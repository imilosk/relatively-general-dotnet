
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 371 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3701">
            <a href="https://ayende.com/blog/166913/mixing-sync-async-calls" target="_blank">
                <h2 class="title mb-6" id="article-3701">Mixing Sync &amp; Async calls</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 03, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Take a look at the following code: int count = 0;&#xA;var sp = Stopwatch.StartNew();&#xA;var tasks = new List&lt;Task&gt;();   &#xA;for (int i = 0; i &lt; 500; i&#x2B;&#x2B;)&#xA;{&#xA;    var t = Task.Run(() =&gt;&#xA;    {&#xA;        var webRequest = WebRequest.Create(new Uri(&#x201C;http://google.com&#x201D;));        webRequest.GetResponse().Close();&#xA;        Interlocked.Increment(ref count);&#xA;    });&#xA;    tasks.Add(t);&#xA;}&#xA;var whenAll = Task.WhenAll(tasks.ToArray());&#xA;while (whenAll.IsCompleted == false &amp;&amp; whenAll.IsFaulted  == false)&#xA;{&#xA;    Thread.Sleep(1000);&#xA;    Console.WriteLine(&quot;{0} - {1}, {2}&quot;, sp.Elapsed, count, tasks.Count(x=&gt; x.IsCompleted == false));&#xA;}&#xA;Console.WriteLine(sp.Elapsed);&#xA;&#xA;&#xA;&#xA;As you can see, it is a pretty silly example of making 500 queries to Google. There is some stuff here about reporting &amp; managing, but the key points is that we start 500 tasks to do some I/O. How long do you think that this is going to run?&#xA;On my machine, this code completes in roughly 22 seconds. Now, WebRequest is old school, and we want to use HttpClient, because it has a much better interface, so we wrote:&#xA;int count = 0;&#xA;var sp = Stopwatch.StartNew();&#xA;var tasks = new List&lt;Task&gt;();&#xA;for (int i = 0; i &lt; 500; i&#x2B;&#x2B;)&#xA;{&#xA;    var t = Task.Run(() =&gt;&#xA;    {&#xA;        var client = new HttpClient();&#xA;        client.SendAsync(new HttpRequestMessage(HttpMethod.Get, new Uri(&quot;http://google.com&quot;))).Wait();&#xA; &#xA;        Interlocked.Increment(ref count);&#xA;    });&#xA;    tasks.Add(t);&#xA;}&#xA;var whenAll = Task.WhenAll(tasks.ToArray());&#xA;while (whenAll.IsCompleted == false &amp;&amp; whenAll.IsFaulted == false)&#xA;{&#xA;    Thread.Sleep(1000);&#xA;    Console.WriteLine(&quot;{0} - {1}, {2}&quot;, sp.Elapsed, count, tasks.Count(x =&gt; x.IsCompleted == false));&#xA;}&#xA;Console.WriteLine(sp.Elapsed); &#xA;&#xA;&#xA;&#xA;I&#x2019;ve been running this code on my machine for the past 7 minutes, and this code hasn&#x2019;t yet issue a single request.&#xA;It took a while to figure it out, but the problem is in how this is structured. We are creating a lot of tasks, more than the available threads in the thread pool. Then we make an async call, and block on that. That means that we block the thread pool thread. Which means that to process the result of this call, we&#x2019;ll need to use another thread pool thread. However, we have scheduled more tasks than we have threads for. So there is no thread available to handle the reply, so all the threads are stuck waiting for reply that there is no thread to handle to unstick them.&#xA;The thread pool notices that, and will decide to allocate more threads, but they are also taken up by the already existing tasks that will immediately block.&#xA;Now, surprisingly, eventually the thread pool will allocate enough threads (although it will take it several hours to do so, probably) to start handling the requests, and the issue is resolved. Expect that this ends up basically crippling the application while this is happening.&#xA;Obviously, the solution is to not wait on async calls inside a task like that, indeed, we can use the following code quite easily:&#xA;var t = Task.Run(async () =&gt;&#xA;{&#xA;    var client = new HttpClient();&#xA;    await client.SendAsync(new HttpRequestMessage(HttpMethod.Get, new Uri(&quot;http://google.com&quot;)));&#xA;&#xA;    Interlocked.Increment(ref count);&#xA;});&#xA;&#xA;&#xA;&#xA;And this shows performance comparable to the WebRequest method.&#xA;However, that isn&#x2019;t very helpful when we need to expose a synchronous API. In our case, in RavenDB we have the IDoctumentSession, which is a simple synchronous API. We want to use the a common codebase for sync and async operations. But we need to expose the same interface, even if we changed things. To make things worse, we have no control on how the http client is scheduling the async operations, and it has no sync operations.&#xA;That means that we are left with the choice of writing everything twice, once for synchronous operations and once for async ops or just living with this issue.&#xA;A work around we managed to find is to run the root tasks (which we do control) on our own task scheduler, so they won&#x2019;t compete with the I/O operations. But that is hardly something that I am thrilled about.</p>
        </article>
        <article id="article-3702">
            <a href="https://ayende.com/blog/166882/the-contracts-of-lazy-t-vs-task-t" target="_blank">
                <h2 class="title mb-6" id="article-3702">The contracts of Lazy&lt;T&gt;  vs Task&lt;T&gt;</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 02, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There was a question about our use of Task&lt;T&gt; and Lazy&lt;T&gt; in RavenDB, and I thought that this is a subtle thing that deserve more than a short email. The basic difference between Lazy&lt;T&gt; and Task&lt;T&gt; are the kind of contracts that they express.  Lazy&lt;T&gt; represent a potentially expensive operation that has been deferred. The promise given is that the lazy&#x2019;s value will be generated the first time that it is needed. Task&lt;T&gt; represent a potentially expensive operation that is currently executing. The promise is that the task&#x2019;s value will be available on request, hopefully already there by the time you asked. The major difference is when we are actually starting the operation. Most often, when we return a task, we return a reference to an scheduled / executing task, which will complete whatever or not the task&#x2019;s result will be accessed. Conversely, a lazy&#x2019;s whose value was never accessed is not something that will ever execute. The use cases for them tend to be quite different. Lazy&lt;T&gt; is used a lot of the time as a way to handle once and only once creation (basically, a safe singleton pattern), and for actually deferring the execution of work. Sometimes you can avoid having to do something, and it is easier to give a caller a lazy object and only have to pay for that additional work if they access the data.  Task&lt;T&gt; is primarily used to actually parallelize the work, so you&#x2019;ll have it running while you are doing other stuff. Usually this is used for I/O, since that can be natively parallelized. With RavenDB, we use Task&lt;T&gt; as the return type of all our async operations, allowing of to take advantage on the async nature of I/O. And we use Lazy&lt;T&gt; to setup a deferred call for the server. When someone actually access one of lazy&#x2019;s values, we have to provide you with the answer. At this point, we can go to the server with all&#xA0; the pending lazy operations, and save a lot of effort just making remote calls to the server. In fact, in RavenDB 3.0, we have lazy support in the async API. That means that we have methods that return Lazy&lt;Task&lt;T&gt;&gt;, which means: Give me a deferred operation, that when required, will perform in an async manner. That gives me both the ability to combine requests to the server and avoid blocking up a thread while that I/O is in progress.</p>
        </article>
        <article id="article-3703">
            <a href="https://ayende.com/blog/166881/ravendb-migration-assistance-services-now-available" target="_blank">
                <h2 class="title mb-6" id="article-3703">RavenDB Migration Assistance Services now available</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 30, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Many people who want to gain the benefits of RavenDB are facing a lot of challenges when they look at their projects. This is especially the case when we are talking about moving existing projects to RavenDB, rather than doing green field development. Recently we have seen quite a bit of a surge in customers coming to us for assistance in that area. As a result of that, I would like to announce that we are now offering those services as a core part of our offering. If you have an existing application and you want to move all or part of it to RavenDB, we now have completed training for staff to help you do just that. This can be just a standalone  In addition to that, because this is a new service, we are actually going to offer the first three new customers this service for free (contact support@ravendb.net for this). We want to encourage people to use RavenDB, and I think that one of the key things we can do to help is reduce any barriers to entry, and this one is pretty big.</p>
        </article>
        <article id="article-3704">
            <a href="https://ayende.com/blog/166849/working-on-the-uber-profiler-3-0" target="_blank">
                <h2 class="title mb-6" id="article-3704">Working on the Uber Profiler 3.0</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 28, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that tend to get lost is the fact that Hibernating Rhinos is doing more than just working on RavenDB. The tagline we like to use is Easier Data, and the main goal we have is to provide users with better ways to access, monitor and manage their data. We have started planning the next version of the Uber Profiler, that means Entity Framework Profiler, NHibernate Profiler, etc. Obviously, we&#x2019;ll offer support for EF 7.0 and NHibernate 4.0, and we had gathered quite a big dataset for common errors when using an OR/M, which we intend to convert into useful guidance whenever our users run into such an issue.  But I realized that I was so busy working on RavenDB that I forgot to even mention the work we&#x2019;ve been doing elsewhere. And I also wanted to solicit feedback about the kind of features you&#x2019;ll want to see in the 3.0 version of the profilers.</p>
        </article>
        <article id="article-3705">
            <a href="https://ayende.com/blog/166598/exploring-the-data-extracting-series-from-my-blog-posts" target="_blank">
                <h2 class="title mb-6" id="article-3705">Exploring the data, extracting series from my blog posts</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 26, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;m pretty bad when it comes to actually organizing my blog. I just like to write stuff out, I don&#x2019;t like to do things like properly setting things up in series. Mostly because I usually think about one post at a time, or three at the most. I did notice that I usually use something like &#x201C;Series name: post name&#x201D; convention when writing series of posts. So I decided to write the following index to check the data out:  As you can see, this is pretty simple way of doing things. And that lead to the following data.  Some of those are obviously false positives, and we have things like this, which are obviously out:  But it looks like important series are also spread over time:  I think that I&#x2019;m going to have to do a new blog feature, to highlight those emergent series.</p>
        </article>
        <article id="article-3706">
            <a href="https://ayende.com/blog/166817/smarter-failure-handling-with-ravendb-3-0" target="_blank">
                <h2 class="title mb-6" id="article-3706">Smarter failure handling with RavenDB 3.0</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 23, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that we have to deal with as a replicated database is how to handle failure. In RavenDB, we have dealt with that with replication, automatic failover and a smart backoff strategy that combined reducing the impact on the clients when a node was down with being able to detect that it was up quickly. In RavenDB 3.0, we have improved on that. Before, we would ping the failed server every now and then, to check if it is up. However, that would mean that routine operations would slow down, even when the failover server was working. In order to handle this, we used to have a backoff strategy for checking the failed server. We would only check it once every 10th request, until we have 10 failed requests, then we would check it only once every 100th request, until we had a 100 failed requests, etc. That worked quite well. Mostly because a lot of the time, failures are transients, and you don&#x2019;t want to fail to a secondary for too long, and if we had a long standing issue, we had a small hiccup, and then everything worked fine, with the occasional hold on a request while we checked things. In addition to that, we also have gossip mechanism that would inform clients that their server is up so they can figure out that the primary server is up even faster.  Anyway, that is what we used to do. In RavenDB 3.0, we have moved to using an async pinging approach. When we detect that the server is down, we will still do the checks as before, but unlike 2.x, we won&#x2019;t do them in the current execution thread, instead, we have a background task that will ping the server to see if it is up. That means that after the first failed request, we will immediately switch over to the secondary, and we will keep on the secondary until the background ping process will report that everything is up. That means that for a very short failure (less than 1 second, usually) we will switch over to the secondary, where before we&#x2019;ll be able to figure out that the server is still up. But the upside here is that we won&#x2019;t have any interruption in service just to check that the primary is up.</p>
        </article>
        <article id="article-3707">
            <a href="https://ayende.com/blog/166753/voron-graphs" target="_blank">
                <h2 class="title mb-6" id="article-3707">Voron &amp; Graphs</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 22, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of our guys is having fun playing with graph databases, and we had a serious discussion on how we can use Voron for that.  No, we don&#x2019;t have any plans to do a graph database. This is purely one of the guys playing with something that interest him. For the purpose of this post, I&#x2019;m only concerned with having the ability to store graph data and read them efficiently. I don&#x2019;t care for the actual graph operations. Let us look at the following graph:  Here is how we can define this in code: var michael = db.CreateNode();&#xA;michael[&quot;Name&quot;] = &quot;Michael&quot;;&#xA;&#xA;var graphs = db.CreateNode();&#xA;graphs[&quot;Name&quot;] = &quot;Graphs&quot;;&#xA;&#xA;var edge = michael.RelatesTo(graphs, db.Relationship(&quot;Plays With&quot;));&#xA;&#xA;&#xA;Now, how would we go about implementing something like this? Well, with Voron, that is pretty easy. &#xA;We&#x2019;ll start with defining a Nodes tree, which is going to using an incremental 64 bits integer for the key, and a JSON object for the value. This means that on CreateNode, we&#x2019;ll just allocate the id for it, and just have the node itself as a JSON object that can be as complex as you want.&#xA;We also have relationships, and here it gets a bit complex, a relationship is always from a node to a node, and it has a specific type. Because the types of relationships tend to be very few, we will limit them to 65,536 relationship types. I think that this would be more than enough. As a result, I can quickly get the id of a relationship type. This leads us to having another tree in Voron, the RelationshipTypes tree, with a key that is the string name of the relationship and the value is just an incremental short. The reason we need to do this will be obvious shortly.&#xA;After we have the relationship type, we need to record the actual relationships. That means that we need to consider how we want to record that. Relationships can have their own properties, so the actual relationship is going to be another JSON object as the value in a tree. But what about the key for this tree? The question here is how are we going to work with this? What sort of queries are we going to issue. Obviously, in a graph database, we are going to follow relationships a lot. And the kind of questions we are going to ask are almost always going to be &#x201C;from node X, find all outgoing relations of type Y&#x201D;. So we might as well do this properly.&#xA;The key for the relations tree would be 18 bytes, the first 8 bytes are the source node id, the next 2 bytes are the relationship type and the last 8 bytes are the destination node id. That means that on the disk, the data is actually sorted first by the node id, then by the relationship type. Which make the kind of queries that I was talking about very natural and fast.&#xA;And that is pretty much it. Oh, you&#x2019;re going to need metadata tree for things like the last relationship type id, and probably other stuff. But that is it, when speaking from the point of view of the storage.&#xA;The overall structure is:&#xA;&#xA;Nodes - (Key: Int64, Val: JSON)&#xA;RelationshipTypes &#x2013; (Key: string, Val: Int16)&#xA;Relationships ( Key: Int64, Int16, Int64, Val: JSON)&#xA;And on top of that you&#x2019;ll be able to write any sort of graph logic.</p>
        </article>
        <article id="article-3708">
            <a href="https://ayende.com/blog/166721/bisecting-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-3708">Bisecting RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 21, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the results of expanding the RavenDB&#x2019;s team is that we have to deal with a lot more pull requests. We have individual developers working on their features, and submitting pull requests on a daily basis. That usually means that I have to merge anything between ten to thirty pull requests per day.  Given our test suite runtime, it isn&#x2019;t really reasonable to run the full test suite after each pull request, so we merge them all, review them, and then run the tests. The problem then is that if there was a test failure&#x2026; which pull request, and which commit cause it? That is why git has the wonderful git bisect command. And we have taken advantage of that to enable the following development time feature:  ./bisect.ps1 HEAD HEAD~10 General_Initialized_WithoutErrors It will output something like:  631caa60719b1a65891eec37c4ccb4673eb28d02 is the first bad commitcommit 631caa60719b1a65891eec37c4ccb4673eb28d02Author: Pawel PekrolDate: Fri May 9 08:57:55 2014 &#x2B;0200another temp commit Pin pointing exactly where the issue is. And yes, this is here as a post primarily because I might forget about it.</p>
        </article>
        <article id="article-3709">
            <a href="https://ayende.com/blog/166785/compression-memory-sizing-in-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-3709">Compression &amp; Memory Sizing in RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 20, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We had an interesting issue at a customer recently, and it took a while to resolve, so it is interesting. The underlying problem as stated by the customer was that they tried to reset an index, and RavenDB took all the memory on the machine. That is kinda rude, and we have taken steps to ensure that this wouldn&#x2019;t happen, so that was surprising. So we settled down to figure out what was going on, and we were able to reproduce this locally. That was strange, and quite annoying. We finally narrowed things down to very large documents. There was a collection on this database where most documents were several MB in size. We do a lot of rate limiting, to avoid overloading, but we do usually do that on the count of documents, not the size of them. Except, that we actually do limit the size where it matter. When we load documents to be indexed, we specify a maximum size (usually 128MB) per batch. However&#x2026; what actually happens is that we go to the storage and ask it, give us X amount of documents, up to Y amount in size. The question is, what size. And in this case, we are using the size on disk, which has a close correlation to the actual size taken when loading into a JSON object. Except&#x2026; when we use compression. When we have compression, what actually happens is that we limited to the maximum size of the compressed data, which can be 10% &#x2013; 15% of the actual data size when we decompress it in memory. That was a large part of the problem. Another issue was what happened when we had prefetching enabled. We routinely prefetch data to memory so we won&#x2019;t have to wait for I/O. The prefetcher only considered documents count, but when each document is multiple MB, we really needed to consider both count and size.  Both issues were fixed, and there are no longer any issues with this dataset. Interestingly enough, the customer had no issue when creating the database, because it only had to deal with whatever changed, and not the entire data set.</p>
        </article>
        <article id="article-3710">
            <a href="https://ayende.com/blog/166657/c-async-programming-pitfall" target="_blank">
                <h2 class="title mb-6" id="article-3710">C# Async programming pitfall</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 19, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I really like the TPL, and I really like the async/await syntax. It is drastically better than any other attempt I&#x2019;ve seen to handle concurrency. But it also has a really major issue. There is no way to properly debug things. Imagine that I have the following code:  public Task DoSomething(){    return new TaskCompletionSource&lt;object&gt;().Task;}&#xA;And now imagine that I have some code that is going to do an await DoSomething();&#xA;What is going to happen? This is a never ending task, so we&#x2019;ll never return. And that is fine, except that there is absolutely no way to see that. I have no way of seeing which task didn&#x2019;t return, and I have no way of seeing all the pending tasks, and what they are all waiting for, etc. I&#x2019;ve run into something like that (obviously a lot harder to figure out) too many times.&#xA;If I was using non async code, it would be obvious that there is this thread that is stopped on this thing, and I could figure it out. For us, this make it a lot harder to work with.</p>
        </article>
        <div class="button flex justify-between">
            <a href="370.html"><span class="back arrow"></span></a>

            <a href="372.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>