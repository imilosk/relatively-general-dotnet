
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 391 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3901">
            <a href="https://www.meziantou.net/combine-multiple-dotnet-assemblies.htm" target="_blank">
                <h2 class="title mb-6" id="article-3901">Combine multiple .NET assemblies</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 20, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Applications often consist of an executable and several DLLs. To deploy this type of application you have to copy all the files. It would be more convenient to deploy only one file: the executable. We could use ILMerge or ILRepack which work pretty well, but we can also do it just from Visual Studi</p>
        </article>
        <article id="article-3902">
            <a href="https://ayende.com/blog/166049/more-xunit-tweaks-dynamic-test-skipping" target="_blank">
                <h2 class="title mb-6" id="article-3902">More xUnit tweaks, dynamic test skipping</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 19, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">For a long time, xUnit&#x2019;s dev has resisted adding support for skipping a test dynamically. You could create your own Fact class and handle that yourself, but that was quite a lot of work, for something very specific. In RavenDB, we had the need to dynamically decide whatever the test can run based on the actual test situation, so I decided to add this to our xUnit fork. This turned out to be really simple to do. Just three lines of code  https://github.com/ayende/xunit/commit/82accb4c850a3938187ac334fb73d6e81dc921e3#diff-3c2b9f2cb8392f32456d0bf81151b59fR57</p>
        </article>
        <article id="article-3903">
            <a href="https://benfoster.io/blog/aspnet-identity-stripped-bare-mvc-part-2/" target="_blank">
                <h2 class="title mb-6" id="article-3903">ASP.NET Identity Stripped Bare - MVC Part 2</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 19, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I introduce some of the new membership features in ASP.NET Identity and swap out my dodgy hard-coded authentication logic to validate user credentials against information stored in a database .</p>
        </article>
        <article id="article-3904">
            <a href="https://ayende.com/blog/166017/ravendb-conference-status-update" target="_blank">
                <h2 class="title mb-6" id="article-3904">RavenDB Conference Status Update</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 18, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">As you probably know, we have the RavenDB Conference coming up in a few weeks. This is the very first conference that we are doing, and to say that we are excited would be a major understatement. We are going to have speakers talk about RavenDB from all angles. From the development team (including yours truly) to the operation guys behind RavenHQ as well as customers and consultants that can share their real world experience about how to best utilize RavenDB. The idea is to have an intimate gathering, and for the very first time, to actually have direct way to talk with all of our users, as well as share a lot of the stuff that happens behind the scenes. Not to mention, we crave feedback, and several key features of RavenDB were actually proposed by the community and then implemented by us. I was reviewing the registration numbers for the conference and it looks like we have made a&#x2026; miscalculation. The idea with the conference was to charge just enough to ensure a commitment to come, to avoid the plague of free conferences where many people sign up and most never come. We even offset things so you can pay 89$ for the conference and you get a 90$ coupon for RavenDB. On the side, since we are already there, we also setup an additional 3 days course for an in-depth look at RavenDB. But we had a lot more demand for the conference and the course than we thought we would have. We currently have just 2 places open for the course, and about 15 &#x2013; 20 places open for the conference.  Since the course is more expensive, that was a the kind of surprise that is actually kinda nice to have: &#x201C;Wait, you mean that they are giving us more money than we thought they would&#x2026;&#x201D;  At any rate, I find myself in the strange situation of encouraging people to go and buy the cheaper product, simply because we are really going to have no more room for the course soon. You can register here, I&#x2019;m looking forward to seeing you all.</p>
        </article>
        <article id="article-3905">
            <a href="https://www.meziantou.net/windows-data-protection-api-dpapi.htm" target="_blank">
                <h2 class="title mb-6" id="article-3905">Windows Data Protection API (DPAPI)</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 18, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">J&#x27;ai &#xE9;crit un article sur un autre blog:Dans mon pr&#xE9;c&#xE9;dent article je vous ai pr&#xE9;sent&#xE9; les diff&#xE9;rentes fa&#xE7;ons de sauvegarder une information lorsque l&#x27;on n&#x27;a pas besoin de pouvoir retrouver l&#x27;information initiale. Cependant dans certains cas on souhaite prot&#xE9;ger une donn&#xE9;e afin que tout le monde ne</p>
        </article>
        <article id="article-3906">
            <a href="https://ayende.com/blog/165955/raft-as-the-raven-flies" target="_blank">
                <h2 class="title mb-6" id="article-3906">Raft, as the Raven flies</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 17, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The interesting thing about the etcd / go-raft review wasn&#x2019;t so much what they did, they did things quite beautifully, but the things that I wanted them to do that they didn&#x2019;t do. The actual implementation was fascinating, and for the purposes of what is required, more than adequate. I, however, have a very specific goal in mind, and that means that this is really not going to work with the given implementations. I&#x2019;ve better explain first. I&#x2019;m not sure if go-raft was written by the same people as etcd, but they do &#x201C;smell&#x201D; very much the same. It just occurred to me that yes, they are actually both on github, so I checked it appears that I was correct. xiangli-cmu, philips, benbjohnson and bcwaldon (among many others) have worked on both projects. The reason this is important is that this reinforce my feeling that go-raft was written mainly to serve the need of etcd. Anyway&#x2026; The reason that I think that is that the implementation is very much optimized at the level etcd needs it. What I mean is that there is a lot of work there to support multiple concurrent operations that would be batched to all the nodes in the cluster, then be applied in the in memory model. This work because etcd is a set of key/value pairs that are shared among many nodes, but they are usually very small values, and very small number of keys. I would be surprised if there were hundreds of thousands of keys in a single etcd installation. That just isn&#x2019;t the type of thing that it is meant to do. And that reflects throughout.  For example, there is an inherit assumption through the codebase, that the data set is small, the each value is small, etc. When sending a snapshot over the wire, there is the assumption that it can all fit in memory and that this is a good thing to do so. Even more to the point, the system where we only push entries to the nodes on heartbeats is great when you are trying to batch multiple changes together, with each change being independent of all the others (usually). However, that really doesn&#x2019;t work when what you actually need is something like the sort of things that we usually deal with. I want to emphasize that I&#x2019;m really evaluating the way etcd &amp; go-raft are built and find them wanting for my own purposes, I think that they are doing quite great for the kind of problem that they are meant to solve. Let us consider the kind of databases that we have. We usually have to deal with much larger values, typical documents are in the KB range, and are frequently hundreds of KB in size. We also tend to have quite a lot of them. Trying to put them all in memory (the etcd way) would be&#x2026; suboptimal. Now, one option would be to try and do just that, and have each operation in RavenDB (put/delete documents) as a state machine command in Raft. The problem is that this really gets complicated very quickly, leaving aside the fact that it isn&#x2019;t a general solution, and we really want to try to get to a general solution.  We don&#x2019;t want to solve this once for RavenDB, and then for RavenFS, and then for&#x2026; etc. And the reason that working at that level is tricky is that you need to push everything through the state machine, and everything in this case really does mean everything. That lead to a very different database design and implementation. It is also probably not really necessary. We can drop this a level or two down and instead of dealing at the database level, we can deal with that at the storage layer level. This is basically just an extension of the log shipping idea. Instead of using Raft for high level commands, just use Raft to create a consensus around the sequence of writes to the journal. That means that all the nodes will have the same journal, and thus have the same data in the storage. That in turn means that an &#x201C;entry&#x201D; can actually be pretty large (mutli MB range, sometimes). And because the journal is purely sequential, we need to issue that command to all the nodes as soon as it is submitted to the Raft state machine.  Now, the reason that the go-raft implementation waits for the heartbeat is that it batches things up nicely, and really speed up the general case. But we don&#x2019;t need to do that for what we are going to do. Or, to be rather more exact, we have already done just that. That is basically what Voron&#x2019;s transaction merging is all about. And since we can only handle writes as the leader, and since we will merge concurrent writes anyway, that is going to end up as a very similar behavior under load, and faster without load. At least that is what the initial thinking is saying. Snapshots, also something quite important for Raft, can be handle very simply by just doing a backup/restore over the network, by streaming all the data.  And the rest is just implementing Raft .</p>
        </article>
        <article id="article-3907">
            <a href="https://ayende.com/blog/165954/the-downsides-of-going-big" target="_blank">
                <h2 class="title mb-6" id="article-3907">The downsides of going big</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 14, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that I found out is that as Hibernating Rhinos grows (and we currently have over a dozen people working full time), I&#x2019;m seeing two very interesting changes in my own behavior. The actual velocity is increasing by leaps &amp; bounds. We can do a lot more now, and we can do that faster and with a greater degree of parallelism. My personal development is growing less, as I am doing a lot more of business type things. One aspect of that is that I do a lot of reading of contracts, legalese, and other stuff that takes time from actual development work. I try to compensate by running the tests while I&#x2019;m reading contracts, and then I found the following in a contract I&#x2019;m reviewing:  Nice to know where that stand. And I emphasize.</p>
        </article>
        <article id="article-3908">
            <a href="https://ayende.com/blog/165985/ravendb-success-stories-codealike" target="_blank">
                <h2 class="title mb-6" id="article-3908">RavenDB Success Stories: Codealike</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 13, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I just run into the following case study from Microsoft:  We were amazed by how simple it was to embed RavenDB into our Windows Azure application. This gave us a huge advantage in getting our solution to market in just six weeks. Federico Andres LoisCo-Founder, Codealike</p>
        </article>
        <article id="article-3909">
            <a href="https://ayende.com/blog/165729/stack-overflow-yeah-right" target="_blank">
                <h2 class="title mb-6" id="article-3909">Stack overflow&#x2026; yeah, right!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 12, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">My app crashed with stack overflow exception. That would be fine, except:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;&#xA0;&#xA;&#xA;&#x9;To be fair, that was under low memory conditions, since I was leaking virtual memory. So that make&#xA0;sense, still...</p>
        </article>
        <article id="article-3910">
            <a href="https://ayende.com/blog/165889/reviewing-go-raft-part-ii" target="_blank">
                <h2 class="title mb-6" id="article-3910">Reviewing go-raft, part II</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 11, 2014
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my previous post, I started to go over the go-raft implementation, after being interrupted by the need to sleep, I decided to go on with this, but I wanted to expand a bit first about the issue we discussed earlier, not checking the number of bytes read in log_entry&#x2019;s Decode.  Let us assume that we actually hit that issue, what would happen?  The process goes like this, we try to read a value, but the Read method only return some of the information. We explicitly ignore that, and try to use the buffer anyway. Best case scenario, we are actually getting an error, so we bail early. At that point, we detect the error and truncate the file. Hello data loss, nice to see you. For fun, this is the best case scenario. It is worse if we marshal the partial data without an error. Then we have not the case of &#x201C;oh, we have a node that is somehow way behind&#x201D;, we have the case of &#x201C;this node actually applied different commands than anyone else&#x201D;. I reported this issue, and I&#x2019;m interested to know if my review is in any way correct. With that said, let us move on&#x2026; getEntriesAfter gives us all the in memory entries. That is quite similar to how RavenDB handled indexing, for that matter, so it is amusing. But this applies only to in memory stuff, and it is quite interesting to see how this will interact with other parts of the codebase. setCommitIndex is interesting. In my head, committing something means flushing them to disk. But in Raft&#x2019;s term. Committing something means applying the commands. But the reason it is interesting is that it has some interesting comments on edge cases. So far, I haven&#x2019;t see actually writing to disk, mind. And this one gives me a headache:  Basically, this mean that we need to write the commit index to the beginning of the file. It is also an extremely unsafe operation. What happens if you crash immediately after? Did you change go through, or not? For that matter, there is nothing that prevents the OS from first writing the changes you made to the beginning of the file then whatever else you wrote at the end. So a crash might actually leave you with the commit pointer pointing at corrupted data. Luckily, I don&#x2019;t see anything there actually calling this, though. The truncate method makes my head ache, mostly because it does things like delete data, which makes my itchy. This is called from the server code as part of normal processing of the append entries request. What this does, in effect, is to say something like: I want you to apply this log entry, make sure that your previous log entry is this, and if it isn&#x2019;t, revert it back to this entry.&#xA0; This is how Raft ensure that all the logs are the same across the cluster. Then we have this:     1:  // Appends a series of entries to the log.   2:  func (l *Log) appendEntries(entries []*protobuf.LogEntry) error {   3:      l.mutex.Lock()   4:      defer l.mutex.Unlock()   5:  &#xA0;   6:      startPosition, _ := l.file.Seek(0, os.SEEK_CUR)   7:  &#xA0;   8:      w := bufio.NewWriter(l.file)   9:  &#xA0;  10:      var size int64  11:      var err error  12:      // Append each entry but exit if we hit an error.  13:      for i := range entries {  14:          logEntry := &amp;LogEntry{  15:              log:      l,  16:              Position: startPosition,  17:              pb:       entries[i],  18:          }  19:  &#xA0;  20:          if size, err = l.writeEntry(logEntry, w); err != nil {  21:              return err  22:          }  23:  &#xA0;  24:          startPosition &#x2B;= size  25:      }  26:      w.Flush()  27:      err = l.sync()  28:  &#xA0;  29:      if err != nil {  30:          panic(err)  31:      }  32:  &#xA0;  33:      return nil  34:  }&#xA;&#xA;&#xA;This seems pretty easy to follow, all told. But note the call to sync() there in line 27. And the fact that this translate down to an fsync, which is horrible for performance.&#xA;There is also appendEntry, which appears to be doing the exact same thing as appendEntries and writeEntry. I&#x2019;m guessing that the difference is that appendEntries is called for a follower, and appendEntry is for a leader.&#xA;The last thing to go through in the log.go file is the compact function, which is&#x2026; interesting:&#xA;&#xA;   1:  // compact the log before index (including index)   2:  func (l *Log) compact(index uint64, term uint64) error {   3:      var entries []*LogEntry   4:  &#xA0;   5:      l.mutex.Lock()   6:      defer l.mutex.Unlock()   7:  &#xA0;   8:      if index == 0 {   9:          return nil  10:      }  11:      // nothing to compaction  12:      // the index may be greater than the current index if  13:      // we just recovery from on snapshot  14:      if index &gt;= l.internalCurrentIndex() {  15:          entries = make([]*LogEntry, 0)  16:      } else {  17:          // get all log entries after index  18:          entries = l.entries[index-l.startIndex:]  19:      }  20:  &#xA0;  21:      // create a new log file and add all the entries  22:      new_file_path := l.path &#x2B; &quot;.new&quot;  23:      file, err := os.OpenFile(new_file_path, os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0600)  24:      if err != nil {  25:          return err  26:      }  27:      for _, entry := range entries {  28:          position, _ := l.file.Seek(0, os.SEEK_CUR)  29:          entry.Position = position  30:  &#xA0;  31:          if _, err = entry.Encode(file); err != nil {  32:              file.Close()  33:              os.Remove(new_file_path)  34:              return err  35:          }  36:      }  37:      file.Sync()  38:  &#xA0;  39:      old_file := l.file  40:  &#xA0;  41:      // rename the new log file  42:      err = os.Rename(new_file_path, l.path)  43:      if err != nil {  44:          file.Close()  45:          os.Remove(new_file_path)  46:          return err  47:      }  48:      l.file = file  49:  &#xA0;  50:      // close the old log file  51:      old_file.Close()  52:  &#xA0;  53:      // compaction the in memory log  54:      l.entries = entries  55:      l.startIndex = index  56:      l.startTerm = term  57:      return nil  58:  }&#xA;&#xA;&#xA;This code can&#x2019;t actually run on Windows. Which is interesting. The issue here is that it is trying to rename a file that is open on top of another file which is open. Windows does not allow it.&#xA;But the interesting thing here is what this does. We have the log file, which is the persisted state of the in memory entries collection. Every now and then, we compact it by creating a snapshot, and then we create a new file, with only the entries after the newly created snapshot position.&#xA;So far, so good, and that gives me a pretty good feeling regarding how the whole thing is structured. Next in line, the peer.go file. This represent a node&#x2019;s idea about what is going on in the another node in the cluster. I find the heartbeat code really interesting:&#xA;// Starts the peer heartbeat.&#xA;func (p *Peer) startHeartbeat() {&#xA;    p.stopChan = make(chan bool)&#xA;    c := make(chan bool)&#xA;    go p.heartbeat(c)&#xA;    &lt;-c&#xA;}&#xA;&#xA;// Stops the peer heartbeat.&#xA;func (p *Peer) stopHeartbeat(flush bool) {&#xA;    p.stopChan &lt;- flush&#xA;}&#xA;&#xA;// Listens to the heartbeat timeout and flushes an AppendEntries RPC.&#xA;func (p *Peer) heartbeat(c chan bool) {&#xA;    stopChan := p.stopChan&#xA;&#xA;    c &lt;- true&#xA;&#xA;    ticker := time.Tick(p.heartbeatInterval)&#xA;&#xA;    debugln(&quot;peer.heartbeat: &quot;, p.Name, p.heartbeatInterval)&#xA;&#xA;    for {&#xA;        select {&#xA;        case flush := &lt;-stopChan:&#xA;            if flush {&#xA;                // before we can safely remove a node&#xA;                // we must flush the remove command to the node first&#xA;                p.flush()&#xA;                debugln(&quot;peer.heartbeat.stop.with.flush: &quot;, p.Name)&#xA;                return&#xA;            } else {&#xA;                debugln(&quot;peer.heartbeat.stop: &quot;, p.Name)&#xA;                return&#xA;            }&#xA;&#xA;        case &lt;-ticker:&#xA;            start := time.Now()&#xA;            p.flush()&#xA;            duration := time.Now().Sub(start)&#xA;            p.server.DispatchEvent(newEvent(HeartbeatEventType, duration, nil))&#xA;        }&#xA;    }&#xA;}&#xA;&#xA;&#xA;Start heartbeat starts a new heartbeat, and then wait under the heartbeat function notify it that it has started running. &#xA;What is confusing is the reference to the peer&#x2019;s server. Peer is defined as:&#xA;// A peer is a reference to another server involved in the consensus protocol.&#xA;type Peer struct {&#xA;    server            *server&#xA;    Name              string `json:&quot;name&quot;`&#xA;    ConnectionString  string `json:&quot;connectionString&quot;`&#xA;    prevLogIndex      uint64&#xA;    mutex             sync.RWMutex&#xA;    stopChan          chan bool&#xA;    heartbeatInterval time.Duration&#xA;}&#xA;&#xA;&#xA;&#xA;And it seems logical to think that this is a remote peer&#x2019;s server, but this is actually the local server reference, not the remote one. Note that it is actually the flush method that does the remote call.&#xA;Flush is defined as:&#xA;func (p *Peer) flush() {&#xA;    debugln(&quot;peer.heartbeat.flush: &quot;, p.Name)&#xA;    prevLogIndex := p.getPrevLogIndex()&#xA;    term := p.server.currentTerm&#xA;&#xA;    entries, prevLogTerm := p.server.log.getEntriesAfter(prevLogIndex, p.server.maxLogEntriesPerRequest)&#xA;&#xA;    if entries != nil {&#xA;        p.sendAppendEntriesRequest(newAppendEntriesRequest(term, prevLogIndex, prevLogTerm, p.server.log.CommitIndex(), p.server.name, entries))&#xA;    } else {&#xA;        p.sendSnapshotRequest(newSnapshotRequest(p.server.name, p.server.snapshot))&#xA;    }&#xA;}&#xA;&#xA;&#xA;The interesting thing here is that the entries collection might be empty (in which case this serve as just a heartbeat). Another thing that pops to mind is that this has an explicitly leader instructing follower to generate snapshots. The Raft paper suggested that this is something that would happen locally on each server on an independent basis.&#xA;There is a lot of interesting behavior in sendAppendEntriesRequest(), not so much in what it does, as in how it handles replies. There is a lot of state going on there. It&#x2019;s very well commented, so I&#x2019;ll let you read it, there isn&#x2019;t anything that is actually going on that is complex.&#xA;What is fascinating is that while the transport layer for go-raft is HTTP, which is inherently request/response. It actually handles this in an interesting fashion:&#xA;&#xA;Requests are synchronous&#xA;On reply, the in memory state of the peer is updated immediately&#xA;The response from the peer is queued to be handled by the server event loop&#xA;The end result is that a lot of the handling is centralized into a really pretty state machine. The rest of what is going on there is not very interesting, except for snapshots, but those are covered elsewhere.&#xA;And now, we are ready to actually go and look at the server code, but&#x2026; not yet. It is over thousand lines of code, so I think that I&#x2019;ll go over other stuff first. In particular, snapshotting looks interesting.&#xA;&#xA;This is actually quite depressing. Note the State properties here. There is an implicit assumption that it is possible / advisable to go with the entire in memory state like that. I know that I am sensitive to such things, but that seems like an aweful lot of waste when talking about large systems.&#xA;Here is one such issue:&#xA;&#xA;Let us assume that our state is big, hundreds of MB or maybe a few GB in size.&#xA;We currently hold it in memory inside the Snaphsot.STate, then we marshal that to json. Now, I actually had to go and check, but Go&#x2019;s json package actually does the usual thing and encode a byte array as a base 64 formatted string. What that means, in turn, is that you have an overhead of about 25% that you have to deal with, and this is all allocated in main memory. And then you write it to a file. &#xA;This is&#x2026;. quite insane, to be frank.&#xA;Assuming that I have a state that is 100 MB in size, I&#x2019;m going to hold all of that in memory, then allocate another 125MB just to hold the json state, then write it to a file. Why not write it to a file directly in the first place? (You could do CRC along the way).&#xA;The whole thing appear to be assuming small sizes of data. Throughout the entire codebase, actually.&#xA;And now, I have no other ways to avoid it, we are going into the server.go itself&#x2026;&#xA;There is a lot of boilerplate stuff there, but the first interesting thing happens when we look at how to apply the log:&#xA;&#xA;&#xA;This says, when we need to apply it, execute the command method on my state. A lot of the other methods are some variant of:&#xA;&#xA;Nothing to see here at all.&#xA;And we finally get to the key part, the event loop:&#xA;&#xA;Let us look in detail on the followerLoop. Inside that function, we have a loop that waits for:&#xA;&#xA;Stop signal, which would lead to us shutting down&#x2026;&#xA;We got an event on our queue&#x2026;&#xA;The timeout for an event has expired&#x2026;&#xA;There is one part there that puzzles me:&#xA;&#xA;promotable will return true if the log has any entries at all. I&#x2019;m not really sure why that is the case, to be honest. In particular, what about the case when we start with an empty server. I&#x2019;m going to go on reading the code, and we&#x2019;ll see where it leads us. And it leads us to:&#xA;&#xA;So next we need to figure out what is this self join stuff. I am not sure if that is something comes from Raft or from an external source. I found this issue that discusses this, but it isn&#x2019;t very helpful in terms of understanding who issue the self join command. I tried looking at the etcd codebase, but I didn&#x2019;t find anything so far. I&#x2019;ll leave it for now.&#xA;The rest of the operations are basically just forwarding the calls to the appropriate methods if they are in the allowed state.&#xA;The caniddateLoop method isn&#x2019;t anything special, it follows the Raft paper pretty nicely, although I have to admit the &#x201C;candidate becomes follower upon Append Entries command&#x201D; is buried deep. The same is true for the other behaviors. The appropriate state based responses sometimes are hard to figure out, because you have the state loop, then you have the same apparent behavior everywhere. For example, we need to become follower if we get an Append Entries request. That happens in processAppendEntriesRequest(), but it would actually be easier to see this if we had code duplication. This is a case where getting familiar with the codebase would help understanding it, and I don&#x2019;t think that this would be a change worth doing, anyway.&#xA;Probably the most interesting behavior is in the leadershipLoop when we process a command. A command is added to the server queue using a Do(Command) method. It is then processed in processCommand.&#xA;The problem here is that commands are actually appended to the log, and then sent to peers using the heartbeat interval. By default, that stand at 50 ms.&#xA;This is great and all, but it does mean that the latency for requests is going to suffer. This doesn&#x2019;t matter that much for something like etcd. The assumption here is that the requests are all going to be on different things, so we can queue a lot of commands and get pretty good speed overall. It is a problem if in our system, we have to process sequential operations. In that mode, we can&#x2019;t wait until the heartbeat, and we want to process this right away. I&#x2019;ll discuss this later,I think. It is a very important property of this implementation (but not for Raft in general).&#xA;Looking at the snapshot state, this happens when a follower get this a SnapshotRequest, but I don&#x2019;t see anywhere that send it. Maybe it is another caller originated thing?&#xA;I just looked at the etcd source, and I think that I confirmed that both behaviors are there in the etcd source. So I think that that explains it.&#xA;And this is it, basically. I have some thoughts about the implementation of this and of etcd, but I think that this is enough for now&#x2026; I&#x2019;ll post them in my next post.</p>
        </article>
        <div class="button flex justify-between">
            <a href="390.html"><span class="back arrow"></span></a>

            <a href="392.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>