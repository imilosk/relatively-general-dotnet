
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 118 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-1171">
            <a href="https://ayende.com/blog/195105-B/heisenbug-the-concurrent-exception-in-the-transaction-that-will-only-occur-if-you-observe-it" target="_blank">
                <h2 class="title mb-6" id="article-1171">Heisenbug: The concurrent exception in the transaction that will only occur if you observe it</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 22, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Recently we had to tackle a seriously strange bug. A customer reported that under a specific set of circumstances, when loading the database with many concurrent requests, they would get an optimistic concurrency violation from RavenDB.That is the sort of errors that we look at and go: &#x201C;Well, that is what you expect it to do, no?&#x201D;The customer code looked something like this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          def worker(self): # runs on multiple threads&#xA;        &#xA;        &#xA;          &#xA;            with session as self.store.open_session(use_optimistic_concurrency = True):&#xA;        &#xA;        &#xA;          &#xA;              lock = session.load(self.lock_id)&#xA;        &#xA;        &#xA;          &#xA;              if lock is not None:&#xA;        &#xA;        &#xA;          &#xA;                raise &quot;Lock busy&quot;&#xA;        &#xA;        &#xA;          &#xA;              session.store(self.lock_id, {})&#xA;        &#xA;        &#xA;          &#xA;              session.save_changes() # ensures that we get the lock or throws&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;              self.do_work(session)&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;              session.delete(self.lock_id) # release the lock&#xA;        &#xA;        &#xA;          &#xA;              session.save_changes()&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          work.py&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can imagine, this code is expected to deal with concurrency errors, since it is explicitly meant to run from multiple threads (and processes) all at once.However, in the scenario that the user was using, it had two separate types of workers running, one type was accessing the same set of locks, and there you might reasonably expect to get a concurrency error. However, the second type was run in the main thread only, and there should be no contention on that at all. However, the user was getting a concurrency error on that particular lock, which shouldn&#x2019;t happen. Looking at the logs, it was even more confusing. Leaving aside that we could only reproduce this issue when we had a high contention rate, we saw some really strange details. Somehow, we had a write to the document coming out of nowhere?It took a while to figure out what was going on, but we finally figured out what the root cause was. RavenDB internally does not execute transactions independently. That would be far too costly. Instead, we use a process call transaction merging.Here is what this looks like:The idea is that we need to write to the disk to commit the transaction. That is an expensive operation. By merging multiple concurrent transactions in this manner, we are able to significantly reduce the number of disk writes, increasing the overall speed of the system. That works great, until you have an error. The most common error, of course, is a concurrency error. At this point, the entire merged transaction is rolled back and we will execute each transaction independently. In this manner, we suffer a (small) performance hit when running into such an error, but the correctness of the system is preserved.The problem in this case would only happen when we had enough load to start doing transaction merging. Furthermore, it would only happen if the actual failure would happen on the second transaction in the merged sequence, not the first one.Internally, each transaction does something like this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          class TxBatch:&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;            def __init(self, operations):&#xA;        &#xA;        &#xA;          &#xA;              self.replies = []&#xA;        &#xA;        &#xA;          &#xA;              self.operations = operations&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;            def execute(self, tx):&#xA;        &#xA;        &#xA;          &#xA;              for op in self.operations:&#xA;        &#xA;        &#xA;          &#xA;                result = op.execute(tx)&#xA;        &#xA;        &#xA;          &#xA;                self.replies.append(result)&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          batch.py&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Remember that aside from merging transactions, a single transaction in RavenDB can also have multiple operations. Do you see the bug here?The problem was that we successfully executed the transaction batch, but the next one in the same transaction failed. RavenDB did the right thing and execute the transaction batch again independently (this is safe to do, since we rolled back the previous transaction and are operating on a clean slate).The problem is that the transaction batch itself, on the other hand, had its own state. In this case, the problem was that when we replied back to the caller, we used the old state, the one that came from the old transaction that was rolled back.The only state we return to the user is the change vector, which is used for concurrency checks. What happened was that we got the right result, for the old change vector. Everything worked, and the actual state of the database was fine. The only way to discover this issue is if you are continue to make modifications to the same document on the same session. That is a rare scenario, since you typically discard the session after you save its changes.In any other scenario, you&#x2019;ll re-load the document from the server, which will give you the right change vector and make everything work. Like all such bugs, when we look back at it, this is pretty obvious, but to get to this point was quite a long road.</p>
        </article>
        <article id="article-1172">
            <a href="https://ayende.com/blog/195073-C/negative-feature-response-automatic-attachment-compression-in-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-1172">Negative feature response</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 20, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Following my previous post, which mentioned that you can save significantly on disk space if you store a plain text attachment using gzip, we go a feature request:Perhaps in future attachments could have built-in compression as well?The answer to that is no, but I thought that it is worth a post to explain why not. Let&#x2019;s consider the typical types of attachments that you&#x2019;ll store in RavenDB. Based on experience, we usually see:PDF filesWord / Excel / Power PointImages (JPEG, PNG, GIF, etc)VideoesDesigns (floor plans, CAD / DWG, etc)Text filesAside from the text files, pretty much all the data you&#x2019;ll store as an attachment is already compressed. In fact, you&#x2019;ll be hard pressed today to find any file format that does not already have built-in compression.Compressing already compressed data is&#x2026; suboptimal. I will not usually lead to significant space savings and can actually make the file size larger. It also burns CPU cycles unnecessarily. It is better to shift the responsibility to the users in this case, since they have a lot more information about what they actually put into RavenDB and won&#x2019;t have to guess.</p>
        </article>
        <article id="article-1173">
            <a href="https://ayende.com/blog/195042-C/when-the-error-is-byzantine" target="_blank">
                <h2 class="title mb-6" id="article-1173">When the error is byzantine</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 19, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In distributed systems, the term Byzantine fault tolerance refers to working in an environment where the other nodes in the system are going to violate the invariants held by the system. Sometimes, that is because of a bug, sometimes because of a hardware issue (Figure 11) and sometimes that is a malicious action. A user called us to let us know about a serious issue, they have a 100 documents in their database, but the index reports that there are 105 documents indexed. That was&#x2026; puzzling. None of the avenues of investigation we tried help us. There wasn&#x2019;t any fanout on the index, for example.That was&#x2026; strange.We looked at the index in more details and we noticed something really strange. There were documents ids that were in the index that weren&#x2019;t in the database, and they were all at the end. So we had something like:users/1 &#x2013; users/100 &#x2013; in the indexusers/101 &#x2013; users/105 &#x2013; not in the indexWhat was even stranger was that the values for the documents that were already in the index didn&#x2019;t match the values from the documents. For that matter, the last indexed etag, which is how RavenDB knows what documents to index.Overall, this is a really strange thing, and none of that is expected to happen. We asked the user for more details, and it turns out that they don&#x2019;t have much. The error was reported in the field, and as they described their deployment scenario, we were able to figure out what was going on.On certain cases, their end users will want to &#x201C;reset&#x201D; the system. The manner in which they do that is to shut down their application and then delete the RavenDB folder. Since all their state is in RavenDB, that brings them back up at a clean state. Everything works, and this is a documented manner in which they are working.However, the manner in which the end user will delete is done as: &#x201C;Delete the database files&#x201D;, the actual task is done by the end user. A RavenDB database internally is composed of a few directories, for data and indexes. What would happen in the case where you deleted just the database file, but kept the index files? In that case, RavenDB will just accept that this is the case (soft delete is a a thing, so we have to accept that) and open the index file. That index file, however, came from a different database, so a lot of invariants are broken. I&#x2019;m actually surprised that it took this long to find out that this is problematic, to be honest.We explained the issue, and then we spent some time ensuring that this will never be an invisible error. Instead, we will validate that the index is coming from the right source, or error explicitly. This is one bug that we won&#x2019;t have to hunt ever again.</p>
        </article>
        <article id="article-1174">
            <a href="https://andrewlock.net/exploring-dotnet-6-part-6-supporting-integration-tests-with-webapplicationfactory-in-dotnet-6/" target="_blank">
                <h2 class="title mb-6" id="article-1174">Supporting integration tests with WebApplicationFactory in .NET 6</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 19, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Exploring .NET 6 - Part 6</p>
        </article>
        <article id="article-1175">
            <a href="https://ayende.com/blog/195041-C/finding-a-bug-with-code-that-isnt-there" target="_blank">
                <h2 class="title mb-6" id="article-1175">Finding a bug with code that isn&#x2019;t there</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 18, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A user called us with a strange bug report. He said that the SQL ETL process inside of RavenDB was behaving badly. It would write the data from the RavenDB server to the MySQL database, but then it would immediately delete it.From the MySQL logs, the user showed:2021-10-12 13:04:18 UTC:20.52.47.2(65396):root@ravendb:[1304]:LOG: execute &lt;unnamed&gt;: INSERT INTO orders (&quot;id&quot;) VALUES (&#x27;Tab/57708-A&#x27;)2021-10-12 13:04:19 UTC:20.52.47.2(65396):root@ravendb:[1304]:LOG: execute &lt;unnamed&gt;: DELETE FROM orders WHERE &quot;id&quot; IN (&#x27;Tab/57708-A&#x27;)As you can imagine, that isn&#x2019;t an ideal scenario for ETL processes. It is also something that should absolutely not happen. RavenDB issues the delete before the insert, obviously. In fact, for your viewing pleasure, here is the relevant piece of code:It doesn&#x2019;t get any clearer than that, right? We issue any deletes we have, then we send the inserts. But the user insisted that they are seeing this behavior, and I tend to trust them. But we couldn&#x2019;t reproduce the issue, and the code in question dates to 2017, so I was pretty certain it is correct.Then I noticed the user&#x2019;s configuration. To define a SQL ETL process in RavenDB, you need to define what tables we&#x2019;ll be writing to as well as deciding what data to send to those tables. Here is what this looked like:And here is the script:Do you see the problem? It might be better to use an overload, which make it clearer:In the table listing, we had an &#x201C;orders&#x201D; table, but the script sent the data to the &#x201C;Orders&#x201D; table.RavenDB is a case insensitive database, but in this case, what happened behind the scenes is that the code used a case sensitive dictionary to keep track of the tables that we are working with. That meant that what we did was roughly:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          for doc in docs:&#xA;        &#xA;        &#xA;          &#xA;            for table in tables:&#xA;        &#xA;        &#xA;          &#xA;              changes_by_table.delete(table, doc.id)&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;             results = run_script(doc)&#xA;        &#xA;        &#xA;          &#xA;             for result in results:&#xA;        &#xA;        &#xA;          &#xA;              changes_by_table.insert(result.table, result.value, doc.id)&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;          for table in changes_by_table:&#xA;        &#xA;        &#xA;          &#xA;            for delete in table.deletes:&#xA;        &#xA;        &#xA;          &#xA;              # do actual delete...&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;            for insert in table.inserts:&#xA;        &#xA;        &#xA;          &#xA;              # do actual insert...&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          etl.py&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;And basically, the changes_by_table dictionary had two tables in it. One from the table definitions and one from the script. When we validate that the tables from the script are fine, we do that using case insensitive comparison, so that passed properly.To make it worst, the order of items in a dictionary is not predictable. If this was the iteration order other way around, everything would appear to be working just fine. We fixed the bug, but I found it really interesting that three separate people (very experienced with the codebase) had a look and couldn&#x2019;t figure out how this bug can happen. It wasn&#x2019;t in the code, it was in what wasn&#x2019;t there.</p>
        </article>
        <article id="article-1176">
            <a href="https://www.meziantou.net/finding-duplicate-documents-in-mongodb.htm" target="_blank">
                <h2 class="title mb-6" id="article-1176">Finding Duplicate Documents in MongoDB</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 18, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Recently I needed to create a new unique index on a MongoDB collection. However, there were some duplicate data&#x2026; so I got the following error:copyE11000 duplicate key error collection: db.collection index: index_name dup key: { key: &quot;duplicate value&quot; }The error message lists the first duplicated va</p>
        </article>
        <article id="article-1177">
            <a href="https://ayende.com/blog/195009-C/when-you-want-to-store-index-and-search-mbs-of-text-inside-of-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-1177">When you want to store, index and search MBs of text inside of RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 15, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A scenario came up from a user that was quite interesting to explore. Let&#x2019;s us assume that we want to put the Gutenberg Project inside of RavenDB. An initial attempt for doing that would look like this: I&#x2019;m skipping a lot of the details, but the most important field here is the Content field. That contains the actual text of the book.On last count, however, the size of the book was around 708KB. When storing that as a single field inside of RavenDB, on the other hand, RavenDB will notice that this is a long field and compress it. Here is what this looks like:The 738.55 KB is the size of the actual JSON, the 674.11 KB is after quick compression cycle and the 312KB is the actual size that this takes on disk. RavenDB is actively trying to help us.But let&#x2019;s take the next step, we want to allow us to query, using full text search, on the content of the book. Here is what this will look like:Everything works, which is great. But what is going on behind the scenes?Even a single text field that is large (100s of KB or many MB) puts a unique strain on RavenDB. We need to manage that as a single unit, it significantly bloats the size of the parent document and make it more expensive to work with. This is interesting because usually, we don&#x2019;t actually work all that much with the field in question. In the case of the Pride and Prejudice book, the content is immutable and not really relevant for the day to day work with the document. We are better off moving this elsewhere. An attachment is a natural way to handle this. We can move the content of the book to an attachment. In this way, the text is retained, we can still work and process that, but it is sitting on the side, not making our life harder on each interaction with the document. Here is what this looks like, note that the size of the document is tiny. Operations on that size would be much faster than a multi MB document:Of course, there is a disadvantage here, how can we index the book&#x2019;s contents now? We still want that. RavenDB support that scenario explicitly, let&#x2019;s define an index to do just that:You can see that I&#x2019;m loading the content attachment and then accessing its content as string, using UTF8 as the encoding mechanism. I tell RavenDB to use full text search on this field, and I&#x2019;m off to the races.Of course, we could stop here, but why? We can do even better. When working with large text fields, an index such as the one above will force us to materialize the entire field as a single value. For very large values, that can put a lot of pressure in terms of memory usage.But RavenDB supports more than that. Instead of processing a very large string in one shot, we can do that in an incremental fashion, avoiding big value materialization and the memory pressure associated with that. Here is what you can write:That tells RavenDB that we should process the field in a streaming fashion. Here is why it matters:&#xA;&#xA;&#xA;Value Materialized&#xA;Streaming Value&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;When we are working on a document that has a &lt; 1 MB attachment, it probably doesn&#x2019;t matter all that much (although using 25% of the memory is nice), but it matters a lot more when you are working with larger texts.We can take this one step further still! Instead of storing the attachment text as is, we can compress it, like so:And then in the index, we&#x2019;ll decompress on the fly:Note that throughout all of that, the queries that you send are exactly the same, we are just taking 20% of the disk space and 25% of the memory that we used to.</p>
        </article>
        <article id="article-1178">
            <a href="https://ayende.com/blog/194977-A/a-pki-less-secure-communication-channel-using-tls" target="_blank">
                <h2 class="title mb-6" id="article-1178">A PKI-less secure communication channel</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 12, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After spending so much time building my own protocol, I decided to circle back a bit and go back to TLS itself and see if I can get the same thing for it that I make on my own. As a reminder, here is what we achieved:Trust established between nodes in the system via a back channel, not Public Key Interface. For example, I can have:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          [&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;              &quot;Name&quot;: &quot;orders.app&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;PublicKey&quot;: &quot;3xPJBNRzybdD2XhxCkO9e9L7cVrjAocPc00MwB2eyv8=&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;Access&quot;: [&#xA;        &#xA;        &#xA;          &#xA;                &quot;Orders&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;Leads&quot;&#xA;        &#xA;        &#xA;          &#xA;               ]&#xA;        &#xA;        &#xA;          &#xA;            },&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;              &quot;Name&quot;: &quot;shipping.app&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;PublicKey&quot;: &quot;UYnz8EeyEv9m2zs3w3X9Xifw4fMalv8YfgE/q4fo1Yc=&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;Access&quot;: [&#xA;        &#xA;        &#xA;          &#xA;                &quot;Shipping&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;Products&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;Customers&quot;&#xA;        &#xA;        &#xA;          &#xA;              ]&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          ]&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          authorizations.json&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;On the client side, I can define something like this:Server=northwind.database.local:9222;Database=Orders;Server Key=6HvG2FFNFIifEjaAfryurGtr&#x2B;ucaNgHfSSfgQUi5MHM=;Client Secret Key=daZBu&#x2B;vbufb6qF&#x2B;RcfqpXaYwMoVajbzHic4L0ruIrcw=Can we achieve this using TLS? On first glance, that doesn&#x2019;t seem to be possible. After all, TLS requires certificates, but we don&#x2019;t have to give up just yet. One of the (new) options for certificates is Ed25519, which is a key pair scheme that uses 256 bits keys. That is also similar to what I have used in my previous posts, behind the covers. So the plan is to do the following:Generate key pairs using Ed25519 as before.Distribute the knowledge of the public keys as before.Generate a certificate using those keys.During TLS handshake, trust only the keys who we were explicitly told to trust, disabling any PKI checks.That sounds reasonable, right?&#xA0; Except that I failed. To be rather more exact, I couldn&#x2019;t generate a valid X509 certificate from Ed25519 key pair. Using .NET, you can use the CertificateRequest class to generate certificates, but it only supports RSA and ECDsa keys. Safe sizes for those types are probably:RSA &#x2013; 4096 bits (2048 bits might also be acceptable) &#x2013; key size on disk: 2,348 bytes.ECDsa &#x2013; 521 bits&#xA0; - key size on disk: 223 bytes.The difference between those and the 32 bytes key for Ed25519 is pretty big. It isn&#x2019;t much in the grand scheme of things, for sure, but it matters. The key issue (pun intended) is that this is large enough to make it awkward to use the value directly. Consider the connection string I listed above. The keys we use here are small enough that we can just write them inline (simplest and most oblivious thing to do). The keys for either of the more commonly used RSA and ECDsa are too big for that. Here is a ECDsa key, for example:MIHcAgEBBEIBuF5HGV5342&#x2B;1zk1/Xus4GjDx&#x2B;FR&#xA;rbOPrC0Q&#x2B;ou5r5hz/49w9rg4l6cvz0srmlS4/Ysg&#xA;H/6xa0PYKnpit02assuGgBwYFK4EEACOhgYkDgYY&#xA;ABABaxs8Ur5xcIHKMuIA7oedANhY/UpHc3KX&#x2B;SKc&#xA;K&#x2B;NIFue8WZ3YRvh1TufrUB27rzgBR6RZrEtv6yuj&#xA;2T2PtQa93ygF761r82woUKai7koACQZYzuJaGYbG&#xA;dL&#x2B;DQQApory0agJ140T3kbT4LJPRaUrkaZDZnpLA&#xA;oNdMkUIYTG2EYmsjkTg==&#xA;And here is an RSA key:MIIJKAIBAAKCAgEApkGWJc&#x2B;Ir0Pxpk6affFIrcrRZgI8hL6yjXJyFNORJUrgnQUw&#xA;i/6jAZc1UrAp690H5PLZxoq&#x2B;HdHVN0/fIY5asBnj0QCV6A9LRtd3OgPNWvJtgEKw&#xA;GCa0QFofKk/MTjPimUKiVHT&#x2B;XgZTnTclzBP3aSZdsROUpmHs2h4eS9cRNoEnrC1u&#xA;YUzaGK4OeQNLCNi1LyB6I33697&#x2B;dNLVPoMJgfDnoDBV12KtpB6/pLjigYgIMwFx/&#xA;Qyx9DhnREXYst/CLQs8S/dmF&#x2B;opvghhdhiUUOUwqGA/mIIbwtnhMQFKWCQXEk7km&#xA;5hNg/fyv/qwqvTkqQTZkJdj0/syPNhqnZ9RurFPkiOwPzde8I/QwOkEoOXVMboh4&#xA;Ji3Y6wwEkWSwY/9rzUK2799lzTmZlvUu2ZxNZfKxQ84vmPUCvP288KXOCU4FxIUX&#xA;lujBu7aXUORtQE9oZxBSxqCSqmCEb7jGwR3JOpFlUZymK7W0jbY4rmfZL8vcDYdG&#xA;r0msuXD&#x2B;ggVjYzpHI7EH5MtQXYJZ2aKan5ZpSL/Lb0HsjkDLrsvMi&#x2B;72FcwXH&#x2B;5P&#xA;Q1E30uxs5y9xOTSqff9T9x6KPAOwIpmrv4Bc3J0NgEgWiKxG9nM1&#x2B;f8FkKlCRino&#xA;rrF9ZrC&#x2B;/l/vc67xye&#x2B;Pr1tLvEFT5ARu/nR1JH/Lv/CsAU9y51wOPqD6dQUCAwEA&#xA;AQKCAgBJseTWWcnitqFU8J62mM94ieCL8Q3WYZlP7Zz38lfySeCKeZRtWa/zsozm&#xA;XEQY0t7&#x2B;807pHPLs0OhMHlFv1GQKj09Wg4XvWWgqvLOSucC7QZ6cLfNUoUNhCxGp&#xA;dbnAKGuXN9wwx7NBBljl5V4Ruf//UgxRw7YuklWk0ZjoUSrGGDX3siOtaZ17Nxwf&#xA;NAB8qWKWwzSgquUmEH&#x2B;kr4HeZorSRfC/&#x2B;ntEUaa6y5T28g7Vosb4NYgLxJqiN3te&#xA;3B0yY6O3N4bZkyQ6TEblSdua7LCsPUCjbdi6LlZg664RDQqIcVATkwzVC14A95Mj&#xA;tjkzqzU5ttxpkmP21cHdX6847QcpERgQ7NzAbjrU5UH8aBOsetaZo/1yDr5U13ah&#xA;YcAq9XX6tLeAA0rUsnXKAWBQswtWIU0jXBuRRSE7xDXv&#x2B;82SWEoPqZMSAv77p&#x2B;uc&#xA;AeogN&#x2B;zzZPPet/AOERKLcGC9WoC/HT7q/H3zFAsRPoKY6qMfLFntdosc0lmRxvHv&#xA;b9NXBzKdDuOiUXhdRMhL5Yld8ivvHuwRnPfcZycplSFrA9E5xo/S3RQj&#x2B;Re9L0yR&#xA;8tNzjl&#x2B;lcgtk8Q0CSJl6eW2Fjja5ZrvDD8qL97&#x2B;WFqHR7LTTqZ7TmiT7u1MXW1Il&#xA;wTuccWCQ85BzxpRbyzPXLdsxMgPCmjicX/23&#x2B;srOXAk2z42bOQKCAQEAzM1Mocnd&#xA;w0uoETHZH0VX29WaKVqUAecGtrj&#x2B;YNujzmjLy2FPW10njgBfZgkVQETjFxUS9LBZ&#xA;xv/p6fCio3NgXh3q7O/kWLxojuR8JB7n4vxoKGBwinwzi1DHp37gzjp/gGdr4mG9&#xA;8b7UeFJY8ZPz0EoXcPr3TL&#x2B;69vOoLieti/Ou9W7HbpDHXYLKclFkJ0d/0AtDNaM7&#xA;kCNvI7HgC5JvCCOdGatmbB09kniQjtvE4Wh4vOg/TtH1KoKGXbC8JnjHNRjJtgqU&#xA;1mhbq36Eru8iOVME9jyHAkSPqphqeayEUdeP3C1Bc2xmrlxCQALZrAfH37ZWcf44&#xA;UuOO5TMnf5HTLwKCAQEAz9F59/xlVDHaaFpHK6ZRTQQWh6AVBDKUG2KDqRFAGQik&#xA;6YqQwJFGSo1Z&#x2B;FjXzidGEHkqH6KyGtSxS6dTgqqfTC96P1rdrBab5vgdXpfSa/0S&#xA;Qke2sH3eZ1vWJe95AD7AuVfsN/6IXIBHP5fWjXthGuo6U3vkkNjdjJGNxjfuMuug&#xA;SbxjjVV6kZI6gwX2gfTQDKUT&#x2B;yRjEnqGAyCcFeZXwWGryF1IseOFaNB2ATVKSqn9&#xA;oXI7AaI3ZRX3SyfOfyo3TaZEXabS1tfEg4JwIGNpx8WvRxb/X7WZi46be8u0ya4L&#xA;BDJ6ZIOBf7lpvaI1Dr3dzCuPqjGQ3V/xPwGy5D8&#x2B;CwKCAQEAuFVUUw6pjn0LIabX&#xA;QQEd6hzgq7X&#x2B;H5Q8A7yQIMewMTk7rKvCTH6U&#x2B;oe1VdZ5DSazqvPp4tjThXyTol9X&#xA;U3ymUS/mYiotQf0asvpODgjPOAttCGJ9CPhvQEaN3WEioBwg5IaxoMnOt8bF4CJm&#xA;MdG0ElaNsMACVE8BzgJS7nACEURcxkVWNVsURkNRSgGd/oipLqzkamOoWby67MrN&#xA;2DyNuSqs3QzbnBXZdHsVya9fDm8EtSroyF3Lp95hZ/SJ9KqiylSsQTBW9IBrefjf&#xA;HcDY8fWaMrMZ5V2mXarfsvInCq7VqhwFnAkGhos9ifXGy8MZEG9CcUmakmiFFiCr&#xA;vXOYOwKCAQADL9Yr/F3dbapIwWGoBLPod3CVAdpwpwnoZZlZRV9zQtOslShlG5U1&#xA;XXeMvGgKzEVhyUnhFFCg4rQZUeaQ8Wbh9zRrtkwB8JLRduqUYcWjTE00YP8nM7bu&#xA;ZNUi3cpAO7Ye4X9I2Ilkyb7N9dkfcE3r6L2ePB8kLX8wQacn7AGmHEDoAJCSQUZQ&#xA;5yooijXehk&#x2B;OchWdW1B9nw1hDOX33AFqgMHun6eWusN3&#x2B;QJmQFf0TykJicPn4YHx&#xA;9eVF7MVY49/XO/5&#x2B;ZSmEi&#x2B;iCj8SCaqPboWdvsqWV5SYGotg1jMkn8phOpyuDURTy&#xA;TXiWpN8la7n0AJMCbCIpkugTLEZ/A41DAoIBAAr73RhOZWDi40D6g&#x2B;Z2KLHMtLdn&#xA;xHMEkT0bzRZYlr0WGQpP/GPKJummDHuv/fRq2qXhML7yh7JK8JFxYU94fW2Ya1tx&#xA;lYa5xtcboQpBLfDvvvI4T4H1FE4kXeOoO46AtZ6dFZyg3hgKlaJkR&#x2B;pFPLr5Aeak&#xA;w9&#x2B;6UCK8v72esoKzCMxQzt3L2euYRt4zTKL3NnrgS7i5w56h2UvP1rDo3P0RVoqc&#xA;knS1ToamVL2JaPnf/g&#x2B;gUUVZyya9pyu9RP8MIcd1cvnxZec8JaN89WWnsA2JJbPw&#xA;stYBnWMvLFabPtPXVcsLrWMEmLFI2yn&#x2B;fU4YTviwRSs/SrprXDdsqZO2xd8=Note that in both cases, we are looking at the private key only. As you can imagine, this isn&#x2019;t really something viable. We will need to store that separately, load it from a file, etc. I tried generating Ed25519 keys using the built-in .NET API as well as the Bouncy Castle one. Bouncy Castle is a well known cryptographic library that is very useful. It also supports Ed25519. I spent quite some time trying to get it to work. You can see the code here. Unfortunately, while I&#x2019;m able to generate a certificate, it doesn&#x2019;t appear to be valid. Here is what this looks like:Using RSA, however, did generate viable certificates, and didn&#x2019;t take a lot of code at all:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private static X509Certificate2 GenerateCertificate(string keyFile, string nmae)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            var rsa = RSA.Create(4096);&#xA;        &#xA;        &#xA;          &#xA;            var key = File.ReadAllBytes(keyFile);&#xA;        &#xA;        &#xA;          &#xA;            rsa.ImportRSAPrivateKey(key, out _);&#xA;        &#xA;        &#xA;          &#xA;            var req = new CertificateRequest(&quot;cn=&quot; &#x2B; nmae, rsa, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);&#xA;        &#xA;        &#xA;          &#xA;            var serverCertificate = req.CreateSelfSigned(DateTime.Today.AddDays(-1), DateTime.Today.AddYears(3));&#xA;        &#xA;        &#xA;          &#xA;            // yuck: https://github.com/dotnet/runtime/issues/23749&#xA;        &#xA;        &#xA;          &#xA;            return new X509Certificate2(serverCertificate.Export(X509ContentType.Pkcs12, (string) null), (string)null);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          temp_cert.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;We store the actual key in a file, and we generate a self signed certificate on the fly. Great. I did try to use the ECDsa option, which generates a much smaller key, but I run into sever issues there. I could generate the key, but I couldn&#x2019;t use the certificate, I run into a host of issues around permissions, somehow. You can try to figure out more details from this issue, what I took from that is that in order to use ECDsa on Windows, I would need to jump through hoops. And I don&#x2019;t know if Ed25519 will even work or how to make it.As an aside, I posted the code to generate the Ed25519 certificates, if you can show me how to make it work, it would be great.So we are left with using RSA, with the largest possible key. That isn&#x2019;t fun, but we can make it work. Let&#x2019;s take a look at the connection string again, what if we change it so it will look like this?Server=northwind.database.local:9222;Database=Orders;Server Key Hash=6HvG2FFNFIifEjaAfryurGtr&#x2B;ucaNgHfSSfgQUi5MHM=;Client Key=client.keyI marked the pieces that were changed. The key observation here is that I don&#x2019;t need to hold the actual public key here, I just need to recognize it. That I can do by simply storing the SHA256 signature of the public key, that ensures that I always have the same length, regardless of what key type I&#x2019;m using. For that matter, I think that this is something that I want to do regardless, because if I do manage to fix the other key types, I could still use the same approach. All values in SHA256 will hash to the same length, obviously.After all of that, what do we have?We generate a keypair and store, we let the other side know about the public key hash as the identifier. Then we dynamically generate a certificate with the stored key. Let&#x2019;s say that we do that once per startup. That certificate is going to be different each run, but we don&#x2019;t actually care, we can safely authenticate the other side using the (persistent) key pair by validating the public key hash. Here is what this will look like in code from the client perspective:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var clientCert = GenerateCertificate(&quot;client.key&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          // the expected server public key hash&#xA;        &#xA;        &#xA;          &#xA;          var certCertPublicKeyHash = &quot;6HvG2FFNFIifEjaAfryurGtr&#x2B;ucaNgHfSSfgQUi5MHM=&quot;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var tcpClient = new TcpClient();&#xA;        &#xA;        &#xA;          &#xA;          tcpClient.Connect(IPAddress.Loopback, 9222);&#xA;        &#xA;        &#xA;          &#xA;          var clientSsl = new SslStream(tcpClient.GetStream(), false, (sender, certificate, chain, errors) =&gt;&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var publicKeyHash = SHA256.HashData(certificate.GetPublicKey());&#xA;        &#xA;        &#xA;          &#xA;              return certCertPublicKeyHash == Convert.ToBase64String(publicKeyHash);&#xA;        &#xA;        &#xA;          &#xA;          });&#xA;        &#xA;        &#xA;          &#xA;          clientSsl.AuthenticateAsClient(@&quot;foobar&quot;, new X509Certificate2Collection(clientCert), SslProtocols.Tls12, false);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var reader = new StreamReader(clientSsl);&#xA;        &#xA;        &#xA;          &#xA;          Console.WriteLine(reader.ReadLine());&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          client.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;And here is what the server is doing:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private static async Task&lt;Stream&gt; HandleConnection(&#xA;        &#xA;        &#xA;          &#xA;              TcpClient client, &#xA;        &#xA;        &#xA;          &#xA;              X509Certificate2 serverCertificate,&#xA;        &#xA;        &#xA;          &#xA;              HashSet&lt;string&gt; allowedClientKeys)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var serverSsl = new SslStream(client.GetStream(), false, (_, _, _, _) =&gt; true); // allow all clients certificates&#xA;        &#xA;        &#xA;          &#xA;              await serverSsl.AuthenticateAsServerAsync(serverCertificate, clientCertificateRequired: true, SslProtocols.Tls12, false);&#xA;        &#xA;        &#xA;          &#xA;              var clientPublicKeyHash =&#xA;        &#xA;        &#xA;          &#xA;                  Convert.ToBase64String(SHA256.HashData(serverSsl.RemoteCertificate?.GetPublicKey() ??&#xA;        &#xA;        &#xA;          &#xA;                                                         Array.Empty&lt;byte&gt;()));&#xA;        &#xA;        &#xA;          &#xA;              await using var writer = new StreamWriter(serverSsl);&#xA;        &#xA;        &#xA;          &#xA;              if (allowedClientKeys.Contains(clientPublicKeyHash) == false)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  // failed to authenticate, send a proper error message&#xA;        &#xA;        &#xA;          &#xA;                  await using var _ = serverSsl;&#xA;        &#xA;        &#xA;          &#xA;                  await writer.WriteLineAsync(&quot;ERROR Client is not authorized: &quot; &#x2B; clientPublicKeyHash);&#xA;        &#xA;        &#xA;          &#xA;                  await serverSsl.FlushAsync();&#xA;        &#xA;        &#xA;          &#xA;                  return null; // client failure&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              await writer.WriteLineAsync(&quot;OK&quot;);&#xA;        &#xA;        &#xA;          &#xA;              return serverSsl;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          server.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, this is very similar to what I ended up with in my secured protocol, but it utilizes TLS and all the weight behind it to achieve the same goal. A really important aspect of this is that we can actually connect to the server using something like openssl s_client &#x2013;connect, which can be really nice for debugging purposes.However, the weight of TLS is also an issue. I failed to successfully create Ed25519 certificates, which was my original goal. I couldn&#x2019;t get it work using ECDsa certificates and had to use RSA ones with the biggest keys. It was obvious that a lot of those issues are because we are running on a particular operating system, which means that this protocol is subject to the whims of the environment still. I have also not done everything that is required to ensure that there will not be any remote calls as part of the TLS handshake in this case, that can actually be quite complex to ensure, to be honest. Given that these are self signed (and pretty bare boned) certificates, there shouldn&#x2019;t be any, but you know what they say about assumptions .The end goal is that we are now able to get roughly the same experience using TLS as the underlying communication mechanism, without dealing with certificates directly. We can use standard tooling to access the server, which is great. Note that this doesn&#x2019;t address something like browser access, which will not be trusted, obviously.&#xA0; For that, we have to go back to Let&#x2019;s Encrypt or some other trusted CA, and we are back in PKI land.</p>
        </article>
        <article id="article-1179">
            <a href="https://ardalis.com/design-patterns-overview/" target="_blank">
                <h2 class="title mb-6" id="article-1179">Design Patterns Overview</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 12, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Design patterns provide reusable approaches to common problems and allow for higher level discussions of software design. Learn the basics&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-1180">
            <a href="https://andrewlock.net/exploring-dotnet-6-part-5-supporting-ef-core-tools-with-webapplicationbuilder/" target="_blank">
                <h2 class="title mb-6" id="article-1180">Supporting EF Core migrations with WebApplicationBuilder</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 12, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Exploring .NET 6 - Part 5</p>
        </article>
        <div class="button flex justify-between">
            <a href="117.html"><span class="back arrow"></span></a>

            <a href="119.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	"> Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
