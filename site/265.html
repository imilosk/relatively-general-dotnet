
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/167331/map-reduce-visualizer-take-ii" target="_blank"><h1 class="title mb-6">Map/Reduce visualizer, take II</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 21, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Yes, I talked about this already, but we made some additional improvements that make it even cooler. Here is a document:  And here is the index:  Now, let us look at what happens when we go to the map/reduce visualizer:  This is a highly zoomed out picture, let us zoom a little (click it for higher zoom):   As you can see, we can see all the documents that have any reduce keys shared with the reduce keys from the document we started from. That is going to make explaining, and debugging, map/reduce so much easier. For that matter, here is an example of the visualizer showing us a multi step reduce. Which is an optimization that happens when we have a lot of entries for the same reduce key. Now we can actually show you how this works:  Pretty cool!</p>
        <a href="https://ardalis.com/javascript-date-tips/" target="_blank"><h1 class="title mb-6">JavaScript Date Tips</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 18, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The other night at the Hudson Software Craftsmanship meeting at the Falafel Software training center in Hudson, Ohio, I did the Red Pencil&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/167363/introducing-inefficiencies-into-ravendb-on-purpose" target="_blank"><h1 class="title mb-6">Introducing inefficiencies into RavenDB, on purpose</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 18, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Yes, I choose the title on purpose. The topic of this post is this issue. In RavenDB, we use replication to ensure high availability and load balancing. We have been using that for the past five years now, and in general, it has been great, robust and absolutely amazing when you need it. But like all software, it can run into interesting scenarios. In this case, we had three nodes, call them A, B and C. In the beginning, we had just A &amp; B and node A was the master node, for which all the data was written and node B was there as a hot spare. The customer wanted to upgrade to a new RavenDB version, and they wanted to do that with zero downtime. They setup a new node, with the new RavenDB server, and because A was the master server, they decided to replicate from node B to the new node. Except&#x2026; nothing appear to be happening.  No documents were replicating to the new node, however, there was a lot of CPU and I/O. But nothing was actually happening. The customer opened a support call, and it didn&#x2019;t take long to figure out what was going on. The setup the replication between the nodes with the default &#x201C;replicate only documents that were changed on this node&#x201D;. However, since this was the hot spare node, no documents were ever changed on that node. All the documents in the server were replicated from the primary node. The code for that actually look like this:  public IEnumerable&lt;Doc&gt; GetDocsToReplicate(Etag lastReplicatedEtag){    foreach(var doc in Docs.After(lastReplicatedEtag)    {         if(ModifiedOnThisDatabase(doc) == false)               continue;         yield return doc;    }}var docsToReplicate = GetDocsToReplicate(etag).Take(1024).ToList();Replicate(docsToReplicate);&#xA;However, since there are no documents that were modified on this node, this meant that we had to scan through all the documents in the database. Since this was a large database, this process took time. &#xA;The administrators on the server noted the high I/O and that a single thread was constantly busy and decided that this is likely a hung thread. This being the hot spare, they restarted the server. Of course, that aborted the operation midway, and when the database started, it just started everything from scratch.&#xA;The actual solution was to tell the database, &#x201C;just replicate all docs, even those that were replicated to you&#x201D;. That is the quick fix, of course.&#xA;The long term fix was to actually make sure that we abort the operation after a while, report to the remote server that we scanned up to a point, and had nothing to show for it, and go back to the replication loop. The database would then query the remote server for the last etag that was replicated, it would respond with the etag that we asked it to remember, and we&#x2019;ll continue from that point.&#xA;The entire process is probably slower (we make a lot more remote calls, and instead of just going through everything in one go, we have to stop, make a bunch of remote calls, then resume). But the end result is that the process is now resumable. And an admin will be able to see some measure of progress for the replication, even in that scenario.</p>
        <a href="https://ayende.com/blog/167362/the-fallacy-of-distributed-transactions" target="_blank"><h1 class="title mb-6">The fallacy of distributed transactions</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 17, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This can be a very short post, just: See CAP. Unfortunately, we have a lot of people who actually have experience in using distributed transactions, and have a good reason to believe that they work. The answer is that yes, they do, as long as you don&#x2019;t run into some of the interesting edge cases. By the way, that is not a new observation, see The Two Generals. Allow me to demonstrate. Assume that we have a distributed system with the following actors:   This is a fairly typical setup. You have a worker that pull messages from a queue and read/write to a database based on those messages. To coordinate between them, it uses a transaction coordinator such as MSDTC. Transaction coordinators use a two phase commit (or sometimes a three phase commit protocols) to ensure that either all the data would be committed, or none of it would be. The general logics goes like this:  For each participant in the transaction, send a prepare message.   If the participant answered &#x201C;prepared&#x201D;, it is guaranteeing that the transaction can be committed. If any of the participants failed on prepare, abort the whole transaction. If all of the participants successfully prepared, send the commit message to all of them. The actual details are a bit more involved, obviously, but that is pretty much it. Now, let us take a look at an interesting scenario. Worker #1 is pulling (in a distributed transaction) a message from the queue, and based on that message, it modify the database. Then it tells the transaction coordinator that it can commit the transaction. At this point, the TC is sending the prepare message to the database and the queue. Both reply that they have successfully prepared the transaction to be committed. The TC sends a commit message to the queue, completing the transaction from its point of view, however, at this point, it is unable to communicate with the database. What happens now? Before I answer that, let us look at another such scenario. The TC needs to commit a transaction, it sends a prepare message to the database, and receive a successful reply. However, before it manages to send a prepare message to the queue, it becomes unavailable. Note that from the point of view of the database, the situation looks exactly the same. It got (and successfully replied) to a Prepare message, then it didn&#x2019;t hear back from the transaction coordinator afterward. Now, that is where it gets interesting. In an abstract world, we can just wait with the pending transaction until the connection with the coordinator is resumed, and we can actually get a &#x201C;commit / abort&#x201D; notification. But we aren&#x2019;t in abstract world. When we have such a scenario, we are actually locking records in the database (because they are in the process of being modified). What happens when another client comes to us and want to modify the same record? For example, it is quite common for to host the business logic, queue and transaction coordinator on the same worker instance, while the database is on a separate machine. That means that in the image above, if Worker #1 isn&#x2019;t available, we recover by directing all the users to the 2nd worker. However, at that point, we have a transaction that was prepared, but not committed.  When the user continue to make requests to our system, the 2nd worker, which has its own queue and transaction coordinator is going to try and access the user&#x2019;s record. The same user whose record are currently locked because of the ongoing transaction. If we just let it hang in this manner, we have essentially created a situation where the user&#x2019;s data become utterly unavailable (at least for writes). In order to resolve that, transactions comes with a timeout. So after the timeout has expired, we can roll back that transaction. Of course, that leads to a very interesting situation. Let us go back to the first scenario we explored. In this scenario, the queue got both Prepare &amp; Commit messages, while the database got just a Prepare message. The timeout has expired, and the database has rolled back the transaction.&#xA0; In other words, as far as the queue is concerned, the transaction committed, and the message is gone. As far as the database is concerned, that transaction was rolled back, and never happened.  Of course, the chance that something like that can happen in one of your systems? Probably one in a million.</p>
        <a href="https://ardalis.com/where-to-declare-variables-in-c-and-javascript/" target="_blank"><h1 class="title mb-6">Where to Declare Variables in C# and JavaScript</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 16, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Both JavaScript and C# belong to the C family of languages. They share curly braces and semi-colons, and in fact there are many cases where&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/167425/when-a-race-condition-is-what-you-want" target="_blank"><h1 class="title mb-6">When a race condition is what you want&#x2026;</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 16, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have an interesting situation that I am not sure how to resolve. We need to record the last request time for a RavenDB database. Now, this last request time is mostly used to show the user, and to decide when a database is idle, and can be shut down. As such, it doesn&#x2019;t have to be really accurate ( a skew of even a few seconds is just fine ). However, under load, there are many requests coming in (in the case presented to us, 4,000 concurrent requests), and they all need to update the last request. Obviously, in such a scenario, we don&#x2019;t really care about the actual value. But the question is, how do we deal with that? In particular, I want to avoid a situation where we do a lot of writes to the same value in an unprotected manner, mostly because it is likely to cause contentions between cores. Any ideas?  It is actually fine for us to go slightly back (so thread A at time T&#x2B;1 and thread B at time T&#x2B;2 running concurrently, and the end result is T&#x2B;1), which is why I said that a race is fine for us. But what I want to avoid is any form of locking / contention. I wrote the following test code: class Program&#xA;{&#xA;    static void Main(string[] args)&#xA;    {&#xA;        var threads = new List&lt;Thread&gt;();&#xA;&#xA;        var holder = new Holder();&#xA;&#xA;        var mre = new ManualResetEvent(false);&#xA;&#xA;        for (int i = 0; i &lt; 2500; i&#x2B;&#x2B;)&#xA;        {&#xA;            var thread = new Thread(delegate()&#xA;            {&#xA;                mre.WaitOne();&#xA;                for (long j = 0; j &lt; 500*1000; j&#x2B;&#x2B;)&#xA;                {&#xA;                    holder.Now = j;&#xA;                }&#xA;            });&#xA;            thread.Start();&#xA;            threads.Add(thread);&#xA;        }&#xA;&#xA;        mre.Set();&#xA;&#xA;        threads.ForEach(t =&gt; t.Join());&#xA;&#xA;&#xA;        Console.WriteLine(holder.Now);&#xA;    }&#xA;}&#xA;&#xA;public class Holder&#xA;{&#xA;    public long Now;&#xA;}&#xA;&#xA;&#xA;&#xA;And it looks like it is doing what I want it to. This creates a lot of contention on the same value, but it is also giving me the right value. And again, the value of right here is very approximate. The problem is that I know how to write thread safe code, I&#x2019;m not sure if this is a good way to go about doing this.&#xA;Note that this code (yes, even with 2,500 threads) runs quite fast, in under a second. Trying to use Interlocked.Exchange is drastically more expensive, and Interlocked.CompareExchange is even worse.&#xA;But it is just not sitting well with me.</p>
        <a href="https://ardalis.com/ensure-you-are-not-adding-to-global-scope-in-javascript/" target="_blank"><h1 class="title mb-6">Ensure You Are Not Adding To Global Scope in JavaScript</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 15, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A key best practice if you&#x2019;re writing JavaScript code is to avoid adding objects to the global scope. There are several good reasons for&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/167393/message-passing-performance-take-2" target="_blank"><h1 class="title mb-6">Message passing, performance&#x2013;take 2</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 15, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my previous post, I did some rough &#x201C;benchmarks&#x201D; to see how message passing options behave. I got some great comments, and I thought I&#x2019;ll expand on that. The baseline for this was a blocking queue, and we managed to process using that we managed to get:  145,271,000 msgs in 00:00:10.4597977 for 13,888,510 ops/sec And the async BufferBlock, using which we got:  43,268,149 msgs in 00:00:10 for 4,326,815 ops/sec. Using LMAX Disruptor we got a disappointing:  29,791,996 msgs in 00:00:10.0003334 for 2,979,100 ops/sec However, it was pointed out that I can significantly improve this if I changed the code to be:  var disruptor = new Disruptor.Dsl.Disruptor&lt;Holder&gt;(() =&gt; new Holder(), new SingleThreadedClaimStrategy(256), new YieldingWaitStrategy(), TaskScheduler.Default);&#xA;After which we get a very nice:&#xA;&#xA;141,501,999 msgs in 00:00:10.0000051 for 14,150,193 ops/sec&#xA;Another request I got was for testing this with a concurrent queue, which is actually what it is meant to do. The code is actually the same as the blocking queue, we just changed Bus&lt;string&gt; to ConcurrentQueue&lt;string&gt;.&#xA;&#xA0;&#xA;Using that, we got:&#xA;&#xA;170,726,000 msgs in 00:00:10.0000042 for 17,072,593 ops/sec&#xA;And yes, this is pretty much just because I could. Any of those methods is quite significantly higher than anything close to what I actually need.</p>
        <a href="https://ayende.com/blog/167361/message-passing-performance" target="_blank"><h1 class="title mb-6">Message passing, performance</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 14, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got some replies about the async event loop post, mentioning LMAX Disruptor and performance. I decided to see for myself what the fuss was all about. You can read about the LMAX Disruptor, but basically, it is a very fast single process messaging library. I wondered what that meant, so I wrote my own messaging library:  public class Bus&lt;T&gt;{    Queue&lt;T&gt; q = new Queue&lt;T&gt;();    public void Enqueue(T msg)    {        lock (q)        {            q.Enqueue(msg);        }    }    public bool TryDequeue(out T msg)    {        lock (q)        {            if (q.Count == 0)            {                msg = default(T);                return false;            }            msg = q.Dequeue();            return true;        }    }}&#xA;I think that you&#x2019;ll agree that this is a thing of beauty and elegant coding. I then tested this with the following code:&#xA;&#xA;public static void Read(Bus&lt;string&gt; bus){    int count = 0;    var sp = Stopwatch.StartNew();    while (sp.Elapsed.TotalSeconds &lt; 10)    {        string msg;        while (bus.TryDequeue(out msg))        {            count&#x2B;&#x2B;;        }    }    sp.Stop();    Console.WriteLine(&quot;{0:#,#;;0} msgs in {1} for {2:#,#} ops/sec&quot;, count, sp.Elapsed, (count / sp.Elapsed.TotalSeconds));}public static void Send(Bus&lt;string&gt; bus){    var sp = Stopwatch.StartNew();    while (sp.Elapsed.TotalSeconds &lt; 10)    {        for (int i = 0; i &lt; 1000; i&#x2B;&#x2B;)        {            bus.Enqueue(&quot;test&quot;);        }    }}var bus = new Bus&lt;string&gt;();ThreadPool.QueueUserWorkItem(state =&gt; Send(bus));ThreadPool.QueueUserWorkItem(state =&gt; Read(bus));&#xA;The result of this code?&#xA;&#xA;145,271,000 msgs in 00:00:10.4597977 for 13,888,510 ops/sec&#xA;Now, what happens when we use the DataFlow&#x2019;s BufferBlock as the bus?&#xA;&#xA;public static async Task ReadAsync(BufferBlock&lt;string&gt; bus){    int count = 0;    var sp = Stopwatch.StartNew();    while (sp.Elapsed.TotalSeconds &lt; 10)    {        try        {            await bus.ReceiveAsync(TimeSpan.FromMilliseconds(5));            count&#x2B;&#x2B;;        }        catch (TaskCanceledException e)        {        }    }    sp.Stop();    Console.WriteLine(&quot;{0:#,#;;0} msgs in {1} for {2:#,#} ops/sec&quot;, count, sp.Elapsed, (count / sp.Elapsed.TotalSeconds));}public static async Task SendAsync(BufferBlock&lt;string&gt; bus){    var sp = Stopwatch.StartNew();    while (sp.Elapsed.TotalSeconds &lt; 10)    {        for (int i = 0; i &lt; 1000; i&#x2B;&#x2B;)        {            await bus.SendAsync(&quot;test&quot;);        }    }}&#xA;What we get is:&#xA;&#xA;43,268,149 msgs in 00:00:10 for 4,326,815 ops/sec.&#xA;I then decided to check what happens with the .NET port of the LMAX Disruptor. Here is the code:&#xA;&#xA;public class Holder{    public string Val;}internal class CounterHandler : IEventHandler&lt;Holder&gt;{    public int Count;    public void OnNext(Holder data, long sequence, bool endOfBatch)    {        Count&#x2B;&#x2B;;    }}static void Main(string[] args){    var disruptor = new Disruptor.Dsl.Disruptor&lt;Holder&gt;(() =&gt; new Holder(), 1024, TaskScheduler.Default);    var counterHandler = new CounterHandler();    disruptor.HandleEventsWith(counterHandler);    var ringBuffer = disruptor.Start();    var sp = Stopwatch.StartNew();    while (sp.Elapsed.TotalSeconds &lt; 10)    {        for (var i = 0; i &lt; 1000; i&#x2B;&#x2B;)        {            long sequenceNo = ringBuffer.Next();            ringBuffer[sequenceNo].Val = &quot;test&quot;;            ringBuffer.Publish(sequenceNo);        }    }    Console.WriteLine(&quot;{0:#,#;;0} msgs in {1} for {2:#,#} ops/sec&quot;, counterHandler.Count, sp.Elapsed, (counterHandler.Count / sp.Elapsed.TotalSeconds));}&#xA;And the resulting performance is:&#xA;&#xA;29,791,996 msgs in 00:00:10.0003334 for 2,979,100 ops/sec&#xA;Now, I&#x2019;ll be the first to agree that this is really and absolutely not even close to be a fair benchmark. It is testing wildly different things. Distruptor is using a ring buffer, and the BlockBuffer didn&#x2019;t, and the original Bus implementation just used an unbounded queue. &#xA;But that is a very telling benchmark as well. Pretty much because it doesn&#x2019;t matter. What I need this for is for network protocol handling. As such, even assuming that every single byte is a message, we would have to go far beyond what any reasonable pipe can be expected to be handle.</p>
        <a href="https://ayende.com/blog/167299/async-event-loops-in-c" target="_blank"><h1 class="title mb-6">Async event loops in C#</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: July 11, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;m designing a new component, and I want to reduce the amount of complexity involved in dealing with it. This is a networked component, and after designing several such, I wanted to remove one area of complexity, which is the use of explicitly concurrent code. Because of that, I decided to go with the following architecture:  &#xA0; The network code is just reading messages from the network, and putting them in an in memory queue. Then we have a single threaded event loop that simply goes over the queue and process those messages. All of the code that is actually processing messages is single threaded, which make it oh so much easier to work with. Now, I can do this quite easily with a&#xA0; BlockingCollection&lt;T&gt;, which is how I usually did those sort of things so far. It is simple, robust and easy to understand. It also tie down a full thread for the event loop, which can be a shame if you don&#x2019;t get a lot of messages. So I decided to experiment with async approaches. In particular, using the BufferBlock&lt;T&gt; from the DataFlow assemblies. I came up with the following code:  var q = new BufferBlock&lt;int&gt;(new DataflowBlockOptions{    CancellationToken = cts.Token,});&#xA;This just create the buffer block, but the nice thing here is that I can setup a &#x201C;global&#x201D; cancellation token for all operations on this. The problem is that this actually generate bad exceptions (InvalidOperationException, instead of TaskCancelledException). Well, I&#x2019;m not sure if bad is the right term, but it isn&#x2019;t the one I would expect here, at least. If you pass a cancellation token directly to the method, you get the behavior I expected.&#xA;At any rate, the code for the event loop now looks like this:&#xA;&#xA;private static async Task EventLoop(BufferBlock&lt;object&gt; bufferBlock, CancellationToken cancellationToken){    while (true)    {        object msg;        try        {            msg = await bufferBlock.ReceiveAsync(TimeSpan.FromSeconds(3), cancellationToken);        }        catch (TimeoutException)        {            NoMessagesInTimeout();            continue;        }        catch (Exception e)        {            break;        }        ProcessMessage(msg);    }}&#xA;And that is pretty much it. We have a good way to handle timeouts, and processing messages, and we don&#x2019;t take up a thread. We can also be easily cancelled. I still need to run this through a lot more testing, in particular, to verify that this doesn&#x2019;t cause issues when we need to debug this sort of system, but it looks promising.</p>
        <div class="button flex justify-between">
            <a href="264.html"><span class="back arrow"></span></a>

            <a href="266.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>