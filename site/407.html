
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 407 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4061">
            <a href="https://ayende.com/blog/163873/vorons-log" target="_blank">
                <h2 class="title mb-6" id="article-4061">Voron&#x2019;s Log</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 09, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was thinking, which is a bit dangerous, about Voron&#x2019;s backup story, and things sort of started to roll down the hill from there.  Nitpicker note: None of the things that I am discussing here is actually novel in any way, I am well aware of that. I am articulating my thought process about a problem and how it went down from an initial small feature to something much bigger. Yes, I am aware of previous research in the area. I know that Xyz is also doing that. Thank you in advance. Voron&#x2019;s backup story is&#xA0; a thing of beauty, and I can say that because I didn&#x2019;t write it. I took it all from LMDB. Basically, just copy the entire file in a safe and transactional manner.&#xA0; However, it cannot do incremental backups. So I started thinking about what would be needed to happen to get that, and I found that it is actually a pretty easy proposition.  Whenever we commit a transaction, we have a list of modified pages that we write back to the data file. An incremental backup strategy could be just: Do a full backup &#x2013; copy the full data file and put it somewhere. Keep track of all the modified pages in a log file. Incremental backup would just be copying the change log elsewhere are restarting the change log. Restoring would happen by taking the full data file and applying the changes to it. This looks hard, but not when you consider that we always work in pages, so we can just have a change log format like this:  The process for applying the change log then becomes something like this: foreach(LogEntry entry in GetLogEntryFiles())&#xA;{&#xA;       foreach(Page page in entry.Pages)&#xA;       {&#xA;             WritePageToDataFile(page.PageNumber, page.Base);&#xA;       }&#xA;}&#xA;&#xA;&#xA;And voila, we have incremental backups. &#xA;Of course, this means that we will have to write the data twice, once for the incremental log file, and once for the actual data file. But that led me to another series of thoughts. Once of the areas where we can certainly do better is random writes. This is an area where we have a particular problem with. I already discussed this here. But if we already have a log file (which we need to support incremental backups), and if we already write twice&#x2026; why not take advantage of that.&#xA;Instead of having a change log, we can have a write ahead log. That turn all of our writes into sequential writes. Leading to much faster performance overall.&#xA;The downside of write ahead logging is that you are going to need to do a few important things. To start with, there is a point where you need to spill the write ahead log into the actual file. That leads to doubling the costs of writes, in comparison to LMDB&#x2019;s usual manner of only a single write. It also means that you now have to implement some form of recovery, since we need to read the log at startup.&#xA;The benefits however are pretty good, I think. There is a reason why most databases have some form of Write Ahead Log to make sure that their writes are sequential. And the nice thing about it is that we can now flush only very clearly defined section of the file, and only do fsyncs on the actual log file.&#xA;The idea now becomes:&#xA;In the data file header we add record to indicate what is the last flushed log file, and up to where in the log file we flushed. We pre-allocate a log file with 64MB, and start write to it using mem map. &#xA;We also write to the end of of the mapped range, and we can safely state what section of the file needs to flush &amp; fsynced, and it is always at the (logical) end of the file. Once every X (where X is time or size or just idleness), we take all the records from the log file from the last position we flushed the log file to the current location, then update the data file header accordingly.&#xA0; The fun part about this is that this is absolutely safe in the case of failure. If we failed midway through for any reason, we can just re-apply the process from the beginning and there can be no corruption. There is also a good chance for being able to do additional optimizations here, because we can merge a lot of writes into a single operation and then make sure that we access the disk in a predictable and optimal fashion. All of this means that this can be an async process that is allowed to fail, which is very good from our perspective, because it means we can just kick it off with low priority to avoid having impacting regular write performance.&#xA;Until we get the data flushed to the data file, we maintain an in memory map of pages. In the image above, we will have a map for pages 2,3,13,19 and when they are requested, we will give out the address of the memory mapped log file entry at the appropriate location.&#xA;One thing that I want to avoid is stalls, like what happen to leveldb under heavy sustained writes. So when the log file is full, we just create a new log file and write to that. It is possible that under very heavy load you&#x2019;ll have the &#x201C;flush to data file&#x201D; process take long enough that the new log file will also be full before the process is done. Unlike leveldb, we are going to just go ahead and create a new log file. So when the &#x201C;flush to disk file&#x201D; process resumes, it may need to process multiple log files. That is fine with us, and likely to be even better, because free space reuse will mean that we can probably skip writing pages that were overwritten by newer transactions (for example, above, we only need to write page 3 once).&#xA;There are a bunch of &#x201C;details&#x201D; that still need to be done:&#xA;&#xA;What happens if you have a single transaction that is bigger than the size of the log file? &#xA;&#xA;We can reject that transaction, 64MB per transaction is a lot.&#xA;Probably it means that we need to have a log file dedicated to that transaction, but how do we detect / decide that? That doesn&#x2019;t seems workable.&#xA;Probably better would be to keep the 64MB size but say that this is a transaction start only, and that we need to process transaction end before we consider this committed. This is very similar to the way the leveldb log works.&#xA;Need to think about way to reduce the impact of flushing the logs:&#xA;&#xA;Maybe provide a way for the user to &#x201C;suppress&#x201D; this for a period of 1 minute. We can use that during things like bulk insert, to get very high speed. And as long as the bulk insert goes, we will keep asking for an extension. (I don&#x2019;t want to have on/off switches, because that means we have to be very careful about turning it on again).&#xA;Maybe we can detect the rate of writes and adjust accordingly? But what happens when we are running multiple databases at the same time?&#xA;Transaction logs should be named 0000000001.txlog, 0000000002.txlog, etc. Because I keep getting send them as &#x201C;database log&#x201D; during debug scenarios.&#xA;Need to make sure that this works properly for large values. So values that takes more than a single page are supported.&#xA;&#xA;To make things complicated, what happen if we are the last 3 items in the log file, but we need to write a value that is 5 pages long? We need to mark the transaction as &#x201C;tx started&#x201D;, move to the next log file, and continue the transaction.&#xA;For that matter, what if we have a single value that is more than the size of the log file? Is that something that we want to support? We can do the same as &#x201C;tx started&#x201D;, marker, but maybe also indicate that we a &#x201C;tx large value start&#x201D;, &#x201C;tx large value mid&#x201D;, &#x201C;tx large value end&#x201D;.&#xA;For both &#x201C;tx started&#x201D; and &#x201C;tx large value started&#x201D; we need to be sure that we consider the transaction aborted unless we have the &#x201C;tx end&#x201D; part.&#xA;On startup, we need to read the log file(s) from the last flushed log location and upward and build the map of the pages contained in the log file. This introduce a &#x201C;recovery&#x201D; step of a sort, but I think that this should be a pretty small one overall.&#xA;We need to make sure to delete old log files (unless users want them to incremental backup purposes). And we need to make sure that the memory map for read transactions is kept alive as long there are any transactions that may be reading from it.&#xA;Overall, I think that this is a pretty radical departure in our internal process compare to how LMDB works, but I have high hopes for this. Even though it starts with &#x201C;do we really need to support incremental backups?&#x201D;&#xA;My expectation is that we will see much higher writes, and about the same numbers for reads. Especially for our scenarios.</p>
        </article>
        <article id="article-4062">
            <a href="https://ayende.com/blog/163841/the-candy-crush-challenge" target="_blank">
                <h2 class="title mb-6" id="article-4062">The Candy Crush Challenge</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 08, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Here is an interesting challenge. In Candy Crush (which I do not have a problem with), you have 5 lives to try. Life renew at a rate of about 1 per 30 minutes. So it is pretty common to get to this stage:  Now, you can go and change your system clock, and then you&#x2019;ll get 5 more lives, and you can play some more.  Now, there are probably very good reason why this is done in this manner, to ensure players are still hooked, and it is just inconvenient enough that there is still meaning to the number of lives you have.  However, let us say that we wanted to stop that. How would you go about approaching this? Remember, we are talking about an app on a phone, and this isn&#x2019;t something super serious if it gets broken, but we want to avoid the super easy workaround. How would you solve that if this was on a computer, instead of a phone? What are the different considerations? What if this was something that was very important?</p>
        </article>
        <article id="article-4063">
            <a href="https://ayende.com/blog/163809/ravendb-2-5-hidden-feature-index-debugging" target="_blank">
                <h2 class="title mb-6" id="article-4063">RavenDB 2.5 hidden feature: Index debugging</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 07, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Here is something that you aren&#x2019;t likely to know, mostly because it is an internal feature that we mostly use to fix strange stuff. You can debug into the indexing functions, and see exactly what happens during indexing / transformers:  To be fair, this is probably something that you won&#x2019;t really have a chance to se, but for debugging the really hard stuff, it is invaluable.</p>
        </article>
        <article id="article-4064">
            <a href="https://ayende.com/blog/163969/update-on-ravendb-at-nbc-universal" target="_blank">
                <h2 class="title mb-6" id="article-4064">Update on RavenDB at NBC Universal</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 06, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I just got an email from NBC Universal about the RavenDB usage. We&#x2019;ve previously talked with them about their RavenDB usage, and I was very pleased to hear that they have completed their upgrade to RavenDB 2.x.&#xA;&#xA;&#x9;I was even happier to hear the results of the upgrade:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;Index times decreased&#xA0; (75% improvement)&#xA;&#x9;&#xA;&#x9;&#x9;Replication &#x2B; Indexing times decreased (40% improvement)&#xA;&#x9;&#xA;&#x9;&#x9;Development server raven restore times decreased (75% improvement)&#xA;&#x9;&#xA;&#x9;&#x9;Memory leak/crash frequency decreased (1)&#xA0;(60% improvement &#x2013; stronger devices are experiencing no crashes)&#xA;&#x9;&#xA;&#x9;&#x9;Support from Hibernating Rhinos will now improve as they are more capable of supporting the new version&#xA;&#xA;&#xA;&#x9;I like getting such news from customers.&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;The scenario they are talking about is overloading the system. It exhibits itself as a high memory utilization. On small devices, that can lead to crashes due to out of memory errors.</p>
        </article>
        <article id="article-4065">
            <a href="https://ayende.com/blog/163745/the-saga-of-the-race-condition-re-fix" target="_blank">
                <h2 class="title mb-6" id="article-4065">The saga of the race condition re-fix</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 04, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is a story about a bug, RavenDB-1280, to be exact. It is really bad when we start with a race condition bug, and it only gets worse from there. The story begins with the following index: public class EmailIndex : AbstractIndexCreationTask&lt;EmailDocument, EmailIndexDoc&gt;&#xA;{&#xA;    public EmailIndex()&#xA;    {&#xA;        Map =&#xA;            emails =&gt; from email in emails&#xA;                    let text = LoadDocument&lt;EmailText&gt;(email.Id &#x2B; &quot;/text&quot;)                 &#xA;                    select new&#xA;                            {&#xA;                                email.To,&#xA;                                email.From,&#xA;                                email.Subject,&#xA;                                Body = text == null ? null : text.Body&#xA;                            };&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;So far, this&#xA0; is a pretty standard index using LoadDocument. The LoadDocument feature allows us to also index data from related documents, and the database will ensure that when the loaded document is changed, the requesting document will also be re-indexed.&#xA;What does this mean? It means that when we change the text of an email, we will also be re-indexing that email&#x2019;s document. Internally, we store it in something that looks like this (using relation model because it is probably easy to follow for most of you):&#xA;CREATE TABLE DocumentReferences&#xA;{&#xA;   Source,&#xA;   Reference&#xA;}&#xA;&#xA;&#xA;&#xA;&#xA;So in the case above, we will have (Source: emails/1 and Reference: emails/1/text).&#xA;Whenever we modify a document, we check the stored references for matches. If we were using a relational database, the code would be something like:&#xA;foreach ( var src in (SELECT Source FROM DocumentReferences WHERE Reference = @ref))&#xA;{&#xA;   TouchDocument(src);&#xA;}&#xA;&#xA;&#xA;So far, so good. This ensures that we are always keep the index up to date. Obviously, this also means that the indexing process needs to update the references as well. Which brings us to the problematic part:&#xA;Parallel.For(0, iterations, i =&gt;&#xA;{&#xA;    using (var session = documentStore.OpenSession())&#xA;    {&#xA;        session.Store(new EmailDocument {Id = &quot;Emails/&quot;&#x2B; i,To = &quot;root@localhost&quot;, From = &quot;nobody@localhost&quot;, Subject = &quot;Subject&quot; &#x2B; i});&#xA;        session.SaveChanges();&#xA;    }&#xA;&#xA;    using (var session = documentStore.OpenSession())&#xA;    {&#xA;        session.Store(new EmailText { Id = &quot;Emails/&quot; &#x2B; i &#x2B; &quot;/text&quot;, Body = &quot;MessageBody&quot; &#x2B; i });&#xA;        session.SaveChanges();&#xA;    }&#xA;});&#xA;&#xA;&#xA;&#xA;This code will result in an interesting edge case. Because we are using two different sessions (and thus two different transactions), it is possible for the index to pick up the emails/1 document and start indexing it, but not pick up the emails/1/text document (it hasn&#x2019;t been saved yet).&#xA;However, during the save of emails/1/text document, there wouldn&#x2019;t be anything in the references storage, so we won&#x2019;t know that we need to re-index emails/1. The result is that we violated our promise of re-indexing if the document changed. &#xA;As I said, just setting up the problem require parallel thinking and a severe case of headache. Luckily, we had a great bug report from Barry Hagan, which included an occasionally failing test. (Even just writing &#x201C;occasionally failing&#x201D; causes me to throw up a little bit).&#xA;After we identified the problem, we tried to solve it by holding up a list of modified documents in memory that were also required (and missing) during indexing using LoadDocument. Don&#x2019;t bother to follow up on this statement, it is complex, and it is hard, and we did it. And it worked, except that it didn&#x2019;t. That just moved the race condition from the entire process to the edges of the process. We have had two guys sitting on this for a couple of days and in danger of hair tearing, with no luck narrowing it down.&#xA;Eventually I sat down and tried to figure out how to deal with it. I was able to build on their work, and narrow down exactly where we had the race condition now. And just thinking about trying to solve it was way too hard. It would require multiple locks and pretty strange behavior overall. I wasn&#x2019;t happy with the implications, and that code already created quite a lot of complications as it was.&#xA;So I started by reverting all of that code and had a clean slate to work with. Then I sat down and thought about it, and finally figured out a better way to do it. The problem was only relevant when we had a missing reference (an existing reference would properly generate the re-indexing under all conditions). So I started with that, I gathered up all of the missing references, and stored them in a db task.&#xA0; A db task is a RavenDB notion of a transactionally safe way of registering things to run in another transaction. So after the indexing transaction was done, we would then go an execute that task.&#xA;The idea here is that doing it this way prevent us from having to deal with any issues with regards to &#x201C;what is the server crashes midway&#x201D;, etc. Anyway, it also means that this task is running in a separate transaction and after the indexing transaction is done. The only thing that this task is doing is just forcing re-indexing of all the documents that tried to call LoadDocument but got null as a result. Because we are now in a separate transaction, there are only two options:&#xA;&#xA;The related document is still not there, in which case were are merely doing some extra work.&#xA;The related document is there, and will be indexed.&#xA;The first case deserve some more attention, even if the document that was missing comes while we are re-indexing, we don&#x2019;t care, we already setup the references, and committed it, so it would force yet another re-indexing, and in the end, everyone will be happy.&#xA;And now, I have written this blog post while I was running a stress test on this feature, but it took me long enough that I am sure it works properly. So I&#x2019;ll call it a day and go do something more fun, maybe 3.0 work.</p>
        </article>
        <article id="article-4066">
            <a href="https://ayende.com/blog/163905/the-ravendb-experts-network" target="_blank">
                <h2 class="title mb-6" id="article-4066">The RavenDB Experts Network</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 03, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I am proud to announce another service that Hibernating Rhinos now offers. A network of experts that are now available for RavenDB work in many parts of the world.&#xA;&#xA;&#x9;This is in addition to our recent enterprise partnership agreement with Managed Designs, which gives us the ability to offer consulting, training and support services throughout most of Europe.&#xA;&#xA;&#x9;We now have experts available in:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;Dublin, Ireland&#xA;&#x9;&#xA;&#x9;&#x9;London, UK&#xA;&#x9;&#xA;&#x9;&#x9;Toru&#x144;, Poland&#xA;&#x9;&#xA;&#x9;&#x9;Dallas, Texas, USA&#xA;&#x9;&#xA;&#x9;&#x9;Austin, Texas, USA&#xA;&#x9;&#xA;&#x9;&#x9;Chicago, Illinois, USA&#xA;&#xA;&#xA;&#x9;Those experts are available for RavenDB consulting and support, so you can get a local experts backed by our own expertise on RavenDB. If you are interested in having one of those people show up, ping our support email.&#xA;&#xA;&#x9;In addition to that, I intend to be visiting the stats starting mid November, so if you are interested in having me show up for a day or two of consulting, or even a private RavenDB course, my schedule calls for visit for the following locations:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;New York, NY&#xA;&#x9;&#xA;&#x9;&#x9;Trenton, NJ&#xA;&#x9;&#xA;&#x9;&#x9;Pittsburgh, PA&#xA;&#x9;&#xA;&#x9;&#x9;Orlando, FA&#xA;&#x9;&#xA;&#x9;&#x9;Raleigh, NC&#xA;&#x9;&#xA;&#x9;&#x9;Dallas, TX&#xA;&#xA;&#xA;&#x9;Ping me if you are interested in a visit. In addition to that, any user groups in the area that might be interested, I would love to pop and and give a guest lecture.</p>
        </article>
        <article id="article-4067">
            <a href="https://ayende.com/blog/163361/evil-interview-questions-unique-random-c" target="_blank">
                <h2 class="title mb-6" id="article-4067">Evil interview questions: Unique &amp; Random C</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 02, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Writing in C (and using only the C std lib as building blocks, which explicitly exclude C&#x2B;&#x2B; and all its stuff), generate 1 million unique random numbers. For reference, here is the code in C#:      1: var random = new Random();   2: var set = new HashSet&lt;int&gt;();   3:&#xA0;    4: var sp = Stopwatch.StartNew();   5:&#xA0;    6: while (set.Count &lt; 1000 * 1000)   7: {   8:     set.Add(random.Next(0, int.MaxValue));   9: }  10:&#xA0;   11: Console.WriteLine(sp.ElapsedMilliseconds);&#xA;It is a brute force approach, I&#x2019;ll admit, but it completes in about 150ms on my end.&#xA0; Solution must run in under 10 seconds. &#xA;This question just looks stupid, it actually can tell you quite a bit about the developer.</p>
        </article>
        <article id="article-4068">
            <a href="https://ayende.com/blog/163073/file-i-o-flush-or-writethrough" target="_blank">
                <h2 class="title mb-6" id="article-4068">File I/O - Flush or WriteThrough?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 01, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Daniel Crabtree has asked a really interesting question:  I&#x27;ve been playing around with file I/O and I am trying to figure out when to use FileOptions.WriteThrough. In your experience, if durability is priority 1 and performance priority 2, is there any reason to use WriteThrough onfile streams in addition to or instead of FlushToDisk?  From my experiments, I found the following:  WriteThrough  Durable Calls to Write block Slower than FlushToDisk FlushToDisk  Durable Calls to Flush block Faster than WriteThrough Both WriteThrough &amp; FlushToDisk  Durable Calls to Write block Same performance as WriteThrough alone I&#x27;m asking you, as I notice you&#x27;ve used both approaches.You used WriteThrough:  http://ayende.com/blog/3448/some-observations-on-saving-to-file http://ayende.com/blog/3456/code-critique-transactional-file And in RavenDB https://github.com/ravendb/raven.munin/blob/master/Raven.Munin/FileBasedPersistentSource.cs You used Flush with flushToDisk in Rhino Events: https://github.com/ayende/Rhino.Events/blob/master/Rhino.Events/Storage/FileStreamSource.cs Well&#x2026; that caught up with me, is appears. Basically, I was a bit lazy with the terms I was using in those blog posts, so I think that I have better clarify. WriteThrough is the .NET name for FILE_FLAG_WRITE_THROUGH which tells the OS to skip any caching and goes directly to the disk. Writes will block until the data is sent to the disk. That is usually the wrong thing to do, actually, since this means that you can&#x2019;t get any benefit from OS buffers, batching, etc. In practice, what this means is that you are effectively calling fsync() after each and every write call. That is usually the wrong thing to do, since you would usually want to do multiple writes and then flush all those changes to disk, and you do want those changes to take advantage of the work the OS can do to optimize your system. Instead, you want to use Flush(). Note that even in Munin, both options are used, and WriteThrough can be removed. Although Munin by no means should be seen as a good impl of a storage engine. That said, you also have to be aware that Flush doesn&#x2019;t always does its work: http://connect.microsoft.com/VisualStudio/feedback/details/792434/flush-true-does-not-always-flush-when-it-should It looks like this is fixed in 4.5, but be aware if you need to run on 4.0 or previous versions.</p>
        </article>
        <article id="article-4069">
            <a href="https://ayende.com/blog/163842/ravendb-webinar-customer-stories-ucommerce-net" target="_blank">
                <h2 class="title mb-6" id="article-4069">RavenDB Webinar - Customer Stories - uCommerce.net</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 30, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Discover how RavenDB powers uCommerce, an e-commerce platform for .NET tightly integrated CMSs Umbraco and Sitecore. Helping customers find the product they&#x27;re looking for is one of the biggest challenges in e-commerce: Learn how uCommerce integrates RavenDB and its faceted search capabilities into the core platform to solve this challenge. Monday, October 14, 2013 Space is limited.Reserve your Webinar seat now at:https://www2.gotomeeting.com/register/591534170</p>
        </article>
        <article id="article-4070">
            <a href="https://ayende.com/blog/163137/sparse-files-memory-mapped-files" target="_blank">
                <h2 class="title mb-6" id="article-4070">Sparse files &amp; memory mapped files</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 30, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the problems with memory mapped files is that you can&#x2019;t actually map beyond the end of the file. So you can&#x2019;t use that to extend your file.&#xA0; I had a thought and set out to check, what will happen if I create a sparse file, a file that only take space when you write to it, and at the same time, map it?  As it turn out, this actually work pretty well in practice. You can do so without any issues. Here is how it works: using (var f = File.Create(path))&#xA;{&#xA;    int bytesReturned = 0;&#xA;    var nativeOverlapped = new NativeOverlapped();&#xA;    if (!NativeMethod.DeviceIoControl(f.SafeFileHandle, EIoControlCode.FsctlSetSparse, IntPtr.Zero, 0,&#xA;                                      IntPtr.Zero, 0, ref bytesReturned, ref nativeOverlapped))&#xA;    {&#xA;        throw new Win32Exception();&#xA;    }&#xA;    f.SetLength(1024*1024*1024*64L);&#xA;}&#xA;&#xA;&#xA;This create a sparse file that is 64Gb in size. Then we can map it normally:&#xA;using (var mmf = MemoryMappedFile.CreateFromFile(path))&#xA;using (var memoryMappedViewAccessor = mmf.CreateViewAccessor(0, 1024*1024*1024*64L))&#xA;{&#xA;    for (long i = 0; i &lt; memoryMappedViewAccessor.Capacity; i &#x2B;= buffer.Length)&#xA;    {&#xA;        memoryMappedViewAccessor.WriteArray(i, buffer, 0, buffer.Length);&#xA;    }&#xA;}&#xA;&#xA;&#xA;And then we can do stuff to it.&#xA0; And that include writing to yet unallocated parts of the file. This also means that you don&#x2019;t have to worry about writing past the end of the file, the OS will take care of all of that for you.&#xA;Happy happy, joy joy, etc.&#xA;One problem with this method, however. It means that you have a 64Gb file, but you don&#x2019;t have that much allocated. What that means in turn is that you might not have that much space available for the file. Which brings up an interesting question, what happens when you are trying to commit a new page, and the disk is out of space? Using file I/O you would get an IO error with the right code. But using memory mapped files, the error would actually turn up during access, which can happen pretty much anywhere. It also means that it is a Standard Exception Handling error in Windows, which require special treatment. &#xA;To test this out, I wrote the following so it would write to a disk that had only about 50 Gb free. I wanted to know what would happen when it run out of space. That is actually something that happens, and we need to be able to address this issue robustly. The kicker is that this might actually happen at any time, so that would really result is some&#x2026; interesting behavior with regards to robustness. In other words, I don&#x2019;t think that this is a viable option, it is a really cool trick, but I don&#x2019;t think it is a very well thought out option.&#xA;By the way, the result of my experiment was that we had an effectively a frozen process. No errors, nothing, just a hung. Also, I am pretty sure that WriteArray() is really slow, but I&#x2019;ll check this out at another pointer in time.</p>
        </article>
        <div class="button flex justify-between">
            <a href="406.html"><span class="back arrow"></span></a>

            <a href="408.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>