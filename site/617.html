
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 617 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-6161">
            <a href="https://ayende.com/blog/3780/nh-prof-alerts-excessive-number-of-rows-returned" target="_blank">
                <h2 class="title mb-6" id="article-6161">NH Prof Alerts</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 29, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is a bit from the docs for NH Prof, which I am sharing in order to get some peer review. The excessive number of rows returned is a warning that is being generated from the profiler when... a query is returning a large number of rows. The simplest scenario is that we simply loaded all the rows in a large table, using something like this code: session.CreateCriteria(typeof(Order))&#xA;&#x9;.List&lt;User&gt;();&#xA;This is a common mistake when you are binding to a UI component (such as a grid) that perform its own paging. This is a problem is several levels:&#xA;&#xA;We tend to want to see only part of the data&#xA;We just loaded a whole lot of unnecessary data&#xA;We are sending more data over the network&#xA;We have higher memory footprint than we should have&#xA;In extreme cases, we may crash as a result of out of memory exception&#xA;None of those are good things, and like the discussion on unbounded result sets, this can be easily prevented by applying a limit at the database level to the number of rows that we will load.&#xA;But it is not just simple queries without limit that can cause issue, another common source of this error is Cartesian product when using joins. Let us take a look at this query:&#xA;session.CreateCriteria(typeof(Order))&#xA;&#x9;.SetFetchMode(&quot;OrderLines&quot;, FetchMode.Join)&#xA;&#x9;.SetFetchMode(&quot;Snapshots&quot;, FetchMode.Join)&#xA;&#x9;.List&lt;Order&gt;();&#xA;Assuming that we have ten orders, with ten order lines each and five snapshots each, we are going to load 500 rows from the database. Mostly, they will contain duplicate data that we already have, and NHibernate will reduce the duplication to the appropriate object graph.&#xA;The problem is that we still loaded too much data, with the same issues as before. Now we also have the problem that Cartesian product doesn&#x27;t tend to stop at 500, but escalate very quickly to ridiculous number of rows returned for trivial amount of data that we actually want.&#xA;The solution for this issue is to change the way we query the data. Instead of issuing a single query with several joins, we can split this to several queries, and send them all to the database in a single batch using Multi Queries.</p>
        </article>
        <article id="article-6162">
            <a href="https://ayende.com/blog/3779/architecture-advice-scale-the-architecture-to-fit-the-application" target="_blank">
                <h2 class="title mb-6" id="article-6162">Architecture Advice: Scale the architecture to fit the application</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 29, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was just reviewing an application that was obviously built upon a lot of the best practices advice for using an NHibernate application. I am currently in the process of ripping apart much of that application and then putting it back together again. This involve things like collapsing projects, removing abstractions and deleting tests.&#xA0; The main reason for that is quite simple, the architecture is too big for the application. We can create a much more stream lined application is we don&#x27;t burden it with an architecture that is suitable for bigger and more complex applications. Selecting an inappropriate architecture is a big burden on an application, and it is one where you should be very careful. Chose an overly simplistic architecture, and you can only scale the application complexity with great difficulty. Chose an overly complex architecture, and you can&#x27;t even get the baseline working easily, because of the complexity involved. Don&#x27;t try to make an application fit the architecture, and don&#x27;t try to apply architecture blindly. Think and always start from the simplest thing that can possibly work.</p>
        </article>
        <article id="article-6163">
            <a href="https://ayende.com/blog/3778/my-baseline-asp-net-mvc-modifications" target="_blank">
                <h2 class="title mb-6" id="article-6163">My baseline ASP.Net MVC modifications</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 29, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We start by killing ViewData. I don&#x27;t want it, and I want to fail hard if someone is trying to use it:   Likewise in the views, I hate ViewData.Model, so I remove it from there as well:   For Javascript, I don&#x27;t want to use &lt;script/&gt; tags, they are prone to path problems, and I might need to go back and change them (using compression, combining scripts, etc). I use this approach:   The page title is set by the view, the way it should:   Or, I just set it up in the master page, if I don&#x27;t care that much about changing it.</p>
        </article>
        <article id="article-6164">
            <a href="https://ayende.com/blog/3777/do-not-put-presentation-concerns-in-the-controllers" target="_blank">
                <h2 class="title mb-6" id="article-6164">Do not put presentation concerns in the controllers!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 29, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I thought it would be obvious, but I am currently cleaning up an application that has mixed them in a very annoying way. I decided to track the reason for this coupling and I found this on the sample controller in ASP.Net MVC:   I am pretty sure that setting the page title is a presentation concern, as such, I don&#x27;t want to see this in the controller, and I certainly don&#x27;t want to see it in the base sample from which everyone is going to start.</p>
        </article>
        <article id="article-6165">
            <a href="https://ayende.com/blog/3776/nh-prof-alerts-unbounded-result-set" target="_blank">
                <h2 class="title mb-6" id="article-6165">NH Prof Alerts</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 29, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is a bit from the docs for NH Prof, which I am sharing in order to get some peer review. Unbounded result set is perform a query without explicitly limiting the number of returned result (using SetMaxResults() with NHibernate, or using TOP or LIMIT clauses in the SQL). Usually, this means that the application is assuming that a query will only return a few records. That works well in development and testing, but it is a time bomb in production.  The query suddenly starts returning thousands upon thousands of rows and in some cases, it is returning millions of rows. This leads to more load on the database server, the application server and the network. In many cases, it can grind the entire system to a halt, usually ending with the application servers crashing with out of memory errors.  Here is one example of a query that will trigger unbounded result set warning:  session.CreateQuery(&quot;from OrderLines lines where lines.Order.Id = :id&quot;)&#xA;       .SetParameter(&quot;id&quot;, orderId)&#xA;       .List();&#xA;&#xA;If the order have many line items, we are going to load all of them, which is probably not what we intended. A very easy fix for this issue is to add pagination: &#xA;session.CreateQuery(&quot;from OrderLines lines where lines.Order.Id = :id&quot;)&#xA;&#x9;.SetParameter(&quot;id&quot;, orderId)&#xA;&#x9;.SetFirstResult(0)&#xA;&#x9;.SetMaxResult(25)&#xA;&#x9;.List();&#xA;&#xA;Now we are assured that we need to only handle a predictable number, and if we need to work with all of them, we can page through the records as needed. But there is another common occurrence of unbounded result set, directly traversing the object graph, as in this example: &#xA;var order = session.Get&lt;Order&gt;(orderId);&#xA;DoSomethingWithOrderLines(order.OrderLines); &#xA;Here, again, we are loading the entire set (in fact, it is identical to the query we issued before) without regard to how big it is. NHibernate does provide robust handling of this scenario, using filters. &#xA;var order = session.Get&lt;Order&gt;(orderId);&#xA;var orderLines = session.CreateFilter(order.OrderLines, &quot;&quot;)&#xA;&#x9;.SetFirstResult(0)&#xA;&#x9;.SetMaxResults(25)&#xA;&#x9;.List();&#xA;DoSomethingWithOrderLines(orderLines);&#xA;This allow us to page through a collection very easily, and save us from having to deal with unbounded result sets and their consequences.</p>
        </article>
        <article id="article-6166">
            <a href="https://ayende.com/blog/3775/nh-prof-alerts-use-of-implicit-transactions-is-discouraged" target="_blank">
                <h2 class="title mb-6" id="article-6166">NH Prof Alerts</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 28, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is a bit from the docs for NH Prof, which I am sharing in order to get some peer review. A common mistake when using a database is that we should use only transactions to orchestrate several write statements. Every operation that the database is doing is done inside a transaction. This include both queries and writes ( update, insert, delete ). When we don&#x27;t define our own transactions, we fall back into implicit transaction mode, in which every statement to the database run in its own transaction, resulting in a higher performance cost (database time to build and tear down transactions) and reduced consistency. Even if we are only reading data, we want to use a transaction, because using a transaction ensure that we get a consistent result from the database. NHibernate assume that all access to the database is done under a transaction, and strongly discourage any use of the session without a transaction. Example of valid code: using(var session = sessionFactory.OpenSession()) &#xA;using(var tx = session.BeginTransaction()) &#xA;{ &#xA;&#x9;// execute code that uses the session &#xA;&#x9;tx.Commit(); &#xA;} &#xA;Leaving aside the safety issue of working with transactions, the assumption that transactions are costly and we need to optimize them is a false one. As already mentioned, databases are always running in transaction. And databases have been heavily optimized to work with transactions. The question is whatever this is per statement or per batch. There is some amount of work that need to be done to create and dispose a transaction, and having to do it per statement is actually more costly than doing it per batch.&#xA;It is possible to control the number and type of locks that a transaction takes by changing the transaction isolation level (and indeed, a common optimization is to reduce the isolation level).&#xA;NHibernate treat the call to Commit() as the time to flush all changed items from the unit of work to the database, without an explicit Commit(), it has no way of knowing when it should do that. A call to Flush() is possible, but it is generally strongly discouraged, because this is usually a sign that you are not using transactions properly.&#xA;I strongly suggest that you would use code similar to the one shown above (or use another approach to transactions, such as TransactionScope, or Castle&#x27;s Automatic Transaction Management) in order to handle transactions correctly.</p>
        </article>
        <article id="article-6167">
            <a href="https://ayende.com/blog/3774/nh-prof-alerts-select-n-1" target="_blank">
                <h2 class="title mb-6" id="article-6167">NH Prof Alerts</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 28, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is a bit from the docs for NH Prof, which I am sharing in order to get some peer review. Select N&#x2B;1 is a data access anti pattern, in which we are accessing the database in one of the least optimal ways. Let us take a look at a code sample, and then discuss what is going on. I want to show the user all the comments from all the posts, so they can delete all the nasty comments. The na&#x5DF;ve implementation would be something like:  // SELECT * FROM Posts&#xA;foreach (Post post in session.CreateQuery(&quot;from Post&quot;).List()) &#xA;{&#xA;     //lazy loading of comments list causes: SELECT * FROM Comments where PostId = @p0&#xA;    foreach (Comment comment in post.Comments) &#xA;    {&#xA;        //do something with comment&#xA;    }&#xA;}&#xA;&#xA;In this example, we can see that we are loading a list of posts ( the first select ) and then traversing the object graph. However, we access the lazily loaded collection, causing NHibernate to go to the database and bring the results one row at a time. This is incredibly inefficient, and the NHibernate Profiler will generate a warning whenever it encounters such a case. The solution for this example is simple, we simple force an eager load of the collection up front. &#xA;Using HQL:&#xA;var posts = session&#xA;&#x9;.CreateQuery(&quot;from Post p left join fetch p.Comments&quot;)&#xA;&#x9;.List();&#xA;Using the criteria API: &#xA;session.CreateCriteria(typeof(Post)) &#xA;&#x9;.SetFetchMode(&quot;Comments&quot;, FetchMode.Eager) &#xA;&#x9;.List();&#xA;&#xA;In both cases, we will get a join and only a single query to the database. Note, this is the classic appearance of the problem, it can also surface in other scenarios, such as calling the database in a loop, or more complex object graph traversals. In those cases, it it generally much harder to see what is causing the issue.&#xA;NHibernate Profiler will detect those scenarios as well, and give you the exact line in the source code that cause this SQL to be generated. Another option for solving this issue is: MutliQuery and MultiCriteria, which are also used to solve the issue of Too Many Queries.</p>
        </article>
        <article id="article-6168">
            <a href="https://ayende.com/blog/3773/nh-prof-deep-dive-implemented-the-unbounded-result-set-warning" target="_blank">
                <h2 class="title mb-6" id="article-6168">NH Prof Deep Dive</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 24, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">So, I talked a bit about the architecture and the actual feature, but let us see how I have actually build &amp; implemented this feature.  This is the actual code that goes into the actual product, I want to point out. And this is actually one of the more complex ones, because of the possible state changes. public class UnboundedResultSetStatementProcessor : IStatementProcessor&#xA;{&#xA;&#x9;public void BeforeAttachingToSession(SessionInformation sessionInformation, &#xA;&#x9;&#x9;FormattedStatement statement)&#xA;&#x9;{&#xA;&#x9;}&#xA;&#xA;&#x9;public void AfterAttachingToSession(SessionInformation sessionInformation, &#xA;&#x9;&#x9;FormattedStatement statement, OnNewAction newAction)&#xA;&#x9;{&#xA;&#x9;&#x9;if(statement.CountOfRows!=null)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;CheckStatementForUnboundedResultSet(statement, newAction);&#xA;&#x9;&#x9;&#x9;return;&#xA;&#x9;&#x9;}&#xA;&#x9;&#x9;bool addedAction = false;&#xA;&#x9;&#x9;statement.ValuesRefreshed &#x2B;= () =&gt;&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;if(addedAction)&#xA;&#x9;&#x9;&#x9;&#x9;return;&#xA;&#x9;&#x9;&#x9;addedAction = CheckStatementForUnboundedResultSet(statement, newAction);&#xA;&#x9;&#x9;};&#xA;&#x9;}&#xA;&#xA;&#x9;public bool CheckStatementForUnboundedResultSet(FormattedStatement statement,&#xA;&#x9;&#x9; OnNewAction newAction)&#xA;&#x9;{&#xA;&#x9;&#x9;if (statement.CountOfRows == null)&#xA;&#x9;&#x9;&#x9;return false;&#xA;&#xA;&#x9;&#x9;// we are discounting statements returning 1 or 0 results because&#xA;&#x9;&#x9;// those are likely to be queries on either PK or unique values&#xA;&#x9;&#x9;if (statement.CountOfRows &lt; 2)&#xA;&#x9;&#x9;&#x9;return false;&#xA;&#xA;&#x9;&#x9;// we don&#x27;t check for select statement here, because only selects have row count&#xA;&#x9;&#x9;var limitKeywords = new[] { &quot;top&quot;, &quot;limit&quot;, &quot;offset&quot; };&#xA;&#x9;&#x9;foreach (var limitKeyword in limitKeywords)&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;//why doesn&#x27;t the CLR have Contains() that takes StringComparison ??&#xA;&#x9;&#x9;&#x9;if (statement.RawSql.IndexOf(limitKeyword, StringComparison.InvariantCultureIgnoreCase) != -1)&#xA;&#x9;&#x9;&#x9;&#x9;return true;&#xA;&#x9;&#x9;}&#xA;&#xA;&#x9;&#x9;newAction(new ActionInformation&#xA;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;Severity = Severity.Suggestion,&#xA;&#x9;&#x9;&#x9;Title = &quot;Unbounded result set&quot;&#xA;&#x9;&#x9;});&#xA;&#x9;&#x9;return true;&#xA;&#x9;}&#xA;&#xA;&#x9;public void ProcessTransactionStatement(TransactionMessageBase tx)&#xA;&#x9;{&#xA;&#x9;}&#xA;}&#xA;And now the test:&#xA;[TestFixture]&#xA;public class Ticket_51_UnboundedResultSet : IntegrationTestBase&#xA;{&#xA;&#x9;[Test]&#xA;&#x9;public void Will_issue_alert_for_unbounded_result_sets()&#xA;&#x9;{&#xA;&#x9;&#x9;ExecuteScenarioInDifferentAppDomain&lt;LoadPostsUsingCriteriaQuery&gt;();&#xA;&#xA;&#x9;&#x9;var statement = observer.Model.RecentStatements.Statements&#xA;&#x9;&#x9;&#x9;.OfType&lt;StatementModel&gt;()&#xA;&#x9;&#x9;&#x9;.First();&#xA;&#x9;&#x9;Assert.AreEqual(1, statement.Actions.Count);&#xA;&#x9;&#x9;Assert.AreEqual(&quot;Unbounded result set&quot;, statement.Actions[0].Title);&#xA;&#x9;}&#xA;}&#xA;&#xA;And, just for fun, the scenario that we are testing:&#xA;public class LoadPostsUsingCriteriaQuery : IScenario&#xA;{&#xA;    public void Execute(ISessionFactory factory)&#xA;    {&#xA;        using (var session = factory.OpenSession())&#xA;        using (var tx = session.BeginTransaction())&#xA;        {&#xA;            session.CreateCriteria(typeof(Post))&#xA;                .List();&#xA;&#xA;            tx.Commit();&#xA;        }&#xA;    }&#xA;}&#xA;&#xA;And this is it. All you have to do to implement a new feature. This make building the application much easier, because at each point in time, we have to deal with only one thing. It is the aggregation of everything put together that is actually of value.&#xA;Also, notice that I heavily optimized my workflow for tests and scenarios. I can write just what I want to happen, not caring about how this is actually happening. Optimizing the ease of test is another architectural concern that I consider very important. If we don&#x27;t deal with that, the tests would be a PITA to write, so they would either wouldn&#x27;t get written, or we would get tests that are hard to read.&#xA;Also, notice that this is a full integration tests, we execute the entire backend, and we test the actual view model that the UI is going to display. I could have tested this using standard unit testing, but in this case, I chose to see how everything works from start to finish.</p>
        </article>
        <article id="article-6169">
            <a href="https://ayende.com/blog/3772/nh-prof-deep-dive-applying-the-open-close-principle-at-the-architecture-level" target="_blank">
                <h2 class="title mb-6" id="article-6169">NH Prof Deep Dive</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 24, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The back end in NH Prof is responsible for intercepting NHibernate&#x27;s events, making sense of all the mess, applying best practices suggestions and forwarding to the front end for display. Second, it is also a good example of how I apply the Open Close Principle at the architecture level. With NH Prof, there are multiple extension points that I can use to add new features. Here is a schematic of how things works:   Not shown here is the NHibernate Listener (of which, of course, I have several), which is publishing events to the bus. Those events are first handled by the low level message handlers, which publish new events on the bus. Those are interesting only in the sense that they translate the low level details into events with semantics that we can use in the app itself. Most of those events, as you probably guessed, end up in the Model Building part. This is responsible of taking a set of unstructured events into a coherent structure. Along with the model building, we have another extension point here, best practices analysis. Those are implemented as a set of classes that we plug into the model building part. If we want to add a new best practice, we need to create a new class, register it, and we are done. Here is the checkin for implementing the unbounded row set (which is ticket #51):   We add a new class (and a test for the class), register it in the BusFacility and in this case I actually had to fix a bug in the tested scenario, which loaded the wrong item. I&#x27;ll post more details about the actual implementation of Unbounded Result Set soon, but I wanted to talk about the architecture that enable this. Because we structured the whole thing around a common core that we can use, anything that fit the core (and most things does) doesn&#x27;t require any special effort. Apply a new behavior, done.</p>
        </article>
        <article id="article-6170">
            <a href="https://ayende.com/blog/3771/nh-prof-new-feature-unbounded-result-sets" target="_blank">
                <h2 class="title mb-6" id="article-6170">NH Prof new feature</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 24, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that I am doing with NH Prof is not only giving you visibility into what NHibernate is doing, but also trying to automate my own experience in analyzing best practices and problematic usages of NHibernate. NH Prof will detect usage patterns and warn against bad practices and suggest how to deal with them. The first one that I implemented was detecting Select N&#x2B;1, and the feedback from the beta group was &quot;Wow! I didn&#x27;t even know that we had this problem, but casual use with the profiler immediately showed it.&quot; Here is the newest feature, detecting &amp; warning about unbounded result sets:   And the actual warning:</p>
        </article>
        <div class="button flex justify-between">
            <a href="616.html"><span class="back arrow"></span></a>

            <a href="618.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>