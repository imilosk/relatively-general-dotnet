
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/164962/voron-the-freedb-dataset" target="_blank"><h1 class="title mb-6">Voron &amp; the FreeDB dataset</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: January 07, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got tired of doing arbitrary performance testing, so I decided to take the FreeDB dataset and start working with that. FreeDB is a data set used to look up CD information based on the a nearly unique disk id. This is a good dataset, because it contains a lot of data (over three million albums, and over 40 million songs), and it is production data. That means that it is dirty. This makes it perfect to run all sort of interesting scenarios. The purpose of this post (and maybe the new few) is to show off a few things. First, we want to see how Voron behaves with realistic data set. Second, we want to show off the way Voron works, its API, etc. To start with, I run my FreeDB parser, pointing it at /dev/null. The idea is to measure what is the cost of just going through the data is. We are using freedb-complete-20130901.tar.bz2 from Sep 2013. After 1 minute, we went through 342,224 albums, and after 6 minutes we were at 2,066,871 albums. Reading the whole 3,328,488 albums took about a bit over ten minutes. So just the cost of parsing and reading the FreeDB dataset&#xA0; is pretty expensive. The end result is a list of objects that looks like this:  Now, let us see how we want to actually use this. We want to be able to:  Lookup an album by the disk ids  Lookup all the albums by an artist*.  Lookup albums by album title*. This gets interesting, because we need to deal with questions such as: &#x201C;Given Pearl Jam, if I search for Pearl, do I get them? Do I get it for jam?&#x201D; For now, we are going to go with case insensitive, but we won&#x2019;t be doing full text search, we will allow, however, prefix searches.  We are using the following abstraction for the destination:      1: public abstract class Destination   2: {   3:     public abstract void Accept(Disk d);   4:     public abstract void Done();   5: }&#xA;Basically, we read data as fast as we can, and we shove it to the destination, until we are done. Here is the Voron implementation:&#xA;&#xA;&#xA;   1: public class VoronDestination : Destination   2: {   3:     private readonly StorageEnvironment _storageEnvironment;   4:     private WriteBatch _currentBatch;   5:     private readonly JsonSerializer _serializer = new JsonSerializer();   6:     private int counter = 1;   7:&#xA0;    8:     public VoronDestination()   9:     {  10:         _storageEnvironment = new StorageEnvironment(StorageEnvironmentOptions.ForPath(&quot;FreeDB&quot;));  11:         using (var tx = _storageEnvironment.NewTransaction(TransactionFlags.ReadWrite))  12:         {  13:             _storageEnvironment.CreateTree(tx, &quot;albums&quot;);  14:             _storageEnvironment.CreateTree(tx, &quot;ix_artists&quot;);  15:             _storageEnvironment.CreateTree(tx, &quot;ix_titles&quot;);  16:             tx.Commit();  17:         }  18:         _currentBatch = new WriteBatch();  19:     }  20:&#xA0;   21:     public override void Accept(Disk d)  22:     {  23:         var ms = new MemoryStream();  24:         _serializer.Serialize(new JsonTextWriter(new StreamWriter(ms)), d);  25:         ms.Position = 0;  26:         var key = new Slice(EndianBitConverter.Big.GetBytes(counter&#x2B;&#x2B;));  27:         _currentBatch.Add(key, ms, &quot;albums&quot;);  28:&#xA0;   29:         if(d.Artist != null)  30:             _currentBatch.MultiAdd(d.Artist.ToLower(), key, &quot;ix_artists&quot;);  31:         if (d.Title != null)  32:             _currentBatch.MultiAdd(d.Title.ToLower(), key, &quot;ix_titles&quot;);  33:&#xA0;   34:         if (counter%1000 == 0)  35:         {  36:             _storageEnvironment.Writer.Write(_currentBatch);  37:             _currentBatch = new WriteBatch();  38:         }  39:&#xA0;   40:     }  41:&#xA0;   42:     public override void Done()  43:     {  44:         _storageEnvironment.Writer.Write(_currentBatch);  45:     }  46: }&#xA;Let us go over this in detail, shall we?&#xA;In line 10 we create a new storage environment. In this case, we want to just import the data, so we can create the storage inline. On lines 13 &#x2013; 15, we create the relevant trees.&#xA;You can think about Voron trees in a very similar manner to the way you think about tables. They are a way to separate data into different parts of the storage. Note that this still all reside in a single file, so there isn&#x2019;t a physical separation. &#xA;Note that we created an albums tree, which will contain the actual data. And ix_artists, ix_titles trees. Those are indexes into the albums tree. You can see them being used just a little lower.&#xA;In the Accept method, you can see that we use a WriteBatch, a native Voron notion that allows us to batch multiple operations into a single transaction. In this case, for every album, we are making 3 writes.&#xA;First, we write all of the data, as a JSON string, into a stream and put it in the albums tree. Then we create a simple incrementing integer to be the actual album key. Finally, we add the artist and title entries (lower case, so we don&#x2019;t have to worry about case sensitivity in searches) into the relevant indexes.&#xA;At 60 seconds, we written 267,998 values to Voron. In fact, I explicitly designed it so we can see the relevant metrics. At 495 seconds we have reads 1,995,385 entries from the FreeDB file, we parsed&#xA0; 1,995,346 of them and written to Voron&#xA0; 1,610,998. As you can imagined, each step is running in a dedicated thread, so we can see how they behave on an individual basis. The good thing about this is that I can physically see the various costs, it is actually pretty cool&#xA;Here is the Voron directory at 60 seconds:&#xA;&#xA;You can see that we have two journal files active (haven&#x2019;t been applied to the data file yet) and the db.voron file is at 512 MB. The compression buffer is at 32 MB (this is usually twice as big as the biggest transaction, uncompressed).&#xA;The scratch buffer is used to hold in flight transaction information (until we send it to the data file), and you can see it is sitting on 256MB in size.&#xA;At 15 minutes, we have the following numbers: 3,035,452 entries read from the file,&#xA0; 3,035,426 parsed and 2,331,998 written to Voron. Note that we are reading the file &amp; writing to Voron on the same disk, so that might impact the read performance. &#xA;At that time, we can see the following on the disk:&#xA;&#xA;Note that we increase the size of most of our files by factor of 2, so some of the space in the db.voron file is probably not used. Note that we needed more scratch space to handle the in flight information. &#xA;The entire process took 22 minutes, start to finish. Although I have to note that this hasn&#x2019;t been optimized at all, and I know we are doing a lot of stupid stuff through it.&#xA;You might have noticed something else, we actually &#x201C;crashed&#x201D; closed the Voron db, this was done to see what would happen when we open a relatively large db after an unordered shutdown.&#xA;We&#x2019;ll actually get to play with the data in my next post. So far this has been pretty much just to see how things are behaving. And&#x2026; I just realized something, I forgot to actually add an index on disk id .&#xA;Which means that I have to import the data again. But before that, I also wrote the following:&#xA;&#xA;&#xA;   1: public class JsonFileDestination : Destination   2: {   3:     private readonly GZipStream _stream;   4:     private readonly StreamWriter _writer;   5:     private readonly JsonSerializer _serializer = new JsonSerializer();   6:&#xA0;    7:     public JsonFileDestination()   8:     {   9:         _stream = new GZipStream(new FileStream(&quot;freedb.json.gzip&quot;, FileMode.CreateNew, FileAccess.ReadWrite), CompressionLevel.Optimal);  10:         _writer = new StreamWriter(_stream);  11:     }  12:&#xA0;   13:     public override void Accept(Disk d)  14:     {  15:         _serializer.Serialize(new JsonTextWriter(_writer), d);  16:         _writer.WriteLine();  17:     }  18:&#xA0;   19:     public override void Done()  20:     {  21:         _writer.Flush();  22:         _stream.Dispose();  23:     }  24: }&#xA;This completed in ten minutes, for 3,328,488 entries. Or a rate of about 5,538 per / second. The result is a 845MB gzip file. &#xA;I had twofold reasons to want to do this. First, this gave me something to compare ourselves to, and more to the point, I can re-use this gzip file for my next tests, without having to go through the expensive parsing of the freedb file.&#xA;I did just that and ended up with the following:&#xA;&#xA;&#xA;   1: public class VoronEntriesDestination : EntryDestination   2: {   3:     private readonly StorageEnvironment _storageEnvironment;   4:     private WriteBatch _currentBatch;   5:     private int counter = 1;   6:&#xA0;    7:     public VoronEntriesDestination()   8:     {   9:         _storageEnvironment = new StorageEnvironment(StorageEnvironmentOptions.ForPath(&quot;FreeDB&quot;));  10:         using (var tx = _storageEnvironment.NewTransaction(TransactionFlags.ReadWrite))  11:         {  12:             _storageEnvironment.CreateTree(tx, &quot;albums&quot;);  13:             _storageEnvironment.CreateTree(tx, &quot;ix_diskids&quot;);  14:             _storageEnvironment.CreateTree(tx, &quot;ix_artists&quot;);  15:             _storageEnvironment.CreateTree(tx, &quot;ix_titles&quot;);  16:             tx.Commit();  17:         }  18:         _currentBatch = new WriteBatch();  19:     }  20:&#xA0;   21:     public override int Accept(string d)  22:     {  23:         var disk = JObject.Parse(d);  24:&#xA0;   25:         var ms = new MemoryStream();  26:         var writer = new StreamWriter(ms);  27:         writer.Write(d); writer.Flush();  28:         ms.Position = 0;  29:         var key = new Slice(EndianBitConverter.Big.GetBytes(counter&#x2B;&#x2B;));  30:         _currentBatch.Add(key, ms, &quot;albums&quot;);  31:         int count = 1;  32:&#xA0;   33:         foreach (var diskId in disk.Value&lt;JArray&gt;(&quot;DiskIds&quot;))  34:         {  35:             count&#x2B;&#x2B;;  36:             _currentBatch.MultiAdd(diskId.Value&lt;string&gt;(), key, &quot;ix_diskids&quot;);  37:         }  38:&#xA0;   39:         var artist = disk.Value&lt;string&gt;(&quot;Artist&quot;);  40:         if (artist != null)  41:         {  42:             count&#x2B;&#x2B;;   43:             _currentBatch.MultiAdd(artist.ToLower(), key, &quot;ix_artists&quot;);  44:         }  45:         var title = disk.Value&lt;string&gt;(&quot;Title&quot;);  46:         if (title != null)  47:         {  48:             count&#x2B;&#x2B;;   49:             _currentBatch.MultiAdd(title.ToLower(), key, &quot;ix_titles&quot;);  50:         }  51:&#xA0;   52:         if (counter % 100 == 0)  53:         {  54:             _storageEnvironment.Writer.Write(_currentBatch);  55:             _currentBatch = new WriteBatch();  56:         }  57:         return count;  58:     }  59:&#xA0;   60:     public override void Done()  61:     {  62:         _storageEnvironment.Writer.Write(_currentBatch);  63:         _storageEnvironment.Dispose();  64:     }  65: }&#xA;Now we are actually properly disposing of things, and I also decreased the size of the batch, to see how it would respond. Note that it is now being fed directly from the gzip file, at a greatly reduced cost.&#xA;I also added tracking note only for how many albums we write, but also how many entries. By entries I mean, how many Voron entries (which include the values we add to the index). &#xA;I did find a bug where we would just double the file size without due consideration to its size, so now we are doing smaller file size increases.&#xA;&#xA;Word of warning: I didn&#x2019;t realized until after I was done with all the benchmarks, but I actually run all of those in DEBUG configuration, which basically means that it is utterly useless as a performance metric. That is especially true because we have a lot of verifier code that runs in DEBUG mode. So please don&#x2019;t take those numbers as actual performance metrics, they aren&#x2019;t valid.&#xA;&#xA;&#xA;&#xA;Time&#xA;# of albums&#xA;# of entries&#xA;&#xA;4 minutes&#xA;773,398&#xA;3,091,146&#xA;&#xA;6 minutes&#xA;1,126,998&#xA;4,504,550&#xA;&#xA;8 minutes&#xA;1,532,858&#xA;6,126,413&#xA;&#xA;18 minutes&#xA;2,781,698&#xA;11,122,799&#xA;&#xA;24 minutes&#xA;3,328,488&#xA;13,301,496&#xA;The status of the file system midway during the run. You can see that now we increase the file is smaller increments. And that we are using more scratch space, probably because we are under very heavy write load.&#xA;&#xA;After the run:&#xA;&#xA;Scratch &amp; compression are only used when the database is running, and deleted on close. The database is 7GB in side, which is quite respectable. Now, to working with it, but I&#x2019;ll save that for my next post, this one is long enough already.</p>
        <a href="https://benfoster.io/blog/proxying-httpclient-requests-through-fiddler/" target="_blank"><h1 class="title mb-6">Proxying HttpClient requests through Fiddler</h1></a>
        <p class="mb-2">by Ben Foster</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: January 07, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">How to proxy requests made with .NET&#x2019;s HttpClient through Fiddler, the web debugging proxy tool.</p>
        <a href="https://ayende.com/blog/164993/performance-testing-with-voron-omg" target="_blank"><h1 class="title mb-6">Performance Testing with Voron OMG</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: January 06, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I am not going to have a lot of commentary here, I think that I can let the numbers speak for themselves. Here are the current performance test of Voron vs. Esent on my machine.  Note, the numbers are in millions of writes per second here! For Random Writes, the numbers are in thousands of writes per second:  Okay, I lied about no commentary. What you can see is that in our test, inserting 1.5 million items to storage. In sequential runs, we get such big variance because the test run itself is so short. (Nitpicker, yes, we&#x2019;ll post longer benchmarks). Note that this was running on a pretty good SSD drive, but what about HDD? Yes, that isn&#x2019;t a mistake, Esent is doing 901 writes per second.   As we have seen, we are pretty good at reading, but what are the current results?  As you can see, we are significantly better than Esent for reads in single and dual threaded modes, but Esent is faster when it can use more threads. That annoyed me, so I set out to figure out what was blocking us. As it turned out, searching the B-tree was quite expensive, but when I added a very small optimization (remember the last few searched pages), we saw something very interesting).  (The Esent results are different than the previous run because we run it on a different disk (still SSD)). What about random reads?   Now, one area where we currently suck is large writes, where we are doing really bad, but we&#x2019;re working on that. Overall, I am pretty happy about it all.</p>
        <a href="https://ardalis.com/when-should-you-refactor/" target="_blank"><h1 class="title mb-6">When Should You Refactor</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: January 03, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A common question teams face is, when should we take the time to refactor our code? Refactoring is defined as improving the design or&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/164961/growable-memory" target="_blank"><h1 class="title mb-6">Growable memory</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: January 03, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I wish that I could have more control over virtual memory. In particular, what I would really like at this time is the ability to map two virtual address ranges to the same physical memory. And yes, I am well aware (and already using) the ability to do just that using memory mapped files.&#xA0; However, what I would like to do is to have a pure memory based system, without any files being involved. This is meant to be used for the memory only system, which is commonly meant to be be used for unit testing. The reason that I want to be able to map the physical memory multiple times is that I have a buffer. Let us say that it is 1MB in size. And now I need to grow it. I can&#x2019;t ask the OS to just grow the buffer, since it might not have the virtual address available past the buffer end by the time I request it. What I would like to do is to request a new virtual allocation, let us say of 2 MB, and then ask the OS to map the same physical memory for the first buffer to the first section of the new buffer, and new memory for the rest.  The end result is that the first part of the buffer is mapped twice, and any changes you make there will be visible in both locations. Now, it is pretty easy to do this with memory mapped files, but I couldn&#x2019;t find a way to do it sans files. What I ended up doing is reserve a large portion of the virtual address space (using VirtualAlloc) and then committing it on demand. But I would really have liked to do something better, because now just moved the problem to when I run out of the reserved buffered space.</p>
        <a href="https://ayende.com/blog/164930/decisions-decisions" target="_blank"><h1 class="title mb-6">Decisions, decisions&#x2026;</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: January 02, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I don&#x2019;t think that this is going to be a hard one&#x2026;</p>
        <a href="https://ayende.com/blog/164897/versioned-collections" target="_blank"><h1 class="title mb-6">Versioned Collections</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: January 01, 2014
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Last time we talked about collections, I talked about Linked Dictionary and Safe List. The first did some fancy dancing to reduce the cost of allocations, and the second would re-create the list on change. Those implementations were good enough for us to go to hundreds of thousands of writes per second in the sequential scenario, but we noticed them cracking up under the pressure for the random writes scenario. So I started looking at more options. As it turns out, there is a very simple immutable and highly efficient design for a list. Just hold to the end of the list, and every append is just creating a new node that points to the old tail of the list. This makes adding to the list an O(1) operation. It is very fast, simple and easy to work with. This has just one issue, it allows efficient iteration only in reverse order. And there are a few places where we are actually relying on the ordering, so it would be nice not to lose that. Alex suggested using a internally mutable but externally immutable structure, such as this one. The benefit here is that we still get external immutability, but we get the performance of mutable access.  That works, as long as we use a list, which we needed for some pretty important things. However, the key collection, and the one that caused us most performance issues was the cost of getting values from the page table, which is a dictionary. We needed a really good solution there. I started to think that we would need to change all the code that uses this, but then I realized something very important. I don&#x2019;t actually need this. I don&#x2019;t need immutability, I just need snapshotting. And another aspect of that is that we have only a single writer thread for all of those items. So while we require that once we gave an instance to a reader, it can never change, that only applies to its externally observable behavior.  I would like to thank Tyler for the suggestion. Basically, we start off with a Concurrent Dictionary (and the only reason we need it is so we can write to the dictionary while we are reading from it, something that isn&#x2019;t safe to do with standard dictionary). The values in that dictionary is an immutable list of the values with the transaction id. Whenever we modify a value, we can drop all the values older than the oldest existing transaction. And when we search, we search for a value that is not greater than our own transaction id. That means that we effectively have a frozen snapshot of the page table, at a very little cost. I felt bad calling this as a generic collection name, so we actually named the class PageTable, since it has a very specific role in the code.  After this was done, we could not longer find any major cost associated with collections. So it is onward to the next challenge, reducing the cost of key comparisons&#x2026;</p>
        <a href="https://ayende.com/blog/165250/end-of-year-32-discount-coupon-has-2-sales-left" target="_blank"><h1 class="title mb-6">End of year 32% discount coupon has 2 sales left!</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 31, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Guys, we still have about 2 available purchases on our end of year sale. This is for a 32% discount for the following products: This applies to:  RavenDB NHibernate Profiler Entity Framework Profiler You can use coupon code: 0x20-twentysomething</p>
        <a href="https://ayende.com/blog/164872/machine-bias-in-profiler-based-optimizations" target="_blank"><h1 class="title mb-6">Machine bias in profiler based optimizations</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 30, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Take a look at the following profilers results. They both showcase pretty much the same codebase, without any major changes in between. However, they have been both run on different machines, and they result in very different performance optimization paths.  Main machine:   Laptop:   As you can see, when running the code on my main machine, the most expensive thing is actually writing to disk (WriteToJournal). However, on my laptop, writing to disk is actually very cheap.&#xA0; The likely reason is, again, my laptop is faking writing to disk in favor of buffering writes, even though we explicitly tell it not to. That means that it behaves as if it is we already optimized writing to disk. My main machine behaves more like a server, and we see a lot more I/O costs, which pretty much mask any other costs that we might have. Using the profiler to guide you with regards to how to optimize the system on any one of those machines would lead you in very different paths. With Voron, we are testing it in a variety of scenarios, to make sure that we aren&#x2019;t optimizing for one particular machine and hurting another.</p>
        <a href="https://ayende.com/blog/164871/reducing-the-cost-of-writing-to-disk" target="_blank"><h1 class="title mb-6">Reducing the cost of writing to disk</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 27, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">So, we found out that the major cost of random writes in our tests was actually writing to disk. Writing 500K sequential items resulted in about 300 MB being written. Writing 500K  random items resulted in over 2.3 GB being written.  Note: I would like to point out Alex&#x2019;s comment, which helped setup this post. So the obvious thing to do would be to use compression. I decided to try and see what that would give us, and the easiest thing to do is to just enable file compression at the NTFS level. But we can probably do better. The major cost we have is writes to the journal file. And we only ever read from the journal file when we recover the database. We are also usually writing multiple pages at a time for most transactions, and for the scenario we care about, writing 100 random values in a single transaction, we are usually write about a 100 pages or so anyway. That means that we have got a pretty big buffer that we can try to compress all at once. Sadly, we don&#x2019;t really see a meaningful improvement under that scenario. Using NTFS compression slow us down considerably, while both LZ4 and Snappy resulted in greatly reduce file writes, but roughly the same performance. &#xA0;   Note that I have done just the minimal amount of work required to test this out. I changed how we are writing to the journal, and disabled reading from it. That was pretty disappointing, to tell you the truth, I fully expected that we&#x2019;ll see some interesting improvements there. The LZ4 compression factor is about x10 for our data set. That means that 100 &#x2013; 121 pages usually are compressed to 10 &#x2013; 13 pages. The good thing about this is that running this through the profiler shows that we are running on a high I/O machine, where the amount and speed of I/O doesn&#x2019;t impact our performance much.  To test it out, I run the same test on an Amazon m3.2xlarge machine, and got the following results (writing to the C: drive):  So for now I think that I&#x2019;ll do the following. We&#x2019;ll focus on the other costs beyond I/O, and profile heavily on systems with higher I/O costs. Compression should work, in fact, my first thought was that we pay for less I/O with more CPU, but that is a guess without looking at the numbers. Here is the cost of committing using compression (lz4):  And here it is without compression:  So the good news is that we can visible see that we reduced the I/O cost from 8 seconds to 3.8 seconds. And even with compression cost of 2.6 seconds, we are still ahead. However, the cost of the collections used is actually a lot worse from our perspective. So we are back to reducing computation costs first, then looking at compression again at a later point in time.</p>
        <div class="button flex justify-between">
            <a href="380.html"><span class="back arrow"></span></a>

            <a href="382.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>