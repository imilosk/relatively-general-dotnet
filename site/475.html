
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 475 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4741">
            <a href="https://ayende.com/blog/155617/a-bad-test" target="_blank">
                <h2 class="title mb-6" id="article-4741">A bad test</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 18, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is a bad test, because what it does is ensuring that something does not works. I just finished implementing the session.Advaned.Defer support, and this test got my attention by failing the build. Bad test, you should be telling me when I broke something, not when I added new functionality.</p>
        </article>
        <article id="article-4742">
            <a href="https://ayende.com/blog/155585/when-using-the-task-parallel-library-wait-is-a-bad-warning-sign" target="_blank">
                <h2 class="title mb-6" id="article-4742">When using the Task Parallel Library, Wait() is a BAD warning sign</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 17, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Take a look at the following code: public static Task ParseAsync(IPartialDataAccess source, IPartialDataAccess seed, Stream output, IEnumerable&lt;RdcNeed&gt; needList)&#xA;{&#xA;    return Task.Factory.StartNew(() =&gt;&#xA;    {&#xA;        foreach (var item in needList)&#xA;        {&#xA;            switch (item.BlockType)&#xA;            {&#xA;                case RdcNeedType.Source:&#xA;                    source.CopyToAsync(output, Convert.ToInt64(item.FileOffset), Convert.ToInt64(item.BlockLength)).Wait();&#xA;                    break;&#xA;                case RdcNeedType.Seed:&#xA;                    seed.CopyToAsync(output, Convert.ToInt64(item.FileOffset), Convert.ToInt64(item.BlockLength)).Wait();&#xA;                    break;&#xA;                default:&#xA;                    throw new NotSupportedException();&#xA;            }&#xA;        }&#xA;    });&#xA;}&#xA;&#xA;&#xA;Do you see the problem in here?&#xA;It is a result of a code review comment about improper use of async in a project. This resulted in a lot of Task showing up in the return methods, but not in any measurable improvement in the actual codebase use of asynchronicity.&#xA;The problem is that when you need to work with such things in C# 4.0, you have to do some annoying things to get the code to work properly. In particular, this method was modified to be:&#xA;public static Task ParseAsync(IPartialDataAccess source, IPartialDataAccess seed, Stream output, IList&lt;RdcNeed&gt; needList, int position = 0)&#xA;{&#xA;  if(position&gt;= needList.Count)&#xA;  {&#xA;        return new CompletedTask();&#xA;  }&#xA;  var item = needList[position];&#xA;  Task task;&#xA;            &#xA;  switch (item.BlockType)&#xA;  {&#xA;        case RdcNeedType.Source:&#xA;            task = source.CopyToAsync(output, Convert.ToInt64(item.FileOffset), Convert.ToInt64(item.BlockLength));&#xA;            break;&#xA;        case RdcNeedType.Seed:&#xA;            task = seed.CopyToAsync(output, Convert.ToInt64(item.FileOffset), Convert.ToInt64(item.BlockLength));&#xA;            break;&#xA;        default:&#xA;            throw new NotSupportedException();&#xA;  }&#xA;&#xA;  return task.ContinueWith(resultTask =&gt;&#xA;    {&#xA;        if (resultTask.Status == TaskStatus.Faulted)&#xA;            resultTask.Wait(); // throws&#xA;        return ParseAsync(source, seed, output, needList, position &#x2B; 1);&#xA;    }).Unwrap();&#xA;}&#xA;&#xA;&#xA;This code is more complex, but it is actually making proper use of the TPL. We have changed the loop into a recursive function, so we can take advantage of ContinueWith to the next iteration of the loop.&#xA;And no, I can&#x2019;t wait to get to C# 5.0 and have proper await work.</p>
        </article>
        <article id="article-4743">
            <a href="https://ardalis.com/common-design-patterns-presentations/" target="_blank">
                <h2 class="title mb-6" id="article-4743">Common Design Patterns Presentations</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 16, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This month I presented on Common Design Patterns at two regional events. I&#x2019;ve given this talk a few times before, and it continues to evolve&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4744">
            <a href="https://ayende.com/blog/155553/reviewing-ravendb-app-releasecandidatetracker" target="_blank">
                <h2 class="title mb-6" id="article-4744">Reviewing RavenDB app: ReleaseCandidateTracker</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 16, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">ReleaseCandidateTracker is a new RavenDB based application by Szymon Pobiega. I reviewed version 5f7e42e0fb1dea70e53bace63f3e18d95d2a62dd. At this point, I don&#x2019;t know anything about this application, including what exactly it means, Release Tracking. I downloaded the code and started VS, there is one project in the solution, which is already a Good Thing. I decided to randomize my review approach and go and check the Models directory first.  Here is how it looks:  This is interesting for several reasons. First, it looks like it is meant to keep a record of all deployments to multiple environments, and that you can lookup the history of each deployment both on the environment side and on the release candidate side. Note that we use rich models, which have collections in them. In fact, take a look at this method:  Which calls to this method:  You know what the really fun part about this?  It ain&#x2019;t relational model. There is no cost of actually making all of these calls! Next, we move to the Infrastructure folder, where we have a couple of action results and the RavenDB management stuff. Here it how RCT uses RavenDB: public static class Database&#xA;{&#xA;    private static IDocumentStore storeInstance;&#xA;&#xA;    public static IDocumentStore Instance&#xA;    {&#xA;        get&#xA;        {&#xA;            if (storeInstance == null)&#xA;            {&#xA;                throw new InvalidOperationException(&quot;Document store has not been initialized.&quot;);&#xA;            }&#xA;            return storeInstance;&#xA;        }&#xA;    }&#xA;&#xA;    public static void Initialize()&#xA;    {&#xA;        var embeddableDocumentStore = new EmbeddableDocumentStore {DataDirectory = @&quot;~\App_Data\Database&quot;};&#xA;        embeddableDocumentStore.Initialize();&#xA;        storeInstance = embeddableDocumentStore;&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;It is using an embedded database to do that, which makes it very easy to use the app. Just hit F5 and go. In fact, if we do, we see the fully functional website, which is quite awesome .&#xA;Let us move to seeing how we are managing the sessions:&#xA;public class BaseController : Controller&#xA;{&#xA;    public IDocumentSession DocumentSession { get; private set; }&#xA;    public CandidateService CandidateService { get; private set; }&#xA;    public ScriptService ScriptService { get; private set; }&#xA;&#xA;    protected override void OnActionExecuting(ActionExecutingContext filterContext)&#xA;    {&#xA;        if (filterContext.IsChildAction)&#xA;        {&#xA;            return;&#xA;        }&#xA;        DocumentSession = Database.Instance.OpenSession();&#xA;        CandidateService = new CandidateService(DocumentSession);&#xA;        ScriptService = new ScriptService(DocumentSession);&#xA;        base.OnActionExecuting(filterContext);&#xA;    }&#xA;    &#xA;    protected override void OnActionExecuted(ActionExecutedContext filterContext)&#xA;    {&#xA;        if (filterContext.IsChildAction)&#xA;        {&#xA;            return;&#xA;        }&#xA;        if(DocumentSession != null)&#xA;        {&#xA;            if (filterContext.Exception == null)&#xA;            {&#xA;                DocumentSession.SaveChanges();&#xA;            }&#xA;            DocumentSession.Dispose();&#xA;        }&#xA;        base.OnActionExecuted(filterContext);&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;This is all handled inside the base controller, and it is very similar to how I am doing that in my own apps.&#xA;However, ScriptService and CandidateService seems strange, let us explore them a bit.&#xA;public class ScriptService&#xA;{&#xA;    private readonly IDocumentSession documentSession;&#xA;&#xA;    public ScriptService(IDocumentSession documentSession)&#xA;    {&#xA;        this.documentSession = documentSession;&#xA;    }&#xA;&#xA;    public void AttachScript(string versionNumber, Stream fileContents)&#xA;    {&#xA;        var metadata = new RavenJObject();&#xA;        documentSession.Advanced.DatabaseCommands.PutAttachment(versionNumber, null, fileContents, metadata);&#xA;    }&#xA;&#xA;    public Stream GetScript(string versionNumber)&#xA;    {&#xA;        var attachment = documentSession.Advanced.DatabaseCommands.GetAttachment(versionNumber);&#xA;        return attachment != null &#xA;            ? attachment.Data() &#xA;            : null;&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;So this is using RavenDB attachment to store stuff, I am not quite sure what yet, so let us track it down.&#xA;This is being used like this:&#xA;[HttpGet]&#xA;public ActionResult GetScript(string versionNumber)&#xA;{&#xA;    var candidate = CandidateService.FindOneByVersionNumber(versionNumber);&#xA;    var attachment = ScriptService.GetScript(versionNumber);&#xA;    if (attachment != null)&#xA;    {&#xA;        var result = new FileStreamResult(attachment, &quot;text/plain&quot;);&#xA;        var version = candidate.VersionNumber;&#xA;        var product = candidate.ProductName;&#xA;        result.FileDownloadName = string.Format(&quot;deploy-{0}-{1}.ps1&quot;, product, version);&#xA;        return result;&#xA;    }&#xA;    return new HttpNotFoundResult(&quot;Deployment script missing.&quot;);&#xA;}&#xA;&#xA;&#xA;&#xA;So I am assuming that the scripts are deployment scripts for different versions, and that they get uploaded on every new release candidate.&#xA;But look at the CandidateService, it looks like a traditional service wrapping RavenDB, and I have spoken against it multiple times.&#xA;In particular, I dislike this bit of code:&#xA;public ReleaseCandidate FindOneByVersionNumber(string versionNumber)&#xA;{&#xA;    var result = documentSession.Query&lt;ReleaseCandidate&gt;()&#xA;        .Where(x =&gt; x.VersionNumber == versionNumber)&#xA;        .FirstOrDefault();&#xA;    if(result == null)&#xA;    {&#xA;        throw new ReleaseCandidateNotFoundException(versionNumber);&#xA;    }&#xA;    return result;&#xA;}&#xA;&#xA;public void Store(ReleaseCandidate candidate)&#xA;{&#xA;    var existing = documentSession.Query&lt;ReleaseCandidate&gt;()&#xA;        .Where(x =&gt; x.VersionNumber == candidate.VersionNumber)&#xA;        .Any();&#xA;    if (existing)&#xA;    {&#xA;        throw new ReleaseCandidateAlreadyExistsException(candidate.VersionNumber);&#xA;    }&#xA;    documentSession.Store(candidate);&#xA;}&#xA;&#xA;&#xA;From looking at the code, it looks like the version number of the release candidate is the primary way to look it up. More than that, in the entire codebase, there is never a case where we load a document by id.&#xA;When I see a VersionNumber, I think about things like &#x201C;1.0.812.0&#x201D;, but I think that in this case the version number is likely to include the product name as well, &#x201C;RavenDB-1.0.812.0&#x201D;, otherwise you couldn&#x2019;t have two products with the same version.&#xA;That said, the code above it wrong, because it doesn&#x2019;t take into account RavenDB&#x2019;s indexes BASE nature. Instead, the version number should actually be the ReleaseCandidate id. This way, because RavenDB&#x2019;s document store is fully ACID, we don&#x2019;t have to worry about index update times, and we can load things very efficiently.&#xA;Pretty much all of the rest of the code in the CandidateService is only used in a single location, and I don&#x2019;t really see a value in it being there.&#xA;For example, let us look at this one:&#xA;[HttpPost]&#xA;public ActionResult MarkAsDeployed(string versionNumber, string environment, bool success)&#xA;{&#xA;    CandidateService.MarkAsDeployed(versionNumber, environment, success);&#xA;    return new EmptyResult();&#xA;}&#xA;&#xA;&#xA;&#xA;As you can see, it is merely loading the appropriate release candidate, and calling the MarkAsDeployed method on it.&#xA;Instead of doing this needless, forwarding, and assuming that we have the VersionNumber as the id, I would write:&#xA;[HttpPost]&#xA;public ActionResult MarkAsDeployed(string versionNumber, string environment, bool success)&#xA;{&#xA;    var cadnidate = DocumentSession.Load&lt;ReleaseCandidate&gt;(versionNumber);&#xA;    if (cadnidate == null)&#xA;        throw new ReleaseCandidateNotFoundException(versionNumber);&#xA;    var env = DocumentSession.Load&lt;DeploymentEnvironment&gt;(environment);&#xA;    if (env == null)&#xA;        throw new InvalidOperationException(string.Format(&quot;Environment {0} not found&quot;, environment));&#xA;&#xA;    cadnidate.MarkAsDeployed(success, env);&#xA;    return new EmptyResult();&#xA;}&#xA;&#xA;&#xA;&#xA;Finally, a word about the error handling, this is handled via:&#xA;protected override void OnException(ExceptionContext filterContext)&#xA;{&#xA;    filterContext.Result = new ErrorResult(filterContext.Exception.Message);&#xA;    filterContext.ExceptionHandled = true;&#xA;}&#xA;&#xA;public class ErrorResult : ActionResult&#xA;{&#xA;    private readonly string message;&#xA;&#xA;    public ErrorResult(string message)&#xA;    {&#xA;        this.message = message;&#xA;    }&#xA;&#xA;    public override void ExecuteResult(ControllerContext context)&#xA;    {&#xA;        context.HttpContext.Response.Write(message);&#xA;        context.HttpContext.Response.StatusCode = 500;&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;The crazy part is that OnException is overridden only on some of the controllers, rather than in the base controller, and even worse. This sort of code leads to error details loss.&#xA;For example, let us say that I get a NullReferenceException. This code will dutifully tell me all about it, but will not tell me where it happened.&#xA;This sort of thing make debugging extremely hard.</p>
        </article>
        <article id="article-4745">
            <a href="https://ayende.com/blog/155521/non-overlapping-time-periods-because-i-like-the-pain-of-2-am-wakeup-calls" target="_blank">
                <h2 class="title mb-6" id="article-4745">Non overlapping time periods&#x2013;because I like the pain of 2 AM wakeup calls</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 15, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This post is partly in response for this post, discussing the Azure problem with leap year. But it is actually a bit more general than that.&#xA;&#xA;&#x9;In my code, here is how I define &#x201C;one year from now&#x201D;:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;DateTime.Today.AddYears(1).AddDays(3);&#xA;&#xA;&#xA;&#x9;As it turned out, this tend to have a lot of implications on your business, most of them are actually pretty good ones.&#xA;&#xA;&#x9;For a start, you will never get hit with a leap year bug, but more importantly, you are never going to have to deal with an immediate cutoff. This is important because it gives you time. Mostly, it gives you time to screw up, but having the time to do so without having an egg all of your face is a really nice thing.&#xA;&#xA;&#x9;For example, all of our subscriptions are using a similar method of calculation, and this is why we can take the ordering system down for a few hours or even a day or two and no one will actually notice. We have a big grace period in which we can work things out.&#xA;&#xA;&#x9;Sure, a user gets 3 &#x201C;extra&#x201D; days for free out of this, but frankly, I don&#x2019;t give a damn. It is more important that I get the buffer, and most users like it much better when you don&#x2019;t slam the doors in their faces on the first chance.&#xA;&#xA;&#x9;One of the things that is important is style, and giving a grace period for those sort of things is crucial.</p>
        </article>
        <article id="article-4746">
            <a href="https://ayende.com/blog/155489/rotten-scheduling-dont-roll-your-own" target="_blank">
                <h2 class="title mb-6" id="article-4746">Rotten Scheduling: Don&#x2019;t roll your own</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 14, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">&#x201C;We need to run a specific task every 72 hours, I thought about this approach&#x2026;&#x201D; public class TimedTask&#xA;{&#xA;  public static Timer Timer;&#xA;  &#xA;  public static void Init()&#xA;  {&#xA;    Timer = new Timer(ExecuteEvery72Hours, null, TimeSpan.FromHours(72), TimeSpan.FromHours(72));&#xA;  }&#xA;  &#xA;  public static void ExecuteEvery72Hours()&#xA;  {&#xA;    // do something important&#xA;  }&#xA;}&#xA;&#xA;&#xA;This is a bloody rotten idea, let us see why&#x2026;&#xA;&#xA;What happens if your application is recycled every 29 hours?&#xA;What happens if your application is always on, but during that 72 hour call, it was offline?&#xA;What happens if your task actually takes more than 72 hours to run?&#xA;What happens if the task fails? &#xA;How do you report errors, warnings, etc?&#xA;Scheduling is a hard problem. There are a lot of things that you actually need to consider. And the code above is really considering none of them. I would be very surprised if something like that ever run. in production. It most certainly can&#x2019;t be made to run reliably.&#xA; Things that run every X time, where X is a long time (hours / days) tend to be pretty important. In some of the systems that we wrote, that include doing things like updating VAT and interest rates, pulling from external source, generating the weekly report, etc.&#xA;You do not want this to be messed up.&#xA;If you need to do anything like that, make use of the builtin scheduling features of the OS you are running on (Windows Task Scheduler is an amazingly full featured, and cron isn&#x2019;t bad if you are running on Linux). If you still insist on doing this in code, at the very least do something like this:&#xA;public class TimedTask&#xA;{&#xA;  public static Timer Timer;&#xA;  &#xA;  public static void Init()&#xA;  {&#xA;    Timer = new Timer(()=&gt;&#xA;    {&#xA;      if( (DateTime.UtcNow - GetLastExecutedTime()) &gt; 72)&#xA;        ExecuteEvery72Hours();&#xA;    }, null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(1));&#xA;  }&#xA;  &#xA;  public static void ExecuteEvery72Hours()&#xA;  {&#xA;    // do something important&#xA;  }&#xA;}&#xA;&#xA;&#xA;This still has a lot of problems, but at least it it solving some crucial problems for you (note that GetLastExecutedTime has to be a persisted value).&#xA;Of course, if you need something like this in your code, you have better use something like Quartz, instead. Don&#x2019;t roll your own. Sure, this is ten lines of code to do so, but as I said, this is the very basics, and it gets complex really fast.</p>
        </article>
        <article id="article-4747">
            <a href="https://ayende.com/blog/155457/rotten-scheduling" target="_blank">
                <h2 class="title mb-6" id="article-4747">Rotten Scheduling</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 11, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">&#x201C;We need to run a specific task every 72 hours, I thought about this approach&#x2026;&#x201D; public class TimedTask&#xA;{&#xA;  public static Timer Timer;&#xA;  &#xA;  public static void Init()&#xA;  {&#xA;    Timer = new Timer(ExecuteEvery72Hours, null, TimeSpan.FromHours(72), TimeSpan.FromHours(72));&#xA;  }&#xA;  &#xA;  public static void ExecuteEvery72Hours()&#xA;  {&#xA;    // do something important&#xA;  }&#xA;}&#xA;&#xA;&#xA;Let us assume that this code is being called properly. Why is this a bloody rotten idea?</p>
        </article>
        <article id="article-4748">
            <a href="https://ayende.com/blog/155073/reviewing-xenta-and-wishing-i-hadnt" target="_blank">
                <h2 class="title mb-6" id="article-4748">Reviewing Xenta and wishing I hadn&#x2019;t</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 10, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Xenta Framework is the extensible enterprise n-tier application framework with multilayered architecture. I was asked by the coordinator for the project to review it. This isn&#x2019;t going to take long. I looked at the code, and I got this:  I am sure you remember the last time when I run into something like this, except that the number of projects at that solution was a quarter of what we had here, and I already had to hold my nose. Looking a bit deeper:  Here is a hint, you are allowed to have more than one class per project.  Having that many project is a nightmare in trying to manage them. Finding things, actually making use of how things work. Not to mention that the level of abstractness required to support that is giving me a headache. This is still without looking at the code, mind. Now, let us look at the actual code. I like to start the controllers. The following code is from ForumController: [HttpPost, ValidateInput(false)]&#xA;public ActionResult Update(int forumID, FormCollection form)&#xA;{&#xA;    ForumModel m = new ForumModel()&#xA;    {&#xA;        ForumID = forumID&#xA;    };&#xA;&#xA;    if(!m.Load())&#xA;    {&#xA;        return HttpNotFound();&#xA;    }&#xA;&#xA;    if(TryUpdateModel&lt;ForumModel&gt;(m, &quot;Model&quot;, form))&#xA;    {&#xA;        try&#xA;        {&#xA;            m.Update();&#xA;        }&#xA;        catch(Exception ex)&#xA;        {&#xA;            ModelState.AddModelError(&quot;API&quot;, ex);&#xA;        }&#xA;    }&#xA;&#xA;    if(!ModelState.IsValid)&#xA;    {&#xA;        TempData.OperationStatus(&quot;Failed&quot;);&#xA;        TempData.PersistObject(&quot;Model&quot;, m);&#xA;        TempData.PersistModelState(ModelState);&#xA;    }&#xA;    else&#xA;    {&#xA;        TempData.OperationStatus(&quot;Success&quot;);&#xA;    }&#xA;&#xA;    return RedirectToAction(&quot;Edit&quot;, new&#xA;    {&#xA;        ForumID = m.ForumID&#xA;    });&#xA;}&#xA;&#xA;&#xA;Seriously, I haven&#x2019;t seen this style of architecture in a while. Let us dig deeper:&#xA;public bool Update()&#xA;{&#xA;    using(ForumApiClient api = new ForumApiClient())&#xA;    {&#xA;        var dto = api.UpdateForum(ForumID, ParentForumID, DisplayOrder, Flags);&#xA;&#xA;        return Load(dto);&#xA;    }&#xA;}&#xA;&#xA;public bool Load()&#xA;{&#xA;    using(ForumApiClient api = new ForumApiClient())&#xA;    {&#xA;        var dto = api.GetForum(ForumID);&#xA;&#xA;        return Load(dto);&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;In case you are wondering, those are on the ForumModel class.&#xA;This piece of code is from the ForumPostModel class, it may look familiar:&#xA;public bool Load()&#xA;{&#xA;    using(ForumApiClient api = new ForumApiClient())&#xA;    {&#xA;        var dto = api.GetPost(PostID);&#xA;&#xA;        return Load(dto);&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;This ForumApiClient is actually a WCF Proxy class, which leads us to this interface:&#xA;&#xA;I won&#x2019;t comment on this any further, but will go directly to ForumApiService, where we actually update a forum using the following code:&#xA;public ForumDto UpdateForum(int forumID,&#xA;    int parentForumID,&#xA;    int displayOrder,&#xA;    ForumFlags flags)&#xA;{&#xA;    ForumService forumService = Infrastructure.Component&lt;ForumService&gt;();&#xA;&#xA;    if(forumService == null)&#xA;    {&#xA;        throw new FaultException(new FaultReason(&quot;forum service&quot;), new FaultCode(ErrorCode.Infrastructure.ToString()));&#xA;    }&#xA;&#xA;    try&#xA;    {&#xA;        ForumEntity entity = forumService.UpdateForum(forumID, parentForumID, displayOrder, flags, DateTime.UtcNow);&#xA;&#xA;        return Map(entity);&#xA;    }&#xA;    catch(XentaException ex)&#xA;    {&#xA;         throw new FaultException(new FaultReason(ex.Message), new FaultCode(ex.Code.ToString()));&#xA;    }&#xA;}&#xA;&#xA;&#xA;Infrastructure.Component represent a home grown service locator. Note that we have manual exception handling for absolutely no reason whatsoever (you can do this in a behavior once, and since this is repeated for each and every one of the methods&#x2026;).&#xA;I apologize in advance, but here is the full UpdateForum method:&#xA;public ForumEntity UpdateForum(int forumID,&#xA;    int parentForumID,&#xA;    int displayOrder,&#xA;    ForumFlags flags, &#xA;    DateTime updatedOn)&#xA;{&#xA;    ForumEntity oldForum = GetForum(forumID);&#xA;            &#xA;    if(oldForum == null)&#xA;    {&#xA;        throw new XentaException(ErrorCode.NotFound, &quot;forum&quot;);&#xA;    }&#xA;&#xA;    ForumEntity parentForum = null;&#xA;&#xA;    if(parentForumID != 0)&#xA;    {&#xA;        parentForum = GetForum(parentForumID);&#xA;&#xA;        if(parentForum == null)&#xA;        {&#xA;            throw new XentaException(ErrorCode.NotFound, &quot;forum&quot;);&#xA;        }&#xA;&#xA;        ForumEntity tmp = parentForum;&#xA;&#xA;    HierarchyCheck:&#xA;&#xA;        if(tmp.ForumID == forumID)&#xA;        {&#xA;            throw new XentaException(ErrorCode.InvalidArgument, &quot;parentForumID&quot;);&#xA;        }&#xA;        if(tmp.ParentForumID != 0)&#xA;        {&#xA;            tmp = tmp.Parent;&#xA;&#xA;            goto HierarchyCheck;&#xA;        }&#xA;    }&#xA;&#xA;    ForumEntity newForum = null;&#xA;    bool res = Provider.UpdateForum(forumID,&#xA;        parentForumID,&#xA;        oldForum.LastTopicID,&#xA;        oldForum.TopicCount,&#xA;        oldForum.PostCount,&#xA;        displayOrder,&#xA;        flags,&#xA;        oldForum.CreatedOn,&#xA;        updatedOn);&#xA;&#xA;    if(res)&#xA;    {&#xA;        if(Cache != null)&#xA;        {&#xA;            Cache.Remove(&quot;ForumService_GetForum_{0}&quot;, oldForum.ForumID);&#xA;        }&#xA;&#xA;        newForum = GetForum(forumID);&#xA;&#xA;        if(EventBroker != null)&#xA;        {&#xA;            EventBroker.Publish&lt;PostEntityUpdate&lt;ForumEntity&gt;&gt;(this, new PostEntityUpdate&lt;ForumEntity&gt;(newForum, oldForum));&#xA;        }&#xA;    }&#xA;    return newForum;&#xA;}&#xA;&#xA;&#xA;Yes, it is a goto there, for the life of me I can&#x2019;t figure out why.&#xA;Note that there is also this Provider in here, which is an IForumProvider, which is implemented by&#x2026; ForumProvider, which looks like this:&#xA;public bool UpdateForum(int forumID,&#xA;    int parentForumID,&#xA;    int lastTopicID,&#xA;    int topicCount,&#xA;    int postCount,&#xA;    int displayOrder,&#xA;    ForumFlags flags,&#xA;    DateTime createdOn,&#xA;    DateTime updatedOn)&#xA;{&#xA;    bool res = false;&#xA;&#xA;    using(DbCommand cmd = DataSource.GetStoredProcCommand(&quot;fwk_Forums_Update&quot;))&#xA;    {&#xA;        SqlServerHelper.SetInt32(DataSource, cmd, &quot;ForumID&quot;, forumID);&#xA;        SqlServerHelper.SetInt32(DataSource, cmd, &quot;ParentForumID&quot;, parentForumID);&#xA;        SqlServerHelper.SetInt32(DataSource, cmd, &quot;LastTopicID&quot;, lastTopicID);&#xA;        SqlServerHelper.SetInt32(DataSource, cmd, &quot;TopicCount&quot;, topicCount);&#xA;        SqlServerHelper.SetInt32(DataSource, cmd, &quot;PostCount&quot;, postCount);&#xA;        SqlServerHelper.SetInt32(DataSource, cmd, &quot;DisplayOrder&quot;, displayOrder);&#xA;        SqlServerHelper.SetInt32(DataSource, cmd, &quot;Flags&quot;, (int)flags);&#xA;        SqlServerHelper.SetDateTime(DataSource, cmd, &quot;CreatedOn&quot;, createdOn);&#xA;        SqlServerHelper.SetDateTime(DataSource, cmd, &quot;UpdatedOn&quot;, updatedOn);&#xA;&#xA;        res = DataSource.ExecuteNonQuery(cmd) &gt; 0;&#xA;    }&#xA;    return res;&#xA;}&#xA;&#xA;&#xA;And&#x2026; this is about it guys.&#xA;I checked the source control, and the source control history for this goes back only to the beginning of February 2012. I assume that this is older than this, because the codebase is pretty large.&#xA;But to summarize, what we actually have is a highly abstracted project, a lot of abstraction. A lot of really bad code even if you ignore the abstractions, seemingly modern codebase that still uses direct ADO.Net for pretty much everything, putting a WCF service in the middle of the application just for the fun of it.&#xA;Tons of code dedicated to error handling, caching, etc. All of which can be handled as cross cutting concerns.&#xA;This is the kind of application that I would expect to see circa 2002, not a decade later.&#xA;And please note, I actually got the review request exactly 34 minutes ago. I didn&#x2019;t review the entire application (nor do I intend to). I merely took a reprehensive* vertical slide of the app and followed up on that.&#xA;*Yes, this is intentional.</p>
        </article>
        <article id="article-4749">
            <a href="https://ayende.com/blog/154817/the-best-multi-threading-debugging-tool-is-microsoft-excel" target="_blank">
                <h2 class="title mb-6" id="article-4749">The best multi threading debugging tool is Microsoft Excel</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 09, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In any system that gets to a certain size, especially one that is multi threaded, there are a certain class of bugs that are really a bitch to figure out.  They are usually boil down to some sort of a race condition. I have been doing that recently, trying to fix a bunch of race conditions in RavenDB. The problem with race conditions is that they are incredibly hard to reproduce, and even when you can reproduce them, you can&#x2019;t really debug them.  I came up with the following test harness to try to narrow things down. Basically, create a test case that sometimes fails, and run it a thousand times. Odds are that you&#x2019;ll get the failure, but that isn&#x2019;t the important bit. The important bit is that you setup logging properly. In my case, I set things up so the logging output to CSV and each test run had a different file. This gives me output that looks like this:  23:54:34.5952,Raven.Database.Server.HttpServer,Debug,Request #&#xA0; 10: GET&#xA0;&#xA0;&#xA0;&#xA0; -&#xA0;&#xA0;&#xA0; 12 ms - &lt;default&gt;&#xA0; - 200 - /indexes/dynamic/Companies?query=&amp;start=0&amp;pageSize=1&amp;aggregation=None,,1123:54:34.5952,Raven.Client.Document.SessionOperations.QueryOperation,Debug,&quot;Stale query results on non stale query &#x27;&#x27; on index &#x27;dynamic/Companies&#x27; in &#x27;http://reduction:8079/&#x27;, query will be retried, index etag is: bcf0fed1-d975-43b4-bfb7-65221ef06b99&quot;,,123:54:34.5952,Raven.Database.Indexing.WorkContext,Debug,&quot;No work was found, workerWorkCounter: 10, for: TasksExecuter, will wait for additional work&quot;,,623:54:34.5952,Raven.Database.Indexing.WorkContext,Debug,Incremented work counter to 11 because: WORK BY IndexingExecuter,,1223:54:34.5952,Raven.Database.Indexing.WorkContext,Debug,&quot;No work was found, workerWorkCounter: 11, for: TasksExecuter, will wait for additional work&quot;,,623:54:34.5952,Raven.Database.Indexing.WorkContext,Debug,&quot;No work was found, workerWorkCounter: 11, for: ReducingExecuter, will wait for additional work&quot;,,2123:54:34.5952,Raven.Database.Indexing.WorkContext,Debug,&quot;No work was found, workerWorkCounter: 11, for: IndexingExecuter, will wait for additional work&quot;,,1223:54:34.6952,Raven.Client.Document.SessionOperations.QueryOperation,Debug,Executing query &#x27;&#x27; on index &#x27;dynamic/Companies&#x27; in &#x27;http://reduction:8079/&#x27;,,123:54:34.8172,Raven.Database.Indexing.Index.Querying,Debug,Issuing query on index Temp/Companies for all documents,,1123:54:34.8172,Raven.Storage.Esent.StorageActions.DocumentStorageActions,Debug,Document with key &#x27;companies/1&#x27; was found,,11 Not really helpful in figure out what is going on, right? Except for one tiny thing, we load them to Excel, and we use conditional formatting to get things to look like this:  The reason this is so helpful? You can actually see the threads interleaving. This usually help me get to roughly the right place, and then I can add additional logging so I can figure out better what is actually going on. I was able to detect and fix several race conditions using this approach.  And yes, I know that this is basically printf() debugging. But at least it is printf() debugging with pretty colors.</p>
        </article>
        <article id="article-4750">
            <a href="https://www.meziantou.net/choosing-the-right-data-structure.htm" target="_blank">
                <h2 class="title mb-6" id="article-4750">Choosing the right data structure</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 09, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">#IntroductionIn data processing, a data structure is a logical structure intended to contain data, to give them an organization enabling them to be processed. Knowledge of them makes it possible to choose the one that best responds to a given problem. My goal is not to do an algorithm course but on</p>
        </article>
        <div class="button flex justify-between">
            <a href="474.html"><span class="back arrow"></span></a>

            <a href="476.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	"> Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
