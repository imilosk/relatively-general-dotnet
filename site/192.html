
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 192 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-1911">
            <a href="https://ayende.com/blog/185378-C/refactoring-c-code-implementing-parsing" target="_blank">
                <h2 class="title mb-6" id="article-1911">Refactoring C Code</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 07, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">So far, I did a whole lot of work around building the basic infrastructure of just building a trivial echo server with SSL. But the protocol I have in mind is a lot more complex, let&#x2019;s get started with actually implementing the parsing of messages.To start with, we need to implement parsing of lines. In C, this is actually a decidedly non trivial operation, because you need to read the data from the network into someplace and parse it. This area is rife with errors, so that is going to be fun. Here is a simple raw message:GET employees/1-A employees/2-BTimeout: 30Sequence: 293Include: ReportsToThe structure goes:CMD args1 argN\r\nAnd then header lines with:Name: value\r\nThe final end of the message is \r\n\r\n.To make things simple for myself, I&#x2019;m going to define the maximum size of a message as 8KB (this is the common size in HTTP as well). Here is how I decided to represent it in memory:The key here is that I want to minimize the amount of work and complexity that I need to do. That is why the entire message is limited to 8KB. I&#x2019;m also simplifying how I&#x2019;m going to be handling things from an API perspective. All the strings are actually C strings, null terminated, and I&#x2019;m using the argv, argc convention for naming, just like in the main function. This means that I can simply read from the network until I find a &#x201C;\r\n\r\n&#x201D; in there. Here is how I do this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          struct cmd* read_message(struct connection * c) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;int rc, to_read, to_scan = 0;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;do&#xA;        &#xA;        &#xA;          &#xA;          &#x9;{&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;// first, need to check if we already&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;// read the value from the network&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (c-&gt;used_buffer &gt; 0) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;char* final = strnstr(c-&gt;buffer &#x2B; to_scan, &quot;\r\n\r\n&quot;, c-&gt;used_buffer);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;if (final != NULL) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;struct cmd* cmd = parse_command(c, c-&gt;buffer, final - c-&gt;buffer &#x2B; 2/*include one \r\n*/);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;// now move the rest of the buffer that doesn&#x27;t belong to this command &#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;// adding 4 for the length of the msg separator (\r\n\r\n)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;c-&gt;used_buffer -= (final &#x2B; 4) - c-&gt;buffer;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;memmove(c-&gt;buffer, final &#x2B; 4, c-&gt;used_buffer);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;return cmd;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;to_scan = max(c-&gt;used_buffer - 3, 0);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;to_read = MSG_SIZE - c-&gt;used_buffer;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (to_read == 0) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;push_error(EINVAL, &quot;Message size is too large, after 8KB, &quot;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&quot;couldn&#x27;t find \r\n separator, aborting connection.&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;return NULL;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;rc = connection_read(c, c-&gt;buffer &#x2B; c-&gt;used_buffer, to_read);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (rc == 0)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;return NULL; // broken connection, probably&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;c-&gt;used_buffer &#x2B;= rc;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;} while (1);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          read_message.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;There is a bit of code here, but the gist of it is pretty simple. The problem is that I need to handle partial state. That is, a single message may come in two separate packets, or multiple messages may come in a single packet. I don&#x2019;t have a way to control that, so I need to be careful about tracking past state. The connection has a buffer that is used to hold the state in memory, whose size is large enough to hold the largest possible message. I&#x2019;m reading from the network to a buffer and then scanning to find the message separator.If I couldn&#x2019;t find it, I&#x2019;m recording the last location where it could be starting, and then issuing another network read and will try searching for \r\n\r\n again. Once that is found, the code will call to the parse_commnad() method that operates over the entire command in memory (which is much easier). With that done, my message parsing is actually quite easy, from a conceptual point of view, although I&#x2019;ll admit that C make it a bit long.&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          static struct cmd* parse_command(struct connection* c, char* buffer, size_t len) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;char* line_ctx = NULL, *ws_ctx = NULL, *line, *arg;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;struct cmd* cmd = NULL;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;char* copy = malloc(len&#x2B;1);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if (copy == NULL) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;push_error(ENOMEM, &quot;Unable to allocate command memroy&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;goto error_cleanup;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;// now we need to have our own private copy of this&#xA;        &#xA;        &#xA;          &#xA;          &#x9;memcpy(copy, buffer, len);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;copy[len] = 0; // ensure null terminator!&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;cmd = calloc(1, sizeof(struct cmd));&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if (cmd == NULL) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;push_error(ENOMEM, &quot;Unable to allocate command memroy&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;goto error_cleanup;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;line = strtok_s(copy, &quot;\r\n&quot;, &amp;line_ctx);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if (line == NULL) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;push_error(EINVAL, &quot;Unable to find \r\n in the provided buffer&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;goto error_cleanup;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;arg = strtok_s(line, &quot; &quot;, &amp;ws_ctx);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if (arg == NULL) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;push_error(EINVAL, &quot;Invalid message command line: %s&quot;, line);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;goto error_cleanup;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;do&#xA;        &#xA;        &#xA;          &#xA;          &#x9;{&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd-&gt;argc&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd-&gt;argv = realloc(cmd-&gt;argv, sizeof(char*) * cmd-&gt;argc);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd-&gt;argv[cmd-&gt;argc - 1] = arg;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;arg = strtok_s(NULL, &quot; &quot;, &amp;ws_ctx);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;} while (arg != NULL);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;while (1)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;{&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;line = strtok_s(NULL, &quot;\r\n&quot;, &amp;line_ctx);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (line == NULL)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;break;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;arg = strtok_s(line, &quot;:&quot;, &amp;ws_ctx);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (arg == NULL) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;push_error(EINVAL, &quot;Header line does not contain &#x27;:&#x27; separator: %s&quot;, line);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;goto error_cleanup;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;while (*ws_ctx != 0 &amp;&amp; *ws_ctx == &#x27; &#x27;)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;ws_ctx&#x2B;&#x2B;; // skip initial space&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd-&gt;headers_count&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd-&gt;headers = realloc(cmd-&gt;headers, sizeof(struct header) *cmd-&gt;headers_count);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd-&gt;headers[cmd-&gt;headers_count - 1].key = arg;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd-&gt;headers[cmd-&gt;headers_count - 1].value = ws_ctx;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;return cmd;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          error_cleanup:&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if (copy != NULL)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;free(copy);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if (cmd != NULL) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;cmd_drop(cmd);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;return NULL;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          parse_command.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;I&#x2019;m copying the memory from the network buffer to my own location, this is important because the read_message() function will overwrite it in a bit, and it also allow me to modify the memory more easily, which is required for using strtok(). This basically allow me to tokenize the message into its component parts. First on a line by line basis (with splitting on space for the first line and then treating this as headers lines).I added the ability to reply to a command, which means that we are pretty much almost done. You can see the current state of the code here.</p>
        </article>
        <article id="article-1912">
            <a href="https://ayende.com/blog/185249-C/cost-oriented-programming-in-the-cloud" target="_blank">
                <h2 class="title mb-6" id="article-1912">Cost oriented programming in the cloud</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 06, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">You might be familiar with Moore&#x2019;s law, which states that the number of transistors in a dense integrated circuit doubles about every two years. In effect, that performance doubles every 24 months. For many years, that has certainly held true. But that hasn&#x2019;t been the case for the past 10 years or so. Even when Moore&#x2019;s law held true, there was a snag. Wirth&#x2019;s law is also in effect (as an aside, read his article &#x201C;A Plea for Lean Software&#x201D;, 23 years, and it holds true today) and Wirth&#x2019;s law states that software is slower quicker than hardware is becoming faster. It&#x2019;s good to be a software developer, because even when the CPU clock speed doesn&#x2019;t jump all the time, we still get more CPUs to play with. A common approach to handle performance issues today is just to throw more parallelism at the problem until it shuts up. To a certain extent, this make a perfect economic sense. In the calculus between developers&#x2019; salaries and the cost of hardware, you&#x2019;ll usually find that buying a couple extra servers is drastically cheaper than spending another 6 months improving the performance of the system. Jeff Atwood wrote about the topic a decade ago and I think that he is still very much correct, to a degree. There are other factors to consider, which is the overhead over time and in particular in the cloud. One of the major factors to take into account here is that when you are running in the cloud, you aren&#x2019;t running on your servers and you are charged on usage. That can change the math by quite a bit.For example, if I bought a couple of servers, the number of IO operations that I make is pretty much meaningless to me. If I hitting the disk ten times a second or ten thousands times a second, I&#x2019;m paying the same cost. Oh, sure, I might need to buy a better hard disk to get 10,000 IOPS, but that is a one time cost, and usually not that meaningful in the grand scheme of things. But when you are on the cloud, getting higher IOPS cost more, and it cost more over time. In the same sense, in my data center, the cost of querying a database is zero. In the cloud, you will typically be charged some (miniscule) amount on a per query basis. Nothing to worry about, except that your software still work according to Wirth&#x2019;s law, so you are making more queries than you should, which means that you are charged for each and every one of them. I used to make my living by being a database performance consultant. I would go to a customer, look at how they are using their database and optimize the access pattern. It was common to see 90%&#x2B; savings in the number of queries for common operations. I was doing that because that directly translated to better responsiveness of the application. Applications that respond faster are more pleasant to use and there are numerous studies about faster applications generating higher revenues. I remember talking to clients and explaining to them why they should invest in the overall performance of the application before they hit the total resource depletion that would take them down.Today, in the cloud, I would have a much simpler task. Let&#x2019;s assume a simple application using CosmosDB, as an example. With 200 page views / sec on the site, and each page view generating 80 requests to the database, that gives us a total of 16,000 requests a second, which translates to an end of the month bill of about 10,000$. I&#x2019;m using the 80 queries / page view as a reasonable low ball estimate, mind. Drupal, for example, does 300 &#x2013; 400 queries per page view and it is easy to get to these numbers without paying attention. Dropping the number of queries per page to 10 (which is usually pretty easy to do with proper queries, attention to details and some caching) gives you a database bill that is around than 1,000$.Over the span of a year, that is enough to pay a full time developer that can go and find other places where your software can be improved. And unlike before, you don&#x2019;t need to justify with studies or any indirect causation. You can point directly to the bottom line in an invoice and show how much money is saved.</p>
        </article>
        <article id="article-1913">
            <a href="https://andrewlock.net/secure-secrets-storage-for-asp-net-core-with-aws-secrets-manager-part-2/" target="_blank">
                <h2 class="title mb-6" id="article-1913">Secure secrets storage for ASP.NET Core with AWS Secrets Manager (Part 2)</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 06, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how to control which secrets are loaded from AWS Secrets Manager when your ASP.NET Core app start.&#x2026;</p>
        </article>
        <article id="article-1914">
            <a href="https://ayende.com/blog/185377-C/debugging-security-errors" target="_blank">
                <h2 class="title mb-6" id="article-1914">Debugging security errors</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 05, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">&#x201C;I&#x2019;m getting a 403 Forbidden error&#x201D; is one of the more annoying things to debug. Something, somewhere, in a distributed system, has decided that a request is not authorized and blocked it.In RavenDB 3.5, we supported OAuth and Windows Authentication to authenticate clients talking to RavenDB. That meant that we had to field support questions exactly like the one above. That was not fun. First of all, there seem to be an inclination in the security community to hide errors really well. &#x201C;I don&#x2019;t like you because the difference between our clocks, let&#x2019;s send an EPERM to this socket and close it, and if I&#x2019;m feeling nice, log it to /var/logs/obscure/dev/null&#x201D;. I have scars from trying to work out &#x201C;Why doesn&#x2019;t Windows Auth work for this user&#x201D; that involved talking to a DBA who wasn&#x2019;t neither the domain admin nor even aware of the domain topology in the organization (Fallacies: There is one administrator). At one point, we had a production issue that had RavenDB refusing all access because Windows couldn&#x2019;t validate credentials because of a disconnect in a linked domain that was down for scheduled maintenance and the credential cache expired.When we designed RavenDB 4.0, we decided that for security, we need something that would be debuggable. That means:Secured &#x2013; that goes without saying, if it is security measure that is debuggable but isn&#x2019;t actually secured&#x2026;Rely only on two parties &#x2013; the client &amp; server in each connection. Provide enough information to solve the problemWe selected TLS / SSL for this, with client certificate as the authentication mechanism. This answers the first requirement, because TLS has been analyzed enough that I&#x2019;m certain that it is secured. It is also well known and familiar to administrators. TLS uses PKI, so it isn&#x2019;t technically a two parties solution, you may have to deal with certificates revocation, trust chains, etc. But those are well understood and you have really good errors on those. On the client certificate authentication side, however, we require that we&#x2019;ll have the actual list of trusted certificates, so there is no need to check anywhere else.We have also taken debuggable security a couple of steps further. For example, we&#x2019;ll accept an unsecured connection and let it establish itself. Then send a single message down the line, explaining why we aren&#x2019;t going to use it.In practice, this works great. Take a look at this stack overflow question, which shows the following error:Given just the information in the post and the error from RavenDB, it was easy to figure out that the client certificate hasn&#x2019;t been registered and that this is why RavenDB is refusing access.I consider this a major success.</p>
        </article>
        <article id="article-1915">
            <a href="https://ayende.com/blog/185345-C/refactoring-c-code-multi-platform-and-valgrind" target="_blank">
                <h2 class="title mb-6" id="article-1915">Refactoring C Code</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 04, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I decided that this is time to take my network protocol and make it cross platform, so I tried to compile it on the Linux subsystem for Windows. As an aside, the fact that I could edit everything in Visual Studio while compiling using GCC and having immediate feedback is amazing, given the usual workflow that this entails. And I would very much like to hear about an IDE that is comparable to Visual Studio out there.I got to say, the situation for dependencies on C/C&#x2B;&#x2B; is flat out horrible. I&#x2019;m depending on OpenSSL for this code, and I have used VCPkg for actually setting up the dependency. On WSL, on the other hand, the OpenSSL packages are from 2014(!), so they were incompatible. I re-compiled the lastest stable on WSL and tried to get it to work. It didn&#x2019;t, first it didn&#x2019;t put the new code in the right place and when I forced it to use the right paths, it failed with missing methods. It looks like I&#x2019;m spoiled from the point of backward compatibility, but several methods has been deprecated or flat our removed.I fixed that stuff only to find out that what the WSL version requires is actually newer than what the OpenSSL version I have on the Winodws machine has. I could compile the latest on Windows as well but for now it was just easier to conditional compile the stuff that I needed. I find it sad, but I want to get things done.After a lot of grunt work, I&#x2019;m happy to say that this looks like it is actually working. You can find the code for that in this link. I also wrote a small C# code to connect to the server, which looks like:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var tcpClient = new TcpClient();&#xA;        &#xA;        &#xA;          &#xA;          await tcpClient.ConnectAsync(IPAddress.Loopback, 4433);&#xA;        &#xA;        &#xA;          &#xA;          using (var stream = tcpClient.GetStream())&#xA;        &#xA;        &#xA;          &#xA;          using (var ssl = new SslStream(stream, leaveInnerStreamOpen: false,&#xA;        &#xA;        &#xA;          &#xA;              userCertificateValidationCallback: &#xA;        &#xA;        &#xA;          &#xA;                  (object sender, X509Certificate certificate, &#xA;        &#xA;        &#xA;          &#xA;                   X509Chain chain, SslPolicyErrors sslPolicyErrors) =&gt; true&#xA;        &#xA;        &#xA;          &#xA;                   ))&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var cert = new X509CertificateCollection();&#xA;        &#xA;        &#xA;          &#xA;              cert.Add(new X509Certificate2(@&quot;example.p12&quot;));&#xA;        &#xA;        &#xA;          &#xA;              await ssl.AuthenticateAsClientAsync(&quot;example.com&quot;, cert, checkCertificateRevocation: false);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              var writer = new StreamWriter(ssl);&#xA;        &#xA;        &#xA;          &#xA;              var reader = new StreamReader(ssl);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              while (true)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  Console.WriteLine(reader.ReadLine());&#xA;        &#xA;        &#xA;          &#xA;                  var str = Console.ReadLine();&#xA;        &#xA;        &#xA;          &#xA;                  writer.WriteLine(str);&#xA;        &#xA;        &#xA;          &#xA;                  writer.Flush();&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          network-client.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;I gotta admit, the difference in the lines of code and complexity between the two code bases is pretty staggering. I have to admit, I had an ulterior motive behind wanting to run on Linux, I wanted to see just how badly I managed to manage memory in this short bit of C code, and Valgrind is one of the more common tools to do that. Of course, Valgrind doesn&#x2019;t run on WSL, so I had to build that from source as well. I have to say, I was really careful about the actual memory usage and freeing everything. Valgrind was still able to find an issue within the first two minutes of me running it. I got to say, I&#x2019;m really impressed. Here is the leak:As you can see, this is happening because I&#x2019;m using client certificates and it is deep inside OpenSSL (narrator voice: it wasn&#x2019;t a problem with OpenSSL).This was a bit of a problem to try to figure out, because I was really careful and properly match each allocation call with the call to release it (in this case, SSL_new() with SSL_free()). I went over the code to establish and tear down a connection many times, but couldn&#x2019;t see any problem.The issue here is that Valgrind, in this case, shows me where the memory was allocate, but the leaks is actually elsewhere. OpenSSL implements reference counting for many objects, and as part of the client certificate usage I&#x2019;m getting the client&#x2019;s certificate an examining it. The act of getting the certificate increment the ref count on that certificate. I have to explicitly release that certificate once I&#x2019;m done with it. Naturally Valgrind wasn&#x2019;t able to figure all of that and just told me that I actually have a leak.Lesson learned, look at the allocation stack, but don&#x2019;t marry it or assume it is known correct. Here is the latest drop of code, which is able to pass Valgrind with no leaks detected.</p>
        </article>
        <article id="article-1916">
            <a href="https://andrewlock.net/secure-secrets-storage-for-asp-net-core-with-aws-secrets-manager-part-1/" target="_blank">
                <h2 class="title mb-6" id="article-1916">Secure secrets storage for ASP.NET Core with AWS Secrets Manager (Part 1)</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 04, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how you can store your ASP.NET Core secrets securely in AWS Secrets Manager and load them into the .NET Core configuration system.&#x2026;</p>
        </article>
        <article id="article-1917">
            <a href="https://ayende.com/blog/185313-C/refactoring-c-code-choosing-the-next-direction" target="_blank">
                <h2 class="title mb-6" id="article-1917">Refactoring C Code</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 03, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Initially I thought that my next step would be to write the code to handle more than a single connection at a time, but I decided that this isn&#x2019;t the natural next step. It would be better to build the API and abstractions that are required to use this network protocol before committing to an actual implementation. I took a peek at what is available, and it looks like we have the following options:Thread per connection &#x2013; obviously out.select() / pool() &#x2013; allow to have a single thread manage multiple connections, but require a lot of state management.libuv &#x2013; or similar, that handle all of those details for me.Regardless of what I&#x2019;ll end up in the end, I think that the externally facing API is always going to be the same, so I&#x2019;m going to focus on that. Right now we have:In other words, we have an interface that explicitly require us to manage state, manage the socket, etc. I think the first thing to do would be to change that. The first thing I did was to remove the connection_create and connection_read. They are now handled internally and no longer the concern of the calling code. Instead, we have:This is basic OO in C, we define a bunch of function pointers and allow the user to send them to us to be trigger appropriately. On connection create, we&#x2019;ll call connection_create(), and the user can return a state object that will be used in future callbacks. I&#x2019;m currently using connection_recv() that accepts a raw buffer, because I haven&#x2019;t dealt with parsing yet. Note the call to server_state_run(), which actually does all the work. I&#x2019;m currently just going to take whatever we already have and convert to this API.That turned out to be fairly straightforward to do, I&#x2019;m happy to say. I did find that working on C code after midnight has negative implications, I wrote:Do you see the bug? The first time I&#x2019;m adding a new cert, I&#x2019;m going to allocate a single byte, then I&#x2019;m going to write the full certificate_thumbprint to that memory, well beyond the buffer I actually allocated. The fix? That&#x2019;s simple enough, but it was an unpleasant thing to realize that I made this error.</p>
        </article>
        <article id="article-1918">
            <a href="https://www.meziantou.net/integrating-google-analytics-using-dependency-injection-in-asp-net-core.htm" target="_blank">
                <h2 class="title mb-6" id="article-1918">Integrating Google Analytics using dependency injection in ASP.NET Core</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 03, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Integrating Google Analytics in your website is not very complicated. You just need to copy the snippet in the head tag of your page. But, there is another way to integrate it. Since ASP.NET Core 2.0, you can create a Tag Helper Component. A Tag Helper Component is a Tag Helper that allows you to c</p>
        </article>
        <article id="article-1919">
            <a href="https://ardalis.com/double-dispatch-in-c-and-ddd/" target="_blank">
                <h2 class="title mb-6" id="article-1919">Double Dispatch in C# and DDD</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 01, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Double dispatch is a pattern you can use in C# to control how communication flows between two objects. A frequent use of the pattern is to&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-1920">
            <a href="https://ayende.com/blog/185282-C/refactoring-c-code-giving-good-ssl-errors-to-your-client" target="_blank">
                <h2 class="title mb-6" id="article-1920">Refactoring C Code</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 30, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Getting errors from SSL isn&#x2019;t easy. Sometimes, I think that so much encryption has wrapped things up and error reporting are treated as secret information that must be withheld. The root of the problem is that SSL doesn&#x2019;t really have a way for the two communicating parties to tell each other: &#x201C;I don&#x2019;t trust you because you wear glasses&#x201D;. There are some well known error codes, but for the most part, you&#x2019;ll get a connection abort. I want to see what it would take to provide good error handling for network protocol using SSL that handles:&#xA;&#xA;No certificate provided&#xA;Expired / not yet valid certificate provided&#xA;Unfamiliar certificate provided&#xA;&#xA;In order to do that, we must provide this error handling at a higher level than SSL. Therefor, we need to provide something in a higher layer. In this protocol, the first thing that the server will send to the client on connection will be: &#x201C;OK\r\n&#x201D; if everything is okay, or some error string that will explain the issue, otherwise. This turned out to be rather involved, actually.&#xA;First, I had to ask OpenSSL to send the &#x201C;please gimme a client cert&#x201D;:&#xA;&#xA;&#xA;&#xA;Note the callback? It will accept everything, since doing otherwise means that we are going to just disconnect with very bad error experience. After completing the SSL_accept() call, I&#x2019;m explicitly checking the client certificate, like so:&#xA;&#xA;&#xA;&#xA;I have to say, the sheer amount of code (and explicit error handling) can be exhausting. And the fact that C is a low level language is something that I certainly feel. For example, I have this piece of code:&#xA;&#xA;&#xA;&#xA;This took a long time to write. And it should have been near nothing, to be honest. We get the digest of the certificate, convert it from raw bytes to hex and then do a case insensitive comparison on the registered certificates that we already know.&#xA;To be honest, that piece of code was stupidly hard to write. I messed up and forgot that snprintf() will always insert a null terminator and I specified that it should insert only 2 characters. That led to some confusion, I have to say.&#xA;The last thing that this piece of code does is scan through the registered certificates and figure out if we are familiar with the one the client is using. You might note that this is a linked list, because this is pretty much the only data structure that you get in C. The good thing here is that it is easy to hide the underlying implementation, and this is a just some code that I write for fun. I don&#x2019;t expect to have a lot of certificates to deal with, nor do I expect o have to optimize the connection portion of this code, but it bothers me.&#xA;In C#, I would use a dictionary and forget about it. In C, I need to make a decision on what dictionary to use. That adds a lot of friction to the process, to be honest. If I wasn&#x2019;t using a dictionary, I would use a List&lt;T&gt;, which has the advantage that it is contiguous&#xA0;in memory and fast to scan. For completion&#x2019;s sake, here is the code that register a certificate thumbprint:&#xA;&#xA;As you can see, this isn&#x2019;t really something that interesting. But even though it doesn&#x2019;t really matter, I wonder how much effort it will take to avoid the usage of a link list&#x2026; I think that I can do that without too much hassle with realloc. Let&#x2019;s see, here is the new registration code:&#xA;&#xA;&#xA;&#xA;And here is how I&#x2019;m going to be iterating on it:&#xA;&#xA;&#xA;&#xA;So that isn&#x2019;t too bad, and we can be sure that this will be all packed together in memory. Of course, this is pretty silly, since if I have enough certificates to want to benefits from sequential scan performance, I might as well use a hash&#x2026;&#xA;Next topic I want to tackle is actually handling more than a single connected client at a time, but that will be for the next post. The code for this one is here.</p>
        </article>
        <div class="button flex justify-between">
            <a href="191.html"><span class="back arrow"></span></a>

            <a href="193.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>