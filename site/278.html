
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 278 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-2771">
            <a href="https://ayende.com/blog/178017/distributed-task-assignment-with-failover" target="_blank">
                <h2 class="title mb-6" id="article-2771">Distributed task assignment with failover</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 02, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When building a distributed system, one of the more interesting aspects is how you are going to distribute tasks assignment. In other words, given that you have multiple nodes, how do you decide which node will do what? In some cases, that is relatively easy, you can say &#x201C;all nodes will process read requests&#x201D;, but in others, this is more complex. Let us take the case where you have several nodes, and you need to have a regular backup of a database that is replicated between all those nodes. You probably don&#x2019;t want to run the backup across all the nodes, after all, they are pretty much the same and you don&#x2019;t want to backup the exact same thing multiple times. On the other hand, you probably don&#x2019;t want to assign this work statically, if you do, and if the node that is responsible for the backup is down, you got no backup.  Another example of the problem can be seen when you have other processes that you would like to be sticky if possible, and only jump around if there is a failure. Brining up a new node online is a common thing to do in a cluster, and the ideal scenario in that case is that a single node will feed it all the data that it needs. If we have multiple nodes doing that, they are likely to overlap and they might very well overload the poor new server. So we want just one node to update its state, but if that node goes down midway, we need someone else to pick up the slack.. For RavenDB, those sort of tasks includes things like ETL processes, Subscriptions, backup, bootstrapping new servers and more. We keep discovering new things that can use this sort of behavior. But how do we actually make this work? One way of doing this is to take advantage of the fact that RavenDB is using Raft and have the leader do task assignment. That works quite well, but it doesn&#x2019;t scale. What do I meant by that? I mean that as the number of tasks that we need to manage grows, the complexity in the task assignment portion of the code grows as well. Ideally, I don&#x2019;t want to have to consider twenty different variables and considerations before deciding what operation should go on which server, and trying to balance that sort of work in one place has proven to be challenging.  Instead, we have decided to allocate work in the cluster based on simple rules. Each task in the cluster has a key (which is typically generated by hashing some of its parameters), and that task can be assigned to a group of servers. Given those two details, we can use Jump Consistent Hashing to spread the load around. However, that doesn&#x2019;t handle failover. We have a heartbeat process that can detect and notify nodes that a sibling has went down, so combining those two, we get the following code: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public static string WhoseTaskIsIt(List&lt;Entry&gt; topology, ulong key)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;             topology = new List&lt;Entry&gt;(topology); // local copy so we can safely change it&#xA;        &#xA;        &#xA;          &#xA;             while (true)&#xA;        &#xA;        &#xA;          &#xA;             {&#xA;        &#xA;        &#xA;          &#xA;                 var index = (int)JumpConsistentHash(key, topology.Count);&#xA;        &#xA;        &#xA;          &#xA;                 var entry = topology.Values[index];&#xA;        &#xA;        &#xA;          &#xA;                 if (entry.Disabled == false)&#xA;        &#xA;        &#xA;          &#xA;                     return entry.Id;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                 topology.RemoveAt(index);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                 key = CombineHash(key, (ulong)topology.Count);&#xA;        &#xA;        &#xA;          &#xA;             }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          //A Fast, Minimal Memory, Consistent Hash Algorithm&#xA;        &#xA;        &#xA;          &#xA;          //by John Lamping, Eric Veach&#xA;        &#xA;        &#xA;          &#xA;          //relevant article: https://arxiv.org/abs/1406.2294&#xA;        &#xA;        &#xA;          &#xA;          public static long JumpConsistentHash(ulong key, int numBuckets)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            long b = 1L;&#xA;        &#xA;        &#xA;          &#xA;            long j = 0;&#xA;        &#xA;        &#xA;          &#xA;            while (j &lt; numBuckets)&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                b = j;&#xA;        &#xA;        &#xA;          &#xA;                key = key * 2862933555777941757UL &#x2B; 1;&#xA;        &#xA;        &#xA;          &#xA;                j = (long)((b &#x2B; 1) * ((1L &lt;&lt; 31) / ((double)(key &gt;&gt; 33) &#x2B; 1)));&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;            return b;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          public static ulong CombineHash(ulong x, ulong y)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              // This is the Hash128to64 function from Google&#x27;s CityHash (available&#xA;        &#xA;        &#xA;          &#xA;              // under the MIT License).  We use it to reduce multiple 64 bit hashes&#xA;        &#xA;        &#xA;          &#xA;              // into a single hash.&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              // Murmur-inspired hashing.&#xA;        &#xA;        &#xA;          &#xA;              ulong a = (y ^ x) * kMul;&#xA;        &#xA;        &#xA;          &#xA;              a ^= (a &gt;&gt; 47);&#xA;        &#xA;        &#xA;          &#xA;              ulong b = (x ^ a) * kMul;&#xA;        &#xA;        &#xA;          &#xA;              b ^= (b &gt;&gt; 47);&#xA;        &#xA;        &#xA;          &#xA;              b *= kMul;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              return b;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          distributed-task-ownership-decision.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; What we are doing here is rely on two different properties. Jump Consistent Hashing to let us know which node is responsible for what, and the Raft cluster leader that keep track of all the live nodes and let us know when a node goes down. When we need to assign a task, we use its hashed key to find its preferred owner, and if it is alive, that is that. But if it currently down, we do two things, we remove the downed node from the topology and re-hash the key with the new number of nodes in the cluster. That gives us a new preferred node, and so on until we find a live one.  The reason we rehash on failover is that Jump Consistent Hashing is going to usually point to the same position in the topology (that is why we choose it in the first place, after all), so we rehash to get a different position so it won&#x2019;t all fall unto the next node in the list. All downed node tasks are fairly distributed among the remaining live cluster members. The nice thing about this is that aside from keeping the live/down list up to date, the Raft cluster doesn&#x2019;t really need to do something. This is a consistent algorithm, so different nodes operating on the same data can arrive at the same result, so a node going down will result in another node picking up on updating the new server up to spec and another will start a backup process. And all of that logic is right where we want it, right next to where the task logic itself is written. This allow us to reason much more effectively about the behavior of each independent task, and also allow each node to let you know where each task is executing.</p>
        </article>
        <article id="article-2772">
            <a href="https://ardalis.com/when-should-you-upgrade-to-asp-net-core/" target="_blank">
                <h2 class="title mb-6" id="article-2772">When Should You Upgrade to ASP.NET Core?</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 02, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">ASP.NET Core 1.0 shipped last summer. Then ASP.NET Core 1.1 shipped last fall. Overall, the framework and server-side components have been&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-2773">
            <a href="https://www.meziantou.net/starting-a-http-file-server-from-the-file-explorer-using-dotnet-core.htm" target="_blank">
                <h2 class="title mb-6" id="article-2773">Starting a http file server from the file explorer using .NET Core</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 02, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">WarningThis post uses .NET Core 1.1. If you use .NET Core 2.0, please read the updated post here.If you&#x27;re developing html/js applications and want to test locally (file:///c:/...), many times your browser will prevent you from using some functionalities such as accessing local files using XMLHttpR</p>
        </article>
        <article id="article-2774">
            <a href="https://enterprisecraftsmanship.com/posts/code-review-user-controller-and-error-handling/" target="_blank">
                <h2 class="title mb-6" id="article-2774">Code review: User Controller and error handling</h2>
            </a>
            <p class="mb-2">by Vladimir Khorikov</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 01, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is the first code review where I showcase some real-world code example and nitpick suggest improvements in it. If you want to learn more about this new format, check out this post. You can also request a review yourself. To do that, use the form on this page.&#xA;&#xA;Code review: User Controller and error handling The code in question is a UserController class with this Create method:&#xA;publicIActionResult Create([FromBody] UserCreateModeluser)</p>
        </article>
        <article id="article-2775">
            <a href="https://ayende.com/blog/177987/de-virtualization-in-coreclr-part-ii" target="_blank">
                <h2 class="title mb-6" id="article-2775">De-virtualization in CoreCLR</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 01, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my previous post, I discussed how the CLR is handling various method calls, depending on exactly what we are doing ( interface dispatch, virtual method call, struct method call ). That was all fun and games, but how can we actually practice this? Let us take a look at a generic method and how it is actually translated to machine code: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          Run&lt;IActor&gt;( ... ) ;&#xA;        &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,r8  &#xA;        &#xA;        &#xA;          &#xA;           mov         r11,7FFACA010020h  &#xA;        &#xA;        &#xA;          &#xA;           cmp         dword ptr [rcx],ecx  &#xA;        &#xA;        &#xA;          &#xA;           call        qword ptr [r11]  &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          Run&lt;ActorStruct&gt;(...);&#xA;        &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,27AB5E33068h  &#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,qword ptr [rcx]  &#xA;        &#xA;        &#xA;          &#xA;           call        00007FFACA160750  &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          generic-calls.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; In the case of an interface, we got through the standard virtual stub to dispatch the method. In the case of a struct, the JIT was smart enough to inline the generic call. I&#x2019;ll let that sink in for a second. Using a struct generic argument, we were able to inline the call. Remember the previous post when we talked about the cost of method dispatch, in number of instructions, in number of memory jumps and references? We now have a way to replace those invocation cost with inlinable code. When is going to be useful? This technique is most beneficial when we are talking about code that is used a lot, is relatively small / efficient already, to the point where the cost of calling it is a large part of the execution time.  One situation that pop to mind that answer just this scenario is getting hash code and equality checks in a dictionary. The number of such calls that we have is in the many billions for second, and the cost of indirection here is tremendous. We have our own dictionary implementation (with different default and design guideline than the default one), but one who is also meant to be used with this approach. In other words, instead of passing an EqualityComparer instance, we use an EqualityComparer generic parameter. And that allows the JIT to tune us to the Nth degree, allow us to inline the hash / equals calls. That means that in a very hot code path, we can drastically reduce costs.</p>
        </article>
        <article id="article-2776">
            <a href="https://ardalis.com/registering-open-generics-in-aspnet-core-dependency-injection/" target="_blank">
                <h2 class="title mb-6" id="article-2776">Registering Open Generics in ASPNET Core Dependency Injection</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 30, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you have a generic interface and implementation that you want to configure for dependency injection in ASP.NET Core startup, there is a&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-2777">
            <a href="https://andrewlock.net/using-imagesharp-to-resize-images-in-asp-net-core-part-2/" target="_blank">
                <h2 class="title mb-6" id="article-2777">Using ImageSharp to resize images in ASP.NET Core - Part 2</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 30, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how to download a file from the URL provided in the querystring using ImageSharp&#x2026;</p>
        </article>
        <article id="article-2778">
            <a href="https://ayende.com/blog/177986/de-virtualization-in-coreclr-part-i" target="_blank">
                <h2 class="title mb-6" id="article-2778">De-virtualization in CoreCLR</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 28, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I mentioned that we are doing some work to enable de-virtualization of our code, as well as getting ready for CoreCLR changes that will get the JIT to do more de-virtualization. I was asked (by Maayan) about this, more specifically:  How does manual de-virtualization work? AFAIK, the compiler always emits a CallVirt instruction for non-static method calls, regardless of weather the method is virtual or not (and regardless of weather the class is sealed or not). Are you extending the C# compiler and overriding the emission code? Are you re-JITting the code in runtime (as profilers do using the profiler API)? And the answer is that Maayan is correct, C# is defined (for various reasons related to ECMA approval process over 15 years ago) to always dispatch methods using CallVirt. But CallVirt is an IL instruction, not an assembly one. Here is some code for various code, as well as the relevant assembly being generated for it (CoreCLR 1.1, X64, Release). Don&#x2019;t worry about the assembly, I have detailed explanations below for each part. &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,rdx  &#xA;        &#xA;        &#xA;          &#xA;           mov         r11,7FFABFEA0020h  &#xA;        &#xA;        &#xA;          &#xA;           cmp         dword ptr [rcx],ecx  &#xA;        &#xA;        &#xA;          &#xA;           call        qword ptr [r11]  &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(IActor d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,rdx  &#xA;        &#xA;        &#xA;          &#xA;           mov         rax,qword ptr [rdx]  &#xA;        &#xA;        &#xA;          &#xA;           mov         rax,qword ptr [rax&#x2B;40h]  &#xA;        &#xA;        &#xA;          &#xA;           call        qword ptr [rax&#x2B;20h]  &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(ActorVirtual d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           mov         qword ptr [rsp&#x2B;38h],rdx  &#xA;        &#xA;        &#xA;          &#xA;           lea         rcx,[rsp&#x2B;38h]  &#xA;        &#xA;        &#xA;          &#xA;           call        00007FFACA4C00E8  &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(ActorStruct_NoInline d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,1EB4DDC3068h  &#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,qword ptr [rcx]  &#xA;        &#xA;        &#xA;          &#xA;           call        00007FFACA4B0750  &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(ActorStructStruct d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          // all Exec impl, are:&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          public void Exec()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              Console.WriteLine(&quot;1&quot;);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          calls-and-asm.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; This is pretty simple (non inlined) set of methods that are just there to make sure that you can see what ends up actually running. The actual method just end up calling Console.WriteLine, but that is about it. Now, let us inspect each of those behaviors one at a time, first let us look at how an interface dispatch work. &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h                 - reserve stack space&#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,rdx                 - move incoming parameter to rcx (this pointer for the next call method in this case)&#xA;        &#xA;        &#xA;          &#xA;           mov         r11,7FFABFEA0020h       - move virtual stub address to r11&#xA;        &#xA;        &#xA;          &#xA;           cmp         dword ptr [rcx],ecx     - ensure that we weren&#x27;t given null value&#xA;        &#xA;        &#xA;          &#xA;           call        qword ptr [r11]         - call the stub with the address of the interface impl obj&#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h                 - free stack space&#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(IActor d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;          rough C# code would be:&#xA;        &#xA;        &#xA;          &#xA;          &#xA;        &#xA;        &#xA;          &#xA;            if(d == null) trap();&#xA;        &#xA;        &#xA;          &#xA;            StubCallFor_IActor(d); &lt;-- will decide based on type of d how to run it &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          interface-dispatch.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; If you want the gory details, you can look for those&#xA0; in the Book of the Runtime. But basically, we are jumping to a code location that will find the proper code that we need to execute. Note that there is still additional work there to actually route the method to the appropriate place, which is hidden from us by the runtime, JIT, etc.  Note that the funny cmp method there? It is there to generate a dereference of the address by the CPU, which will cause it raise a trap if the address is invalid, and if the address is 0, the CLR will convert that to a NullReferenceException. Now, what about a virtual method call? That is actually simpler, since is it similar to how I learned it when I worked with C&#x2B;&#x2B;. &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h                   - reserve stack space&#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,rdx                   - move the d parameter to rcx, which will serve as the this pointer for the next call&#xA;        &#xA;        &#xA;          &#xA;           &#xA;        &#xA;        &#xA;          &#xA;           mov         rax,qword ptr [rdx]       - this two lines can be translated to &#xA;        &#xA;        &#xA;          &#xA;           mov         rax,qword ptr [rax&#x2B;40h]   - rax = *(&amp;d &#x2B; 64) - which is getting to the virtual method table&#xA;        &#xA;        &#xA;          &#xA;           &#xA;        &#xA;        &#xA;          &#xA;           call        qword ptr [rax&#x2B;20h]       - (rax &#x2B; 32) (); - invoke a specific method from the virtual method table&#xA;        &#xA;        &#xA;          &#xA;                                                 - basically &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h                   - free stacl space&#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(DisposeImplVirtual d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;          rough C# code would be:&#xA;        &#xA;        &#xA;          &#xA;           &#xA;        &#xA;        &#xA;          &#xA;              d.MethodTable[4](d);&#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          virtual-dispatch.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; Basically, at the end of the object we have a method table pointer, and we dereference that, and then another pointer to the specific method we want to invoke. Part of the reason that virtual calls are expensive is exactly this, we have to jump around in memory a lot, and that means that we both have to issue more instructions, and more to the point, we have to touch a lot more memory, which can can cause cache lines to be evicted, forcing us to stall. What about a struct method call? To make things easier, I made sure that it couldn&#x2019;t be inlined, which generated: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h                  - reserve stack space&#xA;        &#xA;        &#xA;          &#xA;           mov         qword ptr [rsp&#x2B;38h],rdx  - put value of parameter on the stack&#xA;        &#xA;        &#xA;          &#xA;           lea         rcx,[rsp&#x2B;38h]            - put address of the stack in rcx (this for the next call)&#xA;        &#xA;        &#xA;          &#xA;           call        00007FFACA4C00E8         - call the method directly &#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h                  - release stack space&#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(ActorStruct_NoInline d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          struct-no-inline-dispatch.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; In this case, I&#x2019;m using an empty struct, so it has as much size as a pointer, which is why you can see it being passed around like it was just a pointer. If I had a bigger struct, I would see very different code.  &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          sub         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;          mov         rcx,rdx  &#xA;        &#xA;        &#xA;          &#xA;          call        00007FFAC9EE00E8  &#xA;        &#xA;        &#xA;          &#xA;          nop  &#xA;        &#xA;        &#xA;          &#xA;          add         rsp,28h  &#xA;        &#xA;        &#xA;          &#xA;          ret &#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          non-empty-struct.asm&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; Why is the code simpler when the struct is bigger? Well, the answer is quite simple, we are looking at the actual method that was called with this parameter, but the job of actually sending the parameter is done by the caller, so we aren&#x2019;t seeing it here. What is going on is that as long as your struct is empty or have a single value that is an 4 / 8 bytes long, the CLR can optimize that to be a regular parameter, making it effectively free. In such cases, you can see the struct being passed around in registers (the struct itself, since it is copied, not the address to it). However, if you have a struct that is composed of multiple fields, that require us to copy each field to the stack before call, which on large stacks can take a bit. I mentioned that this was done with a struct that we disabled inlining for, what happens if we allow inlining (the default)? &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          /*&#xA;        &#xA;        &#xA;          &#xA;           sub         rsp,28h              - reserve stack space&#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,1EB4DDC3068h     - load address of string constants table entry&#xA;        &#xA;        &#xA;          &#xA;           mov         rcx,qword ptr [rcx]  - deferefence the relavant string constant position&#xA;        &#xA;        &#xA;          &#xA;           call        00007FFACA4B0750     - call WriteLine&#xA;        &#xA;        &#xA;          &#xA;           nop  &#xA;        &#xA;        &#xA;          &#xA;           add         rsp,28h              - free stack space&#xA;        &#xA;        &#xA;          &#xA;           ret  &#xA;        &#xA;        &#xA;          &#xA;          */&#xA;        &#xA;        &#xA;          &#xA;          public void Run(ActorStruct d)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              d.Exec();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          struct-with-inline.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; This looks completely different then anything we have seen so far. And in fact, it is. What we are seeing here is the result of inlining the struct method invocation. Because the compiler was able to figure out what the end target of the call is, and because it is small enough to be inlined, we can skip calling the method entirely and just directly run the code. As it turns out, this can have dramatic affect on performance (on both directions, mind), and something that you need to carefully consider when you analyze your application performance. But the short of it is, the fewer jumps and dereferences we have, the better it is for us. And you can see the various methods (pun intended) that the CLR uses to dispatch them. In my next post, I&#x2019;ll talk about how we can make use of this behavior.</p>
        </article>
        <article id="article-2779">
            <a href="https://ayende.com/blog/177955/writing-a-time-series-database-with-voron" target="_blank">
                <h2 class="title mb-6" id="article-2779">Writing a time series database with Voron</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 27, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Following up on this post, I wondered what it would be like if I were to implement this with Voron. Given that Voron was explicitly designed to be a low level storage engine, suitable for varying needs, it is an interesting experiment.  Let us define upfront what we want to do: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public interface ITimeSeriesDatabase&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;             Task Append(BlittableJsonReaderObject key, DateTime time, double value);&#xA;        &#xA;        &#xA;          &#xA;             &#xA;        &#xA;        &#xA;          &#xA;             IEnumerable&lt;double&gt; Query(Dictionary&lt;string, string&gt; matches, DateTime from, DateTime to);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          ITimeSeriesDatabase.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; We use BlittableJsonReaderObject as the key in the add because initializing a dictionary per add call would be ridiculously expensive. The blittable instance is much cheaper, and its associated memory can be cleaned when it is done much more easily. Here is how we handle the append: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public Task Append(BlittableJsonReaderObject key, DateTime time, double value)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var entry = new Entry&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  Key = key,&#xA;        &#xA;        &#xA;          &#xA;                  Time = time,&#xA;        &#xA;        &#xA;          &#xA;                  Value = value&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              _entries.Enqueue(entry);&#xA;        &#xA;        &#xA;          &#xA;              _hasEntries.Set();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              return entry.Tcs.Task;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          ITimeSeriesDatabase.Append.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; There isn&#x2019;t much here, and that is quite intentional. What you are seeing here is transaction merging. Instead of having to compete on the same lock, we just place the value to be written on the queue, and wait for it to complete. The other side of that is the transaction merging itself: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private unsafe void TransactionMerger()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var existing = new HashSet&lt;long&gt;();&#xA;        &#xA;        &#xA;          &#xA;              var tasks = new List&lt;TaskCompletionSource&lt;object&gt;&gt;();&#xA;        &#xA;        &#xA;          &#xA;              while (_cts.IsCancellationRequested == false)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  existing.Clear();&#xA;        &#xA;        &#xA;          &#xA;                  tasks.Clear();&#xA;        &#xA;        &#xA;          &#xA;                  double value;&#xA;        &#xA;        &#xA;          &#xA;                  using (var tx = _storageEnvironment.WriteTransaction())&#xA;        &#xA;        &#xA;          &#xA;                  using (Slice.From(tx.Allocator, &quot;dummy-val&quot;, out Slice dummy))&#xA;        &#xA;        &#xA;          &#xA;                  using (Slice.External(tx.Allocator, (byte*)&amp;value, sizeof(double), out Slice valueSlice))&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      var fst = tx.FixedTreeFor(dummy, valSize: sizeof(double));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      int count = 0;&#xA;        &#xA;        &#xA;          &#xA;                      Entry entry;&#xA;        &#xA;        &#xA;          &#xA;                      var propertiesInsertionBuffer = new BlittableJsonReaderObject.PropertiesInsertionBuffer();&#xA;        &#xA;        &#xA;          &#xA;                      while (_entries.TryDequeue(out entry))&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                          var keyHash = (long)entry.Key.DebugHash;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                          using (Slice.External(tx.Allocator, (byte*)&amp;keyHash, sizeof(long), out Slice slice))&#xA;        &#xA;        &#xA;          &#xA;                          {&#xA;        &#xA;        &#xA;          &#xA;                              fst.RepurposeInstance(slice, clone: false);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                              value = entry.Value;&#xA;        &#xA;        &#xA;          &#xA;                              fst.Add(entry.Time.Ticks, valueSlice);&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          if (existing.Add(keyHash))&#xA;        &#xA;        &#xA;          &#xA;                          {&#xA;        &#xA;        &#xA;          &#xA;                              int propCount = entry.Key.GetPropertiesByInsertionOrder(propertiesInsertionBuffer);&#xA;        &#xA;        &#xA;          &#xA;                              var prop = new BlittableJsonReaderObject.PropertyDetails();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                              for (int i = 0; i &lt; propCount; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                              {&#xA;        &#xA;        &#xA;          &#xA;                                  entry.Key.GetPropertyByIndex(propertiesInsertionBuffer.Properties[i], ref prop);&#xA;        &#xA;        &#xA;          &#xA;                                  var tree = tx.CreateTree(prop.Name);&#xA;        &#xA;        &#xA;          &#xA;                                  var matches = tree.FixedTreeFor(prop.Value.ToString());&#xA;        &#xA;        &#xA;          &#xA;                                  matches.Add(keyHash);&#xA;        &#xA;        &#xA;          &#xA;                              }&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          tasks.Add(entry.Tcs);&#xA;        &#xA;        &#xA;          &#xA;                          if (count&#x2B;&#x2B; &gt; 25_000)&#xA;        &#xA;        &#xA;          &#xA;                          {&#xA;        &#xA;        &#xA;          &#xA;                              _hasEntries.Set();&#xA;        &#xA;        &#xA;          &#xA;                              break;&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      tx.Commit();&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  foreach (var tcs in tasks)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      tcs.TrySetResult(null);&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  _hasEntries.Wait();&#xA;        &#xA;        &#xA;          &#xA;                  _hasEntries.Reset();&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          ITimeSeriesDatabase.TransactionMerger.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; Please note that I didn&#x2019;t really focus on performance here, just to make sure that this is clear. Basically, we use the hash of the key as the time series id, and then we break the key into name/value pieces, and record the time series ids of all the series with that particular name/value. That allows us to get the list of all the series that match a particular name/value easily, and from there we can do more complex filtering. We are using a FixedSizeTree for quite a lot, this is basically a tree whose key is always a long, and whose value is predefined (in this case, a double), and we just store that based on the time series id.  Querying this will require us to first find all the series that match the query, then find the relevant values in the time range for the specified series, and that is all .</p>
        </article>
        <article id="article-2780">
            <a href="https://ayende.com/blog/177954/re-writing-a-time-series-database-from-scratch" target="_blank">
                <h2 class="title mb-6" id="article-2780">re</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 26, 2017
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is a fascinating post about building a time series database from scratch. The author explicitly warns that they have no background in databases, but given that this is my day job, I decided I might throw in my 2 cents about the way they do things.&#xA;Note: Large protion of the original post talk about their existing system (which they are replacing), and most of my criticisms are about that system. Where I&#x27;m talking about the new system (toward the end of this post) , I&#x27;m noting that explicitly.&#xA;I started writing this post about halfway through reading&#xA0; the post, mostly because I got all sort of comments and wanted to keep a record of things as I&#x2019;m reading it. It is possible that some of the things that I&#x2019;m concerned about would be answered later in the post. Without further ado, my comments. It will probably won&#x2019;t make sense without reading the original post.&#xA;They are storing their time series data using keys similar to:&#xA;&#xA;{__name__=&quot;requests_total&quot;, path=&quot;/status&quot;, method=&quot;GET&quot;, instance=&#x201D;10.0.0.1:80&#x201D;}&#xA;&#xA;And then they allow to do queries on both the keys and time (all GET requests on /status in the past week). I would have thought about this, but it it a very interesting way to handle queries on such an environment. They also seem to need to do queries that are both in the same series and across series, they call it vertical and horizontal queries.&#xA;&#xA;Let&#x27;s just consider the main take away: sequential and batched writes are the ideal write pattern for spinning disks and SSDs alike.&#xA;&#xA;Yes, that is pretty much the key for good performance.&#xA;&#xA;So ideally, samples for the same series would be stored sequentially so we can just scan through them with as few reads as possible. On top, we only need to know where this sequence starts to access all data points.&#xA;There&#x27;s obviously a strong tension between the ideal pattern for writing collected data to disk and the layout that would be significantly more efficient for serving queries. It is the fundamental problem our TSDB has to solve.&#xA;&#xA;Yes, being able both write efficiently and query efficiently are two very different problems that you need to handle, and often you need to select which one you&#x2019;ll prefer.&#xA;&#xA;We create one file per time series that contains all of its samples in sequential order.&#xA;&#xA;What?! No, you can&#x2019;t do that. At least, you can&#x2019;t do that and get reasonable behavior. To start with, even though you are doing batch, you are actually guaranteeing that your write pattern would be random. Why is that?&#xA;Because if you are writing every KB (which is what they do) per file, you are basically ensuring that the OS will have to write to different sectors / pages on the physical drive. So if you have writes to 100 series, you are going to be writing to 100 different on disk locations. To make things worse, you aren&#x2019;t writing in 4KB increments, which basically means that you are doing buffered writes. That information isn&#x2019;t in the post, but it is a safe assumption, since if they weren&#x2019;t doing buffered writes, there is no way that the operating system will be able to catch up with the kind of load. That in turn means that you don&#x2019;t have any durability whatsoever.&#xA;In fact, this is mentioned explicitly, but only in the case of losing the writes made in the application buffer. I&#x2019;m assuming that they either don&#x2019;t care or have a different manner for avoiding / dealing with data loss / corruption in the case of machine failure. More to the point, given that they do compression, they need to be able to recover from partially written data to the files, and from the post, I don&#x2019;t think that they are doing that.&#xA;But those issues are only just the start. On Windows, you don&#x2019;t typically worry about the number of open files you have, but on Linux, there is a typical a limit on the number of open files you can have. It is common to have that around 64K max open files. Using a file per series means that you are very likely going to run into issues with the number of open files you have, in fact, it would be very easy to construct a query that would hit that limit, and that would have a global impact on the server.&#xA;Other issues with such large number of files is that file systems don&#x2019;t really like it when you have so many files, this is discussed in the post as running out of inodes, but we have noticed performance degradation on directories with large number of files on a wide variety of file systems.&#xA;When you implement expiration of data, it also means that you have to move data from the middle of the file to the beginning, and then truncate it, that leads to a huge amount of additional I/O, likely blocking and is probably something that an operations guy is looking at.&#xA;Another issue is that because they have a file per series, they need to cache it aggressively, leading to competition between the database cache and the operation system page cache. It also means that the application is sensitive to allocation patterns, and on Linux, that is a really bad thing to do, because the silly OOM killer.&#xA;&#xA;When querying data that is not cached in memory, the files for queried series are opened and the chunks containing relevant data points are read into memory. If the amount of data exceeds the memory available, Prometheus quits rather ungracefully by getting OOM-killed.&#xA;&#xA;Yep, that was my first thought when I started reading this. I follow the reasoning on why OOM is there, but I still think it is a very silly choice.&#xA;The actual solution that they present is to have all the data for a particular time frame (2 hours, in their case) in a block directory. I&#x2019;m not sure why they have a separate directory from block (with multiple chunks per block), and mmaping the whole thing. That is a far better solution, but they also implement compaction, which get you right back to write amplification, and I don&#x2019;t quite get why. The example they give is that if you have a week long query, you don&#x2019;t want to merge results across 80 blocks, but I would assume that this is surely better than having to write the same data over and over again.&#xA;&#xA;If the series with IDs 10, 29, and 9 contain the label app=&quot;nginx&quot;, the inverted index for the label &quot;nginx&quot; is the simple list [10, 29, 9], which can be used to quickly retrieve all series containing the label.&#xA;&#xA;This just screams at me that it is wrong. Oh, not the actual content, but look at the list, it should be [9, 10, 29], because working with the sorted data is going to enable so many more interesting scenarios. Oh, it seems like that is what they are doing in the new version, so that is good.&#xA;I think that I found the right location for the code, and this line scares me, basically, it means that this will issue an fsync once every 10 seconds. That means that there is a 10 seconds period of potential data loss. Given the data that is kept, that is probably not an issue, and losing 10 seconds of samples is likely not going to be an issue.&#xA;That means that you can basically do all writes to memory all the time, and that gives you a major performance boost all around, at the expense of safety.&#xA;This is an interesting enough topic that I&#x2019;ll do another post, discussing how I&#x2019;ll implement the same scenario with Voron.</p>
        </article>
        <div class="button flex justify-between">
            <a href="277.html"><span class="back arrow"></span></a>

            <a href="279.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>