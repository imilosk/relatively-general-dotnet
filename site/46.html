
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 46 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-451">
            <a href="https://devblogs.microsoft.com/dotnet/introducing-ms-test-runner/" target="_blank">
                <h2 class="title mb-6" id="article-451">Introducing the MSTest Runner &#x2013; CLI, Visual Studio, &amp; More</h2>
            </a>
            <p class="mb-2">by Amaury Lev&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 24, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">MSTest runner is a new, light-weight and portable runner for MSTest tests available in the .NET CLI, Visual Studio, and more!</p>
        </article>
        <article id="article-452">
            <a href="https://ayende.com/blog/200580-B/meta-blog-im-a-js-developer-now" target="_blank">
                <h2 class="title mb-6" id="article-452">Meta Blog</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 23, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Following my previous post&#xA0;about updating the publishing platform of this blog, I realized that I dug myself into a hole. The new workflow was pretty sweet. To the point where I wrote my blog posts a lot more frequently than before, as you can probably tell. The problem was that I wanted to edit and process the blog post inside Google Docs, where I have a great workflow for editing, reviews, collaboration, etc. And then I want to push that same document to the blog. The killer for me is that I want that to be a smooth process, and the end text should fit&#xA0;into the blog. That means, if I want to emphasize&#xA0;something, it should be seen in the blog as bold. And if I want to write some code, that should work as well. In fact, the&#xA0;reason that I started this process is that it got so annoying to post code to the blog.I&#x2019;m using Google Docs&#x2019; export functionality to get the HTML back, and I did some basic cleaning to get it blog-ready instead of being focused on visual fidelity. I was using HTML Agility Pack to do that, and it turned out to be the wrong tool for the job. The issue is that it processed the data as if it were an XML document. I actually got a lot of track record with XML, so that wasn&#x2019;t the issue. The problem is that I wanted to do a series of non-trivial things with the HTML, and there aren&#x2019;t any off-the-shelf facilities to do that in .NET that I could find. For example, given how important it is to me to show code snippets properly, I wanted to be able to grab them from the document, figure out what language I&#x2019;m actually using there and syntax highlight it properly. There isn&#x2019;t anything like that in .NET, all the libraries I found were for JavaScript. You know the adage about: Let&#x2019;s rewrite it in Rust? I rewrote my entire publishing process to JavaScript. Which then led me to another adventure. How can I do two contrary things? When I&#x2019;m writing this document, I want to be able to just write the code. When I publish it, I want to see the syntax highlighted code, properly formatted and working.Google Docs has support for writing code blocks inline (for some small number of languages), which is great for the editing process. However, &#xA0;the HTML that this generates is beyond atrocious. What is even worse, in HTML, it doesn&#x2019;t align things properly using fixed-sized fonts, etc. In other words, it is almost&#xA0;there, but not quite. When analyzing the Google Docs output, I noticed a couple of funny characters in the code output. Here is what it looks like. I believe this is a bug in the export process, probably related to the way code blocks work in Google Docs.Dear Googlers, if you are reading this, please make a note that this thing has just been Hyrum&#x27;s Law. It is an observable state, and I&#x2019;m relying on it to do important tasks. Don&#x2019;t break this in the future.It turns out these are actually a pair of Unicode characters. More specifically, they are Unicode characters that are marked for private use:0xEC03&#xA0;- appears to be used to mark the beginning of a code block0xEC02&#xA0;- appears to be used to mark the end of a code blockNote the &#x201C;appears&#x201D;, and my blatant disregard for things like software maintenance discipline and all things proper and good in the world of Computer Science. This is a project where there are no rules, there is one customer, and he can code &#x1F642;.As mentioned earlier, while extracting the Google Doc as HTML and processing it, I encounter those Unicode markers that delineate the code section. This is good, because in terms of HTML itself, what it is doing inside is a&#x2026; mess. Getting the actual text as it is supposed to be is not easy. So I exported the file again, as text. Those markers are showing up in the textual edition as well, which made things a lot easier for me. With all of this done, allow me to show you some truly horrifying&#xA0;beautiful code:let blocks = [];&#xA;for (const match of text.data.matchAll(/\uEC03(.*?)\uEC02/gs)) {&#xA;    const code = match[1].trim();&#xA;    const lang = flourite(code, { shiki: true, noUnkown: true }).language;&#xA;    const formattedCode = Prism.highlight(code, Prism.languages[lang], lang);&#xA;&#xA;&#xA;    blocks.push(&quot;&lt;hr/&gt;&lt;pre class=&#x27;line-numbers language-&quot; &#x2B; lang &#x2B; &quot;&gt;&quot; &#x2B;&#xA;        &quot;&lt;code class=&#x27;line-numbers language-&quot; &#x2B; lang &#x2B; &quot;&#x27;&gt;&quot; &#x2B;&#xA;        formattedCode &#x2B; &quot;&lt;/code&gt;&lt;/pre&gt;&lt;hr/&gt;&quot;);&#xA;}&#xA;&#xA;&#xA;let inCodeSegment = false;&#xA;htmlDoc.findAll().forEach(e =&gt; {&#xA;    var text = e.getText().trim();&#xA;    if (text == &quot;&amp;#60419;&quot;) {&#xA;        e.replaceWith(blocks[codeSegmentIndex&#x2B;&#x2B;]);&#xA;        inCodeSegment = true;&#xA;    }&#xA;    if (inCodeSegment) {&#xA;        e.extract();&#xA;    }&#xA;    if (text == &quot;&amp;#60418;&quot;) {&#xA;        inCodeSegment = false;&#xA;    }&#xA;})That isn&#x2019;t a lot of code, but it does plenty. We scan through the textual&#xA0;version of the document and find all the code blocks using a regular expression. We then try to figure out what language I&#x2019;m using and apply code formatting during the publication process (this saves the need to change anything on the blog, which is nice, especially since we have to take into account syndication).I push the code snippets into an array and then I process the actual HTML document using the DOM and find all the code snippets. I replace the start marker with the actual formatted code and continue to discard all the other elements until I hit the end of the code segment. The rest of the code remains pretty much the same as before.I was writing this in VS Code and copilot suggested the following code for handling images:htmlDoc.findAll(&#x27;img&#x27;).forEach(img =&gt; {&#xA;    if (img.attrs.hasOwnProperty(&#x27;src&#x27;)) {&#xA;        let src = img.attrs.src;&#xA;        let imgName = src.split(&#x27;/&#x27;).pop();&#xA;        let imgData = entries.find(e =&gt; e.entryName === &#x27;images/&#x27; &#x2B; imgName).getData();&#xA;        let imgType = imgName.split(&#x27;.&#x27;).pop();&#xA;        let imgSrc = &#x27;data:image/&#x27; &#x2B; imgType &#x2B; &#x27;;base64,&#x27; &#x2B; imgData.toString(&#x27;base64&#x27;);&#xA;        img.replaceWith(&#x27;&lt;img src=&quot;&#x27; &#x2B; imgSrc &#x2B; &#x27;&quot; style=&quot;float: right&quot;/&gt;&#x27;);&#xA;    }&#xA;})In other words, instead of uploading the images as separate files, I can just encode them into the blog post directly. I like that idea very much because it means that I don&#x2019;t have to store the images elsewhere. Given that I don&#x2019;t have any npm packages to abandon, I don&#x2019;t know if I can call myself a JavaScript developer, but I did put the full code up&#xA0;for people to take a peek and then recoil.</p>
        </article>
        <article id="article-453">
            <a href="https://ardalis.com/2023-year-in-review/" target="_blank">
                <h2 class="title mb-6" id="article-453">2023 Year in Review</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 23, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Now that CodeMash is over (I had a workshop and 2 talks, including a new one), I can focus enough to write up this review post. For those&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-454">
            <a href="https://devblogs.microsoft.com/dotnet/dotnet-framework-january-2024-cumulative-update-preview/" target="_blank">
                <h2 class="title mb-6" id="article-454">.NET Framework January 2024 Cumulative Update Preview</h2>
            </a>
            <p class="mb-2">by Salini Agarwal</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 23, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">January 2024 Cumulative Update Preview Updates for .NET Framework.</p>
        </article>
        <article id="article-455">
            <a href="https://andrewlock.net/creating-a-source-generator-part-10-testing-your-incremental-generator-pipeline-outputs-are-cacheable/" target="_blank">
                <h2 class="title mb-6" id="article-455">Testing your incremental generator pipeline outputs are cacheable</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 23, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Creating a source generator - Part 10</p>
        </article>
        <article id="article-456">
            <a href="https://ayende.com/blog/200578-B/non-fungible-money-in-cloud-accounting" target="_blank">
                <h2 class="title mb-6" id="article-456">Non fungible money in cloud accounting</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 22, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Fungible is a funny word, mostly because you are most likely familiar with the term from NFT (non-fungible tokens) and other similar scams. At its core, it is the idea that for certain things, the instance doesn&#x2019;t matter, just the amount.The classic example is that if I lend you a 50$ bill, and you give me back two 20$ bills and a 10$ bill, you&#x2019;ve still given me back my money. That is even though you very clearly didn&#x2019;t. I didn&#x2019;t get the same physical 50$ paper bill back, I got bills for that same amount. On the other hand, if I give you my dog for the weekend, I would be quite upset if I got back three different dogs, even if the total weight is the same.This is actually a lot more than I want&#xA0;to know about fungibility, to be honest. But it turns out that if you are running a cloud business&#xA0;or just use the cloud in general, you have to be well-versed in the matter. Because in the cloud, money isn&#x2019;t&#xA0;fungible. In fact, it doesn&#x2019;t behave a lot like money at all. Let&#x2019;s assume that we are a cloud company called cloud.example.com, offering VPS for ourr users. You are in charge of writing the billing code, and it is pretty simple, right? Here is some code that can compute the charges:function compute_charges(custId, start, end) {&#xA;  let total = 0;&#xA;  let predicate = instance =&gt;&#xA;    (instance.custId === custId  &amp;&amp; instance.started &lt; end) &amp;&amp;&#xA;    (instance.ended &gt; start      || instance.ended == null);&#xA;&#xA;&#xA;  for (let instance of query_instances(predicate)) {&#xA;    total &#x2B;= instance.hours_running(start, end) *&#xA;             instance.price_per_hour;&#xA;  }&#xA;&#xA;&#xA;  return total;&#xA;}As you can see, there isn&#x2019;t much there. We find all the instances that were running in the billing period and then calculate the total hours they ran during that period. Please note, this is a simplified model as we aren&#x2019;t dealing with stopping &amp; starting instances, etc. The output of the compute_charges()&#xA0;function is a number, which will presumably be handed over to be charged over a credit card. There are other things that we need to do as well (generate an invoice, have a usage report, etc), but I want to focus on the money issue here.The simplest model is that at the end of the billing period, we charge the customer (using a credit card, for example) and receive our payment. Everyone is happy and we can go home, hopefully richer. The challenge arises when we want to offer additional options to the customer. For example, we may be willing to give the customer a discount if they are going to commit to a minimum amount of money they&#x2019;ll spend each month. We may want to offer them upfront payment options or give monetary incentives to a particular aspect of the business (run on ARM instances instead of X64, for example).Each time that we make such an offer, we are going to be turning around and (significantly) complicating the way we bill the customer. Let&#x2019;s talk about something as simple as committing to run an instance for a whole year. No upfront payment, just a commitment to pay for a particular server for a year. In AWS or Azure, that would be Reserved Instances, so you are likely very familiar with the idea.How is that going to be expressed in code? Probably something like this:function compute_charges(custId, start, end) {&#xA;    let total = 0;&#xA;    let predicate = instance =&gt; /*..redacted.*/;&#xA;   &#xA;    var hrsPerIns = {};&#xA;    for (let i of this.instances(predicate)) {&#xA;        let hours = i.hours_running(start, end);&#xA;        hrsPerIns[i.type] = hours &#x2B; (hrsPerIns[i.type] || 0);&#xA;        total &#x2B;= hours * i.price_per_hour;&#xA;    }&#xA;&#xA;&#xA;    for (let c of this.commitmentsFor(custId, start, end)) {&#xA;        let hours = c.committed_time(start, end);&#xA;        let hoursUsed = hrsPerIns[c.type] || 0;&#xA;        let unusedCommittedHours = Math.max(0, hours - hoursUsed);&#xA;        total &#x2B;= unusedCommittedHours *&#xA;                this.instance(c.type).price_per_hour;&#xA;    }&#xA; &#xA;    return total;&#xA;  }To be clear, the code above is not&#xA0;a good way to handle such a task, but it does show in a pretty succinct way the hidden complexities. In this case, if you didn&#x2019;t meet your commitment, we&#x2019;ll charge you for the unused commitment as well. A more complex system would have to account for discounted rates while using the committed values, for example. And in that case, the priority of applying such rates between different matching commitments. Other aspects may be giving the user a discount for a particular level of usage. So the first 100GB are priced differently from the rest, applying a free tier and&#x2026; you get the point, I think. It gets complex.Note that at this point, we aren&#x2019;t even talking about money yet, we are discussing computing the charges. The situation is more interesting when we move to the next stage. On the face of it, this seems pretty simple, all you need to do is charge the credit card, no?Okay, maybe you need to send an invoice, but that is about it, right?Well&#x2026; what happens if the customer made an upfront payment for one of those commitments? Or just accidentally paid twice last month and now has credit on your system. I&#x2019;m going to leave aside the whole complexity around payments bouncing&#xA0;(which is a whole other interesting topic) and how to deal with the actual charging. Right now I want to focus on the nature of money itself.Imagine you have a commitment with a customer for an 8-core / 64 GB VPS server for a whole year. And they paid upfront, getting a nice discount along the way. How would you record that in your system?The easiest is to create the notion of credit for the user, which you deduct whenever you need to charge them. So we&#x2019;ll first compute the charges, then deduct the existing credits, and debit the customer if anything remains. This is simple, easy to work with, and wrong.Remember that discount the user received? They paid for that particular VPS type, and if you now need to charge them for anything else (such as storage charges), that money cannot come from the funds paid for the VPS. In other words, the money the customer paid is not fungible. It isn&#x2019;t applicable for any charge, it is colored. It is dedicated to a particular purpose. And managing that&#xA0;turns out to be pretty complex. Mostly because we are trying to fit everything into the debits and credits on the account. A better model is to avoid using&#xA0;money, in the same way that if you mix inches and centimeters you&#x2019;ll eventually end up in a bad place on Mars. The solution is to treat each individual charge as its own &#x201C;currency&#x201D;.In other words, when computing the charges, we aren&#x2019;t trying to find the cost of running a particular instance for the billing period. We are trying to find how many &#x201C;cost units&#x201D; we have for that time period.Instead of getting a single number that we&#x2019;ll charge the customer, we&#x2019;ll obtain a detailed set of the changes in question. Not as money, but as cost units. Think about those in a similar way to currency. &#xA0;Note that all the units are multiples of 730 hours (number of hours per month, on average).compute_charges(custId, start, end) =&gt; {&#xA;    custId: &#x27;customers/3291-B&#x27;,&#xA;    start: &#x27;2024-01-01&#x27;, end: &#x27;2024-01-31&#x27;,&#xA;    costs: [&#xA;      {type: &#x27;8Cores-64GB-hours&#x27;,  qty: 2190},&#xA;      {type: &#x27;4Cores-32GB-hours&#x27;,  qty:  730},&#xA;      {type: &#x27;disk-5000-iops&#x27;,     qty: 2920},&#xA;    ],&#xA;}The next step after that is to get your allocated budget for the same billing period, which will look something like this:compute_budget(custId, start, end) =&gt; {&#xA;    custId: &#x27;customers/3291-B&#x27;,&#xA;    start: &#x27;2024-01-01&#x27;, end: &#x27;2024-01-31&#x27;,&#xA;    commitments: [&#xA;      {type: &#x27;8Cores-64GB-hours&#x27;,  qty: 2190},&#xA;      {type: &#x27;4Cores-32GB-hours&#x27;,  qty: 1460},&#xA;      {type: &#x27;disk-5000-iops&#x27;,     qty: 730},&#xA;    ],&#xA;}In other words, just as we compute the charges based on the actual usage for that billing period, we apply the same approach on the commitments we have. The next stage is to just add all of those together. In this case, we&#x2019;ll end up with the following:8Cores-64GB-hours &#x21D2; 0 (we used as much as we committed to)4Cores-32GB-hours &#x21D2; -730 (we committed to more than we used)Disk-5000-iops &#x21D2; 2190 (remaining use after applying commitment, priced as you go)We aren&#x2019;t done yet, after commitments, there are other plans that we may need to run. For example, we&#x2019;ll provide you with some global discounts for VM rental (which doesn&#x2019;t apply to disks, however). Working at the level of cost units (or colors, or currency, whatever term you like) allows us to apply those things in a very fine-grained manner. More importantly, the end result and all its intermediate steps are very clear. That is quite important when you look at a six-figure bill with hundreds of line items and you want to see whether the billing matches your contract or not. As you can imagine, given the inherent complexity of the system, being able to clearly &#x201C;show your work&#x201D; is quite important. Especially when there is a misunderstanding or questions are being raised (and there will be).What we have done now is compute the actual charges based on their type, but we need to convert that to real money. There are several steps along this process:We need to charge all the active commitments. Those may have been pre-paid (in which case there is no current charge), but they may have a (fixed) monthly cost that we need to add to the current invoice.We need to perform a &#x201C;currency conversion&#x201D; between the units we have and actual money. In the example above, we have a negative number of units (for 4Cores-32GB-hours), as we committed to more hours than we actually used. We are still being charged for this by applying the rate from the commitment. On the other hand, when we examine the disk costs, we used more than we committed to. Here we need to make a decision about what price we&#x2019;ll charge the user. It can be the commitment price or the pay-as-you-go price. So even for the same currency&#xA0;we may have different rules. After all of this is done, we are now left with a final number. The actual amount of money that we need to charge the customer. This is the point at which we check if the customer has any credit already paid in the system or if we need to make an actual charge. That aspect is complicated by whether you are charging a credit card (same for any other automatic billing option) or issuing an invoice to be paid manually. For a manual invoice, you now have a whole other&#xA0;process. For example, you may offer discounts for the customer if they pay within 14 days versus the usual 30, or charge a fee for paying within 60 days, etc. I&#x2019;m not touching on collections or what to do when you fail to charge the customer. It is shockingly&#xA0;common to encounter payment failures. To the point where we never had a single payment run that didn&#x2019;t include at least several such cases. The reasons range from deal size too big to (temporary) lack of funds to suspicious-seeming activity. You need to be able to handle that as well. But those are topics for another post. In this post, my aim was to discuss just the issue of the complexity of money in the cloud business. I find the model of treating the charges as separate &#x201C;currencies&#x201D; to be a nice one overall, but I would love to hear about other people&#x2019;s experiences in this matter.</p>
        </article>
        <article id="article-457">
            <a href="https://www.meziantou.net/how-to-get-assembly-code-generated-by-the-jit-for-a-csharp-method.htm" target="_blank">
                <h2 class="title mb-6" id="article-457">How to get assembly code generated by the JIT for a C# method</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 22, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When you execute a .NET method, the JIT compiles the method to native code. This native code is then executed by the CPU. In this post, I describe how you can inspect the generated assembly code.&#xA0;Table Of ContentsUsing the DOTNET_JitDisasm environment variableUsing DisasmoUsing Sharplab#Using the D</p>
        </article>
        <article id="article-458">
            <a href="https://ayende.com/blog/200577-B/code-review-time-travel" target="_blank">
                <h2 class="title mb-6" id="article-458">Code review &amp; Time Travel</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 19, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A not insignificant part of my job is to go over code. Today I want to discuss how we approach code reviews at RavenDB, not from a process perspective but from an operational one. I have been a developer for nearly 25 years now, and I&#x2019;ve come to realize&#xA0;that when I&#x2019;m doing a code review I&#x2019;m actually looking at the code from three separate perspectives.The first, and most obvious one, is when I&#x2019;m actually looking for problems in the code - ensuring that I can understand what is going on, confirming the flow makes sense, etc. This involves looking at the code as it is right now. I&#x2019;m going to be showing snippets of code reviews here. You are not actually expected to follow the code, only the concepts that we talk about here.Here is a classic code review comment:There is some duplicated code that we need to manage. Another comment that I liked is this one, pointing out a potential optimization in the code:If we define the code using the static&#xA0;keyword, we&#x2019;ll avoid delegate allocation and save some memory, yay!It gets more interesting when the code is correct and proper, but may do something weird in some cases, such as in this one:I really love it when I run into those because they allow me to actually explore the problem thoroughly. Here is an even better example, this isn&#x2019;t about a problem in the code, but a discussion on its impact. RavenDB has been around for over 15 years, and being able to go back and look at those conversations in a decade or so is invaluable to understanding what is going on. It also ensures that we can share current knowledge a lot more easily.Speaking of long running-projects, take a look at the following comment:Here we need to provide some context to explain. The _caseInsensitive&#xA0;variable here is a concurrent dictionary, and the change is a pretty simple optimization to avoid the annoying KeyValuePair overload. Except&#x2026; this code is there intentionally, we use it to ensure that the removal operation will only succeed if both&#xA0;the key and the value match. There was an old bug that happened when we removed blindly and the end result was that an updated value was removed. In this case, we look at the code change from a historical perspective and realize that a modification would reintroduce old (bad) behavior. We added a comment to explain that in detail in the code (and there already was a test to catch it if this happens again). By far, the most important and critical part of doing code reviews, in my opinion, is not focusing on what is&#xA0;or what was, but on what will be. In other words, when I&#x2019;m looking at a piece of code, I&#x2019;m considering not only what it is doing right now, but also what we&#x2019;ll be doing with it in the future. Here is a simple example of what I mean, showing a change to a perfectly fine piece of code:The problem is that the if statement will call InitializeCmd(), but we previously called it using a different condition. We are essentially testing for the same thing using two different methods, and while currently we end up with the same situation, in the future we need to be aware that this may change. I believe one of the major shifts in my thinking about code reviews came about because I mostly work on RavenDB, and we have kept the project running over a long period of time. Focusing on making sure that we have a sustainable and maintainable code base over the long haul is important. Especially because you need to experience those benefits over time to really appreciate looking at codebase changes from a historical perspective.</p>
        </article>
        <article id="article-459">
            <a href="https://ayende.com/blog/200545-B/ravendb-hackaton-at-devweek" target="_blank">
                <h2 class="title mb-6" id="article-459">RavenDB Hackaton at DevWeek</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 18, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB will be participating in the DevWeek hackathon&#xA0;in February. The hackathon is now live, and we are offering prizes worth 4,000 USD for the top two winners. The hackathon is open to both attendees of the DevWeek conference and the general public. The challenge we put forth is building a sharing platform in a community. I&#x2019;m excited to see what kind of solutions will be submitted.I will also be personally attending the DevWeek conference and would be very happy to meet you in person. Happy hacking!</p>
        </article>
        <article id="article-460">
            <a href="https://ayende.com/blog/200521-B/meta-blog-blogging-ergonomics-in-2024" target="_blank">
                <h2 class="title mb-6" id="article-460">Meta Blog</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 17, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x27;ve been writing this blog since 2004. That means I have been doing this for twenty years, which is frankly unbelievable to me. The actual date is sometime in April, so I&#x2019;ll probably do a summary post then about that. What I want to talk about today is a different aspect. The mechanism and processes I use to write blog posts. A large part of the reason I write blog posts is that it helps me understand and organize my own thoughts. And in order to do that effectively, I have found that I need very little friction in the blogging process. About a decade ago, Google Reader was shut down, and I&#x2019;m still very&#xA0;bitter about that. It effectively killed a significant portion of the blogging audience&#xA0;and made the ergonomics of reading blogs a lot harder. That also led people to use walled gardens to communicate with others, instead of the decentralized network and feed aggregators. A side effect of that decision is that blogging tools have stopped being a viable thing people spend time or money on.At the time, I was using Windows Live Writer, which was a high-quality editor and had a rich plugin system. Microsoft discontinued it at some point, it became an open-source project, and even that died. The website is no longer functional and even in terms of the GitHub project, the last commit was 5 years ago.I&#x2019;m still using Open Live Writer to write the majority of my blog posts, but given there are no longer any plugins, even something as simple as embedding code in my posts has become an&#x2026; annoyance. That kills the ergonomics of blogging for me.Not a problem, this is Open Source, and I can do that myself. Except&#x2026; I really don&#x2019;t have the time to spend on something ancillary like that. I would happily pay (a reasonable amount) for a blogging client, but I&#x2019;m going to assume that I&#x2019;m not part of a large enough group that there is a market for this. Taking the code snippets example, I can go into the code, figure out what is going on there, and add a &#x201C;code snippet&#x201D; feature. I estimate that would take several days. Alternatively, I can place the code as a GitHub gist and embed it in the page. It is annoying, but far quicker than going to the trouble of figuring that out. Another issue that bugs me (pun intended) is a problem with copy/paste of images, where taking screenshots using the Snipping Tool doesn&#x2019;t paste into Writer. I need to first paste them into Paint, then into Writer. In this case, I assume that Writer doesn&#x2019;t recognize the clipboard format or something similar. &#xA0;Finally, it turns out that I&#x2019;m not writing blog posts in the same manner as I used to. It got to the point where I asked people to review my posts before making them public. It turns out that no matter how many times it is corrected, my brain seems unable to discern when to write &#x201C;whether&#x201D; or &#x201C;whatever&#x201D;, for example. At this point I gave up updating that&#xA0;piece of software &#x1F642;. Even the use of emojis doesn&#x2019;t work properly (Open Live Writer mostly predates a lot of them and breaks the HTML in a weird fashion &#x1F937;).In other words, there are several problems in my current workflow, and it has finally reached the point where I need to do something about it. The last requirement, by the way, is the most onerous. Consider the workflow of getting the following fixes to a blog post:and we run =&gt; and we ranwe spend =&gt; we spentWhere is my collaborating editing and the ability to suggest changes with good UX? Improving the ergonomics for the blog has just expanded in scope massively. Now it is a full-fledged publishing platform with modern sensibilities. It&#x2019;s 2024, features like proper spelling and grammar corrections should absolutely be there, no? And what about AI integration? It turns out that predicting text makes the writing process more efficient. Here is what this may look like:At this stage, this isn&#x2019;t just a few minor fixes. I should mention that for the past decade and a half or so, I stopped considering myself as someone who can do UI in any meaningful manner. I find that the &lt;table/&gt; tag, which used to be my old reliable method, is not recommended now, for some reason.This&#x2026; kind of sucks. I want to upgrade my process by a couple of decades, but I don&#x2019;t want to pay the price for that. If only there was an easier way to do that.I started using Google Docs to edit my blog posts, then pasting them into Live Writer or directly to the blog (using a Rich Text Box with an editor from&#x2026; a decade ago). I had to check the source code for this, by the way. The entire experience is decidedly Developer UX. Then I had a thought, I already have a pretty good process of writing the blog posts in Google Docs, right? It handles rich text editing and management much better than the editor in the blog. There are also options for things like proper workflows. For example, someone can go over my drafts and make comments or suggestions.The only thing that I need is to put both of those together. I have to admit that I spent quite some time just trying to figure out how to get&#xA0;the document from Google Docs using code. The authentication hurdles are&#x2026; significant to someone who isn&#x2019;t aware of how it all plugs together. Once I got that done, I got my publishing platform with modern features. Here is what the end result looks like:public class PublishingPlatform&#xA;{&#xA;  private readonly DocsService GoogleDocs;&#xA;  private readonly DriveService GoogleDrive;&#xA;  private readonly Client _blogClient;&#xA;&#xA;&#xA;  public PublishingPlatform(string googleConfigPath, string blogUser, string blogPassword)&#xA;  {&#xA;    var blogInfo = new MetaWeblogClient.BlogConnectionInfo(&#xA;     &quot;https://ayende.com/blog&quot;,&#xA;     &quot;https://ayende.com/blog/Services/MetaWeblogAPI.ashx&quot;,&#xA;     &quot;ayende.com&quot;, blogUser, blogPassword);&#xA;    _blogClient = new MetaWeblogClient.Client(blogInfo);&#xA;&#xA;&#xA;    var initializer = new BaseClientService.Initializer&#xA;    {&#xA;      HttpClientInitializer = GoogleWebAuthorizationBroker.AuthorizeAsync(&#xA;          GoogleClientSecrets.FromFile(googleConfigPath).Secrets,&#xA;          new[] { DocsService.Scope.Documents, DriveService.Scope.DriveReadonly },&#xA;          &quot;user&quot;, CancellationToken.None,&#xA;          new FileDataStore(&quot;blog.ayende.com&quot;)&#xA;      ).Result&#xA;    };&#xA;&#xA;&#xA;    GoogleDocs = new DocsService(initializer);&#xA;    GoogleDrive = new DriveService(initializer);&#xA;  }&#xA;&#xA;&#xA;  public void Publish(string documentId)&#xA;  {&#xA;    using var file = GoogleDrive.Files.Export(documentId, &quot;application/zip&quot;).ExecuteAsStream();&#xA;    var zip = new ZipArchive(file, ZipArchiveMode.Read);&#xA;&#xA;&#xA;    var doc = GoogleDocs.Documents.Get(documentId).Execute();&#xA;    var title = doc.Title;&#xA;&#xA;&#xA;    var htmlFile = zip.Entries.First(e =&gt; Path.GetExtension(e.Name).ToLower() == &quot;.html&quot;);&#xA;    using var stream = htmlFile.Open();&#xA;    var htmlDoc = new HtmlDocument();&#xA;    htmlDoc.Load(stream);&#xA;    var body = htmlDoc.DocumentNode.SelectSingleNode(&quot;//body&quot;);&#xA;&#xA;&#xA;    var (postId, tags) = ReadPostIdAndTags(body);&#xA;&#xA;&#xA;    UpdateLinks(body);&#xA;    StripCodeHeader(body);&#xA;    UploadImages(zip, body, GenerateSlug(title));&#xA;&#xA;&#xA;    string post = GetPostContents(htmlDoc, body);&#xA;&#xA;&#xA;    if (postId != null)&#xA;    {&#xA;      _blogClient.EditPost(postId, title, post, tags, true);&#xA;      return;&#xA;    }&#xA;&#xA;&#xA;    postId = _blogClient.NewPost(title, post, tags, true, null);&#xA;&#xA;&#xA;    var update = new BatchUpdateDocumentRequest();&#xA;    update.Requests = [new Request&#xA;    {&#xA;      InsertText = new InsertTextRequest&#xA;      {&#xA;        Text = $&quot;PostId: {postId}\r\n&quot;,&#xA;        Location = new Location&#xA;        {&#xA;          Index = 1,&#xA;        }&#xA;      },&#xA;    }];&#xA;&#xA;&#xA;    GoogleDocs.Documents.BatchUpdate(update, documentId).Execute();&#xA;  }&#xA;&#xA;&#xA;  private void StripCodeHeader(HtmlNode body)&#xA;  {&#xA;    foreach(var remove in body.SelectNodes(&quot;//span[text()=&#x27;&amp;#60419;&#x27;]&quot;).ToArray())&#xA;    {&#xA;      remove.Remove();&#xA;    }&#xA;    foreach (var remove in body.SelectNodes(&quot;//span[text()=&#x27;&amp;#60418;&#x27;]&quot;).ToArray())&#xA;    {&#xA;      remove.Remove();&#xA;    }&#xA;  }&#xA;&#xA;&#xA;  private static string GetPostContents(HtmlDocument htmlDoc, HtmlNode body)&#xA;  {&#xA;    // we use the @scope element to ensure that the document style doesn&#x27;t &quot;leak&quot; outside&#xA;    var style = htmlDoc.DocumentNode.SelectSingleNode(&quot;//head/style[@type=&#x27;text/css&#x27;]&quot;).InnerText;&#xA;    var post = &quot;&lt;style&gt;@scope {&quot; &#x2B; style &#x2B; &quot;}&lt;/style&gt; &quot; &#x2B; body.InnerHtml;&#xA;    return post;&#xA;  }&#xA;&#xA;&#xA;  private static void UpdateLinks(HtmlNode body)&#xA;  {&#xA;    // Google Docs put a redirect like: https://www.google.com/url?q=ACTUAL_URL&#xA;    foreach (var link in body.SelectNodes(&quot;//a[@href]&quot;).ToArray())&#xA;    {&#xA;      var href = new Uri(link.Attributes[&quot;href&quot;].Value);&#xA;      var url = HttpUtility.ParseQueryString(href.Query)[&quot;q&quot;];&#xA;      if (url != null)&#xA;      {&#xA;        link.Attributes[&quot;href&quot;].Value = url;&#xA;      }&#xA;    }&#xA;  }&#xA;&#xA;&#xA;  private static (string? postId, List&lt;string&gt; tags) ReadPostIdAndTags(HtmlNode body)&#xA;  {&#xA;    string? postId = null;&#xA;    var tags = new List&lt;string&gt;();&#xA;    foreach (var span in body.SelectNodes(&quot;//span&quot;))&#xA;    {&#xA;      var text = span.InnerText.Trim();&#xA;      const string TagsPrefix = &quot;Tags:&quot;;&#xA;      const string PostIdPrefix = &quot;PostId:&quot;;&#xA;      if (text.StartsWith(TagsPrefix, StringComparison.OrdinalIgnoreCase))&#xA;      {&#xA;        tags.AddRange(text.Substring(TagsPrefix.Length).Split(&quot;,&quot;));&#xA;        RemoveElement(span);&#xA;      }&#xA;      else if (text.StartsWith(PostIdPrefix, StringComparison.OrdinalIgnoreCase))&#xA;      {&#xA;        postId = text.Substring(PostIdPrefix.Length).Trim();&#xA;        RemoveElement(span);&#xA;      }&#xA;    }&#xA;    // after we removed post id &amp; tags, trim the empty lines&#xA;    while (body.FirstChild.InnerText.Trim() is &quot;&amp;nbsp;&quot; or &quot;&quot;)&#xA;    {&#xA;      body.RemoveChild(body.FirstChild);&#xA;    }&#xA;    return (postId, tags);&#xA;  }&#xA;&#xA;&#xA;  private static void RemoveElement(HtmlNode element)&#xA;  {&#xA;    do&#xA;    {&#xA;      var parent = element.ParentNode;&#xA;      parent.RemoveChild(element);&#xA;      element = parent;&#xA;    } while (element?.ChildNodes?.Count == 0);&#xA;  }&#xA;&#xA;&#xA;  private void UploadImages(ZipArchive zip, HtmlNode body, string slug)&#xA;  {&#xA;    var mapping = new Dictionary&lt;string, string&gt;();&#xA;    foreach (var image in zip.Entries.Where(x =&gt; Path.GetDirectoryName(x.FullName) == &quot;images&quot;))&#xA;    {&#xA;      var type = Path.GetExtension(image.Name).ToLower() switch&#xA;      {&#xA;        &quot;.png&quot; =&gt; &quot;image/png&quot;,&#xA;        &quot;.jpg&quot; or &quot;jpeg&quot; =&gt; &quot;image/jpg&quot;,&#xA;        _ =&gt; &quot;application/octet-stream&quot;&#xA;      };&#xA;      using var contents = image.Open();&#xA;      var ms = new MemoryStream();&#xA;      contents.CopyTo(ms);&#xA;      var bytes = ms.ToArray();&#xA;      var result = _blogClient.NewMediaObject(slug &#x2B; &quot;/&quot; &#x2B; Path.GetFileName(image.Name), type, bytes);&#xA;      mapping[image.FullName] = new UriBuilder { Path = result.URL }.Uri.AbsolutePath;&#xA;    }&#xA;    foreach (var img in body.SelectNodes(&quot;//img[@src]&quot;).ToArray())&#xA;    {&#xA;      if (mapping.TryGetValue(img.Attributes[&quot;src&quot;].Value, out var path))&#xA;      {&#xA;        img.Attributes[&quot;src&quot;].Value = path;&#xA;      }&#xA;    }&#xA;  }&#xA;&#xA;&#xA;  private static string GenerateSlug(string title)&#xA;  {&#xA;    var slug = title.Replace(&quot; &quot;, &quot;&quot;);&#xA;    foreach (var ch in Path.GetInvalidFileNameChars())&#xA;    {&#xA;      slug = slug.Replace(ch, &#x27;-&#x27;);&#xA;    }&#xA;&#xA;&#xA;    return slug;&#xA;  }&#xA;}You&#x2019;ll probably not appreciate this, but the fact that I can just push code like that into the document and get it with proper formatting easily is a major lifestyle improvement from my point of view. The code works with the document in two ways. First, in the Document DOM (which is quite complex), it extracts the title of the blog post and afterward updates it with the document ID. But the core of this code is to extract the document as a zip file, grab everything from there, and push that to the blog. I do some editing for the HTML to get everything set up properly, mostly editing the links and uploading the images. There is also some stuff happening with CSS scopes that I frankly don&#x2019;t understand. I think&#xA0;I got it right, which is fine for now.This cost me a couple of evenings, and it was fun. Nothing earth-shattering, I&#x2019;ll admit. But it&#x2019;s the first time in a while that I actually wrote a piece of code that was immediately useful. My blogging queue is rather full, and I hope that with this new process it will be easier to push the ideas out of my head and to the blog.And with that, it is now 01:26 AM, and I&#x2019;m going to call it a night &#x1F642;.And as a final thought, I had just made several changes to the post after publication, and it went smoothly. I think that I like it.</p>
        </article>
        <div class="button flex justify-between">
            <a href="45.html"><span class="back arrow"></span></a>

            <a href="47.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>