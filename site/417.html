
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 417 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4161">
            <a href="https://ayende.com/blog/162977/worlds-smallest-no-sql-database-persistent-data" target="_blank">
                <h2 class="title mb-6" id="article-4161">World&#x2019;s smallest No SQL Database: Persistent data</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 16, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The second item to go over with the World&#x2019;s smallest No SQL database is about persistence, and following that, I/O. Right now, there is no persistence. If you restart the process, all the data is gone. Now, there are actually quite a few real world dbs that behave in this fashion. But they are a rarity. For the most part, if I put data inside a db, I expect it to be there until I do something about it. And at that point, you are in for quite a bit of complexity. How are you going to persist the data? The easiest way to do it, just create a file per every value in the db is going to be&#x2026; problematic on most systems. So you need to put a lot of data in a small set of files. Which means that you have to decide how you are going to put the data together. In general, there is either the fixed size option, in which you divide the file(s) into pages and work around that. The good thing about this is that this gives you the ability to reuse space in the file after deletes / updates. The bad thing about that is that it is quite complex. Alternatively, you can just write the data out as needed, but then you can&#x2019;t really update written data, and would need to run compactions. And we haven&#x2019;t talked about searching yet. Some DBs, like Bitcask / Munin, would actually store the keys in memory, and store the position on the disk for retrieving the value. But for the most part, both keys &amp; values tend to be on disk in some form. In CouchDB, they are held inside an append only B&#x2B;Tree. In LevelDB, they are held in Sorted String Tables. LMDB uses Copy-On-Write B&#x2B;Tree. Esent use a B&#x2B;Tree with a Log file.  In each of those cases, the actual semantics for persistent data involve at least two concerns. You need to actually be able to search the data (that usually mean more than just O(1) access, you want to be able to go back &amp; forth on the keys) and you need to be able to do a transactional save. This is so you can recover&#xA0; in case of a crash, most of the time. But there are actually a lot more that goes into the selection of the proper persistence format. To start with, how you store the data on disk will have a big effect on your performance. If you store the data as a linked list, for example, you might as well kiss your performance goodbye. Beyond that, we also have issues with things like how is the format going to scale when we have concurrent readers. For example, if you have something that does a lot of seeks, and rely on the seeks always going forward to ensure performance, that is going to be very badly hit the moment that you have concurrent readers doing concurrent reads on different parts of the system. You would be forcing the system to do random seeks.  There are other considerations, as well. For example, if you are using something like B&#x2B;Tree, it is likely that you&#x2019;ll be overwriting the same section on the disk multiple times. That is fine with HDD, but SSD would just give up &amp; die on you at some point. And we haven&#x2019;t started talking about secondary indexes yet&#x2026;</p>
        </article>
        <article id="article-4162">
            <a href="https://ayende.com/blog/162945/b-trees-and-why-i-love-them-part-i" target="_blank">
                <h2 class="title mb-6" id="article-4162">B&#x2B;Trees and why I love them, part I</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 15, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that I enjoy about learning new things is the way it changes the way I look at the stuff that I already knows. Reading the LMDB codebase, and implementing a persistent B&#x2B;Tree has given me a new depth of understanding about how relational databases (and Esent, too), work. I am going to go back to level zero and assume that you have never heard about this. You probably know what a binary search tree is. And you know how they work. Here is such a tree:  Most tree algorithms spend a lot of time ensuring that the trees are balanced, because their most important property, O(log N) search performance, require that.&#xA0; Binary search trees seems ideally suitable for building databases ,since they allow speedy lookups and backward &amp; forward iteration through the data. Unfortunately, they suffer from a pretty crippling limitation. They have absolutely horrible performance when used in persistent medium. Let us assume that I have a file that contains the following information (Key, Left offset, Right offset). I could search through that file by just walking the links. That, however, would result quite terrible performance. Every time that we move between nodes, we have to do a seek, and that would kill any benefits we will gain from using binary search tree. Instead, we have a data structure that is aimed at reducing those costs. B&#x2B;Tree. On the face of it, B&#x2B;Tree is a truly stupidly simple idea. Instead of having just 2 items in the tree, left &amp; right, let us have more. Now, since B&#x2B;Trees are usually used in persistent format, we start out by defining pages. That is because if we want to do random I/O, we have to be able to write in pages to the file. Therefor, we usually talk about B&#x2B;Trees in terms of pages. Here is the above tree, rendered as a B&#x2B;Tree:  Since the data is small, it all fits into a single page. That means that you can read the entire page into memory, and then do a binary search on the data page cheaply. The page above uses a page size of 4,096, so it can contain about 200 entries (of the size we just put in, which are very small). What happens when we have more than that? We Split the page. The resulting data now looks like this (256 entries):  Now, if we want to do a search for key 152, we start by reading the root node, we can see that the page containing values greater than 102 is page 1, so we will go there. We read that, and do a binary search on the data to find our value. So that was two seeks to get the data. Instead of eight. And usually, the high level pages are already cached, so we would only need a single seek.&#xA0;  Let us see what happens when we put even more data in (512):  As you can see, we doubled the amount of information we store, but we remain at the same height. That is quite important, in order to get good performance from&#xA0; the disk. The usual fan out is about a 100, depending on your page size and the keys you selected. I played with the settings a a bit so you can get a good idea about what this look like when you have some more depth, I wrote the following code:     1: for (int i = 0; i &lt; 32; i&#x2B;&#x2B;)   2: {   3:     ms.Position = 0;   4:     for (int j = 0; j &lt; 32; j&#x2B;&#x2B;)   5:     {   6:         env.Root.Add(tx, string.Format(&quot;{0,5}&quot;, i&#x2B;j), ms);   7:     }   8: }&#xA;Which resulted in the following tree:&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;So far, so good, but this is actually the best case scenario. This is what happens when we are inserting data in a sequential manner. Let us mix things up a bit, okay? &#xA;&#xA;   1: for (int i = 0; i &lt; 16; i&#x2B;&#x2B;)   2: {   3:     ms.Position = 0;   4:     for (int j = 0; j &lt; 4; j&#x2B;&#x2B;)   5:     {   6:         env.Root.Add(tx, string.Format(&quot;{1,5}-{0,5}&quot;, i, j), ms);   7:     }   8: }&#xA;This code will generate values in effectively a random fashion, and you can see the impact it has on the tree:&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;What happens is that we have had to insert data in a lot of places, which resulted in a lot of page splits, which increase the depth of the tree. Deeper trees means more operations required to actually get to the data on the leaf nodes. And yes, if you have a flash back to &#x201C;always use sequential ids&#x201D; section in RDMBS class, this is the reason why. &#xA;Now, I think that this is enough for now, I&#x2019;ll do some more talking about the subject in my next post.</p>
        </article>
        <article id="article-4163">
            <a href="https://ayende.com/blog/162916/vorons-implementation-managed-memory-mapped-database-getting-to-c-memory-model" target="_blank">
                <h2 class="title mb-6" id="article-4163">Voron&#x2019;s implementation: Managed memory mapped database&#x2013;getting to C memory model</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 14, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my previous post I started to talk about the architecture of Naver. But this is actually still too early to tell, since before anything else, I want to create the low level interface for working with pages. And even before that, I had to decide how to actually represent a page in C#. In LMDB, this is easy because you can just access the memory using a pointer, and work with memory in this fashion is really natural in C. But in C#, that is much harder. It took me some trial and error, but I realize that I was trying to write C code in C#, and that isn&#x2019;t going to work. Instead, I have to write native C#, which is similar, but different. In C, I can just pass around a pointer, and start doing evil things to it at will. In C#, there are a lot of road blocks along the way that prevent you from doing that.&#xA;&#xA;&#x9;So I ended up with this:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   1: [StructLayout(LayoutKind.Explicit, Pack = 1)]&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   2: public struct PageHeader&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   3: {&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   4:     [FieldOffset(0)]&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   5:     public int PageNumber;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   6:     [FieldOffset(4)]&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   7:     public PageFlags Flags;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   8:&#xA0; &#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   9:     [FieldOffset(5)]&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  10:     public ushort Lower;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  11:     [FieldOffset(7)]&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  12:     public ushort Upper;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  13:&#xA0; &#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  14:     [FieldOffset(5)]&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  15:     public int NumberOfPages;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  16: }&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;This is the memory layout that I want. But, there is not way in C# to say, allocate this struct at this location. Luckily, I found a workaround.&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   1: public unsafe class Page&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   2: {&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   3:     private readonly byte* _base;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   4:     private readonly PageHeader* _header;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   5:&#xA0; &#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   6:     public Page(byte* b)&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   7:     {&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   8:         _base = b;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   9:         _header = (PageHeader*)b;&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  10:     }&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  11:&#xA0; &#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;  12:     public int PageNumber { get { return _header-&gt;PageNumber; } set { _header-&gt;PageNumber = value; } }&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;What I can do, I can have a Page class that manage this for me. This means that I just give the class a pointer, and it can treat this either as a PageHeader* or as a byte array. This means that I also get to do cool tricks like having an array backed by memory directly in the code:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   1: public ushort* KeysOffsets&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   2: {&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   3:     get { return (ushort*)(_base &#x2B; Constants.PageHeaderSize); }&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;   4: }&#xA;&#x9;&#x9;&#x9;&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;The Page class have a lot of methods relating to managing the page itself, and it should abstract away all the pesky details of actually working with memory directly.&#xA;&#xA;&#x9;So, this isn&#x2019;t a really informative post, I fear. But it did take me a few hours to come up with the approach that I wanted. I kept trying to find ways to embed addresses inside the PageHeader, until I realized that I can just hold that externally. Note that all the important state about the Page is actually stored in memory outside the Page class, so that is shared globally, but you can have two Page instances that point to the same place. And that is where I decided to put local state. Things like where we are currently positioned in the page, for example.</p>
        </article>
        <article id="article-4164">
            <a href="https://ayende.com/blog/162913/architecture-design-guidance-make-the-machine-do-your-work-for-you" target="_blank">
                <h2 class="title mb-6" id="article-4164">Architecture &amp; Design Guidance, make the machine do your work for you</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 13, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I am currently playing around with persistent B&#x2B;Trees. This is done using memory mapped files and pointer arithmetic in C#. I consider this a non trivial exercise,&#xA0; and certainly quite outside of my usual haunts. Obviously, as you can imagine, there are bugs. Those can be really pretty hard to figure out, because they can arise from any number of issues (usually it is me, but still&#x2026;). After fighting for a few hours with a set of bus that just wouldn&#x2019;t let me be, I decided that I had enough of that and set out to design the debug hooks I need to actually figure it out. Because I am dealing with pointers, I couldn&#x2019;t just use the normal methods that I would use when debugging C# code. To top that, I think that most of you would agree that explaining a data structure (any data structure) without a whiteboard is nigh impossible. In the same manner, trying to figure out a bug in a B&#x2B;Tree by following the member references was too hard. I wanted to actually visualize that. I could throw it into a TreeView in a few minutes, but I wanted to take the time and do it right. I have a feeling that this is going to be useful for the future as well, so I learned how to use Graphviz&#x2019;s dot language and wrote the code to dump the structure of the B&#x2B;Tree into a properly formatted dot file, after which I could ask dot.exe to turn that into an image. The piece of code that I was having trouble with was the page split function. Here is the before snapshot, note that we have nearly run out of room in this page.  And here is the output of the after snapshot. As you can see, this really make no sense at all. We have a page split, but it all went into the same page?       What actually happened is that I had a bug where I wired both the left and right pages in the split to the original page. Once that was fixed (and one I actually saw the data, it was very easy to see what is wrong). It was a matter of changing a single parameter. After the fix, I could visually see that everything was fine.  Leaving aside the details about the actual bug &amp; fix. The lesson that I wish to impart today is that building those sort of capabilities into your systems is important. Now that I have this ability, I fully expect to be starting to using that when I need to debug the next issue. In fact, I run into the next issue quite quickly. After inserting quite a lot of data, I messed up the pointers and returned what looked very much like corrupted data. It was pretty hard to isolate, as usual with pointer issues, since the actual error occurred at some point during the process, I wasn&#x2019;t really clear on where and how to figure it out. I ended up just dumping the tree content to a file after every operation, and then checking the operations until I found the one where we start to have corruption. That allowed me to figure out that the corruption began at step 98 iteration #4.   As it turned out, that was pretty hard to figure out, because I didn&#x2019;t realize that when I was splitting the page, I needed to compact the data on the original page. Too much thinking in List&lt;T&gt; and not enough thinking about the layout of the problem in memory.</p>
        </article>
        <article id="article-4165">
            <a href="https://ayende.com/blog/163458/hello-voron" target="_blank">
                <h2 class="title mb-6" id="article-4165">Hello Voron</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 12, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">What is Voron? Well, it is a joke, but I&#x2019;ll leave it for someone else to explain.&#xA;&#xA;&#x9;Voron is the codename for our next generation storage engine, it is a managed port of LMDB, with some tweaks that we added on. The basic idea is that we will have our own storage solution based on our own code that we fully control.&#xA0;&#xA;&#xA;&#x9;Voron is different than LMDB in a few details, mostly:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;Only single process (multiple process can read, but only one process can write, and we don&#x2019;t really care about multi process reads).&#xA;&#x9;&#xA;&#x9;&#x9;No duplicates (LMDB allows them, we have no need for them yet, so we didn&#x2019;t do that).&#xA;&#x9;&#xA;&#x9;&#x9;Support for increasing the file size (LMDB doesn&#x2019;t support it, but we need to, so we added support for it).&#xA;&#x9;&#xA;&#x9;&#x9;Pure mmap access to the data (we don&#x2019;t do manual I/O writes).&#xA;&#xA;&#xA;&#x9;Early testing shows that for read speeds, we really couldn&#x2019;t ask for anything else. For write speed, we are good, but aren&#x2019;t as good as we would like it to be.&#xA0;&#xA;&#xA;&#x9;Personally, I think that the codebase is a lot easier to follow, but I wrote it, so&#x2026; It isn&#x2019;t ready yet for public consumption, but I would like to share it with a few people. So here is the deal.&#xA;&#xA;&#x9;I am looking for people to join the alpha program for it. Like with RavenDB at its early stage, I am looking for commitment to do something for the project. It can be anything from testing it out and submitting failing scenarios to actually working on the code to building small scale proofs on it, etc.&#xA;&#xA;&#x9;What I am not interested is viewers. There will be time enough for that at a later point in time. What I am looking for right now is contributors. And I think that this is a really cool project to be a part of. If you want to join, please ping via email.</p>
        </article>
        <article id="article-4166">
            <a href="https://ayende.com/blog/162914/the-design-of-managed-memory-map-database" target="_blank">
                <h2 class="title mb-6" id="article-4166">The design of managed memory map database</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 12, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Since MMMD appears to be an airport in Mexico, I think that I&#x2019;ll call this project Nevar Voron. It seems&#x2026; appropriate, somehow.&#xA;&#xA;&#x9;I don&#x2019;t learn by just reading code, I really need to do some writing to actually understand the concepts. In order to do that, I decided to try to create a managed implementation based on the ideas from LMDB. Note that I explicitly don&#x2019;t try to do a port, I am trying to do something different, but based on the concepts that I learned from reading the code.&#xA;&#xA;&#x9;Goals:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;Single process only &#x2013; I have no need to do something that can be used by multiple processes.&#xA;&#x9;&#xA;&#x9;&#x9;No predefined file size &#x2013; The reason LMDB does this is that it maps the entire file as a single continuous range. But there isn&#x2019;t really any reason why you can grow the file and map the extra space in a different location.&#xA;&#x9;&#xA;&#x9;&#x9;Multiple trees (&#x201C;tables&#x201D;) &#x2013; So we don&#x2019;t have just a single B-Tree, we can have more than one. I won&#x2019;t have a main DB exposed outside.&#xA;&#x9;&#xA;&#x9;&#x9;ACID, Transactional, MVCC with single writer&#xA;&#x9;&#xA;&#x9;&#x9;No File I/O &#x2013; In LMDB, the code allows either standard file I/O or direct memory writes. The later is dangerous if you are using C, because you can overwrite and corrupt data, but in .NET, that isn&#x2019;t an issue, since we don&#x2019;t do direct memory access.&#xA;&#x9;&#xA;&#x9;&#x9;No duplicates &#x2013; It really complicates the LMDB codebase, and I don&#x2019;t think it is really needed.&#xA;&#xA;&#xA;&#x9;Overall architecture:&#xA;&#xA;&#x9;One of the reasons I explicitly not trying to do a port is that I still don&#x2019;t like the LMDB codebase. I think that it require a major refactoring, and the way it works is not really suitable for a managed implementation. The first major component is going to be the B-Tree. This is responsible for reading &amp; writing data from a memory mapped file region. But it is focused only on that. Things like transactions, page allocations, free pages, concurrency and anything else is the responsibility of others. This is important because B-Tree is going to be useful for a lot of stuff. In LMDB, the B&#x2B;Tree is used to maintain the free list, the main db, sub databases, etc. For that matter, just having a persistent B&#x2B;Tree is going to be very useful in general.&#xA;&#xA;&#x9;After going away and playing with the code for a while, I can tell you that you need the following just to get started:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;Page &#x2013; represent a page in memory, of course. A page is a sorted list of items, where item can be a value or a reference to another page.&#xA;&#x9;&#xA;&#x9;&#x9;Tree &#x2013; the actual tree implementation, responsible for such things as maintaining the tree, reads &amp; searches. The only outside dependency it has is on Transaction, and that is only when it needs to allocate a pages.&#xA;&#x9;&#xA;&#x9;&#x9;Transaction &#x2013; manages transactions, either read only or write. Handles page allocations. This one isn&#x2019;t even started, because I want to see how far I can take the tree code before I need to actually complete it.&#xA;&#xA;&#xA;&#x9;The basic idea is, I really like the ideas that LMDB uses, I just don&#x2019;t like the codebase. So I want to see if I can do the same thing with a codebase that would be easier for me to work with.&#xA;&#xA;&#x9;And, of course, this is a cool project and quite interesting one.</p>
        </article>
        <article id="article-4167">
            <a href="https://ardalis.com/first-impressions-of-the-intel-haswell-ultrabook/" target="_blank">
                <h2 class="title mb-6" id="article-4167">First Impressions of the Intel Haswell Ultrabook</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 10, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was on vacation last week, and spent most of Monday driving home. When I got there, I found that a nice present had arrived: a new Intel&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4168">
            <a href="https://ayende.com/blog/162855/lightning-memory-mapped-database-is-esent" target="_blank">
                <h2 class="title mb-6" id="article-4168">Lightning memory-mapped database is Esent</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 09, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Here is something that suddenly dawned at me as I was going through the LMDB codebase. LMDB is actually how Esent works. In fact, going through LMDB codebase I am in a much better position to understand how Esent works.  For example, Esent is limited to 16TB per database. I did some math to figure out the max size of a LMDB db that used 32bits for page number and I got to 2 ** 32 times 4,096 == 16 TB, and that isn&#x2019;t a coincidence. And all the background information in the Esent API that talk about large values, for example. That is how LMDB does overflow, and tables are implemented as additional B-Trees (what LMDB calls dbs). At some point I was going through this in my head and realized that indexes are also working in the exact same way, and so does pretty much everything else. What Esent does on top is provide better concurrency (LMDB allows only a single writer), and a whole lot of additional features (schemas, secondary indexes, etc). But I think that the major difference from my point of view is that I had a theoretical idea about how Esent really worked, under the covers. Now I feel like I actually grok things at a much better level. For instance, Esent will not give back space to the operating system, even if you deleted stuff. I knew that, and just accepted that as how it worked. But now I can understand why it doesn&#x2019;t do that. Or the MAX_VER_PAGES setting, I knew what it purpose was, and how it impacted operations (it is the amount of changes that can be pending). But after reading LMDB dirty_pages and its limit, I understand the why and how it works at a much deeper level. To be honest, I kept reading LMDB codebase purely because I wasn&#x2019;t going to let that code beat me, but it is very educational.</p>
        </article>
        <article id="article-4169">
            <a href="https://ayende.com/blog/162881/reviewing-lightning-memory-mapped-database-library-mvcc" target="_blank">
                <h2 class="title mb-6" id="article-4169">Reviewing Lightning memory-mapped database library</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 08, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">MVCC stands for Multi Versioning Concurrency Control. This is how you can have both readers &amp; writer at the same time and not have to arrange locks for the two. With LMDB, MVCC is implemented by always creating a new page, never modifying them in place. That also means that when we &#x201C;free&#x201D; a page, we need to make sure not to actually use it until all the transactions that could see it has completed. To be honest, I can&#x2019;t follow the code. It is somewhat related to me_pghead , but I just can&#x2019;t follow what is going on. I think that this is related to the way it manage multiple transactions, but I am just unable to follow the code .Maybe it is just that I overloaded my senses with too much C code, I have been diving into this code, and sometimes it feels like this:  That said, I understand how it has to work, so that should be enough for now. Next, I want to see how to do it myself .</p>
        </article>
        <article id="article-4170">
            <a href="https://ayende.com/blog/162854/reviewing-lightning-memory-mapped-database-library-what-about-free-pages" target="_blank">
                <h2 class="title mb-6" id="article-4170">Reviewing Lightning memory-mapped database library</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 07, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, so in my last post (and last night, from my perspective), I wrote about the process in which LMDB maintains the B-Tree when it grows. But what about when it shrinks? And how does LMDB handle things like reusing space? For that matter, we need to discuss another thing. As I understand this right now, LMDB is going to write a page once and only once .And when that is done, that page is now immutable. Updates to this page will result in a new page, and the old one will be marked for reuse. So you don&#x2019;t actually have to worry about updating the page while others may be reading it. In other words, I would expect this code to use a lot of pages:  Actually, I would expect it to use two pages all the time. Alternating between the two after every transaction. Indeed, following the code, it is easy to see that this magic happens during mdb_page_touch. We find (somehow, not sure how yet) a free page (or create a new one), and we mark the old one for reuse. That means that when you actually write to the data, you aren&#x2019;t really writing to the old page, you are creating a new one. This drastically reduces a lot of complexity. However, it does mean that the db will be using more space, since every write transaction will use a minimum of one new page (and probably more, considering that there is the B-Tree to maintain). in fact, on average size dbs, I would be surprised if a single transaction could write less than 3 &#x2013; 4 pages as a minimum. I&#x2019;ll test the min number of pages per transaction in a bit, right now I want to focus on the implications of that decision. Well, to start with, concurrency is easier. We aren&#x2019;t writing to old data, so we have MVCC. The only thing we need to ensure is that we aren&#x2019;t reusing a page before all of its transactions are complete. But it also has other implications, I haven&#x2019;t confirmed my suspicions about transaction commits, but because we are writing to new locations, not modifying existing ones, this means that a crash midway would simply restore us to the previous state, and will not corrupt any data.  Since we don&#x2019;t modify pages, it means that free pages aren&#x2019;t just things that happen when we delete data, they happen all the time, so it would be interesting to see how LMDB handles them. Here is the relevant piece of the code:  So either find me a free page, or allocate a new one. Then add the existing page to the free list for the current transaction. A bit lower in the code we copy the data in the old page to the new one, and we are ready to go. So, when we make updates, at least in this scenario, we are cycling between two pages, always allocating one and freeing the other, and on the next transaction we go the other way. This is really quite interesting, from the perspective of comparing that to other storage engines. CouchDB work in pretty much the same way, B-Tree with all the associated benefits. But CouchDB model is based on append only, and it cannot reuse the space in the file, which require compactions. LMDB model is much nicer in that regard. Since in both cases, in place updates are not allowed, there is a lot of wasted space that goes just for those updates. In LMDB&#x2019;s case, that wasted space is a lot bigger, because it works in page sizes, and can reuse them. In CouchDB&#x2019;s case, it doesn&#x2019;t reuse space, so it doesn&#x2019;t use pages (more space efficient this way).  Side note: C&#x2019;s lack of native data structures beyond array is really annoying. You realize that in C, a Stack is a design pattern?! And about the minimum number of pages per transaction, let us see what is going on about that. So I wrote the following code:  This should generate a deep enough B-Tree to show what I want. And indeed, the action happens here:  Both the root node and the data node are modified, because of the cursor stack. It isn&#x2019;t really a big deal, to be honest, since usually you would only need to update H pages (where H is the height of the tree) and H is very small for B-Trees. But this leads to me to consider something else. Usually when talking about on disk structures, one of the more important things that you want to keep in mind is reducing seeks. But the B-Tree model that we have here would result in having pages pretty much all over the file. Now, in something like CouchDB, it doesn&#x2019;t actually matter, because the file is append only, so you always end up scanning from the end of the file backward. But because LMDB is reusing pages, it is entirely possible for a root page to be in the middle of the file, the next level to be in the start and the actual data in the end. Now, I am guessing that this isn&#x2019;t actually an issue, because LMDB relies on the OS page cache to handle this, and that would take care of that. In practice, I expect, the branches of the tree are always going to be in memory, since they were the last written and the most accessed.  And that is enough for now. Next, I want to figure out how we return free pages to the system. In order to do that, I think that I&#x2019;ll need to look at how we transactions are committed.</p>
        </article>
        <div class="button flex justify-between">
            <a href="416.html"><span class="back arrow"></span></a>

            <a href="418.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>