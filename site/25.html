
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/199522-C/integer-compression-simd-bit-packing-and-unusual-usages" target="_blank"><h1 class="title mb-6">Integer compression</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 12, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I talked a bit before about the nature of bit packing and how the simdcomp library isn&#x2019;t actually doing compression. Why do I care about that, then?&#xA;Because the simdcomp library provides a very useful building block. A simple set of functions that allows you to very quickly pack and unpack bits. That is important, since those operations are fast enough that we can treat them as effectively free. Once that exists, we can now start finding interesting usages for those.&#xA;Let&#x2019;s assume that we have the following functions:&#xA;&#xA;Pack(Span&lt;uint&gt; input, Stream output, int bit);&#xA;Unpack(Stream input, Span&lt;uint&gt; output, int bit);&#xA;&#xA;It get a set of numbers and the number of bits and encode or decode them as needed.&#xA;Because those methods are&#xA0;fast, it means that we can play with various interesting designs. For example, let&#x2019;s take dictionary compression. Assume that we have a set of values, such as country names. This looks like this:&#xA;&#xA;[ &quot;United States&quot;, &quot;China&quot;, &quot;Japan&quot;, &quot;India&quot;, &quot;United States&quot;, &quot;Brazil&quot;, &quot;Germany&quot;, &quot;India&quot;, &quot;France&quot;, &quot;China&quot;, &quot;Japan&quot;, &quot;Brazil&quot;, &#x2026; ]&#xA;&#xA;This array contains thousands or millions of entries. We want to encode that in an efficient manner, how can we do that? Here is a simple way to utilize the speed of bit-packing to do something useful:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          void Encode(List&lt;string&gt; countries, Stream output)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var nums = new List&lt;int&gt;();&#xA;        &#xA;        &#xA;          &#xA;              var dic = new Dictionary&lt;string, int&gt;();&#xA;        &#xA;        &#xA;          &#xA;              foreach (var country in countries)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  if(dic.TryGetValue(country, out var index) == false)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      dic[country] = index = dic.Count;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  nums.Add(index);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              var bits = 32 - BitOperations.LeadingZeroCount((uint)dic.Count);&#xA;        &#xA;        &#xA;          &#xA;              var br = new BinaryWriter(output);&#xA;        &#xA;        &#xA;          &#xA;              br.Write(dic.Count);&#xA;        &#xA;        &#xA;          &#xA;              foreach(var country in dic.Keys)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  br.Write(country);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              br.Write(nums.Count);&#xA;        &#xA;        &#xA;          &#xA;              Pack(nums, output, bits);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          DictionaryCompression.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;What is going on here?&#xA;&#xA;We first iterate over the set of countries, finding the unique names and giving an index for each one of them.&#xA;Along the way, we produce an integer array of the indexes of country names.&#xA;Then we compute the maximum number of bits that we have to use to store those indexes.&#xA;To the output, we write the number of unique country names, the names themselves and then the bit-packed set of indexes.&#xA;&#xA;Let&#x2019;s assume that we have 30 unique values in this list, but the list itself is 5 million items in size. What is the actual cost here?&#xA;We&#x2019;ll assume an average country name of 8 bytes, to make the math easy. That means that to store the list of countries would cost us 38MB, if we did that using the most obvious approach.&#xA;Using the code above, assuming 30 unique values, we&#x2019;ll have 5 million values with 5 bits each, leading to a total cost of about 3MB, instead of 38MB.&#xA;The nice thing about this approach is that once you have fast bit-packing routines, you can now start using them in all sorts of interesting ways.&#xA;The reason I talked about the topic before starting to discuss FastPFor is that it makes a lot more sense to understand how bit-packing can be applied separately from FastPFor, since that is just making interesting use of the capability.</p>
        <a href="https://ayende.com/blog/199521-C/talk-scalable-architecture-from-the-ground-up" target="_blank"><h1 class="title mb-6">Talk</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 09, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20"></p>
        <a href="https://ayende.com/blog/199491-B/integer-compression-using-simd-bit-packing-in-practice" target="_blank"><h1 class="title mb-6">Integer compression</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 08, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the last post, I talked about how the simdcomp library is actually just doing bit-packing. Given a set of numbers, it will put the first N bits in a packed format. That is all. On its own, that isn&#x2019;t very useful, we have to pair it with something else to make it do something more interesting.&#xA;Previously, I talked about delta compression, what if we put both of those together?&#xA;Given a sorted list of numbers, we&#x2019;ll compute the delta between the numbers, then we can figure out how many bits we need to store them, and we can pack that tightly.&#xA;Analyzing the sample posting list I&#x2019;m using, we get the following batches (of 128 numbers each)&#xA;&#xA;328 batches at 13 bits&#xA;11 batches at 22 bits&#xA;7 batches at 23 bits&#xA;3 batches as 27 bits&#xA;1 batch at 31 bits&#xA;1 batch at 28 bits&#xA;&#xA;Doing the math, we can fit all of those using 77Kb or so.&#xA;The idea is that for each batch, we can use simdpack() to write just the relevant bits. We&#x2019;ll need some extra metadata to keep track of the number of bits per batch, but that is just one byte per every 128 values. For that matter, we can bit-pack that as well .&#xA;Note that in this case, we are using the simd packing routines just for bit packing. The actual compression aspect comes not from the packing, but from computing the deltas and then figuring out how densely we can pack those values.&#xA;This approach is called Frame Of Reference (FOR), and it has some really nice advantages. By splitting the data into blocks, we can take advantage of the patterns in the data. Here are the first 16 deltas in the posting list:&#xA;&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA;&#xA;&#xA;Value&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA;&#xA;&#xA;Bits&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[0]&#xA;&#xA;&#xA;1871143144&#xA;&#xA;&#xA;31&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[1]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[2]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[3]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[4]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[5]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[6]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[7]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[8]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[9]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[10]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[11]&#xA;&#xA;&#xA;7984&#xA;&#xA;&#xA;13&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[12]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[13]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[14]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA;[15]&#xA;&#xA;&#xA;4&#xA;&#xA;&#xA;3&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;Let&#x2019;s assume that the batch size is 4 numbers, what would be the numbers here? Basically, we take the max number of bits for each batch of 4 numbers.&#xA;The first block will require us to use 31 bits, the second would be just 3 bits, but the third would require 13 bits and the last is 3 bits again.&#xA;The idea is that for each block, we have a separate frame of reference, the number of bits that are required for us to record &amp; retrieve the data.&#xA;Of course, if you&#x2019;ll look at the data itself, we are wasting quite a lot of space here needlessly. There are just two numbers (0, 11) that require more than 3 bits.&#xA;There is an algorithm called Patched Frame Of Reference (PFor) that handles this. Basically, when we compute a batch, we&#x2019;ll record it using 3 bits only in this case. What about the rest of the values? Those we&#x2019;ll store outside the batch, as an exception. On reading, we&#x2019;ll need to patch the data to make it whole.&#xA;That adds a bit of complexity, but it also means that you can compress the data a lot more densely.&#xA;In the next post, I&#x2019;m going to be talking about FastPFor, which combines simd bit packing, patched frame of references and some really clever tricks to get a very interesting integer compression algorithm.</p>
        <a href="https://ayende.com/blog/199490-B/integer-compression-understanding-simd-compression-by-lemire" target="_blank"><h1 class="title mb-6">Integer compression</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 07, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post, I showed how you can use integer compression using variable-size integers. That is a really straightforward approach for integer compression, but it isn&#x2019;t ideal. To start with, it means that we take at least one byte for each number, but in many cases, especially if we are using delta encoding, we can pack things a lot more tightly. For reference, here are the first 15 records we have in the posting list I&#x2019;m using for testing, delta encoded:&#xA;&#xA;1871143144 4 4 4 4 4 4 4 4 4 4 7984 4 4 4&#xA;&#xA;See the range of 4, repeating. Each one of them can be represented by 3 bits, but we&#x2019;ll waste 32 &#x2013; 64 bits to hold it.&#xA;When you are searching for data on &#x201C;database stuff&#x201D;, the building blocks that are being used to build databases, you&#x2019;ll usually find Lemire there. In this case, I would like to talk about the SimdComp library. From the GitHub repository:&#xA;&#xA;A simple C library for compressing lists of integers using binary packing and SIMD instructions. This library can decode at least 4 billion of compressed integers per second on most desktop or laptop processors.&#xA;&#xA;Those are some really nice numbers, but I actually have a pet peeve with the name of the library. It isn&#x2019;t actually doing compression, what it does is bit packing, which is something quite different.&#xA;Bit packing just takes numbers that are 32 bits in length and stores them using fewer bits.&#xA0; For example, let&#x2019;s consider the following list: 1,2,3,4,5,6,7,8,9,10. If I would store that in 32 bits integers, that would take 40 bytes. But given that the maximum size is 10, I can use 4 bits integers, instead. Taking only 5 bytes.&#xA;The core of the library is this set of routines:&#xA;&#xA;simdpack()&#xA;simdpackwithoutmask()&#xA;simdunpack()&#xA;&#xA;All of them have roughly the same structure, something like this:&#xA;&#xA;&#xA;&#xA;This switch statement goes on for 32 bits. Each time selecting a different function. This code makes a lot of assumptions. You&#x2019;ll always give it exactly an input of 128 numbers and it will pack them and write them to output. The idea is to be as compact as you possibly can.&#xA;Reading this code is.. a challenge, because there is so much mental weight behind it, or so it seems. For example, take a look at how we pack a set of numbers into 2-bit integers:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          static void __SIMD_fastpack2_32(const uint32_t *_in, __m128i *out) {&#xA;        &#xA;        &#xA;          &#xA;            const __m128i *in = (const __m128i *)(_in);&#xA;        &#xA;        &#xA;          &#xA;            __m128i OutReg;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            const __m128i mask = _mm_set1_epi32((1U &lt;&lt; 2) - 1);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            __m128i InReg = _mm_and_si128(_mm_loadu_si128(in), mask);&#xA;        &#xA;        &#xA;          &#xA;            OutReg = InReg;&#xA;        &#xA;        &#xA;          &#xA;            InReg = _mm_and_si128(_mm_loadu_si128(&#x2B;&#x2B;in), mask);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            OutReg = _mm_or_si128(OutReg, _mm_slli_epi32(InReg, 2));&#xA;        &#xA;        &#xA;          &#xA;            InReg = _mm_and_si128(_mm_loadu_si128(&#x2B;&#x2B;in), mask);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            OutReg = _mm_or_si128(OutReg, _mm_slli_epi32(InReg, 4));&#xA;        &#xA;        &#xA;          &#xA;            InReg = _mm_and_si128(_mm_loadu_si128(&#x2B;&#x2B;in), mask);&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;            // redacted&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          __SIMD_fastpack2_32.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;The actual code goes on for quite a while (104 of dense SIMD code), so let&#x2019;s try to break it up a bit. If we&#x2019;ll translate this from SIMD to scalar, we&#x2019;ll have code like this:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          uint mask = (1u &lt;&lt; 2) -1;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var input = *in&#x2B;&#x2B; &amp; mask;&#xA;        &#xA;        &#xA;          &#xA;          var output = input;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          input = *in&#x2B;&#x2B; &amp; mask;&#xA;        &#xA;        &#xA;          &#xA;          output |=  input &lt;&lt; 2;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          input = *in&#x2B;&#x2B; &amp; mask;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          output |=  input &lt;&lt; 4;&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          scalar.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;If you are used to manipulating bits, it&#x2019;s fairly straightforward. We start by setting the output to the first value, then the second value was shifted by 2 bits and added to the value, then the third value was shifted by 4 bits, etc.&#xA;With SIMD, the interesting part is that we aren&#x2019;t operating on a single value, but 4 at a time. That also means that we have a difference in how the data actually end up being packed.&#xA;Given a list of values from 1 .. 16, bit packing them will usually result in the data looking like this:&#xA;&#xA;In contrast, the SIMD bit packing model will store the data like so:&#xA;&#xA;This is a result of operating on 4 items at a time, but in practice, the actual placement of the bits does not matter much, just that we are able to store and retrieve them.&#xA;Note that for packing, we have two options, one that uses a mask and the other that does not. That will be important later. The only difference between those options is whether&#xA0;a mask is applied before we splice the bits into the output, nothing else.&#xA;The reason I said that this isn&#x2019;t compression is that this library is focused solely on packing the bits, it has no behavior / concept beyond that stage. In the next post, we&#x2019;ll start looking into how we can make use of this in more interesting ways.</p>
        <a href="https://ayende.com/blog/199489-B/integer-compression-delta-encoding-variable-size-integers" target="_blank"><h1 class="title mb-6">Integer compression</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 06, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you are building a database, the need to work with a list of numbers is commonplace. For example, when building an index, we may want to store all the ids of documents of orders from Europe.&#xA;You can just store the raw values, of course, but that can be incredibly wasteful in terms of disk space, memory bandwidth and performance. Consider a database where millions of orders are from Europe. We&#x2019;ll need multiple megabytes just to store the document ids. We can utilize patterns in the numbers to reduce the total storage size. For example, if you are storing a list of sorted numbers, you can store the delta of the numbers, instead of the whole value. The delta tends to be much smaller, after all. Take a look at the following code:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          static void DeltaEncode(List&lt;long&gt; sortedList)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              if (sortedList.Count == 0)&#xA;        &#xA;        &#xA;          &#xA;                  return;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              long prev = sortedList [0];&#xA;        &#xA;        &#xA;          &#xA;              for (int i = 1; i &lt; sortedList.Count; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  long current = sortedList [i];&#xA;        &#xA;        &#xA;          &#xA;                  sortedList [i] = current - prev;&#xA;        &#xA;        &#xA;          &#xA;                  prev = current;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          static void WriteListToStream(List&lt;long&gt; deltas, Stream outputStream)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              BinaryWriter writer = new BinaryWriter(outputStream);&#xA;        &#xA;        &#xA;          &#xA;              foreach (var num in deltas)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  writer.Write7BitEncodedInt64(num);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          delta_encode.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;This will generate (in place) delta for the sorted list. We can then write it to a stream, using 7-bit integer (also called variable size integers) encoding. This way, smaller numbers take less space, which is the point of first doing delta encoding.&#xA;For testing purposes, I have a list of 44,956 items, which looks like this (full list is here):&#xA;&#xA;&#xA;&#xA;&#xA;1871143144&#xA;&#xA;&#xA;&#xA;&#xA;1871143148&#xA;&#xA;&#xA;&#xA;&#xA;1871143152&#xA;&#xA;&#xA;&#xA;&#xA;1871143156&#xA;&#xA;&#xA;&#xA;&#xA;1871143160&#xA;&#xA;&#xA;&#xA;&#xA;1871143164&#xA;&#xA;&#xA;&#xA;&#xA;1871143168&#xA;&#xA;&#xA;&#xA;&#xA;1871143172&#xA;&#xA;&#xA;&#xA;&#xA;1871143176&#xA;&#xA;&#xA;&#xA;&#xA;1871143180&#xA;&#xA;&#xA;&#xA;&#xA;Note that I&#x2019;m using int64, so if we would store the data as is, it would take ~351KB. Using delta encoding, we can pack that into just ~45Kb.&#xA;I care a lot more about the decoding of the values, so let&#x2019;s see how we read it back, shall we?&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          static List&lt;long&gt; ReadListFromStream(Stream inputStream)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var nums = new List&lt;long&gt;();&#xA;        &#xA;        &#xA;          &#xA;              var reader = new BinaryReader(inputStream);&#xA;        &#xA;        &#xA;          &#xA;              while (reader.BaseStream.Position &lt; reader.BaseStream.Length)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  nums.Add(reader.Read7BitEncodedInt64());&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              return nums;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          static void DeltaDecode(List&lt;long&gt; list)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              for (int i = 1; i &lt; list.Count; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  list[i] = list[i - 1] &#x2B; list[i];&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          delta_decode.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;With very little code, we can gain quite a jump in information density. That is quite good. For reference purposes, taking the same data and compressing it using GZip would cost us ~58KB, so significantly more than this simpler mechanism.&#xA;On the other hand, using GZip on the delta encoded list will put us under 8KB. This is because in this context, there is a great deal of repetition in the data, there are many runs that are exactly 4 values apart from one another, so we can get quite a good compression ratio out of this.&#xA;That does require that we&#x2019;ll have patterns in the data, which is by no means a guarantee. There is a whole field out there of research into integer compression, since it is such an important aspect of how database internals are working.&#xA;In this series, I&#x2019;m going to focus on detailing how we implemented FastPFor inside of RavenDB, what we learned along the way and what the final results were.</p>
        <a href="https://ardalis.com/latest-dotnet-roadmap/" target="_blank"><h1 class="title mb-6">What&#x27;s the latest .NET roadmap?</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: May 31, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">.NET Roadmap The latest version of .NET is 7. The current roadmap is for .NET 8. .NET 8 is scheduled to ship in November 2023 and will be an&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ardalis.com/when-and-how-to-use-blazor-components/" target="_blank"><h1 class="title mb-6">When and How to Use Blazor Components</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: May 19, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When and How to Use Blazor Components Blazor is a powerful framework for building web applications using C# instead of JavaScript. One of&#x2026;Keep Reading &#x2192;</p>
        <a href="https://www.stevejgordon.co.uk/concurrent-hosted-service-start-and-stop-in-dotnet-8" target="_blank"><h1 class="title mb-6">Concurrent Hosted Service Start and Stop in .NET 8</h1></a>
        <p class="mb-2">by Steve Gordon</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: May 17, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post, I will describe a new feature of the Microsoft.Extensions.Hosting library coming in .NET 8 (available since preview 4) affecting hosted services. Let&#x2019;s first begin with a brief recap of hosted services. The hosting library for .NET, used in both the ASP.NET Core project template and the Worker Service template, provides the capability [&#x2026;]</p>
        <a href="https://ardalis.com/avoid-dbcontext-iqueryable-proliferation/" target="_blank"><h1 class="title mb-6">Avoid Proliferating DbContext or IQueryable in .NET Apps</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: May 10, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Most .NET apps use EF Core and a DbContext for data access, but maintainability can suffer when the use of a DbContext or an IQueryable&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/199457-B/bug-chasing-narrowing-down-the-scope" target="_blank"><h1 class="title mb-6">Bug chasing, narrowing down the scope</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: May 05, 2023
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I just completed a major refactoring of a piece of code inside RavenDB that is responsible for how we manage sorted queries. The first two tiers of tests all passed, which is great. Now was the time to test how this change performed. I threw 50M records into RavenDB and indexed them. I did&#x2026; not like the numbers I got back. It makes sense, since I was heavily refactoring to get a particular structure, I could think of a few ways to improve performance, but I like doing this based on profiler output.&#xA;When running the same scenario under the profiler, the process crashed. That is&#x2026; quite annoying, as you can imagine. In fact, I discovered a really startling issue.&#xA;If I index the data and query on it, I get the results I expect. If I restart the process and run the same query, I get an ExecutionEngineException. Trying to debug those is a PITA. In this case, I&#x2019;m 100% at fault, we are doing a lot of unsafe things to get better performance, and it appears that I messed up something along the way. But my only reproduction is a 50M records dataset. To give some context, this means 51GB of documents to be indexed and 18 GB of indexing. Indexing this in release mode takes about 20 minutes. In debug mode, it takes a lot longer.&#xA;Trying to find an error there, especially one that can only happen after you restart the process is going to be a challenging task. But this isn&#x2019;t my first rodeo. Part of good system design is knowing how to address just these sorts of issues.&#xA;The indexing process inside RavenDB is single-threaded per index. That means that we can rule out a huge chunk of issues around race conditions. It also means that we can play certain tricks. Allow me to present you with the nicest tool for debugging that you can imagine: repeatable traces.&#xA;Here is what this looks like in terms of code:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private readonly struct IndexOperationsDumper : IDisposable&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;          #if GENERATE_INDEX_ACTION_TRACE&#xA;        &#xA;        &#xA;          &#xA;              private readonly FileStream _fs;&#xA;        &#xA;        &#xA;          &#xA;              private readonly BinaryWriter _bw;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public IndexOperationsDumper(IndexFieldsMapping fieldsMapping)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _fs = File.OpenWrite(&quot;index.bin-log&quot;);&#xA;        &#xA;        &#xA;          &#xA;                  _fs.Position = _fs.Length;&#xA;        &#xA;        &#xA;          &#xA;                  _bw = new BinaryWriter(_fs);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (_fs.Length == 0)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      _bw.Write7BitEncodedInt(fieldsMapping.Count);&#xA;        &#xA;        &#xA;          &#xA;                      for (int i = 0; i &lt; fieldsMapping.Count; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          IndexFieldBinding indexFieldBinding = fieldsMapping.GetByFieldId(i);&#xA;        &#xA;        &#xA;          &#xA;                          _bw.Write(indexFieldBinding.FieldName.ToString());&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Index(string id, Span&lt;byte&gt; data)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _bw.Write(id);&#xA;        &#xA;        &#xA;          &#xA;                  _bw.Write7BitEncodedInt(data.Length);&#xA;        &#xA;        &#xA;          &#xA;                  _bw.Write(data);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Commit()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _bw.Write(&quot;!Commit!&quot;);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Dispose()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _bw.Dispose();&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          #else&#xA;        &#xA;        &#xA;          &#xA;              public IndexOperationsDumper(IndexFieldsMapping fieldsMapping)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              public void Index(string id, Span&lt;byte&gt; data)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Commit()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Dispose()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          #endif&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          IndexOperationsDumper.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;In this case, you can see that this is a development only feature, so it is really bare-bones one. What it does is capture the indexing and commit operations on the system and write them to a file. I have another piece of similarly trivial code that reads and applies&#xA0;them, as shown below. Don&#x2019;t bother to dig into that, the code itself isn&#x2019;t really that interesting. What is important is that I have captured the behavior of the system and can now replay it at will.&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          [Fact]&#xA;        &#xA;        &#xA;          &#xA;          public void ShouldNotCorrupt()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              RequireFileBasedPager();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              using var stream = File.OpenRead(@&quot;/path/to/index.bin-log&quot;);&#xA;        &#xA;        &#xA;          &#xA;              using var br = new BinaryReader(stream);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              using var bsc = new ByteStringContext(SharedMultipleUseFlag.None);&#xA;        &#xA;        &#xA;          &#xA;              using var builder = IndexFieldsMappingBuilder.CreateForWriter(false);&#xA;        &#xA;        &#xA;          &#xA;              var fieldsCount = br.Read7BitEncodedInt();&#xA;        &#xA;        &#xA;          &#xA;              for (int i = 0; i &lt; fieldsCount; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var name = br.ReadString();&#xA;        &#xA;        &#xA;          &#xA;                  builder.AddBinding(i, name);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              var fields = builder.Build();&#xA;        &#xA;        &#xA;          &#xA;              int txns = 0;&#xA;        &#xA;        &#xA;          &#xA;              int items = 0;&#xA;        &#xA;        &#xA;          &#xA;              var wtx = Env.WriteTransaction();&#xA;        &#xA;        &#xA;          &#xA;              try&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var iw = new IndexWriter(wtx, fields);&#xA;        &#xA;        &#xA;          &#xA;                  while (true)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      string id;&#xA;        &#xA;        &#xA;          &#xA;                      try&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          id = br.ReadString();&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      catch (EndOfStreamException)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          iw.Commit();&#xA;        &#xA;        &#xA;          &#xA;                          iw.Dispose();&#xA;        &#xA;        &#xA;          &#xA;                          wtx.Commit();&#xA;        &#xA;        &#xA;          &#xA;                          wtx.Dispose();&#xA;        &#xA;        &#xA;          &#xA;                          break;&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      if (id == &quot;!Commit!&quot;)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          FlushIndexAndRenewWriteTransaction();&#xA;        &#xA;        &#xA;          &#xA;                          continue;&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      int len = br.Read7BitEncodedInt();&#xA;        &#xA;        &#xA;          &#xA;                      var buffer = br.ReadBytes(len);&#xA;        &#xA;        &#xA;          &#xA;                      iw.Index(id, buffer);&#xA;        &#xA;        &#xA;          &#xA;                      items&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  using (var rtx = Env.ReadTransaction())&#xA;        &#xA;        &#xA;          &#xA;                      QueryAll(rtx);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  void FlushIndexAndRenewWriteTransaction()&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      iw.Commit();&#xA;        &#xA;        &#xA;          &#xA;                      iw.Dispose();&#xA;        &#xA;        &#xA;          &#xA;                      wtx.Commit();&#xA;        &#xA;        &#xA;          &#xA;                      wtx.Dispose();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      StopDatabase();&#xA;        &#xA;        &#xA;          &#xA;                      StartDatabase();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      using (var rtx = Env.ReadTransaction())&#xA;        &#xA;        &#xA;          &#xA;                          QueryAll(rtx);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      txns&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;                      Console.WriteLine(txns &#x2B; &quot; With &quot; &#x2B; items);&#xA;        &#xA;        &#xA;          &#xA;                      items = 0;&#xA;        &#xA;        &#xA;          &#xA;                      wtx = Env.WriteTransaction();&#xA;        &#xA;        &#xA;          &#xA;                      iw = new IndexWriter(wtx, fields);&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              finally&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  wtx.Dispose();&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              StopDatabase();&#xA;        &#xA;        &#xA;          &#xA;              StartDatabase();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              using (var rtx = Env.ReadTransaction())&#xA;        &#xA;        &#xA;          &#xA;                  QueryAll(rtx);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              void QueryAll(Transaction rtx)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var matches = new long[1024];&#xA;        &#xA;        &#xA;          &#xA;                  for (int i = 0; i &lt; fieldsCount; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      var searcher = new IndexSearcher(rtx, fields);&#xA;        &#xA;        &#xA;          &#xA;                      var field = FieldMetadata.Build(fields.GetByFieldId(i).FieldName, default, i, default, default);&#xA;        &#xA;        &#xA;          &#xA;                      var sort = searcher.OrderBy(searcher.AllEntries(), new OrderMetadata(field, true, MatchCompareFieldType.Sequence));&#xA;        &#xA;        &#xA;          &#xA;                      while (sort.Fill(matches) != 0)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          ShouldNotCorrupt.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;The code itself isn&#x2019;t much, but it does the job. What is more important, note that we have calls to StopDatabase() and StartDatabase(), I was able to reproduce the crash using this code.&#xA;That was a massive win, since it dropped my search area from 50M documents to merely 1.2 million.&#xA;The key aspect of this is that I now have a way to play around with things. In particular, instead of using the commit points in the trace, I can force a commit (and start / stop the database) every 10,000 items (by calling FlushIndexAndRenewWriteTransaction). When using that, I can reproduce this far faster. Here is the output when I run this in release mode:&#xA;&#xA;1 With 0&#xA;2 With 10000&#xA;3 With 10000&#xA;4 With 10000&#xA;5 With 10000&#xA;6 With 10000&#xA;7 With 10000&#xA;8 With 10000&#xA;9 With 10000&#xA;10 With 10000&#xA;11 With 10000&#xA;Fatal error. Internal CLR error. (0x80131506)&#xA;&#xA;&#xA;So now I dropped the search area to 120,000 items, which is pretty awesome. Even more important, when I run this in debug mode, I get this:&#xA;&#xA;1 With 0&#xA;2 With 10000&#xA;Process terminated. Assertion failed.&#xA;   at Voron.Data.Containers.Container.Get(Low...&#xA;&#xA;So now I have a repro in 30,000 items, what is even better, a debug assertion was fired, so I have a really good lead into what is going on.&#xA;The key challenge in this bug is that it is probably triggered as a result of a commit and an index of the next batch. There is a bunch of work that we do around batch optimizations that likely cause this sort of behavior. By being able to capture the input to the process and play with the batch size, we were able to reduce the amount of work required to generate a reproduction from 50M records to 30,000 and have a lead into what is going on.&#xA;With that, I can now start applying more techniques to narrow down what is going on. But by far the most important aspect as far as I&#x2019;m concerned is the feedback cycle. I can now hit F5 to run the code and encounter the problem in a few seconds.&#xA;&#xA;&#xA;&#xA;It looks like we hit a debug assertion because we keep a reference to an item that was already freed. That is really interesting, and now I can find out which item and then figure out why this is the case. And at each point, I can simply go one step back in the investigation, and reproduce the state, I have to hit F5 and wait a bit. This means that I can be far more liberal in how I figure out this bug.&#xA;This is triggered by a query on the indexed data, and if I follow up the stack, I have:&#xA;&#xA;&#xA;&#xA;This is really interesting, I wonder&#x2026; what happens if I query before I restart the database? With this structure, this is easy to do.&#xA;&#xA;&#xA;&#xA;This is actually a big relief. I had no idea why restarting the database would cause us to expose this bug.&#xA;Another thing to note is that when I ran into the problem, I reproduced this on a query that sorted on a single field. In the test code, I&#x2019;m testing on all fields, so that may be an asset in exposing this faster.&#xA;Right now the problem reproduces on the id field, which is unique. That helps, because it removes a large swath of code that deals with multiple terms for an entry. The current stage is that I can now reproduce this issue without running the queries, and I know exactly where it goes wrong.&#xA;&#xA;&#xA;&#xA;And I can put a breakpoint on the exact location where this entry is created:&#xA;&#xA;&#xA;&#xA;By the way, note that I&#x2019;m modifying the code instead of using a conditional breakpoint. This is because of the performance difference. For a conditional breakpoint, the debugger has to stop execution, evaluate the condition and decide what to do. If this is run a lot, it can have a huge impact on performance. Easier to modify the code. The fact that I can do that and hit F5 and get to the same state allows me to have a lot more freedom in the ergonomics of how I work.&#xA;This allows me to discover that the entry in question was created during the second transaction. But the failure happens during the third, which is really interesting. More to the point, it means that I can now do this:&#xA;&#xA;&#xA;&#xA;With the idea that this will trigger the assert on the exact entry that cause the problem. This is a good idea, and I wish that it worked, but we are actually doing a non-trivial amount of work during the commit process, so now we have a negative feedback and another clue. This is happening in the commit phase of the indexing process. It&#x2019;s not a big loss, I can do the same in the commit process as well. I have done just that and now I know that I have a problem when indexing the term: &#x201C;tweets/1212163952102137856&#x201D;. Which leads to this code:&#xA;&#xA;&#xA;&#xA;And at this point, I can now single step through this and figure out what is going on, I hope.&#xA;When working on complex data structures, one of the things that you need to do is to allow to visualize them. Being able to manually inspect the internal structure of your data structures can save you a lot of debugging. As I mentioned, this isn&#x2019;t my first rodeo. So when I narrowed it down to a specific location, I started looking into exactly what is going on.&#xA;Beforehand, I need to explain a couple of terms (pun intended):&#xA;&#xA;tweets/1212163952102137856 &#x2013; this is the entry that triggers the error.&#xA;tweets/1212163846623727616 &#x2013; this is the term that should be returned for 1679560&#xA;&#xA;Here is what the structure looks like at the time of the insert:&#xA;&#xA;&#xA;&#xA;You can notice that the value here for the last page is the same as the one that we are checking for 1679560.&#xA;To explain what is going on will take us down a pretty complex path that you probably don&#x2019;t care about, but the situation is that we are keeping track of the id in two locations. Making sure to add and remove it in both locations as appropriate. However, at certain points, we may decide to shuffle things around inside the tree, and we didn&#x2019;t sync that up properly with the rest of the system, leading to a dangling reference.&#xA;Now that I know what is going on, I can figure out how to fix it. But the story of this post was mostly about how I figured it out, not the bug itself.&#xA;The key aspect was to get to the point where I can reproduce this easily, so I can repeat it as many times that is needed to slowly inch closer to the solution.</p>
        <div class="button flex justify-between">
            <a href="24.html"><span class="back arrow"></span></a>

            <a href="26.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>