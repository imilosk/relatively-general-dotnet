
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 410 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4091">
            <a href="https://ayende.com/blog/161700/reviewing-leveldb-part-viii-what-are-the-levels-all-about" target="_blank">
                <h2 class="title mb-6" id="article-4091">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 02, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When I last left things, we were still digging into the code for Version and figure out that this is a way to handle the list of files, and that it is the table cache that is actually doing IO. For this post, I want to see where continuing to read the Version code will take us. There are some interesting things going on in here. We use the version to do a lot more. For example, because it holds all of the files, we can use it to check if they are overlaps in key spaces, which leveldb can use to optimize things later on. I am not sure that I am following everything that is going on there, but I start to get the shape of things. As I understand things right now. Data is stored in the following levels:  MemTable &#x2013; where all the current updates are going  Immutable MemTable &#x2013; which is frozen, and probably in the process of being written out  Level 0 &#x2013; probably just a dump of the mem table to disk, key ranges may overlap, so you may need to read multiple files to know where a particular value is.  Level 1 to 6 &#x2013; files where keys cannot overlap, so you probably only need one seek to find things. But seeks are still charged if you need to go through multiple levels to find a value.  That make sense, and it explains things like charging seeks, etc. Now, I am currently going over VersionSet::Builder, which appears to be applying something called VersionEdit efficiently. I don&#x27;t know what any of those things are yet... VersionEdit appears to be a way to hold (and maybe store on disk?) data about pending changes to a version. This is currently not really useful because I still don&#x27;t know how that is used. This means that I need to go deeper into the VersionSet code now. VersionSet::LogAndApply looks like it is an interesting candidate for behavior. I also found why we need VersionEdit to be persistable, we write it to the manifest file. Probably as a way to figure out what is going on when we recover. LogAndApply write the VersionEdit to a manifest file, then set the current file to point to that manifest file. I am currently reading the Recover function, and it seems to be applying things in reverse. It reads the CURRENT file which points to the current manifest, which contains the serialized VersionEdit contents. Those are read in turn, after which we apply the edit to the in memory state.  Toward the end of VersionSet.cc file, we start seeing things regards compaction. Like: Iterator* VersionSet::MakeInputIterator(Compaction* c) Compaction* VersionSet::PickCompaction() I sort of follow and sort of doesn&#x27;t follow what the code is doing there. It selects the appropriate set of files that need to be compacted. I don&#x27;t really get the actual logic, I&#x27;ll admit, but hopefully that will become better when I read the rest of the code. Compaction appears to work on level and level&#x2B;1 files. I assume that it is going to read all of those files, merge them into level&#x2B;1 and then delete (or mark for deletion) the existing files. This is now close to midnight, and my eyes started building and the code started to do gymnastics on the screen, so I&#x27;ll call it a post for now.</p>
        </article>
        <article id="article-4092">
            <a href="https://benfoster.io/blog/nancy-vs-aspnet-mvc-getting-started/" target="_blank">
                <h2 class="title mb-6" id="article-4092">Nancy vs ASP.NET MVC - Getting Started</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 02, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post we look at how to create a very basic web site from scratch using both Nancy and ASP.NET MVC frameworks.</p>
        </article>
        <article id="article-4093">
            <a href="https://ayende.com/blog/161889/my-passover-project-introducing-rattlesnake-clr" target="_blank">
                <h2 class="title mb-6" id="article-4093">My Passover Project: Introducing Rattlesnake.CLR</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 01, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, after spending quite a lot of time digging through the leveldb codebase, and with several years of working with RavenDB, I can say with confidence that the CLR make it extremely hard to build high performance server side systems using the CLR. Mostly, the issues are related to GC and memory. In particular, not having any way to control memory allocation and/or the GC means that we can&#x2019;t optimize those scenarios in any meaningful way. At the same time, I do not want to go back to the unmanaged world. As mentioned ,I just came back from a very deep dive into a non trivial C&#x2B;&#x2B; codebase ,and while I consider that codebase a really good one, that ain&#x2019;t to say it is a pleasure to always be thinking about all the stuff that the CLR just takes away. Therefor, I decided that I&#x2019;m going to be doing something about it. And Rattlesnake.CLR was born:  The major features of the Rattlesnake.CLR include explicit memory management when required. Let us say that we know that we are going to be needing some amount of memory for a while, and then all of that can be thrown away. This is extremely common in scenarios such as a web request, pretty much all the memory that you generate during the processing web request can be safely free immediately. In RavenDB&#x2019;s case, the memory we consume during indexing can be free immediately when we stop indexing. Right now this is a painful process of making sure that we allocate within the same gen0 and hoping that it won&#x2019;t be too expensive, or that we won&#x2019;t get a complete halt of the entire server while it is releasing memory. It also make it really hard to do things like limit the amount of memory your code uses. Another requirement that I have is that Rattlesnake.CLR should be able to execute existing .NET assemblies without any additional steps. Since I don&#x2019;t fancy doing ports of stuff that already exists. In order to handle this scenario with the given constraints, we have:      1: var heap = Heap.Create(HeapOptions.None,    2:     1024 * 1024,   3:     512 * 1024 * 1024);   4:&#xA0;    5: using(MemoryAllocations.AllocateFrom(heap))   6: {   7:    var sb = new StringBuilder();   8:    for(var i = 0; i &lt; 100; i &#x2B;&#x2B; )   9:          sb.AppendLine(i);  10:    Console.WriteLine(sb.ToString());  11: }  12:&#xA0;   13: heap.Destroy(); &#xA;All the code within the using statement is allocated in our own heap. In line 13, we are destroying all of that memory in one fell swoop.&#xA;There are a few notes about this that we probably should address:&#xA;&#xA;By default, memory allocated by this form is not subject to any form of GC. The idea is that this whole heap is getting released immediately.&#xA;Note that last two parameters for the Heap.Create. The first is the initial size of the heap, and the second is&#xA0; the max size. We now have a real way to actually limit the amount of memory a piece of code will use. This is really important on server applications where avoiding paging is critical.&#xA;For that matter, we can now figure out how much memory a particular piece of code uses, and allocate our resources accordingly.&#xA;You can use multiple heaps at the same time, although only one can be installed as the default allocation at a given point in time.&#xA;There is the explicit heap.GarbageCollect() method that will do GC only on that heap, and which you can schedule at your own convenience.&#xA0; You can have two heaps, and allocate from one while you are GCing from the other. And yes ,that means that GCs using this methods will not stop the process!&#xA;Memory allocated on the heap is obviously only valid as long as the heap is valid. That means that once the heap is destroyed, you can&#x2019;t access any of the objects that were created there. This has implications for things like cache. We provide MemoryAllocations.AllocateOnGlobalHeap&lt;T&gt;(args) method to force you to use the global heap, instead, if you want this memory to be always available and subject to GC.&#xA;This is early days yet, but we already see some really interesting performance improvements!&#xA;How does this work?&#xA;While an early experiment with Rattlensake.CLR was based on the Mono runtime. I quickly decided that I wanted to keep using the MS CLR. Now, it order to handle this I had to do some unnatural things (to say the least), but I think that I even managed to make this a supported option. Essentially, we are using the CLR Hosting API for this. In particular:&#xA;&#xA;ICLRGCManager&#xA;IHostMalloc&#xA;IHostMemoryManager &#xA;You can use Rattlesnake.CLR like this:&#xA;&#xA;.\Rattlesnake.exe Raven.Server.exe&#xA;Just for fun, we also allowed to place limits on the default heap, so you can be sure that you aren&#x2019;t allocating too much there.&#xA;&#xA;.\Rattlesnake.exe Raven.Server.exe --max-default-heap-size=256MB&#xA;We are still running some tests, but this is looking really good.</p>
        </article>
        <article id="article-4094">
            <a href="https://benfoster.io/blog/nancy-vs-aspnet-mvc-introduction/" target="_blank">
                <h2 class="title mb-6" id="article-4094">Nancy vs ASP.NET MVC - An introduction</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 31, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">First in a series of blog posts where I take a practical approach to comparing Nancy and ASP.NET MVC.</p>
        </article>
        <article id="article-4095">
            <a href="https://ayende.com/blog/161857/toys-for-geeks" target="_blank">
                <h2 class="title mb-6" id="article-4095">Toys for geeks</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 30, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I just got myself a UFO Mini Helicopter, it looks like this:  This is the first helicopter that I got, and for a 30$ toy, it is an awesome amount of fun. The only complaint that I have is that this has only about 5 minutes of battery life. I am really bad at flying it, too.  As mentioned, this is the very first helicopter that I bought, and I think that I would like to have a better one for the next time. Any recommendations from you guys?  I would like a better battery life. 30 minutes &#x2013; 1 hour would be what I want. Should be pretty resistant to crashes. I know that I am going to crash it a lot. Any recommendations?</p>
        </article>
        <article id="article-4096">
            <a href="https://ayende.com/blog/161698/reviewing-leveldb-part-vii-the-version-is-where-the-levels-are" target="_blank">
                <h2 class="title mb-6" id="article-4096">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 29, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, so far I have written 6 parts, and the only thing that happened is that we wrote some stuff to the log file. That is cool, but I am assuming that there has got to be more. I started tracking the code, and I think that what happens is that we have compactions of the MemTable, at which point we flush it to disk. I think that what happens is this, we have a method called MaybeScheduleCompaction, in db_impl.cc, which is kicking of the actual process for the MemTable compaction. This is getting called from a few places, but most importantly, it is called during the Write() call. Reading the code, it seems that before we can go to the actual compaction work, we need to look at something called a VersionSet. This looks like it holds all of the versions of the database at a particular point in time. Including all the files that it is using, etc. A lot of what it (and its associate, the Version class) is about managing lists of this structure: &#xA;&#xA;&#xA;I am not sure what allowed_seeks mean, I assume it is there to force compaction for the next level.&#xA;Okay, moving on to version, it looks this is where all the actual lookups are done. We have a list of file metadata, including smallest &amp; largest keys in each file. That allows us to find the appropriate files to look at quite easily. There seems to be some interaction between Version and TableCache, but I&#x2019;m not going into that now.&#xA;A version is holding an array of 7 levels, and at each level we have the associated files. I am going to continue digging into Version &amp; VersionSet for the moment. &#xA;Side Note: In fact, I got frustrated enough with trying to figure out leveldb on Windows that I setup a Ubunto machine with KDevelop just to get things done. This blog post is actually written on the Ubunto machine (later to be copy into live writer :-)).&#xA;I am still in the process of going through the code. It is a really much easier to do this in an IDE that can actually build &amp; understand the code.&#xA;Once thing that I can tell you right now is that C&#x2B;&#x2B; programmers are strange. I mean, take a look at the following code, from Version::LevelFileNumIterator :&#xA;&#xA;&#xA;&#xA;&#xA;This returns a byte array containing encoded file num &amp; size in a buffer. Would it be so hard to create a struct for that or use std::pair ? Seems like this would complicate the client code. Then again, maybe there is a perf reason that I am not seeing? &#xA;Then again, here is the client code:&#xA;&#xA;&#xA;&#xA;And that seems pretty clear.&#xA;So far, it appears as if the Version is the current state of all of the files in a particular point in time. I think that this is how leveldb implements snapshots. The files are SSTables, which are pretty much write once only. A version belong to a set (not sure exactly what that means yet) and is part of a linked list. Again, I am not sure what is the purpose of that yet.&#xA;I&#x27;ll need to do a deeper dive into snapshots in general, later on, because it is interesting to see how that is implemented with regards to the memtable.&#xA;Moving back to the actual code, we have this code:&#xA;&#xA;This seems to me to indicate that the table_cache is the part of the code that is actually manages the SSTables, probably using some variant of the page pool.&#xA;Now, let us get to the good parts, Version::Get:&#xA;&#xA;&#xA;This looks like this is actually doing something useful. In fact, it find the relevant files to look for that particular key, once it did that, it calls:&#xA;&#xA;&#xA;So the data is actually retrieved from the cache, as expected. But there was an interesting comment there about &#x201C;charging&#x201D; seeks for files, so I am going to be looking at who is calling Version::Get right now, then come back to the cache in another post.&#xA;What is interesting is that we have this guy:&#xA;&#xA;&#xA;&#xA;And that in turn all make sense now. allowed_seeks is something that is set when we apply a VersionEdit, it seems. No idea what this is now, but there is a comment there that explains that we use this as a way to trigger compaction when it is cheaper to do do compaction than continue doing those seeks. Interestingly enough, seeks are only counted if we have to go through more than one file to find a value, which makes sense, I guess. &#xA;Okay, now let us back up a bit and see who is calling Version::Get. And as it turned out, it is our dear friend, DBImpl::Get().&#xA;There, we first look in the current memtable, then in the immutable memtable (which is probably on its way to become a SSTable now. And then we are looking at the current Version, calling Version::Get. If we actually hit the version, we also call Version::UpdateStats, and if we need to, we then call MaybeScheduleCompaction(), which is where we started this post.&#xA;And... that is it for this post, we still have managed to find where we actually save to disk (they hid it really deep), but I think I&#x27;ll probably be able to figure this out in this sitting, watch out for the next post.</p>
        </article>
        <article id="article-4097">
            <a href="https://ayende.com/blog/161442/reviewing-leveldb-part-vi-the-log-is-base-for-atomicity" target="_blank">
                <h2 class="title mb-6" id="article-4097">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 28, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Here we are starting to get into the interesting bits. How do we actually write to disk. There are two parts of that. The first part is the log file. This is were all the recent values are stored, and it is an unsorted backup for the MemTable in case of crashes. Let us see how this actually works. There are two classes which are involved in this manner. leveldb::log::Writer and leveldb::WritableFile. I think that WritableFile is the leveldb abstraction, so it is bound to be simpler. We&#x2019;ll take a look at that first. Here is what it looks like:      1: // A file abstraction for sequential writing.  The implementation   2: // must provide buffering since callers may append small fragments   3: // at a time to the file.   4: class WritableFile {   5:  public:   6:   WritableFile() { }   7:   virtual ~WritableFile();   8:&#xA0;    9:   virtual Status Append(const Slice&amp; data) = 0;  10:   virtual Status Close() = 0;  11:   virtual Status Flush() = 0;  12:   virtual Status Sync() = 0;  13:&#xA0;   14:  private:  15:   // No copying allowed  16:   WritableFile(const WritableFile&amp;);  17:   void operator=(const WritableFile&amp;);  18: };&#xA;Pretty simple, overall. There is the buffering requirement, but that is pretty easy overall. Note that this is a C&#x2B;&#x2B; interface. There is a bunch of implementations, but the one that I think will be relevant here is PosixMmapFile. So much for it being simple. As I mentioned, this is Posix code that I am reading, and I have to do a lot of lookup into the man pages. The implementation isn&#x2019;t that interesting, to be fair, and full of mmap files on posix minutia. So I am going to skip it.&#xA;I wonder why the choice was map to use memory mapped files, since the API exposed here is pretty much perfect for streams. As you can imagine from the code, calling Apend() just writes the values to the mmap file, flush is a no op, and Sync() actually ask the file system to write the values to disk and wait on that. I am guessing that the use of mmap files is related to the fact that mmap files are used extensively in the rest of the code base (for reads) and that gives leveldb the benefit of using the OS memory manager as the buffer.&#xA;Now that we got what a WritableFile is like, let us see what the leveldb::log::Writer is like. In terms of the interface, it is pretty slick, it has a single public method:&#xA;&#xA;&#xA;   1: Status AddRecord(const Slice&amp; slice);&#xA;As a remind, those two are used together in the DBImpl::Write() method, like so:&#xA;&#xA;&#xA;   1: status = log_-&gt;AddRecord(WriteBatchInternal::Contents(updates));   2: if (status.ok() &amp;&amp; options.sync) {   3:  status = logfile_-&gt;Sync();   4: }&#xA;From the API look of things, it appears that this is a matter of simply forwarding the call from one implementation to another. But a lot more is actually going on:&#xA;&#xA;&#xA;   1: Status Writer::AddRecord(const Slice&amp; slice) {   2:   const char* ptr = slice.data();   3:   size_t left = slice.size();   4:&#xA0;    5:   // Fragment the record if necessary and emit it.  Note that if slice   6:   // is empty, we still want to iterate once to emit a single   7:   // zero-length record   8:   Status s;   9:   bool begin = true;  10:   do {  11:     const int leftover = kBlockSize - block_offset_;  12:     assert(leftover &gt;= 0);  13:     if (leftover &lt; kHeaderSize) {  14:       // Switch to a new block  15:       if (leftover &gt; 0) {  16:         // Fill the trailer (literal below relies on kHeaderSize being 7)  17:         assert(kHeaderSize == 7);  18:         dest_-&gt;Append(Slice(&quot;\x00\x00\x00\x00\x00\x00&quot;, leftover));  19:       }  20:       block_offset_ = 0;  21:     }  22:&#xA0;   23:     // Invariant: we never leave &lt; kHeaderSize bytes in a block.  24:     assert(kBlockSize - block_offset_ - kHeaderSize &gt;= 0);  25:&#xA0;   26:     const size_t avail = kBlockSize - block_offset_ - kHeaderSize;  27:     const size_t fragment_length = (left &lt; avail) ? left : avail;  28:&#xA0;   29:     RecordType type;  30:     const bool end = (left == fragment_length);  31:     if (begin &amp;&amp; end) {  32:       type = kFullType;  33:     } else if (begin) {  34:       type = kFirstType;  35:     } else if (end) {  36:       type = kLastType;  37:     } else {  38:       type = kMiddleType;  39:     }  40:&#xA0;   41:     s = EmitPhysicalRecord(type, ptr, fragment_length);  42:     ptr &#x2B;= fragment_length;  43:     left -= fragment_length;  44:     begin = false;  45:   } while (s.ok() &amp;&amp; left &gt; 0);  46:   return s;  47: }&#xA;Let us see if we do a lot here. But I don&#x2019;t know yet what is going on. From the first glance, it appears that we are looking at fragmenting the value into multiple records, and we might want to enter zero length records (no idea what that is for?maybe compactions?). &#xA;It appears that we write in blocks of 32Kb at a time. Line 12 &#x2013; 21 are dealing with how to finalize the block when you have no more space. (Basically fill in with nulls).&#xA;Lines 26 &#x2013; 40 just set the figure out what the type of the record that we are going to work (a full record, all of which can sit in a single buffer, a first record, which is the start in a sequence of items or middle / end, which is obvious).&#xA;And then we just emit the physical record to disk, and move on. I am not really sure what the reasoning is behind it. It may be to avoid having to read records that are far too big?&#xA;I looked at EmitPhysicalRecord to see what we have there and it is nothing much, it writes the header, including CRC computation, but that is pretty much it. So far, a lot of questions, but not a lot of answers. Maybe I&#x2019;ll get them when I&#x2019;ll start looking at the reading portion of the code. But that will be in another post.</p>
        </article>
        <article id="article-4098">
            <a href="https://ayende.com/blog/161441/reviewing-leveldb-part-v-into-the-memtables-we-go" target="_blank">
                <h2 class="title mb-6" id="article-4098">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 27, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">You can read about the theory of Sorted Strings Tables and Memtables here. In this case, what I am interested in is going a bit deeper into the leveldb codebase, and understanding how the data is actually kept in memory and what is it doing there. In order to do that, we are going to investigate MemTable. As it turned out, this is actually a very simple data structure. A MemTable just hold a SkipList, whish is a sorted data structure that allows O(log N) access and modifications. The interesting thing about Skip List in contrast to Binary Trees, is that it is much easier to create a performant solution of concurrent skip list (either with or without locks) over a concurrently binary tree. The data in the table is just a list of key &amp; value (or delete marker). And that means that searches through this can give you three results:  Here is the value for the key (exists) The value for the key was remove (deleted) The value is not in the memory table (missing) It is the last part where we get involved with the more interesting aspect of LevelDB (and the reason it is called leveldb in the first place). The notion that you have multiple levels. The mem table is the first one, and then you spill the output out to disk (the Sorted Strings Table). Now that I figure out how simple MemTable is really is, I am going to take a look at the leveldb log, and then dive into Sorted Strings Table.</p>
        </article>
        <article id="article-4099">
            <a href="https://ayende.com/blog/161413/reviewing-leveldb-part-iv-on-std-string-buffers-and-memory-management-in-c" target="_blank">
                <h2 class="title mb-6" id="article-4099">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 26, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">his is a bit of a side track. One of the things that is quite clear to me when I am reading the leveldb code is that I was never really any good at C&#x2B;&#x2B;. I was a C/C&#x2B;&#x2B; developer. And that is a pretty derogatory term. C &amp; C&#x2B;&#x2B; share a lot of the same syntax and underlying assumption, but the moment you want to start writing non trivial stuff, they are quite different. And no, I am not talking about OO or templates. I am talking about things that came out of that. In particular, throughout the leveldb codebase, they are very rarely, if at all, allocate memory directly. Pretty much the whole codebase rely on std::string to handle buffer allocations and management. This make sense, since RAII is still the watch ward for good C&#x2B;&#x2B; code. Being able to utilize std::string for memory management also means that the memory will be properly released without having to deal with it explicitly. More interestingly, the leveldb codebase is also using std::string as a general buffer. I wonder why it is std::string vs. std::vector&lt;char&gt;,&#xA0; which would bet more reasonable, but I guess that this is because most of the time, users will want to pass strings as keys, and likely this is easier to manage, given the type of operations available on std::string (such as append). It is actually quite fun to go over the codebase and discover those sort of things. Especially if I can figure them out on my own . This is quite interesting because from my point of view, buffers are a whole different set of problems. We don&#x2019;t have to worry about the memory just going away in .NET (although we do have to worry about someone changing the buffer behind our backs), but we have to worry a lot about buffer size. This is because at some point (80Kb), buffers graduate to the large object heap, and stay there. Which means, in turn, that every time that you want to deal with buffers you have to take that into account, usually with a buffer pool. Another aspect that is interesting with regards to memory usage is the explicit handling of copying. There are various places in the code where the copy constructor was made private, to avoid this. Or a comment is left about making a type copy-able intentionally. I get the reason why, because it is a common failing point in C&#x2B;&#x2B;, but I forgot (although I am pretty sure that I used to know) the actual semantics of when/ how you want to do that in all cases.</p>
        </article>
        <article id="article-4100">
            <a href="https://ayende.com/blog/161667/ravendb-2-0-3-stable-release" target="_blank">
                <h2 class="title mb-6" id="article-4100">RavenDB 2.0.3 Stable Release!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 25, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We have just released the next stable build 2330 of RavenDB 2.0. You can find it here. This release contains a lot of bug fixes, improvements, streamlining and some interesting new stuff. The full change log is actually here, because we found a bug in 2325 (ironically, it was a bug in how it reported its build number).  Breaking Changes:  SQL Replication script / configuration change (more below). Features:  More debug / visibility endpoints (user info, changes traffic, map/reduce data, etc). Better highlighting support. Spatial Search will sort by distance by default. Better indexing for TimeSpan values. Can do more Parallel Work in Map/Reduce indexes now. Improvements:  Map/Reudce indexes tune themselves automatically. Better Periodic Backup behavior when there is no new writes. Better handling of transactions during documents put with high number of referencing documents. Better use of alerts. Better float support. Studio:  Better import/export UI. Bug fixes:  Can backup &amp; restore even in the presence of corrupt / missing indexes. LoadDocument with map/reduce indexes cause issues. Allow to change the number of cached requests on the client side without NRE. Fixing Unique Constraints bundle with null unique properties. Forbidden error when running as a non admin user in the studio. Better support for indexing nullable properties with HasValue. Fixed a problem with replication of deleted documents when adding a new node in the topology. Support export / import with versioning bundle. &#xA0; SQL Replication Breaking Changes With SQL Replication, it became apparent that we missed a pretty big use case.&#xA0; Deletions.  Deletions is something that we didn&#x2019;t handle, and couldn&#x2019;t handle using the existing format. It was a touch call, but we decided to make a breaking change here. Now, you need to define all the tables that you&#x2019;ll be working with (as well as the order we will be writing to them). Assuming that we have a User document, and we want to replicate to Users and UsersGroups tables, we would have:      1: replicateToUsers({   2:    Name: this.Name   3: })   4:&#xA0;    5: for(var i = 0; i &lt; this.Groups.length; i&#x2B;&#x2B;) {   6:   replicateToUsersGroups({   7:       Group: this.Groups[i]   8:   });   9: }&#xA;This replaced the sqlReplicate calls. Note that this is a hard breaking reset. When you upgrade, you&#x2019;ll need to update all of your SQL Replication definitions (but you keep the replication state, you won&#x2019;t have to start replicating from scratch).</p>
        </article>
        <div class="button flex justify-between">
            <a href="409.html"><span class="back arrow"></span></a>

            <a href="411.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>