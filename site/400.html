
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 400 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3991">
            <a href="https://ayende.com/blog/163170/building-async-unit-of-work-with-mvc-4" target="_blank">
                <h2 class="title mb-6" id="article-3991">Building async Unit of Work with MVC 4</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 27, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the RavenDB mailing list, we had a question about how we can combine the standard unit of work pattern of working with RavenDB in MVC applications with async. In particular, the problematic code was:      1: public class HomeController : Controller   2: {   3:     public IAsyncDocumentSession Db { get; set; }   4:&#xA0;    5:     public async Task&lt;ActionResult&gt; Index()   6:     {   7:         var person = new Person {Name = &quot;Khalid Abuhakmeh&quot;};   8:         await Db.StoreAsync(person);   9:&#xA0;   10:         return View(person);  11:     }  12:&#xA0;   13:     protected override void OnActionExecuting(ActionExecutingContext filterContext)  14:     {  15:         Db = MvcApplication.DocumentStore.OpenAsyncSession();  16:         base.OnActionExecuting(filterContext);  17:     }  18:&#xA0;   19:     protected override void OnActionExecuted(ActionExecutedContext filterContext)  20:     {  21:         Db.SaveChangesAsync()  22:             .ContinueWith(x =&gt; { });  23:&#xA0;   24:         base.OnActionExecuted(filterContext);  25:     }  26:&#xA0;   27:     public class Person  28:     {  29:         public string Id { get; set; }   30:         public string Name { get; set; }  31:     }  32: }&#xA;&#xA;As you probably noticed, the problem is with line 21. We want to execute the save changes in an async manner, but we don&#x2019;t want to do that in a way that would block the thread. The current code just assume the happy path, and any error would be ignored. That ain&#x2019;t right. If we were using Web API, this would be trivially easy, but we aren&#x2019;t. So let us see what can be done about it.&#xA;I created a new MVC 4 application and wrote the following code:&#xA;&#xA;As you can see, I have a break point after the await, which means that when that break point is hit, I&#x2019;ll be able to see what is responsible for handling async calls in MVC4. When the breakpoint was hit, I looked at the call stack, and saw:&#xA;&#xA;&#xA;Not very useful, right? But we can fix that:&#xA;&#xA;And now we get:&#xA;&#xA;This is a whole bunch of stuff that doesn&#x2019;t really help, I am afraid. But then I thought about putting the breakpoint before the await, which gave me:&#xA;&#xA;And this means that I can check the code here. I got the code and started digging. At first I thought that I couldn&#x2019;t do it, but then I discovered that I could. See, all you have to do is to create you own async action invoker, like so:&#xA;&#xA;&#xA;   1: public class UnitOfWorkAsyncActionInvoker : AsyncControllerActionInvoker   2: {   3:     protected override IAsyncResult BeginInvokeActionMethod(   4:         ControllerContext controllerContext,   5:         ActionDescriptor actionDescriptor,   6:         IDictionary&lt;string, object&gt; parameters, AsyncCallback callback,   7:         object state)   8:     {   9:         return base.BeginInvokeActionMethod(controllerContext, actionDescriptor, parameters,  10:                                             result =&gt; DoSomethingAsyncAfterTask().ContinueWith(task =&gt; callback(task)),  11:                                             state);  12:     }  13:&#xA0;   14:     public async Task DoSomethingAsyncAfterTask()  15:     {  16:         await Task.Delay(1000);  17:     }  18: }&#xA;And then register it:&#xA;&#xA;&#xA;   1: DependencyResolver.SetResolver(type =&gt;   2:     {   3:         if (type == typeof (IAsyncActionInvoker))   4:             return new UnitOfWorkAsyncActionInvoker();   5:         return null;   6:     }, type =&gt; Enumerable.Empty&lt;object&gt;());&#xA;And you are golden. &#xA;Note: Except for doing a minimum of F5 in the debugger, I have neither tested nor verified this code. It appears to do what I want it to, and since I am only getting to this because a customer asked about this in the mailing list, that is about as much investigation time that I can dedicate to it.</p>
        </article>
        <article id="article-3992">
            <a href="https://ayende.com/blog/163169/maintaining-foreign-identifier-mapping-in-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-3992">Maintaining foreign identifier mapping in RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 26, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A fairly common question that gets ask is how to maintain identifiers between RavenDB and a secondary system. For this example, we will assume that we have a table in SQL Server that have a list of users. In SQL Server, we use a identity to identify the users. But in RavenDB we want to use different ids (maybe we want to have ids that are created only in RavenDB). That means that we have something like:  As you can see, users 1 &#x2013; 2 map to the same id in the RDBMS system, but users/3 was created in the RavenDB system, and the other users are on different ids. The question now becomes, how do you keep track of that, especially with regards to having updates later on. The easiest way to go about it would be to just keep the RDMBS id in the document, and query on that. That means that you need to query, and that subject to RavenDB BASE queries. So we want to try to do something better. We can just keep a document reference, so we could do something like Load(&#x201C;mapping/3&#x201D;) &#x2013;&gt; &#x201C;users/4&#x201D;. This means that we keep a document with the RDBMS&#xA0; id that just points to the actual user&#x2019;s document. That works, but that isn&#x2019;t very optimal. Mostly because you will need to do a lot of requests (or load a lot of documents) to get that working nicely in bulk scenarios. But that isn&#x2019;t the only option. Instead, you are going to use a document per 1000 ids. That would be called something like: &#x201C;mappings/1-1000&#x201D;, &#x201C;mappings/1001-2000&#x201D;, etc. The idea here is that we can load a single document, and get a thousand mapping all at once. Since we will usually be processing those values in order, this gives us a cheap way to preload stuff.</p>
        </article>
        <article id="article-3993">
            <a href="https://ayende.com/blog/163138/memory-mapped-files-file-i-o-performance" target="_blank">
                <h2 class="title mb-6" id="article-3993">Memory Mapped Files, File I/O &amp; Performance</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 23, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have been testing out several approaches for writing out to files. And I thought that the results are interesting enough to share. In all cases, I was writing a 128Kb buffer of random data to a file with size of 256Mb. The first thing that I wanted to try was the trivial managed memory map approach: using (var mmf = MemoryMappedFile.CreateFromFile(&quot;test.bin&quot;, FileMode.Create, &quot;test&quot;, 1024*1024*256))&#xA;{&#xA;    using (var accessor = mmf.CreateViewAccessor())&#xA;    {&#xA;        for (int i = 0; i &lt; accessor.Capacity; i &#x2B;= buffer.Length)&#xA;        {&#xA;            accessor.WriteArray(i, buffer, 0, buffer.Length);&#xA;        }&#xA;        accessor.Flush();&#xA;    }&#xA;}&#xA;&#xA;&#xA;This completed in 3.871 seconds.&#xA;Next, I Wanted to see what would happen if I were using direct memory access, and used CopyMemory to do that:&#xA;[DllImport(&quot;kernel32.dll&quot;, EntryPoint = &quot;RtlMoveMemory&quot;)]&#xA;static extern void CopyMemory(byte* dst, byte* src, long size);&#xA;&#xA;using (var mmf = MemoryMappedFile.CreateFromFile(&quot;test.bin&quot;, FileMode.Create, &quot;test&quot;, 1024*1024*256))&#xA;{&#xA;    using (var accessor = mmf.CreateViewAccessor())&#xA;    {&#xA;        byte* p = null;&#xA;        accessor.SafeMemoryMappedViewHandle.AcquirePointer(ref p);&#xA;        fixed (byte* src = buffer)&#xA;        {&#xA;            for (int i = 0; i &lt; accessor.Capacity; i &#x2B;= buffer.Length)&#xA;            {&#xA;                CopyMemory(p &#x2B; i, src, buffer.Length);&#xA;            }&#xA;        }&#xA;        accessor.SafeMemoryMappedViewHandle.ReleasePointer();&#xA;        accessor.Flush();&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;As you can see, this is somewhat more complex, and require unsafe code. But this completed in 2.062 seconds. Nearly twice as fast.&#xA;Then I decided to try with raw file IO:&#xA;using (var f = new FileStream(&quot;test.bin&quot;,FileMode.Create))&#xA;{&#xA;    f.SetLength(1024*1024*256);&#xA;    for (int i = 0; i &lt; f.Length; i &#x2B;= buffer.Length)&#xA;    {&#xA;        f.Write(buffer, 0, buffer.Length);&#xA;    }&#xA;    f.Flush(true);&#xA;}&#xA;&#xA;&#xA;This is about the most trivial code that you can think of, and this completed in about 1.956 seconds. Slightly faster, but within the margin of error (note, in repeated tests, they were consistently very close, and the file I/O was very near).&#xA;So, in other words, the accessor code adds a lot of overhead when using Memory Mapped Files.</p>
        </article>
        <article id="article-3994">
            <a href="https://ayende.com/blog/162917/some-final-notes-about-lmdb-review" target="_blank">
                <h2 class="title mb-6" id="article-3994">Some final notes about LMDB review</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 22, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, having gone through the LMDB codebase with a fine toothed comb, I think that I can safely say that it is both a very impressive codebase and one the dearly need some TLC. I&#x2019;ll freely admit that I am by no means a C guy. And it is entirely possible that a lot of the issues that I have been bugging me are standard C things. But I don&#x2019;t think so. Methods that go on for hundreds of lines, duplicated code and plethora of gotos hardly seem to be the things that pop to mind when I hear good C code. But beyond my issues with the code, the implementation is really quite brilliant. The way LMDB manages to pack so much functionality by not doing things is quite impressive. Interestingly, you couldn&#x2019;t write this database even 5 years ago. LMDB relies on being able to map the db into memory, and up until x64 became prevalent, you just couldn&#x2019;t do that for any db with a meaningful size. With x64 and the effectively unlimited address space we have (will I be laughing at my naivety in a few years?), that is no longer an issue. I learned quite a lot from the project, and it has been frustrating, annoying and fascinating experience.</p>
        </article>
        <article id="article-3995">
            <a href="https://ayende.com/blog/163489/re-how-memory-mapped-files-filesystems-and-cloud-storage-works" target="_blank">
                <h2 class="title mb-6" id="article-3995">re</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 21, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Kelly has an interesting post about memory mapped files and the cloud. This is in response to a comment on my post where I stated that we don&#x2019;t reserve space up front in Voron because we&#xA0; support cloud providers that charge per storage. From Kelly&#x2019;s post, I assume she thinks about running it herself on her own cloud instances, and that is what here pricing indicates. Indeed, if you want to get a 100GB cloud disk from pretty much anywhere, you&#x2019;ll pay for the full 100GB disk from day 1. But that isn&#x2019;t the scenario that I actually had in mind. I was thinking about the cloud providers. Imagine that you want to go to RavenHQ, and get a db there. You sigh up for a 2 GB plan, and all if great. Except that on the very first write, we allocate a fixed 10 GB, and you start paying overage charges. This isn&#x2019;t what you pay when you run on your own hardware. This is what you would have to deal with as a cloud DBaaS provider, and as a consumer of such a service. That aside, let me deal a bit with the issues of memory mapped files &amp; sparse files. I created 6 sparse files, each of them 128GB in size in my E drive.  As you can see, this is a 300GB disk, but I just &#x201C;allocated&#x201D; 640GB of space in it.   This also shows that there has been no reservation of space on the disk. In fact, it is entirely possible to create files that are entirely too big for the volume they are located on.  I did a lot of testing with mmap files &amp; sparseness, and I came to the conclusion that you can&#x2019;t trust it. You especially can&#x2019;t trust it in a cloud scenario. But why? Well, imagine the scenario where you need to use a new page, and the FS needs to allocate one for you. At this point, it need to find an available page. That might fail, let us imagine that this fails because of no free space, because that is easiest. What happens then? Well, you aren&#x2019;t access things via an API, so there isn&#x2019;t an error code it can return, or an exception to be thrown. In Windows, it will use Standard Exception Handler to throw the error. In Linux, that will be probably generate a SIVXXX error. Now, to make things interesting, this may not actually happen when you are writing to the newly reserved page, it may be deferred by the OS to a later point in time (or if you call msync / FlushViewOfFile).&#xA0; At any rate, that means that at some point the OS is going to wake up and realize that it promised something it can&#x2019;t deliver, and in that point (which, again, may be later than the point you actually wrote to that page) you are going to find yourself in a very interesting situation. I&#x2019;ve actually tested that scenario, and it isn&#x2019;t a good one form the point of view of reliability. You really don&#x2019;t want to get there, because then all bets are off with regards to what happens to the data you wrote. And you can&#x2019;t even do graceful error handling at that point, because you might be past the point. Considering the fact that disk full is one of those things that you really need to be aware about, you can&#x2019;t really trust this intersection of features.</p>
        </article>
        <article id="article-3996">
            <a href="https://ardalis.com/wiring-up-timeago-and-aspnet-mvc/" target="_blank">
                <h2 class="title mb-6" id="article-3996">Wiring Up TimeAgo and ASPNET MVC</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 20, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Imagine you want to display something on a page so that instead of raw dates, the user is shown something more relative to the current time&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-3997">
            <a href="https://ayende.com/blog/163009/b-trees-and-why-i-love-them-part-iii-in-page-additions-deletions-and-updates" target="_blank">
                <h2 class="title mb-6" id="article-3997">B&#x2B;Trees and why I love them, Part III&#x2013;in page additions, deletions and updates</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 20, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is more of less how a page is represented in memory.  There are a few things to note. The entries immediately following the page header points to the actual data at the end of the page. Why is that? Well, remember that we are working with a fixed size page. And we need to add data to the page in a sorted fashion, and do this cheaply. In order to do that, we always add the actual data at the end of the file, before any other data. When the page is empty, we add the value in the end. And the next value is immediately before the previous value, etc. However, as you can see in the image, the fact that we add values in a particular order doesn&#x2019;t mean that they are sorted in that order. In order to get good sorting, we keep a list of the entries offsets in the beginning of the page, just after the header. This is a sorted list, which gives us the ability to easy add / move an item in the page without actually moving the page, just by changing the offset position it is located on. If we would add another entry to this page, with the key C, the actual data would go on top of entry# 3. But the offset recording this entry would go between B &amp; A at the head of the page.  In other words, the actual data of the page grows upward, and the offsets pointing to the locations of entries in the page grows downward. A page is full when you can&#x2019;t fit the next data item and its offset in the space between the data &amp; the offsets. So that is addition. How about deletion. When we delete, we need to recover the space, but that is actually very easy to handle. Let us say that we want to delete the A entry. That means that we need to do the following. Move all the higher entries data downward to cover the space taken by the entry, and then update the offsets to reflect that. In the end, we are left with:  Updates work as a pair of delete/add operations, with some important edge cases. What happen if we have a page that is nearly full, and we want to update an entry that is bigger than it can currently hold? We have to check if the value is also too big if the previous value is removed. If not, we can fit it into the currently page. Otherwise, we would have to do a page split to accommodate it. Surprisingly enough, the code that is required to handle that is quite pretty, although the actual mechanism probably require a whiteboard to explain. And a lot of hand waving.</p>
        </article>
        <article id="article-3998">
            <a href="https://ayende.com/blog/162946/b-trees-and-why-i-love-them-part-ii-splitting-hairs-and-pages" target="_blank">
                <h2 class="title mb-6" id="article-3998">B&#x2B;Trees and why I love them, Part II &#x2013; splitting hairs (and pages)</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 19, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post, I gave a brief introduction about B&#x2B;Trees. Now I want to talk about a crucial part of handling them. Let us start with the basic, we have the following tree, which consist of a single page:  As you can imagine, attempting to add a single item to this page isn&#x2019;t going to happen (there isn&#x2019;t enough space), so we are going to have to something about it. That something is call page splitting. The easiest way to do that is to simply cut things in half, like so:  We have split the page, and now we are left with two pages that we can start writing to. Everyone is happy. Almost&#x2026; in this case, you can see that we are doing sequential inserts. So page #0 is never going to have any additional data written to it. That means that we are wasting half this page!   What I have done is to add just a tiny bit of smarts into the mix. Instead of doing a 50/50 split, we can detect if this is a sequential insert that is causing the split. If it is, we are going to split the data in a way that put more of it in the original page, like so:  We leave 85% of the data in the original page because that give some room to play with if one of the entries change there. This gives us a better page utilization in the common case of sequential inserts. But what about non sequential inserts? Well, if we detect that the page is being split because of a non sequential insert, we are going to do a 50/50 split, expecting that there would be additional non sequential inserts along the way. I am not sure how useful that would be, but it seems like something that could be a nice optimization for a common case, and it requires nothing else from the user, we can do it all on our own.</p>
        </article>
        <article id="article-3999">
            <a href="https://ayende.com/blog/162977/worlds-smallest-no-sql-database-persistent-data" target="_blank">
                <h2 class="title mb-6" id="article-3999">World&#x2019;s smallest No SQL Database: Persistent data</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 16, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The second item to go over with the World&#x2019;s smallest No SQL database is about persistence, and following that, I/O. Right now, there is no persistence. If you restart the process, all the data is gone. Now, there are actually quite a few real world dbs that behave in this fashion. But they are a rarity. For the most part, if I put data inside a db, I expect it to be there until I do something about it. And at that point, you are in for quite a bit of complexity. How are you going to persist the data? The easiest way to do it, just create a file per every value in the db is going to be&#x2026; problematic on most systems. So you need to put a lot of data in a small set of files. Which means that you have to decide how you are going to put the data together. In general, there is either the fixed size option, in which you divide the file(s) into pages and work around that. The good thing about this is that this gives you the ability to reuse space in the file after deletes / updates. The bad thing about that is that it is quite complex. Alternatively, you can just write the data out as needed, but then you can&#x2019;t really update written data, and would need to run compactions. And we haven&#x2019;t talked about searching yet. Some DBs, like Bitcask / Munin, would actually store the keys in memory, and store the position on the disk for retrieving the value. But for the most part, both keys &amp; values tend to be on disk in some form. In CouchDB, they are held inside an append only B&#x2B;Tree. In LevelDB, they are held in Sorted String Tables. LMDB uses Copy-On-Write B&#x2B;Tree. Esent use a B&#x2B;Tree with a Log file.  In each of those cases, the actual semantics for persistent data involve at least two concerns. You need to actually be able to search the data (that usually mean more than just O(1) access, you want to be able to go back &amp; forth on the keys) and you need to be able to do a transactional save. This is so you can recover&#xA0; in case of a crash, most of the time. But there are actually a lot more that goes into the selection of the proper persistence format. To start with, how you store the data on disk will have a big effect on your performance. If you store the data as a linked list, for example, you might as well kiss your performance goodbye. Beyond that, we also have issues with things like how is the format going to scale when we have concurrent readers. For example, if you have something that does a lot of seeks, and rely on the seeks always going forward to ensure performance, that is going to be very badly hit the moment that you have concurrent readers doing concurrent reads on different parts of the system. You would be forcing the system to do random seeks.  There are other considerations, as well. For example, if you are using something like B&#x2B;Tree, it is likely that you&#x2019;ll be overwriting the same section on the disk multiple times. That is fine with HDD, but SSD would just give up &amp; die on you at some point. And we haven&#x2019;t started talking about secondary indexes yet&#x2026;</p>
        </article>
        <article id="article-4000">
            <a href="https://ayende.com/blog/162945/b-trees-and-why-i-love-them-part-i" target="_blank">
                <h2 class="title mb-6" id="article-4000">B&#x2B;Trees and why I love them, part I</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 15, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that I enjoy about learning new things is the way it changes the way I look at the stuff that I already knows. Reading the LMDB codebase, and implementing a persistent B&#x2B;Tree has given me a new depth of understanding about how relational databases (and Esent, too), work. I am going to go back to level zero and assume that you have never heard about this. You probably know what a binary search tree is. And you know how they work. Here is such a tree:  Most tree algorithms spend a lot of time ensuring that the trees are balanced, because their most important property, O(log N) search performance, require that.&#xA0; Binary search trees seems ideally suitable for building databases ,since they allow speedy lookups and backward &amp; forward iteration through the data. Unfortunately, they suffer from a pretty crippling limitation. They have absolutely horrible performance when used in persistent medium. Let us assume that I have a file that contains the following information (Key, Left offset, Right offset). I could search through that file by just walking the links. That, however, would result quite terrible performance. Every time that we move between nodes, we have to do a seek, and that would kill any benefits we will gain from using binary search tree. Instead, we have a data structure that is aimed at reducing those costs. B&#x2B;Tree. On the face of it, B&#x2B;Tree is a truly stupidly simple idea. Instead of having just 2 items in the tree, left &amp; right, let us have more. Now, since B&#x2B;Trees are usually used in persistent format, we start out by defining pages. That is because if we want to do random I/O, we have to be able to write in pages to the file. Therefor, we usually talk about B&#x2B;Trees in terms of pages. Here is the above tree, rendered as a B&#x2B;Tree:  Since the data is small, it all fits into a single page. That means that you can read the entire page into memory, and then do a binary search on the data page cheaply. The page above uses a page size of 4,096, so it can contain about 200 entries (of the size we just put in, which are very small). What happens when we have more than that? We Split the page. The resulting data now looks like this (256 entries):  Now, if we want to do a search for key 152, we start by reading the root node, we can see that the page containing values greater than 102 is page 1, so we will go there. We read that, and do a binary search on the data to find our value. So that was two seeks to get the data. Instead of eight. And usually, the high level pages are already cached, so we would only need a single seek.&#xA0;  Let us see what happens when we put even more data in (512):  As you can see, we doubled the amount of information we store, but we remain at the same height. That is quite important, in order to get good performance from&#xA0; the disk. The usual fan out is about a 100, depending on your page size and the keys you selected. I played with the settings a a bit so you can get a good idea about what this look like when you have some more depth, I wrote the following code:     1: for (int i = 0; i &lt; 32; i&#x2B;&#x2B;)   2: {   3:     ms.Position = 0;   4:     for (int j = 0; j &lt; 32; j&#x2B;&#x2B;)   5:     {   6:         env.Root.Add(tx, string.Format(&quot;{0,5}&quot;, i&#x2B;j), ms);   7:     }   8: }&#xA;Which resulted in the following tree:&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;So far, so good, but this is actually the best case scenario. This is what happens when we are inserting data in a sequential manner. Let us mix things up a bit, okay? &#xA;&#xA;   1: for (int i = 0; i &lt; 16; i&#x2B;&#x2B;)   2: {   3:     ms.Position = 0;   4:     for (int j = 0; j &lt; 4; j&#x2B;&#x2B;)   5:     {   6:         env.Root.Add(tx, string.Format(&quot;{1,5}-{0,5}&quot;, i, j), ms);   7:     }   8: }&#xA;This code will generate values in effectively a random fashion, and you can see the impact it has on the tree:&#xA;&#xA;&#xA;&#xA;&#xA;&#xA;What happens is that we have had to insert data in a lot of places, which resulted in a lot of page splits, which increase the depth of the tree. Deeper trees means more operations required to actually get to the data on the leaf nodes. And yes, if you have a flash back to &#x201C;always use sequential ids&#x201D; section in RDMBS class, this is the reason why. &#xA;Now, I think that this is enough for now, I&#x2019;ll do some more talking about the subject in my next post.</p>
        </article>
        <div class="button flex justify-between">
            <a href="399.html"><span class="back arrow"></span></a>

            <a href="401.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>