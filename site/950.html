
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 950 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-9491">
            <a href="https://ayende.com/blog/1106/castle-demo-app-viewcomponents-security-filters-and-friends" target="_blank">
                <h2 class="title mb-6" id="article-9491">Castle Demo App</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 03, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post, I&#x27;m going to explain how to secure the administration section of the site. Since the pages in our application do not map to a directory structure on the server, the ASP.Net default security isn&#x27;t going to help us (I&#x27;m not entirely sure about this, though).     Because of the way that the MonoRail is built, we often can make security decisions about the all the actions in a controller. Such is the case with the AdminController, only administrators should be able to access this page. Currently, we don&#x27;t have the notion of an admin in the application, so we will need to add that as well.     We want to think about this for a minute, do we want a seperate page for login, or do we want to have a login box in every page? I think that we want a login box in every page, which can either display the Enter User and Password, or the currently logged on user. We can add it to the layouts, and then it will be seen in all the pages that belongs to this layout. But, we have multiply layouts in the application. Right now we have two of those, but we may have more in the future. So we can&#x27;t just put it in the layout.     If I was using ASP.Net, I could&#x27;ve created a control (or used a pre-built one). In MonoRail, this is called a ViewComponent, and we&#x27;ll build one in a few minutes. Just to note, in Brail, we can often just use a Common Script method, but because ViewComponents has access to MonoRail state, it&#x27;s often simpler to just use them when you need to access various parts of MonoRail. In this case, we need to determain if the user it logged on or not, so we&#x27;ll build a ViewComponent for this. Here is the code for the LoginComponent:             public class Login : ViewComponent                        {                        &#xA0;&#xA0;&#xA0; public override void Initialize()                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;user&quot;] = this.RailsContext.CurrentUser.Identity;                        &#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0; public override void Render()                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (this.RailsContext.CurrentUser.Identity.IsAuthenticated==false)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderView(&quot;Login&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderView(&quot;LoggedOn&quot;);                        &#xA0;&#xA0;&#xA0; }                        }                         We put the current user identity in the Flash on intialization (so the view can make use of it, if applicable), and when we render the control, we choose which view to render, the Login control, or the LoggedOn notification. If you are developing using the WebDev.WebServer, you already has Windows Authentication on, we want to disable that for this app (I want to show how we can build our own). You can disable Windows Authentication&#xA0;by updating the Web.Config file to include this little snippet.             &lt;system.web&gt;                        &#xA0;&#xA0;&#xA0;&#xA0; ...                 &lt;authentication mode=&quot;Forms&quot;/&gt;                        ...                        &lt;/system.web&gt;         A couple of things about ViewComponents, they are like tiny controllers, but they should be focused on doing spesific stuff, usually providing some sort of a all around service, like this login control. This is a way where you can still get the seperation of concerns that I like so much in MonoRail, and get functionality that can cut through all the layers of the application without breaking the design.     Now for the details, the views for a component are located on Views\Components\&lt;Component Name&gt;, and the default view for a component is Default.boo (no surprise here, sorry). So the Login view is located at Views\Componenets\Login\Login.boo, and looks like this:             ${HtmlHelper.Form(&#x27;/Home/AuthenticateUser.rails&#x27;)}                        ${HtmlHelper.FieldSet(&#x27;Login:&#x27;)}         &#xA0;                        &lt;table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;${HtmlHelper.LabelFor(&#x27;userName&#x27;,&#x27;Username:&#x27;)}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;${HtmlHelper.InputText(&#x27;userName&#x27;,&#x27;&#x27;)}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;${HtmlHelper.LabelFor(&#x27;password&#x27;,&#x27;Password:&#x27;)}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;${HtmlHelper.InputPassword(&#x27;password&#x27;)}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &lt;/table&gt;&#xA0;&#xA0;                        &#xA0;${HtmlHelper.InputHidden(&#x27;currentAction&#x27;, currentAction)}                &lt;p&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ${HtmlHelper.SubmitButton(&#x27;Login&#x27;)}                        &lt;/p&gt;                                                        ${HtmlHelper.EndFieldSet()}                        ${HtmlHelper.EndForm()}         Nothing much going here, we have a user and password fields, and we direct them to the AuthenticateUser action. The LoggedOn view is located at Views\Components\Login\LoggedOn.boo and is defined so:             ${HtmlHelper.FieldSet(&#x27;User Information:&#x27;)}                        &lt;table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr &gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;${HtmlHelper.LabelFor(&#x27;userNameLabel&#x27;,&#x27;Username:&#x27;)}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;${HtmlHelper.LabelFor(&#x27;userName&#x27;,user.Name)}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0; &lt;td&gt;${HtmlHelper.LinkTo(&#x27;Logout&#x27;,&#x27;home&#x27;,&#x27;logout&#x27;)}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &lt;/table&gt;                        ${HtmlHelper.EndFieldSet()}        Again, this is nothing new, just showing the user name and a logout link. Now, let&#x27;s add that to the Home layout (located at Views\Layouts\Home.boo), and edit it so it will look like this:             &lt;!DOCTYPE xhtml                        PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;                        &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;                        &lt;html&gt;                        &lt;body&gt;                        &lt;table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ${ChildOutput}                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td width=&quot;20%&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;?brail component Login ?&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &lt;/body&gt;                        &lt;/html &gt;                         (I hear the CSS Designers&#x27; League is on the lookout after me because of this series :-D). As you can see, we only need to specify which comonent we want, and that is it. We also need to make the same change to the Admin layout. Compile the application and point your browser to: http://localhost:8080/home/default.rails, here is how it looks like on my system:          Okay, we now have a login control, let&#x27;s put it to good use. We&#x27;ll add the Authenticate User action to the HomeController, but before we can do that we need to consider some design implications of this change. We will probably need to give the user some error message if they couldn&#x27;t login, but we already wrote that when we did the AdminController. I get the shakes when I see duplicate code, so we need to do a couple of things here, we need to make the GenericMessage view aviable to all the controllers in the application, and we probably want to make the RenderMessage() method accessible to the HomeController as well.     Well, a view is really something that is relevant for a single controller, but luckily for us, we don&#x27;t need to duplicate the view, since MonoRail has the notion of a Shared View. We need to move GenericMessage.boo from Views\Admin\ to Views\ (to make it visible for other controllers).     Now, we need to make RenderMessage() accessible for the HomeController. I choose to do this with Extract Base Class, and create the following class, which both AdminController and HomeController now inherits from:             public abstract class MythicalBugTrackerControllerBase : ARSmartDispatcherController                        {                        &#xA0;&#xA0;&#xA0; protected void RenderMessage(string nextActionText, string nextAction)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;nextActionText&quot;] = nextActionText;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;nextAction&quot;] = nextAction;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderSharedView(&quot;GenericMessage&quot;);                        &#xA0;&#xA0;&#xA0; }                        }                         This is an abstract class that inherits from ARSmartDispatcherController (which in turn inherits from SmartDispatcherController, so we get the nice features of being able to get real method parameters instead of unpacking the request parameters manually). Note that we are using RenderSharedView() to render GenericMessage. Another thing to note is that I belong to the school of thought that is not afraid of long class names.     It&#x27;s important to note that I&#x27;m wrapping the render view call with a method that make sure that the mandatory parameters are set. This ensure that I won&#x27;t forget to add a parameter and cause my view to throw an exception. I find that this works quite well to create an interface between my views and te controller. Now, we need to write the code that will handle the security infrastructure for the application. A couple of notes on that before we continue. This is what I call Reasonably Secured application, which means that it&#x27;s not easy to by-pass the security, but it&#x27;s not impossible. The security scheme I&#x27;m going to show you is vulnerable to attacks such as Man In The Middle and Cookies Replay. If you want true security, you need an expert. If you work in Israel, I can refer you to a superb expert in this field. Our bug tracking application isn&#x27;t important enough to make it truely secured (which take more than a bit of work), but we can make it reasonably secured, and I think that this would be enough in this case.     We&#x27;ll try to take advantage of as many features that ASP.Net provides us as possible, so we&#x27;ll start with making our User class implement IPrincipal, which just mean that we need these two methods:              public class User : ActiveRecordValidationBase&lt;User&gt;, IPrincipal                        {                        &#xA0; ....                &#xA0;     #region IPrincipal Members                        &#xA0;                        &#xA0;&#xA0;&#xA0; public IIdentity Identity                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return new GenericIdentity(Name, &quot;Mythical.Bug.Tracker.Authentication&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0; }                                &#xA0;                        &#xA0;&#xA0;&#xA0; //TODO: Add support for this later                        &#xA0;&#xA0;&#xA0; public bool IsInRole(string role)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return false;                        &#xA0;&#xA0;&#xA0; }                                &#xA0;                        &#xA0;&#xA0;&#xA0; #endregion                 &#xA0; ....                }        Right now we don&#x27;t offer roles, so we always return false (we might add roles later), and the Identity is just the generic identity. Now that we have an IPrinicpal, we can start implementing the login features, here is the Authenticate User method:              &#xA0;&#xA0;&#xA0; public void AuthenticateUser(string userName, string password, string currentAction)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; User user = User.FindUserByLogin(userName, password);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (user == null)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;bad&quot;] = &quot;User / Password mismatch&quot;;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderMessage(&quot;Back to home page&quot;, &quot;default&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AddAuthenticationTicket(user);                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Redirect(currentAction);                        &#xA0;&#xA0;&#xA0; }                     &#xA0;&#xA0;&#xA0; private void AddAuthenticationTicket(User user)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; FormsAuthenticationTicket ticket = new FormsAuthenticationTicket(1, user.Name,                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DateTime.Now, DateTime.Now.AddMinutes(20), false, user.Id.ToString());                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; string cookieValue = FormsAuthentication.Encrypt(ticket);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; this.Context.Response.CreateCookie(FormsAuthentication.FormsCookieName, cookieValue,                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DateTime.Now.AddMinutes(20));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; this.Context.CurrentUser = user;                        &#xA0;&#xA0;&#xA0; }        We are doing a couple of cool things here. We start by trying to find a user by its name and password, if we can&#x27;t find it, we send the user to the error page. If we do find a user, we create an authentication ticket for this user (using the pre-existing Froms Authentication in ASP.Net), encrypt it, and store it in a cookie. A couple of points before moving on:             Because we are using the existing support in ASP.Net, we saved a whole lot of coding that we may have had to do.                 We also do here is replace the current user, this is needed so anything that queries the current user in this request (such as the Login component) will recognize the user that just logged in.                 Notice that the cookie is encrypted and hashed, which means that it&#x27;s not likely that someone could tamper with our cookie. This is important, since it means that when we get the cookie back, we can rely on its contents (but only if they pass decryption and checks, of course).                 Since the Authenticate view doesn&#x27;t have any UI to display, we call the Default() method (which push some parameters for the view to handle) and then specify that we want to use the Default view. It&#x27;s very easy to do this kind of switching, since we are dealing with the same object, and not another page, which requires some coordination between classes. The only thing that I needed to to support this was to add a call to RenderView(&quot;Default&quot;) in the Default() method, so the correct view will be rendered, even if we are calling it from another action.         Now that we have an encrypted cookie on the client, let&#x27;s see how we handle the authentication on the next request. We do this by hooking the AuthenticateRequest event in MythicalBugTrackerApplication.&#xA0;The code that does the check is here:             &#xA0;&#xA0;&#xA0; void MythicalBugTrackerApplication_AuthenticateRequest(object sender, EventArgs e)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; HttpCookie cookie = Request.Cookies.Get(FormsAuthentication.FormsCookieName);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (cookie == null)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; int id = GetUserId(cookie);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Model.User current = Model.User.TryFind(id);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (current == null)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; //This means that we&#x27;ve a cookie for a user that has been removed, we&#x27;ll                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; //remove the cookie and redirect to the default page, if the user will                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; //try to log in again, they will get the usual message, and then it is                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; //the IT problem.                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RemoveAuthCookieAndRedirectToDefaultPage();                        &#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0;&#xA0;}                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Context.User = current;                        &#xA0;&#xA0;&#xA0; }         We get the cookie from the incoming request, and send it to the GetUserId() method (which we&#x27;ll see in a few seconds). Then we take the user id and try to get the matching user. If the user exists, then we set the Context.User property to this user (which we can do because our User implements IPrincipal). It&#x27;s possible that the user does not exist (it may have been removed, for instance), so we handle that be removing the authentication cookie and redirecting to the default page. We now have authentication working for our app. Now, let&#x27;s see some of the details:             &#xA0;&#xA0;&#xA0; private int GetUserId(HttpCookie cookie)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; try                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; FormsAuthenticationTicket ticket = FormsAuthentication.Decrypt(cookie.Value);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return int.Parse(ticket.UserData);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; catch (ArgumentException ae)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; logger.ErrorFormat(        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &quot;A possible hack attempt, got an invalid cookie value: &#x27;{0}&#x27; from {1}&quot;,                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; cookie.Value, Request.UserHostAddress);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; //Somebody tried to mess with the cookie, could be a hacker or transimission                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; //failure, we&#x27;ll remove the cookie and send them to the default page.                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RemoveAuthCookieAndRedirectToDefaultPage();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return -1;//will never reach here, the previous method will abort the thread                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0; }         Most of this method is error handling, but basically what happens here is that the cookie in decrypted, and then the id we put there is extracted and returned. The interesting part is the error handling. It&#x27;s possible that the Decrypt() method (or the Parse(), for that matter) will throw, and in this case, it is most likely a hacker tampering with the cookie. We log the error and then remove the cookie and redirect to the default page in this case. The thinking here is that it may be a transmission error, and anyway, we don&#x27;t want to provide any information to the hackers (even something like; &quot;modifed cookie values found, kicking you out&quot; is giving away too much information.) For completeness sake, here it the RemoveAuthCookieAndRedirectToDefaultPage() method:             &#xA0;&#xA0;&#xA0; private void RemoveAuthCookieAndRedirectToDefaultPage()                        &#xA0;&#xA0;&#xA0; {        &#xA0;        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; FormsAuthentication.SignOut();                                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Response.Redirect(&quot;/home/default.rails&quot;, true);                        &#xA0;&#xA0;&#xA0; }         One thing that you need to pay attention to here, we are not using the MonoRail API here, but the ASP.Net ones. This is because we want MonoRail to get the request with the current user already set, and this is still too early in the request pipeline for MonoRail to take over.    So, we now have a way to login a user, and a way to authenticate a logged in user on the next request, we need two more things before we can say that the security part of the application is complete. The first thing is to allow a user to log out, and to make sure that only authorized users can access the administrators section.     We&#x27;ll start by creating the Logout functionality, since this one is very simple.             &#xA0;&#xA0;&#xA0; public void Logout()                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; FormsAuthentication.SignOut();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Redirect(&quot;home&quot;, &quot;default&quot;);                &#xA0;&#xA0;&#xA0; }    We remove the cookie from the user and redirect to the default page. Now, let&#x27;s implement security for the administration section. At this point, all we want to achieve is to allow only authenticated users to access thos pages. We will do this with a Filter. A Filter is a wrapper around a request, which can do action for the request. Here is our authentication filter:            public class AuthenticationFilter : IFilter                        {                        &#xA0;&#xA0;&#xA0; public bool Perform(ExecuteEnum exec, IRailsEngineContext context, Controller controller)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (context.CurrentUser == null || context.CurrentUser.Identity.IsAuthenticated == false)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; context.Response.Redirect(&quot;home&quot;, &quot;default&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return false;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0;&#xA0;return true;                        &#xA0;&#xA0;&#xA0; }                        }                        It simply checks to see if you are authenticated, and if not, kicks you back to the home page. Now we need to integrate it with the AdminController, this is done by specifying this attribute:            [Filter(ExecuteEnum.BeforeAction, typeof(AuthenticationFilter))]                        public class AdminController : MythicalBugTrackerControllerBase        This is it, we have now secured the administration section, only authenticated users will be able to access those parts now. As I mentioned, this is reasonable security, but if we deal with sensitive data, or mission critical operations, it&#x27;s not good enough. In those cases, you want to run the sensitive sections of your site on SSL, and have a full security audit before you go live.    Well, that was a long one. I hope that you&#x27;re following, since there are still more to come (here is the non-complete, totally random list):            Tests! Tests! Tests!            Personalization            Roles            Handling exceptions            Actually writing the Submit Bug page.            Complex searches using Active Record            Mitigating Cross Site Scripting Attacks            Sending Emails            Thinking about Castle    In the meantime, I realized that I forgot to give the urls for you to check what is happening. I&#x27;m sure you figured them out, but here are the usable entry points into the application, for reference:            http://localhost:8080/admin/Projects.rails            http://localhost:8080/admin/users.rails            http://localhost:8080/admin/index.rails            http://localhost:8080/home/default.rails    You can get the application here.</p>
        </article>
        <article id="article-9492">
            <a href="https://ayende.com/blog/1105/merging-net-1-1-and-2-0-code-or-abusing-the-type-system" target="_blank">
                <h2 class="title mb-6" id="article-9492">Merging .Net 1.1 and 2.0 code, or abusing the type system...</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 02, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you&#x27;ve a code that you want to use for .Net 1.1, but still use features from .Net 2.0 (because they are such fun), you usually end with a bunch of #ifdef all over the place, or you create a second class and delegate functionality. It occured to me that C# allows a funky way to combine this functionality without too much bother.    The idea is only applicable where you&#x27;ve a class that you want to be generic in .Net 2.0, and use System.Object on 1.1, this is the case in quite a bit of scenarios, actually. Here is the code:            #if !dotNet2                        using T = System.Object;                        #endif                                &#xA0;                        public class FunkyClass                                 #if dotNet2&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0; &lt;T&gt;                                 #endif                        {                        &#xA0;&#xA0;&#xA0; T _item;                                &#xA0;                        &#xA0;&#xA0;&#xA0; public T Item                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get { return _item; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; set { _item = value; }                        &#xA0;&#xA0;&#xA0; }                                &#xA0;                        &#xA0;&#xA0;&#xA0; public FunkyClass(T item)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; this._item = item;                        &#xA0;&#xA0;&#xA0; }&#xA0;&#xA0;                                 }        This relies on a aliasing the System.Object type to T, so your code can refer to T, and it will mean either System.Object ( in 1.1 ) or the generic type ( in 2.0 ).</p>
        </article>
        <article id="article-9493">
            <a href="https://ayende.com/blog/1104/embarrassing-moments" target="_blank">
                <h2 class="title mb-6" id="article-9493">Embarrassing Moments</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 02, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Sometimes I make mistakes that has no reason whatsoever. It&#x27;s like I developed a sudden blank spot in a particular area for a while. I had a piece of code similar to this one (PL/SQL, nonesense code):            for rec0 in sql_data&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if rec0.Status == 3 then&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; v_Foo = rec.Foo                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; end if;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; open bar                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; loop exit when NO_DATA_FOUND                 &#xA0;&#xA0;fetch v_bar into v_Da                 update Fubars                                 SET Foo = v_Foo &#x2B; rec0.Bar &#x2B; v_Da                where rec0.rowid = rec0.rowid                                &#xA0;                        end loop;                        end loop;        I, and two developers with quite a bit of expeirance in Oracle couldn&#x27;t figure what this does. Oh, we knew what the code is doing, but no how it was doing it. The issue was with the identing of the code (which was worse in the original code). It took a trip to the help files to find out what is going on.    In the meantime this actually started an escelation procedure. Luckily it was caught in time (not by me, by the way), and then we had a good laugh about how blind we were. I would hate to see the look on the face of the expert we would&#x27;ve shown this to (or to think about approaching him ever again...).</p>
        </article>
        <article id="article-9494">
            <a href="https://ayende.com/blog/1103/the-space-shuttle-and-the-width-of-a-horse-ass" target="_blank">
                <h2 class="title mb-6" id="article-9494">The Space Shuttle And The Width Of A  Horse Ass</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 01, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This post&#xA0;is a killer. Sahil explains the relationship between the Space Shuttle and the width of a horse ass. It is incredeibly funny post, go check it out. (Oh, and next time that the software chagne, don&#x27;t complain about it.)</p>
        </article>
        <article id="article-9495">
            <a href="https://ayende.com/blog/1102/reading-the-logs" target="_blank">
                <h2 class="title mb-6" id="article-9495">Reading the logs</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 01, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I spent a couple of minutes now going over the logs, it&#x27;s quite amazing what you can find there. It looks like my posts about Brail started a bit of interest, since I suddenly started to see searches for information about it.&#xA;Another interesting things is that I started to get a lot more readers ~2,800 a day in the browser, and ~1,300 a day from RSS aggerators. I&#x27;m not using those numbers for their numeric values, since they don&#x27;t really mean much by themselves, but it&#x27;s interesting about 1,000 more readers via the browser, and ~700 more in RSS.</p>
        </article>
        <article id="article-9496">
            <a href="https://ayende.com/blog/1101/things-i-have-learned-today" target="_blank">
                <h2 class="title mb-6" id="article-9496">Things I have learned today</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 01, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Random thoughts about today, no real content:&#xA;&#xA;Copying gigabytes of data is going to take a long time.&#xA;Debugging Brail is fun, you get to play the &quot;Who exactly changed this bit&quot; game, where you have the pre processor, Brail&#x27;s compiler extentions and Boo&#x27;s magic all mixing together to a complete whole.&#xA;It&#x27;s not good to save dynamic assemblies to the bin directory of an ASP.Net application, the application will reset itself on each request. It make debuging sort of hard, I heard.&#xA;Causing your head to impact the wall at high speed hurts. And it also attracts some funny glances. What is up with those people?&#xA;It&#x27;s actually a joy to work with Brail on a project, I get to remember all my previous design decisions, and I don&#x27;t have anyone to blame. It&#x27;s an interesting spot for me, since I usually blame Microsoft and/or Oracle.&#xA;Linking SQL Server to Oracle requires black magic and a couple of chickens. SQL Server will flat out refuse to read a perfectly innocent table from Oracle, but for some reason readily agree to read the same table when piped through a view.&#xA;One off solutions aren&#x27;t.&#xA;SQL Server has a lot of different errors messages, I&#x27;m going to switch the language settings to Japanese and enjoy the pretty pictures in red brush.&#xA;Physical violance against machines works.&#xA;You can be agile when fixing errors. See: iterational error reduction (First iteration, 300 errors, second iteration, 150 errors, third iteration 140 errors, etc).&#xA;A run-check cycle of ~3 - 8 hours really sucks.&#xA;The varchar &#x27;000&#x27; is an invalid number, even when you try to get it as a varchar, but only when the moon is full and when you back is turned.&#xA;Relying of reference equality to manage syncronizations between objects can bite you in the ass.</p>
        </article>
        <article id="article-9497">
            <a href="https://ayende.com/blog/1100/i-love-being-pwop-ambassador" target="_blank">
                <h2 class="title mb-6" id="article-9497">I Love Being Pwop Ambassador!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 01, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you&#x27;re not familiar with the term, Pwop Ambassadors are geeks that donate bandwidth to distribue the files that Pwop&#xA0;produce using bittorrent. And Pwop is the company that produce shows like:            Dot Net Rocks                Mondays                Hanselminutes                Dnr TV        This means that I spent a couple of hours setting it up, and now whenever I see an annoucement for a new show being released, I can head to my Hard Disk, and voila, it is there already. Talk about immediate gratification.    In return, I&#x27;m sharing those files, of course, so this mean that if you are in Israel, you really should try downloading those shows (all of them are excellent, by the way) via BitTorrent, since you&#x27;ve a local source nearby, serving them.</p>
        </article>
        <article id="article-9498">
            <a href="https://ayende.com/blog/1099/castle-demo-app-code-update" target="_blank">
                <h2 class="title mb-6" id="article-9498">Castle Demo App</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 01, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x27;ve updated the code that is avialable. Now I also bundle the parts of Castle that you need in order to run it, so you will have easier time build and testing this code. All the binaries you need can be found in the Deps directory, you&#x27;ll need to change the references to point to that directory. You will also need SQL Server or SQL Express for the database, as well as .Net 2.0.    You can get the new release here&#xA0;(1.2Mb).</p>
        </article>
        <article id="article-9499">
            <a href="https://ayende.com/blog/1098/castle-demo-app-queries-and-foreign-keys" target="_blank">
                <h2 class="title mb-6" id="article-9499">Castle Demo App</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 01, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, one thing that I&#x27;m sure that you have&#xA0;noticed is that we have a bug in the DeleteUser method. The problem is that we don&#x27;t check for foreign keys violations, and that will cause problems down the road (someone tries to delete a user that is assigned to a project, and he suddenly stares at an error page asking &quot;But what did I do?&quot;     Let&#x27;s try to prevent it before we get a bug report about it. First, we need to make a couple of policy decsisions. There are two ways that a user can be attached to a project. Either the user is&#xA0; the default assignee, or he is assigned to the project. From my perspective it&#x27;s perfectly fine to delete a user if he is assigned to a project, the assignment to the project should just go away, but it&#x27;s bad to remove a user that is the default assignee of a project.     How do I do this? When we first defined the relationship between users and projects, I decided that the class that should be responsible for maintain the association between the objects would be Project class. Because of this, we defined the Projects as the ones responsible for the connection. This ensure that the association is managed properly (otherwise you might get into a case when you save both the user and the project, and each tries to update the same association, which is a waste at best, and can be dangerous at worst.    Because of that, we will not instruct Active Record to deal with that, but do it manually, and here is the result:            &#xA0;&#xA0;&#xA0; public void DeleteUser([ARFetch(&quot;id&quot;)]User user)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (user == null)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderView(&quot;NoSuchUser&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (AssertUserIsNoDefaultAssigneeInAnyProjecT(user)==false)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; user.Projects.Clear();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; user.Delete();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RedirectToAction(&quot;Users&quot;);                        &#xA0;&#xA0;&#xA0; }        As you can see, we Clear() the Projects collection before we delete the user, and that is all. Active Record takes care of the rest.    Now to the AssertUserIsNoDefaultAssigneeInAnyProject() method:                private bool AssertUserIsNoDefaultAssigneeInAnyProject(User user)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Project[] projectsUserIsDefaultAssigneeIn = Project.FindAll(Expression.Eq(&quot;DefaultAssignee&quot;, user));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (projectsUserIsDefaultAssigneeIn.Length &gt; 0)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; List&lt;string&gt; names = new List&lt;string&gt;();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Array.ForEach(projectsUserIsDefaultAssigneeIn,                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; delegate(Project project) { names.Add(project.Name); });                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;bad&quot;] = string.                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Format(&quot;User {0} is the default assignee for {1}, and so cannot be deleted&quot;,                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; user.Name,                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; string.Join(&quot;,&quot;,names.ToArray()));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderView(&quot;GenericMessage&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return false;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return true;                        &#xA0;&#xA0;&#xA0; }                                                    &#xA0;        We ask to get all the projects where this user is the default assignee. We don&#x27;t deal with SQL, or need to pass the correct Id, or anything like this. We just tell Active Record, &quot;give me all the projects where this user is the default assignee&quot;. This is one of the main reasons I like Active Record so much.    We then unpack the projects names to an array, and tell the user he can&#x27;t delete a user that is the default assignee in a project (we also tell him what the projects are, which would save some frustrations in the future).    This is it, we solved the problem.    But wait, we have another problem, again with users. The problem is with the password field. If the user doesn&#x27;t change it, it&#x27;s set to the default &quot;Dummy Password&quot;, which is probably not a good thing. Let&#x27;s see how we can fix it.    First, we remove the &quot;Dummy Password&quot; default from the view, and leave it with an empty password (this will make it easy afterward to tell whatever the user changed the password.    Then, we change the SaveUser() method to this:            &#xA0;&#xA0;&#xA0; public void SaveUser(                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; [ARDataBind(&quot;user&quot;, AutoLoadUnlessKeyIs = 0,                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Exclude=&quot;Password&quot;)] User user)                        &#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderMessage(&quot;Back to Users&quot;, &quot;Users&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; try                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; string pass = Request.Params[&quot;user.Password&quot;];                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (string.IsNullOrEmpty(pass) == false)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; user.Password = pass;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; user.Save();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;good&quot;] = string.Format(                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &quot;User {0} was saved successfully.&quot;, user.Name);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; catch (Exception e)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;DataBindErrors&quot;] = user.ValidationErrorMessages;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;bad&quot;] = e.Message;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0; }        The only interesting thing here is the Exclude, where we tell Active Record to not set the Password property. We then manually get the value, check if it is not empty and if it is not, set the password.</p>
        </article>
        <article id="article-9500">
            <a href="https://ayende.com/blog/1097/update-complete" target="_blank">
                <h2 class="title mb-6" id="article-9500">Update Complete</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 01, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, I seem to have gone out of it fine, I made a mistake that caused the admin interface to blow up, but that wasn&#x27;t exposed to users ( I hope).    Anyway, this site is now on Cuyahoga 1.0, if case anyone cares. This means that my own site is being driven by NHibernate.</p>
        </article>
        <div class="button flex justify-between">
            <a href="949.html"><span class="back arrow"></span></a>

            <a href="951.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
