
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 603 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-6021">
            <a href="https://ayende.com/blog/4053/avoid-externalizing-decisions-from-your-domain-model" target="_blank">
                <h2 class="title mb-6" id="article-6021">Avoid externalizing decisions from your domain model</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 09, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I recently saw an entity that looked something like this:          public class Prisoner&#xA;{&#xA;    public virtual bool CanBePutInIsolation() { ... }&#xA;    public virtual bool IsEligibleForVacations() { ... }&#xA;    public virtual bool CanSendToWork() { ... }&#xA;}&#xA;  &#xA;&#xA;&#xA;I won&#x2019;t show the logic in those methods, but it was fairly involved and very business focused. It is also, incidentally, caused my rhino sense to tingle. It didn&#x2019;t surprise me to find out that the UI looked like this:&#xA;&#xA; &#xA;&#xA;Well, the logic is well encapsulated, and it clearly is business logic. Why should I care where I am actually putting it? Isn&#x2019;t the place of domain logic in the&#x2026; domain?&#xA;&#xA;Yes &amp; no. The problem that I have here is that those are query methods that are only going to be used in the UI. There is no business logic in the application that actually uses them, it is only the UI that will call them to make presentation decisions.&#xA;&#xA; There are actually several issues here, first, and I want to make it clear, this is not an issue of mixing presentation logic in the entities. Next, and the reason that my rhino sense tingled is the presence of a Boolean query method&#xA0; on the entity. Every time that I see one I become very suspicious. Boolean methods worry me because of their implications. If you have a Boolean method here, it means that somewhere else you have an if statement that works based on this method.&#xA;&#xA;And at that point, you really have to ask yourself if this is an appropriate decision to make. Usually, I find, you can avoid it by moving the responsibility into the domain. But what about this case? I can&#x2019;t really move the responsibility for creating the UI into the entity, after all. And somewhere in the application I must have this knowledge so I can build my UI. &#xA;&#xA;I am not going to try to answer this question at this moment. I have my own thoughts about the subject, but I would like to have additional feedback about this from the community.</p>
        </article>
        <article id="article-6022">
            <a href="https://ardalis.com/speaking-in-cleveland-and-ann-arbor-this-week/" target="_blank">
                <h2 class="title mb-6" id="article-6022">Speaking in Cleveland and Ann Arbor this week</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 08, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This week I&#x2019;ll be presenting my TechEd session on SOLIDifying ASP.NET MVC applications to the Cleveland .NET SIG in Independence and the Ann&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-6023">
            <a href="https://ardalis.com/dry-&#x2013;-don&#x2019;t-repeat-yourself-&#x2013;-motivator/" target="_blank">
                <h2 class="title mb-6" id="article-6023">DRY &#x2013; Don&#x2019;t Repeat Yourself &#x2013; Motivator</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 08, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;ve been meaning to create a DRY (Don&#x2019;t Repeat Yourself) motivational poster for a while now, ever since seeing Derick Bailey&#x2019;s SOLID&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-6024">
            <a href="https://ayende.com/blog/4052/analyzing-a-performance-problem-is-a-prisoner-dangerous" target="_blank">
                <h2 class="title mb-6" id="article-6024">Analyzing a performance problem &#x2013; Is a prisoner dangerous?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 08, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Recently I run into a performance problem in an application that I was reviewing, and I thought that it would make a great post. Since I can&#x2019;t use the actual application model, I decided that I am tired of using the same old online shop model and turned to the one domain in which I am a domain expert. Prisons.  Let us imagine that this is part of the Prison 10&#x2019;s* Dashboard. It looks pretty simple, right?     Let us talk about this as SQL, ignoring all layers in the middle. We can express this as:          SELECT TOP 10 Prisoner.Id, Prisoner.FirstName, Prisoner.LastName, Prisoner.Status&#xA;FROM Prisoner JOIN Imprisonment on Prisoner.Id = Imprisonment.Prisoner&#xA;WHERE Imprisonment.Prion = 6 AND Imprisonment.IsCurrent = 1&#xA;ORDER BY Imprisonment.ArrivalDate DESC&#xA;  &#xA;&#xA;&#xA;Seems simple enough, right? But notice that we don&#x2019;t have Prisoner.Dangerous column on the result. That is because there is no such column in the table. So what does our good developer do? He goes to the domain expert and ask him where he is supposed to get the data from. The domain expert answer is that this is not an attribute of the prisoner itself, it is a decision based on many factors, any of which can flag a prisoner as a dangerous. He then gives the developer a list of the few common ones:&#xA;&#xA;&#xA;  If the prisoner is not convicted&#xA;&#xA;  If the prisoner has a disciplinary notice in the last 2 months&#xA;&#xA;  If the prisoner has more than one disciplinary notice in the last 6 months&#xA;&#xA;  If the prisoner is charged with violent crime&#xA;&#xA;  If the prisoner is currently in withdrawal&#xA;&#xA;  If the prisoner request for vacation was denied in the last 3 months&#xA;&#xA;&#xA;As you can see, the list goes on (and on, and on). Our developer starts working on the problem. Since he is working on a small local database, he is starting out with a spike of everything as in memory filters. It is beautifully Object Oriented, and it looks like this:&#xA;&#xA;&#xA;  &#xA;    public class NotConvicted : IPrisonerDangerousEvaluator&#xA;{&#xA;    public bool Eval(Prisoner p)&#xA;    {&#xA;        return p.Status != PrisonerStatus.Convicted;&#xA;    }&#xA;}&#xA;&#xA;public class DisciplinaryNoticeInLast2Months : IPrisonerDangerousEvaluator&#xA;{&#xA;    public bool Eval(Prisoner p)&#xA;    {&#xA;        return p.DisciplinaryNotices&#xA;                .Any(x=&gt;x.Date &gt; DateTime.Today.AddMonths(-2));&#xA;    }&#xA;}&#xA;&#xA;public class MorethanOneDisciplinaryNoticeInLast6Months : IPrisonerDangerousEvaluator&#xA;{&#xA;    public bool Eval(Prisoner p)&#xA;    {&#xA;        return p.DisciplinaryNotices&#xA;                .Where(x=&gt;x.Date &gt; DateTime.Today.AddMonths(-6))&#xA;                .Count() &gt; 1;&#xA;    }&#xA;}&#xA;&#xA;public class ChargedWithViolentCrime : IPrisonerDangerousEvaluator&#xA;{&#xA;    public bool Eval(Prisoner p)&#xA;    {&#xA;        return p.Charges&#xA;                .Any(x=&gt;x.ChargeStatus.IsViolent);&#xA;    }&#xA;}&#xA;&#xA;public class CurrentlyInDrugWithdrawal : IPrisonerDangerousEvaluator&#xA;{&#xA;    public bool Eval(Prisoner p)&#xA;    {&#xA;        return p.MedicalRecord&#xA;                .Withdrawals&#xA;                .Any(x=&gt;x.IsCurrent);&#xA;    }&#xA;}&#xA;&#xA;public class VacationRequestDeniedInLast3Months : IPrisonerDangerousEvaluator&#xA;{&#xA;    public bool Eval(Prisoner p)&#xA;    {&#xA;        return p.Requests&#xA;                .Where(x=&gt;x.RequestType == RequestType.Vacation &amp;&amp; x.Date &gt; DateTime.Today.AddMonths(-3))&#xA;                .Any(x=&gt;x.Status.Approved == false);&#xA;    }&#xA;}&#xA;  &#xA;&#xA;&#xA;Now, this works, and from OO perspective, it works just great. From a performance perspective, this is horrible. Let us do the math of how many queries this is going to generate, oaky?&#xA;&#xA;&#xA;  Get all prisoners &#x2013; 1&#xA;&#xA;  &#xA;    For each prisoner &#x2013; N(Prisoners)&#xA;&#xA;    &#xA;      NotConvicted &#x2013; 0 (load data in the prisoner entity, which was already loaded)&#xA;&#xA;      DisciplinaryNoticeInLast2Months &#x2013; 1 (load DisciplinaryNotices)&#xA;&#xA;      MorethanOneDisciplinaryNoticeInLast6Months &#x2013; 0 (DisciplinaryNotices already loaded)&#xA;&#xA;      ChargedWithViolentCrime &#x2013; 1 (load Charges)&#xA;&#xA;      CurrentlyInDrugWithdrawal &#x2013; 2 (load Medical Record, load Withdrawals)&#xA;&#xA;      VacationRequestDeniedInLast3Months &#x2013; 2 (load Requests, load Status)&#xA;    &#xA;  &#xA;&#xA;&#xA;This isn&#x2019;t SELECT N&#x2B;1 ! This is so much worse. What we have is actually: SELECT 1 &#x2B; N(1&#x2B;1&#x2B;2&#x2B;2)&#xA;&#xA;Or, in other words, assuming we want to display the first ten inmates, showing that little grid up above is going to result in 41 queries!&#xA;&#xA;This actually show us several important worst practices:&#xA;&#xA;&#xA;  In memory filtering should be avoided if possible.&#xA;&#xA;  Trying to ignore the realities of data access is going to bite you, hard.&#xA;&#xA;  There is a good reason for the call for aggregate roots and the avoidance of highly connected object graphs.&#xA;&#xA;&#xA;So, what is the obvious approach? We can change the way that we load the data. Instead of trying to go through the object model, we can query the data directly from the database. It is going to look something like this:&#xA;&#xA;&#xA;  &#xA;    SELECT TOP 10 Prisoner.Id, Prisoner.FirstName, Prisoner.LastName, Prisoner.Status,&#xA;(&#xA;    SELECT 1 &#xA;    WHERE Prisoner.Status != &#x27;Convicted&#x27;&#xA;    OR EXISTS (SELECT 1 FROM DisciplinaryNotices &#xA;        WHERE DisciplinaryNotices.Prisoner = Prisoner.Id&#xA;        AND   DisciplinaryNotices.Date &gt; getdate()-60)&#xA;    OR 1 &lt; (SELECT COUNT(*) FROM DisciplinaryNotices &#xA;        WHERE DisciplinaryNotices.Prisoner = Prisoner.Id&#xA;        AND   DisciplinaryNotices.Date &gt; getdate()-180)&#xA;    OR  EXISTS (SELECT 1 FROM Charges&#xA;        WHERE Charges.Prisoner = Prsioner.Id&#xA;        AND Charges.IsViolent = 1)&#xA;    OR  EXISTS (SELECT 1 FROM MedicalRecords JOIN Withdrawals ON MedicalRecords.Id = Withdrawal.Record&#xA;        WHERE MedicalRecords.Prisoner = Prisoner.Id&#xA;        AND Withdrawal.IsCurrent = 1)&#xA;    OR  EXISTS (SELECT 1 FROM Requests JOIN RequestsStatus ON Requests.Id = RequestsStatus.Request&#xA;        WHERE Requests.Prisnoer = Prisoner.Id&#xA;        AND   Request.Date &gt; getdate() - 90&#xA;        AND   RequestsStatus.Approved = 0&#xA;        AND   Request.Type = &#x27;Vacation&#x27;)&#xA;) as Dangerous &#xA;FROM Prisoner JOIN Imprisonment on Prisoner.Id = Imprisonment.Prisoner&#xA;WHERE Imprisonment.Prion = 6 AND Imprisonment.IsCurrent = 1&#xA;ORDER BY Imprisonment.ArrivalDate DESC&#xA;  &#xA;&#xA;&#xA;From the point of view of database access, we are in a much better position, we now have only a single query to execute. For that matter, we can change the IPrisonerDangerousEval to perform their evaluation in the database, retaining the nice OO model that we have. It would look something like this:&#xA;&#xA;&#xA;  &#xA;    public class NotConvicted : IPrisonerDangerousEvaluator&#xA;{&#xA;    public void AddSelectionCriteria(DetachedCriteria crit)&#xA;    {&#xA;        return crit.Add(Restrictions.NotEq(&quot;Status&quot;, PrisonerStatus.Convicted));&#xA;    }&#xA;}&#xA;&#xA;public class DisciplinaryNoticeInLast2Months : IPrisonerDangerousEvaluator&#xA;{&#xA;    public void AddSelectionCriteria(DetachedCriteria crit)&#xA;    {&#xA;        return crit.CreateCriteria(&quot;DisciplinaryNotices)&#xA;                   .Add(Restrictions.Gt(&quot;Date&quot;, DateTime.Today.AddMonths(-2)));&#xA;    }&#xA;}&#xA;  &#xA;&#xA;&#xA;Note, doing something like this require a fairly interesting infrastructure, to make sure that the results are consistent and each rule isn&#x2019;t stepping on its other toes.&#xA;&#xA;Problem solved? &#xA;&#xA;Not&#x2026; really.&#xA;&#xA;Take a look at the SQL that we have above. This query is hitting 8 tables, and please remember that I explicitly stated that I kept the number of things that make a prisoner dangerous limited, there are about forty rules relating to this, not half a dozen. But even with just half a dozen, trying to optimize the above query is going to be&#x2026; problematic.&#xA;&#xA;This is where we figure out something really interesting. In most systems, the number of reads far outweigh the number of writes. The most basic optimization that we can do is move work from the read phase of the application to the write phase, since it is going to execute so much less often.&#xA;&#xA;It seems like it would be a very simple solution for the application to execute the rules on save and set the IsDangerous property, right? Well, it would, except that there are so many different places in the application that can need this. Remember, there are a lot of rules, and just about anything can change that. So we would need to execute the rules whenever we change something in the application.&#xA;&#xA;Here, again, we see the importance of aggregates, because instead of spreading that logic all over the system, we can define Prisoner as the aggregate, and force all changes to it to occur through the entity. When saving a prisoner, then we can execute this.&#xA;&#xA;However, there is another aspect, this can cause an unacceptable performance for saving, since we expect the number of rules to grow and only become more complex over time. This looks like a good opportunity to to shift work to a background process. There is also the matter that we have to process those rules against every day, to make sure that we reset any rules that depend on time.&#xA;&#xA;I would build such a system using the following structure:&#xA;&#xA;&#xA;&#xA;The web server would send a notification to the batch processing server whenever a prisoner aggregate root is updated. The batch server will then process all rules for the prisoner. Once a day, the batch server will re-evaluate the rules for all prisoners. This solves the performance problem that we have when updating a prisoner. It introduce a new one, a problem of consistency. Now, there is going to be some delay between updating a prisoner and updating the IsDangerous status. In practice, I would expect the window of inconsistency to be be in the order of the time it takes to process all the rules. I would be extremely surprised if it was more than a second, and probably a lot less.&#xA;&#xA;In the duration, we can show in the UI that the prisoner&#x2019;s danger status in unknown. The UI can then query the application periodically until the danger status became known again using Ajax. From the user experience point of view, there would be almost no change, but in cases where the evaluation takes long enough for the user to notice, it will be made explicit what is going on.&#xA;&#xA;Yes, it is a more complex solution, but it is also one that neatly avoids all the complications that we have run into during this post.&#xA;&#xA;&#xA;&#xA;* I am sorry, but this post is going to be choke full of jokes that only I will probably understand.</p>
        </article>
        <article id="article-6025">
            <a href="https://ayende.com/blog/4051/nhibernate-get-thou-out-of-my-database-2nd-edition" target="_blank">
                <h2 class="title mb-6" id="article-6025">NHibernate &#x2013; Get Thou Out Of My Database &#x2013; 2nd Edition</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 08, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Following up on my previous post, the customer has complained about table names like [tbl_-1434067361], apparently they felt that this was misusing their naming policy. I told them that while I understood that, it did meet their naming policy. I got a new naming policy that stated that numbers are not allowed in column or table name, (and showing forethought) that table names must be composed of valid English words.  I, of course, decided that if this is what they wanted, they will get just that. And created this:     The words.txt file was taken from this URL: http://www.puzzlers.org/pub/wordlists/pocket.txt  The result is exactly per their specification:          create table [tbl_colonel] (&#xA;  [col_verbiage] INT IDENTITY NOT NULL,&#xA;   [col_unsparing] NVARCHAR(255) null,&#xA;   [col_indomitable] NVARCHAR(255) null,&#xA;   [col_bulldog] BIT null,&#xA;   [col_thank] DATETIME null,&#xA;   primary key ([col_verbiage])&#xA;)&#xA;create table [tbl_stump] (&#xA;  [col_upheaval] INT IDENTITY NOT NULL,&#xA;   [col_promissory] NVARCHAR(255) null,&#xA;   [col_predecessor] NVARCHAR(255) null,&#xA;   [col_chafer] NVARCHAR(255) null,&#xA;   [col_unyoke] INT null,&#xA;   [col_vise] NVARCHAR(255) null,&#xA;   PostId INT null,&#xA;   primary key ([col_upheaval])&#xA;)&#xA;&#xA;create table [tbl_reprieve] (&#xA;  [col_wherewith] INT IDENTITY NOT NULL,&#xA;   [col_wolf] VARBINARY(8000) null,&#xA;   [col_legendary] NVARCHAR(255) null,&#xA;   [col_ago] NVARCHAR(255) null,&#xA;   [col_carabineer] DATETIME null,&#xA;   [col_referee] NVARCHAR(255) null,&#xA;   primary key ([col_wherewith])&#xA;)&#xA;  &#xA;&#xA;&#xA;The fun part about this approach is that you still get great level of security, while maintaining the naming convention. Even more than that, you get queries like:&#xA;&#xA;&#xA;  &#xA;    SELECT col_verbiage, col_indomitable, col_bulldog, col_wolf, col_legendary, col_referee&#xA;FROM tbl_colonel JOIN tbl_repreieve ON tbl_repreieve.tbl_referee = tbl_colonel.col.unsparing&#xA;WHERE col_ago = &#x27;Fun@house.at&#x27;&#xA;  &#xA;&#xA;&#xA;It is obvious that we are getting users &amp; blogs with specific email, right?&#xA;&#xA;This is actually much harder than just numeric values, because this is going to really mess with your mind.&#xA;&#xA;&#xA;  Nitpicker corner: Yes, this is a humorous post, don&#x2019;t take it seriously, and please don&#x2019;t really do it to unsuspecting customers / DBAs. Unleash it on silly integration teams only.</p>
        </article>
        <article id="article-6026">
            <a href="https://ardalis.com/upgrading-hp-mediasmart-ex470-to-2gb-of-ram/" target="_blank">
                <h2 class="title mb-6" id="article-6026">Upgrading HP MediaSmart ex470 to 2GB of RAM</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 07, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After the horrible experience of trying to restore some files from my Windows Home Server while it was continuously thrashing due to&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-6027">
            <a href="https://ayende.com/blog/4050/if-stupidity-was-money-i-would-be-rich" target="_blank">
                <h2 class="title mb-6" id="article-6027">If stupidity was money, I would be rich</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 07, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Here is a crash report that I got from NH Prof error reporting:          System.NullReferenceException: Object reference not set to an instance of an object.&#xA;  at HibernatingRhinos.NHibernate.Profiler.Client.Model.Sessions.RecentStatements.set_SelectedStatement(IStatementModel value)&#xA;  at HibernatingRhinos.NHibernate.Profiler.Client.Model.Sessions.RecentStatements.Clear()&#xA;  at HibernatingRhinos.NHibernate.Profiler.Client.Model.SessionPresenter.Clear()&#xA;  at HibernatingRhinos.NHibernate.Profiler.Client.Model.ApplicationModel.Clear()&#xA;  at HibernatingRhinos.NHibernate.Profiler.Client.Commands.Clear.Execute(Object parameter)&#xA;  &#xA;&#xA;&#xA;This seems to be pretty standard, isn&#x2019;t it? Let us look at SelectedStatement:&#xA;&#xA; &#xA;&#xA;There isn&#x2019;t a possibility of a null reference exception, even the RaisePropertyChanged is safe from NRE.&#xA;&#xA;So, what was going on? I started dismissing this as a ghost story, but I got several issues of those. Then I remember that I am not the only on working on the profiler (well, that is a lie, I got a &#x2018;someone else updated this file&#x2019; when I tried to commit) and updated. Here is the updated version:&#xA;&#xA; &#xA;&#xA;And there is was, right on the third line in the set. &#xA;&#xA;Lesson learned? Don&#x2019;t be stupid, svn update.</p>
        </article>
        <article id="article-6028">
            <a href="https://ayende.com/blog/4049/connection-pooling-implemention" target="_blank">
                <h2 class="title mb-6" id="article-6028">Connection Pooling: Implemention</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 06, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Given the following contact:          /// &lt;summary&gt;&#xA;/// Thread Safety - This is NOT a thread safe connection&#xA;/// Exception Safety - After an exception is thrown, it should be disposed and not used afterward&#xA;/// Connection Pooling - It is expected that this will be part of a connection pool&#xA;/// &lt;/summary&gt;&#xA;public class DistributedHashTableStorageClient&#xA;  &#xA;&#xA;&#xA;I decided that I needed to really didn&#x2019;t want to pass the responsibility for that to the client, and that I wanted to handle that inside my library. Here is what I came up with:&#xA;&#xA;&#xA;  &#xA;    public class DefaultConnectionPool&#xA;{&#xA;    private static readonly ILog log = LogManager.GetLogger(typeof (DefaultConnectionPool));&#xA;    readonly object locker = new object();&#xA;&#xA;    private readonly Dictionary&lt;NodeEndpoint, LinkedList&lt;PooledDistributedHashTableStorageClientConnection&gt;&gt; pooledConnections =&#xA;        new Dictionary&lt;NodeEndpoint, LinkedList&lt;PooledDistributedHashTableStorageClientConnection&gt;&gt;();&#xA;&#xA;    public IDistributedHashTableStorage Create(NodeEndpoint endpoint)&#xA;    {&#xA;        PooledDistributedHashTableStorageClientConnection storage = null;&#xA;        lock (locker)&#xA;        {&#xA;            LinkedList&lt;PooledDistributedHashTableStorageClientConnection&gt; value;&#xA;            if (pooledConnections.TryGetValue(endpoint, out value) &amp;&amp; value.Count &gt; 0)&#xA;            {&#xA;                storage = value.First.Value;&#xA;                value.RemoveFirst();&#xA;            }&#xA;        }&#xA;        if (storage != null)&#xA;        {&#xA;            if (storage.Connected == false)&#xA;            {&#xA;                log.DebugFormat(&quot;Found unconnected connection in the pool for {0}&quot;, endpoint.Sync);&#xA;                try&#xA;                {&#xA;                    storage.Dispose();&#xA;                }&#xA;                catch (Exception e)&#xA;                {&#xA;                    log.Debug(&quot;Error when disposing unconnected connection in the pool&quot;, e);&#xA;                }&#xA;            }&#xA;            else&#xA;            {&#xA;                return storage;&#xA;            }&#xA;        }&#xA;        log.DebugFormat(&quot;Creating new connection in the pool to {0}&quot;, endpoint.Sync);&#xA;        return new PooledDistributedHashTableStorageClientConnection(this, endpoint);&#xA;    }&#xA;&#xA;    private void PutMeBack(PooledDistributedHashTableStorageClientConnection connection)&#xA;    {&#xA;        lock (locker)&#xA;        {&#xA;            LinkedList&lt;PooledDistributedHashTableStorageClientConnection&gt; value;&#xA;            if (pooledConnections.TryGetValue(connection.Endpoint, out value) == false)&#xA;            {&#xA;                pooledConnections[connection.Endpoint] = value = new LinkedList&lt;PooledDistributedHashTableStorageClientConnection&gt;();&#xA;            }&#xA;            value.AddLast(connection);&#xA;        }&#xA;        log.DebugFormat(&quot;Put connection for {0} back in the pool&quot;, connection.Endpoint.Sync);&#xA;    }&#xA;&#xA;    class PooledDistributedHashTableStorageClientConnection : DistributedHashTableStorageClient&#xA;    {&#xA;        private readonly DefaultConnectionPool pool;&#xA;&#xA;        public PooledDistributedHashTableStorageClientConnection(&#xA;            DefaultConnectionPool pool,&#xA;            NodeEndpoint endpoint) : base(endpoint)&#xA;        {&#xA;            this.pool = pool;&#xA;        }&#xA;&#xA;        public bool Connected&#xA;        {&#xA;            get { return client.Connected; }&#xA;        }&#xA;&#xA;        public override void Dispose()&#xA;        {&#xA;            if(Marshal.GetExceptionCode() != 0)//we are here because of some sort of error&#xA;            {&#xA;                log.Debug(&quot;There was an error during the usage of pooled client connection, will not return it to the pool (may be poisioned)&quot;);&#xA;                base.Dispose();&#xA;            }&#xA;            else if(Connected == false)&#xA;            {&#xA;                log.Debug(&quot;The connection was disconnected, will not return connection to the pool&quot;);&#xA;                base.Dispose();&#xA;            }&#xA;            else&#xA;            {&#xA;                pool.PutMeBack(this);&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;  &#xA;&#xA;&#xA;I think that should pretty much cover everything I need.&#xA;&#xA;Thoughts?</p>
        </article>
        <article id="article-6029">
            <a href="https://ayende.com/blog/4048/nhibernate-get-thou-out-of-my-database" target="_blank">
                <h2 class="title mb-6" id="article-6029">NHibernate &#x2013; Get Thou Out Of My Database</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 06, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There are evil people in this world, and some of them want access to my database. Unfortunately, they are often part of that nasty integration team and they try to integrate directly into my database. I tried beating them with clubs and lobbing arguments about letting other people mess with my implementation details, but they have been persistent. That is when I reached out to a technological solution for the problem.  I want to emphasize that this is the nuclear option and&#xA0; you want to really consider it before going that route.  We are going to use NHibernate to do that, naturally. Here is how:      &#xA;&#xA;&#xA;Which results in the following schema:&#xA;&#xA;&#xA;  &#xA;    create table [tbl_-1434067361] (&#xA;   [col_287061521] INT IDENTITY NOT NULL,&#xA;   [col_4699698] INT not null,&#xA;   [col_-1966747349] NVARCHAR(255) null,&#xA;   [col_-649855325] NVARCHAR(255) null,&#xA;   [col_-649855326] NVARCHAR(255) null,&#xA;   [col_775690683] NVARCHAR(255) null,&#xA;   [col_-2127361396] NVARCHAR(255) null,&#xA;   [col_-1334581412] NVARCHAR(255) null,&#xA;   primary key ([col_287061521])&#xA;)&#xA;  &#xA;&#xA;&#xA;To make sure that we follow procedure, we are even using the naming convention of the organization! Lovely, isn&#x2019;t it? It is obvious that this is my people table, right?&#xA;&#xA;All arguments against this schema can be answered using: &#x201C;It is more secured&#x201D;.&#xA;&#xA;It might be the nuclear option, but it tend to work :-)&#xA;&#xA;&#xA;  Nitpicker corner: No, I don&#x2019;t suggest you would do this, that is why the code is an image. This is just an example of how to programmatically modify the configuration and mapping. I only used it once, during a demo to the integration people, to get them to leave my DB alone. If you push something like that for production you should probably be shot.</p>
        </article>
        <article id="article-6030">
            <a href="https://ayende.com/blog/4047/wcf-works-in-mysterious-ways" target="_blank">
                <h2 class="title mb-6" id="article-6030">WCF works in mysterious ways</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 04, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Here is the result of about two hours of trying to figure out what WCF is doing:          class Program&#xA;    {&#xA;        static private readonly Binding binding = new NetTcpBinding&#xA;        {&#xA;            OpenTimeout = TimeSpan.FromMilliseconds(500),&#xA;            CloseTimeout = TimeSpan.FromMilliseconds(250),&#xA;            ReaderQuotas =&#xA;                {&#xA;                    MaxArrayLength = Int32.MaxValue,&#xA;                    MaxBytesPerRead = Int32.MaxValue,&#xA;                    MaxNameTableCharCount = Int32.MaxValue,&#xA;                    MaxDepth = Int32.MaxValue,&#xA;                    MaxStringContentLength = Int32.MaxValue,&#xA;                },&#xA;            MaxReceivedMessageSize = Int32.MaxValue,&#xA;        };&#xA;        static void Main()&#xA;        {&#xA;            try&#xA;            {&#xA;                var uri = new Uri(&quot;net.tcp://&quot; &#x2B; Environment.MachineName &#x2B; &quot;:2200/master&quot;);&#xA;                var serviceHost = new ServiceHost(new DistributedHashTableMaster(new NodeEndpoint&#xA;                {&#xA;                    Async = uri.ToString(),&#xA;                    Sync = uri.ToString()&#xA;                }));&#xA;                serviceHost.AddServiceEndpoint(typeof(IDistributedHashTableMaster),&#xA;                                               binding,&#xA;                                               uri);&#xA;&#xA;                serviceHost.Open();&#xA;&#xA;                var channel =&#xA;                    new ChannelFactory&lt;IDistributedHashTableMaster&gt;(binding, new EndpointAddress(uri))&#xA;                        .CreateChannel();&#xA;                channel.Join();&#xA;            }&#xA;            catch (Exception e)&#xA;            {&#xA;                Console.WriteLine(e);&#xA;            }&#xA;&#xA;        }&#xA;    }&#xA;&#xA;    [ServiceBehavior(&#xA;        InstanceContextMode = InstanceContextMode.Single,&#xA;        ConcurrencyMode = ConcurrencyMode.Single,&#xA;        MaxItemsInObjectGraph = Int32.MaxValue&#xA;        )]&#xA;    public class DistributedHashTableMaster : IDistributedHashTableMaster&#xA;    {&#xA;        private readonly Segment[] segments;&#xA;&#xA;        public DistributedHashTableMaster(NodeEndpoint endpoint)&#xA;        {&#xA;            segments = Enumerable.Range(0, 8192).Select(i =&gt;&#xA;                                                        new Segment&#xA;                                                        {&#xA;                                                            AssignedEndpoint = endpoint,&#xA;                                                            Index = i&#xA;                                                        }).ToArray();&#xA;        }&#xA;&#xA;        public Segment[] Join()&#xA;        {&#xA;            return segments;&#xA;        }&#xA;    }&#xA;&#xA;    [ServiceContract]&#xA;    public interface IDistributedHashTableMaster&#xA;    {&#xA;        [OperationContract]&#xA;        Segment[] Join();&#xA;    }&#xA;&#xA;    public class NodeEndpoint&#xA;    {&#xA;        public string Sync { get; set; }&#xA;        public string Async { get; set; }&#xA;    }&#xA;&#xA;    public class Segment&#xA;    {&#xA;        public Guid Version { get; set; }&#xA;&#xA;        public int Index { get; set; }&#xA;        public NodeEndpoint AssignedEndpoint { get; set; }&#xA;        public NodeEndpoint InProcessOfMovingToEndpoint { get; set; }&#xA;&#xA;        public int WcfHatesMeAndMakeMeSad { get; set; }&#xA;    }&#xA;  &#xA;&#xA;&#xA;The problem? On my machine, executing this results in:&#xA;&#xA;&#xA;  Maximum number of items that can be serialized or deserialized in an object graph is &#x27;65536&#x27;. Change the object graph or increase the MaxItemsInObjectGraph quota.&#xA;&#xA;&#xA;The freaky part? Do you see the WcfHatesMeAndMakeMeSad property? If I comment that one out, the problem goes away. Since MaxItemsInObjectGraph is set to int.MaxValue, I don&#x2019;t know what else to do, and frankly, I am getting mighty tired of WCF doing stuff in unpredictable ways.&#xA;&#xA;Protocol Buffers &amp; TcpClient, here I comes.</p>
        </article>
        <div class="button flex justify-between">
            <a href="602.html"><span class="back arrow"></span></a>

            <a href="604.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
