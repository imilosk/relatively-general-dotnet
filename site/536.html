
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 536 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-5351">
            <a href="https://ayende.com/blog/4566/ef-prof-and-code-only" target="_blank">
                <h2 class="title mb-6" id="article-5351">EF Prof and Code Only</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 30, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I just finish touching up a new feature for EF Prof, support for Entity Framework&#x2019;s Code Only feature. What you see below is EF Prof tracking the Code Only Nerd Dinner example:     I tried to tackle the same thing in CTP3, but I was unable to resolve it. Using CTP4, it was about as easy as I could wish it.  Just for fun, the following screen shot looks like it contains a bug, but it doesn&#x2019;t (at least, not to my knowledge). If you can spot what the bug is, I am going to hand you a 25% discount coupon for EF Prof. If you can tell me why it is not a bug, I would double that.  As an aside, am I the only one that is bothered by the use of @@IDNETITY by EF? I thought that we weren&#x2019;t supposed to make use of that. Moreover, why write this complex statement when you can write SELECT @@IDENTITY?</p>
        </article>
        <article id="article-5352">
            <a href="https://ayende.com/blog/4565/a-question-of-an-untenable-situation" target="_blank">
                <h2 class="title mb-6" id="article-5352">A question of an untenable situation</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 29, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the most common issues that I run into in my work is getting all sort of questions which sound really strange. For example, I recently got a question that went something like this:     What is the impact of reflection on NHibernate&#x2019;s performance?   I started to answer that there isn&#x2019;t one that you would notice, even beyond the major optimizations that NH had in that role, you are accessing a remote database, which is much more expensive. But then they told me that they profiled the application and found some stuff there about that.  I asked them what their scenario was, and the exchange went like that:     Well, when we load a million rows&#x2026;   And that is your problem&#x2026;  To be fair, they actually had a reasonable reason to want to do that. I disagree with the solution that they had, but it was a reasonable approach to the problem at hand.</p>
        </article>
        <article id="article-5353">
            <a href="https://ayende.com/blog/4564/reviewing-communitycourses-a-ravendb-application" target="_blank">
                <h2 class="title mb-6" id="article-5353">Reviewing CommunityCourses: A RavenDB application</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 28, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The code for CommunityCourses can be found here: http://github.com/adam7/CommunityCourses  This is a RavenDB application whose existence I learned about roughly an hour ago. The following is a typical code review about the application, not limited to just RavenDB.  Tests  When I first opened the solution, I was very happy to see that there are tests for the application, but I was disappointed when I actually opened it.      The only tests that exists seems to be the default ones that comes with ASP.Net MVC.  I would rather have no test project than a test project like that.  Account Controller, yet again  Annoyed with the test project, I headed for my favorite target for frustration, the MVC AccountController and its horrid attempt at creating DI or abstractions.  Imagine my surprise when I found this lovely creature instead:     [HandleError]&#xA;public partial class AccountController : Controller&#xA;{&#xA;    public virtual ActionResult LogOn()&#xA;    {&#xA;        return View();&#xA;    }&#xA;&#xA;    [AcceptVerbs(HttpVerbs.Post)]&#xA;    public virtual ActionResult LogOn(string userName, string password)&#xA;    {&#xA;        if (FormsAuthentication.Authenticate(userName, password))&#xA;        {&#xA;            FormsAuthentication.SetAuthCookie(userName, false);&#xA;            return RedirectToAction(&quot;Index&quot;, &quot;Home&quot;);&#xA;        }&#xA;        else&#xA;        {&#xA;            ModelState.AddModelError(&quot;logon&quot;, &quot;Invalid username or password&quot;);&#xA;            return View();&#xA;        }&#xA;    }&#xA;&#xA;    public virtual ActionResult LogOff()&#xA;    {&#xA;        FormsAuthentication.SignOut();&#xA;        return RedirectToAction(&quot;Index&quot;, &quot;Home&quot;);&#xA;    }&#xA;}&#xA;  &#xA;&#xA;Yes, simple, work, simple, uncomplicated! You don&#x2019;t have to think when reading this code, I like it. That is how the Account Controller should have been, by default. &#xA;&#xA;The model&#xA;&#xA;I then turned into the model. Community Courses is a RavenDB application, so I am very interested in seeing how this is handled. The first thing that I noticed was this:&#xA;&#xA; &#xA;&#xA;That was interesting, I am not used to seeing static classes in the model. But then I looked into those classes, and it all became clear:&#xA;&#xA; &#xA;&#xA;This is essentially a lookup class. &#xA;&#xA;Then I switched to the rest of the model, the following image shows a partial view of the model, annotated a bit:&#xA;&#xA; &#xA;&#xA;The classes with the Id property (highlighted) are presumed to be Root Entities (in other words, they would each reside in their own document). I am not absolutely sure that this is the case yet, but I am sure enough to point out a potential problem.&#xA;&#xA;Did you notice that we have references to things like Address, Person and Centre in the model? They are marked with red and green points.&#xA;&#xA;A green point is when we reference a class that doesn&#x2019;t have an id, and is therefore considered to be a value type which is embedded in the parent document. A red point, however, indicate what I believe will be a common problem for people coming to RavenDB from an OR/M background. &#xA;&#xA;RavenDB doesn&#x2019;t support references (this is by design), and the result of referencing a Root Entity in another Root Entity is that the referenced entity is embedded inside the referencing document. This is precisely what you want for value types like Address, and precisely what you don&#x2019;t want for references. You can see in TasterSession that there are actually two references to Tutor, one for the Tutor data and one for the TutorId. I think that this is an indication for hitting that problem.&#xA;&#xA;For myself, I would prefer to not denormalize the entire referenced entity, but only key properties that are needed for processing the referencing entity. That make is easier to understand the distinction between the Person instance that is mapped to people/4955 and the Person instance that is help in Centre.Contact.&#xA;&#xA;Session management&#xA;&#xA;Next on the list, because it is so easy to get it wrong (I saw so many flawed NHibernate session management):&#xA;&#xA; &#xA;&#xA;This is great, we have a session per request, which is what I would expect in a we application.&#xA;&#xA;I might quibble with the call to SaveChanges, though. I like to make that one an explicit one, rather than implicit, but that is just that, a quibble.&#xA;&#xA;Initializing RavenDB&#xA;&#xA;This is worth speaking about (it happens in Application_Start):&#xA;&#xA; &#xA;&#xA;RavenDB is pretty conventional, and Community Courses override one of those conventions to make it easier to work with MVC. By default, RavenDB will use ids like: &#x201C;people/391&#x201D;, &#x201C;centres/912&#x201D;, by changing the identity parts separator, it will ids like: &#x201C;people-952&#x201D;, &#x201C;centres-1923&#x201D;. The later are easier to work with in MVC because they don&#x2019;t contain a routing character.&#xA;&#xA;Centre Controller&#xA;&#xA;This is a simple CRUD controller, but it is worth examining nonetheless:&#xA;&#xA; &#xA;&#xA;Those are all pretty simple. The only thing of real interest is the Index action, which uses a query on an index to get the results.&#xA;&#xA;Currently the application doesn&#x2019;t support paging, but it probably should, which wouldn&#x2019;t complicate like all that much (adding Skip &amp; Take, that is about it).&#xA;&#xA;Next, the Create/Edit actions:&#xA;&#xA; &#xA;&#xA;&#xA;&#xA;They are short &amp; to the point, nothing much to do here. I like this style of coding very much. You could fall asleep while writing it. The only comment beyond that is that those methods are so similar that I would consider merging them into a single action.&#xA;&#xA;Course Controller&#xA;&#xA;Things are starting to get much more interesting here, when we see this method:&#xA;&#xA; &#xA;&#xA;Overall, it is pretty good, but am very sensitive to making remote calls, so I would change the code to make only a single remote call:&#xA;&#xA;CourseViewModel ConvertToCourseViewModel(Course course)&#xA;{&#xA;    var ids = new List&lt;string&gt; { course.CentreId, course.TutorId, course.UnitId };&#xA;    if(course.VerifierId != null)&#xA;        ids.Add(course.VerifierId);&#xA;    ids.AddRange(course.StudentIds);&#xA;&#xA;    var results = MvcApplication.CurrentSession.Load&lt;object&gt;(ids.ToArray());&#xA;&#xA;    var courseViewModel = new CourseViewModel&#xA;    {&#xA;        Centre = (Centre)results[0],&#xA;        CentreId = course.CentreId,&#xA;        EndDate = course.EndDate,&#xA;        Id = course.Id,&#xA;        Name = course.Name,&#xA;        StartDate = course.StartDate,&#xA;        StudentIds = course.StudentIds,&#xA;        Tutor = (Person)results[1],&#xA;        TutorId = course.TutorId,&#xA;        Unit = (Unit)results[2],&#xA;        UnitId = course.UnitId,                &#xA;        VerifierId = course.VerifierId&#xA;    };&#xA;    int toSkip = 3;&#xA;    if (course.VerifierId != null)&#xA;    {&#xA;        toSkip &#x2B;= 1;&#xA;        courseViewModel.Verifier = (Person)results[3];&#xA;    }&#xA;&#xA;    courseViewModel.Students = results.Skip(toSkip).Cast&lt;Person&gt;().ToList();&#xA;&#xA;    return courseViewModel;&#xA;}&#xA;&#xA;&#xA;This is slightly more complex, but I think that the benefits outweigh the additional complexity.&#xA;&#xA;5N&#x2B;1 requests ain&#x2019;t healthy&#xA;&#xA;The following code is going to cause a problem:&#xA;&#xA; &#xA;&#xA;It is going to cause a problem because it makes a single remote call (the Query) and for every result from this query it is going to perform 5 remote calls inside ConvertToCourseViewModel.&#xA;&#xA;In other words, if we have twenty courses to display, this code will execute a hundred remote calls. That is going to be a problem. Let us look at how the document courses-1 looks like:&#xA;&#xA;{&#xA;    &quot;CentreId&quot;: &quot;centres-1&quot;,&#xA;    &quot;Status&quot;: &quot;Upcoming&quot;,&#xA;    &quot;Name&quot;: &quot;NHibernate&quot;,&#xA;    &quot;StartDate&quot;: &quot;/Date(1280361600000)/&quot;,&#xA;    &quot;EndDate&quot;: &quot;/Date(1280534400000)/&quot;,&#xA;    &quot;UnitId&quot;: &quot;units-1&quot;,&#xA;    &quot;TutorId&quot;: &quot;people-1&quot;,&#xA;    &quot;VerifierId&quot;: null,&#xA;    &quot;StudentIds&quot;: [&#xA;        &quot;people-1&quot;&#xA;    ]&#xA;}&#xA;&#xA;&#xA;And here is how the UI looks like:&#xA;&#xA; &#xA;&#xA;I think you can figure out what I am going to suggest, right? Instead of pulling all of this data at read time (very expensive), we are going to denormalize the data at write time, leading to a document that looks like this:&#xA;&#xA;{&#xA;    &quot;CentreId&quot;: { &quot;Id&quot;:  &quot;centres-1&quot;, &quot;Name&quot;: &quot;SkillsMatter London&quot; },&#xA;    &quot;Status&quot;: &quot;Upcoming&quot;,&#xA;    &quot;Name&quot;: &quot;NHibernate&quot;,&#xA;    &quot;StartDate&quot;: &quot;/Date(1280361600000)/&quot;,&#xA;    &quot;EndDate&quot;: &quot;/Date(1280534400000)/&quot;,&#xA;    &quot;UnitId&quot;: { &quot;Id&quot;: &quot;units-1&quot;, &quot;Name&quot;: &quot;1 - Introduction to Face Painting&quot;},&#xA;    &quot;TutorId&quot;: { &quot;Id&quot;: &quot;people-1&quot;, &quot;Name&quot;: &quot;Mr Oren Eini&quot; },&#xA;    &quot;VerifierId&quot;: null,&#xA;    &quot;StudentIds&quot;: [&#xA;        { &quot;Id&quot;: &quot;people-1&quot;, &quot;Name&quot;: &quot;Ayende Rahien&quot; }&#xA;    ]&#xA;}&#xA;&#xA;&#xA;Using this approach, we can handle the Index action shown above with a single remote call. And that is much better.&#xA;&#xA;I am going to ignore actions whose structure we already covered (Edit, Details, etc), and focus on the interesting ones, the next of which is:&#xA;&#xA; &#xA;&#xA;This is an excellent example of how things should be. (Well, almost, I would remove the unnecessary Store call and move the StudentIds.Add just before the foreach, so all the data access happens first, it makes it easier to scan). Using an OR/M, this code would generate 8 remote calls, but because Raven&#x2019;s documents are loaded as a single unit, we have only 3 here (and if we really wanted, we can drop it to one). &#xA;&#xA;Next, we update a particular session / module in a student. &#xA;&#xA; &#xA;&#xA;We can drop the unnecessary calls to Store, but beside that, it is pretty code. I don&#x2019;t like that moduleId / sessionId are compared to the Name property, That seems confusing to me. &#xA;&#xA;Charting with RavenDB&#xA0;&#xA;&#xA;I am showing only the parts that are using RavenDB here:&#xA;&#xA;&#xA;&#xA;There is one problem with this code, it doesn&#x2019;t work. Well, to be bit more accurate, it doesn&#x2019;t work if you have enough data. This code ignores what happen if you have enough people to start paging, and it does a lot of work all the time. It can be significantly improved by introducing a map/ reduce index to do all the hard work for us:&#xA;&#xA; &#xA;&#xA;&#xA;&#xA;This will perform the calculation once, updating it whenever a document changes. It will also result in much less traffic going on the network, since the data that we will get back will look like this:&#xA;&#xA; &#xA;&#xA;Person Controller doesn&#x2019;t contain anything that we haven&#x2019;t seen before. So we will skip that and move directly to&#x2026;&#xA;&#xA;Taster Session Controller&#xA;&#xA; &#xA;&#xA;I sincerely hope that those comments were generated by a tool.&#xA;&#xA;The following three methods all shared the same problem:&#xA;&#xA; &#xA;&#xA;They all copy Centre &amp; Person to the TasterSession entity. The problem with that is that it generate the following JSON:&#xA;&#xA; &#xA;&#xA;References in RavenDB are always embedded in the referencing entity. This should be a denomralized reference instead (just Id &amp; Name, most probably).&#xA;&#xA;Other aspects&#xA;&#xA;I focused exclusively on the controller / Raven code, and paid absolutely no attention to any UI / JS / View code. I can tell you that the UI looks &amp; behaves really nice, but that is about it. &#xA;&#xA;&#xA;&#xA;&#xA;&#xA;Summary&#xA;&#xA;All in all, this was a codebase that was a pleasure to read. There are some problems, but they are going to be easy to fix.</p>
        </article>
        <article id="article-5354">
            <a href="https://ayende.com/blog/4563/ravendb-authorization-bundle-design" target="_blank">
                <h2 class="title mb-6" id="article-5354">RavenDB Authorization Bundle Design</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 27, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I used to be able to just sit down and write some code, and eventually things would work. Just In Time Design. That is how I wrote things like Rhino Mocks, for example.  Several years ago (2007, to be exact) I started doing more detailed upfront design, those designs aren&#x2019;t curved in stone, but they are helpful in setting everything in motion properly. Of course, in some cases those design need a lot of time to percolate. At any rate, this is the design for the Authorization Bundle for RavenDB. I would welcome any comments about it. I gave some background on some of the guiding thoughts about the subject in this post.     Note: This design is written before the code, it reflect the general principles of how I intend to approach the problem, but it is not a binding design, things will change.   Rhino Security design has affected the design of this system heavily. In essence, this is a port (of a sort) of Rhino Security to RavenDB, with the necessary changes to make the move to a NoSQL database. I am pretty happy with the design and I actually think that we might do back porting to Rhino Security at some point.  Important Assumptions  The most important assumption that we make for the first version is that we can trust the client not to lie about whose user it is executing a certain operation. That one assumes the following deployment scenario:     In other words, only the application server can talk to the RavenDB server and the application server is running trusted code.  To be clear, this design doesn&#x2019;t not apply if users can connect directly to the database and lie about who they are. However, that scenario is expected to crop up, even though it is out of scope for the current version. Our design need to be future proofed in that regard.  Context &amp; User  Since we can trust the client calling us, we can rely on the client to tell us which user a particular action is executed on behalf of, and what is the context of the operation.  From the client API perspective, we are talking about:     using(var session = documentStore.OpenSession())&#xA;{&#xA;     session.SecureFor(&quot;raven/authorization/users/8458&quot;, &quot;/Operations/Debt/Finalize&quot;);&#xA;    &#xA;    var debtsQuery =   from debt in session.Query&lt;Debt&gt;(&quot;Debts/ByDepartment&quot;)&#xA;                       where debt.Department == department&#xA;                       select debt&#xA;                       orderby debt.Amount;&#xA;    &#xA;     var debts = debtsQuery.Take(25).ToList();&#xA;&#xA;    // do something with the debts&#xA;}&#xA;  &#xA;&#xA;I am not really happy with this API, but I think it would do for now. There are a couple of things to note with regards to this API:&#xA;&#xA;&#xA;  The user specified is using the reserved namespace &#x201C;raven/&#x201D;. This allows the authorization bundle to have a well known format for the users documents.&#xA;&#xA;  The operation specified is using the Rhino Security conventions for operations. By using this format, we can easily construct hierarchical permissions.&#xA;&#xA;&#xA;Defining Users&#xA;&#xA;The format of the authorization user document is as follows:&#xA;&#xA;&#xA;  // doc id /raven/authorization/users/2929{&#xA;    &quot;Name&quot;: &quot;Ayende Rahien&quot;,&#xA;    &quot;Roles&quot;: [ &quot;/Administrators&quot;, &quot;/DebtAgents/Managers&quot;],&#xA;    &quot;Permissions&quot;: [&#xA;       { &quot;Operation&quot;: &quot;/Operations/Debts/Finalize&quot;, &quot;Tag&quot;: &quot;/Tags/Debts/High&quot;, &quot;Allow&quot;: true, &quot;Priority&quot;: 1, }&#xA;    ]&#xA;}&#xA;  &#xA;&#xA;There are several things to note here:&#xA;&#xA;&#xA;  The format isn&#x2019;t what an application needs for a User document. This entry is meant for the authorization bundle&#x2019;s use, not for an application&#x2019;s use. You can use the same format for both, of course, by extending the authorization user document, but I&#x2019;ll ignore this for now.&#xA;&#xA;  Note that the Roles that we have are hierarchical as well. This is important, since we would use that when defining permissions. Beyond that, Roles are used in a similar manner to groups in something like Active Directory. And the hierarchical format allows to manage that sort of hierarchical grouping inside Raven easily.&#xA;&#xA;  Note that we can also define permissions on the user for documents that are tagged with a particular tag. This is important if we want to grant a specific user permission for a group of documents.&#xA;&#xA;&#xA;Roles&#xA;&#xA;The main function of roles is to define permissions for a set of tagged documents. A role document will look like this:&#xA;&#xA;// doc id /raven/authorization/roles/DebtAgents/Managers&#xA;    &#xA;&#xA;  {&#xA;   &quot;Permissions&quot;: [&#xA;       { &quot;Operation&quot;: &quot;/Operations/Debts/Finalize&quot;, &quot;Tag&quot;: &quot;/Tags/Debts/High&quot;, &quot;Allow&quot;: true, &quot;Priority&quot;: 1, }&#xA;    ]&#xA;}&#xA;  &#xA;&#xA;Defining permissions&#xA;&#xA;Permissions are defined on individual documents, using RavenDB&#x2019;s metadata feature. Here is an example of one such document, with the authorization metadata:&#xA;&#xA;&#xA;  //docid-/debts/2931&#xA;{&#xA;  &quot;@metadata&quot;: {&#xA;    &quot;Authorization&quot;: {&#xA;      &quot;Tags&quot;: [&#xA;        &quot;/Tags/Debts/High&quot;&#xA;      ],&#xA;      &quot;Permissions&quot;: [&#xA;        {&#xA;          &quot;User&quot;: &quot;raven/authorization/users/2929&quot;,&#xA;          &quot;Operation&quot;: &quot;/Operations/Debts&quot;,&#xA;          &quot;Allow&quot;: true,&#xA;          &quot;Priority&quot;: 3&#xA;        },&#xA;        {&#xA;          &quot;User&quot;: &quot;raven/authorization/roles/DebtsAgents/Managers&quot;,&#xA;          &quot;Operation&quot;: &quot;/Operations/Debts&quot;,&#xA;          &quot;Allow&quot;: false,&#xA;          &quot;Priority&quot;: 1&#xA;        }&#xA;      ]&#xA;    }&#xA;  },&#xA;  &quot;Amount&quot;: 301581.92,&#xA;  &quot;Debtor&quot;: {&#xA;    &quot;Name&quot;: &quot;Samuel Byrom&quot;,&#xA;    &quot;Id&quot;: &quot;debots/82985&quot;&#xA;  }&#xA;  //more document data&#xA;}&#xA;  &#xA;&#xA;Tags, operations and roles are hierarchical. But the way they work is quite different. &#xA;&#xA;&#xA;  For Tags and Operations, having permission for &#x201C;/Debts&#x201D; gives you permission to &#x201C;/Debts/Finalize&#x201D;.&#xA;&#xA;  For roles, it is the other way around, if you are a member of &#x201C;/DebtAgents/Managers&#x201D;, you are also a memeber of &#x201C;/DebtAgents&#x201D;.&#xA;&#xA;&#xA;The Authorization Bundle uses all of those rules to apply permissions.&#xA;&#xA;Applying permissions&#xA;&#xA;I think that it should be pretty obvious by now how the Authorization Bundle makes a decision about whatever a particular operation is allowed or denied, but the response for denying an operation are worth some note.&#xA;&#xA;&#xA;  When performing a query over a set of documents, some of which we don&#x2019;t have the permission for under the specified operation, those documents are filtered out from the query.&#xA;&#xA;  When loading a document by id, when we don&#x2019;t have the permission to do so under the specified operation, an error is raised.&#xA;&#xA;  When trying to write to a document (either PUT or DELETE), when we don&#x2019;t have the permission to do so under the specified operation, an error is raised.&#xA;&#xA;&#xA;That is pretty much as detailed as I want things to be at this stage. Thoughts?</p>
        </article>
        <article id="article-5355">
            <a href="https://ardalis.com/book-recommendations-2010/" target="_blank">
                <h2 class="title mb-6" id="article-5355">Books</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 26, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Sadukie tagged me with her books post a couple of weeks ago and I&#x2019;ve been meaning to respond with a post of my own. I have a post I update&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-5356">
            <a href="https://ayende.com/blog/4562/ravendb-index-management" target="_blank">
                <h2 class="title mb-6" id="article-5356">RavenDB Index Management</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 26, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When I wrote RavenDB, I started from the server, and built the client last. That had some interesting affects on RavenDB, for example, you can see detailed docs about the HTTP API, because that is what I had when I wrote most of the docs.  In the context of indexes, that meant that I thought a lot more about defining and working with indexes from the WebUI perspective, rather than the client perspective. Now that Raven have users that actually put it through its paces, I found that most people want to be able to define their indexes completely in code, and want to be able to re-create those indexes from code.  And that calls for a integral solution from Raven for this issue. Here is how you do this.     You define your index creation as a class, such as this one:      public class Movies_ByActor : AbstractIndexCreationTask&#xA;{&#xA;    public override IndexDefinition CreateIndexDefinition()&#xA;    {&#xA;        return new IndexDefinition&lt;Movie&gt;&#xA;        {&#xA;            Map = movies =&gt; from movie in movies&#xA;                            select new {movie.Name}&#xA;        }&#xA;        .ToIndexDefinition(DocumentStore.Conventions);&#xA;    }&#xA;}&#xA;    &#xA;&#xA;  Somewhere in your startup routine, you include the following line of code: &#xA;    IndexCreation.CreateIndexes(typeof(Movies_ByActor).Assembly, store);&#xA;    &#xA;&#xA;&#xA;And that is it, Raven will scan the provided assembly (you can also provide a MEF catalog, for more complex scenarios) and create all those indexes for you, skipping the creation if the new index definition matches the index definition in the database.&#xA;&#xA;This also provide a small bit of convention, as you can see, the class name is Movies_ByActor, but the index name will be Movies/ByActor. You can override that by overriding the IndexName property</p>
        </article>
        <article id="article-5357">
            <a href="https://ayende.com/blog/4561/find-the-bug-accidental-code-reviews" target="_blank">
                <h2 class="title mb-6" id="article-5357">Find the bug</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 25, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was working with a client about a problem they had in integrating EF Prof to their application, when my caught the following code base (anonymized, obviously):     public static class ContextHelper&#xA;{&#xA;     private static Acme.Entities.EntitiesObjectContext _context;&#xA;&#xA;     public static Acme.Entities.EntitiesObjectContext CurrentContext&#xA;     {&#xA;           get { return _context ?? (_context = new Acme.Entities.EntitiesObjectContext()); }&#xA;      }&#xA;&#xA;}&#xA;  &#xA;&#xA;That caused me to stop everything and focus the client&#x2019;s attentions on the problem that this code can cause.&#xA;&#xA;What were those problems?</p>
        </article>
        <article id="article-5358">
            <a href="https://ayende.com/blog/4560/a-series-of-posts-about-nhibernate-tooling" target="_blank">
                <h2 class="title mb-6" id="article-5358">A series of posts about NHibernate tooling</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 25, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I intend to write a series of posts about NHibernate tooling, and I thought that before I start, I should ask people to point me to tools that I might not be familiar with.  Tools that are currently on the list to post about:     LLBLGen 3.0    Pleasant Modeler    Active Writer    NHibernate Query Analyzer   Any others that you&#x2019;ll like me to check out?</p>
        </article>
        <article id="article-5359">
            <a href="https://ayende.com/blog/4559/real-world-authorization-implementation-considerations" target="_blank">
                <h2 class="title mb-6" id="article-5359">Real world authorization implementation considerations</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 23, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Nitpicker corner: this post discusses authorization, which assumes that you already know who the user is. Discussion of authentication methods, how we decide who the user is, would be outside the scope of this post.   I had a lot of experience with building security systems. After all, sooner or later, whatever your project is, you are going to need one. At some point, I got tired enough of doing that that I wrote Rhino Security, which codify a lot of the lessons that I learned from all of those times. And I learned a lot from using Rhino Security in real world projects as well.  When coming to design the authorization bundle for RavenDB, I had decided to make a conscious effort to detail the underlying premise that I have when I am approaching the design of a security system.  You can&#x2019;t manage authorization at the infrastructure level  That seems to be an instinctual response by most developers when faced with the problem, &#x201C;we will push it to the infrastructure and handle this automatically&#x201D;. The usual arguments is that we want to avoid the possibility of the developer forgetting to include the security checks and that it makes it easier to develop.  The problem is that when you put security decisions in the infrastructure, you are losing the context in which a certain operation is performed. And context matters. It matters even more when we consider the fact that there are actually two separate levels of security that we need to consider:     Infrastructure related &#x2013; can I read / write to this document?     Business related &#x2013; can I perform [business operation] on this entity?    Very often, we try to use the first to apply the second. This is often the can when we have a business rule that specify that a user shouldn&#x2019;t be able to access certain documents which we try to apply at the infrastructure level.  For a change, we will use the example of a debt collection agency.      As a debt collector, I can negotiate a settlement plan with a debtor, so the agency can resolve the debt.         Debt collectors can only negotiate settlement plans for debts under 50,000$       Only managers can negotiate settlement plans for debts over 50,000$      Seems simple, right? We will assume that we have a solution in store and say that the role of DebtCollectors can&#x2019;t read/write to documents about settlement plans of over 50K$. I am not sure how you would actually implement this, but let us say that we did just that. We solved the problem at the infrastructure level and everyone is happy.  Then we run into a problem, a Debt Collector may not be allow to do the actual negotiation with a heavy debtor, but there is a whole lot of additional work that goes on that the Debt Collector should do (check for collateral, future prospects, background check, etc).  The way that the agency works, the Debt Collector does a lot of the preliminary work, then the manager does the actual negotiation. That means that for the same entity, under different contexts, we have very different security rules. And these sort of requirements are the ones that are going to give you fits when you try to apply them at the infrastructure level.  You can argue that those sort of rules are business logic, not security rules, but the way the business think of them, that is exactly what they are.   The logged on user isn&#x2019;t the actual user  There is another aspect for this. Usually when we need to implement security system like this, people throw into the ring the notion of Row Level Security and allowing access to specific rows by specific logins. That is a non starter from the get go, for several reasons. The previous point about infrastructure level security applies here as well, but the major problem is that it just doesn&#x2019;t work when you have more than a pittance of users.  All Row Level Security solutions that I am aware of (I am thinking specifically of some solutions provided by database vendors) requires you to login into the database using a specific user, from which your credentials can be checked against specific rows permissions.  Consider the case where you have a large number of users, and you have to login to the database for each user using their credentials. What is going to be the affect on the system?  Well, there are going to be two major problems. The first is that you can wave goodbye to small &amp; unimportant things like connection pooling, since each user have their own login, they can&#x2019;t share connections, which is going to substantially increase the cost of talking to the database.  The second is a bit more complex to explain. When the system perform an operation as a result of a user action, there are distinct differences between work that the system performs on behalf of the user and work that the system performs on behalf of the system.  Let us go back to our Debt Collection Agency and look at an example:     As a Debt Collector, I can finalize a settlement plan with a debtor, so the agency can make a lot of money.         A Debt Collector may only view settlement plans for the vendors that they handle debt collection for.      Settlement plan cannot be finalized if (along with other plans that may exists) the settlement plan would result in over 70% of the debtor salary going into paying debts.      This is pretty simple scenario. If I am collecting debts for ACME, I can&#x2019;t take a peek and see how debts handle be EMCA, ACME&#x2019;s competitor, are handled. And naturally, if the debtor&#x2019;s income isn&#x2019;t sufficient to pay the debt, it is pretty obvious that the settlement plan isn&#x2019;t valid, and we need to consider something else.  Now, let us look at how we would actually implement this, the first rule specifies that we can&#x2019;t see other settlement plans, but for us to enforce the second rule, we must see them, even if they belong to other creditors. In other words, we have a rule where the system need to execute in the context of the system and not in the context of the user.  You will be surprised how often such scenarios come up when building complex systems. When your security system is relying on the logged on user for handling security filtering, you are going to run into a pretty hard problem when it comes the time to handle those scenarios.  Considerations  So, where does this leave us? It leave us with the following considerations when the time comes to build&#xA0; an authorization implementation:     You can&#x2019;t handle authorization in the infrastructure, there isn&#x2019;t enough context to make decisions there.    Relying on the logged on user for row/document level security is a good way to have a wall hit your head in a considerable speed.    Authorization must be optional, because we need to execute some operations to ensure valid state outside the security context of a single user.    Authorization isn&#x2019;t limited to the small set of operations that you can perform from infrastructure perspective (Read / Write) but have business meaning that you need to consider.</p>
        </article>
        <article id="article-5360">
            <a href="https://ayende.com/blog/4558/an-interesting-ravendb-bug" target="_blank">
                <h2 class="title mb-6" id="article-5360">An interesting RavenDB bug</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 22, 2010
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got a very strange bug report recently,   The following index:     from movie in docs.Movies&#xA;from actor in movie.Actors&#xA;select new { Actor = actor }&#xA;  &#xA;&#xA;&#xA;&#xA;Will produce multiple results from a single document, which poses a pretty big problem when you try to page through that. Imagine that each movie has 10 actors, and you are trying to page through this index for the first two documents of movies by Charlie Chaplin. The first movie that matches Charlie Chaplin will have ten results returned from the index, and simple paging at the index level will give us the wrong results.&#xA;&#xA;Here is my solution for that, which works, but make me just a tad uneasy:&#xA;&#xA;public IEnumerable&lt;IndexQueryResult&gt; Query(IndexQuery indexQuery)&#xA;{&#xA;    IndexSearcher indexSearcher;&#xA;    using (searcher.Use(out indexSearcher))&#xA;    {&#xA;        var previousDocuments = new HashSet&lt;string&gt;();&#xA;        var luceneQuery = GetLuceneQuery(indexQuery);&#xA;        var start = indexQuery.Start;&#xA;        var pageSize = indexQuery.PageSize;&#xA;        var skippedDocs = 0;&#xA;        var returnedResults = 0;&#xA;        do&#xA;        {&#xA;            if(skippedDocs &gt; 0)&#xA;            {&#xA;                start = start &#x2B; pageSize;&#xA;                // trying to guesstimate how many results we will need to read from the index&#xA;                // to get enough unique documents to match the page size&#xA;                pageSize = skippedDocs * indexQuery.PageSize; &#xA;                skippedDocs = 0;&#xA;            }&#xA;            var search = ExecuteQuery(indexSearcher, luceneQuery, start, pageSize, indexQuery.SortedFields);&#xA;            indexQuery.TotalSize.Value = search.totalHits;&#xA;            for (var i = start; i &lt; search.totalHits &amp;&amp; (i - start) &lt; pageSize; i&#x2B;&#x2B;)&#xA;            {&#xA;                var document = indexSearcher.Doc(search.scoreDocs[i].doc);&#xA;                if (IsDuplicateDocument(document, indexQuery.FieldsToFetch, previousDocuments))&#xA;                {&#xA;                    skippedDocs&#x2B;&#x2B;;&#xA;                    continue;&#xA;                }&#xA;                returnedResults&#x2B;&#x2B;;&#xA;                yield return RetrieveDocument(document, indexQuery.FieldsToFetch);&#xA;            }&#xA;        } while (skippedDocs &gt; 0 &amp;&amp; returnedResults &lt; indexQuery.PageSize);&#xA;    }&#xA;}</p>
        </article>
        <div class="button flex justify-between">
            <a href="535.html"><span class="back arrow"></span></a>

            <a href="537.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>