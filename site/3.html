
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 3 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-21">
            <a href="https://www.meziantou.net/detect-missing-migrations-in-entity-framework-core.htm" target="_blank">
                <h2 class="title mb-6" id="article-21">Detect missing migrations in Entity Framework Core</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 17, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Entity Framework Core allows to update the database schema using migrations. The migrations are created manually by running a CLI command. It&#x27;s easy to forget to create a new migration when you change the model. To ensure the migrations are up-to-date, you can write a test that compares the current</p>
        </article>
        <article id="article-22">
            <a href="https://ayende.com/blog/201990-A/ravendb-7-1-reclaiming-disk-space" target="_blank">
                <h2 class="title mb-6" id="article-22">RavenDB 7.1</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 14, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After describing in detail the major refactoring we did for how RavenDB (via Voron, its storage engine) has gone through, there is one question remaining. What&#x2019;s the point? The code is a lot&#xA0;simpler, of course, but the whole point of this much effort is to allow us to do interesting things.There is performance, of course, but we haven&#x2019;t gotten around to testing that yet because something that is a lot&#xA0;more interesting came up: Disk space management. Voron allocates disk space from the operating system in batches of up to 1GB at a time. This is done to reduce file fragmentation and allow the file system to optimize the disk layout. It used to be something critical, but SSDs and NVMe made that a lot less important (but still a&#xA0;factor).What happens if we have a very large database, but we delete a big collection of documents? This is a case where the user&#x2019;s expectations and Voron&#x2019;s behavior diverge. A user who just deleted a few million documents would expect to see a reduction in the size of the database. But Voron will mark the area on the disk as &#x201C;to-be-used-later&#x201D; and won&#x2019;t free the disk space back to the operating system. There were two reasons for this behavior:We designed Voron in an era where it was far more common for systems to have hard disks, where fragmentation was a very serious problem. It is really complicated to actually release disk space back to the operating system.The first reason is no longer that relevant, since most database servers can reasonably expect to run on SSD or NVMe these days, significantly reducing the cost of fragmentation. The second reason deserves a more in-depth answer.In order to release disk space back to the operating system, you have to do one of three things:Store the data across multiple files and delete a file where it is no longer in use.Run compaction, basically re-build the database from scratch in a compact form.Use advanced features such as sparse files (hole punching) to return space to the file system without changing the file size.The first option, using multiple files, is possible but pretty complex. Mostly because of the details of how you split to multiple files, whenever a single entry in an otherwise empty file will prevent its deletion, etc. There are also practical issues, such as the number of open file handles that are allowed, internal costs at the operating system level, etc.Compaction, on the other hand, requires that you have enough space available during the compaction to run. In other words, if your disk is 85% full, and you delete 30% of the data, you don&#x2019;t have free space to run a compaction. Another consideration for compaction is that it can be really expensive. Running compaction on a 100GB database, for example, can easily take hours and in the cloud will very quickly exhaust your I/O credits.RavenDB &amp; Voron have supported compaction for over a decade, but it was always something that you did on very rare occasions. A user had to manually trigger it, and the downsides are pretty heavy, as you can see.In most cases, I have to say, returning disk space back to the operating system is not something that is that interesting. That free space is handled by RavenDB and will be reused before we&#x2019;ll allocate any additional new space from the OS. However, this is one of those features that keep coming up, because we go against users&#x2019; expectations. The final option I discussed is using hole punching or sparse files (the two are pretty much equivalent - different terms between operating systems). The idea is that we can go to the operating system and tell it that a certain range in the file is not used, and that it can make use of that disk space again. Any future read from that range will return zeroes. If you write to this region, the file system will allocate additional space for those writes.That behavior is problematic for RavenDB, because we used to use memory-mapped I/O to write to the disk. If there isn&#x2019;t sufficient space to write, memory-mapped I/O is going to generate a segmentation fault / access violation. In general, getting an access violation because of a disk full is not&#xA0;okay by us, so we couldn&#x2019;t use sparse files. The only option we were able to offer to reduce disk space was full compaction.You might have noticed that I used past tense in the last paragraph. That is because I am now no longer limited to using just memory-mapped I/O. Using normal I/O for this purpose works&#xA0;even if we run out of disk space, we will get the usual disk full error (which we are already handling anyway). Yes, that means that starting with RavenDB 7.1, we&#x2019;ll automatically release free disk space directly back to the operating system, matching your likely expectations about the behavior. This is done in increments of 1MB, since we still want to reduce fragmentation and the number of file metadata that the file system needs to manage.The one MB triggerRavenDB will punch a hole in the file whenever there is a consecutive 1MB of free space. This is important to understand because of fragmentation. If you wrote 100 million documents, each 2 KB in size, and then deleted every second document, what do you think will happen? There won&#x2019;t be&#xA0;any consecutive 1MB range for us to free.Luckily, that sort of scenario tends to be pretty rare, and it is far more common to have clustering of writes and deletes, which allow us to take advantage of locality and free the disk space back to the OS automatically.RavenDB will first use all the free space inside the file, reclaiming sparse regions as needed, before it will request additional disk space from the OS. When we do&#xA0;request additional space, we&#x2019;ll still get it in large chunks (and without using sparse files). That is because it is far more likely to be immediately used, and we want to avoid giving the file system too much work.Note that the overall file&#xA0;size is going to stay the same, but the actually used&#xA0;disk space is going to be reduced. We updated the RavenDB Studio to report both numbers, but when browsing the files manually, you need to keep that in mind.I expect that this will be most noticeable for users who are running on cloud instances, where it is common to size the disks to be just sufficiently big enough for actual usage. It Just WorksThere is no action that you need to take to enable this behavior, and on first start of RavenDB 7.1, it will immediately release any free space already in the data files. The work was actually completed and merged in August 2024, but it is going to be released sometime in Q2/Q3 of 2025. You might have noticed that there have been a lot&#xA0;of low-level changes targeted at RavenDB 7.1. We need to run them through the wringer to make sure that everything works as it should.I&#x2019;m looking forward to seeing this in action, there are some really nice indications about the sort of results we can expect. I&#x2019;ll talk about that in more detail in another post, this one is getting long enough.</p>
        </article>
        <article id="article-23">
            <a href="https://devblogs.microsoft.com/dotnet/enhancing-razor-productivity-with-new-features/" target="_blank">
                <h2 class="title mb-6" id="article-23">New Features for Enhanced Razor Productivity!</h2>
            </a>
            <p class="mb-2">by Leslie Richardson</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 13, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The Extract to Component refactoring and the Roslyn tokenizer are two new features designed to help improve your productivity in Razor files.</p>
        </article>
        <article id="article-24">
            <a href="https://ayende.com/blog/201959-A/ravendb-7-1-write-modes" target="_blank">
                <h2 class="title mb-6" id="article-24">RavenDB 7.1</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 12, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post, I talked about a massive amount of effort (2&#x2B; months of work) and about 25,000 lines of code changes. The only purpose of this task was to remove two locks from the system. During high load, we spent huge&#xA0;amounts of time contending for these locks, so removing them was well worth the effort.During this work, I essentially found myself in the guts of Voron (RavenDB&#x2019;s storage engine) and mostly dealing with old&#xA0;code. I&#x2019;m talking about code that was written between 10 and 15 years ago. I wrote a blog post about it at the time. Working with old code is an interesting experience, especially since most of this code was written by me. I can remember some of my thoughts from the time I wrote it.Old code is working code, and old code is also something that was built upon. Other parts of the codebase are making assumptions about the way the system behaves. And the more time a piece of code doesn&#x27;t change, the more likely its behavior is going to ossify. Changing old code is hard because of the many ways that such dependencies can express themselves. I dug through all of this decade-plus old code and I realized something pretty horrible. It turns out that I made a mistake&#xA0;in understanding how Windows implements buffering for memory-mapped files. I realized my mistake around mid-2024, see the related post for theactual details.The TLDR summary, however, is that when using unbuffered&#xA0;file I/O with memory-mapped files on Windows, you cannot expect the mapped memory to reflect the data written using the file I/O API. Windows calls it coherence, and it was quite confusing when I first realized what the problem was. It turns out that this applies only to unbuffered I/O and there is no such problem with buffered I/O. The scenario I needed to work with can&#xA0;use buffered I/O, however, which has been a profound shock to me. Large&#xA0;portions of the architecture of Voron are actually shaped by this limitation. Because I thought that you couldn&#x2019;t use both file I/O and memory-mapped files at the same time in Windows and get a consistent view of the data (the documentation literally says that, I have to add), RavenDB used memory-mapped I/O to write to the data file. That is&#xA0;a&#xA0;choice, certainly, but not one that I particularly liked. It was just that I was able to make things work and move on to other things.This is another tale of accidental complexity, actually. I had a problem and found a solution to it, which at the time I considered quite clever. Because I had a solution, I never tried to dig any deeper into it and figure out whether this is the only solution.This choice of using only memory-mapped I/O to write to the data file had consequences. In particular, it meant that:We had to map the data using read-write mode.There was no simple way to get an error if a write failed - since we just copied the data to memory, there was no actual write&#xA0;to fail. An error to write to disk would show up as a memory access violation (segmentation fault!) or just not show up at all.Writing to a page that isn&#x2019;t in memory may require us to read it first (even if we are overwriting all of it).I accepted those limitations because I thought that this was the only way to do things. When I realized that I was wrong, that opened up so many possibilities. As far as the refactoring work, the way Voron did things changed significantly. We are now mapping the data file as read-only and writing to it using file I/O.That means we have a known point of failure&#xA0;if we fail to write. That probably deserves some explanation. Failure to write to the disk can come in a bunch of ways. In particular, successfully writing to a file is not&#xA0;enough to safely store data, you also need to sync&#xA0;the file before you can be assured that the data is safe. The key here is that write &#x2B; sync ensures that you&#x2019;ll know that this either succeeded or failed. Here is the old way&#xA0;we were writing&#xA0;to the data file. Conceptually, this looks like this:auto mem = EnsureFileSize(pagesToWrite[pagesToWriteLength - 1].EndPosition);&#xD;&#xA;for(auto i = 0; i &lt; pagesToWriteLength; i&#x2B;&#x2B;)&#xD;&#xA;{&#xD;&#xA;    auto path = pagesToWrite[i];&#xD;&#xA;    memcpy(mem &#x2B; page.Number * 8192, page.Buffer, page.Length);    &#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;// some later time&#xD;&#xA;if(FAILED(msync(mem))&#xD;&#xA;   return SYNC_FAILURE;And here is the first iteration of using the file I/O API for writes.fallocate_if_needed(pagesToWrite[pagesToWriteLength - 1].EndPosition);&#xD;&#xA;for(auto i = 0; i &lt; pagesToWriteLength; i&#x2B;&#x2B;)&#xD;&#xA;{&#xD;&#xA;    auto path = pagesToWrite[i];&#xD;&#xA;    if(FAILED(pwrite(page.Number * 8192, page.Buffer, page.Length)))&#xD;&#xA;         return WRITE_FAILURE;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;// some time later&#xD;&#xA;if (FAILED(fdatasync(file))&#xD;&#xA;   return SYNC_FAILURE;Conceptually, this is just the same, but notice that we respond immediately to write failures here. When we started testing this feature, we realized something really interesting. The new version was much&#xA0;slower than the previous one, and it also generated a lot&#xA0;more disk writes.I moved mountains for this?Sometimes you get a deep sense of frustration when you look at benchmark results. The amount of work invested in this change is&#x2026; pretty high. And from an architectural point of view, I&#x2019;m loving&#xA0;it. The code is simpler, more robust, and allows us to cleanly do a lot&#xA0;more than we used to be able to.The code also should&#xA0;be much faster, but it wasn&#x2019;t. And given that performance is a critical aspect of RavenDB, that may cause us to scrap the whole thing. Looking more deeply into the issue, it turned out that my statement about old code and the state of the system was spot on. Take a look at the two code snippets above and consider how they look from the point of view of the operating system. In the case of the memcpy()&#xA0;version, there is a strong likelihood that the kernel isn&#x2019;t even involved (the pages are already paged in), and the only work done here is marking them as dirty (done by the CPU directly).That means that the OS will figure out that it has stuff to write to the disk either when we call msync() or when its own timer is called. On the other hand, when we call pwrite(), we involve the OS at every stage of the process, making it far more likely that it will start the actual write to the disk earlier. That means that we are wasting batching opportunities.In other words, because we used memory-mapped writes, we (accidentally, I might add) created a situation where we tried very hard to batch those writes in memory as much as possible. Another aspect here is that we are issuing a separate&#xA0;system call for each page. That means we are paying another high price. The good thing about this is that we now have a good way to deal&#xA0;with those issues. The pwrite()&#xA0;code above was simply the first version used to test things out. Since we now have the freedom&#xA0;to run, we can use whatever file I/O we want.In particular, RavenDB 7.1 now supports the notion of write modes, with the following possible options:mmap - exactly like previous versions, uses a writable memory map and memcpy()&#xA0;to write the values to the data file.file_io - uses&#xA0;pwrite()&#xA0;to write the data, onc page at a time, as shown above.vectored_file_io - uses pwritev()&#xA0;to write the data, merging adjacent writes to reduce the number of system calls we use (Posix only, since Windows has strict limits on this capability).io_ring - uses HIORING (Windows) / IO_Uring&#xA0;(Linux) to submit the whole set of work to the kernel as a single batch of operations.RavenDB will select the appropriate mode for the system on its own, usually selecting io_ring&#xA0;for modern Linux and Windows machines, and vectored_file_io&#xA0;for Mac. You can control that using the RAVEN_VORON_WRITER_MODE environment variable, but that is provided only because we want to have an escape hatch, not something that you are meant to configure.With those changes, we are on a much&#xA0;better footing for overall performance, but we aren&#x2019;t done yet! I would love to give you the performance numbers, but we didn&#x2019;t actually run the full test suite with just these changes. And that is because we aren&#x2019;t done yet, I&#x2019;ll cover that in the next post.</p>
        </article>
        <article id="article-25">
            <a href="https://ardalis.com/when-qa-keeps-finding-bugs/" target="_blank">
                <h2 class="title mb-6" id="article-25">When QA Keeps Finding Bugs</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 12, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A developer manager recently reached out with a concern: their new QA team member was finding too many bugs, leading to frustration among&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-26">
            <a href="https://devblogs.microsoft.com/dotnet/announcing-generative-ai-for-beginners-dotnet/" target="_blank">
                <h2 class="title mb-6" id="article-26">Announcing Generative AI for Beginners &#x2013; .NET</h2>
            </a>
            <p class="mb-2">by Pablo Lopes</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 12, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Introducing a new practical course designed for the .NET community to explore the world of Generative AI.</p>
        </article>
        <article id="article-27">
            <a href="https://devblogs.microsoft.com/dotnet/dotnet-and-dotnet-framework-february-2025-servicing-updates/" target="_blank">
                <h2 class="title mb-6" id="article-27">.NET and .NET Framework February 2025 servicing releases updates</h2>
            </a>
            <p class="mb-2">by Tara,Rahul</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 11, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A recap of the latest servicing updates for .NET and .NET Framework for February 2025.</p>
        </article>
        <article id="article-28">
            <a href="https://devblogs.microsoft.com/dotnet/csharp-on-visual-studio-code-just-got-better-with-enhancements-to-csharp-dev-kit/" target="_blank">
                <h2 class="title mb-6" id="article-28">C# Dev Kit Updates: .NET Aspire, Hot Reload, and More!</h2>
            </a>
            <p class="mb-2">by Wendy Breiding (SHE/HER)</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 11, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Exploring the latest features and enhancements in the C# Dev Kit for VS Code including .NET Aspire orchestration support, new hot reload features, enhanced debugging capabilities, and more!</p>
        </article>
        <article id="article-29">
            <a href="https://andrewlock.net/preventing-client-side-cross-site-scripting-vulnerabilities-with-trusted-types/" target="_blank">
                <h2 class="title mb-6" id="article-29">Preventing client-side cross-site-scripting vulnerabilities with Trusted Types</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 11, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I describe how the Trusted Types Content-Security-Policy feature can protect you against cross-site-scripting attacks.&#x2026;</p>
        </article>
        <article id="article-30">
            <a href="https://ayende.com/blog/201955-A/ravendb-7-1-next-gen-pagers" target="_blank">
                <h2 class="title mb-6" id="article-30">RavenDB 7.1</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 10, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Even though RavenDB 7.0 isn&#x2019;t quite out of the gate yet (expect the release very&#xA0;soon), I want to start talking about the RavenDB 7.1 release. This release is going to represent the biggest change in RavenDB in about 7 years, and at the same time, it is expected to be a complete non-event for most people.We care enough about performance that we have both a dedicated team to verify it&#xA0;as well as really talented people whose sole job is to run benchmarks and optimize RavenDB. This year, the goal was to test RavenDB&#x2019;s performance when running on large&#xA0;machines (many hundreds of GBs or RAM, dozens of cores, etc). The idea was to find bottlenecks and remove them, and we quickly found a few. Performance optimization is often a very repetitive process. Find a problem, figure out the root cause, and move on. It is a process full of small changes and 0.1% improvements. The key is that if you practice this routinely, you end up with real measurable results over time, since your changes compound. Most of the time, these are the changes you celebrate:Here you can see a 6.6% increase in the number of operations per millisecond. That is a pretty big change, especially since it affects reading documents from storage. We were roughly two months into this process when we ran into the end of the line. The scenario in question was 95% reads / 5% writes, with the idea of seeing how quickly the system responds under load, but without stressing it to the limits. Take a look at our findings:What you can see here is that creating a transaction is&#xA0;costly, andover 50% of that cost is due to contention over a lock. We didn&#x2019;t notice that until we had a lot&#xA0;of cores to go around, since there wasn&#x2019;t a sufficient number of threads actively contending for this lock. Once we started looking for it, the problem was very apparent and visible on smaller machines as well. RavenDB creates a single transaction per request, so that means we are spending a lot of time doing essentially nothing useful. What is worse, this is actively&#xA0;spinning. So the more cores we have, the more CPU we&#x2019;ll use and the less useful work we&#x2019;ll do. Yuck!When we looked at the root cause, the problem became pretty apparent. Take a look at the following snippet:_txCreation.EnterReadLock(); // creating read transaction&#xD;&#xA;try&#xD;&#xA;{&#xD;&#xA;    _cancellationTokenSource.Token.ThrowIfCancellationRequested();&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    tx = new LowLevelTransaction(previous.LowLevelTransaction, transactionPersistentContext, context);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    ActiveTransactions.Add(tx);&#xD;&#xA;}&#xD;&#xA;finally&#xD;&#xA;{&#xD;&#xA;    _txCreation.ExitReadLock();&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;using (PreventNewTransactions()) // during commit of write transaction&#xD;&#xA;{&#xD;&#xA;    if (tx.Committed &amp;&amp; tx.FlushedToJournal)&#xD;&#xA;        Interlocked.Exchange(ref _transactionsCounter, tx.Id);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    State = tx.State;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    Journal.Applicator.OnTransactionCommitted(tx);&#xD;&#xA;    ScratchBufferPool.UpdateCacheForPagerStatesOfAllScratches();&#xD;&#xA;    Journal.UpdateCacheForJournalSnapshots();&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    tx.OnAfterCommitWhenNewTransactionsPrevented();&#xD;&#xA;}What happens is that during the commit of a write transaction we need to make updates to a bunch of places. We also need all new read transactions to see all our changes at once. So during commit, we take a short lock to update a couple of locations. And when we create a write transaction, we hold a read lock to be able to properly read all those values safely.This particular code (and the approach in general) dates back to the very early days of Voron:On one hand, I look at this code and cringe internally. On the other&#xA0;hand, it has served us really well for a long time. Of course, on the gripping hand, that code has been around for long enough to have grown some barnacles. Notice the OnAfterCommitWhenNewTransactionsPrevented() call we have there? It is meant to allow other operations&#xA0;that need to run while no read transactions are allowed, in order to maintain in-memory consistency. Fixing this issue was both straightforward and quite complex at the same time. Instead of storing all the data in various places, I introduced the following record:record EnvironmentStateRecord(&#xD;&#xA;    Pager.State DataPagerState, &#xD;&#xA;    long TransactionId,&#xD;&#xA;    ImmutableDictionary&lt;long, PageFromScratchBuffer&gt; ScratchPagesTable,&#xD;&#xA;    TreeRootHeader Root,&#xD;&#xA;    long NextPageNumber,&#xD;&#xA;    (long Number, long Last4KWritePosition) Journal,&#xD;&#xA;    object ClientState);The actual details of what it does aren&#x2019;t really that interesting. What is important is that we have an immutable record that is being generated by the write transaction. That record contains all the database state that we carry over between transactions. When we want to publish this state, we can just make a single atomic write to a pointer, no need for a lock.Of course, it can&#x2019;t&#xA0;be that simple. We needed to essentially convert large portions of the code to take their state from the environment record and provide a way for higher-level code to add their own state to the record on write. That took about two months of hard&#xA0;work, I think. Not complicated work, just grinding through all of those places, figuring out the best way to represent that, and making all the necessary changes. Unfortunately, that wasn&#x2019;t the only lock convoy we found. Files inside RavenDB are held by a class called Pager (since it serves pages&#xA0;of data). A file (Pager) may hold multiple States, which is a fancy way of referring to a memory-mapped range we use. The Pager may hold multiple such&#xA0;mapping concurrently. For example, if we increase the file size, we need to map the memory again&#xA0;- so for a certain period of time, we have two such mappings.A transaction may create a reference to such a state (and thus may access the mapping) for its lifetime. At the end of the transaction, we can release the state, and if it is the last reference, we&#x2019;ll close the mapping. This is implemented using the following code:This runs for multiple&#xA0;Pagers for each transaction, mind you. The actual AddRef()&#xA0;call is very cheap, but the lock&#x2026;public void AddRef() =&gt; Interlocked.Increment(ref _refs);As you can see from the image, this is also pretty old code. The problem was how to deal with the issue. I have&#xA0;to be able to keep track of the mapped memory if a transaction is using it, but at the same time, I want to dispose of it quickly if it isn&#x2019;t being used. The answer to this question was to lean on the GC. Instead of implementing AddRef()&#xA0;/ Release(), I hold the Pager.State&#xA0;object and handle disposal in the finalizer. If there is a reference to it, the finalizer isn&#x2019;t called, so this gives me the exact behavior I want, for free. However&#x2026; I also need to be able to dispose of this explicitly when closing the pager. A common scenario is that I&#x2019;m closing the Pager and deleting the directory. If I have an outstanding reference to the file, that will fail. Here is how I&#x2019;m dealing with the issue. The Pager holds a Weak-Reference to the State and may explicitly dispose of it:public void Dispose()&#xD;&#xA;{&#xD;&#xA;    foreach (WeakReference&lt;State&gt; state in _states)&#xD;&#xA;    {&#xD;&#xA;        if (state.TryGetTarget(out var v))&#xD;&#xA;        {&#xD;&#xA;            v.Dispose();&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}That also allowed me to refactor the way we deal with files in general inside Voron. The first version of Voron did everything in managed code (including significant P/Invoke and cross-platform work). At some point, we introduced a native DLL (PAL - Platform Abstraction Layer - written in C) that allowed us to have a more consistent API.The issue was that there was no clean division of labor between the native C code and the managed code, and some responsibilities were split between them in a way that wasn&#x2019;t very clean. RavenDB is using ZigTo be rather more exact, I&#x2019;m using Zig as a build system to make cross-compilation a lot&#xA0;easier. I initially moved everything to use Zig, but it turns out that Zig isn&#x2019;t able to produce DLLs that would run properly on older versions of Windows. At least, nothing that I did convinced Zig to give me something that wouldn&#x2019;t fail to load. So we are still using MSVC to compile for Windows and then Zig to both Linux &amp; Mac (x64 &amp; ARM). If you have good ideas on how to solve that, I would really appreciate it.As a final thought, this work took several months, and when I got to the end, we got a pull request with some interesting numbers (&#x2B;11.3K LOC, -11.2K LOC). I have to admit that I feel a bit bad about that for the reviewers &#x1F642;. I was really hoping that I would get a net negative result in the number of lines changed, but that couldn&#x2019;t be helped. The end result is that all of our state is now far simpler, but we didn&#x2019;t actually change&#xA0;anything in the way we behave. We removed two frequently hit lock convoys and allowed RavenDB to be far more efficient. How efficient? Well&#x2026; that is a bit complex to answer, because we didn&#x2019;t stop here. There are more things that happened in RavenDB 7.1 that I need to talk to you about. We&#x2019;ll cover them in my next post.</p>
        </article>
        <div class="button flex justify-between">
            <a href="2.html"><span class="back arrow"></span></a>

            <a href="4.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>