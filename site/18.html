
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 18 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-171">
            <a href="https://devblogs.microsoft.com/dotnet/rewriting-nuget-restore-in-dotnet-9/" target="_blank">
                <h2 class="title mb-6" id="article-171">How we ended up rewriting NuGet Restore in .NET 9</h2>
            </a>
            <p class="mb-2">by The NuGet Team</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 09, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Learn about the journey that led to a full rewrite of the NuGet Restore algorithm in .NET 9, achieving break-through scale and performance.</p>
        </article>
        <article id="article-172">
            <a href="https://andrewlock.net/verifiying-tricky-git-rebases-with-range-diffs/" target="_blank">
                <h2 class="title mb-6" id="article-172">Verifying tricky git rebases with git range-diff</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 08, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I look at the git range-diff feature, show what it&#x27;s for and how it works, explain the output format, and demonstrate it with a toy scenario&#x2026;</p>
        </article>
        <article id="article-173">
            <a href="https://ayende.com/blog/202180-A/production-postmortem-the-race-condition-in-the-interlock" target="_blank">
                <h2 class="title mb-6" id="article-173">Production postmortem</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 07, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This post isn&#x2019;t actually about a production issue&#x2014;thankfully, we caught this one during testing. It&#x2019;s part of a series of blog posts that are probably some of my favorite posts to write. Why? Because when I&#x2019;m writing one, it means I&#x2019;ve managed to pin down and solve a nasty problem.&#xA0;This time, it&#x2019;s a race condition in RavenDB that took mountains of effort, multiple engineers, and a lot of frustration to resolve. For the last year or so, I&#x2019;ve been focused on speeding up RavenDB&#x2019;s core performance, particularly its IO handling. You might have seen my earlier posts about this effort. One key change we made was switching RavenDB&#x2019;s IO operations to use IO Ring, a new API designed for high-performance, asynchronous IO, and other goodies. If you&#x2019;re in the database world and care about squeezing every ounce of performance out of your system, this is the kind of thing that you want to use.This wasn&#x2019;t a small tweak. The pull request for this work exceeded 12,000 lines of code&#x2014;over a hundred commits&#x2014;and likely a lot more code when you count all the churn. Sadly, this is one of those changes where we can&#x2019;t&#xA0;just split the work into digestible pieces. Even now, we still have some significant additional work remaining to do. We had two or three of our best engineers dedicated to it, running benchmarks, tweaking, and testing over the past few months. The goal is simple: make RavenDB faster by any means necessary. And we succeeded, by a&#xA0;lot&#xA0;(and yes, more on&#xA0;that&#xA0;in a separate post). But speed isn&#x2019;t enough; it has to be correct too. That&#x2019;s where things got messy.Tests That Hang, SometimesWe noticed that our test suite would occasionally hang with the new code. Big changes like this&#x2014;ones that touch core system components and take months to implement&#x2014;often break things. That&#x2019;s expected, and it&#x2019;s why we have tests. But these weren&#x2019;t just failures; sometimes the tests would hang, crash, or exhibit other bizarre behavior. Intermittent issues are the worst. They scream &#x201C;race condition,&#x201D; and race conditions are notoriously hard to track down.Here&#x2019;s the setup. IO Ring isn&#x2019;t available in managed code, so we had to write native C code to integrate it. RavenDB already has a Platform Abstraction Layer (PAL) to handle differences between Windows, Linux, and macOS, so we had a natural place to slot this in. The IO Ring code had to be multithreaded and thread-safe. I&#x2019;ve been writing system-level code for over 20 years, and I still get uneasy about writing new multithreaded C code. It&#x2019;s a minefield. But the performance we could get&#x2026; so we pushed forward&#x2026; and now we had to see where that led us.Of course, there was a race condition. The actual implementation was under 400 lines of C code&#x2014;deliberately simple, stupidly obvious, and easy to review. The goal was to minimize complexity: handle queuing, dispatch data, and get out. I wanted something I could look at and say, &#x201C;Yes, this is correct.&#x201D; I absolutely thought that I had it covered.We ran the test suite repeatedly. Sometimes it passed; sometimes it hung; rarely, it would crash.When we looked into it, we were usually stuck on submitting work to the IO Ring. Somehow, we ended up in a state where we pushed data in and never got called back. Here is what this looked like. 0:019&gt; k&#xD;&#xA; #   Call Site&#xD;&#xA;00   ntdll!ZwSubmitIoRing&#xD;&#xA;01   KERNELBASE!ioring_impl::um_io_ring::Submit&#x2B;0x73&#xD;&#xA;02   KERNELBASE!SubmitIoRing&#x2B;0x3b&#xD;&#xA;03   librvnpal!do_ring_work&#x2B;0x16c &#xD;&#xA;04   KERNEL32!BaseThreadInitThunk&#x2B;0x17&#xD;&#xA;05   ntdll!RtlUserThreadStart&#x2B;0x2cIn the previous code sample, we just get the work and mark it as done. Now, here is the other side, where we submit the work to the worker thread.int32_t rvn_write_io_ring(void* handle, int32_t count, &#xD;&#xA;        int32_t* detailed_error_code)&#xD;&#xA;{&#xD;&#xA;        int32_t rc = 0;&#xD;&#xA;        struct handle* handle_ptr = handle;&#xD;&#xA;        EnterCriticalSection(&amp;handle_ptr-&gt;global_state-&gt;lock);&#xD;&#xA;        ResetEvent(handle_ptr-&gt;global_state-&gt;notify);&#xD;&#xA;        char* buf = handle_ptr-&gt;global_state-&gt;arena;&#xD;&#xA;        struct workitem* prev = NULL;&#xD;&#xA;        for (int32_t curIdx = 0; curIdx &lt; count; curIdx&#x2B;&#x2B;)&#xD;&#xA;        {&#xD;&#xA;                struct workitem* work = (struct workitem*)buf;&#xD;&#xA;                buf &#x2B;= sizeof(struct workitem);&#xD;&#xA;                *work = (struct workitem){&#xD;&#xA;                        .prev = prev,&#xD;&#xA;                        .notify = handle_ptr-&gt;global_state-&gt;notify,&#xD;&#xA;                };&#xD;&#xA;                prev = work;&#xD;&#xA;                queue_work(work);&#xD;&#xA;        }&#xD;&#xA;        SetEvent(IoRing.event);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        bool all_done = false;&#xD;&#xA;        while (!all_done)&#xD;&#xA;        {&#xD;&#xA;                all_done = true;&#xD;&#xA;                WaitForSingleObject(handle_ptr-&gt;global_state-&gt;notify, INFINITE)&#xD;&#xA;                ResetEvent(handle_ptr-&gt;global_state-&gt;notify);&#xD;&#xA;                struct workitem* work = prev;&#xD;&#xA;                while (work)&#xD;&#xA;                {&#xD;&#xA;                        all_done &amp;= InterlockedCompareExchange(&#xD;&#xA;&amp;work-&gt;completed, 0, 0);&#xD;&#xA;                        work = work-&gt;prev;&#xD;&#xA;                }&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        LeaveCriticalSection(&amp;handle_ptr-&gt;global_state-&gt;lock);&#xD;&#xA;        return rc;&#xD;&#xA;}We basically take each page we were asked to write and send it to the worker thread for processing, then we wait for the worker to mark all&#xA0;the requests as completed. Note that we play a nice game with the prev and next&#xA0;pointers. The next pointer is used by the worker thread while the prev pointer is used by the submitter thread.You can also see that this is being protected by a critical section (a lock) and that there are clear hand-off segments. Either I own the memory, or I explicitly give it to the background thread and wait until the background thread tells me it is done. There is no place&#xA0;for memory corruption. And yet, we could clearly get it to fail.Being able to have a small reproduction meant that we could start making changes and see whether it affected the outcome. With nothing else to look at, we checked this function:void queue_work_origin(struct workitem* work)&#xD;&#xA;{&#xD;&#xA;    work-&gt;next = IoRing.head;&#xD;&#xA;    while (true)&#xD;&#xA;    {&#xD;&#xA;        struct workitem* cur_head = InterlockedCompareExchangePointer(&#xD;&#xA;                        &amp;IoRing.head, work, work-&gt;next);&#xD;&#xA;        if (cur_head == work-&gt;next)&#xD;&#xA;            break;&#xD;&#xA;        work-&gt;next = cur_head;&#xD;&#xA;    }&#xD;&#xA;}I have written similar code dozens of times, I very intentionally made the code simple so it would be obviously correct.&#xA0;But when I even slightly tweaked the queue_work&#xA0;function, the issue vanished. That wasn&#x2019;t good enough, I needed to know what&#xA0;was going on.Here is the &#x201C;fixed&#x201D; version of the queue_work&#xA0;function:void queue_work_fixed(struct workitem* work)&#xD;&#xA;{&#xD;&#xA;        while (1)&#xD;&#xA;        {&#xD;&#xA;                struct workitem* cur_head = IoRing.head;&#xD;&#xA;                work-&gt;next = cur_head;&#xD;&#xA;                if (InterlockedCompareExchangePointer(&#xD;&#xA;&amp;IoRing.head, work, cur_head) == cur_head)&#xD;&#xA;                        break;&#xD;&#xA;        }&#xD;&#xA;}This is functionally the same thing. Look at those two functions! There shouldn&#x2019;t be a difference between them. I pulled up the assembly output for those functions and stared at it for a long while.1 work$ = 8&#xD;&#xA; 2 queue_work_fixed PROC                             ; COMDAT&#xD;&#xA; 3        npad    2&#xD;&#xA; 4 $LL2@queue_work:&#xD;&#xA; 5        mov     rax, QWORD PTR IoRing&#x2B;32&#xD;&#xA; 6        mov     QWORD PTR [rcx&#x2B;8], rax&#xD;&#xA; 7        lock cmpxchg QWORD PTR IoRing&#x2B;32, rcx&#xD;&#xA; 8        jne     SHORT $LL2@queue_work&#xD;&#xA; 9        ret     0&#xD;&#xA;10 queue_work_fixed ENDPA total of ten lines of assembly. Here is what is going on:Line 5 - we read the IoRing.head&#xA0;into register rax (representing cur_head).Line 6 - we write the rax register (representing cur_head) to work-&gt;next.Line 7 - we compare-exchange the value of IoRing.head&#xA0;with the value in rcx (work) using rax (cur_head) as the comparand.Line 8 - if we fail to update, we jump to line 5 again and re-try.That is about as simple a code as you can get, and exactly expresses the intent in the C code. However, if I&#x2019;m looking at the original version, we have:1 work$ = 8&#xD;&#xA; 2 queue_work_origin PROC                               ; COMDAT&#xD;&#xA; 3         npad    2&#xD;&#xA; 4 $LL2@queue_work_origin:&#xD;&#xA; 5         mov     rax, QWORD PTR IoRing&#x2B;32&#xD;&#xA; 6         mov     QWORD PTR [rcx&#x2B;8], rax&#xD;&#xA;;                        &#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193; &#xD;&#xA; 7         mov     rax, QWORD PTR IoRing&#x2B;32&#xD;&#xA;;                        &#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#xD;&#xA; 8         lock cmpxchg QWORD PTR IoRing&#x2B;32, rcx&#xD;&#xA; 9         cmp     rax, QWORD PTR [rcx&#x2B;8]&#xD;&#xA;10         jne     SHORT $LL2@queue_work_origin&#xD;&#xA;11         ret     0&#xD;&#xA;12 queue_work_origin ENDPThis looks mostly&#xA0;the same, right? But notice that we have just a few more lines. In particular, lines 7, 9, and 10 are new. Because we are using a field, we cannot compare to cur_head directly like we previously did but need to read work-&gt;next&#xA0;again on lines 9 &amp;10. That is fine.What is not&#xA0;fine is line 7. Here we are reading IoRing.headagain, and work-&gt;next&#xA0;may point to another&#xA0;value. In other words, if I were to decompile this function, I would have:void queue_work_origin_decompiled(struct workitem* work)&#xD;&#xA;{&#xD;&#xA;    while (true)&#xD;&#xA;    {&#xD;&#xA;        work-&gt;next = IoRing.head;&#xD;&#xA;//                        &#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193;&#x2193; &#xD;&#xA;        struct workitem* tmp = IoRing.head;&#xD;&#xA;//                        &#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#x2191;&#xD;&#xA;        struct workitem* cur_head = InterlockedCompareExchangePointer(&#xD;&#xA;                        &amp;IoRing.head, work, tmp);&#xD;&#xA;        if (cur_head == work-&gt;next)&#xD;&#xA;            break;&#xD;&#xA;    }&#xD;&#xA;}Note the new tmp&#xA0;variable? Why is it reading this twice? It changes the entire&#xA0;meaning of what we are trying to do here. You can look at the output directly in the Compiler Explorer.This smells like a compiler bug. I also checked the assembly output of clang, and it doesn&#x2019;t have this behavior.I opened a feedback item with MSVC to confirm, but the evidence is compelling. Take a look at this slightly different version of the original. Instead of using a global variable in this function, I&#x2019;m passing the pointer to it. void queue_work_origin_pointer(&#xD;&#xA;struct IoRingSetup* ring, struct workitem* work)&#xD;&#xA;{&#xD;&#xA;        while (1)&#xD;&#xA;        {&#xD;&#xA;                struct workitem* cur_head = ring-&gt;head;&#xD;&#xA;                work-&gt;next = cur_head;&#xD;&#xA;                if (InterlockedCompareExchangePointer(&#xD;&#xA;&amp;ring-&gt;head, work, work-&gt;next) ==  work-&gt;next)&#xD;&#xA;                        break;&#xD;&#xA;        }&#xD;&#xA;}And here is the assembly output, without&#xA0;the additional load. ring$ = 8&#xD;&#xA;work$ = 16&#xD;&#xA;queue_work_origin PROC                              ; COMDAT&#xD;&#xA;        prefetchw BYTE PTR [rcx&#x2B;32]&#xD;&#xA;        npad    12&#xD;&#xA;$LL2@queue_work:&#xD;&#xA;        mov     rax, QWORD PTR [rcx&#x2B;32]&#xD;&#xA;        mov     QWORD PTR [rdx&#x2B;8], rax&#xD;&#xA;        lock cmpxchg QWORD PTR [rcx&#x2B;32], rdx&#xD;&#xA;        cmp     rax, QWORD PTR [rdx&#x2B;8]&#xD;&#xA;        jne     SHORT $LL2@queue_work&#xD;&#xA;        ret     0&#xD;&#xA;queue_work_origin ENDPThat unexpected load was breaking our thread-safety assumptions, and that led to a whole mess&#xA0;of trouble. Violated invariants are no joke. The actual fix was pretty simple, as you can see. Finding&#xA0;it was a huge hurdle. The good news is that I got really&#xA0;familiar with this code, to the point that I got some good ideas on how to improve it further &#x1F642;.</p>
        </article>
        <article id="article-174">
            <a href="https://devblogs.microsoft.com/dotnet/build-a-model-context-protocol-mcp-server-in-csharp/" target="_blank">
                <h2 class="title mb-6" id="article-174">Build a Model Context Protocol (MCP) server in C#</h2>
            </a>
            <p class="mb-2">by James Montemagno</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 07, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Learn how to build a Model Context Protocol (MCP) server using the C# SDK to enable seamless communication between AI models and applications.</p>
        </article>
        <article id="article-175">
            <a href="https://www.meziantou.net/how-to-use-a-natural-sort-in-powershell.htm" target="_blank">
                <h2 class="title mb-6" id="article-175">How to use a natural sort in PowerShell</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 07, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">PowerShell doesn&#x27;t provide a built-in way to use a natural sort. However, you can use the Sort-Object cmdlet with a custom script block to achieve a natural sort. In this post, I describe how you can use a natural sort in PowerShell.#What is a natural sort?A natural sort is a sorting algorithm that</p>
        </article>
        <article id="article-176">
            <a href="https://ayende.com/blog/202243-A/ravendb-on-aws-marketplace" target="_blank">
                <h2 class="title mb-6" id="article-176">RavenDB on AWS Marketplace</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 04, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We just announced the general availability of RavenDB on AWS Marketplace. By joining AWS Marketplace, we provide users with a seamless purchasing experience, flexible deployment options, and direct integration with their AWS billing. You can go directly to RavenDB on AWS Marketplace here.That means:One-click cluster deploymentEasy scaling for growing workloadsHigh-availability and security&#xA0;on AWS Most importantly, being a partner in AWS Marketplace allows us to optimize costs and offer you flexible billing options via the Marketplace. This opens up a whole new world of opportunities for collaboration.You can find more at the following link.</p>
        </article>
        <article id="article-177">
            <a href="https://ayende.com/blog/202277-B/ravendb-net-aspire-integration" target="_blank">
                <h2 class="title mb-6" id="article-177">RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 02, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">.NET Aspire is a framework for building cloud-ready distributed systems in .NET. It allows you to orchestrate your application along with all its dependencies, such as databases, observability tools, messaging, and more. RavenDB now has full support for .NET Aspire. You can read the full details in this article, but here is a sneak peek.Defining RavenDB deployment as part of your host definition:using Projects;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;var builder = DistributedApplication.CreateBuilder(args);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;var serverResource = builder.AddRavenDB(name: &quot;ravenServerResource&quot;);&#xD;&#xA;var databaseResource = serverResource.AddDatabase(&#xD;&#xA;    name: &quot;ravenDatabaseResource&quot;, &#xD;&#xA;    databaseName: &quot;myDatabase&quot;);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;builder.AddProject&lt;RavenDBAspireExample_ApiService&gt;(&quot;RavenApiService&quot;)&#xD;&#xA;    .WithReference(databaseResource)&#xD;&#xA;    .WaitFor(databaseResource);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;builder.Build().Run();And then making use of that in the API projects:var builder = WebApplication.CreateBuilder(args);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;builder.AddServiceDefaults();&#xD;&#xA;builder.AddRavenDBClient(connectionName: &quot;ravenDatabaseResource&quot;, configureSettings: settings =&gt;&#xD;&#xA;{&#xD;&#xA;    settings.CreateDatabase = true;&#xD;&#xA;    settings.DatabaseName = &quot;myDatabase&quot;;&#xD;&#xA;});&#xD;&#xA;var app = builder.Build();&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;// here we&#x2019;ll add some API endpoints shortly&#x2026;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;app.Run();You can read all the details here. The idea is to make it easier &amp; simpler for you to deploy RavenDB-based systems.</p>
        </article>
        <article id="article-178">
            <a href="https://ayende.com/blog/202307-C/introducing-rook-ai" target="_blank">
                <h2 class="title mb-6" id="article-178">Introducing Rook AI</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 01, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Say hello to Rook AI. RavenDB&#x2019;s mascot just went beyond the singularity and then some.We cranked up the AI to a whole new level. Rook doesn&#x2019;t just handle queries, it gets them. Your data, your queries, your wishes.Need a query? Done. Forgot something? Rook&#x2019;s on it. Lottery numbers? Rook picked a few good ones.Powered by QLBM (Quantum Large Beak Model&#x2122;), it&#x2019;s always one step ahead.Clippy walked so this bird could fly.</p>
        </article>
        <article id="article-179">
            <a href="https://devblogs.microsoft.com/dotnet/modernizing-push-notification-api-for-teams/" target="_blank">
                <h2 class="title mb-6" id="article-179">Modernizing push notification API for Teams</h2>
            </a>
            <p class="mb-2">by Rudolf,Frantisek</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 01, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Push Notification Hub is an essential internal service that plays a crucial role in the messaging and calling flows within Teams and other platforms. This article describes its recent overhaul, which has significantly enhanced its performance and reduced latencies in delivering push notifications to user devices</p>
        </article>
        <article id="article-180">
            <a href="https://andrewlock.net/creating-sbom-attestations-in-github-actions/" target="_blank">
                <h2 class="title mb-6" id="article-180">Creating SBOM attestations in GitHub Actions</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 01, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how you can create attestations for SBOM documents that you have created for your application or Nuget package&#x2026;</p>
        </article>
        <div class="button flex justify-between">
            <a href="17.html"><span class="back arrow"></span></a>

            <a href="19.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
