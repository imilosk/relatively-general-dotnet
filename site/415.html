
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 415 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4141">
            <a href="https://ayende.com/blog/161704/reviewing-leveldb-part-xii-reading-an-sst" target="_blank">
                <h2 class="title mb-6" id="article-4141">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 08, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After figuring out how the TableCache works, I now want to dig a bit deeper into what the Tables are. That means that we are starting out in Table::Open. And this starts with:   So we start by reading the footer. Then we read the index block:   Construct a new table, and we are pretty much set. I went back to look at the TableBuilder, and I think that I am getting things better. There is the BlockHandle, which is basically just the offset / size in the file. Then we have the actual index, which is located at the end of the file. This one has the format of:  key, offset, size key, offset, size key, offset, size The only problem is that I don&#x27;t see yet where this is actually used. And here it is, inside Table::InternalGet.   So we seek into the block data. And that matches pretty closely what I would expect here. And then we have this:   &#xA0; Some notes about this code, it looks like we are going to be loading the entire block into memory. But what happens if we have a very large value? For that matter, what happens if we have a very large value next to a very small value on the same block, but we wanted the small value? I think that I am wrong here. Looking at the code ,I found this comment, which I previously missed:   And that explains it really nicely with regards to how blocks works in general. The cool part happens inside Block::Iter::Seek, we first do a binary search for the prefixes that we have inside the block, and then a linear search inside the restart section. By default, there are 16 items per restart, so that is going to generate a really fast turnaround in general.  One key point I think that bear repeating is with regards to my previous comment about sizes. We don&#x27;t actually ever copy the entire block to memory, instead, we rely on the OS to do so for us, because the files are actually memory mapped. That means that we can easily access them with very little cost, even if we have mixed big &amp; small values on the same block. That is because we can just skip the large value and not touch it,and rely on the OS to page the right pages for us. That said, when reading a block, not just iterating it, we are going to allocate it in memory:   So I am not sure about that. I think that I was mistaken previously. The only problem is that the buf is actually used for scratch purposes.&#xA0; I think that this is right on both ends, looking at the code, we have PosixRandomAccessFile:   This is the standard approach, actually. Read it from the disk into the buffer, and go on with your life.&#xA0; But we also have PosixMMapReadableFile implementation:   And this is a lot more reasonable and in line with what I was thinking. We don&#x27;t use the scratch at all. However, we still need to allocate this scratch buffer on every single write. Looking at the code, the decision on what to allocate seems to be done here:        As you can see, it is mmap_limit_ that will make that determination. That is basically limiting us to no memory maps on 32 bits (make sense, the 2 GB virtual address space is really small) and to a max of 1,000 mapped files for 64 bits. Given that I am assuming that you are going to run this on 64 bits a lot more often than on 32 bits (at least for server apps), it would make more sense... Stopping right here. Leveldb is being used in the browser as well, and presumably on mobile devices, etc. That means that you can&#x27;t really assume/require 64 bits. And given that most of the time, you are going to have blocks of up to 4 KB in size (except if you have very large keys), I think that this is reasonable. I would probably have done away with allocating the buffer in the happy case, but that is beside the point, probably, since most of the time I assume that the value are small enough. I am looking at this through the eyes of someone who deals with larger values all the time, so it triggers a lot of introspection for me. And this is how we actually read a value from disk, I actually managed to also figure out how we write, and in what format. All together good day&#x27;s (actually, it was mostly at night) fun.</p>
        </article>
        <article id="article-4142">
            <a href="https://ayende.com/blog/161703/reviewing-leveldb-part-xi-reading-from-sort-string-tables-via-the-tablecache" target="_blank">
                <h2 class="title mb-6" id="article-4142">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 05, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post, I focused mostly on reading the code for writing a SST to disk. But I have to admit that I am not really following how you read them back in a way that would be easy to read. In order to understand that, I think that the right place in the code would be the TableCache. The API for that is pretty slick, here are just the header (comments were stripped). class TableCache {&#xA; public:&#xA;  TableCache(const std::string&amp; dbname, const Options* options, int entries);&#xA;  ~TableCache();&#xA;&#xA;  Iterator* NewIterator(const ReadOptions&amp; options,&#xA;                        uint64_t file_number,&#xA;                        uint64_t file_size,&#xA;                        Table** tableptr = NULL);&#xA;&#xA;  Status Get(const ReadOptions&amp; options,&#xA;             uint64_t file_number,&#xA;             uint64_t file_size,&#xA;             const Slice&amp; k,&#xA;             void* arg,&#xA;             void (*handle_result)(void*, const Slice&amp;, const Slice&amp;));&#xA;&#xA;  void Evict(uint64_t file_number);&#xA;&#xA; private:&#xA;&#xA;  Status FindTable(uint64_t file_number, uint64_t file_size, Cache::Handle**);&#xA;};&#xA;&#xA;&#xA;&#xA;There are a couple of interesting things here that show up right away. How do you know what is the number of entries. I guess that this is stored externally, but I am not sure where. I am going to figure that question out first.&#xA;And the answer is strange:&#xA;&#xA;It isn&#x27;t number of entries in the table, it is the number of files? That actually say something very important, since this means that the table cache is reading multiple SST files, rather than just one per cache. Looking at the rest of the API, it makes even more sense. We need to pass the file number that we are going to be reading. That one is going to be got from the Version we are using.&#xA;&#xA;Side note: I just spend an hour or so setting up a tryout project for leveldb, so I can actually execute the code and see what it does. This had me learning cmake (I am using KDevelop to read the code) and I finally got it. Still haven&#x27;t figure out how to step into leveldb&#x27;s code. But that is a good step. &#xA;Also, the debug experience is about 2/10 compared to VS.&#xA;And damn, I am so not a C&#x2B;&#x2B; developer any longer. Then again, never was a real dev on linux, anyway.&#xA;The first thing the TableCache does is to setup a cache. This is interesting, and I followed the code, it create 16 internal caches and has between them. I think that this is done to get concurrency because all the internal cache methods looks like this:&#xA;&#xA;&#xA;Note the mutex lock. That is pretty much how it works for all of the cache work. Looking deeper into the code, I can see another reason why I should be grateful for staying away from C&#x2B;&#x2B;. leveldb comes with its own hash table functionality. At any rate, the cache it using LRU to evict items, and it get the number of entries from the value that was passed in the ctor. That make me think that it hold the opened files.&#xA;Speaking of the cache, here is an example of the code using it:&#xA;&#xA;&#xA;The cache is also used to do block caching, this is why it takes a slice as an argument. I&#x27;m going to go over that later, because this looks quite interesting. The rest of this method looks like this:&#xA;&#xA;&#xA;&#xA;So the only very interesting bit is the Table::Open. The rest is just opening the mmap file and storing it in the cache. Note that the actual file size is passed externally. I am not really sure what this means yet. I&#x27;ll go over the table code later, right now I want to focus on the table cache.&#xA;Looking over the TableCache interface, we can see that we always get the file size from outside. That got me curious enough to figure out why. And the answer is that we always have it in the FileMetaData that we previously explored. I am not sure why that is so important, but I&#x27;ll ignore it for now.&#xA;The rest of TableCache is pretty simple, although this made me grin:&#xA;&#xA;&#xA;More specifically, look at the RegisterCleanup, this is basically registering for the delete event, so they can unref the cache. Pretty nice, all around.&#xA;The rest of the code is just forwarding calls to the Table, so that is what I&#x27;ll be reading next...</p>
        </article>
        <article id="article-4143">
            <a href="https://benfoster.io/blog/nancy-vs-aspnet-mvc-static-content/" target="_blank">
                <h2 class="title mb-6" id="article-4143">Nancy vs ASP.NET MVC - Static content</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 05, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I cover how to serve static content such as stylesheets and scripts with Nancy and ASP.NET MVC.</p>
        </article>
        <article id="article-4144">
            <a href="https://ardalis.com/march-2013-pluralsight-experiment/" target="_blank">
                <h2 class="title mb-6" id="article-4144">March 2013 Pluralsight Experiment</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 04, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Update: Winner and Results The winner of the experiment&#x2019;s prize is Martin Frey (@tinfrey). You can watch a video of the random drawing here&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4145">
            <a href="https://ayende.com/blog/161702/reviewing-leveldb-part-x-table-building-is-all-fun-and-games-until" target="_blank">
                <h2 class="title mb-6" id="article-4145">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 04, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">It seems like I have been trying to get to the piece that actually write to disk for a very long while.  The API from the header file looks to be pretty nice. I would assume that you would call it something like this: TableBuilder builder(options,writableFile);&#xA;builder.Add(&#x201C;one&#x201D;, &#x201C;bar&#x201D;);&#xA;builder.Add(&#x201C;two&#x201D;, &#x201C;foo&#x201D;);&#xA;builder.Finish();&#xA;&#xA;&#xA;There are some things that looks funky. Like Flush(), which has a comment that I don&#x27;t follow: Can be used to ensure that two adjacent entries never live in the same data block.&#xA;Oh well, maybe I need to actually read the code first?&#xA;And immediately we have this:&#xA;&#xA;I think that this explain why you have Flush(), this forces different blocks. Most of the time, you let leveldb handle that, but you can also control that yourself if you really know what you are doing.&#xA;There is something called FilterBlockPolicy, but I don&#x27;t get what it is for, ignoring for now.&#xA;Calling Add() does some really nice things with regards to the implementation. Let us say that we are storing keys with similar postfixes. That is very common.&#xA;When considering leveldb for RavenDB, we decided that we would store the data in this manner:&#xA;&#xA;/users/ayende/data = {} &#xA;/users/ayende/metadata = {}&#xA;Now, when we want to add them, we add the first one and then the second one, but we have a chance to optimize things.&#xA;We can arrange things so we would output:&#xA;&#xA;0,19,2&#xA;/users/ayende/data&#xA;{}&#xA;15, 9, 3&#xA;metadata&#xA;{}&#xA;Note that for the second key, we can reuse the first 15 characters of the previous entry. And we just saved some bytes on the disk.&#xA;Now, blocks are held in memory, and by default they are flushed every 4 KB or so. &#xA;&#xA;Side note: looking at the code, it is really scary just how many times data is copied from one memory location to another in the leveldb codebase. Client code to WriteBatch, WriteBatch to MemTable, MemTable to TableBuilder, etc.&#xA;Okay, so now I am pretty sure that I am following what is going on when writing to disk. Still not sure how you search in an SST. The data is sorted, but that looks like it would require multiple seeks .There is metadata &amp; index blocks in there, but I am not quite sure how they would work. Need to read the reader side of things to really get things. Well, I&#x27;ll do that next time...</p>
        </article>
        <article id="article-4146">
            <a href="https://ayende.com/blog/161921/ravendb-course-snippet" target="_blank">
                <h2 class="title mb-6" id="article-4146">RavenDB Course Snippet</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 03, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We got several requests for this, so here you go. A small snippet (10 minutes out of more than 12 hours!) of the RavenDB Course that is available for purchase.</p>
        </article>
        <article id="article-4147">
            <a href="https://ayende.com/blog/161701/reviewing-leveldb-part-ix-compaction-is-the-new-black" target="_blank">
                <h2 class="title mb-6" id="article-4147">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 03, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After going over the VersionSet, I understand how leveldb decide when to compact and what it decide to compact. More or less, at least. This means that I now mostly can figure out what this does:  Status DBImpl::BackgroundCompaction()  A user may force manual compaction of a range, or we may have reasons of our own to decide to compact, based on leveldb heuristics. Either way, we get the Compaction object, which tells us what files we need to merge. There is a check there whatever we can do a trivial compaction, that is, just move the file from the current level to level&#x2B;1. The interesting thing is that we avoid doing that if this is going to cause issues in level&#x2B;2 (require more expensive compaction later on).  But the interesting work is done in DoCompactionWork, where we actually do compaction of complex data. The code refers to snapshots for the first time that I see. We only merge values that are in a valid snapshot. So data doesn&#x27;t &#x201C;go away&#x201D; for users. While holding a snapshot active. The actual work starts in here:    This give us the ability to iterate over all of the entries in all of the files that need compaction. And then we go over it:    But note that on each iteration we do a check if we need to CompactMemTable(); I followed the code there, and we finally write stuff to disk! I am quite excited about this, but I&#x27;ll handle that in a future blog post. I want to see how actual compaction works.  We then have this:    This is there to stop a compaction that would force a very expensive compaction next time, I think. As a side note, this really drive me crazy:    Note that we have current_output() and FileSize() in here. I don&#x27;t really care what naming convention you use, but I would really rather that you had one. If there is one for the leveldb code base, I can&#x27;t say that I figured it out. It seems like mostly it is PascalCase, but every now &amp; then we have this_style methods. Back to the code, it took me a while to figure it out.    Will return values in sorted key order, that means that if you have the same key in multiple levels, we need to ignore the older values. After this is happening, we now have this:    This is where we are actually writing stuff out to the SST file! This is quite exciting :-). I have been trying to figure that out for a while now. The rest of the code in the function is mostly stuff related to stats book keeping, but this looks important:   This generate the actual VersionEdit, which will remove all of the files that were compacted and add the new file that was created as a new Version to the VersionSet. Good work so far, even if I say so myself. We actually go to where we are building the SST files. Now it is time to look at the code that build those table. Next post, Table Builder...</p>
        </article>
        <article id="article-4148">
            <a href="https://ayende.com/blog/161700/reviewing-leveldb-part-viii-what-are-the-levels-all-about" target="_blank">
                <h2 class="title mb-6" id="article-4148">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 02, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When I last left things, we were still digging into the code for Version and figure out that this is a way to handle the list of files, and that it is the table cache that is actually doing IO. For this post, I want to see where continuing to read the Version code will take us. There are some interesting things going on in here. We use the version to do a lot more. For example, because it holds all of the files, we can use it to check if they are overlaps in key spaces, which leveldb can use to optimize things later on. I am not sure that I am following everything that is going on there, but I start to get the shape of things. As I understand things right now. Data is stored in the following levels:  MemTable &#x2013; where all the current updates are going  Immutable MemTable &#x2013; which is frozen, and probably in the process of being written out  Level 0 &#x2013; probably just a dump of the mem table to disk, key ranges may overlap, so you may need to read multiple files to know where a particular value is.  Level 1 to 6 &#x2013; files where keys cannot overlap, so you probably only need one seek to find things. But seeks are still charged if you need to go through multiple levels to find a value.  That make sense, and it explains things like charging seeks, etc. Now, I am currently going over VersionSet::Builder, which appears to be applying something called VersionEdit efficiently. I don&#x27;t know what any of those things are yet... VersionEdit appears to be a way to hold (and maybe store on disk?) data about pending changes to a version. This is currently not really useful because I still don&#x27;t know how that is used. This means that I need to go deeper into the VersionSet code now. VersionSet::LogAndApply looks like it is an interesting candidate for behavior. I also found why we need VersionEdit to be persistable, we write it to the manifest file. Probably as a way to figure out what is going on when we recover. LogAndApply write the VersionEdit to a manifest file, then set the current file to point to that manifest file. I am currently reading the Recover function, and it seems to be applying things in reverse. It reads the CURRENT file which points to the current manifest, which contains the serialized VersionEdit contents. Those are read in turn, after which we apply the edit to the in memory state.  Toward the end of VersionSet.cc file, we start seeing things regards compaction. Like: Iterator* VersionSet::MakeInputIterator(Compaction* c) Compaction* VersionSet::PickCompaction() I sort of follow and sort of doesn&#x27;t follow what the code is doing there. It selects the appropriate set of files that need to be compacted. I don&#x27;t really get the actual logic, I&#x27;ll admit, but hopefully that will become better when I read the rest of the code. Compaction appears to work on level and level&#x2B;1 files. I assume that it is going to read all of those files, merge them into level&#x2B;1 and then delete (or mark for deletion) the existing files. This is now close to midnight, and my eyes started building and the code started to do gymnastics on the screen, so I&#x27;ll call it a post for now.</p>
        </article>
        <article id="article-4149">
            <a href="https://benfoster.io/blog/nancy-vs-aspnet-mvc-getting-started/" target="_blank">
                <h2 class="title mb-6" id="article-4149">Nancy vs ASP.NET MVC - Getting Started</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 02, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post we look at how to create a very basic web site from scratch using both Nancy and ASP.NET MVC frameworks.</p>
        </article>
        <article id="article-4150">
            <a href="https://ayende.com/blog/161889/my-passover-project-introducing-rattlesnake-clr" target="_blank">
                <h2 class="title mb-6" id="article-4150">My Passover Project: Introducing Rattlesnake.CLR</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 01, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, after spending quite a lot of time digging through the leveldb codebase, and with several years of working with RavenDB, I can say with confidence that the CLR make it extremely hard to build high performance server side systems using the CLR. Mostly, the issues are related to GC and memory. In particular, not having any way to control memory allocation and/or the GC means that we can&#x2019;t optimize those scenarios in any meaningful way. At the same time, I do not want to go back to the unmanaged world. As mentioned ,I just came back from a very deep dive into a non trivial C&#x2B;&#x2B; codebase ,and while I consider that codebase a really good one, that ain&#x2019;t to say it is a pleasure to always be thinking about all the stuff that the CLR just takes away. Therefor, I decided that I&#x2019;m going to be doing something about it. And Rattlesnake.CLR was born:  The major features of the Rattlesnake.CLR include explicit memory management when required. Let us say that we know that we are going to be needing some amount of memory for a while, and then all of that can be thrown away. This is extremely common in scenarios such as a web request, pretty much all the memory that you generate during the processing web request can be safely free immediately. In RavenDB&#x2019;s case, the memory we consume during indexing can be free immediately when we stop indexing. Right now this is a painful process of making sure that we allocate within the same gen0 and hoping that it won&#x2019;t be too expensive, or that we won&#x2019;t get a complete halt of the entire server while it is releasing memory. It also make it really hard to do things like limit the amount of memory your code uses. Another requirement that I have is that Rattlesnake.CLR should be able to execute existing .NET assemblies without any additional steps. Since I don&#x2019;t fancy doing ports of stuff that already exists. In order to handle this scenario with the given constraints, we have:      1: var heap = Heap.Create(HeapOptions.None,    2:     1024 * 1024,   3:     512 * 1024 * 1024);   4:&#xA0;    5: using(MemoryAllocations.AllocateFrom(heap))   6: {   7:    var sb = new StringBuilder();   8:    for(var i = 0; i &lt; 100; i &#x2B;&#x2B; )   9:          sb.AppendLine(i);  10:    Console.WriteLine(sb.ToString());  11: }  12:&#xA0;   13: heap.Destroy(); &#xA;All the code within the using statement is allocated in our own heap. In line 13, we are destroying all of that memory in one fell swoop.&#xA;There are a few notes about this that we probably should address:&#xA;&#xA;By default, memory allocated by this form is not subject to any form of GC. The idea is that this whole heap is getting released immediately.&#xA;Note that last two parameters for the Heap.Create. The first is the initial size of the heap, and the second is&#xA0; the max size. We now have a real way to actually limit the amount of memory a piece of code will use. This is really important on server applications where avoiding paging is critical.&#xA;For that matter, we can now figure out how much memory a particular piece of code uses, and allocate our resources accordingly.&#xA;You can use multiple heaps at the same time, although only one can be installed as the default allocation at a given point in time.&#xA;There is the explicit heap.GarbageCollect() method that will do GC only on that heap, and which you can schedule at your own convenience.&#xA0; You can have two heaps, and allocate from one while you are GCing from the other. And yes ,that means that GCs using this methods will not stop the process!&#xA;Memory allocated on the heap is obviously only valid as long as the heap is valid. That means that once the heap is destroyed, you can&#x2019;t access any of the objects that were created there. This has implications for things like cache. We provide MemoryAllocations.AllocateOnGlobalHeap&lt;T&gt;(args) method to force you to use the global heap, instead, if you want this memory to be always available and subject to GC.&#xA;This is early days yet, but we already see some really interesting performance improvements!&#xA;How does this work?&#xA;While an early experiment with Rattlensake.CLR was based on the Mono runtime. I quickly decided that I wanted to keep using the MS CLR. Now, it order to handle this I had to do some unnatural things (to say the least), but I think that I even managed to make this a supported option. Essentially, we are using the CLR Hosting API for this. In particular:&#xA;&#xA;ICLRGCManager&#xA;IHostMalloc&#xA;IHostMemoryManager &#xA;You can use Rattlesnake.CLR like this:&#xA;&#xA;.\Rattlesnake.exe Raven.Server.exe&#xA;Just for fun, we also allowed to place limits on the default heap, so you can be sure that you aren&#x2019;t allocating too much there.&#xA;&#xA;.\Rattlesnake.exe Raven.Server.exe --max-default-heap-size=256MB&#xA;We are still running some tests, but this is looking really good.</p>
        </article>
        <div class="button flex justify-between">
            <a href="414.html"><span class="back arrow"></span></a>

            <a href="416.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>