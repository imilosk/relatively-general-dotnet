
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 396 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3951">
            <a href="https://ayende.com/blog/163299/with-malice-aforethought-we-can-try-even-better" target="_blank">
                <h2 class="title mb-6" id="article-3951">With malice aforethought, we can try even better</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 10, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Continuing on with the same theme from our last post. How can we improve the speed in which we write to disk. In particular, I am currently focused on my worst case scenario:  fill rnd buff 10,000 tx&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; :&#xA0;&#xA0;&#xA0; 161,812 ms&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; 6,180 ops / sec This is 10,000 transactions all running one after another, and taking really way too long to go about doing their thing. Now, we did some improvements and we got it all the way to 6,340 ops / sec, but I think you&#x2019;ll agree that even this optimization is probably still bad. We spent more time there, trying to figure out exactly how we can do micro optimizations, and we got all the way up to 8,078 ops /sec. That is the point where I decided that I would really like to look at the raw numbers that I can get from this system. So I wrote the following code:      1: var key = Guid.NewGuid().ToByteArray();   2: var buffer = new byte[100];   3: new Random().NextBytes(buffer);   4:&#xA0;    5: using (var fs = new FileStream(&quot;test.bin&quot;, FileMode.Truncate, FileAccess.ReadWrite))   6: {   7:     fs.SetLength(1024*1024*768);   8:&#xA0;    9:     var sp = Stopwatch.StartNew();  10:&#xA0;   11:     for (int i = 0; i &lt; 10*1000; i&#x2B;&#x2B;)  12:     {  13:         for (int j = 0; j &lt; 100; j&#x2B;&#x2B;)  14:         {  15:             fs.Write(key,0, 16);  16:             fs.Write(buffer, 0, 100);  17:         }  18:         fs.Flush(true);  19:     }  20:     Console.WriteLine(&quot;{0:#,#} ms for {1:#,#} ops / sec&quot;, sp.ElapsedMilliseconds, (1000*1000)/sp.Elapsed.TotalSeconds);  21: }&#xA;This code mimic the absolute best scenario we could hope for. Zero cost for managing the data, pure sequential writes. Note that we call to Flush(true) to simulate 10,000 transactions. This code gives me: 147,201 ops / sec.&#xA;This is interesting, mostly because I thought the reason our random writes with 10K transactions are bad was the calls to Flush(), but it appears that this is actually working very well. I then tested this with some random writes, by adding the following lines before line 13:&#xA;&#xA;&#xA;   1: var next = random.Next(0, 1024*1024*512);   2: fs.Position = next - next%4096;&#xA;I then decided to try it with memory mapped files, and I wrote:&#xA;&#xA;&#xA;   1: using (var fs = new FileStream(&quot;test.bin&quot;, FileMode.Truncate, FileAccess.ReadWrite))   2: {   3:     fs.SetLength(1024 * 1024 * 768);   4:&#xA0;    5:     var memoryMappedFile = MemoryMappedFile.CreateFromFile(fs,   6:                                     &quot;test&quot;, fs.Length, MemoryMappedFileAccess.ReadWrite,   7:                                     null, HandleInheritability.None, true);   8:     var memoryMappedViewAccessor = memoryMappedFile.CreateViewAccessor();   9:&#xA0;   10:     byte* p = null;  11:     memoryMappedViewAccessor.SafeMemoryMappedViewHandle.AcquirePointer(ref p);  12:&#xA0;   13:     var sp = Stopwatch.StartNew();  14:&#xA0;   15:     for (int i = 0; i &lt; 10 * 1000; i&#x2B;&#x2B;)  16:     {  17:         var next = random.Next(0, 1024 * 1024 * 512);  18:         byte* basePtr = p &#x2B; next;  19:         using (var ums = new UnmanagedMemoryStream(basePtr, 12 * 1024,12*1024, FileAccess.ReadWrite))  20:         {  21:             for (int j = 0; j &lt; 100; j&#x2B;&#x2B;)  22:             {  23:                 ums.Write(key, 0, 16);  24:                 ums.Write(buffer, 0, 100);  25:             }  26:         }  27:     }  28:     Console.WriteLine(&quot;{0:#,#} ms for {1:#,#} ops / sec&quot;, sp.ElapsedMilliseconds, (1000 * 1000) / sp.Elapsed.TotalSeconds);  29: }&#xA;You&#x2019;ll note that I am not doing any flushing here. That is intention for now, using this, I am getting 5&#x2B; million ops per second. But since I am not doing flushing, this is pretty much me testing how fast I can write to memory.&#xA;Adding a single flush cost us 1.8 seconds for a 768MB file. And what about doing the right thing? Adding the following in line 26 means that we are actually flushing the buffers.&#xA;&#xA;&#xA;   1: FlushViewOfFile(basePtr, new IntPtr(12 * 1024));&#xA;Note that we are not flushing to disk, we still need to do that. But for now, let us try doing it. This single line changed the code from 5&#x2B; million ops to doing 170,988 ops / sec. And that does NOT include actual flushing to disk. When we do that, too, we get a truly ridiculous number: 20,547 ops / sec. And that explains quite a lot, I think.&#xA;For reference, here is the full code:&#xA;&#xA;&#xA;   1: unsafe class Program   2: {   3:     [DllImport(&quot;kernel32.dll&quot;, SetLastError = true)]   4:     [return: MarshalAs(UnmanagedType.Bool)]   5:     extern static bool FlushViewOfFile(byte* lpBaseAddress, IntPtr dwNumberOfBytesToFlush);   6:&#xA0;    7:     static void Main(string[] args)   8:     {   9:         var key = Guid.NewGuid().ToByteArray();  10:         var buffer = new byte[100];  11:         var random = new Random();  12:         random.NextBytes(buffer);  13:&#xA0;   14:         using (var fs = new FileStream(&quot;test.bin&quot;, FileMode.Truncate, FileAccess.ReadWrite))  15:         {  16:             fs.SetLength(1024 * 1024 * 768);  17:&#xA0;   18:             var memoryMappedFile = MemoryMappedFile.CreateFromFile(fs,  19:                                             &quot;test&quot;, fs.Length, MemoryMappedFileAccess.ReadWrite,  20:                                             null, HandleInheritability.None, true);  21:             var memoryMappedViewAccessor = memoryMappedFile.CreateViewAccessor();  22:&#xA0;   23:             byte* p = null;  24:             memoryMappedViewAccessor.SafeMemoryMappedViewHandle.AcquirePointer(ref p);  25:&#xA0;   26:             var sp = Stopwatch.StartNew();  27:&#xA0;   28:             for (int i = 0; i &lt; 10 * 1000; i&#x2B;&#x2B;)  29:             {  30:                 var next = random.Next(0, 1024 * 1024 * 512);  31:                 byte* basePtr = p &#x2B; next;  32:                 using (var ums = new UnmanagedMemoryStream(basePtr, 12 * 1024, 12 * 1024, FileAccess.ReadWrite))  33:                 {  34:                     for (int j = 0; j &lt; 100; j&#x2B;&#x2B;)  35:                     {  36:                         ums.Write(key, 0, 16);  37:                         ums.Write(buffer, 0, 100);  38:                     }  39:                 }  40:                 FlushViewOfFile(basePtr, new IntPtr(12 * 1024));  41:                 fs.Flush(true);  42:             }  43:             Console.WriteLine(&quot;{0:#,#} ms for {1:#,#} ops / sec&quot;, sp.ElapsedMilliseconds, (1000 * 1000) / sp.Elapsed.TotalSeconds);  44:         }  45:     }  46: }&#xA;This is about as efficient a way you can get for writing to the disk using memory mapped files if you need to do that using memory mapped files in a transactional manner. And that is the absolute best case scenario, pretty much. Where we know exactly what we wrote and were we wrote it. And we always write a single entry, of a fixed size, etc. In Voron&#x2019;s case, we might write to multiple pages at the same transaction (in fact, we are pretty much guaranteed to do just that).&#xA;This means that I need to think about other ways of doing that.</p>
        </article>
        <article id="article-3952">
            <a href="https://ayende.com/blog/163650/ravendb-3-0-mystery-feature-1-webinar" target="_blank">
                <h2 class="title mb-6" id="article-3952">RavenDB 3.0&#x2013;Mystery Feature #1&#x2013;Webinar</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 09, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this Webinar, we will discuss one of the upcoming features of RavenDB 3.0We won&#x27;t tell you what exactly, but it is a pretty cool one.Join us to hear all about it. &#xA0; Space is limited.Reserve your Webinar seat now at:https://www2.gotomeeting.com/register/274102194</p>
        </article>
        <article id="article-3953">
            <a href="https://ayende.com/blog/163682/ravendb-2-x-beginners-guide-is-out" target="_blank">
                <h2 class="title mb-6" id="article-3953">RavenDB 2.x Beginner&#x2019;s Guide is out</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 09, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is the second book about RavenDB in as many days, and I know of a few more that are coming soon.  The previous book was meant for experts, this one is for beginners, enjoy!  http://www.packtpub.com/ravendb-2-x-beginners-guide/book</p>
        </article>
        <article id="article-3954">
            <a href="https://ayende.com/blog/163649/ravendb-high-performance-book-is-out" target="_blank">
                <h2 class="title mb-6" id="article-3954">RavenDB High Performance Book is OUT</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 08, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">You can get the new book here.   Learn how to build your application for scalability and high availability  Make highly interactive applications that support client-side notifications, faceted search, search suggestions, and more  Take advantage of advanced RavenDB APIs to make your application fly</p>
        </article>
        <article id="article-3955">
            <a href="https://ayende.com/blog/163298/with-a-little-knowledge-and-a-profiler-let-us-optimize" target="_blank">
                <h2 class="title mb-6" id="article-3955">With a little knowledge and a profiler, let us optimize!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 06, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">As part of the work we have been doing on Voron, I wrote a few benchmarks and looked at where the hot spots are. One of the major ones was this function:      1: public override void Flush()   2: {   3:     if (_flushMode == FlushMode.None)   4:         return;   5:&#xA0;    6:     PagerState.Accessor.Flush();   7:     _fileStream.Flush(_flushMode == FlushMode.Full);   8: }&#xA;This is the &#x201C;fsync()&#x201D; call, effectively. Accessor.Flush() call will resolve to a FlushViewOfFile(0, size); and _fileStream.Flush(true) will resolve to FlushFileBuffers on Windows.&#xA;It isn&#x2019;t surprising that this would be THE hotspot, it is the part where we actually have to wait for the hardware to do stuff, after all. But further investigation revealed that it wasn&#x2019;t the FlushFileBuffers that was really costly, it was the FlushViewOfFile. What FlushViewOfFile will do is scan all of the pages in range, and flush them to the OS (not to disk) if they are dirty. That is great, but it is effectively an O(N) operation. We have more knowledge about what is going on, so we can do better. We already know what are the dirty pages, so we can actually use that, instead of letting the OS do all the work.&#xA;But then we run into another problem. If we actually just call FlushViewOfFile for every page separately, we are going to have to spend a lot of time just calling to the OS when we have to do a large write. So we need to balance the amount of data we send to FlushViewOfFile with the number of times we are going to call FlushViewOfFile. Therefor, I came up with the following logic. We are going to group calls to FlushViewOfFile, as long as they are nearby (within 256KB of one another), this will give us the best balance between reducing the number of pages that FlushViewOfFile needs to call and the number of times we call FlushViewOfFile.&#xA;This now looks like this:&#xA;&#xA;&#xA;   1: public override void Flush(List&lt;long&gt; sortedPagesToFlush)   2: {   3:     if (_flushMode == FlushMode.None || sortedPagesToFlush.Count == 0)   4:         return;   5:&#xA0;    6:     // here we try to optimize the amount of work we do, we will only    7:     // flush the actual dirty pages, and we will do so in sequential order   8:     // ideally, this will save the OS the trouble of actually having to flush the    9:     // entire range  10:     long start = sortedPagesToFlush[0];  11:     long count = 1;  12:     for (int i = 1; i &lt; sortedPagesToFlush.Count; i&#x2B;&#x2B;)  13:     {  14:         var difference = sortedPagesToFlush[i] - sortedPagesToFlush[i - 1];  15:         // if the difference between them is not _too_ big, we will just merge it into a single call  16:         // we are trying to minimize both the size of the range that we flush AND the number of times  17:         // we call flush, so we need to balance those needs.  18:         if (difference &lt; 64)  19:         {  20:             count &#x2B;= difference;  21:             continue;  22:         }  23:         FlushPages(start, count);  24:         start = sortedPagesToFlush[i];  25:         count = 1;  26:     }  27:     FlushPages(start, count);  28:&#xA0;   29:     if (_flushMode == FlushMode.Full)  30:         _fileStream.Flush(true);  31: }&#xA;A side affect of this is that we are more likely to be writing to the disk in a sequential fashion because of this.&#xA;The end result of this change was doubling the performance of the system under worse case scenario to &#x201C;just&#x201D; 25% faster under best conditions.</p>
        </article>
        <article id="article-3956">
            <a href="https://ayende.com/blog/163617/my-ravendbs-story-contest" target="_blank">
                <h2 class="title mb-6" id="article-3956">My RavenDB&#x2019;s Story Contest</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 05, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">With the public release of RavenDB 2.5, we want to hear a lot more from users about what they are doing with RavenDB. Therefor, we decided to have a contest. Basically, we would ask you to write a post about your RavenDB experience on the RavenDB page in Facebook. We will send a free RavenDB care package (which includes an awesome T-Shirt &amp; laptop stickers) to the first 50 people to send us their stories. We will also raffle 3 RavenDB DVDs from those who will submit their stories. The contest will end on Sep 20.</p>
        </article>
        <article id="article-3957">
            <a href="https://ardalis.com/intel-haswell-ultrabook-preview-unit-experience/" target="_blank">
                <h2 class="title mb-6" id="article-3957">Intel Haswell Ultrabook Preview Unit Experience</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 04, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x27;ve been using my Intel Haswell Ultrabook for about a month now, so it&#x27;s time to follow up on my first impressions review. Overview Last&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-3958">
            <a href="https://ayende.com/blog/163585/ravendb-2-5-is-out-and-a-happy-new-year" target="_blank">
                <h2 class="title mb-6" id="article-3958">RavenDB 2.5 is out, and a happy New Year</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 04, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">About six weeks ago, we actually released RavenDB 2.5 to the world. It was build 2666. I decided to do something a bit different, and do a silent launch. In other words, We released it, let the people in the mailing list know about it, but we didn&#x2019;t make a big fuss about it. Now we have a new build, 2700 (which isn&#x2019;t going to evoke&#x2026; certain issues for some people), and we want to make as much noise as possible. Because RavenDB 2.5 is out, and it is really cool. Here are some of the new stuff:  Dynamic Reporting Result Transformers Scripted Index Results Unbounded Streams support MSI Installer Index directly to memory Smarter query optimizer Idle indexes, index priorities and locked indexes And that is just a taste. In fact, we are going to do a Webinar about how cool RavenDB 2.5 is on Monday. You can register using the following link: https://www2.gotomeeting.com/register/551636514 And, of course, go and get the latest RavenDB from our site.   And have a great New Year, everyone. We will be off for the Holiday until next Monday&#x2026;h</p>
        </article>
        <article id="article-3959">
            <a href="https://ayende.com/blog/163041/diagnosing-a-production-issue-on-our-servers" target="_blank">
                <h2 class="title mb-6" id="article-3959">Diagnosing a production issue on our servers</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 03, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the steps that we take before releasing a stable is to push the latest build into our own production servers, and see what goes on. By far, this has been a pretty pleasant process, and mostly served to increase our confidence that we can go to production with that version. But sometimes it does what it is supposed to do and find the sort of bugs that are very hard to run in production. In this case, after several hours (8 &#x2013; 12, I am guessing), we discovered that we would start getting errors such as EsentOutOfSessionsException on some of our sites. Esent sessions are the main way we access Esent, and we are pretty careful about managing them. Previously, there wasn&#x2019;t really any way that you could get this error, indeed, that is pretty much the first time we saw that outside of the lab. The difference in 2.5 is that we allowed detached sessions to be used along with DTC calls. This gave us the ability to have a commit pending between the Prepare &amp; Commit phases of the operation. Reviewing the code, I found some places where we weren&#x2019;t properly disposing the sessions, which could explain that. So I fixed that and pushed a new version out. It took a bit longer this time, but the same error happened.&#xA0;  The good thing about having this happen on our production servers is that I have full access there. Of course, it is production, so outright debugging it out, but taking a dump and transferring that to my machine was easy enough. Now, open it with WinDBG, run &#x201C;.loadby sos clr&#x201D; and start investigating. First command, as always, is !threads. And there I could see several threads marked with Microsoft.Isam.Esent.Interop.EsentOutOfSessionsException. That was interesting, and said that we caught the problem as it was happening, which was great. Next, it was time to look a bit at the actual memory. I run: !DumpHeap -type Session  My reaction is Huh!!! There is absolutely zero justification for that. Now, the only question is why. So I decided to look at the class that is holding the transaction state, assuming that this is probably what is holding into all those sessions. I run: !DumpHeap -type EsentTransactionContext  And that tells me quite a lot. There appear to be now a total of 317 in flight DTC transactions. Considering that I know what our usage is, that is a huge number. And it tells me that something isn&#x2019;t right here. This is especially true when you consider that we don&#x2019;t have that many open databases holding in flight transactions: !DumpHeap -type EsentInFlightTransactionalState &#x2013;stat  In other words, we have 8 loaded dbs, each of them holding their in flight transactional state. And we have 317 opened transactions and 35 thousands sessions. That is pretty ridiculous. Especially given that I know that we are supposed to have a max of single digits concurrent DTC transactions at any one time. So somehow we are leaking transactions &amp; sessions. But I am still very unhappy with just &#x201C;we are leaking sessions&#x201D;. That is something that I knew before we start debugging everything. I can already tell that we probably need to add a more robust way of expiring transactions, and I added that, but the numbers don&#x2019;t add up to me. Since this is pretty much all I can do with WinDBG, I decided to use another tool, MemProfiler. This gives me the ability to import the dump file, and then analyze that in a much nicer manner. Doing so, I quickly found this out:  Huh?!  Sessions are finalizable, sure, but I am very careful about making sure to dispose of them. Especially after the previous code change. There should be just 317 undisposed sessions. And having that many items in the finalizer queue can certainly explain things. But I don&#x2019;t know how they got there. And the numbers don&#x2019;t match us, either. We are missing about 7K items from the WinDBG numbers. Okay, next, I pulled ClrMD and wrote the following:      1: var dt = DataTarget.LoadCrashDump(@&quot;C:\Users\Ayende\Downloads\w3wp\w3wp.dmp&quot;);   2: var moduleInfo = dt.ClrVersions[0].TryGetDacLocation();   3: var rt = dt.CreateRuntime(moduleInfo);   4:&#xA0;    5: var clrHeap = rt.GetHeap();   6:&#xA0;    7: var finalized = new HashSet&lt;ulong&gt;();   8:&#xA0;    9: int cnt = 0;  10: foreach (var ptr in rt.EnumerateFinalizerQueue())  11: {  12:     var type = clrHeap.GetObjectType(ptr);  13:     if (type.Name == &quot;Microsoft.Isam.Esent.Interop.Session&quot;)  14:     {  15:         finalized.Add(ptr);  16:     }  17: }  18: Console.WriteLine(finalized.Count);  19:&#xA0;   20: var live = new HashSet&lt;ulong&gt;();  21: foreach (var ptr in clrHeap.EnumerateObjects())  22: {  23:     var type = clrHeap.GetObjectType(ptr);  24:     if (type.Name == &quot;Microsoft.Isam.Esent.Interop.Session&quot;)  25:     {  26:         if (finalized.Contains(ptr) == false)  27:             live.Add(ptr);  28:     }  29: }  30: Console.WriteLine(live.Count);&#xA;This gave me 28,112 sessions in the finalizer queue and 7,547 session that are still live. So something is creating a lot of instances, but not using or referencing them?&#xA;I did a code review over everything once again, and I think that I got it. The culprit is this guy:&#xA;&#xA;Where createContext is defined as:&#xA;&#xA;Now, what I think is going on is that the concurrent dictionary, which is what transactionContexts might be calling the createContext multiple times inside the GetOrAdd method. But because those create values that have to be disposed&#x2026;&#xA0; Now, in the normal course of things, worst case scenario is that we would have them in the finalizer queue and they would be disposed in due time. However, under load, we actually gather quite a few of them, and we run out of available sessions to operate with.&#xA;At least ,this is my current theory. I changed the code to be like this:&#xA;&#xA;So if my value wasn&#x2019;t created, I&#x2019;ll properly dispose of it. I&#x2019;ll be pushing this to production in a bit and seeing what is happening. Note that there aren&#x2019;t locking, but we might be generating multiple sessions. That is fine, as long as only one of them survives.</p>
        </article>
        <article id="article-3960">
            <a href="https://ayende.com/blog/163233/get-out-of-the-way-we-are-coding-part-ii" target="_blank">
                <h2 class="title mb-6" id="article-3960">Get out of the way, we are coding, Part II</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 02, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Another thing that is pretty common in development cycles is the notion of who can do more. Hours, that is, rather than work. That is a pretty important distinction. In general, I appreciate Work much better than Hours. For the simple reason that someone doing 12 hours a day in the office usually do a lot less actual work. Sprints are possible, and we do that sometimes, usually if there is a major production issue or we are gearing up for a release. Then again, we have just released RavenDB 2.5, and we haven&#x2019;t had the need for doing that. It was simpler &amp; easiest to push the date by a week than do long hours just to hit an arbitrary point in time. I think that in the last six months, we had people stay in the office past 5 &#x2013; 6 PM twice.  There are three reasons for that. The two obvious ones are:  people doing 12 &#x2013; 18 hours of work each day turn do crappy stuff, so that is bad for the product. people doing 12 &#x2013; 18 hours of work each day also tend to have&#x2026; issues. They burn out, quite rapidly, too. Leaving aside issues such as this one. People crash and burn. I know that I said it before, but it is important to note. Burn out will do nasty things to you. Leaving aside the proven physical and mental health issues that this cause, it boils down to this. I&#x2019;ve burned out before, it sucks. Let&#x2019;s us not do that is a pretty important aspect of what I do on a daily basis. That is why I turned to building products, because being on the road 60% of the time isn&#x2019;t sustainable, and if it is something that I feel, this is certain for other people who work for Hibernating Rhinos. But I said that there are three reasons. And the third might be just as important as the others. Hibernating Rhinos was built to be a place where people retire from. This is the ideal, and we are probably talking 40 years from now, considering all factors, but that is the idea. We aren&#x2019;t a startup, chasing the pot of gold for that one in a hundred chance to make it rich. And that is why I had to kick people out of the office and tell them to continue working on that issue tomorrow.</p>
        </article>
        <div class="button flex justify-between">
            <a href="395.html"><span class="back arrow"></span></a>

            <a href="397.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>