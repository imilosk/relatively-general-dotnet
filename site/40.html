
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/196931-B/answer-why-is-this-code-broken" target="_blank"><h1 class="title mb-6">Answer</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: April 07, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I asked why this code is broken, and now is the time to dig into this. The issue is in this block of code. Take a look at that for a moment, if you please:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          tasks.Add(Task.Factory.StartNew(async () =&gt;&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              using var data = File.OpenRead(file);&#xA;        &#xA;        &#xA;          &#xA;              var url = &quot;/file?=&quot; &#x2B; Uri.EscapeDataString(Path.GetFileName(file));&#xA;        &#xA;        &#xA;          &#xA;              await httpClient.PostAsync(url, new StreamContent(data));&#xA;        &#xA;        &#xA;          &#xA;          }));&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          problem.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;The code is trying to gather the async upload of all the files, and then it will await them. This code compile and runs successfully, but it will not do what you expect it to do. Let&#x2019;s break it up a bit to understand what is going on:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var task = Task.Factory.StartNew(async () =&gt;&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;             // redacted&#xA;        &#xA;        &#xA;          &#xA;          })&#xA;        &#xA;        &#xA;          &#xA;          tasks.Add(task);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          one.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;We are passing the variable task to the list of tasks we have. We just extract a variable, nothing much going on here. Let&#x2019;s explore further, what is the type of task? We know it must be a subtype of Task, since that is what the tasks collection will take. It turns out that this isn&#x2019;t that simple:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          Task&lt;Task&gt; task = Task.Factory.StartNew(async () =&gt;&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;             // redacted&#xA;        &#xA;        &#xA;          &#xA;          })&#xA;        &#xA;        &#xA;          &#xA;          tasks.Add(task);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          two.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;What is that, Task&lt;Task&gt; thingie? Well, let&#x2019;s look at the signature of Task.Factory.StartNew(), shall we?&#xA;&#xA;public Task&lt;TResult&gt; StartNew&lt;TResult&gt;(Func&lt;TResult&gt; function);&#xA;&#xA;Just from the signature, we can tell what is going on. StartNew() accepts a function that returns a value and will then return a task for the eventual result of this function. However, the function we are actually passing to the StartNew() doesn&#x2019;t produce a value. Except that it does&#x2026;&#xA;Let&#x2019;s explore that thing for a bit:&#xA;&#xA;var func = async () =&gt; { };&#xA;&#xA;What is the type of func in this case?&#xA;&#xA;Func&lt;Task&gt; func = async() =&gt; {};&#xA;&#xA;The idea is that when the compiler sees the async keyword, it transforms the function to one that returns a Task. Combining both those features together means that our original code actually registers the start of the asynchronous process to happen and will return as soon as it got started. Basically, we&#x2019;ll only wait for the actual opening of the file, not for the actual network work that has to happen here.&#xA;The right way to express what we want here is:&#xA;&#xA;Task.Run(async () =&gt; {});&#xA;&#xA;The signature for this is:&#xA;&#xA;public static Task Run&lt;TResult&gt;(Func&lt;Task&gt; function);&#xA;&#xA;You can see here that we get a function that returns a task, but we aren&#x2019;t actually wrapping that in another Task instance. The task that will be returned will be completed once the full work has been completed.&#xA;It is an interesting pitfall in the API, and can be quite hard to figure out exactly what is going on. Mostly because there are several different things happening all at once.</p>
        <a href="https://ayende.com/blog/196930-B/challenge-why-is-this-code-broken" target="_blank"><h1 class="title mb-6">Challenge</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: April 06, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The following code looks straightforward, but it has a really subtle issue. &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public async Task SendFiles(params string[] files)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var httpClient = new HttpClient&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  BaseAddress = new Uri(&quot;https://my.backup.server&quot;)&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;              var tasks = new List&lt;Task&gt;();&#xA;        &#xA;        &#xA;          &#xA;              foreach (var f in files)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var file = f;&#xA;        &#xA;        &#xA;          &#xA;                  tasks.Add(Task.Factory.StartNew(async () =&gt;&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      using var data = File.OpenRead(file);&#xA;        &#xA;        &#xA;          &#xA;                      var url = &quot;/file?=&quot; &#x2B; Uri.EscapeDataString(Path.GetFileName(file));&#xA;        &#xA;        &#xA;          &#xA;                      await httpClient.PostAsync(url, new StreamContent(data));&#xA;        &#xA;        &#xA;          &#xA;                  }));&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              await Task.WhenAll(tasks);&#xA;        &#xA;        &#xA;          &#xA;              Console.WriteLine(&quot;All you data has been backed up!&quot;);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          subtle.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Can you spot what is going on?You can ignore the error handling here, by the way, the issue isn&#x2019;t related to handling unexpected errors.</p>
        <a href="https://ayende.com/blog/196929-B/on-fixing-a-bug-and-all-its-siblings-with-a-forward-looking-view" target="_blank"><h1 class="title mb-6">On fixing a bug (and all its siblings) with a forward looking view</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: April 05, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We run into a strange situation deep in the guts of RavenDB. A cluster command (the backbone of how RavenDB is coordinating action in a distributed cluster) failed because of an allocation failure. That is something that we are ready for, since RavenDB is a robust system that handles such memory allocation failures. The problem was that this was a persistent allocation failure. Looking at the actual error explained what was going on. We allocate memory in units that are powers of two, and we had an allocation request that would overflow a 32 bits integer.&#xA;Let me reiterate that, we have a single cluster command that would need more memory than can fit in 32 bits. A cluster command isn&#x2019;t strictly limited, but a 1MB cluster command is huge, as far as we are concerned. Seeing something that exceeds the GB mark was horrifying. The actual issue here was somewhere completely different, there was a bug that caused quadratic growth in the size of a database record. This post isn&#x2019;t about that problem, it is about the fix.&#xA;We believe in defense in depth for such issues. So aside from fixing the actual cause for this problem, the issue was how we can prevent similar issues in the future. We decided that we&#x2019;ll place a reasonable size limit on the cluster commands, and we chose 128MB as the limit (this is far higher than any expected value, mind). We chose that value since it is both big enough to be outside anyone&#x27;s actual usage, but at the same time, it is small enough that we can increase this if we need to. That means that this needs to be a configuration value, so the user can modify that in place if needed. The idea is that we&#x2019;ll stop the generation of a command of this size, before it hits the actual cluster and poison it.&#xA;Which brings me to this piece of code, which was the reason for this blog post:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private void ThrowTooLargeRaftCommand(BlittableJsonReaderObject cmd)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var type = RachisLogHistory.GetTypeFromCommand(cmd);&#xA;        &#xA;        &#xA;          &#xA;              throw new ArgumentOutOfRangeException(&#xA;        &#xA;        &#xA;          &#xA;                  $&quot;The command &#x27;{type}&#x27; size of {new Size(cmd.Size, SizeUnit.Bytes)} exceed the max allowed size.&quot;);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          impr.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;This is where we are actually throwing the error if we found a command that is too big (the check is done by the caller, not important here).&#xA;Looking at the code, it does what is needed, but it is missing a couple of really important features:&#xA;&#xA;We mention the size of the command, but not the actual size limit.&#xA;We don&#x2019;t mention that this isn&#x2019;t a hard coded limit.&#xA;&#xA;The fix here would be to include both those details in the message. The idea is that the user will not only be informed about what the problem is, but also be made aware of how they can fix it themselves. No need to contact support (and if support is called, we can tell right away what is going on).&#xA;This idea, the notion that we should be quite explicit about not only what the problem is but also how to fix it, is very important to the overall design of RavenDB. It allows us to produce software that is self supporting, instead of ErrorCode: 413, you get not only the full details, but how you can fix it.&#xA;Admittedly, I fully expect to never ever hear about this issue again in my lifetime. But in case I&#x2019;m wrong, we&#x2019;ll be in a much better position to respond to it.</p>
        <a href="https://ardalis.com/learning-consumption-creation/" target="_blank"><h1 class="title mb-6">Learning by Consumption and Creation</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: April 05, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Preamble After a conversation on our devBetter Discord server, I published a short twitter thread about learning. It resonated a bit and as&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/196897-B/managing-ravendb-indexes-in-production-a-devops-guide" target="_blank"><h1 class="title mb-6">Managing RavenDB indexes in production, a DevOps guide</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: April 04, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB has the ability to analyze your queries and generate the appropriate indexes for you automatically. This isn&#x2019;t a feature you need to enable or a toggle to switch, it is just the way it works by default. For more advanced scenarios, you have the ability to write your own indexes to process your data in all sorts of interesting ways.&#xA0; Indexes in RavenDB are used for aggregation (map-reduce), full text search, spatial queries, background computation and much more. This post isn&#x2019;t going to talk about what you can do with RavenDB&#x2019;s indexes, however. I&#x2019;m going to discuss how you&#x2019;ll manage them.&#xA;There are several ways to create indexes in RavenDB, the one that we usually recommend is to create a class that will inherit from AbstractIndexCreationTask. If you are using C# or TypeScript, you can create strongly typed indexes that will be checked by the compiler for you. If you are using other clients (or JS indexes), you will have the index definition as constant strings inside a dedicated class. Once you have the indexes defined as part of your codebase, you can then create them using a single command: IndexCreation.CreationIndexes();&#xA;What I described so far is the mechanics of working with indexes. You can read all about them in the documentation. I want to talk about the implications of this design approach:&#xA;&#xA;Your indexes live in the same repository as your code. Whenever you checkout a branch, the index definitions you&#x2019;ll use will always match the code that queries them.&#xA;Your indexes are strongly typed and are checked by the compiler. I mentioned this earlier, but this is a huge&#xA0;advantage, worth mentioning twice.&#xA;You can track changes on your indexes using traditional source control tools. That makes reviewing index changes just a standard part of the job, instead of something you need to do in addition.&#xA;&#xA;RavenDB has a lot of features around index management. Side by side index deployment, rolling indexes, etc. The question is now, when do you deploy those indexes.&#xA;During development, it&#x2019;s standard to deploy your indexes whenever the application starts. This way, you can change your indexes, hit F5 and you are immediately working on the latest index definition without having to make any other actions.&#xA;For production, however, we don&#x2019;t recommend taking this approach. Two versions of the application using different index definitions would &#x201C;fight&#x201D; to apply the &#x201C;right&#x201D; version of the index, causing version bounce, for example. RavenDB has features such as index locking, but those are to save you from a fall, not for day to day activity.&#xA;You should have a dedicated endpoint / tool that you can invoke that would deploy your indexes from your code to your RavenDB instances. The question is, what should that look like? Before I answer this question, I want to discuss another aspect of indexing in RavenDB: automatic indexing.&#xA;So far, we discussed static indexes, ones that you define in your code manually. But RavenDB also allows you to run queries without specifying which index they will use. At this point, the query optimizer will generate the right indexes for your needs. This is an excellent feature, but how does that play in production?&#xA;If you deploy a new version of your application, it will likely have new ways of querying the database. If you just push that to production blindly, RavenDB will adjust quickly enough, but it will still need to learn all the new ways you query your data. That can take some time, and will likely cause a higher load on the system. Instead of doing all the learning and adjusting in production, there are better ways to do so.&#xA;Run the new version of your system on QA / UAT instance and put it through its paces. The QA instance will have the newest static indexes and RavenDB will learn what sort of queries you are issuing and what indexes it needs to run. Once you have completed this work, you can export the indexes from the QA instance and import them into production. Let the new indexes run and process all their data, then you can push the new version of your application out. The production database is already aware of the new behavior and adjusted to it.&#xA;As a final note, RavenDB index deployment is idempotent. That means that you can deploy the same set of indexes twice, but it will not cause us to re-index. That reduces the operational overhead that you have to worry about.</p>
        <a href="https://ayende.com/blog/196865-B/webinar-next-week-clean-architecture-with-ravendb" target="_blank"><h1 class="title mb-6">Webinar next week: Clean Architecture with RavenDB</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: March 31, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Next week I&#x27;ll be talking about how you can utilize RavenDB to create a clean architecture for your systems.&#xA;You can register in the following link</p>
        <a href="https://ayende.com/blog/196833-B/using-ravendb-for-data-aggregation-from-dynamic-sources" target="_blank"><h1 class="title mb-6">Using RavenDB for data aggregation from dynamic sources</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: March 24, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got an interesting question from a customer recently and thought that it would make for a fun blog post. The issue the customer is facing is that they are aggregating data from many sources, and they need to make sense of all the data in a nice manner. For some of the sources, they have some idea about the data, but in many cases, the format of the data they get is pretty arbitrary.&#xA;Consider the image on the right, we have four different documents, from separate sources:&#xA;&#xA;titles/123-45-678/2022-01-28 &#x2013; The car title&#xA;tickets/0000000000000000009-A &#x2013; A parking ticket that was issued for a car&#xA;orders/0000000000000000010-A &#x2013; An order from a garage about fixes made for a customer (which includes some cars)&#xA;claims/0000000000000000011-A &#x2013; Details of a rejected insurance claim for a car&#xA;&#xA;We need to make sense of all of this information and provide some information to the user about a car from all those sources. The system in question is primarily interested in cars, so what I would like to do is show a &#x201C;car file&#x201D;. All the information at hand that we have for a particular car. The problem is that this is not trivial to do. In some cases, we have a field with the car&#x2019;s license plate, but each data source named it differently. In the case of the Order document, the details about the specific service for the car are deep inside the document, in a free form text field.&#xA;I can, of course, just index the whole thing and try to do a full text search on the data. It would work, but can we do better than that?&#xA;A license plate in the system has the following format: 123-45-768. Can we take advantage of that?&#xA;&#xA;If you said regex, you now have two problems :-).&#xA;&#xA;Let&#x2019;s see what we can do about this&#x2026;&#xA;One way to handle this is to create a multi map-reduce index inside of RavenDB, mapping the relevant items from each collection and then aggregating the values by the car&#x2019;s license plate from all sources. The problem with this approach is that you&#x2019;ll need to specialize for each and every data source you have. Sometimes, you know what the data is going to look like and can get valuable insight from that, but in other cases, we are dealing with whatever the data providers will give us&#x2026;&#xA;For that reason, I created the following index, which uses a couple of neat techniques all at once to give me insight into the data that I have in the system, without taking too much time or complexity.&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          // map&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          map(&quot;@all_docs&quot;, d =&gt; {&#xA;        &#xA;        &#xA;          &#xA;              var ids = [id(d)]&#xA;        &#xA;        &#xA;          &#xA;              var occurance = {};&#xA;        &#xA;        &#xA;          &#xA;              occurance[d[&quot;@metadata&quot;][&quot;@collection&quot;]] = 1;&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;              var results = scanLicensePlates(d, {});&#xA;        &#xA;        &#xA;          &#xA;              return Object.keys(results).map(match =&gt; ({&#xA;        &#xA;        &#xA;          &#xA;                      Collections: occurance,&#xA;        &#xA;        &#xA;          &#xA;                      Ids: ids,&#xA;        &#xA;        &#xA;          &#xA;                      LicensePlate: match&#xA;        &#xA;        &#xA;          &#xA;              }));&#xA;        &#xA;        &#xA;          &#xA;          })&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          const licensePlateRegex = /\d{3}-\d{2}-\d{3}/g;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          function scanLicensePlates(d, results){&#xA;        &#xA;        &#xA;          &#xA;              var vals = Object.values(d);&#xA;        &#xA;        &#xA;          &#xA;              for(var i = 0; i &lt; vals.length; i&#x2B;&#x2B;){&#xA;        &#xA;        &#xA;          &#xA;                  var v = vals[i];&#xA;        &#xA;        &#xA;          &#xA;                  switch(typeof v){&#xA;        &#xA;        &#xA;          &#xA;                      case &quot;string&quot;:&#xA;        &#xA;        &#xA;          &#xA;                        var it = v.matchAll(licensePlateRegex);&#xA;        &#xA;        &#xA;          &#xA;                        while(true){&#xA;        &#xA;        &#xA;          &#xA;                            var cur = it.next();&#xA;        &#xA;        &#xA;          &#xA;                            if(cur.done) break;&#xA;        &#xA;        &#xA;          &#xA;                            results[cur.value[0]] = null;&#xA;        &#xA;        &#xA;          &#xA;                        }&#xA;        &#xA;        &#xA;          &#xA;                         break;&#xA;        &#xA;        &#xA;          &#xA;                      case &quot;object&quot;: // array / object, recursive&#xA;        &#xA;        &#xA;          &#xA;                          scanLicensePlates(v, results);&#xA;        &#xA;        &#xA;          &#xA;                          break;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              return results;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          // reduce&#xA;        &#xA;        &#xA;          &#xA;          groupBy(x=&gt;x.LicensePlate)&#xA;        &#xA;        &#xA;          &#xA;              .aggregate(g =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                 var collections = g.values.reduce((acc, cur) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                     for(var k in cur.Collections){&#xA;        &#xA;        &#xA;          &#xA;                         acc[k] = (acc[k] || 0) &#x2B; cur.Collections[k];&#xA;        &#xA;        &#xA;          &#xA;                     }&#xA;        &#xA;        &#xA;          &#xA;                     return acc;&#xA;        &#xA;        &#xA;          &#xA;                 }, {});&#xA;        &#xA;        &#xA;          &#xA;                 var ids = g.values.reduce((acc, cur) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                        cur.Ids.forEach(k =&gt; acc[k] = null);&#xA;        &#xA;        &#xA;          &#xA;                        return acc;&#xA;        &#xA;        &#xA;          &#xA;                    }, {});&#xA;        &#xA;        &#xA;          &#xA;                 return {&#xA;        &#xA;        &#xA;          &#xA;                    LicensePlate: g.key,&#xA;        &#xA;        &#xA;          &#xA;                    Collections: collections,&#xA;        &#xA;        &#xA;          &#xA;                    Ids: Object.keys(ids);&#xA;        &#xA;        &#xA;          &#xA;                 };&#xA;        &#xA;        &#xA;          &#xA;              });&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          index.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;This looks like a lot of code, I know, but the most complex part is in the scanLicensePlates() portion. There we define a regex for the license plate and scan the documents recursively trying to find a proper match.&#xA;The idea is we&#x2019;ll find a license plate in either the field directly (such as Title.LicensePlate) or part of the field contents (such as Orders.Lines.Task field). Regardless of where we find the data, in the map phase we&#x2019;ll emit a separate value for each detected license plate in the document. We&#x2019;ll then aggregate by the license plate in the reduce phase. Some part of the complexity here is because we are building a smart summary, here is the output of this index:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              &quot;LicensePlate&quot;: &quot;123-45-678&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;Collections&quot;: {&#xA;        &#xA;        &#xA;          &#xA;                  &quot;Titles&quot;: 1,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;Tickets&quot;: 1,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;Orders&quot;: 2,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;Claims&quot;: 1&#xA;        &#xA;        &#xA;          &#xA;              },&#xA;        &#xA;        &#xA;          &#xA;              &quot;Ids&quot;: [&#xA;        &#xA;        &#xA;          &#xA;                  &quot;titles/123-45-678/2022-01-28&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;tickets/0000000000000000009-A&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;orders/0000000000000000010-A&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;claims/0000000000000000011-A&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;Orders/0000000000000000012-A&quot;&#xA;        &#xA;        &#xA;          &#xA;              ],&#xA;        &#xA;        &#xA;          &#xA;              &quot;@metadata&quot;: {&#xA;        &#xA;        &#xA;          &#xA;                  &quot;@change-vector&quot;: null,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;@index-score&quot;: 1&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          output.json&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;As you can see, the map-reduce index results will give us the following data items:&#xA;&#xA;The license plate obviously (which is how we&#x2019;ll typically search this index)&#xA;The summary for all the data items that we have for this particular license plate. That will likely be something that we&#x2019;ll want to show to the user.&#xA;The ids of all the documents related to this license plate, which we&#x2019;ll typically want to show to the user.&#xA;&#xA;The nice thing about this approach is that we are able to extract actionable information from the system with very little overhead. If we have new types of data sources that we get in the future, they&#x2019;ll seamlessly merge into the final output for this index.&#xA;Of course, if you know more about the data you are working with, you can probably extract more interesting information. For example, we may want to show the current owner of the car, which we can extract from the latest title document we have. Or we may want to compute how many previous owners a particular vehicle has, etc.&#xA;As the first step to aggregate information from dynamic data sources, that gives us a lot of power. You can apply this technique in a wide variety of scenarios. If you are finding yourself doing coarse grained searches and trying to regex your way to the right data, this sort of approach can drastically improve your performance and make it far easier to build a system that can be maintained over the long run.</p>
        <a href="https://ayende.com/blog/196803-B/a-tale-of-eventually-consistent-acid-model" target="_blank"><h1 class="title mb-6">A tale of eventually consistent ACID model</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: March 23, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I recently had a conversation about ACID, I don&#x2019;t think it would surprise anyone that I&#x2019;m a big proponent of ACID. After all, RavenDB was an ACID database from the first release.&#xA;When working with distributed systems, on the other hand, it is far harder to get ACID guarantees at a reasonable cost. Pretty much all the 1st generation NoSQL databases left ACID on the sidelines, because it is a hard problem. That was one of the primary reasons why RavenDB even exists. I couldn&#x2019;t imagine living without transactions. This is a post from 2011, talking about just that topic.&#xA;Consistency in a distributed system is a hard problem, mostly because it has an impact on the design and performance of the system. It is also common to think about ACID as a binary property, which is sort of true (A for Atomic ). However, it turns out that the real world is a lot more nuanced than that.&#xA;I want to discuss the consistency model for RavenDB as it applies to running in a distributed cluster. It is ACID with eventual consistency, which doesn&#x2019;t sound like it makes sense, right?&#xA;I found a good example to explain the importance of ACID operations from your database even in the presence of eventual consistency.&#xA;Consider the following scenario, we have a married couple with a shared bank account. Both husband and wife have a checkbook for the account and primarily use checks to pay for things in their day to day life.&#xA;Checks are anachronistic for some people, who are used to instant payments and wire transfers. The great thing about checks is that they are (by definition) a way to work in a distributed system. You hand someone a check and at some future point in time they will deposit that and get the money from your account.&#xA;One of the most important aspects of using checks was managing that delay. The amount of money you had in the account didn&#x2019;t necessarily represent how much money you had available. If your rent check wasn&#x2019;t deposited yet, you still had to consider the rest money &#x201C;gone&#x201D;, even if you could still see it in the bank statement.&#xA;Because of checks&#x2019; eventual consistency, a really important part of using checks was to keep track of all the outstanding checks that weren&#x2019;t deposited yet. You did that by filling in the stub of the check in the checkbook whenever you wrote a check. In other words, you never gave a check before you properly filled the stub for that.&#xA;That brings us back to ACID. The act of filling the stub and writing the check is a transaction, composed of two separate actions. That action isn&#x2019;t a&#xA0;global transaction. The husband and wife in our example do not have to coordinate with one another whenever they write a check. But they do need to ensure that no check would be handed off without a proper stub (and vice versa, if we want to be exact). If the act of writing a check and filling the stub isn&#x2019;t atomic, you may have a check unexpectedly hit your account, which is&#x2026; exciting (in the Chinese proverb&#xA0; manner).&#xA;On the other side, the entity that you handed the check to also needs a transaction. They need to fill out an invoice for the check (even though it hasn&#x2019;t been deposited yet). Having a check with no invoice or an invoice with no check is&#x2026; bad (as in, IRS agents having shots and high fives during an audit).&#xA;The idea is that at the local level, you have to use transactions, otherwise, you cannot be sure about the consistency of your own data. If you don&#x2019;t have transactions at the persistence layer, you&#x2019;ll have to build it on top of that, which is&#x2026; not ideal, really hard and usually not going to work in all cases.&#xA;With local transactions, you can then start pushing consistent data out and resolve all the distributed states you have.&#xA;Going back to our husband and wife example, for the most part, they can act completely independently of one another, and they&#x2019;ll reconcile their account status with each other at a later date (weekly budget meeting). At the same time, there are certain transactions (pun intended) where they won&#x2019;t act independently. A great example is buying a car, that sort of amount requires that both will be consulted on the purchase. That is a high value operation, so it is worth the additional cost of distributed consistency.&#xA;With RavenDB, we have the notion of local node transactions, which are then sent out to the rest of the nodes in the cluster in the background (async replication) as well as support for cluster wide transactions, which requires the consent of a majority of the nodes in the cluster. You can choose for each scenario exactly what level of transactions and consistency you want to have,&#xA0;local or global.</p>
        <a href="https://ayende.com/blog/196802-B/using-ravendb-from-serverless-applications" target="_blank"><h1 class="title mb-6">Using RavenDB from Serverless applications</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: March 22, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got a great question about using RavenDB from Serverless applications:&#xA;&#xA;DocumentStore should be created as a singleton. For Serverless applications, there are no long-running instances that would be able to satisfy this condition. DocumentStore is listed as being &quot;heavy weight&quot;, which would likely cause issues every time a new insurance is created.&#xA;&#xA;RavenDB&#x2019;s documentation explicitly calls out that the DocumentStore should be a singleton in your application:&#xA;&#xA;We recommend that your Document Store implement the Singleton Pattern as demonstrated in the example code below. Creating more than one Document Store may be resource intensive, and one instance is sufficient for most use cases.&#xA;&#xA;But the point of Serverless systems is that there is no such thing as a long running instance. As the question points out, that is likely going to cause problems, no? On the one hand we have RavenDB&#x2019;s DocumentStore, which is optimized for long running processes and on the other hand we have Serverless systems, which focus on minimal invocations. Is this really a problem?&#xA;The answer is that there is no real contradiction between those two desires, because while the Serverless model is all about a single function invocation, the actual manner in which it runs means that there exists a backing process that is reused between invocations. Taking AWS Lambda as an example, you can define a function that will be invoked for SQS (Simple Queuing Service), the signature for the function will look something like this:&#xA;&#xA;async Task HandleSQSEvent(SQSEvent sqsEvent, ILambdaContext context);&#xA;&#xA;The Serverless infrastructure will invoke this function for messages arriving on the SQS queue. Depending on its settings, the load and defined policies, the Serverless infrastructure may invoke many parallel instances of this function.&#xA;What is important about Serverless infrastructure is that a single function instance will be reused to process multiple events. It is the Serverless infrastructure&#x27;s responsibility to decide how many instances it will spawn, but it will usually not spawn a separate instance per message in the queue. It will let an instance handle the messages and spawn more as they are needed to handle the ingest load. I&#x2019;m using SQS as an example here, but the same applies for handling HTTP requests, S3 events, etc.&#xA;Note that this is relevant for AWS Lambda, Azure Functions, GCP Cloud Functions, etc. A single instance is reused across multiple invocations. This ensure far more efficient processing (you avoid startup costs) and can make use of caching patterns and common optimizations.&#xA;When it comes to RavenDB usage, the same thing applies. We need to make sure that we won&#x2019;t be creating a separate DocumentStore for each invocation, but once per instance. Here is a simplified example of how you can do this:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          using Amazon.Lambda.Core;&#xA;        &#xA;        &#xA;          &#xA;          using Amazon.Lambda.RuntimeSupport;&#xA;        &#xA;        &#xA;          &#xA;          using Amazon.Lambda.Serialization.SystemTextJson;&#xA;        &#xA;        &#xA;          &#xA;          using Amazon.Lambda.SQSEvents;&#xA;        &#xA;        &#xA;          &#xA;          using Raven.Client.Documents;&#xA;        &#xA;        &#xA;          &#xA;          using System.Security.Cryptography.X509Certificates;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          using var documentStore = new documentStore&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              Urls = new string[] { /* urls */},&#xA;        &#xA;        &#xA;          &#xA;              Certificate = new X509Certificate2(/*path*/)&#xA;        &#xA;        &#xA;          &#xA;          };&#xA;        &#xA;        &#xA;          &#xA;          documentStore.Initialize();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var handler = async (SQSEvent sqsEvent, ILambdaContext context) =&gt;&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              using var session = documentStore.OpenAsyncSession();&#xA;        &#xA;        &#xA;          &#xA;              foreach (var record in sqsEvent.Records)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  // use the session to process the records&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          await LambdaBootstrapBuilder.Create(handler, new DefaultLambdaJsonSerializer())&#xA;        &#xA;        &#xA;          &#xA;                  .Build()&#xA;        &#xA;        &#xA;          &#xA;                  .RunAsync();&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          lambda.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;We define the DocumentStore when we initialize the instance, then we reuse the same DocumentStore for each invocation of the lambda (the handler code).&#xA;We can now satisfy both RavenDB&#x2019;s desire to use a singleton DocumentStore for best performance and the Serverless programming model that abstracts how we actually run the code, without really needing to think about it.</p>
        <a href="https://ayende.com/blog/196801-B/my-interview-about-creating-a-database-in-c-with-michael-shpilt" target="_blank"><h1 class="title mb-6">My interview about Creating a Database in C# with Michael Shpilt</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: March 21, 2022
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was interviewed recently by Michael Shpilt about RavenDB and building a database in C#.I think it went very well, you can read / listen to that in the following link. As always, I would love your feedback.</p>
        <div class="button flex justify-between">
            <a href="39.html"><span class="back arrow"></span></a>

            <a href="41.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>