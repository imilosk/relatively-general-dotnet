
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/161153/ravendb-and-not-having-foreign-keys" target="_blank"><h1 class="title mb-6">RavenDB And Not Having Foreign Keys</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 26, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is something that we hear quite often in the mailing list, and I thought that I would spend the time to answer it in full. There tend to be two kinds of FK references in RDMBS, the essential ones and the one the DBA added just to make my life a living hell.  The first one include things that are essential for internal consistency within a single aggregate. For example, the OrderLines.OrderID FK reference to Orders.ID is quite important, since an order line without an order is meaningless. But what about the association between OrderLine.ProductID and Products.ID ?&#xA0;  An OrderLine can most certainly exists without the product, in fact, an OrderLine already copied into it all of the properties of the product that are important for the order. But because of the FK happy nature of most DBAs (and developers, for that matter), we have a FK reference between the two. The problem is that it actually is perfectly fine to remove a product that we are no longer selling from the store.  Yes, there are order lines for that product, but they have been completed ages ago. With a RDBMS and a FK, you cannot do that. So you resort to hacks like IsDeleted = false, which in practice gives you the exact same behavior as a deleted product, except that the FK is happy. Your application has a 50/50 change to work or not work with that. With RavenDB, we make distinctions between internal consistency, which is maintained inside the same document, and external references, which can come and go as they please. You cannot have an order line in RavenDB without an order, because the order is where the order line exists. But you can most certainly remove the product that an order line refers to, because that is outside the scope of the order, it is a separate aggregate.</p>
        <a href="https://ayende.com/blog/161123/index-prioritization-in-ravendb-problems" target="_blank"><h1 class="title mb-6">Index Prioritization in RavenDB: Problems</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 25, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Every now and then we get a request for index prioritization in RavenDB. The requests are usually in the form of:  I have an index (or a few indexes) that are very important, and I would like them to be update before any other indexes. That is really nice request, but it ignores a lot of actual really hard implementation details. In any prioritization scheme, there is the risk of starvation. If index A has to complete before index B, what happens if we have enough writes that index A is always busy? That means that index B will never get to index, and it will fall further &amp; further behind. There are well known algorithms to handle this scenario, mostly from the OS thread scheduling point of view. You could incrementally increase the priority of an index every time that you skipped updating it, until at some point it has higher priority than all the other indexes and gets its moment in the sun. That is workable if all you are working with are threads, and there isn&#x2019;t a significantly different execution environment for a thread to run. For RavenDB indexes, there is actually a major difference in the execution environment depending on when you are running. We have a lot of optimizations inside RavenDB to avoid IO, in particular, we do a lot of work so indexes do not have to wait for their input, we do parallel IO, optimized insert hooks, and a whole bunch of stuff like that. All of those assume that you all of the indexes are going to run together, however. We already have the feature that a very slow index will be allowed to run while the rest of the indexes are keeping up, but that is something that we really try to avoid (we give it a grace period of 3/4 as much time as all of the other indexes combined). That is because the moment you have out of sync indexes, all that hard work is basically going to be wasted. You are going to be needing to load the documents to be indexed multiple times, creating more load on the server. Keeping the documents that were already indexed waiting in memory for the low priority index to work on is also not a good idea, since that is going to cause RavenDB to consume potentially a LOT more memory. I have been thinking about this for a while, but it isn&#x2019;t an easy decision. What do you think?</p>
        <a href="https://ayende.com/blog/161026/hibernating-rhinos-practices-a-sample-project" target="_blank"><h1 class="title mb-6">Hibernating Rhinos Practices</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 22, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have previously stated that one of the things that I am looking for in a candidate is the actual candidate code. Now, I won&#x2019;t accept &#x201C;this is a project that I did for a client / employee&#x201D;, and while it is nice to be pointed at a URL from the last project the candidate took part of, it is not a really good way to evaluate someone&#x2019;s abilities. Ideally, I would like to have someone that has an OSS portfolio that we can look at, but that isn&#x2019;t always relevant. Instead, I decided to sent potential candidates the following:  Hi, I would like to give you a small project, and see how you handle that. The task at hand is to build a website for Webinars questions. We run bi-weekly webinars for our users, and we want to do the following:  Show the users a list of our webinars (The data is here: http://www.youtube.com/user/hibernatingrhinos)  Show a list of the next few scheduled webinar (in the user&#x2019;s own time zone)  Allow the users to submit questions, comment on questions and vote on questions for the next webinar.  Allow the admin to mark specific questions as answered in a specific webinar (after it was uploaded to YouTube).  Manage Spam for questions &amp; comments. The project should be written in C#, beyond that, feel free to use whatever technologies that you are most comfortable with. Things that we will be looking at:  Code quality  Architecture  Ease of modification  Efficiency of implementation  Ease of setup &amp; deployment Please send us the link to a Git repository containing the project, as well as any instructions that might be necessary. Thanks in advance, &#xA0;&#xA0;&#xA0;&#xA0; Oren Eini This post will go live about two weeks after I started sending this to candidates, so I am not sure yet what the response would be.</p>
        <a href="https://ayende.com/blog/161121/state-of-the-raven-webinar-2-posted" target="_blank"><h1 class="title mb-6">State of the Raven Webinar #2 Posted</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 21, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20"></p>
        <a href="https://ayende.com/blog/161089/open-source-application-review-bitshuva-radio" target="_blank"><h1 class="title mb-6">Open Source Application Review: BitShuva Radio</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 20, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">As part of my ongoing reviews efforts, I am going to review the BitShuva Radio application.  BitShuva Radio is a framework for building internet radio stations with intelligent social features like community rank, thumb-up/down songs, community song requests, and machine learning that responds to the user&#x27;s likes and dislikes and plays more of the good stuff. I just cloned the repository and opened it in VS, without reading anything beyond the first line. As usual, I am going to start from the top and move on down:  We already have some really good indications:  There is just one project, not a gazillion of them. The folders seems to be pretty much the standard ASP.NET MVC ones, so that should be easy to work with. Some bad indications:  Data &amp; Common folders are likely to be troublesome spots. Hit Ctrl&#x2B;F5, and I got this screen, which is a really good indication. There wasn&#x2019;t a lot of setup required.  Okay, enough with the UI, I can&#x2019;t really tell if this is good or bad anyway. Let us dive into the code. App_Start, here I come.  I get the feeling that WebAPI and Ninject are used here. I looked in the NinjectWebCommon file, and found:  Okay, I am biased, I&#x2019;ll admit, but this is good. Other than the RavenDB stuff, it is pretty boring, standard and normal codebase. No comments so far. Let us see what is this RavenStore all about, which leads us to the Data directory:  So it looks like we have the RavenStore and a couple of indexes. And the code itself:      1: public class RavenStore   2: {   3:     public IDocumentStore CreateDocumentStore()   4:     {   5:         var hasRavenConnectionString = ConfigurationManager.ConnectionStrings[&quot;RavenDB&quot;] != null;   6:         var store = default(IDocumentStore);               7:         if (hasRavenConnectionString)   8:         {   9:             store = new DocumentStore { ConnectionStringName = &quot;RavenDB&quot; };  10:         }  11:         else  12:         {  13:             store = new EmbeddableDocumentStore { DataDirectory = &quot;~/App_Data/Raven&quot; };  14:         }  15:&#xA0;   16:         store.Initialize();  17:         IndexCreation.CreateIndexes(typeof(RavenStore).Assembly, store);  18:         return store;  19:     }  20: }&#xA;I think that this code need to be improved, to start with, there is no need for this to be an instance. And there is no reason why you can&#x2019;t use EmbeddableDocumentStore to use remote stuff.&#xA;I would probably write it like this, but yes, this is stretching things:&#xA;&#xA;&#xA;   1: public static class RavenStore   2: {   3:     public static IDocumentStore CreateDocumentStore()   4:     {   5:         var store = new EmbeddableDocumentStore   6:             {   7:                 DataDirectory = &quot;~/App_Data/Raven&quot;   8:             };   9:&#xA0;   10:         if (ConfigurationManager.ConnectionStrings[&quot;RavenDB&quot;] != null)  11:         {  12:             store.ConnectionStringName = &quot;RavenDB&quot;;  13:         }  14:         store.Initialize();  15:         IndexCreation.CreateIndexes(typeof(RavenStore).Assembly, store);  16:         return store;  17:     }  18: }&#xA;I intended to just glance at the indexes, but this one caught my eye:&#xA;&#xA;&#xA;This index effectively gives you random output. It will group by the count of documents, and since we reduce things multiple times, the output is going to be&#x2026; strange.&#xA;I am not really sure what this is meant to do, but it is strange and probably not what the author intended.&#xA;The Common directory contains nothing of interest beyond some util stuff. Moving on to the Controllers part of the application:&#xA;&#xA;So this is a relatively small application, but an interesting one. We will start with what I expect o be a very simple part of the code .The HomeController:&#xA;&#xA;&#xA;   1: public class HomeController : Controller   2: {   3:     public ActionResult Index()   4:     {   5:         var userCookie = HttpContext.Request.Cookies[&quot;userId&quot;];   6:         if (userCookie == null)   7:         {   8:             var raven = Get.A&lt;IDocumentStore&gt;();   9:             using (var session = raven.OpenSession())  10:             {  11:                 var user = new User();  12:                 session.Store(user);  13:                 session.SaveChanges();  14:&#xA0;   15:                 HttpContext.Response.SetCookie(new HttpCookie(&quot;userId&quot;, user.Id));  16:             }  17:         }  18:&#xA0;   19:         // If we don&#x27;t have any songs, redirect to admin.  20:         using (var session = Get.A&lt;IDocumentStore&gt;().OpenSession())  21:         {  22:             if (!session.Query&lt;Song&gt;().Any())  23:             {  24:                 return Redirect(&quot;/admin&quot;);  25:             }  26:         }  27:&#xA0;   28:         ViewBag.Title = &quot;BitShuva Radio&quot;;  29:         return View();  30:     }  31: }&#xA;There are a number of things in here that I don&#x2019;t like. First of all, let us look at the user creation part. You look at the cookies and create a user if it isn&#x2019;t there, setting the cookie afterward.&#xA;This has the smell of something that you want to do in the infrastructure. I did&#xA0; a search for &#x201C;userId&#x201D; in the code and found the following in the SongsController:&#xA;&#xA;&#xA;   1: private User GetOrCreateUser(IDocumentSession session)   2: {   3:     var userCookie = HttpContext.Current.Request.Cookies[&quot;userId&quot;];   4:     var user = userCookie != null ? session.Load&lt;User&gt;(userCookie.Value) : CreateNewUser(session);   5:     if (user == null)   6:     {   7:         user = CreateNewUser(session);   8:     }   9:&#xA0;   10:     return user;  11: }  12:&#xA0;   13: private static User CreateNewUser(IDocumentSession session)  14: {  15:     var user = new User();  16:     session.Store(user);  17:&#xA0;   18:     HttpContext.Current.Response.SetCookie(new HttpCookie(&quot;userId&quot;, user.Id));  19:     return user;  20: }&#xA;That is code duplication with slightly different semantics, yeah!&#xA;Another issue with the HomeController.Index method is that we have direct IoC calls (Get.As&lt;T&gt;) and multiple sessions per request. I would much rather do this in the infrastructure, which would also give us a place for the GetOrCreateUser method to hang from.&#xA;SongsController is actually an Api Controller, so I assume that it is called from JS on the page. Most of the code there looks like this:&#xA;&#xA;&#xA;   1: public Song GetSongForSongRequest(string songId)   2: {   3:     using (var session = raven.OpenSession())   4:     {   5:         var user = GetOrCreateUser(session);   6:         var songRequest = new SongRequest   7:         {   8:             DateTime = DateTime.UtcNow,   9:             SongId = songId,  10:             UserId = user.Id  11:         };  12:         session.Store(songRequest);  13:         session.SaveChanges();  14:     }  15:&#xA0;   16:     return GetSongById(songId);  17: }&#xA;GetSongById will use its own session, and I think it would be better to have just one session per request, but that is about the sum of my comments.&#xA;One thing that did bug me was the song search:&#xA;&#xA;&#xA;   1: public IEnumerable&lt;Song&gt; GetSongMatches(string searchText)   2: {   3:     using (var session = raven.OpenSession())   4:     {   5:         return session   6:             .Query&lt;Song&gt;()   7:             .Where(s =&gt;   8:                 s.Name.StartsWith(searchText) ||   9:                 s.Artist.StartsWith(searchText) ||  10:                 s.Album.StartsWith(searchText))  11:             .Take(50)  12:             .AsEnumerable()  13:             .Select(s =&gt; s.ToDto());  14:     }  15: }&#xA;RavenDB has a really good full text support. And we could be using that, instead. It would give you better results and be easier to work with, to boot.&#xA;Overall, this is a pretty neat little app.</p>
        <a href="https://ardalis.com/how-to-contribute-to-aspnet-yourself/" target="_blank"><h1 class="title mb-6">How To Contribute to ASPNET Yourself</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 19, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Recently I upgraded the Stir Trek conference site&#x2019;s web code from ASP.NET MVC 2 to 4. When I did, I ran into an issue where the [OutputCache&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/161058/a-pull-request-with-all-of-the-taxes-already-paid-gimme-that-again" target="_blank"><h1 class="title mb-6">A pull request with all of the taxes already paid, gimme that again!</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 19, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I recently merged a pull request from Barry Hagan. The actual pull request is pretty boring, to tell you the truth, exposing a Lucene feature through the RavenDB API. What really impressed me was how complete the pull request was. What do I mean by complete?  A feature is not just supporting it in the engine. For this particular pull request, Barry have done:  Supported this in RavenDB Database Core. The HTTP API. The C# Client API. The strongly typed C# Client API. Included support for dynamic indexes. Updated the query optimizer. Exposed this feature in the UI. Basically, the only things that I had to do were git pull and then review the code. Very nicely done.</p>
        <a href="https://ayende.com/blog/160903/bug-hunting-in-a-massively-multi-threaded-environment" target="_blank"><h1 class="title mb-6">Bug hunting in a massively multi threaded environment</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 18, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We got a really nasty bug report from a user. Sometimes, out of the blue, RavenDB would throw an error: System.InvalidOperationException: Collection was modified; enumeration operation may not execute.   at System.Collections.Generic.List`1.Enumerator.MoveNextRare()   at Raven.Json.Linq.RavenJArray.WriteTo(JsonWriter writer, JsonConverter[] converters) in c:\Builds\RavenDB-Stable\Raven.Abstractions\Json\Linq\RavenJArray.cs:line 174   at Raven.Json.Linq.RavenJObject.WriteTo(JsonWriter writer, JsonConverter[] converters) in c:\Builds\RavenDB-Stable\Raven.Abstractions\Json\Linq\RavenJObject.cs:line 275&#xA;   at Raven.Json.Linq.RavenJObject.WriteTo(JsonWriter writer, JsonConverter[] converters) in c:\Builds\RavenDB-Stable\Raven.Abstractions\Json\Linq\RavenJObject.cs:line 275&#xA;&#xA;&#xA;Unfortunately, this error only happened once in a while, usually when the system was under load. But they weren&#x2019;t able to provide a repro for that.&#xA;Luckily, they were able to tell us that they suspected that this is related to the replication support. I quickly setup a database with replication and wrote the following code to try to reproduce this:&#xA;using(var store = new DocumentStore&#xA;{&#xA;    Url = &quot;http://localhost:8080&quot;,&#xA;    DefaultDatabase = &quot;hello&quot;&#xA;}.Initialize())&#xA;{&#xA;    using(var session = store.OpenSession())&#xA;    {&#xA;        session.Store(new ReadingList&#xA;        {&#xA;            UserId = &quot;test/1&quot;,&#xA;            Id = &quot;lists/1&quot;,&#xA;            Books = new List&lt;ReadingList.ReadBook&gt;()&#xA;        });&#xA;        session.SaveChanges();&#xA;    }&#xA;    Parallel.For(0, 100, i =&gt;&#xA;    {&#xA;        while (true)&#xA;        {&#xA;            try&#xA;            {&#xA;                using (var session = store.OpenSession())&#xA;                {&#xA;                    session.Advanced.UseOptimisticConcurrency = true;&#xA;                    session.Load&lt;ReadingList&gt;(&quot;lists/1&quot;)&#xA;                            .Books.Add(new ReadingList.ReadBook&#xA;                            {&#xA;                                ReadAt = DateTime.Now,&#xA;                                Title = &quot;test &quot; &#x2B; i&#xA;                            });&#xA;                    session.SaveChanges();&#xA;                }&#xA;                break;&#xA;            }&#xA;            catch (ConcurrencyException)&#xA;            {&#xA;                &#xA;            }&#xA;        }&#xA;    });&#xA;}&#xA;&#xA;&#xA;And that reproduced the bug! Hurrah! Done deal, we can move on, right?&#xA;Except that the bug was only there when we have massive amount of threads hitting the db at once, and trying to figure out what is actually going on there was next to impossible using standard debugging tools. Instead, I reached down to my tracing toolbelt and starting pulling stuff out. First, we identified that the problem occurred when iterating over RavenJArray, which is our own object, so we added the following:&#xA;        ConcurrentQueue&lt;StackTrace&gt;  addStackTraces = new ConcurrentQueue&lt;StackTrace&gt;();&#xA;&#xA;        public void Add(RavenJToken token)&#xA;        {&#xA;            if (isSnapshot)&#xA;                throw new InvalidOperationException(&quot;Cannot modify a snapshot, this is probably a bug&quot;);&#xA;&#xA;            addStackTraces.Enqueue(new StackTrace(true));&#xA;&#xA;            Items.Add(token);&#xA;        }&#xA;&#xA;&#xA;&#xA;And this one (where the exception is raised):&#xA;public override void WriteTo(JsonWriter writer, params JsonConverter[] converters)&#xA;{&#xA;    writer.WriteStartArray();&#xA;&#xA;    if (Items != null)&#xA;    {&#xA;        try&#xA;        {&#xA;            foreach (var token in Items)&#xA;            {&#xA;                token.WriteTo(writer, converters);&#xA;            }&#xA;        }&#xA;        catch (InvalidOperationException e)&#xA;        {&#xA;            foreach (var stackTrace in addStackTraces)&#xA;            {&#xA;                Console.WriteLine(stackTrace);&#xA;            }&#xA;            throw;&#xA;        }&#xA;    }&#xA;&#xA;    writer.WriteEndArray();&#xA;}&#xA;&#xA;&#xA;With the idea that we would actually be able to get what is going on there. By tracking down who added items to this particular instance, I hoped that I would be able to figure out why we have an instance that is shared among multiple threads.&#xA;When I had that, it was pretty easy to see that it was indeed the replication bundle that was causing the issue. The problem was that the replication bundle was modifying an inner array inside the document metadata. We protected the root properties of the metadata from concurrent modifications, and most of the time, it works just fine. But the problem was that now we had a bundle that was modifying a nested array, which wasn&#x2019;t protected.&#xA;This is one of those bugs that are really hard to catch:&#xA;&#xA;My understanding of the code said that this is not possible, since I believed that we protected the nested properties as well*.&#xA;This bug will only surface if and only if:&#xA;&#xA;You have the replication bundle enabled.&#xA;You have a great deal of concurrent modifications (with optimistic concurrency enabled) to the same document.&#xA;You are unlucky.&#xA;I was grateful that the user figured out the replication connection, because I already sat on that bug previously, and there was no way I could figure out what is going on unless I had the trace to point me to where the actual problem was.</p>
        <a href="https://ayende.com/blog/160962/rhino-etl-union-operation" target="_blank"><h1 class="title mb-6">Rhino ETL Union Operation</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 15, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Yes, it is somewhat of a blast from the past, but I just got asked how to create a good Union All operation for Rhino ETL. The obvious implementation is:      1: public class UnionAllOperation : AbstractOperation   2: {   3:     private readonly List&lt;IOperation&gt; _operations = new List&lt;IOperation&gt;();    4:&#xA0;    5:     public override IEnumerable&lt;Row&gt; Execute(IEnumerable&lt;Row&gt; rows)   6:     {   7:         foreach (var operation in _operations)   8:             foreach (var row in operation.Execute(null))   9:                 yield return row;  10:     }  11:&#xA0;   12:     public UnionAllOperation Add(IOperation operation)  13:     {  14:         _operations.Add(operation);  15:         return this;  16:     }  17: }&#xA;The problem is that this does everything synchronously. The following code is a better impl, but note that this is notepad code, with all the implications of that.&#xA;&#xA;&#xA;   1: public class UnionAllOperation : AbstractOperation   2: {   3:     private readonly List&lt;IOperation&gt; _operations = new List&lt;IOperation&gt;();    4:&#xA0;    5:     public override IEnumerable&lt;Row&gt; Execute(IEnumerable&lt;Row&gt; rows)   6:     {   7:         var blockingCollection = new BlockingCollection&lt;Row&gt;();   8:         var tasks = _operations.Select(currentOp =&gt; Task.Factory.StartNew(() =&gt;{   9:                 foreach(var operation in currentOp.Execute(null))  10:                 {  11:                     blockingCollection.Add(operation);  12:                 }  13:                 blockingCollection.Add(null); // free the consumer thread  14:             });  15:&#xA0;   16:         Row r;  17:         while(true){  18:             if(tasks.All(x=&gt;x.IsFaulted || x.IsCanceled || x.IsCompleted)) // all done  19:                 break;  20:             r = blockingCollection.Take();  21:             if(r == null)  22:                 continue;  23:             yield return r;  24:         }  25:         while(blockingCollection.TryTake(out r)) {  26:             if(r == null)  27:                 continue;  28:             yield return r;  29:         }  30:         Task.WaitAll(tasks.ToArray()); // raise any exception that were raised during execption  31:     }  32:&#xA0;   33:     public UnionAllOperation Add(IOperation operation)  34:     {  35:         _operations.Add(operation);  36:         return this;  37:     }  38: }&#xA;Usual caveats apply, notepad code, never actually run it, much less tested / debugged it.&#xA;Feel free to rip into it, though.&#xA;Dale Newman did some improvements, the most important one is to make sure that we aren&#x2019;t going to evaluate the tasks several times (opps! I told ya it was notepad code ), and now it looks like this:&#xA;&#xA;   1: /// &lt;summary&gt;   2: /// Combines rows from all operations.   3: /// &lt;/summary&gt;   4: public class UnionAllOperation : AbstractOperation {   5:&#xA0;    6:     private readonly List&lt;IOperation&gt; _operations = new List&lt;IOperation&gt;();   7:&#xA0;    8:     /// &lt;summary&gt;   9:     /// Executes the added operations in parallel.  10:     /// &lt;/summary&gt;  11:     /// &lt;param name=&quot;rows&quot;&gt;&lt;/param&gt;  12:     /// &lt;returns&gt;&lt;/returns&gt;  13:     public override IEnumerable&lt;Row&gt; Execute(IEnumerable&lt;Row&gt; rows) {  14:&#xA0;   15:         var blockingCollection = new BlockingCollection&lt;Row&gt;();  16:&#xA0;   17:         Debug(&quot;Creating tasks for {0} operations.&quot;, _operations.Count);  18:&#xA0;   19:         var tasks = _operations.Select(currentOp =&gt; Task.Factory.StartNew(() =&gt; {  20:             Trace(&quot;Executing {0} operation.&quot;, currentOp.Name);  21:             foreach (var row in currentOp.Execute(null)) {  22:                 blockingCollection.Add(row);  23:             }  24:             blockingCollection.Add(null); // free the consumer thread  25:         })).ToArray();  26:&#xA0;   27:         Row r;  28:         while (true) {  29:             if (tasks.All(x =&gt; x.IsFaulted || x.IsCanceled || x.IsCompleted)) {  30:                 Debug(&quot;All tasks have been canceled, have faulted, or have completed.&quot;);  31:                 break;  32:             }  33:&#xA0;   34:             r = blockingCollection.Take();  35:             if (r == null)  36:                 continue;  37:&#xA0;   38:             yield return r;  39:&#xA0;   40:         }  41:&#xA0;   42:         while (blockingCollection.TryTake(out r)) {  43:             if (r == null)  44:                 continue;  45:             yield return r;  46:         }  47:&#xA0;   48:         Task.WaitAll(tasks); // raise any exception that were raised during execption  49:&#xA0;   50:     }  51:&#xA0;   52:     /// &lt;summary&gt;  53:     /// Initializes this instance  54:     /// &lt;/summary&gt;  55:     /// &lt;param name=&quot;pipelineExecuter&quot;&gt;The current pipeline executer.&lt;/param&gt;  56:     public override void PrepareForExecution(IPipelineExecuter pipelineExecuter) {  57:         foreach (var operation in _operations) {  58:             operation.PrepareForExecution(pipelineExecuter);  59:         }  60:     }  61:&#xA0;   62:     /// &lt;summary&gt;  63:     /// Add operation parameters  64:     /// &lt;/summary&gt;  65:     /// &lt;param name=&quot;ops&quot;&gt;operations delimited by commas&lt;/param&gt;  66:     /// &lt;returns&gt;&lt;/returns&gt;  67:     public UnionAllOperation Add(params IOperation[] ops) {  68:         foreach (var operation in ops) {  69:             _operations.Add(operation);  70:         }  71:         return this;  72:     }  73:&#xA0;   74:     /// &lt;summary&gt;  75:     /// Add operations  76:     /// &lt;/summary&gt;  77:     /// &lt;param name=&quot;ops&quot;&gt;an enumerable of operations&lt;/param&gt;  78:     /// &lt;returns&gt;&lt;/returns&gt;  79:     public UnionAllOperation Add(IEnumerable&lt;IOperation&gt; ops) {  80:         _operations.AddRange(ops);  81:         return this;  82:     }  83:&#xA0;   84: }</p>
        <a href="https://ayende.com/blog/160961/some-errors-ravendb-cant-recover-on-its-own" target="_blank"><h1 class="title mb-6">Some errors, RavenDB can&#x2019;t recover on its own</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 14, 2013
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">And yes, I know about this because we got a support ticket for it.</p>
        <div class="button flex justify-between">
            <a href="301.html"><span class="back arrow"></span></a>

            <a href="303.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>