
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 311 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3101">
            <a href="https://ayende.com/blog/175780/that-is-my-memory-youre-freeing-you-foreign-thread" target="_blank">
                <h2 class="title mb-6" id="article-3101">That is my memory you&#x2019;re freeing, you foreign thread!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 18, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB is a pretty big project, and it has been around for quite a while. That means that we have run into a lot of strange stuff over the years. In particular, support incidents are something that we track and try to learn from. Today&#x2019;s post is about one such lesson. We want to be able to track, on a per thread basis, how much memory is in use. Note that when we say that, we talk about unmanaged memory. The idea is, once we track it, we can manage it. Here is one such example:  Note that this has already paid for itself when it showed us very clearly (and without using special tools), exactly who is allocating too much memory. Memory allocation / de-allocation is often a big performance problem, and we are trying very hard to not get painted into performance corners. So a lot of our actual memory usage is allocate once, then keep around in the thread for additional use. This turn out to be quite useful. It also means that for the most part, we really don&#x2019;t have to worry about thread safety. Memory allocations happen in the context of a thread, and are released to the thread once an operation is done.  This gives us high memory locality and it avoids having to take locks to manage memory. Which is great, except that we also have quite a bit of async request processing code. And async request processing code will quite gladly jump threads for you. So that lead to a situation where you allocate memory in thread #17 at the beginning of the request and it waits for I/O, so when it finally completes, the request finish processing in thread #29. In this case, we keep the memory we go for next usage in the finishing thread. This is based on the observation that we typically see the following patterns:  Dedicated threads for tasks, that do no thread hopping, each have unique memory usage signature, and will eventually settle into the memory it needs to process everything properly. Pools of similar threads that share roughly the same tasks with one another, and have thread hopping. Over time, things will average out and all threads will have roughly the same amount of memory. That is great, but it does present us with a problem, how do we account for that? If thread #17 allocated some memory, and it is now sitting in thread #29&#x2019;s bank, who is charged for that memory? The answer is that we always charge the thread that initially allocated the memory, even if it currently doesn&#x2019;t have that memory available. This is because it is frequently the initial allocation that we need to track, and usage over time just means that we are avoiding constant malloc/free calls.  It does present a problem, what happens if thread #29 is freeing memory that belongs to thread #17? Well, we can just decrement the allocated value, but that would force us to always do threads safe operations, which are more expensive. Instead, we do this:  If the freeing thread is the same as the allocation thread, just use simple subtraction, crazy cheap. But if it was allocated from another thread, do the thread safe thing. Then we smash both values together to create the final, complete, picture.</p>
        </article>
        <article id="article-3102">
            <a href="https://andrewlock.net/modifying-the-ui-based-on-user-authorisation-in-asp-net-core/" target="_blank">
                <h2 class="title mb-6" id="article-3102">Modifying the UI based on user authorisation in ASP.NET Core</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 18, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how to modify the UI you present based on the authorisation level of the current user, to hide links the user is not allowed to access.&#x2026;</p>
        </article>
        <article id="article-3103">
            <a href="https://www.stevejgordon.co.uk/loading-pin-on-bing-maps-from-asp-net-core-mvc-data" target="_blank">
                <h2 class="title mb-6" id="article-3103">Loading Pin on Bing Maps from ASP.NET Core MVC Data</h2>
            </a>
            <p class="mb-2">by Steve Gordon</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 17, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">As I&#x2019;ve covered a few times previously in my blog I&#x2019;m really enjoying working on the allReady project which is run by the Humanitarian Toolbox non-profit organisation. One of the great things about this project from a personal perspective is the chance to learn and develop my skills, whilst also contributing to a good cause. [&#x2026;]</p>
        </article>
        <article id="article-3104">
            <a href="https://ayende.com/blog/175779/ravendb-retrospective-the-governors" target="_blank">
                <h2 class="title mb-6" id="article-3104">RavenDB Retrospective</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 17, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB&#x2019;s core philosophy is that It Just Works and that means that we try very hard to get things right. Conversely, that means that we are also trying to make it hard to do the wrong thing. Basically, we want to push you hard into the pit of success.  Part of that approach is what we call the governors. It is a set of features that will detect and abort known bad behavioral patterns.&#xA0; I have already talked about Unbounded Result Sets  and I recently run into this post, which shows how nasty a problem that can be, and how invisible. Another governor we have in place is the session&#x2019;s maximum request limit. A session is meant to be a scope, it has a very short duration and is typically used for a single request / processing a single message, etc. It is supposed to live as long as the business transaction. Because the session is scoped, we can reason that a single session that is making a lot of database operation is probably doing something pretty bad. For example, it might be calling the database in a loop. Those kind of issues can be truly insidious. Let us look at the following code (taken from here):    This kind of thing is a silent performance killer. No one is likely to see this is happening, and it will silently increase the number of database operations that your application make, leading to increased DB load, higher page load times and all sort of problems associated with it. In one particular case, I saw a single page load generate 17,000 queries to the database. The software in question grew over time, and people assumed that this was just it took to run the software. Their database server was a true monster (this was about a decade ago), with dedicated RAM disks, high CPU count and a truly ridiculous amount of memory. Just to explain, we are talking about something like this:  But a decade ago, and it had a quite a bit of space. Now, this kind of beasty can do 500K IOPS (I&#x2019;m drooling just thinking about it), but it is damn expensive. Just to put things in perspective, I spent several weeks at that company working on this particular problem, the cost of those weeks of work didn&#x2019;t even cover the cost of the drive on that machine.  And on that monster, we were seeing page load times in the tens of seconds, and extremely high system load. I was able to bring it down to about 70 queries per page load, and their database server has pretty much idled ever since (IIRC, they turn that machine into a VM host for all the rest of their software, actually). This is something that can bite.  To avoid that, we have the max numbers of requests in the session, which will abort excessive amount of database chatter. This have two important effects:  It follow the &#x201C;better let one bad request die rather than take down the entire application&#x201D;. It put a budget on the number of calls that you can make. Now, that budget is actually really interesting. Because we have it, we need to think about how we can reduce the number of database calls that we have to process the request. That led to a whole bunch of features around that. Lazy requests, includes and transformers to name just a few. That had a positive unintended consequence. RavenDB is fast,&#xA0; really fast, but it is also typically deployed as a network database, that means that each database call actually go over the network, and we all remember our fallacies, right?  In our profiling, we found that most often, the real cost in a RavenDB application was the back &amp; forth chatter with the database. Reducing the number of requests we make to the server has an immediate benefit. And RavenDB allows you to do that by pipelining requests with Lazy, predicting requests with Includes or running the whole thing on the server side with Transformers.  And, like all governors, you can control it, RavenDB allows you to decide what the limit should be (on that particular session or globally based on your actual needs and environment.</p>
        </article>
        <article id="article-3105">
            <a href="https://www.stevejgordon.co.uk/debugging-into-asp-net-core-source" target="_blank">
                <h2 class="title mb-6" id="article-3105">Debugging into ASP.NET Core Source</h2>
            </a>
            <p class="mb-2">by Steve Gordon</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 16, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Update 26-10-16: Thanks to eagle eyed reader Japawel who has commented below; it&#x2019;s been pointed out that there is a release 1.0.1 tag that I&#x2019;d missed when writing this post. Using that negated the two troubleshooting issues I had included at the end of this post. I&#x2019;ve updated the tag name in this post but [&#x2026;]</p>
        </article>
        <article id="article-3106">
            <a href="https://ayende.com/blog/175778/ravendb-retrospective-explicit-indexes-auto-indexes" target="_blank">
                <h2 class="title mb-6" id="article-3106">RavenDB Retrospective</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 14, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB doesn&#x2019;t provide any way for queries to do table scans*.  * That isn&#x2019;t actually true, we have Data Exploration, which does just that, but we don&#x2019;t provide an explicit API for it, and it is a DBA driven feature (I wanna get this report with a minimum of fuss without regards to how much it is going to cost me) than an API that is exposed. What this means is that the cost of query operations in RavenDB is always going to be O(logN), instead of O(N). How does this relate to the topic of RavenDB retrospectives?  One of the things that I kept seeing over and over as a database consultant was that databases are complex, and that it is easy to write a query that works perfectly fine for a period of time, then fall over completely as the size of the data goes over a certain threshold. In particular, queries that use table scans are particularly vulnerable for this issue. One of the design goals for RavenDB was to avoid that, completely. We did it by simply forbidding any query that doesn&#x2019;t have an index. initially, that was a pretty annoying requirement, because every time that you needed a new query, you needed to go ahead and create an index. But early on we got the Auto Indexes feature.  Basically, it means that when you can query RavenDB without specifying which index you want to use, at which point the query optimizer will inspect the query and decide which index can serve it. The most interesting point here is that if there isn&#x2019;t an index that can serve this query, the query optimizer is going to create one on the fly. See the previous post about BASE indexes and how we can afford to do that.  The fun part here is that the query optimizer is actually learning over time, and it will shape its indexes to best fit the kind of queries you are doing. It also makes RavenDB much more robust for New Version Degradation effects. NVD is what happens when you push a new version out, which have slightly different queries, which make previously used indexes ineffective, forcing all your queries to become full table scans. Here is an example of the kind of subtle issues that this can cause. With RavenDB, when you use auto indexes (in other words, when you don&#x2019;t explicitly state which index to use), the query optimizer will take care of that, and it will create all the appropriate indexes (and retire the unused ones)&#xA0; for you. This in particular is a feature that I&#x2019;m really proud of, it require very little from the user to work with, and it gets the Right Thing Done.</p>
        </article>
        <article id="article-3107">
            <a href="https://ayende.com/blog/175745/the-red-alert-sleeper-agent-bug" target="_blank">
                <h2 class="title mb-6" id="article-3107">The Red Alert Sleeper Agent Bug</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 13, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Today I started out like most recent days, I was working on improving performance and running benchmarks. I made a small change in how we handle file allocation and mapping inside Voron. This is the kind of change that should have no observable effects. And indeed, except for making us run faster, everything worked. Except that later today I merged some stuff from a colleague and suddenly I started getting invalid memory accesses. After quickly blaming my colleague for the issue, we eventually figured out that it was my change that caused it. Unfortunately, the problem was a lot more serious than it immediately appeared. It wasn&#x2019;t just that I needed to fix my code, what was happening there was that I made a certain situation (a new file mapping, and thus, exercising the cleanup routine) a lot more frequent. Which is all well and good, except that this is something that will happen routinely in Voron anyway, it just means that this is now much more likely. And the problem is that we couldn&#x2019;t for the life of us figure out why it was failing. Oh, we quickly figured out that we are accessing memory that has been unmapped, but how? The Voron codebase is really careful about such things, and we have quite enough production usage to know that this doesn&#x2019;t really happen. But again, it might just be a sleeper&#x2026; The real problem wasn&#x2019;t actually with the access violation, that was pretty obvious and would have come to our immediate attention. The problem was that the error looked like the Page Translation Table had a race condition. In this case, because we are much more eager about cleanup, it was obvious that we are accessing old information, but without this to trigger our attention, the fear was that we are actually racy, and that the Page Translation Table will serve incorrect information. That means that Voron would violate its consistency rule, we&#x2019;ll effectively be returning random garbage to the user and&#x2026; Bad Things to Follow. At various points during the day, we had five different people working on it in three continents, because it is that kind of bug. And we couldn&#x2019;t figure it out. We traced the code that did that every which way. It is old code, that has been worked upon repeatedly, and it has been stable for years. And none of us could figure out what was going on. Theories ranging from cosmic rays to the wrath of Murphy has been thrown out. Something was very rotten in Voron. Okay, after all of this exposition, let me explain what was going on. We started out with a Page Table that looked like this:  So the first number is the page number, and the second is the page number inside the scratch file (#1 or #2, above). Basically, this means that when Transaction #3 looks asks for Page #0, it will actually get Page #238 from scratch #1. And when Transaction #4 asks for the same page, it will get it from Page #482 on scratch #2. If you got lost with the numbers, don&#x2019;t worry, we did too. The problem was&#x2026; the failing issue was in transaction #5, and the problem was that it was access page #412 on scratch #1. And due to my change, we actually closed scratch #1. The problem is that we couldn&#x2019;t figure out how this thing could actually happen. Crazy stuff. We tried reproducing this in all sort of crazy ways, but it would only fail on the most trivial of tests, and very unpredictably. And then we finally figured it out. Basically by tracing everything, putting locks on everything that moved or looked like it would move it I kicked it and plain head against wall rinse &amp; repeat. Eventually we focused on what happened around the location of the error. It always happened during a query, that was very consistent, when it happened. And finally we figured it out. We now use Lucene indexes stored inside Voron, and Lucene has some funky ideas about how it should be able to access the data. So we have to put a Voron transaction around the whole thing. And we have to flow the same transaction across multiple Lucene index input instances. So we put the transaction inside a thread local variable. And the query method is async. I think that you can figure out what happened from here, right? When the async machinery jumped us threads, we would end up with a totally foreign transaction, our old transaction would be gone, and all of the carefully thought out premises that we have for transaction scope went out the window. Much cursing was to be heard. So we did a quick fix and changed the ThreadLocal&lt;Transaction&gt; to be an AsyncLocal&lt;Transaction&gt;, so it would flow through the async calls. And then we run the tests, confident it would solve it. But it didn&#x2019;t, in fact, we got the exact same error, in the exact same place, and we went back to head butting the wall to see who is smarter. And then I realized that we were doing something else there. Lucene has the notion of cloning an input, which allows for multi threaded usage of an input. When we do that, we check if we are in the old transaction scope and can reuse previous work, or if we need to do the initialization for a new transaction. The problem was that we were doing this check by id.  Now, two transactions with the same id will always show the same data, period. However, how they do it is very different. Let us take a look at the Page Table diagram above. It shows that Page #412 is located on scratch #2 in position #8327. Now, we have a flushing background process that will take the data from the scratch file and move it to the data file. So the new Page Table will look like this:  Note that because the data on the data file in position #412 and scratch #2 in position #8327 is the same, that doesn&#x2019;t actually matter. Except that when you have started in one transaction and started reading from scratch #2, then was bumped into another thread, and now are trying to keep on reading from the same place, only to end up blowing up entirely. Once we have fixed this problem as well, all was well with the world. The sky wasn&#x2019;t falling, and I was writing a blog post at midnight for relaxation.</p>
        </article>
        <article id="article-3108">
            <a href="https://ayende.com/blog/175777/ravendb-retrospective-base-indexes" target="_blank">
                <h2 class="title mb-6" id="article-3108">RavenDB Retrospective</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 12, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB was designed from the get go with ACID documents store, and BASE indexes. ACID stands for Atomic, Consistent, Isolated, Durable, and BASE stands for Basically Available, Soft state, Eventually consistent.&#xA;That design had been conceived by twin competing needs. First, and obvious, a database should never lose data. Second, we want to ensure that the system remains responsive even under load. It is quite common to have spike in production traffic, and we wanted to be able to be able to handle it with better aplomb.&#xA;In particular, the kind of promises that are made by RavenDB queries allow us to perform quite a few performance optimizations. In databases that require that all indexes will be up to date on transaction commit, you&#x2019;ll find that there is a very high cost to adding indexes to the system, because each additional index means additional work is needed at query time. It also makes things such as aggregating indexes (map/reduce, in RavenDB terms) a lot harder to build.&#xA;By having BASE indexes, we gain the ability to batch multiple writes into a single index update operation. It also allows us to defer writing the indexes to the disk, avoiding costly I/O operations. But most importantly, by changing the kind of promise that we give to users, we are able to avoid a lot of locks, complexity and hardship inside RavenDB. This may seems like a small thing, but this is actually quite important. Take a look at this study:&#xA;&#xA;In fact, there are a lot of studies on the overhead of locking in database systems, and that has been a hot research topic for many years. By choosing a different architecture, we can avoid a lot of those costs and complexities.&#xA;So far, that was the explanation from the point of view of the database creator. What about the users?&#xA;Here the tradeoff is more nuanced. On the one hand, there is a certain level of complexity that people have to deal with the notion that queries on just inserted data might not include it (stale queries), on the other hand, it means that queries are consistently faster and we can handle spikes in traffic and load much more easily and consistently.&#xA;But it is a mental model that can be hard to follow, even when you are familiar with it. Probably the most common issue with RavenDB&#x2019;s BASE indexes is the case of Post / Redirect / Get. Let us look at how this may play out:&#xA;In here, we actually have two requests, one that adds a new order to the system, and the other that fetch the details. If you have redirected to the new order page, everything is going to work as expected, and you won&#x2019;t notice anything even if the indexes are stale at the time of the request. But a pretty common scenario is to add the new order, and then go and look at the list of orders for this customer, and if the index didn&#x2019;t have the chance to update between those two requests (which typically happen very quickly) then the customer will not see the new order.&#xA;That particular scenario is responsible for the vast majority the pain we have seen from our users around BASE indexes.&#xA;Now, one of the great things about BASE indexes is that the user get to choose whatever they want to wait for the up to date results or whatever they want whatever is there right now. And we have had mechanisms to control this at a very granular level (including options for personal consistency control, so different customers will have different waits depending on their own previous behavior). But we have found that this is something that puts a lot of responsibility on the developer to control the flow on their users on their applications.&#xA;So in RavenDB 3.5 we have changed things a bit. Now, instead of processing the write requests as soon as possible, you can ask for the server to wait until the relevant indexes has processed:&#xA;&#xA;In other words, when you call SaveChanges, it will wait until the indexes has been updated, so when you return from the call, you can be certain that the results of any future queries will include all the changes on that transaction. This moves the responsibility to the&#xA0; write side and make such scenarios much easier to handle.&#xA;Given all of that, and our experience with RavenDB for the past 8 years or so, we spiked how it would look like with ACID indexes, at least for certain things. The problem is that this pretty much takes out of the equation a lot of the power and flexibility that we get from Lucene (more on why you can&#x2019;t do that in Lucene in a bit) and force us to offer what are essentially B&#x2B;Tree indexes. Those are so limited that we would have to offer:&#xA;&#xA;B&#x2B;Tree indexes &#x2013; ACID (simple property / range queries). With different indexes needed for different queries and ordering options.&#xA;Lucene indexes &#x2013; BASE, full text, spatial, facets, etc queries. Much more flexible and easy to use.&#xA;Map/reduce indexes &#x2013; BASE (because you aren&#x2019;t going to run the full map/reduce during the original transaction).&#xA;&#xA;The problem is that then we would have continuous burden of explaining when to use which index type, and how to deal with the different limitations. It will also make it much more complex if you have a query that can use multiple indexes, and there are problems associated with creating new ACID indexes on live systems. So it would generate a lot of confusion and complexity to users, for fairly small benefit that we can address already with the &#x201C;wait on save&#x201D; option.&#xA;As for why we can&#x2019;t do it all via Lucene anyway, the problem is that this wouldn&#x2019;t be sustainable. Lucene isn&#x2019;t really meant for individual operations, it shines when you push large amount of data through it. It also doesn&#x2019;t really have the facilities to be transactional, we have actually solved that particular problem in RavenDB 4.0, but it was neither pretty nor easy, and it doesn&#x2019;t alleviate the issue of &#x201C;we do best in large batches&#x201D;. RavenDB&#x2019;s BASE indexes are actually designed to take advantage of that particular aspect. Because under load, we&#x2019;ll process bigger batches are reap the performance benefits that they bring.&#xA;BASE indexes also make for much simpler operations. You can define a new index without fearing locking the database, and it enables scenarios such as side by side indexing to update index definitions without impacting the running system.&#xA;Finally, a truly massive benefit of BASE indexes is that they allow us to change the following statement: more indexes means faster reads, slower writes. Fewer indexes means slower reads, faster writes. By movng the actual indexing work to a background task, we let the writes go though as fast as tehy possible can.&#xA;Indexes still have a cost, and the more indexes you have, the higher the cost (we still got to do&#xA0;some work here). But in the vast majority of the cases, we can squeeze this kind of work&#xA0;between writes, in times that the database would be idling.&#xA0;&#xA;What that means is that you can have more indexes at the same cost, and that your queries are going to be using those indexes and are going to be&#xA0;fast.</p>
        </article>
        <article id="article-3109">
            <a href="https://ayende.com/blog/175714/timing-the-time-it-takes-to-parse-time-part-ii" target="_blank">
                <h2 class="title mb-6" id="article-3109">Timing the time it takes to parse time</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 11, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There are times when you write clean, easily to understand code, and there are times when you see 50% of your performance goes into DateTime parsing, at which point you&#x2019;ll need to throw nice code out the window, put on some protective gear and seek out that performance hit that you need so much. Note to the readers: This isn&#x2019;t something that I recommend you&#x2019;ll do unless you have considered it carefully, you have gathered evidence in the form of actual profiler results that show that this is justified, and you covered it with good enough tests. The only reason that I was actually able to do anything is that I know so much about the situation. The dates are strictly formatted, the values are stored as UTF8 and there are no cultures to consider. With that said, it means that we are back to C&#x2019;s style number parsing and processing: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public unsafe class LazyStringParser&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              public enum Result&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  Failed,&#xA;        &#xA;        &#xA;          &#xA;                  DateTime,&#xA;        &#xA;        &#xA;          &#xA;                  DateTimeOffset&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public static Result TryParseDateTime(byte* buffer, int len, out DateTime dt, out DateTimeOffset dto)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  dt = default(DateTime);&#xA;        &#xA;        &#xA;          &#xA;                  dto = default(DateTimeOffset);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (len &lt; 19)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  int year, month, day, hour, minute, second, fractions, offsetHour, offsetMinute;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (buffer[4] != &#x27;-&#x27; || buffer[7] != &#x27;-&#x27; || buffer[10] != &#x27;T&#x27; ||&#xA;        &#xA;        &#xA;          &#xA;                      buffer[13] != &#x27;:&#x27; || buffer[16] != &#x27;:&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (TryParseNumber4(buffer, out year) == false)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (TryParseNumber2(buffer &#x2B; 5, out month) == false)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (TryParseNumber2(buffer &#x2B; 8, out day) == false)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (TryParseNumber2(buffer &#x2B; 11, out hour) == false)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (TryParseNumber2(buffer &#x2B; 14, out minute) == false)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if (TryParseNumber2(buffer &#x2B; 17, out second) == false)&#xA;        &#xA;        &#xA;          &#xA;                      return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  switch (len)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      case 19://&quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss&quot;,&#xA;        &#xA;        &#xA;          &#xA;                          dt = new DateTime(year, month, day, hour, minute, second);&#xA;        &#xA;        &#xA;          &#xA;                          return Result.DateTime;&#xA;        &#xA;        &#xA;          &#xA;                      case 20: //&quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss&#x27;Z&#x27;&quot;,&#xA;        &#xA;        &#xA;          &#xA;                          if (buffer[19] != &#x27;Z&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                          dt = new DateTime(year, month, day, hour, minute, second, DateTimeKind.Utc);&#xA;        &#xA;        &#xA;          &#xA;                          return Result.DateTime;&#xA;        &#xA;        &#xA;          &#xA;                      case 27://&quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss.fffffff&quot;&#xA;        &#xA;        &#xA;          &#xA;                          if (buffer[19] != &#x27;.&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                          if (TryParseNumber(buffer &#x2B; 20, 7, out fractions) == false)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                          dt = new DateTime(year, month, day, hour, minute, second).AddTicks(fractions);&#xA;        &#xA;        &#xA;          &#xA;                          return Result.DateTime;&#xA;        &#xA;        &#xA;          &#xA;                      case 28://&quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss.fffffff&#x27;Z&#x27;&quot;&#xA;        &#xA;        &#xA;          &#xA;                          if (buffer[19] != &#x27;.&#x27; || buffer[27] != &#x27;Z&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                          if (TryParseNumber(buffer &#x2B; 20, 7, out fractions) == false)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                          dt = new DateTime(year, month, day, hour, minute, second, DateTimeKind.Utc).AddTicks(fractions);&#xA;        &#xA;        &#xA;          &#xA;                          return Result.DateTime;&#xA;        &#xA;        &#xA;          &#xA;                      case 33://&quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss.fffffff&#x27;&#x2B;&#x27;dd&#x27;:&#x27;dd&quot;&#xA;        &#xA;        &#xA;          &#xA;                          if (buffer[19] != &#x27;.&#x27; || buffer[27] != &#x27;&#x2B;&#x27; || buffer[30] != &#x27;:&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                          if (TryParseNumber(buffer &#x2B; 20, 7, out fractions) == false)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                          if (TryParseNumber2(buffer &#x2B; 28, out offsetHour) == false)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                          if (TryParseNumber2(buffer &#x2B; 31, out offsetMinute) == false)&#xA;        &#xA;        &#xA;          &#xA;                              return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                          dto = new DateTimeOffset(year, month, day, hour, minute, second,&#xA;        &#xA;        &#xA;          &#xA;                              new TimeSpan(offsetHour, offsetMinute, 0)).AddTicks(fractions);&#xA;        &#xA;        &#xA;          &#xA;                          return Result.DateTimeOffset;&#xA;        &#xA;        &#xA;          &#xA;                      default:&#xA;        &#xA;        &#xA;          &#xA;                          return Result.Failed;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private static bool TryParseNumber(byte* ptr, int size, out int val)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  int localVal = 0;&#xA;        &#xA;        &#xA;          &#xA;                  for (int i = 0; i &lt; size; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      localVal *= 10;&#xA;        &#xA;        &#xA;          &#xA;                      if (ptr[i] &lt; &#x27;0&#x27; || ptr[i] &gt; &#x27;9&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          val = 0;&#xA;        &#xA;        &#xA;          &#xA;                          return false;&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      localVal &#x2B;= ptr[i] - &#x27;0&#x27;;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  val = localVal;&#xA;        &#xA;        &#xA;          &#xA;                  return true;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private static bool TryParseNumber2(byte* ptr, out int val)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  if (ptr[0] &lt; &#x27;0&#x27; || ptr[0] &gt; &#x27;9&#x27; ||&#xA;        &#xA;        &#xA;          &#xA;                      ptr[1] &lt; &#x27;0&#x27; || ptr[1] &gt; &#x27;9&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      val = 0;&#xA;        &#xA;        &#xA;          &#xA;                      return false;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  var result = (ptr[0] - &#x27;0&#x27;) * 10 &#x2B; ptr[1] - &#x27;0&#x27;;&#xA;        &#xA;        &#xA;          &#xA;                  val = result;&#xA;        &#xA;        &#xA;          &#xA;                  return true;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private static bool TryParseNumber4(byte* ptr, out int val)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  if (ptr[0] &lt; &#x27;0&#x27; || ptr[0] &gt; &#x27;9&#x27; ||&#xA;        &#xA;        &#xA;          &#xA;                      ptr[1] &lt; &#x27;0&#x27; || ptr[1] &gt; &#x27;9&#x27; ||&#xA;        &#xA;        &#xA;          &#xA;                      ptr[2] &lt; &#x27;0&#x27; || ptr[2] &gt; &#x27;9&#x27; ||&#xA;        &#xA;        &#xA;          &#xA;                      ptr[3] &lt; &#x27;0&#x27; || ptr[3] &gt; &#x27;9&#x27;)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      val = 0;&#xA;        &#xA;        &#xA;          &#xA;                      return false;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  var result = (ptr[0] - &#x27;0&#x27;) * 1000 &#x2B; (ptr[1] - &#x27;0&#x27;) * 100 &#x2B; (ptr[2] - &#x27;0&#x27;) * 10 &#x2B; ptr[3] - &#x27;0&#x27;;&#xA;        &#xA;        &#xA;          &#xA;                  val = result;&#xA;        &#xA;        &#xA;          &#xA;                  return true;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          LazyStringParser.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; Note that the code is pretty strange, we do upfront validation into the string, then parse all those numbers, then plug this in together.  The tests we run are: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public unsafe class DateParsingBench&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            static byte[][] dates = &#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                    Encoding.UTF8.GetBytes(&quot;2016-10-05T21:07:32.2082285&#x2B;03:00&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    Encoding.UTF8.GetBytes(&quot;2016-10-05T21:07:32.2082285Z&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    Encoding.UTF8.GetBytes(&quot;2016-10-05T21:07:32.2082285&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    Encoding.UTF8.GetBytes(&quot;2016-10-05T21:07:32&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    Encoding.UTF8.GetBytes(&quot;2016-10-05T21:07:3&quot;),// invalid&#xA;        &#xA;        &#xA;          &#xA;                };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            static string[] datesStrings =&#xA;        &#xA;        &#xA;          &#xA;               {&#xA;        &#xA;        &#xA;          &#xA;                    (&quot;2016-10-05T21:07:32.2082285&#x2B;03:00&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    (&quot;2016-10-05T21:07:32.2082285Z&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    (&quot;2016-10-05T21:07:32.2082285&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    (&quot;2016-10-05T21:07:32&quot;),&#xA;        &#xA;        &#xA;          &#xA;                    (&quot;2016-10-05T21:07:3&quot;),// invalid&#xA;        &#xA;        &#xA;          &#xA;                };&#xA;        &#xA;        &#xA;          &#xA;            public static readonly string[] OnlyDateTimeFormat = new[]&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                &quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss.fffffff&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;yyyy&#x27;-&#x27;MM&#x27;-&#x27;dd&#x27;T&#x27;HH&#x27;:&#x27;mm&#x27;:&#x27;ss.fffffff&#x27;Z&#x27;&quot;&#xA;        &#xA;        &#xA;          &#xA;            };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            [Benchmark(OperationsPerInvoke = 5)]&#xA;        &#xA;        &#xA;          &#xA;            public static void ParseDateTime()&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                for (int i = 0; i &lt; dates.Length; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                    var str = Encoding.UTF8.GetString(dates[i]);&#xA;        &#xA;        &#xA;          &#xA;                    DateTime dateTime;&#xA;        &#xA;        &#xA;          &#xA;                    if (DateTime.TryParseExact(str, OnlyDateTimeFormat, CultureInfo.InvariantCulture, &#xA;        &#xA;        &#xA;          &#xA;                        DateTimeStyles.RoundtripKind, out dateTime))&#xA;        &#xA;        &#xA;          &#xA;                    {&#xA;        &#xA;        &#xA;          &#xA;                        continue;&#xA;        &#xA;        &#xA;          &#xA;                    }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                    DateTimeOffset dateTimeOffset;&#xA;        &#xA;        &#xA;          &#xA;                    DateTimeOffset.TryParseExact(str, &quot;o&quot;, CultureInfo.InvariantCulture, DateTimeStyles.RoundtripKind,&#xA;        &#xA;        &#xA;          &#xA;                        out dateTimeOffset);&#xA;        &#xA;        &#xA;          &#xA;                }&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            [Benchmark(OperationsPerInvoke = 5)]&#xA;        &#xA;        &#xA;          &#xA;            public static void ParseDateTimeString()&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                for (int i = 0; i &lt; datesStrings.Length; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                    DateTime dateTime;&#xA;        &#xA;        &#xA;          &#xA;                    if (DateTime.TryParseExact(datesStrings[i], OnlyDateTimeFormat, CultureInfo.InvariantCulture,&#xA;        &#xA;        &#xA;          &#xA;                        DateTimeStyles.RoundtripKind, out dateTime))&#xA;        &#xA;        &#xA;          &#xA;                    {&#xA;        &#xA;        &#xA;          &#xA;                        continue;&#xA;        &#xA;        &#xA;          &#xA;                    }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                    DateTimeOffset dateTimeOffset;&#xA;        &#xA;        &#xA;          &#xA;                    DateTimeOffset.TryParseExact(datesStrings[i], &quot;o&quot;, CultureInfo.InvariantCulture, DateTimeStyles.RoundtripKind,&#xA;        &#xA;        &#xA;          &#xA;                        out dateTimeOffset);&#xA;        &#xA;        &#xA;          &#xA;                }&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            [Benchmark(OperationsPerInvoke = 5)]&#xA;        &#xA;        &#xA;          &#xA;            public static unsafe void EfficentParser()&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                for (int i = 0; i &lt; dates.Length; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                    fixed (byte* p = dates[i])&#xA;        &#xA;        &#xA;          &#xA;                    {&#xA;        &#xA;        &#xA;          &#xA;                        DateTime dt;&#xA;        &#xA;        &#xA;          &#xA;                        DateTimeOffset dto;&#xA;        &#xA;        &#xA;          &#xA;                        LazyStringParser.TryParseDateTime(p, dates[i].Length, out dt, out dto);&#xA;        &#xA;        &#xA;          &#xA;                    }&#xA;        &#xA;        &#xA;          &#xA;                }&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          DateParsingBench.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; Note that I&#x2019;ve actually realized that I&#x2019;ve been forcing the standard CLR parsing to go through conversion from byte array to string on each call. This is actually what we need to do in RavenDB to support this scenario, but I decided to test it out without the allocations as well. All the timings here are in nanoseconds.   Note that the StdDev for those test is around 70 ns. And this usually takes about 2,400 ns to run. Without allocations, things are better, but not by much. StdDev goes does to 50 ns, and the performance is around 2,340 ns, so there is a small gain from not doing allocations. Here are the final results of the three methods:  Note that my method is about as fast as the StdDev on the alternative. With an average of 90 ns or so, and StdDev of 4 ns. Surprisingly, LegacyJit on X64 was the faster of them all, coming in at almost 60% of the LegacyJit on X86, and 20% faster than RyuJit on X64. Not sure why, and dumping the assembly at this point is quibbling, honestly. Our perf cost just went down from 2400 ns to 90 ns. In other words, we are now going to be able to do the same work at 3.66% of the cost. Figuring out how to push it further down to 2.95% seems to insult the 96% perf that we gained. And anyway, that does leave us with some spare performance on the table if this ever become a hotspot again*. * Actually, the guys on the performance teams are going to read this post, and I&#x2019;m sure they wouldn&#x2019;t be able to resist improving it further .</p>
        </article>
        <article id="article-3110">
            <a href="https://ayende.com/blog/175809/ravendb-3-5-release-candidate-3-and-final-is-out" target="_blank">
                <h2 class="title mb-6" id="article-3110">RavenDB 3.5 Release Candidate 3 (and final) is out</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 11, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">All our latest fixes are in it, and this is likely the final release. You can get it here. Please take it for a spin, we plan to do RTM release next week, and RC3 is supported to run in production.</p>
        </article>
        <div class="button flex justify-between">
            <a href="310.html"><span class="back arrow"></span></a>

            <a href="312.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
