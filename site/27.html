
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 27 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-261">
            <a href="https://ayende.com/blog/201602-A/caching-documents-in-ravendb-the-good-the-bad-and-the-ugly" target="_blank">
                <h2 class="title mb-6" id="article-261">Caching documents in RavenDB: The good, the bad and the ugly</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 19, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB has a hidden feature, enabled by default and not something that you usually need to be aware of. It has built-in support for caching. Consider the following code:async Task&lt;Dictionary&lt;string, int&gt;&gt; HowMuchWorkToDo(string userId)&#xD;&#xA;{&#xD;&#xA;    using var session = _documentStore.OpenAsyncSession();&#xD;&#xA;    var results = await session.Query&lt;Item&gt;()&#xD;&#xA;        .GroupBy(x =&gt;new { x.Status, x.AssignedTo })&#xD;&#xA;        .Where(g =&gt; g.Key.AssignedTo == userId &amp;&amp; g.Key.Status != &quot;Closed&quot;)&#xD;&#xA;        .Select(g =&gt; new &#xD;&#xA;        {&#xD;&#xA;            Status = g.Key.Status,&#xD;&#xA;            Count = g.Count()&#xD;&#xA;        })&#xD;&#xA;        .ToListAsync();&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    return results.ToDictionary(x =&gt; x.Status, x =&gt; x.Count);&#xD;&#xA;}What happens if I call it twice with the same user? The first time, RavenDB will send the query to the server, where it will be evaluated and executed. The server will also send an ETag&#xA0;header with the response. The client will remember the response and its ETag in its own memory.The next&#xA0;time this is called on the same user, the client will again send a request to the server. This time, however, it will also inform the server that it has a previous response to this query, with the specified ETag. The server, when realizing the client has a cached response, will do a (very cheap) check to see if the cached response matches the current state of the server. If so, it can inform the client (using 304 Not Modified) that it can use its cache.In this way, we benefit twice:First, on the server side, we avoid the need to compute the actual query.Second, on the network side, we aren&#x2019;t sending a full response back, just a very small notification to use the cached version.You&#x2019;ll note, however, that there is still an issue. We have to go to the server to check. That means that we still pay the network costs. So far, this feature is completely transparent to the user. It works behind the scenes to optimize server query costs and network bandwidth costs.We have a full-blown article on caching in RavenDB if you care to know more details&#xA0;instead of just &#x201C;it makes things work faster for me&#x201D;.Aggressive Caching in RavenDBThe next stage is to involve the user. Enter the AggressiveCache()&#xA0;feature (see the full documentation&#xA0;here), which allows the user to specify an additional aspect. Now, when the client has the value in the cache, it will skip&#xA0;going to the server entirely and serve the request directly from the cache. What about cache invalidation? Instead of having the client check on each request if things have changed, we invert the process. The client asks the server to notify it when things change, and until it gets notice from the server, it can serve responses completely from the local cache.I really love this feature, that was the Good part, now let&#x2019;s talk about the other pieces:There are only two hard things in Computer Science: cache invalidation and naming things.-- Phil KarltonThe bad part of caching is that this introduces more complexity to the system. Consider a system with two clients that are using the same database. An update from one of them may show up at different times in each. Cache invalidation will not happen instantly, and it is possible to get into situations where the server fails to notify the client about the update, meaning that we didn&#x2019;t clear the cache.We have a good set of solutions around all of those, I think. But it is important to understand that the problem space itself is a problem. In particular, let&#x2019;s talk about dealing with the following query:var emps = session.Query&lt;Employee&gt;()&#xD;&#xA;    .Include(x =&gt; x.Department)&#xD;&#xA;    .Where(x =&gt; x.Location.City == &quot;London&quot;)&#xD;&#xA;    .ToListAsync();When an employee is changed on the server, it will send a notice to the client, which can evict the item from the cache, right? But what about when a department&#xA0;is changed? For that matter, what happens if a new&#xA0;employee is added to London? How do we detect that we need to refresh this query?There are&#xA0;solutions to those problems, but they are super&#xA0;complicated and have various failure modes that often require more computing power than actually running the query. For that reason, RavenDB uses a much simpler model. If the server notifies us about any&#xA0;change, we&#x2019;ll mark the entire&#xA0;cache as suspect. The next request will have to go to the server (again with an ETag, etc) to verify that the response hasn&#x2019;t changed. Note that if the specific query&#xA0;results haven&#x2019;t changed, we&#x2019;ll get OK (304 Not Modified) from the server, and the client will use the cached response.Conservatively aggressive approachIn other words, even when using aggressive caching, RavenDB still has to go to the server sometimes. What is the impact of this approach when you have a system under load?We&#x2019;ll still use aggressive caching, but you&#x2019;ll see brief periods where we aren&#x2019;t checking with the server (usually be able to cache for about a second or so), followed by queries to the server to check for any changes.In most cases, this is what you want. We still benefit from the cache while reducing the number of remote calls by about 50%, and we don&#x2019;t have to worry about missing updates. The downside is that, as application developers, we know&#xA0;that this particular document and query are independent, so we want to cache them until we get notice about that&#xA0;particular document being changed.The default aggressive caching in RavenDB will not be of major help here, I&#x2019;m afraid. But there are a few things you can do.You can use Aggressive Caching in the NoTracking mode. In that mode, the client will not ask the server for notifications on changes, and will cache the responses in memory until they expire (clock expiration or size expiration only).There is also a feature suggestion that calls for updating the aggressive cache in a background manner, I would love to hear more feedback on this proposal. Another option is to take this feature higher than RavenDB directly, but still use its capabilities. Since we have a scenario where we know that we want to cache a specific set of documents and refresh the cache only&#xA0;when those documents are updated, let&#x2019;s write it.Here is the code:public class RecordCache&lt;T&gt;&#xD;&#xA;{&#xD;&#xA;    private ConcurrentLru&lt;string, T&gt; _items = &#xD;&#xA;        new(256, StringComparer.OrdinalIgnoreCase);&#xD;&#xA;    private readonly IDocumentStore _documentStore;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    public RecordCache(IDocumentStore documentStore)&#xD;&#xA;    {&#xD;&#xA;        const BindingFlags Flags = BindingFlags.Instance | &#xD;&#xA;            BindingFlags.NonPublic | BindingFlags.Public;&#xD;&#xA;        var violation = typeof(T).GetFields(Flags)&#xD;&#xA;            .FirstOrDefault(f =&gt; f.IsInitOnly is false);&#xD;&#xA;        if (violation != null)&#xD;&#xA;        {&#xD;&#xA;            throw new InvalidOperationException(&#xD;&#xA;                &quot;You should cache *only* immutable records, but got: &quot; &#x2B; &#xD;&#xA;                typeof(T).FullName &#x2B; &quot; with &quot; &#x2B; violation.Name &#x2B; &#xD;&#xA;                &quot; which is not read only!&quot;);&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        var changes = documentStore.Changes();&#xD;&#xA;        changes.ConnectionStatusChanged &#x2B;= (_, args) =&gt;&#xD;&#xA;        {&#xD;&#xA;            _items = new(256, StringComparer.OrdinalIgnoreCase);&#xD;&#xA;        };&#xD;&#xA;        changes.ForDocumentsInCollection&lt;T&gt;()&#xD;&#xA;            .Subscribe(e =&gt;&#xD;&#xA;            {&#xD;&#xA;                _items.TryRemove(e.Id, out _);&#xD;&#xA;            })&#xD;&#xA;            ;&#xD;&#xA;        _documentStore = documentStore;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    public ValueTask&lt;T&gt; Get(string id)&#xD;&#xA;    {&#xD;&#xA;        if (_items.TryGetValue(id, out var result))&#xD;&#xA;        {&#xD;&#xA;            return ValueTask.FromResult(result);&#xD;&#xA;        }&#xD;&#xA;        return new ValueTask&lt;T&gt;(GetFromServer(id));&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    private async Task&lt;T&gt; GetFromServer(string id)&#xD;&#xA;    {&#xD;&#xA;        using var session = _documentStore.OpenAsyncSession();&#xD;&#xA;        var item = await session.LoadAsync&lt;T&gt;(id);&#xD;&#xA;        _items.Set(id, item);&#xD;&#xA;        return item;&#xD;&#xA;    }&#xD;&#xA;}There are a few things to note about this code. We are holding live instances, so we ensure that the values we keep are immutable records. Otherwise, we may hand the same instance to two threads which can be&#x2026; fun. Note that document IDs in RavenDB are case insensitive, so we pass the right string comparer.Finally, &#xA0;the magic happens in the constructor. We register for two important events. Whenever the connection status of the Changes()&#xA0;connection is modified, we clear the cache. This handles any lost updates scenarios that occurred while we were disconnected.In practice, the subscription to events on that particular collection is where we ensure that after the server notification, we can evict the document from the cache so that the next request will load a fresh version.Caching &#x2B; Distributed Systems = &#x1F92F;&#x1F92F;&#x1F92F;I&#x2019;m afraid this isn&#x2019;t an easy topic once you dive into the specifics and constraints we operate under. As I mentioned, I would love your feedback on the background cache refresh feature,&#xA0;or maybe you have better insight into other ways to address the topic.</p>
        </article>
        <article id="article-262">
            <a href="https://www.meziantou.net/disabling-all-leds-on-a-raspberry-pi.htm" target="_blank">
                <h2 class="title mb-6" id="article-262">Turn off all LEDs on a Raspberry Pi</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 19, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Raspberry Pi&#x27;s are very useful, but I find the LEDs very annoying. In this post, I describe how to disable all LEDs on a Rasberry PI.NoteTested on Raspberry Pi 4B and Raspberry Pi 3B&#x2B;Connect to the Raspberry Pi with SSHOpen the file /boot/config.txt as admin using sudo nano /boot/config.txtAdd the</p>
        </article>
        <article id="article-263">
            <a href="https://ayende.com/blog/201601-A/optimizing-old-code-streambitarray-refactoring" target="_blank">
                <h2 class="title mb-6" id="article-263">Optimizing old code: StreamBitArray refactoring</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 16, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB is a pretty old codebase, hitting 15&#x2B; years in production recently. In order to keep it alive &amp; well, we make sure to follow the rule of always leaving the code in a better shape than we found it. Today&#x2019;s tale is about the StreamBitArray&#xA0;class, deep in the guts of Voron, RavenDB&#x2019;s storage engine. The class itself isn&#x2019;t really that interesting, it is just an implementation of a Bit Array that we have for a bitmap. We wrote it (based on Mono&#x2019;s code, it looks like) very early in the history of RavenDB and have never really touched it since.The last time anyone touched it was 5 years ago (fixing the namespace), 7 years ago we created an issue from a TODO comment, etc. Most of the code dates back to 2013, actually. And even then it was moved from a different branch, so we lost the really old history. To be clear, that class did a full tour of duty. For over a decade, it has served us very well. We never found a reason to change it, never got a trace of it in the profiler, etc. As we chip away at various hurdles inside RavenDB, I ran into this class and really looked at it with modern sensibilities. I think that this makes a great test case for code refactoring from the old style to our modern one.Here is what the class looks like:Already, we can see several things that really bug me. That class is only used in one context, to manage the free pages bitmap for Voron. That means we create it whenever Voron frees a page. That can happen a lot, as you might imagine. A single bitmap here covers 2048 pages, so when we create an instance of this class we also allocate an array with 64 ints. In other words, we need to allocate 312 bytes for each page we free. That isn&#x2019;t fun, and it actually gets worse. Here is a typical example of using this class:using (freeSpaceTree.Read(section, out Slice result))&#xD;&#xA;{&#xD;&#xA;    sba = !result.HasValue ? &#xD;&#xA;              new StreamBitArray() : &#xD;&#xA;              new StreamBitArray(result.CreateReader());&#xD;&#xA;}&#xD;&#xA;sba.Set((int)(pageNumber % NumberOfPagesInSection), true);&#xD;&#xA;using (sba.ToSlice(tx.Allocator, out Slice val))&#xD;&#xA;    freeSpaceTree.Add(section, val);And inside the ToSlice()&#xA0;call, we have:public ByteStringContext.InternalScope ToSlice(ByteStringContext context,&#xD;&#xA;ByteStringType type, out Slice str)&#xD;&#xA;{&#xD;&#xA;    var buffer = ToBuffer();&#xD;&#xA;    var scope = context.From(buffer, 0, buffer.Length, &#xD;&#xA;type, out ByteString byteString);&#xD;&#xA;    str = new Slice(byteString);&#xD;&#xA;    return scope;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;private unsafe byte[] ToBuffer()&#xD;&#xA;{&#xD;&#xA;    var tmpBuffer = new byte[(_inner.Length &#x2B; 1)*sizeof (int)];&#xD;&#xA;    unsafe&#xD;&#xA;    {&#xD;&#xA;        fixed (int* src = _inner)&#xD;&#xA;        fixed (byte* dest = tmpBuffer)&#xD;&#xA;        {&#xD;&#xA;            *(int*) dest = SetCount;&#xD;&#xA;            Memory.Copy(dest &#x2B; sizeof (int), (byte*) src, &#xD;&#xA;                                             tmpBuffer.Length - 1);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;    return tmpBuffer;&#xD;&#xA;}In other words, ToSlice()&#xA0;calls ToBuffer(), which allocates an array of bytes (288 bytes are allocated here), copies the data from the inner buffer to a new one (using fixed&#xA0;on the two arrays, which is a performance issue all in itself) and then calls a method to do the actual copy. Then in ToSlice()&#xA0;itself we allocate it again&#xA0;in native memory, which we then write to Voron, and then discard the whole thing. In short, somehow it turns out that freeing a page in Voron costs us ~1KB of memory allocations. That sucks, I have to say. And the only reasoning I have for this code is that it is old. Here is the constructor for this class as well:public StreamBitArray(ValueReader reader)&#xD;&#xA;{&#xD;&#xA;    SetCount = reader.ReadLittleEndianInt32();&#xD;&#xA;    unsafe&#xD;&#xA;    {&#xD;&#xA;        fixed (int* i = _inner)&#xD;&#xA;        {&#xD;&#xA;            int read = reader.Read((byte*)i, _inner.Length * sizeof(int));&#xD;&#xA;            if (read &lt; _inner.Length * sizeof(int))&#xD;&#xA;                throw new EndOfStreamException();&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}This accepts a reader to a piece of memory and does a bunch&#xA0;of things. It calls a few methods, uses fixed on the array, etc., all to get the data from the reader to the class. That is horribly inefficient. Let&#x2019;s write it from scratch and see what we can do. The first thing to notice is that this is a very short-lived class, it is only used inside methods and never held for long. This usage pattern tells me that it is a good candidate to be made into a struct, and as long as we do that, we might as well fix the allocation of the array as well. Note that I have a hard constraint, I cannot change the structure of the data on disk for backward compatibility reasons. So only in-memory changes are allowed. Here is my first attempt at refactoring the code:public unsafe struct StreamBitArray&#xD;&#xA;{&#xD;&#xA;    private fixed uint _inner[64];&#xD;&#xA;    public int SetCount;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;     public StreamBitArray()&#xD;&#xA;     {&#xD;&#xA;         SetCount = 0;&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[0]);&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[8]);&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[16]);&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[24]);&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[32]);&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[40]);&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[48]);&#xD;&#xA;         Vector256&lt;uint&gt;.Zero.StoreUnsafe(ref _inner[56]);&#xD;&#xA;     }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;     public StreamBitArray(byte* ptr)&#xD;&#xA;     {&#xD;&#xA;         var ints = (uint*)ptr;&#xD;&#xA;         SetCount = (int)*ints;&#xD;&#xA;         var a = Vector256.LoadUnsafe(ref ints[1]);&#xD;&#xA;         var b = Vector256.LoadUnsafe(ref ints[9]);&#xD;&#xA;         var c = Vector256.LoadUnsafe(ref ints[17]);&#xD;&#xA;         var d = Vector256.LoadUnsafe(ref ints[25]);&#xD;&#xA;         var e = Vector256.LoadUnsafe(ref ints[33]);&#xD;&#xA;         var f = Vector256.LoadUnsafe(ref ints[41]);&#xD;&#xA;         var g = Vector256.LoadUnsafe(ref ints[49]);&#xD;&#xA;         var h = Vector256.LoadUnsafe(ref ints[57]);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;         a.StoreUnsafe(ref _inner[0]);&#xD;&#xA;         b.StoreUnsafe(ref _inner[8]);&#xD;&#xA;         c.StoreUnsafe(ref _inner[16]);&#xD;&#xA;         d.StoreUnsafe(ref _inner[24]);&#xD;&#xA;         e.StoreUnsafe(ref _inner[32]);&#xD;&#xA;         f.StoreUnsafe(ref _inner[40]);&#xD;&#xA;         g.StoreUnsafe(ref _inner[48]);&#xD;&#xA;         h.StoreUnsafe(ref _inner[56]);&#xD;&#xA;     }&#xD;&#xA;}That looks like a lot of code, but let&#x2019;s see what changes I brought to bear here. Using a struct instead of a class saves us an allocation.Using a fixed array means that we don&#x2019;t have a separate allocation for the buffer.Using [SkipLocalsInit]&#xA0;means that we ask the JIT not&#xA0;to zero the struct. We do that directly in the default constructor.We are loading the data from the ptr&#xA0;in the second constructor directly.The fact that this is a struct and using a fixed array means that we can create a new instance of this without any allocations, we just need 260 bytes of stack space (the 288 we previously allocated also included object headers).Let&#x2019;s look at the actual machine code that these two constructors generate. Looking at the default constructor, we have:StreamBitArray..ctor()&#xD;&#xA;    L0000: push ebp&#xD;&#xA;    L0001: mov ebp, esp&#xD;&#xA;    L0003: vzeroupper&#xD;&#xA;    L0006: xor eax, eax&#xD;&#xA;    L0008: mov [ecx&#x2B;0x100], eax&#xD;&#xA;    L000e: vxorps ymm0, ymm0, ymm0&#xD;&#xA;    L0012: vmovups [ecx], ymm0&#xD;&#xA;    L0016: vmovups [ecx&#x2B;0x20], ymm0&#xD;&#xA;    L001b: vmovups [ecx&#x2B;0x40], ymm0&#xD;&#xA;    L0020: vmovups [ecx&#x2B;0x60], ymm0&#xD;&#xA;    L0025: vmovups [ecx&#x2B;0x80], ymm0&#xD;&#xA;    L002d: vmovups [ecx&#x2B;0xa0], ymm0&#xD;&#xA;    L0035: vmovups [ecx&#x2B;0xc0], ymm0&#xD;&#xA;    L003d: vmovups [ecx&#x2B;0xe0], ymm0&#xD;&#xA;    L0045: vzeroupper&#xD;&#xA;    L0048: pop ebp&#xD;&#xA;    L0049: retThere is the function prolog and epilog, but the code of this method uses 4 256-bit instructions to zero the buffer. If we were to let the JIT handle this, it would use 128-bit instructions and a loop to do it. In this case, our way is better, because we know more than the JIT.As for the constructor accepting an external pointer, here is what this translates into:StreamBitArray..ctor(Byte*)&#xD;&#xA;    L0000: push ebp&#xD;&#xA;    L0001: mov ebp, esp&#xD;&#xA;    L0003: vzeroupper&#xD;&#xA;    L0006: mov eax, [edx]&#xD;&#xA;    L0008: mov [ecx&#x2B;0x100], eax&#xD;&#xA;    L000e: vmovups ymm0, [edx&#x2B;4]&#xD;&#xA;    L0013: vmovups ymm1, [edx&#x2B;0x24]&#xD;&#xA;    L0018: vmovups ymm2, [edx&#x2B;0x44]&#xD;&#xA;    L001d: vmovups ymm3, [edx&#x2B;0x64]&#xD;&#xA;    L0022: vmovups ymm4, [edx&#x2B;0x84]&#xD;&#xA;    L002a: vmovups ymm5, [edx&#x2B;0xa4]&#xD;&#xA;    L0032: vmovups ymm6, [edx&#x2B;0xc4]&#xD;&#xA;    L003a: vmovups ymm7, [edx&#x2B;0xe4]&#xD;&#xA;    L0042: vmovups [ecx], ymm0&#xD;&#xA;    L0046: vmovups [ecx&#x2B;0x20], ymm1&#xD;&#xA;    L004b: vmovups [ecx&#x2B;0x40], ymm2&#xD;&#xA;    L0050: vmovups [ecx&#x2B;0x60], ymm3&#xD;&#xA;    L0055: vmovups [ecx&#x2B;0x80], ymm4&#xD;&#xA;    L005d: vmovups [ecx&#x2B;0xa0], ymm5&#xD;&#xA;    L0065: vmovups [ecx&#x2B;0xc0], ymm6&#xD;&#xA;    L006d: vmovups [ecx&#x2B;0xe0], ymm7&#xD;&#xA;    L0075: vzeroupper&#xD;&#xA;    L0078: pop ebp&#xD;&#xA;    L0079: retThis code is exciting&#xA0;to me because we are also allowing instruction-level parallelism. We effectively allow the CPU to execute all the operations of reading and writing in parallel. Next on the chopping block is this method:public int FirstSetBit()&#xD;&#xA;{&#xD;&#xA;    for (int i = 0; i &lt; _inner.Length; i&#x2B;&#x2B;)&#xD;&#xA;    {&#xD;&#xA;        if (_inner[i] == 0)&#xD;&#xA;            continue;&#xD;&#xA;        return i &lt;&lt; 5 | HighestBitSet(_inner[i]);&#xD;&#xA;    }&#xD;&#xA;    return -1;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;private static int HighestBitSet(int v)&#xD;&#xA;{&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    v |= v &gt;&gt; 1; // first round down to one less than a power of 2 &#xD;&#xA;    v |= v &gt;&gt; 2;&#xD;&#xA;    v |= v &gt;&gt; 4;&#xD;&#xA;    v |= v &gt;&gt; 8;&#xD;&#xA;    v |= v &gt;&gt; 16;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    return MultiplyDeBruijnBitPosition[(uint)(v * 0x07C4ACDDU) &gt;&gt; 27];&#xD;&#xA;}We are using vector instructions to scan 8 ints at a time, trying to find the first one that is set. Then we find the right int and locate the first set bit there. Here is what the assembly looks like:StreamBitArray.FirstSetBit()&#xD;&#xA;    L0000: push ebp&#xD;&#xA;    L0001: mov ebp, esp&#xD;&#xA;    L0003: vzeroupper&#xD;&#xA;    L0006: xor edx, edx&#xD;&#xA;    L0008: cmp [ecx], cl&#xD;&#xA;    L000a: vmovups ymm0, [ecx&#x2B;edx*4]&#xD;&#xA;    L000f: vxorps ymm1, ymm1, ymm1&#xD;&#xA;    L0013: vpcmpud k1, ymm0, ymm1, 6&#xD;&#xA;    L001a: vpmovm2d ymm0, k1&#xD;&#xA;    L0020: vptest ymm0, ymm0&#xD;&#xA;    L0025: jne short L0039&#xD;&#xA;    L0027: add edx, 8&#xD;&#xA;    L002a: cmp edx, 0x40&#xD;&#xA;    L002d: jl short L000a&#xD;&#xA;    L002f: mov eax, 0xffffffff&#xD;&#xA;    L0034: vzeroupper&#xD;&#xA;    L0037: pop ebp&#xD;&#xA;    L0038: ret&#xD;&#xA;    L0039: vmovmskps eax, ymm0&#xD;&#xA;    L003d: tzcnt eax, eax&#xD;&#xA;    L0041: add eax, edx&#xD;&#xA;    L0043: xor edx, edx&#xD;&#xA;    L0045: tzcnt edx, [ecx&#x2B;eax*4]&#xD;&#xA;    L004a: shl eax, 5&#xD;&#xA;    L004d: add eax, edx&#xD;&#xA;    L004f: vzeroupper&#xD;&#xA;    L0052: pop ebp&#xD;&#xA;    L0053: retIn short, the code is simpler, shorter, and more explicit about what it is doing. The machine code that is running there is much&#xA0;tighter. And I don&#x2019;t have allocations galore. This particular optimization isn&#x2019;t about showing better numbers in a specific scenario that I can point to. I don&#x2019;t think we ever delete enough pages to actually see this in a profiler output in such an obvious way. The goal is to reduce allocations and give the GC less work to do, which has a global impact on the performance of the system.</p>
        </article>
        <article id="article-264">
            <a href="https://devblogs.microsoft.com/dotnet/dotnet-9-preview-7/" target="_blank">
                <h2 class="title mb-6" id="article-264">.NET 9 Preview 7 is now available!</h2>
            </a>
            <p class="mb-2">by .NET Team</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 15, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Try out the latest features in .NET 9 Preview 7 across the .NET runtime, SDK, libraries, ASP.NET Core, Blazor, C#, .NET MAUI, and more!</p>
        </article>
        <article id="article-265">
            <a href="https://devblogs.microsoft.com/dotnet/dotnet-conf-2024-celebrating-the-release-of-dotnet-9-save-the-date/" target="_blank">
                <h2 class="title mb-6" id="article-265">.NET Conf 2024 &#x2013; Celebrating the Release of .NET 9! &#x2013; Save the Date!</h2>
            </a>
            <p class="mb-2">by Mehul Harry</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 14, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Announcing .NET Conf 2024 - a free, three-day virtual developer event that celebrates the release of .NET 9.</p>
        </article>
        <article id="article-266">
            <a href="https://devblogs.microsoft.com/dotnet/azure-ai-model-catalog-dotnet-inference-sdk/" target="_blank">
                <h2 class="title mb-6" id="article-266">Introducing the Azure AI Inference SDK: Access More AI Models with the Azure AI Model Catalog</h2>
            </a>
            <p class="mb-2">by Luis Quintanilla</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 13, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Announcing the Azure AI Inference SDK for .NET! This SDK provides easy access to a comprehensive suite of AI models in the Azure AI Model Catalog for inference tasks like chat, enabling you to effortlessly incorporate AI into your applications that align with your requirements.</p>
        </article>
        <article id="article-267">
            <a href="https://devblogs.microsoft.com/dotnet/dotnet-and-dotnet-framework-august-2024-updates/" target="_blank">
                <h2 class="title mb-6" id="article-267">.NET and .NET Framework August 2024 updates</h2>
            </a>
            <p class="mb-2">by Tara,Rahul</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 13, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A recap of the updates for .NET and .NET Framework for August 2024.</p>
        </article>
        <article id="article-268">
            <a href="https://andrewlock.net/combining-multiple-docker-images-into-a-multi-arch-image/" target="_blank">
                <h2 class="title mb-6" id="article-268">Combining multiple docker images into a multi-arch image</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 13, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show two ways to combine multiple docker images into a single multi-arch image, discuss manifests and manifest lists, and why they matter&#x2026;</p>
        </article>
        <article id="article-269">
            <a href="https://www.meziantou.net/useful-resources-to-write-roslyn-analyzers.htm" target="_blank">
                <h2 class="title mb-6" id="article-269">Useful resources to write Roslyn Analyzers</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 12, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This post is part of the series &#x27;Roslyn Analyzers&#x27;. Be sure to check out the rest of the blog posts of the series!Writing a Roslyn analyzerWriting language-agnostic Roslyn Analyzers using IOperationWorking with types in a Roslyn analyzerReferencing an analyzer from a projectPackaging a Roslyn Analy</p>
        </article>
        <article id="article-270">
            <a href="https://ayende.com/blog/201569-A/improving-ravendbs-node-js-bulk-insert-performance" target="_blank">
                <h2 class="title mb-6" id="article-270">Improving RavenDB&#x27;s Node.js bulk insert performance</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 08, 2024
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">During a performance evaluation internally, we ran into a strange situation. Our bulk insert performance using the node.js API was significantly&#xA0;worse than the performance of other clients. In particular, when we compared that to the C# version, we saw that the numbers were significantly&#xA0;worse than expected.To be fair, this comparison is made between our C# client, which has been through the wringer&#xA0;in terms of optimization and attention to performance, and the Node.js client. The focus of the Node.js client was on correctness and usability. It isn&#x2019;t fair to expect the same performance from Node.js and C#, after all. However, that difference in performance was annoying enough to make us take a deeper look into what was going on.Here is the relevant code:const store = new DocumentStore(&#x27;http://localhost:8080&#x27;, &#x27;bulk&#x27;);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;store.initialize();&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;const bulk = store.bulkInsert();&#xD;&#xA;for (let i = 0; i &lt; 100_000_000; i&#x2B;&#x2B;) {&#xD;&#xA;    await bulk.store(new User(&#x27;user&#x27; &#x2B; i));&#xD;&#xA;}&#xD;&#xA;await bulk.finish();As you can see, the Node.js numbers are respectable. Running at a rate of over 85,000 writes per second is nothing to sneeze at.But I also ran the exact same test with the C# client, and I got annoyed. The C# client was able to hit close to 100,000 more&#xA0;writes per second than the Node.js client. And in both cases, the actual limit was on the client side, not on the server side. For fun, I ran a few clients and hit 250,000 writes/second without really doing much. The last time we properly tested ingest performance for RavenDB we achieved 150,000 writes/second. So it certainly looks like we are performing significantly better.Going back to the Node.js version, I wanted to know what exactly was the problem that we had there. Why are we so much slower than the C# version? It&#x2019;s possible that this is just the limits of the node.js platform, but you gotta check to know. Node.js has an --inspect flag that you can use, and Chrome has a built-in profiler (chrome://inspect) that can plug into that. Using the DevTools, you can get a performance profile of a Node.js process.I did just that and go the following numbers:That is&#x2026; curious. Really&#xA0;curious, isn&#x2019;t it?Basically, none of my code appears here at&#xA0;all, most of the time is spent dealing with the async machinery. If you look at the code above, you can see that we are issuing an await&#xA0;for each document stored. &#xA0;The idea with bulk insert is that under the covers, we split the writing to an in-memory buffer and the flushing of the buffer to the network. In the vast majority of cases, we&#x2019;ll not&#xA0;do any async operations in the store()&#xA0;call. If the buffer is full, we&#x2019;ll need to flush it to the network, and that may force us to do an actual await&#xA0;operation. In Node.js, awaiting an async function that doesn&#x2019;t actually perform any async operation appears to be super&#xA0;expensive.We threw around a bunch of ideas on how to resolve this issue. The problem is that Node.js has no equivalent to C#&#x2019;s ValueTask.&#xA0;We also have a lot of existing code out there in the field that we must remain compatible with.Our solution to this dilemma was to add another function that you can call, like so:for (let i = 0; i &lt; 100_000_000; i&#x2B;&#x2B;) {&#xD;&#xA;    const user = new User(&#x27;user&#x27; &#x2B; i);&#xD;&#xA;    const id = &quot;users/&quot; &#x2B; i;&#xD;&#xA;    if (bulk.tryStoreSync(user, id) == false) {&#xD;&#xA;        await bulk.store(user, id);&#xD;&#xA;    }&#xD;&#xA;}The idea is that if you call tryStoreSync()&#xA0;we&#x2019;ll try to do everything in memory, but it may not be possible (e.g. if we need to flush the buffer). In that case, you&#x2019;ll need to call the async function store()&#xA0;explicitly. Given that the usual reason for using the dedicated API for bulk insert is performance, this looks like a reasonable thing to ask. Especially when you can see the actual performance results. We are talking about over 55%(!!!)&#xA0;improvement in the performance of bulk insert.It gets even better. That was just the mechanical fix to avoid generating a promise per operation. While we are addressing this performance issue, there are a few other low-hanging fruits that could improve the bulk insert performance in Node.js. For example, it turns out that we pay a hefty cost to generate the metadata for all those documents (runtime reflection cost, mostly). We can generate it once&#xA0;and be done with it, like so:const bulk = store.bulkInsert();&#xD;&#xA;const metadata = {&#xD;&#xA;    &quot;@collection&quot;: &quot;Users&quot;,&#xD;&#xA;    &quot;Raven-Node-Type&quot;: &quot;User&quot;&#xD;&#xA;};&#xD;&#xA;for (let i = 0; i &lt; 100_000_000; i&#x2B;&#x2B;) {&#xD;&#xA;    const user = new User(&#x27;user&#x27; &#x2B; i);&#xD;&#xA;    const id = &quot;users/&quot; &#x2B; i;&#xD;&#xA;    if (bulk.tryStoreSync(user, id, metadata) == false) {&#xD;&#xA;        await bulk.store(user, id, metadata);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;await bulk.finish();And this code in particular gives us:That is basically near enough to the C#&#x2019;s speed that I don&#x2019;t think we need&#xA0;to pay more attention to performance. Overall, that was time very well spent in making things go fast.</p>
        </article>
        <div class="button flex justify-between">
            <a href="26.html"><span class="back arrow"></span></a>

            <a href="28.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>