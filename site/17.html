
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 17 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-161">
            <a href="https://ayende.com/blog/201987-A/what-happens-when-a-sparse-file-allocation-fails" target="_blank">
                <h2 class="title mb-6" id="article-161">What happens when a sparse file allocation fails?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 29, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Today I set out to figure out an answer to a very specific question. What happens at the OS level when you try to allocate disk space for a sparse file and there is no additional disk space?Sparse files are a fairly advanced feature of file systems. They allow you to define a file whose size is 10GB, but that only takes 2GB of actual disk space. The rest is sparse (takes no disk space and on read will return just zeroes). The OS will automatically allocate additional disk space for you if you write to the sparse ranges.This leads to an interesting question, what happens when you write to a sparse file if there is no additional disk space?Let&#x2019;s look at the problem on Linux first. We define a RAM disk with 32MB, like so:sudo mkdir -p /mnt/ramdisk&#xD;&#xA;sudo mount -t tmpfs -o size=32M tmpfs /mnt/ramdiskAnd then we write the following code, which does the following (on a disk with just 32MB):Create a file - write 32 MB to itPunch a hole of 8 MB in the file (range is 12MB - 20MB)Create another file - write 4 MB to it (there is now only 4MB available)Open the original file and try to write to the range with the hole in it (requiring additional disk space allocation)#define _GNU_SOURCE&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;#include &lt;stdio.h&gt;&#xD;&#xA;#include &lt;stdlib.h&gt;&#xD;&#xA;#include &lt;unistd.h&gt;&#xD;&#xA;#include &lt;fcntl.h&gt;&#xD;&#xA;#include &lt;linux/falloc.h&gt;&#xD;&#xA;#include &lt;errno.h&gt;&#xD;&#xA;#include &lt;string.h&gt;&#xD;&#xA;#include &lt;sys/random.h&gt;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;#define MB (1024 * 1024)&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;void write_all(int fd, const void *buf, size_t count)&#xD;&#xA;{&#xD;&#xA;    size_t bytes_written = 0;&#xD;&#xA;    const char *ptr = (const char *)buf;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    while (bytes_written &lt; count)&#xD;&#xA;    {&#xD;&#xA;        ssize_t result = write(fd, ptr &#x2B; bytes_written, count - bytes_written);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        if (result &lt; 0)&#xD;&#xA;        {&#xD;&#xA;            if (errno == EINTR)&#xD;&#xA;                continue;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;            fprintf(stderr, &quot;Write error: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;            exit(EXIT_FAILURE);&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        if (result == 0)&#xD;&#xA;        {&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;            fprintf(stderr, &quot;Zero len write is bad: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;            exit(EXIT_FAILURE);&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        bytes_written &#x2B;= result;&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;int main()&#xD;&#xA;{&#xD;&#xA;    int fd;&#xD;&#xA;    char buffer[MB];&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    unlink(&quot;/mnt/ramdisk/fullfile&quot;);&#xD;&#xA;    unlink(&quot;/mnt/ramdisk/anotherfile&quot;);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    getrandom(buffer, MB, 0);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    ssize_t bytes_written;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    fd = open(&quot;/mnt/ramdisk/fullfile&quot;, O_RDWR | O_CREAT | O_TRUNC, 0644);&#xD;&#xA;    if (fd == -1)&#xD;&#xA;    {&#xD;&#xA;        fprintf(stderr, &quot;open full file: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;        exit(EXIT_FAILURE);&#xD;&#xA;    }&#xD;&#xA;    for (int i = 0; i &lt; 32; i&#x2B;&#x2B;)&#xD;&#xA;    {&#xD;&#xA;        write_all(fd, buffer, MB);&#xD;&#xA;    }&#xD;&#xA;    close(fd);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    fd = open(&quot;/mnt/ramdisk/fullfile&quot;, O_RDWR);&#xD;&#xA;    if (fd == -1)&#xD;&#xA;    {&#xD;&#xA;        fprintf(stderr, &quot;reopen full file: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;        exit(EXIT_FAILURE);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (fallocate(fd, FALLOC_FL_PUNCH_HOLE | FALLOC_FL_KEEP_SIZE, 12 * MB, 8 * MB) == -1)&#xD;&#xA;    {&#xD;&#xA;        fprintf(stderr, &quot;fallocate failure: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;        exit(EXIT_FAILURE);&#xD;&#xA;    }&#xD;&#xA;    close(fd);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    fd = open(&quot;/mnt/ramdisk/anotherfile&quot;, O_RDWR | O_CREAT | O_TRUNC, 0644);&#xD;&#xA;    if (fd == -1)&#xD;&#xA;    {&#xD;&#xA;        fprintf(stderr, &quot;open another file: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;        exit(EXIT_FAILURE);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    for (int i = 0; i &lt; 4; i&#x2B;&#x2B;)&#xD;&#xA;    {&#xD;&#xA;        write_all(fd, buffer, MB);&#xD;&#xA;    }&#xD;&#xA;    close(fd);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    // Write 8 MB to the hole in the first file&#xD;&#xA;    fd = open(&quot;/mnt/ramdisk/fullfile&quot;, O_RDWR);&#xD;&#xA;    if (fd == -1)&#xD;&#xA;    {&#xD;&#xA;        fprintf(stderr, &quot;reopen full file 2: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;        exit(EXIT_FAILURE);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    // Seek to the start of the hole&#xD;&#xA;    if (lseek(fd, 12 * MB, SEEK_SET) == -1)&#xD;&#xA;    {&#xD;&#xA;        fprintf(stderr, &quot;seek full file: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;        exit(EXIT_FAILURE);&#xD;&#xA;    }&#xD;&#xA;    for (int i = 0; i &lt; 8; i&#x2B;&#x2B;)&#xD;&#xA;    {&#xD;&#xA;        write_all(fd, buffer, MB);&#xD;&#xA;    }&#xD;&#xA;    close(fd);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    printf(&quot;Operations completed successfully.\n&quot;);&#xD;&#xA;    return 0;&#xD;&#xA;}As expected, this code will fail on the 5th write (since there is no disk space to&#xA0;allocate in the disk). The error would be:Write error: errno = 28 (No space left on device)Here is what the file system reports:$ du -h /mnt/ramdisk/*&#xD;&#xA;4.0M    /mnt/ramdisk/anotherfile&#xD;&#xA;28M     /mnt/ramdisk/fullfile&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;$ ll -h /mnt/ramdisk/&#xD;&#xA;total 33M&#xD;&#xA;drwxrwxrwt 2 root   root     80 Jan  9 10:43 ./&#xD;&#xA;drwxr-xr-x 6 root   root   4.0K Jan  9 10:30 ../&#xD;&#xA;-rw-r--r-- 1 ayende ayende 4.0M Jan  9 10:43 anotherfile&#xD;&#xA;-rw-r--r-- 1 ayende ayende  32M Jan  9 10:43 fullfileAs you can see, we have a total of 32 MB of actual size reported, but ll is reporting that we actually have files bigger than that (because we have hole punching).What would happen if we were to run this using memory-mapped I/O? Here is the code:fd = open(&quot;/mnt/ramdisk/fullfile&quot;, O_RDWR);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;char *mapped_memory = mmap(NULL, 32 * MB, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);&#xD;&#xA;if (mapped_memory == MAP_FAILED)&#xD;&#xA;{&#xD;&#xA;    fprintf(stderr, &quot;fail mmap: errno = %d (%s)\n&quot;, errno, strerror(errno));&#xD;&#xA;    exit(EXIT_FAILURE);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;for (size_t i = (12 * MB); i &lt; (20 * MB); i&#x2B;&#x2B;)&#xD;&#xA;{&#xD;&#xA;    mapped_memory[i] = 1;&#xD;&#xA;}&#xD;&#xA;munmap(mapped_memory, 32 * MB);&#xD;&#xA;close(fd);This will lead to an interesting scenario. We need to allocate disk space for the memory, and we&#x2019;ll do so (note that we are writing into the hole), and this code will fail&#xA0;with a segmentation fault.It will fail in the loop, by the way, as part of the page fault to bring the memory in, the file system needs to allocate the disk space. If there is no such disk space, it will fail. The only way for the OS to behave in this case is to fail the write, which leads to a segmentation fault.I also tried that on Windows. I defined a virtual disk like so:$ diskpart&#xD;&#xA;create vdisk file=&quot;D:\ramdisk.vhd&quot; maximum=32&#xD;&#xA;select vdisk file=D:\ramdisk.vhd&quot;&#xD;&#xA;attach vdisk&#xD;&#xA;create partition primary&#xD;&#xA;format fs=NTFS quick label=RAMDISK&#xD;&#xA;assign letter=R&#xD;&#xA;exitThis creates a 32MB disk and assigns it the letter R. Note that we are using NTFS, which has its own metadata, we have roughly 21MB or so of usable disk space to play with here.Here is the Windows code that simulates the same behavior as the Linux code above:#include &lt;stdio.h&gt;&#xD;&#xA;#include &lt;windows.h&gt;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;#define MB (1024 * 1024)&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;int main() {&#xD;&#xA;    HANDLE hFile, hFile2;&#xD;&#xA;    DWORD bytesWritten;&#xD;&#xA;    LARGE_INTEGER fileSize, moveAmount;&#xD;&#xA;    char* buffer = malloc(MB);&#xD;&#xA;    &#xD;&#xA;    int i;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        DeleteFileA(&quot;R:\\original_file.bin&quot;);&#xD;&#xA;        DeleteFileA(&quot;R:\\another_file.bin&quot;);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    hFile = CreateFileA(&quot;R:/original_file.bin&quot;, GENERIC_READ | GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);&#xD;&#xA;    if (hFile == INVALID_HANDLE_VALUE) {&#xD;&#xA;        printf(&quot;Error creating file: %d\n&quot;, GetLastError());&#xD;&#xA;        exit(__LINE__);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    for (int i = 0; i &lt; 20; i&#x2B;&#x2B;) {&#xD;&#xA;        if (!WriteFile(hFile, buffer, MB, &amp;bytesWritten, NULL)) {&#xD;&#xA;            fprintf(stderr, &quot;WriteFile failed on iteration %d: %x\n&quot;, i, GetLastError());&#xD;&#xA;            exit(__LINE__);&#xD;&#xA;        }&#xD;&#xA;        if (bytesWritten != MB) {&#xD;&#xA;            fprintf(stderr, &quot;Failed to write full buffer on iteration %d\n&quot;, i);&#xD;&#xA;            exit(__LINE__);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    FILE_ZERO_DATA_INFORMATION zeroDataInfo;&#xD;&#xA;    zeroDataInfo.FileOffset.QuadPart = 6 * MB; &#xD;&#xA;    zeroDataInfo.BeyondFinalZero.QuadPart = 18 * MB; &#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (!DeviceIoControl(hFile, FSCTL_SET_SPARSE, NULL, 0, NULL, 0, NULL, NULL) || &#xD;&#xA;        !DeviceIoControl(hFile, FSCTL_SET_ZERO_DATA, &amp;zeroDataInfo, sizeof(zeroDataInfo), NULL, 0, NULL, NULL)) {&#xD;&#xA;                printf(&quot;Error setting zero data: %d\n&quot;, GetLastError());&#xD;&#xA;        exit(__LINE__);&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    // Create another file of size 4 MB&#xD;&#xA;    hFile2 = CreateFileA(&quot;R:/another_file.bin&quot;, GENERIC_READ | GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL);&#xD;&#xA;    if (hFile2 == INVALID_HANDLE_VALUE) {&#xD;&#xA;        printf(&quot;Error creating second file: %d\n&quot;, GetLastError());&#xD;&#xA;        exit(__LINE__);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    for (int i = 0; i &lt; 4; i&#x2B;&#x2B;) {&#xD;&#xA;        if (!WriteFile(hFile2, buffer, MB, &amp;bytesWritten, NULL)) {&#xD;&#xA;            fprintf(stderr, &quot;WriteFile 2 failed on iteration %d: %x\n&quot;, i, GetLastError());&#xD;&#xA;            exit(__LINE__);&#xD;&#xA;        }&#xD;&#xA;        if (bytesWritten != MB) {&#xD;&#xA;            fprintf(stderr, &quot;Failed to write full buffer 2 on iteration %d\n&quot;, i);&#xD;&#xA;            exit(__LINE__);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        moveAmount.QuadPart = 12 * MB;&#xD;&#xA;    SetFilePointerEx(hFile, moveAmount, NULL, FILE_BEGIN);&#xD;&#xA;    for (i = 0; i &lt; 8; i&#x2B;&#x2B;) {&#xD;&#xA;        if (!WriteFile(hFile, buffer, MB, &amp;bytesWritten, NULL)) {&#xD;&#xA;            printf(&quot;Error writing to file: %d\n&quot;, GetLastError());&#xD;&#xA;            exit(__LINE__);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    return 0;&#xD;&#xA;}And that gives us the exact same behavior as in Linux. One of these writes will fail because there is no more disk space for it. What about when we use memory-mapped I/O?HANDLE hMapFile = CreateFileMapping(hFile, NULL, PAGE_READWRITE, 0, 0, NULL);&#xD;&#xA;if (hMapFile == NULL) {&#xD;&#xA;    fprintf(stderr, &quot;Could not create file mapping object: %x\n&quot;, GetLastError());&#xD;&#xA;    exit(__LINE__);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;char* lpMapAddress = MapViewOfFile(hMapFile, FILE_MAP_WRITE, 0, 0, 0);&#xD;&#xA;if (lpMapAddress == NULL) {&#xD;&#xA;    fprintf(stderr, &quot;Could not map view of file: %x\n&quot;, GetLastError());&#xD;&#xA;    exit(__LINE__);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;for (i = 0; i &lt; 20 * MB; i&#x2B;&#x2B;) {&#xD;&#xA;    ((char*)lpMapAddress)[i]&#x2B;&#x2B;;&#xD;&#xA;}That results in the expected access violation: I didn&#x2019;t bother checking Mac or BSD, but I&#x2019;m assuming that they behave in the same manner. I can&#x2019;t conceive of anything else that they could&#xA0;reasonably do.You can find my full source here.</p>
        </article>
        <article id="article-162">
            <a href="https://andrewlock.net/supporting-multiple-sdk-versions-in-analyzers-and-source-generators/" target="_blank">
                <h2 class="title mb-6" id="article-162">Supporting multiple .NET SDK versions in analyzers and source generators</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 28, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I describe why source generators might need to work with multiple versions of the .NET SDK and how NuGet packages support this in .NET 6&#x2026;</p>
        </article>
        <article id="article-163">
            <a href="https://ayende.com/blog/201960-A/configuration-values-escape-hatches" target="_blank">
                <h2 class="title mb-6" id="article-163">Configuration values &amp; Escape hatches</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 27, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB is meant to be a self-managing database, one that is able to take care of itself without constant hand-holding from the database administrator. That has been one of our core tenets from the get-go. Today I checked the current state of the codebase and we have roughly 500 configuration options that are available to control various aspects of RavenDB&#x2019;s behavior. These two statements are seemingly contradictory, because if we have so many configuration options, how can we even try&#xA0;to be self-managing? And how can a database administrator expect to juggle all of those options? Database configuration is a really&#xA0;finicky topic. For example, RocksDB&#x2019;s authors flat-out admit that out loud:Even we as RocksDB developers don&#x27;t fully understand the effect of each configuration change. If you want to fully optimize RocksDB for your workload, we recommend experiments and benchmarking.And indeed, efforts were made to tune RocksDB using deep-learning models&#xA0;because it is that&#xA0;complex.RavenDB doesn&#x2019;t take that approach, tuning is something that should work out of the box, managed directly by RavenDB itself. Much of that is achieved by not&#xA0;doing things and carefully arranging that the environment will balance itself out in an optimal fashion. But I&#x2019;ll talk about the Zen of RavenDB another time.Today, I want to talk about why we have so many configuration options, the vast majority of which you, as a user, should neither use, care about, nor even know of. The idea is very simple, deploying a database engine is a Big Deal, and as such, something that users are quite reluctant to do. When we hit a problem and a support call is raised, we need to provide some&#xA0;mechanism for the user to fix&#xA0;things until we can ensure that this behavior is accounted for in the default manner of RavenDB.I treat the configuration options more as escape hatches that allow me to muddle through stuff than explicit options that an administrator is expected to monitor and manage. Some of those configuration options control whether RavenDB will utilize vectored instructions or the compression algorithm to use over the wire. If you need to touch them, it is amazing that they exist. If you have to deal with them on a regular basis, we need to go back to the drawing board.</p>
        </article>
        <article id="article-164">
            <a href="https://www.meziantou.net/roslyn-annotations-for-code-fix.htm" target="_blank">
                <h2 class="title mb-6" id="article-164">Roslyn Annotations for Code Fix</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 27, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Roslyn Analyzer can be used to detect patterns in your code and report them. It can also provide code fixes to automatically fix the issues. In this case the code fix takes the existing SyntaxTree and return the new SyntaxTree with the issue fixed. Roslyn does provide the concept of Annotation to m</p>
        </article>
        <article id="article-165">
            <a href="https://ayende.com/blog/201958-A/partial-writes-io-uring-and-safety" target="_blank">
                <h2 class="title mb-6" id="article-165">Partial writes, IO_Uring and safety</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 24, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my previous post, I discussed how Linux will silently truncate a big write (&gt; 2 GB) for you. That is expected by the interface of write(). The problem is that this behavior also applies when you use IO_Uring. Take a look at the following code:struct io_uring_sqe *sqe = io_uring_get_sqe(&amp;ring);&#xD;&#xA;if (!sqe) {&#xD;&#xA;    return 1;&#xD;&#xA;}&#xD;&#xA;io_uring_prep_write(sqe, fd, buffer, BUFFER_SIZE, 0);&#xD;&#xA;io_uring_submit(&amp;ring);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;struct io_uring_cqe *cqe;&#xD;&#xA;ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);&#xD;&#xA;if (ret &lt; 0) {&#xD;&#xA;    return 2;&#xD;&#xA;}If BUFFER_SIZE is 3 GB, then this will write about 2 GB to the file. The number of bytes written is&#xA0;correctly reported, but the complexity this generates is huge. Consider the following function:int32_t rvn_write_io_ring(&#xD;&#xA;    void *handle,&#xD;&#xA;    int32_t count,&#xD;&#xA;    struct page_to_write *buffers,&#xD;&#xA;    int32_t *detailed_error_code);There is a set of buffers that I want to write, and the natural&#xA0;way to do that is:int32_t rvn_write_io_ring(&#xD;&#xA;    void *handle,&#xD;&#xA;    int32_t count,&#xD;&#xA;    struct page_to_write *buffers,&#xD;&#xA;    int32_t *detailed_error_code)&#xD;&#xA;{&#xD;&#xA;    struct handle *handle_ptr = handle;&#xD;&#xA;    for (size_t i = 0; i &lt; count; i&#x2B;&#x2B;)&#xD;&#xA;    {&#xD;&#xA;        struct io_uring_sqe *sqe = io_uring_get_sqe(&#xD;&#xA;            &amp;handle_ptr-&gt;global_state-&gt;ring);&#xD;&#xA;        io_uring_prep_write(sqe,&#xD;&#xA;            handle_ptr-&gt;file_fd, &#xD;&#xA;            buffers[i].ptr, &#xD;&#xA;            buffers[i].count_of_pages * VORON_PAGE_SIZE, &#xD;&#xA;            buffers[i].page_num * VORON_PAGE_SIZE&#xD;&#xA;        );&#xD;&#xA;    }&#xD;&#xA;    return _submit_and_wait(&amp;handle_ptr-&gt;global_state-&gt;ring,&#xD;&#xA;                            count, detailed_error_code);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;int32_t _submit_and_wait(&#xD;&#xA;    struct io_uring* ring,&#xD;&#xA;    int32_t count,&#xD;&#xA;    int32_t* detailed_error_code)&#xD;&#xA;{&#xD;&#xA;    int32_t rc = io_uring_submit_and_wait(ring, count);&#xD;&#xA;    if(rc &lt; 0)&#xD;&#xA;    {&#xD;&#xA;        *detailed_error_code = -rc;&#xD;&#xA;        return FAIL_IO_RING_SUBMIT;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    struct io_uring_cqe* cqe;&#xD;&#xA;    for(int i = 0; i &lt; count; i&#x2B;&#x2B;)&#xD;&#xA;    {&#xD;&#xA;        rc = io_uring_wait_cqe(ring, &amp;cqe);&#xD;&#xA;        if (rc &lt; 0)&#xD;&#xA;        {&#xD;&#xA;            *detailed_error_code = -rc;&#xD;&#xA;            return FAIL_IO_RING_NO_RESULT;&#xD;&#xA;        }&#xD;&#xA;        if(cqe-&gt;res &lt; 0)&#xD;&#xA;        {&#xD;&#xA;            *detailed_error_code = -cqe-&gt;res;&#xD;&#xA;            return FAIL_IO_RING_WRITE_RESULT;&#xD;&#xA;        }&#xD;&#xA;        io_uring_cqe_seen(ring, cqe);&#xD;&#xA;    }&#xD;&#xA;    return SUCCESS;&#xD;&#xA;}In other words, send all the data to the IO Ring, then wait for all those operations to complete. We verify complete success and can then move on. However, because we may have a write that is greater than 2 GB, and because the interface allows the IO Uring to write&#xA0;less than we thought it would, we need to handle that with retries.After thinking about this for a while, I came up with the following implementation:int32_t _submit_writes_to_ring(&#xD;&#xA;    struct handle *handle,&#xD;&#xA;    int32_t count,&#xD;&#xA;    struct page_to_write *buffers,&#xD;&#xA;    int32_t* detailed_error_code)&#xD;&#xA;{&#xD;&#xA;    struct io_uring *ring = &amp;handle-&gt;global_state-&gt;ring;&#xD;&#xA;    off_t *offsets = handle-&gt;global_state-&gt;offsets;&#xD;&#xA;    memset(offsets, 0, count * sizeof(off_t));   &#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    while(true)&#xD;&#xA;    {&#xD;&#xA;        int32_t submitted = 0;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        for (size_t i = 0; i &lt; count; i&#x2B;&#x2B;)&#xD;&#xA;        {&#xD;&#xA;            off_t offset =  offsets[i];&#xD;&#xA;            if(offset == buffers[i].count_of_pages * VORON_PAGE_SIZE)&#xD;&#xA;                continue;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;            struct io_uring_sqe *sqe = io_uring_get_sqe(ring);&#xD;&#xA;            if (sqe == NULL) // the ring is full, flush it...&#xD;&#xA;                break;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;            io_uring_sqe_set_data(sqe, i);&#xD;&#xA;            io_uring_prep_write(sqe, handle-&gt;file_fd, &#xD;&#xA;                buffers[i].ptr &#x2B; offset,&#xD;&#xA;                buffers[i].count_of_pages * VORON_PAGE_SIZE - offset,&#xD;&#xA;                buffers[i].page_num * VORON_PAGE_SIZE &#x2B; offset);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;            submitted&#x2B;&#x2B;;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        if(submitted == 0)&#xD;&#xA;            return SUCCESS;&#xD;&#xA;        &#xD;&#xA;        int32_t rc = io_uring_submit_and_wait(ring, submitted);&#xD;&#xA;        if(rc &lt; 0)&#xD;&#xA;        {&#xD;&#xA;            *detailed_error_code = -rc;&#xD;&#xA;            return FAIL_IO_RING_SUBMIT;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        struct io_uring_cqe *cqe;&#xD;&#xA;        uint32_t head = 0;&#xD;&#xA;        uint32_t i = 0;&#xD;&#xA;        bool has_errors = false;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        io_uring_for_each_cqe(ring, head, cqe) {&#xD;&#xA;            i&#x2B;&#x2B;;&#xD;&#xA;            uint64_t index = io_uring_cqe_get_data64(cqe);&#xD;&#xA;            int result = cqe-&gt;res;&#xD;&#xA;            if(result &lt; 0)&#xD;&#xA;            {&#xD;&#xA;                has_errors = true;&#xD;&#xA;                *detailed_error_code = -result;&#xD;&#xA;            }&#xD;&#xA;            else&#xD;&#xA;            {&#xD;&#xA;                offsets[index] &#x2B;= result;&#xD;&#xA;                if(result == 0)&#xD;&#xA;                {&#xD;&#xA;                    // there shouldn&#x27;t be a scenario where we return 0 &#xD;&#xA;                    // for a write operation, we may want to retry here&#xD;&#xA;                    // but figuring out if this is a single happening, of if &#xD;&#xA;                    // we need to retry this operation (_have_ retried it?) is &#xD;&#xA;                    // complex enough to treat this as an error for now.&#xD;&#xA;                    has_errors = true;&#xD;&#xA;                    *detailed_error_code = EIO;   &#xD;&#xA;                }&#xD;&#xA;            }&#xD;&#xA;        }&#xD;&#xA;        io_uring_cq_advance(ring, i);&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        if(has_errors)&#xD;&#xA;            return FAIL_IO_RING_WRITE_RESULT;&#xD;&#xA;    }&#xD;&#xA;}That is a lot of code, but it is mostly because of how C works. What we do here is scan through the buffers we need to write, as well as scan through an array of offsets that store additional information for the operation.If the offset to write doesn&#x2019;t indicate that we&#x2019;ve written the whole thing, we&#x2019;ll submit it to the ring and keep going until we either fill the entire ring or run out of buffers to work with. The next step is to submit the work and wait for it to complete, then run through the results, check for errors, and update the offset that we wrote for the relevant buffer.Then, we scan the buffers array again to find either partial writes that we have to complete (we didn&#x2019;t write the whole buffer) or buffers that we didn&#x2019;t write at all because we filled the ring. In either case, we submit the new batch of work to the ring and repeat until we run out of work. This code assumes that we cannot have a non-error state where we write 0 bytes to the file and treats that as an error. We also assume that an error in writing to the disk is fatal, and the higher-level code will discard the entire IO_Uring if that happens. The Windows version, by the way, is somewhat simpler. Windows explicitly limits the size of the buffer you can pass to the write()&#xA0;call (and its IO Ring equivalent). It also ensures that it will write the whole&#xA0;thing, so partial writes are not an issue there. It is interesting to note that the code above will effectively stripe writes if you send very large buffers. Let&#x2019;s assume that we send it two 4 GB buffers, like so:OffsetSizeBuffer 11 GB 4 GBBuffer 210 GB6 GBThe patterns of writes that will actually be executed are:1GB .. 3 GB, 10 GB .. 12 GB3 GB .. 5 GB, 12 GB .. 14 GB14 GB .. 16 GBI can &#x201C;fix&#x201D; that by never issuing writes that are larger than 2 GB and issuing separate writes for each 2 GB range, but that leads to other complexities (e.g., tracking state if I split a write and hit the full ring status, etc.). At those sizes, it doesn&#x2019;t actually matter in terms of efficiency or performance. Partial writes are almost always a sign of either very large writes that were broken up or some underlying issue that is already problematic, so I don&#x2019;t care that much about that scenario in general. For the vast majority of cases, this will always issue exactly one write for each buffer.What is really interesting from my point of view, however, is how even a pretty self-contained feature can get pretty complex internally. On the other hand, this behavior allows me to push a whole bunch&#xA0;of work directly to the OS and have it send all of that to the disk as fast as possible.In our scenarios, under load, we may call that with thousands to tens of thousands of pages (each 8 KB in size) spread all over the file. The buffers are actually sorted, so ideally, the kernel will be able to take advantage of that, but even if not, just reducing the number of syscalls will result in performance savings.</p>
        </article>
        <article id="article-166">
            <a href="https://ayende.com/blog/201957-A/answer-what-does-this-code-do" target="_blank">
                <h2 class="title mb-6" id="article-166">Answer</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 22, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I previously asked&#xA0;what the code below does, and mentioned that it should give interesting insight into the kind of mindset and knowledge a candidate has. Take a look at the code again:#include &lt;stdio.h&gt;&#xD;&#xA;#include &lt;stdlib.h&gt;&#xD;&#xA;#include &lt;unistd.h&gt;&#xD;&#xA;#include &lt;fcntl.h&gt;&#xD;&#xA;#include &lt;errno.h&gt;&#xD;&#xA;#include &lt;sys/stat.h&gt;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;#define BUFFER_SIZE (3ULL * 1024 * 1024 * 1024) // 3GB in bytes&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;int main() {&#xD;&#xA;    int fd;&#xD;&#xA;    char *buffer;&#xD;&#xA;    struct stat st;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    buffer = (char *)malloc(BUFFER_SIZE);&#xD;&#xA;    if (buffer == NULL) {&#xD;&#xA;        return 1;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    fd = open(&quot;large_file.bin&quot;, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR | S_IWUSR);&#xD;&#xA;    if (fd == -1) {&#xD;&#xA;        return 2;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (write(fd, buffer, BUFFER_SIZE) == -1) {&#xD;&#xA;        return 3;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (fsync(fd) == -1) {&#xD;&#xA;        return 4;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (close(fd) == -1) {&#xD;&#xA;        return 5;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (stat(&quot;large_file.bin&quot;, &amp;st) == -1) {&#xD;&#xA;        return 6;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    printf(&quot;File size: %.2f GB\n&quot;, (double)st.st_size / (1024 * 1024 * 1024));&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    free(buffer);&#xD;&#xA;    return 0;&#xD;&#xA;}This program will output: File size: 2.00 GBAnd it will write 2 GB of zeros to the file:~$ head  large_file.bin  | hexdump -C&#xD;&#xA;00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|&#xD;&#xA;*&#xD;&#xA;7ffff000The question is why? And the answer is quite simple. Linux has a limitation of about 2 GB for writes to the disk. Any write call that attempts to write more than that will only write that much, and you&#x2019;ll have to call the system again. This is not&#xA0;an error, mind. The write&#xA0;call is free to write less than&#xA0;the size of the buffer you passed to it.Windows has the same limit, but it is honest about itIn Windows, all write calls accept a 32-bit int as the size of the buffer, so this limitation is clearly communicated in the API. Windows will also ensure that for files, a WriteFile call that completes successfully writes the entire&#xA0;buffer to the disk.And why am I writing 2 GB of zeros? In the code above, I&#x2019;m using malloc(), not calloc(), so I wouldn&#x2019;t expect the values to be zero. Because this is a large allocation, malloc()&#xA0;calls the OS to provide us with the buffer directly, and the OS is contractually obligated to provide us with zeroed pages.</p>
        </article>
        <article id="article-167">
            <a href="https://devblogs.microsoft.com/dotnet/introducing-winforms-analyzers/" target="_blank">
                <h2 class="title mb-6" id="article-167">WinForms: Analyze This (Me in Visual Basic)</h2>
            </a>
            <p class="mb-2">by Klaus Loeffelmann</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 21, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Your WinForms code might have issues&#x2014;maybe an Async call picked the wrong overload, or it&#x2019;s leaking data into resource files. Time to call in a code-shrink! So, WinForms, Analyze This!</p>
        </article>
        <article id="article-168">
            <a href="https://andrewlock.net/creating-a-source-generator-part-13-providing-and-accessing-msbuild-settings-in-source-generators/" target="_blank">
                <h2 class="title mb-6" id="article-168">Accessing MSBuild properties and user configuration from source generators</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 21, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Creating a source generator - Part 13</p>
        </article>
        <article id="article-169">
            <a href="https://ayende.com/blog/201956-A/challenge-what-does-this-code-do" target="_blank">
                <h2 class="title mb-6" id="article-169">Challenge</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 20, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Here is a pretty simple C program, running on Linux. Can you tell me what you expect its output to be?#include &lt;stdio.h&gt;&#xD;&#xA;#include &lt;stdlib.h&gt;&#xD;&#xA;#include &lt;unistd.h&gt;&#xD;&#xA;#include &lt;fcntl.h&gt;&#xD;&#xA;#include &lt;errno.h&gt;&#xD;&#xA;#include &lt;sys/stat.h&gt;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;#define BUFFER_SIZE (3ULL * 1024 * 1024 * 1024) // 3GB in bytes&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;int main() {&#xD;&#xA;    int fd;&#xD;&#xA;    char *buffer;&#xD;&#xA;    struct stat st;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    buffer = (char *)malloc(BUFFER_SIZE);&#xD;&#xA;    if (buffer == NULL) {&#xD;&#xA;        return 1;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    fd = open(&quot;large_file.bin&quot;, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR | S_IWUSR);&#xD;&#xA;    if (fd == -1) {&#xD;&#xA;        return 2;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (write(fd, buffer, BUFFER_SIZE) == -1) {&#xD;&#xA;        return 3;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (fsync(fd) == -1) {&#xD;&#xA;        return 4;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (close(fd) == -1) {&#xD;&#xA;        return 5;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    if (stat(&quot;large_file.bin&quot;, &amp;st) == -1) {&#xD;&#xA;        return 6;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    printf(&quot;File size: %.2f GB\n&quot;, (double)st.st_size / (1024 * 1024 * 1024));&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    free(buffer);&#xD;&#xA;    return 0;&#xD;&#xA;}And what happens when I run:head  large_file.bin  | hexdump -CThis shows both surprising behavior and serves as a good opening for discussion on a whole bunch&#xA0;of issues. In an interview setting, that can give us a lot of insight into the sort of knowledge a candidate has.</p>
        </article>
        <article id="article-170">
            <a href="https://www.meziantou.net/using-roslyn-to-analyze-and-rewrite-code-in-a-solution.htm" target="_blank">
                <h2 class="title mb-6" id="article-170">Using Roslyn to analyze and rewrite code in a solution</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 20, 2025
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x27;ve written a lot about Roslyn in the context of Roslyn Analyzers and Source Generators. You can also use Roslyn as a library to analyze and generate code. For instance, you can create a console application that loads a solution, find patterns, and rewrite code. While Roslyn Analyzers are tied to</p>
        </article>
        <div class="button flex justify-between">
            <a href="16.html"><span class="back arrow"></span></a>

            <a href="18.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>