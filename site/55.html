
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 55 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-541">
            <a href="https://ayende.com/blog/200193-B/ravendb-version-6-0-is-now-live" target="_blank">
                <h2 class="title mb-6" id="article-541">RavenDB version 6.0 is now live</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 02, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Today marks a very long journey for RavenDB as we release version 6.0 into the wild. This completes a multi-year effort on our part, which I&#x2019;m really excited to share with you.&#xA;In version 6.0 the RavenDB team had a number of goals, with the primary one being, as always, providing a simple and powerful platform for your data and documents.&#xA;The full list of changes in the release is here and you can already download the binaries of the new release to try it out.&#xA;Below you&#x2019;ll find more information about some of the highlights for the new release, but the executive summary for the technically inclined is:&#xA;&#xA;Deep integration with Kafka &amp; RabbitMQ - allowing to send and consume messages directly from RavenDB.&#xA;Sharding support allows you to run massively large databases easily and cheaply.&#xA;Corax is a new indexing engine for RavenDB that can provide a 10x performance improvement for both indexing and queries.&#xA;&#xA;With this new release we are also announcing a pricing update for our commercial customers. You can find more details at the bottom of this post.&#xA;&#xA;Before we get to the gist of the changes, I want to spend a minute talking about this release. One of the reasons that we took so long to craft this release was an uncompromising eye toward ease of use, performance, and quality of experience.&#xA;&#xA;&#xA;It may sound strange to talk about &#x201C;quality of experience&#x201D; when discussing a database engine, we aren&#x2019;t talking about a weekend trip or a romantic getaway, after all. The reason RavenDB exists is that we found other databases to be complicated and delicate beasts, and we wanted to create a database that would be a joy to work with. Something that you could throw your data and queries to and would just work.&#xA;&#xA;&#xA;With version 6.0, I&#x2019;m happy to say that we managed to keep on doing just that while providing you with a host of new features and capabilities. Without further ado, allow me to tell you about the highlights of this release.&#xA;&#xA;&#xA0;&#xA;&#xA;Sharding&#xA;Sharding is the process of splitting your data among multiple nodes, to allow you to scale beyond the terabyte range. RavenDB actually had this feature, as far back as 2010, when the 1.0 version came out. I&#x2019;m speaking about this today because we have decided to revamp the entire approach to sharding in the new release. Sharding in RavenDB version 6.0 consists of selecting the sharded option on database creation time, and everything else is handled by the cluster. Splitting the data across the nodes, balancing load and giving you the feeling that you are working on a unified database is all our responsibility.&#xA;A chief goal of the new sharding feature in RavenDB was to make sure that you don&#x2019;t have to be aware that you are running in a sharded environment. In fact, you can even switch the backend to a sharded database behind your application&#x2019;s back, with no modifications to the application.&#xA;Your systems can take advantage of the sharding feature, but they aren&#x2019;t forced to. This makes it easier when you need to scale because you don&#x2019;t need an expensive rewrite or stop the world migration to move to the new architecture.&#xA;RavenDB, with or without sharding, offers you the same capabilities. Features such as indexing, map/reduce, ETL tasks, or subscriptions all work in the same way regardless of how you choose to store your data. A successful metric for us is that after you switch over to sharding, the only thing that you&#x2019;ll notice is that you can now scale your systems even more. And, of course, you could do that easily, safely, and quickly.&#xA;I recorded a webinar showcasing our new sharding approach that you can watch.&#xA;&#xA;Corax Indexing Engine&#xA;Corax indexing engine is now available in version 6.0. We have been working on that since 2014, and as you can imagine, it hasn&#x2019;t been a simple -to-solve challenge. Corax has a single task, to be able to do everything that we use Lucene for, but do that faster. In fact, to do things much faster.&#xA;RavenDB has used Lucene as its indexing engine from the start, and Lucene has been the industry benchmark for search engines for a long time. In the context of RavenDB, we have optimized Lucene heavily for the past 15 years. When building Corax, it wasn&#x2019;t sufficient to match what Lucene can do but to also significantly outperform it.&#xA;With version 6.0, we now offer both Corax and Lucene as indexing engines for RavenDB. You can choose to use either engine (globally or per index). Upgrading from an older version of RavenDB, you&#x2019;ll keep on using the Lucene engine but can create new indexes with Corax.&#xA;Corax outperforms Lucene on a wide range of scenarios by an order of magnitude. This includes both indexing time and query latency. Corax also manages to be far faster than Lucene while utilizing less CPU and memory. One of the ways it does that is by preparing, in advance, the relevant data structures that Lucene needs to compute at runtime.&#xA;Corax indexes tend to consume about 10% - 20% more disk space than Lucene, as a trade for offering lowered memory usage, far faster querying performance, and reduced indexing time.&#xA;In the same manner as sharding, switching to the new indexing engine will get you performance improvements, with no difference in capabilities or features.&#xA;&#xA;Kafka &amp; RabbitMQ Integration&#xA;Kafka &amp; RabbitMQ integration has been extended to version 6.0. RavenDB already supported writing to Kafka and RabbitMQ and we have now extended this capability to allow you to read messages from Kafka and RabbitMQ and turn them into documents.&#xA;This capability provides complete support for queuing infrastructure integration. RavenDB can work with existing pipelines and easily expose its data for the rest of the organization as well as consume messages from the queue and create or update documents accordingly.&#xA;Such documents are then available for querying, aggregation, etc. This makes it trivial to use a low-code solution to quickly and efficiently plug your system into Kafka and RabbitMQ. In the style of all RavenDB features, we take upon ourselves all the complexity inherent in such a solution. You only need to provide the connection string and the details about what you want to pull, and the full management of pulling or pushing data, handling distributed state, failover, and monitoring is the responsibility of the RavenDB cluster.&#xA;&#xA;Data Archiving&#xA;Data archiving is a new capability in RavenDB, aiming to help users who deal with very large amounts of data. While a business wants to retain all its data forever, it typically works primarily with recent data. That is typically the data from the last year or two. As time goes by, old data accumulates, and going through irrelevant data consumes computing and memory resources from the database.&#xA;RavenDB version 6.0 offers a way to mark a document with an attribute, marking when RavenDB should move that document to archive mode. Aside from telling RavenDB at what time we should archive a document, there is nothing further that you need to do.&#xA;When the time comes to archive the document, RavenDB will change the document mode, which will have a number of effects. The document itself is retained, it is not deleted. If you aren&#x2019;t already using document compression, the archived document is stored in a compressed manner, to reduce disk usage further.&#xA;Subscriptions and indexes will ignore archive documents and unless explicitly requested, archived documents will remain on the disk and consume no memory resources. Archiving reduces the resources consumed by archived documents while keeping them available if you need to look them up.&#xA;You can also construct indexing that would operate over archived and regular documents as well if you still want to allow queries over archived data. In this way, you can retain your entire dataset in the main system of record but still operate a significantly smaller chunk of that during normal operations.&#xA;Performance, observability, and usability enhancements have also been on the menu for the version 6.0 release. There are far too many individual features and improvements to count them all in this format. I encourage you to check the full release details on the website.&#xA;&#xA;You are probably well aware of the drastic changes that happened in the business environment in the last few years. As part of adjusting to this new reality, we are updating our pricing to allow us to keep delivering top-notch solutions and support to our valued customers.&#xA;The new pricing policy is effective starting from January 1st, 2024.&#xA;What does this mean to you right now? Absolutely nothing until January 1st, 2024. All subscription renewals in 2023 keep their current price point.&#xA;&#xA;An Early Birds benefit for our existing customers: renew your 2024 subscription while locking your 2023 price point. * Available for Cloud and on-premises Customers.&#xA;&#xA;In the weeks ahead, we&#x27;ll provide detailed updates about these changes and ensure a smooth transition. Our goal is to empower you to make optimized choices about your RavenDB subscription. Your satisfaction remains our priority.&#xA;Our team is ready to assist you. Please reach out to us at sales@ravendb.net for any questions you have.&#xA;Finally, I would like to thank the RavenDB team for their hard work in delivering this version.&#xA;Our goal for this release was to deliver you a lot more while making sure that you&#x2019;ll not be exposed to the underlying complexity of the problems that we are solving for you.&#xA;I believe that as you try out the new release, you&#x2019;ll see how successful we are in providing you with an excellent database platform to take your systems to new heights.&#xA;And with that, I am left only with encouraging you to try out the new version. And let us know what you think about it.</p>
        </article>
        <article id="article-542">
            <a href="https://www.meziantou.net/how-to-test-the-logs-from-ilogger-in-dotnet.htm" target="_blank">
                <h2 class="title mb-6" id="article-542">How to test the logs from ILogger in .NET</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 02, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">You sometimes need to validate that a log message is written to the log. In this post, I describe how to unit test ILogger in .NET Core.There are multiple strategies:You can use a mock framework like Moq to mock the ILogger interface and validate the right calls are made.You can store all logs in-m</p>
        </article>
        <article id="article-543">
            <a href="https://ardalis.com/introduction-to-masstransit-csharp-guide/" target="_blank">
                <h2 class="title mb-6" id="article-543">Introduction to MassTransit: A Guide to Streamlined Messaging in C#</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 28, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you&#x27;re interested in building distributed, scalable, and robust applications in C#, you may have heard of MassTransit. This open-source&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-544">
            <a href="https://www.meziantou.net/how-to-view-logs-from-ilogger-in-xunitdotnet.htm" target="_blank">
                <h2 class="title mb-6" id="article-544">How to write logs from ILogger to xUnit.net ITestOutputHelper</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 25, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When a test fails, it&#x27;s important to understand what happened. All information could be useful. If you are using ILogger in your application, you can use the logs to understand what happened. However, the logs are not displayed in the output of xUnit. You can change this behavior by using a custom</p>
        </article>
        <article id="article-545">
            <a href="https://ayende.com/blog/200161-C/challenge-spot-the-bug" target="_blank">
                <h2 class="title mb-6" id="article-545">Challenge</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 19, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The following bug cost me a bunch of time, can you see what I&#x2019;m doing wrong?&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private static int AddAndSort(Dictionary&lt;long, long&gt; freeListAdditions, Span&lt;long&gt; keys,  Span&lt;long&gt; vals)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              int index = 0;&#xA;        &#xA;        &#xA;          &#xA;              foreach (var (k, v) in freeListAdditions)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  keys[index] = k;&#xA;        &#xA;        &#xA;          &#xA;                  vals[index] = v;&#xA;        &#xA;        &#xA;          &#xA;                  index&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              keys.Sort(vals);&#xA;        &#xA;        &#xA;          &#xA;              return index;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          nasty.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;For fun, it&#x2019;s so nasty because usually, it will accidentally work.</p>
        </article>
        <article id="article-546">
            <a href="https://andrewlock.net/should-you-use-the-dotnet-8-identity-api-endpoints/" target="_blank">
                <h2 class="title mb-6" id="article-546">Should you use the .NET 8 Identity API endpoints?</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 19, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I discuss the new Identity API endpoints and talk about some of the security and architectural issues they may introduce.&#x2026;</p>
        </article>
        <article id="article-547">
            <a href="https://www.meziantou.net/accessing-private-members-without-reflection-in-csharp.htm" target="_blank">
                <h2 class="title mb-6" id="article-547">Accessing private members without reflection in C#</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 18, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Reflection allows you to access private members of a class. This is very useful when you want to access private members of a class that you don&#x27;t own. However, it is slow and doesn&#x27;t work well with Native AOT. In this post, I describe how to access private members without reflection in .NET 8.Let&#x27;s</p>
        </article>
        <article id="article-548">
            <a href="https://ayende.com/blog/200129-A/filtering-negative-numbers-fast-beating-memcpy" target="_blank">
                <h2 class="title mb-6" id="article-548">Filtering negative numbers, fast</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 15, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post, I was able to utilize AVX to get some nice speedups. In general, I was able to save up to 57%(!) of the runtime in processing arrays of 1M items. That is really amazing, if you think about it. But my best effort only gave me a 4% improvement when using 32M items.&#xA;I decided to investigate what is going on in more depth, and I came up with the following benchmark. Given that I want to filter negative numbers, what would happen if the only negative number in the array was the first one?&#xA;In other words, let&#x2019;s see what happens when we could write this algorithm as the following line of code:&#xA;&#xA;array[1..].CopyTo(array);&#xA;&#xA;The idea here is that we should measure the speed of raw memory copy and see how that compares to our code.&#xA;Before we dive into the results, I want to make a few things explicit. We are dealing here with arrays of long, when I&#x2019;m talking about an array with 1M items, I&#x2019;m actually talking about an 8MB buffer, and for the 32M items, we are talking about 256MB of memory.&#xA;I&#x2019;m running these benchmarks on the following machine:&#xA;&#xA;&#xA0;&#xA0;&#xA0; AMD Ryzen 9 5950X 16-Core Processor&#xA;&#xA0;&#xA0;&#xA0; Base speed:&#xA0;&#xA0;&#xA0; 3.40 GHz&#xA0;&#xA0;&#xA0;&#xA0; L1 cache:&#xA0;&#xA0;&#xA0; 1.0 MB&#xA0;&#xA0;&#xA0;&#xA0; L2 cache:&#xA0;&#xA0;&#xA0; 8.0 MB&#xA0;&#xA0;&#xA0;&#xA0; L3 cache:&#xA0;&#xA0;&#xA0; 64.0 MB&#xA;&#xA0;&#xA0;&#xA0; Utilization&#xA0;&#xA0;&#xA0; 9%&#xA0;&#xA0;&#xA0;&#xA0; Speed&#xA0;&#xA0;&#xA0; 4.59 GHz&#xA;&#xA;In other words, when we look at this, the 1M items (8MB) can fit into L2 (barely, but certainly backed by the L3 cache. For the 32M items (256MB), we are far beyond what can fit in the cache, so we are probably dealing with memory bandwidth issues.&#xA;I wrote the following functions to test it out:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          [Benchmark]&#xA;        &#xA;        &#xA;          &#xA;          public int CopyTo()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              items[0] = -items[0];&#xA;        &#xA;        &#xA;          &#xA;              Span&lt;long&gt; itemsSpan = items;&#xA;        &#xA;        &#xA;          &#xA;              itemsSpan[1..].CopyTo(itemsSpan);&#xA;        &#xA;        &#xA;          &#xA;              return items.Length - 1; ;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          [Benchmark]&#xA;        &#xA;        &#xA;          &#xA;          public unsafe int MemoryCopy()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              items[0] = -items[0];&#xA;        &#xA;        &#xA;          &#xA;              fixed(long * p = items)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  Buffer.MemoryCopy(p, p  &#x2B; 1, &#xA;        &#xA;        &#xA;          &#xA;                      items.Length * sizeof(long),&#xA;        &#xA;        &#xA;          &#xA;                      (items.Length - 1) * sizeof(long));&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              return items.Length - 1; ;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          [Benchmark]&#xA;        &#xA;        &#xA;          &#xA;          public unsafe int MoveMemory()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              items[0] = -items[0];&#xA;        &#xA;        &#xA;          &#xA;              fixed (long* p = items)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  MoveMemory(p &#x2B; 1, p,&#xA;        &#xA;        &#xA;          &#xA;                      items.Length * sizeof(long));&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              return items.Length - 1; ;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          [DllImport(&quot;Kernel32.dll&quot;, EntryPoint = &quot;RtlMoveMemory&quot;, SetLastError = false)]&#xA;        &#xA;        &#xA;          &#xA;          static unsafe extern void MoveMemory(void* dest, void* src, int size);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          CopyBench.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;Let&#x2019;s look at what I&#x2019;m actually testing here.&#xA;&#xA;CopyTo() &#x2013; using the span native copying is the most ergonomic way to do things, I think.&#xA;MemoryCopy() &#x2013; uses a built-in unsafe API in the framework. That eventually boils down to a heavily optimized routine, which&#x2026; calls to Memove() if the buffer overlaps (as they do in this case).&#xA;MoveMemory() &#x2013; uses a pinvoke to call to the Windows API to do the moving of memory for us.&#xA;&#xA;Here are the results for the 1M case (8MB):&#xA;&#xA;&#xA;&#xA;Method&#xA;N&#xA;Mean&#xA;Error&#xA;StdDev&#xA;Ratio&#xA;&#xA;&#xA;&#xA;&#xA;FilterCmp&#xA;1048599&#xA;441.4 us&#xA;1.78 us&#xA;1.58 us&#xA;1.00&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;1048599&#xA;141.1 us&#xA;2.70 us&#xA;2.65 us&#xA;0.32&#xA;&#xA;&#xA;CopyTo&#xA;1048599&#xA;872.8 us&#xA;11.27 us&#xA;10.54 us&#xA;1.98&#xA;&#xA;&#xA;MemoryCopy&#xA;1048599&#xA;869.7 us&#xA;7.29 us&#xA;6.46 us&#xA;1.97&#xA;&#xA;&#xA;MoveMemory&#xA;1048599&#xA;126.9 us&#xA;0.28 us&#xA;0.25 us&#xA;0.29&#xA;&#xA;&#xA;&#xA;We can see some real surprises here. I&#x2019;m using the FilterCmp (the very basic implementation) that I wrote.&#xA;I cannot explain why CopyTo() and MemoryMove() are so slow.&#xA;What is really impressive is that the FilterCmp_Avx() and MoveMemory() are so close in performance, and so much faster. To put it in another way, we are already at a stage where we are within shouting distance from the MoveMemory() performance. That is.. really impressive.&#xA;That said, what happens with 32M (256MB) ?&#xA;&#xA;&#xA;&#xA;Method&#xA;N&#xA;Mean&#xA;Error&#xA;StdDev&#xA;Ratio&#xA;&#xA;&#xA;&#xA;&#xA;FilterCmp&#xA;33554455&#xA;22,763.6 us&#xA;157.23 us&#xA;147.07 us&#xA;1.00&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;33554455&#xA;20,122.3 us&#xA;214.10 us&#xA;200.27 us&#xA;0.88&#xA;&#xA;&#xA;CopyTo&#xA;33554455&#xA;27,660.1 us&#xA;91.41 us&#xA;76.33 us&#xA;1.22&#xA;&#xA;&#xA;MemoryCopy&#xA;33554455&#xA;27,618.4 us&#xA;136.16 us&#xA;127.36 us&#xA;1.21&#xA;&#xA;&#xA;MoveMemory&#xA;33554455&#xA;20,152.0 us&#xA;166.66 us&#xA;155.89 us&#xA;0.89&#xA;&#xA;&#xA;&#xA;Now we are faster in the FilterCmp_Avx than MoveMemory. That is&#x2026; a pretty big wow, and a really nice close for this blog post series, right? Except that we won&#x2019;t be stopping here.&#xA;The way the task I set out works, we are actually filtering just the first item out, and then we are basically copying the memory. Let&#x2019;s do some math: 256MB in 20.1ms means 12.4 GB/sec!&#xA;On this system, I have the following memory setup:&#xA;&#xA;&#xA0;&#xA0;&#xA0; 64.0 GB&#xA;&#xA0;&#xA0;&#xA0; Speed:&#xA0;&#xA0;&#xA0; 2133 MHz&#xA0;&#xA0;&#xA0;&#xA0; Slots used:&#xA0;&#xA0;&#xA0; 4 of 4&#xA0;&#xA0;&#xA0;&#xA0; Form factor:&#xA0;&#xA0;&#xA0; DIMM&#xA0;&#xA0;&#xA0;&#xA0; Hardware reserved:&#xA0;&#xA0;&#xA0; 55.2 MB&#xA;&#xA;I&#x2019;m using DDR4 memory, so I can expect a maximum speed of 17GB/sec. In theory, I might be able to get more if the memory is located on different DIMMs, but for the size in question, that is not likely.&#xA;I&#x2019;m going to skip the training montage of VTune, understanding memory architecture and figuring out what is actually going on.&#xA;Let&#x2019;s drop everything and look at what we have with just AVX vs. MoveMemory:&#xA;&#xA;&#xA;&#xA;Method&#xA;N&#xA;Mean&#xA;Error&#xA;StdDev&#xA;Median&#xA;Ratio&#xA;&#xA;&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;1048599&#xA;141.6 us&#xA;2.28 us&#xA;2.02 us&#xA;141.8 us&#xA;1.12&#xA;&#xA;&#xA;MoveMemory&#xA;1048599&#xA;126.8 us&#xA;0.25 us&#xA;0.19 us&#xA;126.8 us&#xA;1.00&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;33554455&#xA;21,105.5 us&#xA;408.65 us&#xA;963.25 us&#xA;20,770.4 us&#xA;1.08&#xA;&#xA;&#xA;MoveMemory&#xA;33554455&#xA;20,142.5 us&#xA;245.08 us&#xA;204.66 us&#xA;20,108.2 us&#xA;1.00&#xA;&#xA;&#xA;&#xA;The new baseline is MoveMemory, and in this run, we can see that the AVX code is slightly slower.&#xA;It&#x2019;s sadly not uncommon to see numbers shift by those ranges when we are testing such micro-optimizations, mostly because we are subject to so many variables that can affect performance. In this case, I dropped all the other benchmarks, which may have changed things.&#xA;At any rate, using those numbers, we have 12.4GB/sec for MoveMemory() and 11.8GB/sec for the AVX version. The hardware maximum speed is 17GB/sec. So we are quite close to what can be done.&#xA;For that matter, I would like to point out that the trivial code completed the task in 11GB/sec, so that is quite respectable and shows that the issue here is literally getting the memory fast enough to the CPU.&#xA;Can we do something about that? I made a pretty small change to the AVX version, like so:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          &#x2B;if (i &#x2B; Vector256&lt;long&gt;.Count &lt;= len)&#xA;        &#xA;        &#xA;          &#xA;          &#x2B;{&#xA;        &#xA;        &#xA;          &#xA;          &#x2B;     var next = Vector256.LoadUnsafe(ref Unsafe.Add(ref output, i));&#xA;        &#xA;        &#xA;          &#xA;          &#x2B;     len -= Vector256&lt;long&gt;.Count;&#xA;        &#xA;        &#xA;          &#xA;                for (; i &#x2B; Vector256&lt;long&gt;.Count &lt;= len; i &#x2B;= Vector256&lt;long&gt;.Count)&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;          -         var v = Vector256.LoadUnsafe(ref Unsafe.Add(ref output, i));&#xA;        &#xA;        &#xA;          &#xA;          &#x2B;         var v = next;&#xA;        &#xA;        &#xA;          &#xA;          &#x2B;         next = Vector256.LoadUnsafe(ref Unsafe.Add(ref output, i &#x2B; Vector256&lt;long&gt;.Count));&#xA;        &#xA;        &#xA;          &#xA;          ...&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          Avx_Next.diff&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;What are we actually doing here? Instead of loading the value and immediately using it, we are loading the next value, then we are executing the loop and when we iterate again, we will start loading the next value and process the current one. The idea is to parallelize load and compute at the instruction level.&#xA;Sadly, that didn&#x2019;t seem to do the trick. I saw a 19% additional cost for that version compared to the vanilla AVX one on the 8MB run and a 2% additional cost on the 256MB run.&#xA;I then realized that there was one really important test that I had to also make, and wrote the following:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          [Benchmark()]&#xA;        &#xA;        &#xA;          &#xA;          public unsafe int MoveMemory()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              items[0] = -items[0];&#xA;        &#xA;        &#xA;          &#xA;              fixed (long* p = items)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  MoveMemory(p &#x2B; 1, p,&#xA;        &#xA;        &#xA;          &#xA;                      items.Length * sizeof(long));&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              return items.Length - 1; ;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          [DllImport(&quot;Kernel32.dll&quot;, EntryPoint = &quot;RtlMoveMemory&quot;, SetLastError = false)]&#xA;        &#xA;        &#xA;          &#xA;          static unsafe extern void MoveMemory(void* dest, void* src, int size);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          [Benchmark(Baseline = true)]&#xA;        &#xA;        &#xA;          &#xA;          public unsafe int FillMemory()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              items[0] = -items[0];&#xA;        &#xA;        &#xA;          &#xA;              fixed (long* p = items)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var b = (byte)Random.Shared.Next();&#xA;        &#xA;        &#xA;          &#xA;                  FillMemory(p,items.Length * sizeof(long), b);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              return items.Length - 1; ;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          [DllImport(&quot;Kernel32.dll&quot;, EntryPoint = &quot;RtlFillMemory&quot;, SetLastError = false)]&#xA;        &#xA;        &#xA;          &#xA;          static unsafe extern void FillMemory(void* dest, IntPtr size, byte fill);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          Final.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;In other words, let&#x27;s test the speed of moving memory and filling memory as fast as we possibly can. Here are the results:&#xA;&#xA;&#xA;&#xA;Method&#xA;N&#xA;Mean&#xA;Error&#xA;StdDev&#xA;Ratio&#xA;RatioSD&#xA;Code Size&#xA;&#xA;&#xA;&#xA;&#xA;MoveMemory&#xA;1048599&#xA;126.8 us&#xA;0.36 us&#xA;0.33 us&#xA;0.25&#xA;0.00&#xA;270 B&#xA;&#xA;&#xA;FillMemory&#xA;1048599&#xA;513.5 us&#xA;10.05 us&#xA;10.32 us&#xA;1.00&#xA;0.00&#xA;351 B&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA;&#xA;MoveMemory&#xA;33554455&#xA;20,022.5 us&#xA;395.35 us&#xA;500.00 us&#xA;1.26&#xA;0.02&#xA;270 B&#xA;&#xA;&#xA;FillMemory&#xA;33554455&#xA;15,822.4 us&#xA;19.85 us&#xA;17.60 us&#xA;1.00&#xA;0.00&#xA;351 B&#xA;&#xA;&#xA;&#xA;This is really interesting, for a small buffer (8MB), MoveMemory is somehow faster. I don&#x2019;t have a way to explain that, but it has been a pretty consistent result in my tests.&#xA;For the large buffer (256MB), we are seeing results that make more sense to me.&#xA;&#xA;MoveMemory &#x2013; 12.5 GB / sec&#xA;FIllMemory &#x2013; 15.8 GB / sec&#xA;&#xA;In other words, for MoveMemory, we are both reading and writing, so we are paying for memory bandwidth in both directions. For filling the memory, we are only writing, so we can get better performance (no need for reads).&#xA;In other words, we are talking about hitting the real physical limits of what the hardware can do. There are all sorts of tricks that one can pull, but when we are this close to the limit, they are almost always context-sensitive and dependent on many factors.&#xA;To conclude, here are my final results:&#xA;&#xA;&#xA;&#xA;Method&#xA;N&#xA;Mean&#xA;Error&#xA;StdDev&#xA;Ratio&#xA;RatioSD&#xA;Code Size&#xA;&#xA;&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;1048599&#xA;307.9 us&#xA;6.15 us&#xA;12.84 us&#xA;0.99&#xA;0.05&#xA;270 B&#xA;&#xA;&#xA;FilterCmp_Avx_Next&#xA;1048599&#xA;308.4 us&#xA;6.07 us&#xA;9.26 us&#xA;0.99&#xA;0.03&#xA;270 B&#xA;&#xA;&#xA;CopyTo&#xA;1048599&#xA;1,043.7 us&#xA;15.96 us&#xA;14.93 us&#xA;3.37&#xA;0.11&#xA;452 B&#xA;&#xA;&#xA;ArrayCopy&#xA;1048599&#xA;1,046.7 us&#xA;15.92 us&#xA;14.89 us&#xA;3.38&#xA;0.14&#xA;266 B&#xA;&#xA;&#xA;UnsafeCopy&#xA;1048599&#xA;309.5 us&#xA;6.15 us&#xA;8.83 us&#xA;1.00&#xA;0.04&#xA;133 B&#xA;&#xA;&#xA;MoveMemory&#xA;1048599&#xA;310.8 us&#xA;6.17 us&#xA;9.43 us&#xA;1.00&#xA;0.00&#xA;270 B&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;33554455&#xA;24,013.1 us&#xA;451.09 us&#xA;443.03 us&#xA;0.98&#xA;0.02&#xA;270 B&#xA;&#xA;&#xA;FilterCmp_Avx_Next&#xA;33554455&#xA;24,437.8 us&#xA;179.88 us&#xA;168.26 us&#xA;1.00&#xA;0.01&#xA;270 B&#xA;&#xA;&#xA;CopyTo&#xA;33554455&#xA;32,931.6 us&#xA;416.57 us&#xA;389.66 us&#xA;1.35&#xA;0.02&#xA;452 B&#xA;&#xA;&#xA;ArrayCopy&#xA;33554455&#xA;32,538.0 us&#xA;463.00 us&#xA;433.09 us&#xA;1.33&#xA;0.02&#xA;266 B&#xA;&#xA;&#xA;UnsafeCopy&#xA;33554455&#xA;24,386.9 us&#xA;209.98 us&#xA;196.42 us&#xA;1.00&#xA;0.01&#xA;133 B&#xA;&#xA;&#xA;MoveMemory&#xA;33554455&#xA;24,427.8 us&#xA;293.75 us&#xA;274.78 us&#xA;1.00&#xA;0.00&#xA;270 B&#xA;&#xA;&#xA;&#xA;As you can see, just the AVX version is comparable or (slightly) beating the MoveMemory function.&#xA;I tried things like prefetching memory, both the next item, the next cache item and from the next page, using non-temporal load and stores and many other things, but this is a pretty tough challenge.&#xA;What is really interesting is that the original, very simple and obvious implementation, clocked at 11 GB/sec. After pulling pretty much all the stops and tricks, I was able to hit 12.5 GB / sec.&#xA;I don&#x2019;t think anyone can look / update / understand the resulting code in any way without going through deep meditation. That is not a bad result at all. And along the way, I learned quite a bit about how the lowest level of the machine architecture&#xA0;is working.</p>
        </article>
        <article id="article-549">
            <a href="https://ardalis.com/trunk-based-development-vs-long-lived-feature-branches/" target="_blank">
                <h2 class="title mb-6" id="article-549">Trunk-Based Development vs. Long-Lived Feature Branches: Which One is Right for Your Software Team?</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 14, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When it comes to effective software development strategies, two distinct approaches often lock horns: Trunk-Based Development and Long-Lived&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-550">
            <a href="https://ayende.com/blog/200102-C/filtering-negative-numbers-fast-avx" target="_blank">
                <h2 class="title mb-6" id="article-550">Filtering negative numbers, fast</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 13, 2023
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post I discussed how we can optimize the filtering of negative numbers by unrolling the loop, looked into branchless code and in general was able to improve performance by up to 15% from the initial version we started with. We pushed as much as we could on what can be done using scalar code. Now it is the time to open a whole new world and see what we can do when we implement this challenge using vector instructions.&#xA;The key problem with such tasks is that SIMD, AVX and their friends were designed by&#x2026; an interesting process using a perspective that makes sense if you can see in a couple of additional dimensions. I assume that at least some of that is implementation constraints, but the key issue is that when you start using SIMD, you realize that you don&#x2019;t have general-purpose instructions. Instead, you have a lot of dedicated instructions that are doing one thing, hopefully well, and it is your role to compose them into something that would make sense. Oftentimes, you need to turn the solution on its head in order to successfully solve it using SIMD. The benefit, of course, is that you can get quite an amazing boost in speed when you do this.&#xA;The algorithm we use is basically to scan the list of entries and copy to the start of the list only those items that are positive. How can we do that using SIMD? The whole point here is that we want to be able to operate on multiple data, but this particular task isn&#x2019;t trivial. I&#x2019;m going to show the code first, then discuss what it does in detail:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public static int FilterCmp_Avx(Span&lt;long&gt; items)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var len = items.Length;&#xA;        &#xA;        &#xA;          &#xA;              if (len &lt;= 0)&#xA;        &#xA;        &#xA;          &#xA;                  return 0;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              ref var permuteStart = ref Unsafe.AsRef(PermuteTable[0]);&#xA;        &#xA;        &#xA;          &#xA;              int outputIdx = 0;&#xA;        &#xA;        &#xA;          &#xA;              int i = 0;&#xA;        &#xA;        &#xA;          &#xA;              ref var output = ref items[i];&#xA;        &#xA;        &#xA;          &#xA;              for (; i &#x2B; Vector256&lt;long&gt;.Count &lt;= len; i &#x2B;= Vector256&lt;long&gt;.Count)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var v = Vector256.LoadUnsafe(ref Unsafe.Add(ref output, i));&#xA;        &#xA;        &#xA;          &#xA;                  var bits = v.ExtractMostSignificantBits();&#xA;        &#xA;        &#xA;          &#xA;                  if (bits == 0) // do we have _any_ negatives here?&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      v.StoreUnsafe(ref Unsafe.Add(ref output, outputIdx));&#xA;        &#xA;        &#xA;          &#xA;                      outputIdx &#x2B;= Vector256&lt;long&gt;.Count;&#xA;        &#xA;        &#xA;          &#xA;                      continue;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  // complex case, we have to deal with some negatives&#xA;        &#xA;        &#xA;          &#xA;                  var permute = Vector256.LoadUnsafe(ref Unsafe.Add(ref permuteStart, (int)bits * (sizeof(int) * 8))).AsInt32();&#xA;        &#xA;        &#xA;          &#xA;                  var m = Avx2.PermuteVar8x32(v.AsInt32(), permute).AsInt64();&#xA;        &#xA;        &#xA;          &#xA;                  m.StoreUnsafe(ref Unsafe.Add(ref output, outputIdx));&#xA;        &#xA;        &#xA;          &#xA;                  outputIdx &#x2B;= 4 - BitOperations.PopCount(bits);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              // remainder, do that in a scalar fashion&#xA;        &#xA;        &#xA;          &#xA;              for (; i &lt; len; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  ref var cur = ref Unsafe.Add(ref output, i);&#xA;        &#xA;        &#xA;          &#xA;                  if (cur &lt; 0)&#xA;        &#xA;        &#xA;          &#xA;                      continue;&#xA;        &#xA;        &#xA;          &#xA;                  Unsafe.Add(ref output, outputIdx&#x2B;&#x2B;) = cur;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              return outputIdx;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          FilterCmp_Avx.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;We start with the usual check (if you&#x2019;ll recall, that ensures that the JIT knows to elide some range checks, then we load the PremuteTable. For now, just assume that this is magic (and it is). The first interesting thing happens when we start iterating over the loop. Unlike before, now we do that in chunks of 4 int64 elements at a time. Inside the loop, we start by loading a vector of int64 and then we do the first odd thing. We call ExtractMostSignificantBits(), since the sign bit is used to mark whether&#xA0;a number if negative or not. That means that I can use a single instruction to get an integer with the bits set for all the negative numbers. That is particularly juicy for what we need, since there is no need for comparisons, etc.&#xA;If the mask we got is all zeroes, it means that all the numbers we loaded to the vector are positives, so we can write them as-is to the output and move to the next part. Things get interesting when that isn&#x2019;t the case.&#xA;We load a permute value using some shenanigans (we&#x2019;ll touch on that shortly) and call the PermuteVar8x32() method. The idea here is that we pack all the non-negative numbers to the start of the vector, then we write the vector to the output. The key here is that when we do that, we increment the output index only by the number of valid values.&#xA0; The rest of this method just handles the remainder that does not fit into a vector.&#xA;The hard part in this implementation was to figure out how to handle the scenario where we loaded some negative numbers. We need a way to filter them, after all. But there is no SIMD instruction that allows us to do so. Luckily, we have the Avx2.PermuteVar8x32() method to help here. To confuse things, we don&#x2019;t actually want to deal with 8x32 values. We want to deal with 4x64 values. There is Avx2.Permute4x64() method, and it will work quite nicely, with a single caveat. This method assumes that you are going to pass it a constant value. We don&#x2019;t have such a constant, we need to be able to provide that based on whatever the masked bits will give us.&#xA;So how do we deal with this issue of filtering with SIMD? We need to move all the values we care about to the front of the vector. We have the method to do that, PermuteVar8x32() method, and we just need to figure out how to actually make use of this. PermuteVar8x32() accepts an input vector as well as a vector of the premutation you want to make. In this case, we are basing this on the 4 top bits of the 4 elements vector of int64. As such, there are a total of 16 options available to us. We have to deal with 32bits values rather than 64bits, but that isn&#x2019;t that much of a problem.&#xA;Here is the premutation table that we&#x2019;ll be using:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public static readonly int[] PermuteTableInts = new int[]&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              0,1,2,3,4,5,6,7, // 0000&#xA;        &#xA;        &#xA;          &#xA;              2,3,4,5,6,7,0,0, // 0001&#xA;        &#xA;        &#xA;          &#xA;              0,1,4,5,6,7,0,0, // 0010&#xA;        &#xA;        &#xA;          &#xA;              4,5,6,7,0,0,0,0, // 0011&#xA;        &#xA;        &#xA;          &#xA;              0,1,2,3,6,7,0,0, // 0100&#xA;        &#xA;        &#xA;          &#xA;              2,3,6,7,0,0,0,0, // 0101&#xA;        &#xA;        &#xA;          &#xA;              0,1,6,7,0,0,0,0, // 0110&#xA;        &#xA;        &#xA;          &#xA;              6,7,0,0,0,0,0,0, // 0111&#xA;        &#xA;        &#xA;          &#xA;              0,1,2,3,4,5,0,0, // 1000&#xA;        &#xA;        &#xA;          &#xA;              2,3,4,5,0,0,0,0, // 1001&#xA;        &#xA;        &#xA;          &#xA;              0,1,4,5,0,0,0,0, // 1010&#xA;        &#xA;        &#xA;          &#xA;              4,5,0,0,0,0,0,0, // 1011&#xA;        &#xA;        &#xA;          &#xA;              0,1,2,3,0,0,0,0, // 1100&#xA;        &#xA;        &#xA;          &#xA;              2,3,0,0,0,0,0,0, // 1101&#xA;        &#xA;        &#xA;          &#xA;              0,1,0,0,0,0,0,0, // 1110&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,0,0,0,0, // 1111&#xA;        &#xA;        &#xA;          &#xA;          };&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          PermuteTableInts.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;What you can see here is that when we have a 1 in the bits (shown in comments) we&#x2019;ll not copy that to the vector. Let&#x2019;s take a look at the entry of 0101, which may be caused by the following values [1,-2,3,-4].&#xA;When we look at the right entry at index #5 in the table: 2,3,6,7,0,0,0,0&#xA;What does this mean? It means that we want to put the 2nd int64 element in the source vector and move it as the first element of the destination vector, take the 3rd element from the source as the second element in the destination and discard the rest (marked as 0,0,0,0 in the table).&#xA;This is a bit hard to follow because we have to compose the value out of the individual 32 bits words, but it works quite well. Or, at least, it would work, but not as efficiently. This is because we would need to load the PermuteTableInts into a variable and access it, but there are better ways to deal with it. We can also ask the JIT to embed the value directly. The problem is that the pattern that the JIT recognizes is limited to ReadOnlySpan&lt;byte&gt;, which means that the already non-trivial int32 table got turned into this:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          // same as the one above, just in bytes for JIT optimizations&#xA;        &#xA;        &#xA;          &#xA;          public static ReadOnlySpan&lt;byte&gt; PermuteTable =&gt; new byte[]&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,2,0,0,0,3,0,0,0,4,0,0,0,5,0,0,0,6,0,0,0,7,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              2,0,0,0,3,0,0,0,4,0,0,0,5,0,0,0,6,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,4,0,0,0,5,0,0,0,6,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              4,0,0,0,5,0,0,0,6,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,2,0,0,0,3,0,0,0,6,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              2,0,0,0,3,0,0,0,6,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,6,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              6,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,2,0,0,0,3,0,0,0,4,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              2,0,0,0,3,0,0,0,4,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,4,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              4,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,2,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              2,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,&#xA;        &#xA;        &#xA;          &#xA;          };&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          PermuteTable.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;This is the exact same data as before, but using ReadOnlySpan&lt;byte&gt; means that the JIT can package that inside the data section and treat it as a constant value.&#xA;The code was heavily optimized, to the point where I noticed a JIT bug where these two versions of the code give different assembly output:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          int A(int i)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              return i * 4 * 8;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          int B(int i)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              return i * (4 * 8);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          code.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;Here is what we get out:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          Program.&lt;&lt;Main&gt;$&gt;g__A|0_0(Int32)&#xA;        &#xA;        &#xA;          &#xA;              L0000: mov eax, ecx&#xA;        &#xA;        &#xA;          &#xA;              L0002: shl eax, 2&#xA;        &#xA;        &#xA;          &#xA;              L0005: shl eax, 3&#xA;        &#xA;        &#xA;          &#xA;              L0008: ret&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          Program.&lt;&lt;Main&gt;$&gt;g__B|0_1(Int32)&#xA;        &#xA;        &#xA;          &#xA;              L0000: mov eax, ecx&#xA;        &#xA;        &#xA;          &#xA;              L0002: shl eax, 5&#xA;        &#xA;        &#xA;          &#xA;              L0005: ret&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          code.asm&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;This looks like an unintended consequence of Roslyn and the JIT each doing their (separate jobs), but not reaching the end goal. Constant folding looks like it is done mostly by Roslyn, but it does a scan like that from the left, so it wouldn&#x2019;t convert $A * 4 * 8 to $A * 32. That is because it stopped evaluating the constants when it found a variable. When we add parenthesis, we isolate the value and now understand that we can fold it.&#xA;Speaking of assembly, here is the annotated assembly version of the code:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          ; Filter.FilterCmp_Avx(System.Span`1&lt;Int64&gt;)&#xA;        &#xA;        &#xA;          &#xA;                 push      rsi            ; push rsi to stack - we&#x27;ll be using a lot of state, so need to preserve it&#xA;        &#xA;        &#xA;          &#xA;                 vzeroupper                 ; clear AVX state, since we don&#x27;t know how the caller left it&#xA;        &#xA;        &#xA;          &#xA;                 mov       rdx,[rcx]        ; rdx is now the pointer of the items&#x27; span&#xA;        &#xA;        &#xA;          &#xA;                 mov       ecx,[rcx&#x2B;8]      ; ecx is now the length of the span&#xA;        &#xA;        &#xA;          &#xA;                 test      ecx,ecx          ; if items.Length &gt; 0&#xA;        &#xA;        &#xA;          &#xA;                 jg        short M02_L00    ; jump ahead to do work&#xA;        &#xA;        &#xA;          &#xA;                 xor       eax,eax          ; return 0&#xA;        &#xA;        &#xA;          &#xA;                 vzeroupper                 ; not actually needed, I think&#xA;        &#xA;        &#xA;          &#xA;                 pop       rsi            &#xA;        &#xA;        &#xA;          &#xA;                 ret&#xA;        &#xA;        &#xA;          &#xA;          M02_L00:&#xA;        &#xA;        &#xA;          &#xA;                 mov       rax,1CA3A753F78  ; load permuteStart&#xA;        &#xA;        &#xA;          &#xA;                 xor       r8d,r8d          ; outputIdx = 0&#xA;        &#xA;        &#xA;          &#xA;                 xor       r9d,r9d          ; i = 0&#xA;        &#xA;        &#xA;          &#xA;                 cmp       ecx,4            ; if items.Length &lt; 4&#xA;        &#xA;        &#xA;          &#xA;                 jl        short M02_L04    ; jump the AVX portion loop to the next one&#xA;        &#xA;        &#xA;          &#xA;          M02_L01:&#xA;        &#xA;        &#xA;          &#xA;                 movsxd    r10,r9d          ; r10 = current i value&#xA;        &#xA;        &#xA;          &#xA;                 vmovdqu   ymm0,ymmword ptr [rdx&#x2B;r10*8] ; load vector register from output[i] (4 elements)&#xA;        &#xA;        &#xA;          &#xA;                 vmovmskpd r10d,ymm0        ; move the top bits from 4 int64 elements to r10d (bits)&#xA;        &#xA;        &#xA;          &#xA;                 test      r10d,r10d        ; if bits != 0&#xA;        &#xA;        &#xA;          &#xA;                 jne       short M02_L02    ; jump to the complex piece of the code&#xA;        &#xA;        &#xA;          &#xA;                 movsxd    r10,r8d          &#xA;        &#xA;        &#xA;          &#xA;                 vmovdqu   ymmword ptr [rdx&#x2B;r10*8],ymm0 ; store vector to output[outputIdx]&#xA;        &#xA;        &#xA;          &#xA;                 add       r8d,4            ; outputIdx &#x2B;= 4&#xA;        &#xA;        &#xA;          &#xA;                 jmp       short M02_L03    ; restart loop&#xA;        &#xA;        &#xA;          &#xA;          M02_L02:&#xA;        &#xA;        &#xA;          &#xA;                 movsxd    r11,r8d          ; r11 - current outputIdx value&#xA;        &#xA;        &#xA;          &#xA;                 mov       esi,r10d         ; esi = bits&#xA;        &#xA;        &#xA;          &#xA;                 shl       esi,5            ; bits * 4 * 8 - optimized&#xA;        &#xA;        &#xA;          &#xA;                 movsxd    rsi,esi          &#xA;        &#xA;        &#xA;          &#xA;                 vmovdqu   ymm1,ymmword ptr [rax&#x2B;rsi] ; load vector from premutation table&#xA;        &#xA;        &#xA;          &#xA;                 vpermd    ymm0,ymm1,ymm0   ; permute value&#xA;        &#xA;        &#xA;          &#xA;                 vmovdqu   ymmword ptr [rdx&#x2B;r11*8],ymm0 ; write to output&#xA;        &#xA;        &#xA;          &#xA;                 popcnt    r10d,r10d        ; count the bits&#xA;        &#xA;        &#xA;          &#xA;                 neg       r10d             ; negate the value&#xA;        &#xA;        &#xA;          &#xA;                 lea       r8d,[r10&#x2B;r8&#x2B;4]   ; add to outputIdx &#x2B; 4&#xA;        &#xA;        &#xA;          &#xA;          M02_L03:&#xA;        &#xA;        &#xA;          &#xA;                 add       r9d,4            ; for loop handling&#xA;        &#xA;        &#xA;          &#xA;                 lea       r10d,[r9&#x2B;4]&#xA;        &#xA;        &#xA;          &#xA;                 cmp       r10d,ecx         &#xA;        &#xA;        &#xA;          &#xA;                 jle       short M02_L01    ; jump to start of loop&#xA;        &#xA;        &#xA;          &#xA;          M02_L04:&#xA;        &#xA;        &#xA;          &#xA;                 cmp       r9d,ecx          ; if there are no elements remaining&#xA;        &#xA;        &#xA;          &#xA;                 jge       short M02_L07    ; jump to end&#xA;        &#xA;        &#xA;          &#xA;          M02_L05:&#xA;        &#xA;        &#xA;          &#xA;                 movsxd    rax,r9d          ; here is the scalar version, already discussed previously&#xA;        &#xA;        &#xA;          &#xA;                 lea       rax,[rdx&#x2B;rax*8]&#xA;        &#xA;        &#xA;          &#xA;                 mov       rax,[rax]&#xA;        &#xA;        &#xA;          &#xA;                 test      rax,rax&#xA;        &#xA;        &#xA;          &#xA;                 jl        short M02_L06&#xA;        &#xA;        &#xA;          &#xA;                 mov       r10d,r8d&#xA;        &#xA;        &#xA;          &#xA;                 lea       r8d,[r10&#x2B;1]&#xA;        &#xA;        &#xA;          &#xA;                 movsxd    r10,r10d&#xA;        &#xA;        &#xA;          &#xA;                 mov       [rdx&#x2B;r10*8],rax&#xA;        &#xA;        &#xA;          &#xA;          M02_L06:&#xA;        &#xA;        &#xA;          &#xA;                 inc       r9d&#xA;        &#xA;        &#xA;          &#xA;                 cmp       r9d,ecx&#xA;        &#xA;        &#xA;          &#xA;                 jl        short M02_L05&#xA;        &#xA;        &#xA;          &#xA;          M02_L07:&#xA;        &#xA;        &#xA;          &#xA;                 mov       eax,r8d&#xA;        &#xA;        &#xA;          &#xA;                 vzeroupper&#xA;        &#xA;        &#xA;          &#xA;                 pop       rsi&#xA;        &#xA;        &#xA;          &#xA;                 ret&#xA;        &#xA;        &#xA;          &#xA;          ; Total bytes of code 179&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          FilterCmp_Avx.asm&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;And after all of this work, where are we standing?&#xA;&#xA;&#xA;&#xA;Method&#xA;N&#xA;Mean&#xA;Error&#xA;StdDev&#xA;Ratio&#xA;RatioSD&#xA;Code Size&#xA;&#xA;&#xA;&#xA;&#xA;FilterCmp&#xA;23&#xA;285.7 ns&#xA;3.84 ns&#xA;3.59 ns&#xA;1.00&#xA;0.00&#xA;411 B&#xA;&#xA;&#xA;FilterCmp_NoRangeCheck&#xA;23&#xA;272.6 ns&#xA;3.98 ns&#xA;3.53 ns&#xA;0.95&#xA;0.01&#xA;397 B&#xA;&#xA;&#xA;FilterCmp_Unroll_8&#xA;23&#xA;261.4 ns&#xA;1.27 ns&#xA;1.18 ns&#xA;0.91&#xA;0.01&#xA;672 B&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;23&#xA;261.6 ns&#xA;1.37 ns&#xA;1.28 ns&#xA;0.92&#xA;0.01&#xA;521 B&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA;&#xA;FilterCmp&#xA;1047&#xA;758.7 ns&#xA;1.51 ns&#xA;1.42 ns&#xA;1.00&#xA;0.00&#xA;411 B&#xA;&#xA;&#xA;FilterCmp_NoRangeCheck&#xA;1047&#xA;756.8 ns&#xA;1.83 ns&#xA;1.53 ns&#xA;1.00&#xA;0.00&#xA;397 B&#xA;&#xA;&#xA;FilterCmp_Unroll_8&#xA;1047&#xA;640.4 ns&#xA;1.94 ns&#xA;1.82 ns&#xA;0.84&#xA;0.00&#xA;672 B&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;1047&#xA;426.0 ns&#xA;1.62 ns&#xA;1.52 ns&#xA;0.56&#xA;0.00&#xA;521 B&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA;&#xA;FilterCmp&#xA;1048599&#xA;502,681.4 ns&#xA;3,732.37 ns&#xA;3,491.26 ns&#xA;1.00&#xA;0.00&#xA;411 B&#xA;&#xA;&#xA;FilterCmp_NoRangeCheck&#xA;1048599&#xA;499,472.7 ns&#xA;6,082.44 ns&#xA;5,689.52 ns&#xA;0.99&#xA;0.01&#xA;397 B&#xA;&#xA;&#xA;FilterCmp_Unroll_8&#xA;1048599&#xA;425,800.3 ns&#xA;352.45 ns&#xA;312.44 ns&#xA;0.85&#xA;0.01&#xA;672 B&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;1048599&#xA;218,075.1 ns&#xA;212.40 ns&#xA;188.29 ns&#xA;0.43&#xA;0.00&#xA;521 B&#xA;&#xA;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA0;&#xA;&#xA;&#xA;FilterCmp&#xA;33554455&#xA;29,820,978.8 ns&#xA;73,461.68 ns&#xA;61,343.83 ns&#xA;1.00&#xA;0.00&#xA;411 B&#xA;&#xA;&#xA;FilterCmp_NoRangeCheck&#xA;33554455&#xA;29,471,229.2 ns&#xA;73,805.56 ns&#xA;69,037.77 ns&#xA;0.99&#xA;0.00&#xA;397 B&#xA;&#xA;&#xA;FilterCmp_Unroll_8&#xA;33554455&#xA;29,234,413.8 ns&#xA;67,597.45 ns&#xA;63,230.70 ns&#xA;0.98&#xA;0.00&#xA;672 B&#xA;&#xA;&#xA;FilterCmp_Avx&#xA;33554455&#xA;28,498,115.4 ns&#xA;71,661.94 ns&#xA;67,032.62 ns&#xA;0.96&#xA;0.00&#xA;521 B&#xA;&#xA;&#xA;&#xA;So it seems that the idea of using SIMD instruction has a lot of merit. Moving from the original code to the final version, we see that we can complete the same task in up to half the time.&#xA;I&#x2019;m not quite sure why we aren&#x2019;t seeing the same sort of performance on the 32M, but I suspect that this is likely because we far exceed the CPU cache and we have to fetch it all from memory, so that is as fast as it can go.&#xA;If you are interested in learning more, Lemire solves the same problem in SVE (SIMD for ARM) and Paul has a similar approach in Rust.&#xA;If you can think of further optimizations, I would love to hear your ideas.</p>
        </article>
        <div class="button flex justify-between">
            <a href="54.html"><span class="back arrow"></span></a>

            <a href="56.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>