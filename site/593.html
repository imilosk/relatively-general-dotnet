
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 593 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-5921">
            <a href="https://ayende.com/blog/3955/repository-is-the-new-singleton" target="_blank">
                <h2 class="title mb-6" id="article-5921">Repository is the new Singleton</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I mentioned in passing that I don&#x2019;t like the Repository pattern anymore much, and gotten a lot of responses to that. This is the answering post, and yes, the title was&#xA0; chosen to get a rise out of you.  There are actually two separate issues that needs to be handled here. One of them is my issues with the actual pattern and the second is the pattern usage. There most commonly used definition for Repository is defined in Patterns of Enterprise Application Architecture:     A system with a complex domain model often benefits from a layer, such as the one provided by Data Mapper, that isolates domain objects from details of the database access code. In such systems it can be worthwhile to build another layer of abstraction over the mapping layer where query construction code is concentrated. This becomes more important when there are a large number of domain classes or heavy querying. In these cases particularly, adding this layer helps minimize duplicate query logic.    A Repository mediates between the domain and data mapping layers, acting like an in-memory domain object collection. Client objects construct query specifications declaratively and submit them to Repository for satisfaction. Objects can be added to and removed from the Repository, as they can from a simple collection of objects, and the mapping code encapsulated by the Repository will carry out the appropriate operations behind the scenes. Conceptually, a Repository encapsulates the set of objects persisted in a data store and the operations performed over them, providing a more object-oriented view of the persistence layer. Repository also supports the objective of achieving a clean separation and one-way dependency between the domain and data mapping layers.   Note that while the actual pattern description defined in PoEAA and DDD are very nearly identical, the actual reasoning behind it is different, and the DDD repository is limited to aggregate roots only.  So, what is the problem with that?  The problem with this pattern is that it totally ignores the existence of mature persistence technologies, such as NHibernate. NHibernate already provides an illusion of in memory access, in fact, that is its sole reason of existing. Declarative queries, check. OO view on the persistence store, check. One way dependency between the domain and the data store, check.  So, what do I gain by using the repository pattern when I already have NHibernate (or similar, most OR/M have matching capabilities by now)?  Not much, really, expect as additional abstraction. More than that, the details of persistence storage are:     Complex    Context sensitive    Important   Trying to hide that behind a repository interface usually lead us to a repository that has method like:     FindCustomer(id)    FindCustomerWithAddresses(id)    FindCustomerWith..   It get worse when you have complex search criteria and complex fetch plan. Then you are stuck either creating a method per each combination that you use or generalizing that. Generalizing that only means that you now have an additional abstraction that usually map pretty closely to the persistent storage that you use.  From my perspective, that is additional code that doesn&#x2019;t have to be written.  Wait, I can hear you say, but repositories encapsulate queries, and removing query logic duplication is one of the reasons for them in the first place.  Well, yes, but encapsulation of queries should be done in the repository. Queries are complex, and you want to encapsulate them in their own object. In most cases, I have something like this:     GetQuery takes an ISession an return ICriteria, which mean that my code gets the chance to set paging, ordering, fetching strategies, etc. That is not the responsibility of the query object, and trying to hide it only add additional abstraction that doesn&#x2019;t actually give me anything.  I mentioned that I have two problems with the repository pattern, the second being the way it is being used.  Quite frankly, and here I fully share the blame, the Repository pattern is popular. A lot of people use it, mostly because of the DDD association. I am currently in the opinion that DDD should be approached with caution, since if you don&#x2019;t actually need it (and have the prerequisites for it, such as business expert to work closely with or an app that can actually benefit from it), it is probably going to be more painful to try using DDD than without.  More than that, the way that most people use a Repository more closely follows the DAO pattern, not the Repository pattern. But Repository sounds more cool, so they call it that.  My current approach for data access now is:     When using a database, use NHibernate&#x2019;s ISession directly    Encapsulate complex queries into query objects that construct an ICriteria query that I can get and manipulate further    When using something other than a database, create a DAO for that, respecting the underlying storage implementation     Don&#x2019;t try to protect developers   Let us see how many call for my lynching we get now&#x2026;</p>
        </article>
        <article id="article-5922">
            <a href="https://ayende.com/blog/3954/what-do-i-expect-from-guidance" target="_blank">
                <h2 class="title mb-6" id="article-5922">What do I expect from guidance?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Phil Haack has a post about code sample taxonomy. He suggests the following taxonomy:     Prototype    Demo    Sample    Production    Reference   I am not sure that I agree with his division. From my point of view, demo code need to focus on one single aspect, mostly because we are going to talk around that, and doing that means that I don&#x2019;t have the time to deal with anything but the aspect that I need to talk about.  Sample code is a more fleshed out example.   I don&#x2019;t make any distinction between reference and sample apps, maybe the size is different but that is about it.  What is important to follow is that for all of them, except maybe prototype (and I was bitten by that before), I have the same code quality expectations.  Note that I am saying code quality vs. production readiness. Most of the code that you see in demos or sample apps is not production ready. And that is fine.  Production readiness include such things as:     Parameter validation    Security    Error handling    Failover &amp; recovery   And a lot more &#x201C;taxes&#x201D; that we need to deal with.  That does not include code quality. Code quality is a metric of its own, and it is one that you cannot give up. I would be personally ashamed to put out something that didn&#x2019;t meet my own code quality metrics.   Sometimes, being production ready means that you have to give up on code quality, here is one example, that is understood and acceptable in certain circumstances.  What is not acceptable is to say that this is &#x201C;Xyz&#x201D; type of code sample, therefore code quality doesn&#x2019;t matter.  And code quality isn&#x2019;t really some amorphous thing. It is a very well defined metric that can be automatically checked. FxCop or NDepend are good tools to have, Simian will give you a lot of value all on its own.   When you put something out as an official Microsoft guidance release, the bar is higher, because whatever you do will be used by other people.</p>
        </article>
        <article id="article-5923">
            <a href="https://ayende.com/blog/3953/kobe-architectural-overview" target="_blank">
                <h2 class="title mb-6" id="article-5923">Kobe &#x2013; Architectural Overview</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Sometimes, you have to make a distinction between the system architecture and the system implementation. It is possible to have a great architecture and have the implementers butcher it by not paying attention at some points.  Sometimes, the problem in the code implementation is so bad that it becomes an architectural problem. Kobe is one such example.  We can start with the pervasive Primitive obsession that is all over the map. The common use of &#x201C;string thisIsReallyGuid&#x201D;, Copy &amp; paste programming, horrible Exception Handling and total lack of respect for the fundamentals of OO.  All of those tie back together to the lack of architectural oversight over the project. I have the feeling that at no point someone stopped and said: &#x201C;there has got to be a better way of doing this.&#x201D;  DRY is a true principle in development, it transcend programming languages and paradigms, about the only one that I can think of that does so. If you violate DRY, you are in for a world of trouble, sooner than later.  SOLID is a set of principles used to build good OO applications. If you are using OO language and paradigms and fail to pay attention to SOLID, it will hurt you at some point. Not as soon as if you have violated DRY, but soon enough.  8.5% of Kobe is copy &amp; pasted code. And that is with the sensitivity dialed high, if we set the threshold to 3, which is what I commonly do, is goes up to 12.5%. A lot of the duplicated code relates to exception handling and caching. Those are classic cases for using an aspect to handle cross cutting concerns. That would reduce a lot of the duplicated code.  The other problems that I have with Kobe is its total lack of respect for SOLID principles. You know what, let us throw solid out the window, I am going to focus on a single principle, Single Responsibility Principle. Just about any method that you care to name does more than one thing, in many cases, they do a lot more than one thing.  This is absolutely wrong.  The &#x201C;repositories&#x201D; in Kobe has so many responsibilities that they are just shy of having a singularity around them.  Overall, Kobe feels very amaturish, as if it was written without true understanding of what is expected of quality code, and without really understanding the underlying platform, frameworks or the infrastructure that they are using.  I don&#x2019;t like it at all, and it is a horrible sample application. In my considered opinioned, it should be pulled from the site, rewritten, and only then published again.</p>
        </article>
        <article id="article-5924">
            <a href="https://ayende.com/blog/3952/kobe-an-example-of-exception-handling-done-wrong" target="_blank">
                <h2 class="title mb-6" id="article-5924">Kobe &#x2013; an example of exception handling done wrong</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In Kobe, pretty much all exception handling is this:  catch (Exception ex)&#xA;{&#xA;    bool rethrow = ExceptionPolicy.HandleException(ex, &quot;Service Policy&quot;);&#xA;    if (rethrow &amp;&amp; WebOperationContext.Current == null)&#xA;    {&#xA;        throw;&#xA;    }&#xA;    return null;&#xA;}&#xA;&#xA;These lines appear in just about any method in the application.&#xA;&#xA;They are wrong. In fact, they are wrong on more than one level. Violating DRY is a big offence, but even ignoring that, they are still wrong.&#xA;&#xA;Exception handling is not something that you should take lightly, and there is a strong tie between the way that you write the code and the way errors are handled. The whole purpose of this exception handling is to avoid throwing an exception by setting some configuration parameter.&#xA;&#xA;The problem with this is that this purpose is wrong. This is a case of writing the code without actually trying to understand what the implications are. You cannot do this sort of thing, because the calling code never expects a null, it expect a valid result or an exception.&#xA;&#xA;This approach bring us back to the bad old days of error codes. Not to mention that even if we actually checked for a null return value, what the hell is the error that actually caused this to happen.&#xA0; Oh, it was put in the log, so now we need to go and look at the log file and try to match timestamps (if we even can).&#xA;&#xA;Exception handling should appear in exactly two places:&#xA;&#xA;&#xA;  When an error is expected (making a web request call, for example) and there is some meaningful behavior to be done in the case of a failure (such as retrying after some delay)&#xA;&#xA;  On a system boundary, in which case you need to make a decision about how you are going to expose the error to the outside world.&#xA;&#xA;&#xA;It is important to note that I explicitly used the term system boundary, instead of service boundary, which is more commonly used. Exception handling within a system should not try to hide errors. Error should propagate all the way to the system boundary, because otherwise we lose a lot of important information.&#xA;&#xA;System boundary is defined as whatever is visible to the actual user or other systems.&#xA;&#xA;Oh, and exception handling in the system boundary is a system infrastructure problem, it is not something that you have to write code for all over the place.</p>
        </article>
        <article id="article-5925">
            <a href="https://ayende.com/blog/3951/kobe-when-the-documentation-is-the-only-delivery-that-matters" target="_blank">
                <h2 class="title mb-6" id="article-5925">Kobe &#x2013; When the documentation is the only delivery that matters</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When comparing the Kobe code base to the Kobe documentation, I am starting to get a sinking feeling. The documentation is really nice, the code is anything but.  When you put out guidance, the documentation is nice, but it is the code that people are going to look it, learn and try to emulate. And when you put out something that doesn&#x2019;t meet basic parameters for good software, that is a huge problem.  With Oxite, Microsoft had the excuse of it being slipped out without anyone noticing. This time it is official, it has passed the proper review procedure, and is explicitly marketed as &#x201C;intended to guide you with the planning, architecting, and implementing of Web 2.0 applications and services.&#x201D;  Sorry, that is entirely unacceptable.  Putting something like that out there as guidance is actively doing harm to the community as a whole. It means that people who would look at that and try to use what they see there are going to get bitten by bad practices, bad architecture and overly complex and redundant approaches.  Phil Haack&#xA0;said that: &#x201C;I was part of a high-level review and I felt most of the app that I saw was reasonably put together.&#x201D;  I submit that high level review of such guidance packages is absolutely not sufficient. You have to get people to do a full review cycle of that, which include the code, the documentation, the reasoning and anything else that is going out there.</p>
        </article>
        <article id="article-5926">
            <a href="https://ayende.com/blog/3950/kobe-data-access-done-wrong" target="_blank">
                <h2 class="title mb-6" id="article-5926">Kobe &#x2013; Data Access done wrong</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">From the Kobe documentation:     The Repository pattern is applied to mediate access to the data store through a Repository provider.    From PoEAA:     A system with a complex domain model often benefits from a layer, such as the one provided by Data Mapper (165), that isolates domain objects from details of the database access code. In such systems it can be worthwhile to build another layer of abstraction over the mapping layer where query construction code is concentrated. This becomes more important when there are a large number of domain classes or heavy querying. In these cases particularly, adding this layer helps minimize duplicate query logic.   I think that Repository is a fad, which is why I don&#x2019;t use it much anymore myself, and looking at the usage semantics of the &#x201C;repositories&#x201D; in Kobe, they certainly don&#x2019;t fit the bill.  Repositories are here to encapsulate query logic, that is not the case with Kobe. Here is a partial view of some of the repositories that it have:     In general, looking at the any of the repositories in detail, I really want to cry. I mean, just take a look:     More to the point, let us look at GroupRepository.AcceptGroupInvite (I removed all the copy &amp; paste crap to concentrate on the actual code):  GroupInvite groupInvite = _context.GroupInviteSet&#xA;                                 .Where(gi =&gt; gi.GroupInviteId == groupInviteId)&#xA;                                 .FirstOrDefault();&#xA;&#xA;if (groupInvite == null)&#xA;    throw new DataException(&quot;Invalid Invite Id&quot;, null);&#xA;&#xA;groupInvite.InvitationStatuses = _context.InvitationStatusSet&#xA;                                        .Where(s =&gt; s.InvitationStatusName == &quot;Accepted&quot;)&#xA;                                        .FirstOrDefault(); ;&#xA;&#xA;_context.SaveChanges(true);&#xA;&#xA;There are so many things wrong with this approach that I don&#x2019;t even know where to start.&#xA;&#xA;You can see how the architects or developers resented having to use an ORM. If they couldn&#x2019;t have stored procedures in the database, then by Jove and his keyboard, they will write stored procedures in code.&#xA;&#xA;Kobe uses Entity Framework for data access, and they treat it as if it was a dataset. As an OR/M aficionado, I am insolated. This shows complete lack of understanding how Entity Framework work, doing a lot more work than you should, brute force &amp; big hammer approach.&#xA;&#xA;From an architectural perspective, most of what Kobe is doing is calling down to the repository to perform the data access details. Business logic, such as there is, is spread between the data access, the controllers and the service layer, in such a way that make is very hard to have a good idea about what is actually happening in the application.&#xA;&#xA;Data access details are quite pervasive throughout the application, and the whole feeling of the application is of a circa 2001 sample app using stored procedures and hand rolled data access layers.</p>
        </article>
        <article id="article-5927">
            <a href="https://ayende.com/blog/3949/kobe-in-the-nuts-bolts-and-dont-really-liking-it" target="_blank">
                <h2 class="title mb-6" id="article-5927">Kobe &#x2013; In the nuts &amp; bolts and don&#x2019;t really liking it</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There is another ASP.Net MVC sample app, this time it is official, passed the proper review procedure, and is explicitly marketed as &#x201C;intended to guide you with the planning, architecting, and implementing of Web 2.0 applications and services.&#x201D;  I am saying all of that in order to distinguish it from Oxite, which was non of this things. There have been a couple of reviews of Kobe already. Frankly, I don&#x2019;t really care for them, mostly because I think that they dealt too much with nitty gritty details of the app that doesn&#x2019;t really matter much. I don&#x2019;t much care for extra using or the use of System.Int32 vs. int, the naming convention used or even what sort of HTML formatting they used. I mostly care about the code and architecture. So I decided to take a look myself.  This post is going to go over the nuts &amp; bolts, looking at low level coding details. I am going to have another that is going to look at the architecture and probably a few others that talk about some additional concerns that I have.  Let us start by looking at the code via some tools. Simian reports:         And that is when the similarity threshold is 6 lines, I usually run it with three, if we try that, we get:     Found 5138 duplicate lines in 873 blocks in 67 files   Next, the most important code metric to me in most cases, Cyclomatic Complexity. Two methods literally jump out of the solution and beg for mercy.     HomeController.Discovery with CC index of 35(!)    GroupController.Profile with CC index of 22   I am going to show them both in all their glory, and let you be the judge of them:  public ActionResult Discovery(string query)&#xA;{&#xA;    query = query.Trim();&#xA;&#xA;    query = Server.HtmlEncode(query);&#xA;&#xA;    List&lt;PresentationSummary&gt; presentationsAll = null;&#xA;    List&lt;PresentationSummary&gt; presentationsMostPopular = null;&#xA;    List&lt;PresentationSummary&gt; presentationsMostViewed = null;&#xA;    List&lt;PresentationSummary&gt; presentationsMostDownload = null;&#xA;    List&lt;PresentationSummary&gt; presentationsNew = null;&#xA;&#xA;    List&lt;UserSummary&gt; activeusers = null;&#xA;    List&lt;UserSummary&gt; allusers = null;&#xA;    List&lt;Group&gt; activegroups = null;&#xA;    List&lt;Group&gt; allgroups = null;&#xA;&#xA;    int iNewMemberPageCount = 0;&#xA;    int iNewGroupPageCount = 0;&#xA;    int ipresentationsAll = 0; &#xA;    int ipresentationsMostPopular =  0;&#xA;    int ipresentationsMostViewed = 0;&#xA;    int ipresentationsMostDownload = 0;&#xA;    int ipresentationsNew = 0;&#xA;&#xA;    UserSummary user = _userService.GetUserByName(query);&#xA;    if (user != null)&#xA;    {&#xA;        presentationsAll = _userService.GetAuthoredPresentations(user.UserName);&#xA;        presentationsMostPopular = presentationsAll.OrderByDescending(p =&gt; p.Favorites).ToList();&#xA;        presentationsMostViewed = presentationsAll.Where(p =&gt; p.Views &gt; 0).OrderByDescending(p =&gt; p.Views).ToList();&#xA;        presentationsMostDownload = presentationsAll.Where(p =&gt; p.Downloads &gt; 0).OrderByDescending(p =&gt; p.Downloads).ToList();&#xA;        presentationsNew = presentationsAll.OrderByDescending(p =&gt; p.InsertedDate).ToList();&#xA;&#xA;        ipresentationsAll = decimal.Divide(presentationsAll.Count, 10).ToInt();&#xA;        ipresentationsMostPopular = decimal.Divide(presentationsMostPopular.Count, 10).ToInt();&#xA;        ipresentationsMostViewed = decimal.Divide(presentationsMostViewed.Count, 10).ToInt();&#xA;        ipresentationsMostDownload = decimal.Divide(presentationsMostDownload.Count, 10).ToInt();&#xA;        ipresentationsNew = decimal.Divide(presentationsNew.Count, 10).ToInt();&#xA;&#xA;        activeusers = new List&lt;UserSummary&gt; { user };&#xA;        allusers = new List&lt;UserSummary&gt; { user };&#xA;        iNewMemberPageCount = decimal.Divide(allusers.Count, 8).ToInt();&#xA;&#xA;        allgroups = _userService.GetGroups(user.UserName);&#xA;        activegroups = allgroups.OrderByDescending(g =&gt; g.InsertedDate).ToList();&#xA;        iNewGroupPageCount = decimal.Divide(allgroups.Count, 8).ToInt();&#xA;    }&#xA;    else&#xA;    {&#xA;        Group group = _groupService.GetGroupByName(query);&#xA;        if (group != null)&#xA;        {&#xA;            presentationsAll = _groupService.GetPresentations(group.GroupName);&#xA;            presentationsMostPopular = presentationsAll.OrderByDescending(p =&gt; p.Favorites).ToList();&#xA;            presentationsMostViewed = presentationsAll.Where(p =&gt; p.Views &gt; 0).OrderByDescending(p =&gt; p.Views).ToList();&#xA;            presentationsMostDownload = presentationsAll.Where(p =&gt; p.Downloads &gt; 0).OrderByDescending(p =&gt; p.Downloads).ToList();&#xA;            presentationsNew = presentationsAll.OrderByDescending(p =&gt; p.InsertedDate).ToList();&#xA;&#xA;            ipresentationsAll = decimal.Divide(presentationsAll.Count, 10).ToInt();&#xA;            ipresentationsMostPopular = decimal.Divide(presentationsMostPopular.Count, 10).ToInt();&#xA;            ipresentationsMostViewed = decimal.Divide(presentationsMostViewed.Count, 10).ToInt();&#xA;            ipresentationsMostDownload = decimal.Divide(presentationsMostDownload.Count, 10).ToInt();&#xA;            ipresentationsNew = decimal.Divide(presentationsNew.Count, 10).ToInt();&#xA;&#xA;            allusers = _groupService.GetMembers(group.GroupName);&#xA;            activeusers = allusers.OrderByDescending(u =&gt; u.DateOfJoining).ToList();&#xA;            iNewMemberPageCount = decimal.Divide(allusers.Count, 8).ToInt();&#xA;&#xA;            allgroups = new List&lt;Group&gt; { group };&#xA;            activegroups = new List&lt;Group&gt; { group };&#xA;            iNewGroupPageCount = decimal.Divide(allgroups.Count, 8).ToInt();&#xA;        }&#xA;        else&#xA;        {&#xA;            presentationsAll = _presentationService.GetAllPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;, 10, 1);&#xA;            presentationsMostPopular = _presentationService.GetMostPopularPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;, 10, 1);&#xA;            presentationsMostViewed = _presentationService.GetMostViewedPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;, 10, 1); &#xA;            presentationsMostDownload = _presentationService.GetMostDownloadedPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;, 10, 1); &#xA;            presentationsNew = _presentationService.GetNewPresentations(query, &quot;Day&quot;, &quot;0&quot;, 10, 1);&#xA;&#xA;            ipresentationsAll = decimal.Divide(_presentationService.GetAllPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;).Count, 10).ToInt();&#xA;            ipresentationsMostPopular = decimal.Divide(_presentationService.GetMostPopularPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;).Count, 10).ToInt();&#xA;            ipresentationsMostViewed = decimal.Divide(_presentationService.GetMostViewedPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;).Count, 10).ToInt();&#xA;            ipresentationsMostDownload = decimal.Divide(_presentationService.GetMostDownloadedPresentationsByKewordTimeLine(query, &quot;Day&quot;, &quot;0&quot;).Count, 10).ToInt();&#xA;            ipresentationsNew = decimal.Divide(_presentationService.GetNewPresentations(query, &quot;Day&quot;, &quot;0&quot;).Count, 10).ToInt();&#xA;&#xA;            activeusers = _userService.GetMostActiveUsers(query, 8, 1);&#xA;            allusers = _userService.GetAllUsers(query, 8, 1);&#xA;            iNewMemberPageCount = decimal.Divide(_userService.GetMostActiveUsers(query).Count,8).ToInt();&#xA;&#xA;            activegroups = _groupService.GetMostActiveGroupByKeyword(query, 8, 1);&#xA;            allgroups = _groupService.GetAllGroupByKeyword(query, 8, 1);&#xA;            iNewGroupPageCount = decimal.Divide(_groupService.GetMostActiveGroupByKeyword(query).Count, 8).ToInt();&#xA;        }&#xA;    }&#xA;&#xA;    ViewData.Add(&quot;membersList-mostactive&quot;, activeusers);&#xA;    ViewData.Add(&quot;membersList-all&quot;, allusers);&#xA;    ViewData.Add(&quot;groupsList-mostactive&quot;, activegroups);&#xA;    ViewData.Add(&quot;groupsList-all&quot;, allgroups);&#xA;&#xA;    ViewData.Add(&quot;presentations-all&quot;,presentationsAll);&#xA;    ViewData.Add(&quot;presentations-mostpopular&quot;,presentationsMostPopular);&#xA;    ViewData.Add(&quot;presentations-mostviewed&quot;,presentationsMostViewed);&#xA;    ViewData.Add(&quot;presentations-mostdownload&quot;,presentationsMostDownload);&#xA;    ViewData.Add(&quot;presentations-new&quot;,presentationsNew);&#xA;   &#xA;    ViewData.Add(&quot;Query&quot;, query);&#xA;    //ViewData.Add(&quot;Presentations&quot;, presentations);&#xA;&#xA;    ViewData.Add(&quot;members-totalcount&quot;, iNewMemberPageCount);&#xA;    ViewData.Add(&quot;groups-totalcount&quot;, iNewGroupPageCount);&#xA;&#xA;    ViewData.Add(&quot;presentations-alltotalcount&quot;, ipresentationsAll);&#xA;    ViewData.Add(&quot;presentations-mostpopulartotalcount&quot;, ipresentationsMostPopular);&#xA;    ViewData.Add(&quot;presentations-mostviewedtotalcount&quot;, ipresentationsMostViewed);&#xA;    ViewData.Add(&quot;presentations-mostdownloadtotalcount&quot;, ipresentationsMostDownload);&#xA;    ViewData.Add(&quot;presentations-newtotalcount&quot;, ipresentationsNew);&#xA;&#xA;    return View();&#xA;}&#xA;&#xA;This is&#x2026; a very busy method, I must say. But in a way, the Profile method is much worse:&#xA;&#xA;[AcceptVerbs(HttpVerbs.Post)]&#xA;public ActionResult Profile(string gname, string type, string section, string subSection, string page)&#xA;{&#xA;    if (string.IsNullOrEmpty(gname))&#xA;        return new ContentResult { Content = &quot;&quot; };&#xA;&#xA;    if (type != &quot;widget&quot;)&#xA;        return new ContentResult { Content = &quot;&quot; };&#xA;&#xA;    Group group = null;&#xA;&#xA;    try&#xA;    {&#xA;        group = _groupService.GetGroupByName(gname);&#xA;    }&#xA;    catch (Exception)&#xA;    {&#xA;        return new ContentResult { Content = &quot;&quot; };&#xA;    }&#xA;&#xA;    if (group == null)&#xA;    {&#xA;        return new ContentResult { Content = &quot;&quot; };&#xA;    }&#xA;&#xA;    string groupName = group.GroupName;&#xA;&#xA;    AddUserLevelToViewData(groupName);&#xA;&#xA;    int pageNo = 1;&#xA;    Int32.TryParse(page, out pageNo);&#xA;    if (pageNo == 0)&#xA;        pageNo = 1;&#xA;&#xA;    if (section == &quot;div-GroupPresentations&quot;)&#xA;    {&#xA;        List&lt;PresentationSummary&gt; presentations = null;&#xA;&#xA;        switch (subSection)&#xA;        {&#xA;            case &quot;div-GroupPresentations-RecentltAdded&quot;:&#xA;                presentations = _groupService.GetRecentlyAddedPresentations(groupName, 5, pageNo);&#xA;                break;&#xA;            case &quot;div-GroupPresentations-MostViewed&quot;:&#xA;                presentations = _groupService.GetMostViewedPresentations(groupName, 5, pageNo);&#xA;                break;&#xA;            case &quot;div-GroupPresentations-MostDownloaded&quot;:&#xA;                presentations = _groupService.GetMostDownloadedPresentations(groupName, 5, pageNo);&#xA;                break;&#xA;            case &quot;div-GroupPresentations-All&quot;:&#xA;                presentations = _groupService.GetPresentations(groupName, 5, pageNo);&#xA;                break;&#xA;        }&#xA;&#xA;        return View(&quot;PresentationsList&quot;, presentations);&#xA;    }&#xA;    else if (section == &quot;div-GroupWall&quot;)&#xA;    {&#xA;        switch (subSection)&#xA;        {&#xA;            case &quot;div-GroupWall-Messages&quot;:&#xA;                ViewData[&quot;GroupMessages&quot;] = _groupService.GetMessages(groupName, 5, pageNo);&#xA;                return View(&quot;GroupMessageList&quot;, ViewData[&quot;GroupMessages&quot;]);&#xA;            case &quot;div-GroupWall-MemberRequests&quot;:&#xA;                ViewData[&quot;GroupJoiningRequests&quot;] = _groupService.GetGroupJoiningRequests(groupName, 5, pageNo);&#xA;                return View(&quot;GroupJoiningRequestList&quot;, ViewData[&quot;GroupJoiningRequests&quot;]);&#xA;        }&#xA;    }&#xA;    else if (section == &quot;div-GroupInfoExtended&quot;)&#xA;    {&#xA;        switch (subSection)&#xA;        {&#xA;            case &quot;div-GroupInfoExtended-GroupMembers&quot;:&#xA;                ViewData[&quot;GroupMembers&quot;] = _groupService.GetMembers(groupName, 4, pageNo);&#xA;                return View(&quot;MembersList&quot;, ViewData[&quot;GroupMembers&quot;]);&#xA;        }&#xA;    }&#xA;&#xA;    return new ContentResult { Content = &quot;&quot; };&#xA;}&#xA;&#xA;Just look at the code. I thought that the whole point of MVC was to separate the logic from the view. Having the view strongly tied to the controller output is fine by me, but having the controller strongly tied to the HTML format of the page? That isn&#x2019;t right.&#xA;&#xA;Another thing that isn&#x2019;t right is HomeController.Index():&#xA;&#xA;public ActionResult Index()&#xA;{&#xA;    GetFeaturedPresentations(); //*** Dummy call the the Database to activate the Connection.&#xA;    List&lt;PresentationSummary&gt; featured = _presentationService.GetFeaturedPresentations();&#xA;    List&lt;PresentationSummary&gt; beingViewed = _presentationService.GetPresentationRecentlyViewed();&#xA;    List&lt;PresentationSummary&gt; mostDownloaded = _presentationService.GetMostDownloadedPresentation();&#xA;    PresentationSummary presentationOfDay = _presentationService.GetPresentationOfDay();&#xA;&#xA;    ViewData.Add(&quot;FeaturedPresentations&quot;, featured.ToArray());&#xA;    ViewData.Add(&quot;RecentlyViewedPresentations&quot;, beingViewed.ToArray());&#xA;    ViewData.Add(&quot;MostDownloadedPresentations&quot;, mostDownloaded.ToArray());&#xA;    ViewData.Add(&quot;presentationsOfDay&quot;, presentationOfDay);&#xA;    ViewData[&quot;Tags&quot;] = _presentationService.GetPopularTags();&#xA;&#xA;    return View();&#xA;}&#xA;&#xA;Notice the first call?&#xA;&#xA;private void GetFeaturedPresentations()&#xA;{&#xA;    try {&#xA;        //*** Dummy call to the Presentation Service to get the Featured presentations,&#xA;        //*** this call is place because, an exception thrown from the Data layered on first hit to the DB (failed to open DB) &#xA;        //*** and the second hit to the DB gets success.&#xA;        _presentationService.GetFeaturedPresentations();&#xA;    }&#xA;    catch (Exception)&#xA;    { /*do nothing with this exception*/ }&#xA;}&#xA;&#xA;I really like it when you work around a bug instead of actually fix it.&#xA;&#xA;Moving on, let us look at the service layer. Most of it looks like this:&#xA;&#xA;public ADs GetAdById(string adId)&#xA;{&#xA;    try&#xA;    {&#xA;        string key = &quot;Ads-&quot; &#x2B; adId;&#xA;        ADs data = cacheService.Get&lt;ADs&gt;(key);&#xA;        if (data == null)&#xA;        {&#xA;            data = provider.GetAdById(adId.ToGuid());&#xA;            if (data != null &amp;&amp; data.Image != null)&#xA;            {&#xA;                cacheService.Add(key, data as Object, null, DateTime.MaxValue, new TimeSpan(0, 10, 0), System.Web.Caching.CacheItemPriority.Normal, null);&#xA;            }&#xA;        }&#xA;        return data;&#xA;&#xA;    }&#xA;    catch (Exception ex)&#xA;    {&#xA;        bool rethrow = ExceptionPolicy.HandleException(ex, &quot;Service Policy&quot;);&#xA;        if (rethrow &amp;&amp; WebOperationContext.Current == null)&#xA;        {&#xA;            throw;&#xA;        }&#xA;        return null;&#xA;    }&#xA;}&#xA;&#xA;I am not joking about all of them looking alike, by the way, it is obviously has been cut &amp; paste a lot.&#xA;&#xA;Nitpick, &#x201C;data as Object&#x201D; &#x2013; that is not something you often see. But this is even better (from CacheService):&#xA;&#xA; &#xA;&#xA;I like how we have a cacheService but we coupled its interface with System.Web.Caching, or the fact that most of this code is just a very long winded way of calling GetAdById.&#xA;&#xA;But wait, I spared you the method documentation, which is a real masterpiece:&#xA;&#xA;/// &lt;summary&gt;&#xA;/// Returns Advertisment.&#xA;/// &lt;/summary&gt;&#xA;/// &lt;param name=&quot;adId&quot;&gt; GUID of an Advertisment&lt;/param&gt;&#xA;/// &lt;returns&gt;Ads&lt;/returns&gt;&#xA;public ADs GetAdById(string adId)&#xA;&#xA;Yes, the adId is a string which is a guid. We are so lucky to work with VARIANT again, right?&#xA;&#xA;Let us take another method, just to see what is going on in a typical method inside the project. I intentionally avoid the ones that we already looked at. I took a peek at CommunityController and found the Index method:&#xA;&#xA;[AcceptVerbs(HttpVerbs.Post)]&#xA;public ActionResult Index(string type, string section, string subSection, string page)&#xA;{&#xA;    if (type != &quot;widget&quot;)&#xA;        return new ContentResult { Content = &quot;&quot; };&#xA;&#xA;    int pageNo = 1;&#xA;    Int32.TryParse(page, out pageNo);&#xA;    if (pageNo == 0)&#xA;        pageNo = 1;&#xA;&#xA;    if (section == &quot;members&quot;)&#xA;    {&#xA;        List&lt;UserSummary&gt; users = null;&#xA;&#xA;        switch (subSection)&#xA;        {&#xA;            case &quot;members-new&quot;:&#xA;                users = _communityService.GetNewUsers(8, pageNo);&#xA;                break;&#xA;            case &quot;members-mostactive&quot;:&#xA;                users = _communityService.GetMostActiveUsers(8, pageNo);&#xA;                break;&#xA;            case &quot;members-all&quot;:&#xA;                users = _communityService.GetAllUsers(8, pageNo);&#xA;                break;&#xA;            default:&#xA;                users = _communityService.GetAllUsers(8, pageNo);&#xA;                break;&#xA;        }&#xA;&#xA;        return View(&quot;MembersList&quot;, users);&#xA;    }&#xA;    else if (section == &quot;groups&quot;)&#xA;    {&#xA;        List&lt;Group&gt; groups = null;&#xA;&#xA;        switch (subSection)&#xA;        {&#xA;            case &quot;groups-new&quot;:&#xA;                groups = _communityService.GetNewGroups(8, pageNo);&#xA;                break;&#xA;            case &quot;groups-mostactive&quot;:&#xA;                groups = _communityService.GetMostActiveGroups(8, pageNo);&#xA;                break;&#xA;            case &quot;groups-all&quot;:&#xA;                groups = _communityService.GetAllGroups(8, pageNo);&#xA;                break;&#xA;            default:&#xA;                groups = _communityService.GetAllGroups(8, pageNo);&#xA;                break;&#xA;        }&#xA;&#xA;        return View(&quot;GroupsList&quot;, groups);&#xA;    }&#xA;    else if (section == &quot;favourites&quot;)&#xA;    {&#xA;        List&lt;PresentationSummary&gt; favouritePresentation = _communityService.GetCommunityFavorite(10, pageNo);&#xA;        return View(&quot;PresentationsView&quot;, favouritePresentation.ToArray());&#xA;    }&#xA;&#xA;&#xA;    return new ContentResult { Content = &quot;&quot; };&#xA;}&#xA;&#xA;Let me see how many things I can find in a cursory examination:&#xA;&#xA;&#xA;  Hard coding galore&#xA;&#xA;  Long method&#xA;&#xA;  Complex method&#xA;&#xA;  Controller method return several different views&#xA;&#xA;&#xA;And note that I am still not even trying for the architectural concepts or code quality metrics. That I&#x2019;m going to leave to another post.&#xA;&#xA;Frankly, I am seeing way too much bad things in the code to overview all of them. I am going to stop with a goodie, though. &#xA;&#xA;Let us explore GroupRepository.GetGroup, shall we?&#xA;&#xA; private Group GetGroup(Guid groupId, KobeEntities Context)&#xA; {&#xA;     try&#xA;     {&#xA;         Group group = Context.GroupSet&#xA;                          .Where(g =&gt; g.GroupId == groupId)&#xA;                          .FirstOrDefault();&#xA;&#xA;         if (group == null)&#xA;             throw new DataException(&quot;Invalid Group Id&quot;, null);&#xA;&#xA;         return group;&#xA;     }&#xA;     catch (Exception ex)&#xA;     {&#xA;&#xA;         bool rethrow = ExceptionPolicy.HandleException(ex, &quot;Data Policy&quot;);&#xA;         if (rethrow)&#xA;         {&#xA;             throw;&#xA;         }&#xA;         return null;&#xA;     }&#xA; }&#xA;&#xA;On the face of it, except for the repeated stupid error handling, there doesn&#x2019;t seems to be something wrong here, right?&#xA;&#xA;Take note for the different parameter casing on the GetGroup, though. Why is KobeEntities PascalCase? Well, that is because there is also a property called Context on the GroupRepository that you might use by accident. So, what is this Context parameter all about? GetGroup is a private method, who is calling it?&#xA;&#xA;Here is one such callsite:&#xA;&#xA; public void AddGroupInterests(Guid groupId, string[] interests, Guid userId)&#xA; {&#xA;     try&#xA;     {&#xA;         KobeEntities _context = Context;&#xA;&#xA;         Group group = GetGroup(groupId, _context);&#xA;         User user = GetUser(userId, _context);&#xA;&#xA;So, we take the Context property, put it in a _context local variable. Then we pass it to GetGroup, which uses it.&#xA;&#xA;I must say that I am at a loss to understand what was going on in the mind of whoever wrote it. Was he trying to optimize the number of time we access the property?&#xA;&#xA;As I said, I am currently writing a few other posts about Kobe, this was just to get to see the code itself, so we have an impression about its quality.&#xA;&#xA;I am&#x2026; not impressed.</p>
        </article>
        <article id="article-5928">
            <a href="https://ayende.com/blog/3948/nhibernate-mapping-named-queries-query-and-sql-query" target="_blank">
                <h2 class="title mb-6" id="article-5928">NHibernate Mapping &#x2013; Named queries &lt;query/&gt; and &lt;sql-query/&gt;</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 17, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Queries are business logic, as such, they can be pretty complex, and they also tend to be pretty perf sensitive. As such, you usually want to have a good control over any complex queries. You can do that by extracting your queries to the mapping, so they don&#x2019;t reside, hardcoded, in the code:     &lt;query name=&quot;PeopleByName&quot;&gt;&#xA;&#x9;from Person p&#xA;&#x9;where p.Name like :name&#xA;&lt;/query&gt;&#xA;&#xA;&#xA;And you can execute it with:&#xA;&#xA;&#xA;  using (var session = sessionFactory.OpenSession())&#xA;using (var tx = session.BeginTransaction())&#xA;{&#xA;&#x9;session.GetNamedQuery(&quot;PeopleByName&quot;)&#xA;&#x9;&#x9;.SetParameter(&quot;name&quot;, &quot;ayende&quot;)&#xA;&#x9;&#x9;.List();&#xA;&#x9;tx.Commit();&#xA;}&#xA;&#xA;&#xA;PeopleByName is a pretty standard query, and executing this code will result in:&#xA;&#xA; &#xA;&#xA;Now, let us say that we discovered some performance problem in this query, and we want to optimize it. But the optimization is beyond what we can do with HQL, we have to drop to a database specific SQL for that. Well, that is not a problem, &lt;sql-query/&gt; is coming to the rescue.&#xA;&#xA;All you need is to replace the query above with:&#xA;&#xA;&#xA;  &lt;sql-query name=&quot;PeopleByName&quot;&gt;&#xA;&#x9;&lt;return alias=&quot;person&quot;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;class=&quot;Person&quot;/&gt;&#xA;&#x9;SELECT {person.*}&#xA;&#x9;FROM People {person} WITH(nolock)&#xA;&#x9;WHERE {person}.Name LIKE :name&#xA;&lt;/sql-query&gt;&#xA;&#xA;&#xA;And you are set. You don&#x2019;t need to make any changes to the code, but the resulting SQL would be:&#xA;&#xA; &#xA;&#xA;Fun, isn&#x2019;t it?</p>
        </article>
        <article id="article-5929">
            <a href="https://ayende.com/blog/3947/nhibernate-mapping-database-object" target="_blank">
                <h2 class="title mb-6" id="article-5929">NHibernate mapping - &lt;database-object/&gt;</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 16, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I, like many, have grown used to NHibernate&#x2019;s schema generation capabilities. Those make working with databases such a pleasure that I cannot imagine trying without them.  However, at some point, even NHibernate&#x2019;s smarts reach an end, and such an occasion requires the use of direct SQL to manipulate the database directly. A good example of that would be:     &lt;!-- SQL Server need this index --&gt;&#xA;&lt;database-object&gt;&#xA;&#x9;&lt;create&gt;&#xA;&#x9;CREATE INDEX PeopleByCityAndLastName ...&#xA;&#x9;&lt;/create&gt;&#xA;&#x9;&lt;drop&gt;&#xA;&#x9;DROP INDEX PeopleByCityAndLastName &#xA;&#x9;&lt;/drop&gt;&#xA;&#x9;&lt;dialect-scope name=&quot;NHibernate.Dialect.MsSql2000Dialect&quot;/&gt;&#xA;&#x9;&lt;dialect-scope name=&quot;NHibernate.Dialect.MsSql2005Dialect&quot;/&gt;&#xA;&#x9;&lt;dialect-scope name=&quot;NHibernate.Dialect.MsSql2008Dialect&quot;/&gt;&#xA;&lt;/database-object&gt;&#xA;&#xA;&lt;!-- Oracle need this stats only --&gt;&#xA;&lt;database-object&gt;&#xA;&#x9;&lt;create&gt;&#xA;&#x9;CREATE STATISTICS PeopleByCityAndLastName ...&#xA;&#x9;&lt;/create&gt;&#xA;&#x9;&lt;drop&gt;&#xA;&#x9;DROP STATISTICS PeopleByCityAndLastName &#xA;&#x9;&lt;/drop&gt;&#xA;&#x9;&lt;dialect-scope name=&quot;NHibernate.Dialect.OracleDialect&quot;/&gt;&#xA;&#x9;&lt;dialect-scope name=&quot;NHibernate.Dialect.Oracle9Dialect&quot;/&gt;&#xA;&lt;/database-object&gt;&#xA;&#xA;&#xA;As you can see, this allows us to execute database specific SQL, using the dialect scope. It is not a common feature, but it can be incredibly useful.</p>
        </article>
        <article id="article-5930">
            <a href="https://ayende.com/blog/3946/nhibernate-mapping-concurrency" target="_blank">
                <h2 class="title mb-6" id="article-5930">NHibernate Mapping - Concurrency</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 15, 2009
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">NHibernate has several concurrency models that you can use:     None     Optimistic             Dirty         All             Versioned             Numeric         Timestamp         DB timestamp             Pessimistic    We will explore each of those in turn.  None basically means that we fall back to the transaction semantics that we use in the database. The database may throw us out, but aside from that, we don&#x2019;t really care much about things.  Optimistic is more interesting. It basically states that if we detect a change in the entity, we cannot update it. Let us see a simple example of using optimistic dirty checking for changed fields only:     &lt;class name=&quot;Person&quot;&#xA;&#x9;&#x9;&#x9; optimistic-lock=&quot;dirty&quot;&#xA;&#x9;&#x9;&#x9; dynamic-update=&quot;true&quot;&#xA;&#x9;&#x9;&#x9; table=&quot;People&quot;&gt;&#xA;&#xA;&#xA;Using this with this code:&#xA;&#xA;&#xA;  using (var session = sessionFactory.OpenSession())&#xA;using (var tx = session.BeginTransaction())&#xA;{&#xA;&#x9;var person = session.Get&lt;Person&gt;(1);&#xA;&#x9;person.Name = &quot;other&quot;;&#xA;&#x9;tx.Commit();&#xA;}&#xA;&#xA;&#xA;Will result in:&#xA;&#xA; &#xA;&#xA;Note that we have so specify dynamic-update to true. This is required because doing so will generally cause much greater number of query plan to exist in the database cache.&#xA;&#xA;Setting optimistic-lock to all would result in:&#xA;&#xA; &#xA;&#xA;If the update fails because the row was updated, we will get a StaleObjectException. Like all exceptions, this will make the session ineligible for use, and you would have to create a new session to handle it.&#xA;&#xA;Usually a better strategy is to use an explicit version column. We can do it by specifying &lt;version/&gt;:&#xA;&#xA;&#xA;  &lt;version name=&quot;Version&quot; column=&quot;Version&quot;/&gt;&#xA;&#xA;&#xA;And that would result in:&#xA;&#xA;&#xA;&#xA; &#xA;&#xA;As you can probably guess, if the version doesn&#x2019;t match, we will get StaleObjectException.&#xA;&#xA;Instead of using numeric values, we can use a timestamp:&#xA;&#xA;&#xA;  &lt;version name=&quot;Version&quot; column=&quot;Version&quot; type=&quot;timestamp&quot;/&gt;&#xA;&#xA;&#xA;In this case, the property type should be DateTime, and the resulting SQL would be:&#xA;&#xA; &#xA;&#xA;This is, of course, a less safe way of doing things, and I recommend that you would use a numeric value instead.&#xA;&#xA;Another option is to use the database facilities to handle that. in MS SQL Server, this is the TimeStamp column, which is a 8 byte binary that is changed any time that the row is updated.&#xA;&#xA;We do this by changing the type of the Version property to byte array, and changing the mapping to:&#xA;&#xA;&#xA;  &lt;version name=&quot;Version&quot;&#xA;&#x9;&#x9;&#x9;&#x9; generated=&quot;always&quot;&#xA;&#x9;&#x9;&#x9;&#x9; unsaved-value=&quot;null&quot;&#xA;&#x9;&#x9;&#x9;&#x9; type=&quot;BinaryBlob&quot;&gt;&#xA;&#x9;&lt;column name=&quot;Version&quot;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;not-null=&quot;false&quot;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;sql-type=&quot;timestamp&quot;/&gt;&#xA;&lt;/version&gt;&#xA;&#xA;&#xA;Executing the code listed above will result in:&#xA;&#xA; &#xA;&#xA;We use the value of the timestamp to ensure that we aren&#x2019;t overwriting the row data after it was changed. The database will ensure that the row timestamp will change whenever the row itself is updated. This plays well with system where you may need to update the underlying tables outside of NHibernate.&#xA;&#xA;Pessimistic concurrency is also expose with NHibernate, by using the overloads that takes a LockMode. This is done in a database independent way, using each database facilities and syntax.&#xA;&#xA;For example, let us example the following code:&#xA;&#xA;using (var session = sessionFactory.OpenSession())&#xA;using (var tx = session.BeginTransaction())&#xA;{&#xA;&#x9;var person = session.Get&lt;Person&gt;(1,LockMode.Upgrade);&#xA;&#x9;person.Name = &quot;other&quot;;&#xA;&#x9;tx.Commit();&#xA;}&#xA;&#xA;This will result in the following SQL:&#xA;&#xA; &#xA;&#xA;We can also issue a separate command to the database to obtain a lock on the row representing the entity:&#xA;&#xA;using (var session = sessionFactory.OpenSession())&#xA;using (var tx = session.BeginTransaction())&#xA;{&#xA;&#x9;var person = session.Get&lt;Person&gt;(1);&#xA;&#x9;session.Lock(person, LockMode.Upgrade);&#xA;&#x9;person.Name = &quot;other&quot;;&#xA;&#x9;tx.Commit();&#xA;}&#xA;&#xA;The Get() would generate a standard select, without the locks, but the Lock() method would generate the following SQL:&#xA;&#xA; &#xA;&#xA;The behavior for conflict in this case is very simple, we wait. If we wait for too long, the timeout will expire and we will get a timeout exception, because we could not obtain the lock.&#xA;&#xA;That is consistent with how we would use pessimistic concurrency elsewhere.</p>
        </article>
        <div class="button flex justify-between">
            <a href="592.html"><span class="back arrow"></span></a>

            <a href="594.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>