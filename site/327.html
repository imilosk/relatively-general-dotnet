
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/157889/improving-map-reduce-performance-in-ravendb" target="_blank"><h1 class="title mb-6">Improving Map/Reduce performance in RavenDB</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 21, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This is another stream of conciseness post, with me trying to figure out what is the best way to resolve a given problem.&#xA;&#xA;&#x9;Update: I ended up solving this in a drastically different way. I&#x27;ll post about this later on. I am keeping this here because it is a good post about how I think about a problem.&#xA;&#xA;&#x9;A while ago, I posted a visual description of how Map/Reduce is supposed to work. That was while I was working on RavenDB map/reduce implementation, but that isn&#x2019;t actually how the current RavenDB map/reduce works.&#xA;&#xA;&#x9;Instead, it works like this:&#xA;&#xA;&#x9;Map phase:&#xA;&#xA;&#x9;for item in docs:&#xA;   for result in reduce(map(item)):&#xA;        Persist(item.id, result.key, result)&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And the reduce phase:&#xA;&#xA;&#x9;for result in reduce(results):&#xA;     WriteToIndex(result)&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;There are a few things that are interesting here.&#xA0; First, we have both map and reduce run during the map phase, why is that?&#xA;&#xA;&#x9;Well, to do an immediate reduction of the values, of course. This has two major benefits.&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;It means that in the reduce phase, the reduce accepts the output of the reduce &#x2013; this is important because it prepare us for the next step that we would have to do, multiple reduce steps.&#xA;&#x9;&#xA;&#x9;&#x9;Second, it means that if you have multiple results from the same documents that share the same key, they would be reduced immediately, rather than have multiple results with the same key.&#xA;&#xA;&#xA;&#x9;You might notice an issue with the code above, though. It seems like we are only running reduce once, and only once.&#xA;&#xA;&#x9;Indeed, this is how RavenDB 1.0 behaves. It only run the reduce once, regardless of how many entries you have per key.&#xA;&#xA;&#x9;Wait! I probably need to explain things. Let us talk for a second about the following map/reduce index:&#xA;&#xA;&#x9;//map&#xA;from order in docs.Orders&#xA;from line in order.OrderLines&#xA;select new&#xA;{&#xA;   line.Product,&#xA;   line.Qty&#xA;}&#xA;&#xA;//reduce&#xA;from result in results&#xA;group result by result.Product into g&#xA;select new&#xA;{&#xA;    Product = g.Key,&#xA;    Qty = g.Sum(x=&gt;x.Qty)&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;Now, if we have an order with two line items for the same product, they would be immediately reduced (on the same document) and saved as the map results.&#xA;&#xA;&#x9;Now, the reduce key in this case is the line item product. So when we execute the reduce, we load all the map results that share the same reduce key and run them through the reduce function together.&#xA;&#xA;&#x9;As I said, this is how RavenDB 1.0 behaves. And it works really nicely, except that it behave less nicely if you have a lot of results for the same reduce key. What happen if we had a really popular product, that was purchased by a million different order?&#xA;&#xA;&#x9;Every time that we would get a new order for this product, we would have to re-reduce the entire set. That means that we would have to re-reduce 1 millions items.&#xA;&#xA;&#x9;We recently got a problem when one of our customers run into an issue with running map/reduce indexes over the entire US census data. One of the problematic indexes was something like:&#xA;&#xA;&#x9;//map &#xA;from person in docs.CensusPeople&#xA;select new&#xA;{&#xA;  person.State,&#xA;  Count = 1&#xA;}&#xA;&#xA;//reduce&#xA;from result in results&#xA;group result by result.State into g&#xA;select new&#xA;{&#xA;  State = g.Key,&#xA;  Count = g.Sum(x=&gt;x.Count)&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;As you can imagine, this sort of thing is going to have a lot of items for the same key.&#xA;&#xA;&#x9;For example, for California, we would need to run reduce over about 38 million items, and for Texas it would be over 25 million items. This is really not what we had in mind, so we turned to a long standing bug in RavenDB and started to implement multi step reduce.&#xA;&#xA;&#x9;The issue is how to do so. Ideally, we do not want to have to make any changes between map/reduce indexes that have a large number of items per key and map/reduce indexes that have small number of indexes per key.&#xA;&#xA;&#x9;The question is how to do this, and how to make sure that we don&#x2019;t affect the overall system performance. As I mentioned before, it is very easy to modify things to fit one particular scenario, while forgetting all about the other scenarios.&#xA;&#xA;&#x9;Things get interesting after that, and here is where you might get lost, because this part is mostly written from the point of view of the implementers.&#xA;&#xA;&#x9;The actual behavior of the system in the map phase is more complex, because we need to invalidate old items, it looks more like this:&#xA;&#xA;&#x9;for item in docs:&#xA;   keys = DeleteMapResultsFor(item.id)&#xA;   for result in reduce(map(item)):&#xA;           keys.Remove(result.key)&#xA;        Persist(item.id, result.key, result)&#xA;   ReReduceRemovedKeys(keys)&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;Instead of this, we will have this:&#xA;&#xA;&#x9;for item in docs:&#xA;   result = DeleteMapResultsFor(item.id)&#xA;   keys = new HashSet&lt;string&gt;(result.Select(x=&gt;x.Key))&#xA;   lookups = result.ToLookup(x=&gt;new {x.id, x.key})&#xA;&#xA;   for result in reduce(map(item)):&#xA;           keys.Remove(result.key)&#xA;           int bucketId&#xA;           if not lookups.TryFind(new { item.Id, result.key}, out bucketId):&#xA;               bucketId = -1&#xA;        Persist(item.id, result.key, bucketId, result)&#xA;   ReReduceRemovedKeys(keys)&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;Note that we now have the notion of a bucket, and by default that bucket is set to &#x2013;1. But note that we keep the same bucketId if it already has one, this will be important later on.&#xA;&#xA;&#x9;The interesting thing happens in the reduce phase:&#xA;&#xA;&#x9;def Reduce(string key, int level):&#xA;    bool hasMore =  true&#xA;    bool hadMore = false&#xA;    while hasMore:&#xA;        results = GetMappedResults(key, level, out hasMore)&#xA;        hadMore |= hasMore&#xA;        if hasMore:&#xA;            newBucketId = GetNewBucketId(key, level)&#xA;            UpdateBucketId(results, newBucketId)&#xA;        for result in reduce(results):&#xA;                Persist(key, level &#x2B;1, result)&#xA;                if not hadMore:&#xA;                    WriteToIndex(key, result)&#xA;    if hadMore:&#xA;        ScheduleReduce(key, level &#x2B;1)&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;Here is where the important things happen. If we have less than 1,024 items for the same key, we just proceed normally, there is nothing to see there.&#xA;&#xA;&#x9;If we have more than that, then we create a bucket for all of those results and schedule a re-reduce for the next level up.&#xA;&#xA;&#x9;In other words, it looks like this, here it the map phase, notice that we start out with all of the bucket ids being &#x2013;1.&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;When running the reduce phase with level = 0, we get three buckets, like this:&#xA;&#xA;&#x9;&#xA0;&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;Which we now need to re-reduce again, this is where we are called with level = 1. Let us assume that the results of bucket 1 &amp; 2 are over 1,024 still, so we will have:&#xA;&#xA;&#x9;&#xA0;&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;And finally:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;&#xA0;&#xA;&#xA;&#x9;So far, this looks nice, but there are several practical problems that we still need to solve.&#xA;&#xA;&#x9;To start with, when does this end? We have users who write map/reduce queries like this:&#xA;&#xA;&#x9;//map #1&#xA;from customer in docs.Customers&#xA;select new &#xA;{&#xA;   CustomerId = customer.Id,&#xA;   CustomerName = customer.Name,&#xA;   OrderId = (string)null,&#xA;}&#xA;&#xA;// map #2&#xA;from order in docs.Orders&#xA;select new&#xA;{&#xA;  order.CustomerId,&#xA;  CustomerName = (string)null,&#xA;  OrderId = order.Id&#xA;}&#xA;&#xA;//reduce&#xA;from result in results&#xA;group result by result.CustomerId into g&#xA;let name = g.FirstOrDefault(x=&gt;x.CustomerName!=null).CustomerName&#xA;from item in g&#xA;select new&#xA;{&#xA;   CustomerId = g.Key,&#xA;   CustomerName = name,&#xA;   item.OrderId&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;This is a frowned upon (but working) way of allow you to query and sort by the customer name while searching for indexes. The problem with this method is that if we have 15,000 orders per customer, we are going to have the same number come out of the reduce phase as well.&#xA;&#xA;&#x9;Now, the reason this is frowned upon? Because while this is using map/reduce, it isn&#x2019;t actually&#x2026; you know.. reducing the data. In order to resolve this issue, we are going to make sure that all of the items generated from a single reduce step will always go into the same bucket. This will mean that we keep pretty much the same behavior as we have now, it is going to be inefficient, but that was always going to be the case.&#xA;&#xA;&#x9;We are also going to limit the number of levels to three, which still gives us the ability to handle over a billion results before a reduce phase would need to see more than 1,024 items at once.&#xA;&#xA;&#x9;Take the California example, we would have 37,691,912 people, each of them reduce to 37,691,912 map results at bucket &#x2013;1. Then we have 36,809 buckets for the second level. And finally 35 levels at the third level. All of which are computed for the final result.&#xA;&#xA;&#x9;The next step from here is to actually handle updates, which means that we have to keep track of the bucket ids going forward, so we start with deleting a person, which means that we need to delete their map result. Which means that we need to re-reduce the bucket they belong to at the appropriate level, and then upward, etc. In total, we would have to compute 1,024 &#x2B; 1,024 &#x2B; 35 items, instead of 37,691,912.&#xA;&#xA;&#x9;Okay, enough talking, let us see if I straighten things out enough for me to actually be able to implement this.</p>
        <a href="https://ayende.com/blog/157825/businesses-that-are-a-joy-to-work-with-skills-matter" target="_blank"><h1 class="title mb-6">Businesses that are a joy to work with: Skills Matter</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 20, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I don&#x2019;t believe that I ever did this, but I was just completely blown away by Skills Matter. Please note, I never actually dealt with them as a student, although I got great feedback from the people I taught about them in that capacity. I am talking here solely about dealing with them as a service provider. I have been working with them since 2008, and we have a great working relationship. I am routinely dealing with many businesses, and almost always you have this&#x2026; friction. I usually have great rapport with the technical people with whom I work, but then it comes to dealing with other departments, it can be&#x2026; annoying. With Skills Matter, not only was it never the case. They go out of their way to make it easy and fun to work for them.&#xA0; I can&#x2019;t talk about the &#x201C;straw that broke the camel&#x2019;s back&#x201D; and was the trigger for this post, but I can talk about some other things. From spreading the word about RavenDB and NHibernate by organising talks with me for the Skills Matter community to helping me with a payment dispute that I had with a hotel (that I reserved, but they took care of all the details of getting my money back and saved me tons of international calls an angst) to being willing and able to accommodate screw ups (oops, I missed the plane) in the most pleasant way possible and all the stuff they do for the developer community. In my time working with them, I found them to be honest, hardworking, professional, ethical and in general Very Good People.</p>
        <a href="https://ayende.com/blog/157761/ravendb-awesome-feature-of-the-day-formatted-indexes" target="_blank"><h1 class="title mb-6">RavenDB Awesome Feature of the Day, Formatted Indexes</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 17, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There is a chance that you&#x2019;ll look at me strangely for calling this the &#x201C;Feature of the Day&#x201D;. But that is actually quite a important little feature.&#xA;&#xA;&#x9;Here is the deal, let us say that you have the following index:&#xA;&#xA;&#x9;public class Orders_Search : AbstractIndexCreationTask&lt;Order, Orders_Search.ReduceResult&gt;&#xA;{&#xA;    public class ReduceResult&#xA;    {&#xA;        public string Query { get; set; }&#xA;        public DateTime LastPaymentDate { get; set; }&#xA;    }&#xA;&#xA;    public Orders_Search()&#xA;    {&#xA;        Map = orders =&gt; from order in orders&#xA;                        let lastPayment = order.Payments.LastOrDefault()&#xA;                        select new&#xA;                        {&#xA;                            Query = new object[]&#xA;                            {&#xA;                                order.FirstName, &#xA;                                order.LastName, &#xA;                                order.OrderNumber, &#xA;                                order.Email, &#xA;                                order.Email.Split(&#x27;@&#x27;),&#xA;                                order.CompanyName,&#xA;                                order.Payments.Select(payment =&gt; payment.PaymentIdentifier),&#xA;                                order.LicenseIds&#xA;                            },&#xA;                            LastPaymentDate = lastPayment == null ? order.OrderedAt : lastPayment.At&#xA;                        };&#xA;    }&#xA;}&#xA;&#xA;&#x9;&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And you are quite happy with it. But that is the client side perspective. We don&#x2019;t have any types on the server, so you can&#x2019;t just execute this there. Instead, we send a string representing the index to the server. That string is actually the output of the linq expression, which looks like this:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;&#xA;&#xA;&#xA;&#x9;This is&#x2026; somewhat hard to read, I think you&#x2019;ll agree. So we had some minimal work done to improve this, and right now what you&#x2019;ll get is (you&#x2019;ll likely see it roll off the screen, that is expected):&#xA;&#xA;&#x9;docs.Orders&#xA;    .Select(order =&gt; new {order = order, lastPayment = order.Payments.LastOrDefault()})&#xA;    .Select(__h__TransparentIdentifier0 =&gt; new {Query = new System.Object []{__h__TransparentIdentifier0.order.FirstName, __h__TransparentIdentifier0.order.LastName, __h__TransparentIdentifier0.order.OrderNumber, __h__TransparentIdentifier0.order.Email, __h__TransparentIdentifier0.order.Email.Split(new System.Char []{&#x27;@&#x27;}), __h__TransparentIdentifier0.order.CompanyName, __h__TransparentIdentifier0.order.Payments&#xA;    .Select(payment =&gt; payment.PaymentIdentifier), __h__TransparentIdentifier0.order.LicenseIds}, LastPaymentDate = __h__TransparentIdentifier0.lastPayment == null ? __h__TransparentIdentifier0.order.OrderedAt : __h__TransparentIdentifier0.lastPayment.At})&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;This is still quite confusing, actually. But still better than the alternative.&#xA;&#xA;&#x9;As I said, it seems like a little thing, but those things are important. An index in its compiled form that is hard to understand for a user is a support issue for us. We needed to resolve this issue.&#xA;&#xA;&#x9;The problem is that source code beautifying is non trivial. I started playing with parsers a bit, but it was all way too complex. Then I had an epiphany. I didn&#x2019;t actually care about the code, I just wanted it sorted. There aren&#x2019;t many C# code beautifiers around, but there are a lot for JavaScript.&#xA;&#xA;&#x9;I started with the code from http://jsbeautifier.org/, which Rekna Anker had already ported to C#. From there, it was an issue of making sure that for my purposes, the code generated the right output. I had to teach it C# idioms such as @foo, null coalescent and lambda expressions, but that sounds harder than it actually was. With that done, we go this output:&#xA;&#xA;&#x9;docs.Orders.Select(order =&gt; new {&#xA;    order = order,&#xA;    lastPayment = order.Payments.LastOrDefault()&#xA;}).Select(__h__TransparentIdentifier0 =&gt; new {&#xA;    Query = new System.Object[] {&#xA;        __h__TransparentIdentifier0.order.FirstName,&#xA;        __h__TransparentIdentifier0.order.LastName,&#xA;        __h__TransparentIdentifier0.order.OrderNumber,&#xA;        __h__TransparentIdentifier0.order.Email,&#xA;        __h__TransparentIdentifier0.order.Email.Split(new System.Char[] {&#xA;            &#x27;@&#x27;&#xA;        }),&#xA;        __h__TransparentIdentifier0.order.CompanyName,&#xA;        __h__TransparentIdentifier0.order.Payments.Select(payment =&gt; payment.PaymentIdentifier),&#xA;        __h__TransparentIdentifier0.order.LicenseIds&#xA;    },&#xA;    LastPaymentDate = __h__TransparentIdentifier0.lastPayment == null ? __h__TransparentIdentifier0.order.OrderedAt : __h__TransparentIdentifier0.lastPayment.At&#xA;})&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And this is actually much better. Still not good enough, mind. we can do better than that. It is a simple change:&#xA;&#xA;&#x9;docs.Orders.Select(order =&gt; new {&#xA;    order = order,&#xA;    lastPayment = order.Payments.LastOrDefault()&#xA;}).Select(this0 =&gt; new {&#xA;    Query = new System.Object[] {&#xA;        this0.order.FirstName,&#xA;        this0.order.LastName,&#xA;        this0.order.OrderNumber,&#xA;        this0.order.Email,&#xA;        this0.order.Email.Split(new System.Char[] {&#xA;            &#x27;@&#x27;&#xA;        }),&#xA;        this0.order.CompanyName,&#xA;        this0.order.Payments.Select(payment =&gt; payment.PaymentIdentifier),&#xA;        this0.order.LicenseIds&#xA;    },&#xA;    LastPaymentDate = this0.lastPayment == null ? this0.order.OrderedAt : this0.lastPayment.At&#xA;})&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And now we got to something far more readable .</p>
        <a href="https://ayende.com/blog/157985/uber-profiler-v2-0-private-beta-is-open" target="_blank"><h1 class="title mb-6">&#xDC;ber Profiler v2.0&#x2013;Private Beta is open</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 16, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Well, it took a while, but the next version of the NHibernate Profiler is ready to go to a private beta. We go to private beta before the product is done, because we want to get as much early feedback as we can. We have 10 spots for NHibernate Profiler v2.0 and 10 spots for Entity Framework Profiler v2.0. If you are interested, please send me an email about this.</p>
        <a href="https://ayende.com/blog/157793/the-features-that-no-one-talks-about-makes-all-the-difference" target="_blank"><h1 class="title mb-6">The &#x201C;features&#x201D; that no one talks about makes all the difference</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 15, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">You might have noticed that I am talking a lot about support and operations recently.&#xA0; This is because we have been doing a lot of work around that area. Making sure that RavenDB is even more forthcoming and open about what is going on. This week it has been about making sure that the shutdown phase of RavenDB is as transparent as it could be. Debugging those sort of issues is a PITA, because you very rarely really stop to consider them. But we got some feedback from customers about a common set of issues there. Under some circumstances, shutting down RavenDB might take a while. We identified several things that can cause this, mostly indexing in progress. The first thing we did is change the way we are doing indexing to allow aborting them during shutdown, but there are still a set of operations that might take a while that we have to complete even in shutdown scenario. For example, we might be just in the middle of flushing to disk, and we really want that to complete successfully (otherwise we would need to run an expensive check on startup). Therefor, we added this:  You&#x2019;ll still have to wait, sure. But now if you watch the logs you can see why, and have some understanding about how long this is going to take.</p>
        <a href="https://ayende.com/blog/157953/new-in-ravendb-studio-1-2-low-bandwidth-mode" target="_blank"><h1 class="title mb-6">New in RavenDb Studio 1.2</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 14, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The full details are on our company blog. Note that this is especially relevant now, I am writing this from a low bandwidth connection.</p>
        <a href="https://ayende.com/blog/157633/feature-dependencies-chains" target="_blank"><h1 class="title mb-6">Feature dependencies chains</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 13, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I wanted to improve the RavenDB query optimizer, so it can merge similar indexes into a single index. It is actually fairly simple to do (conceptually). But that leaves us with the problem of what to do with the indexes that we just superseded. The whole point here is to reduce the number of indexes, not to create an index that will never be used. So the next step was to make sure that we can cleanup unused auto indexes. That is great&#x2026; Except that we don&#x2019;t have any way of tracking unused indexes, so before we could do that, we have to add tracking for query times. Okay, let us do that. Wait, we don&#x2019;t have a place to put those in, and anyway, we don&#x2019;t want to save it all the time, that would mean IO for every query, and what about concurrent queries? So we need to add a way to save this, and make sure that there is some batching going on in there, so we won&#x2019;t go to the disk all the time. And wait, there is this other feature over there that needs something similar, so we might as well solve both problems at once&#x2026; Okay, let us add that. Now, where were we again? That annoying thing about this? You only realize that those are actually problems when you run some deep analysis on the actual feature request. And usually you have to have multiple cycles to get it all out. It is also very easy to go down one branch, all the way to the bottom, then go up to another branch, which was opened up because of the work you just did. Make for a good workday, but make it harder to predict what you are going to do today.</p>
        <a href="https://ayende.com/blog/157409/oh-this-is-beautiful" target="_blank"><h1 class="title mb-6">OH: This is beautiful</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 10, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I just said that when I got this on the debugger:  I think that I need to get off the computer, and I&#x2019;ll do so, just as soon as I am done with this feature.</p>
        <a href="https://ayende.com/blog/157954/the-next-big-thing-in-ravendb-1-2" target="_blank"><h1 class="title mb-6">The next BIG Thing in RavenDB 1.2</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 10, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Is something that you probably wouldn&#x2019;t even notice, to be perfectly honest. We are going to work on our map/reduce implementation.  This is freakishly complex, because we need to do updatable, persistent map/reduce. It got so complex that I decided that I can&#x2019;t really implement this on my own in the RavenDB solution and moved to spiking the solution in isolation. If you care, you can look at this here. There would be additional optimizations to worry about in RavenDB, but it is pretty much all there, in less than 400 lines of code. I couldn&#x2019;t find anything out there which was nearly as useful. Most of the map/reduce implementations are about distributing the work load and scheduling it. None of them really deal with the notion of updatable map/reduce results. Note that the Storage layer there is both only there for the sole purpose of actually showing we can persist and restart from any point and also has critical behavior in its behavior (for example, scheduling). I&#x2019;ll probably do a set of posts about this, but for now, here is the source, have fun poking at it: https://github.com/ayende/updatable-persistent-map-reduce</p>
        <a href="https://ayende.com/blog/157537/i-hate-hello-world-questions" target="_blank"><h1 class="title mb-6">I hate Hello World questions</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: August 09, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">That is what I call things like this:  It was part of a question I was asked, and the question contained things like:  I&#x27;ve a field (Field2) in MyClass as nested Dictionary and i have an index for Field 1. There are several issues with this style of question:  It make it harder to answer, because you have to keep a mapping of that in your head. There is no meaning to the question, we can&#x2019;t figure out whatever this is a good or bad scenario. Usually the problem description contains references to the real model, which I haven&#x2019;t seen and don&#x2019;t know anything about. Annoying.</p>
        <div class="button flex justify-between">
            <a href="326.html"><span class="back arrow"></span></a>

            <a href="328.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>