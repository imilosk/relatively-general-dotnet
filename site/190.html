
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 190 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-1891">
            <a href="https://ayende.com/blog/187649-A/spatial-enhancement-in-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-1891">Spatial enhancement in RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 14, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A few days ago I talked about how you can use RavenDB&#x2019;s query functions to compute distances during queries.&#xA0; On the one hand, I&#x2019;m really happy that you can do that without having to wait for us to update RavenDB, on the other hand, I felt that this should really be us doing this. So I spent some time on spatial this week and we got a whole bunch of nice features out of it.The first new option is the ability to natively get the distance from a location as part of the query:You no longer need JS tricks to get this information.As you can see, I&#x2019;m just projecting the distance here, not sorting or filtering by it. This can be nice if you need to take into account multiple spatial operations. &#x201C;Find me the nearest coffee, but also show me how far it is from work&#x201D;, for example.The next spatial feature is shown in the following query, and I&#x2019;m going to be that you wouldn&#x2019;t notice it if I didn&#x2019;t mark it up:What does this do? Well, this tell RavenDB that we want to sort the movies by distance, but to round it up to 5km increments. This, in turn, means that the secondary sort, by Rating, is now much more meaningful.The output of this query is all a set of movies in that are up to 5 km from me, 5 &#x2013; 10km , 10 &#x2013; 15 km, etc. And inside each bucket, the results are sorted based on the rating descending.This handle the very common issue of users nor caring whatever something is 1.2 or 1.5 km away and wanting to sort by &#x201C;close, medium, far&#x201D; and then by other factors as well.</p>
        </article>
        <article id="article-1892">
            <a href="https://ayende.com/blog/187618-A/benchmarking-ravendb-bulk-insert-on-commodity-hardware" target="_blank">
                <h2 class="title mb-6" id="article-1892">Benchmarking RavenDB bulk insert on commodity hardware</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 13, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We got a few requests for some guidance on how to optimize RavenDB insert rate. Our current benchmark is standing at 135,000 inserts/sec on a sustained basis, on a machine that cost less than a 1,000$. However, some users tried to write their own benchmarks and got far less (about 50,000 writes / sec). Therefor, this post, in which I&#x2019;m going to do a bunch of things and see if I can make RavenDB write really fast.&#xA;&#xA;I&#x2019;m sorry, this is likely to be a long post. I&#x2019;m going to be writing this as I&#x2019;m building the benchmark and testing things out. So you&#x2019;ll get a stream of consciousness. Hopefully it will make sense.&#xA;Because of the size of this post, I decided to move most of the code snippets out. I created a repository just for this post, and I&#x2019;m showing my steps as I go along.&#xA;&#xA;Rules for this post:&#xA;&#xA;I&#x2019;m going to use the last stable version of RavenDB (4.2, at the time of writing)&#xA;Commodity hardware is hard to quantify, I&#x2019;m going to use AWS machines because they are fairly standard metric and likely where you&#x2019;re going to run it.&#xA;&#xA;Note that this does mean that we&#x2019;ll probably have less performance than if we were running on dedicated hardware.&#xA;Another thing to note (and we&#x2019;ll see later) is that I/O rate on the cloud is&#x2026; interesting topic.&#xA;&#xA;No special system setup&#xA;&#xA;Kernel config&#xA;Reformatting of hard disk&#xA;Changing RavenDB config parameters&#xA;&#xA;&#xA;The first thing to do is to figure out what we are going to write.&#xA;The test machine is:&#xA0; t3a.xlarge with 4 cores, 16 GB RAM. This seemed like a fairly reasonable machine to test with. I&#x2019;m using Ubuntu 18.04 LTS as the operating system.&#xA;The machine has an 8GB drive that I&#x2019;m using to host RavenDB and a separate volume for the data itself. I create a 512GB gp2 volume (with 1536 IOPS) to start with. Here what this looked like from inside the machine:&#xA;&#xA;I&#x2019;m including the setup script here for completeness, as you can see, there isn&#x2019;t really anything here that matters.&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          # setup the /data drive (512 GB)&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $ sudo mkfs -t ext4 /dev/nvme1n1&#xA;        &#xA;        &#xA;          &#xA;          $ sudo mkdir /data&#xA;        &#xA;        &#xA;          &#xA;          $ sudo mount /dev/nvme1n1 /data&#xA;        &#xA;        &#xA;          &#xA;          $ sudo chown -R $USER /data&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          # setup RavenDB (on home drive) &#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $ wget https://daily-builds.s3.amazonaws.com/RavenDB-4.2.0-linux-x64.tar.bz2&#xA;        &#xA;        &#xA;          &#xA;          $ tar xjf RavenDB-4.2.0-linux-x64.tar.bz2&#xA;        &#xA;        &#xA;          &#xA;           &#xA;        &#xA;        &#xA;          &#xA;          # setup RavenDB (in UNSECURE mode, don&#x27;t do this for real!)&#xA;        &#xA;        &#xA;          &#xA;          # I had a firewall covering me while this was running&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $ cat &gt; ./RavenDB/Server/settings.json &lt;&lt;EOF&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              &quot;ServerUrl&quot;: &quot;http://0.0.0.0:8080&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;Setup.Mode&quot;: &quot;None&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;Security.UnsecuredAccessAllowed&quot;: &quot;PublicNetwork&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;DataDir&quot;: &quot;RavenData&quot;,&#xA;        &#xA;        &#xA;          &#xA;              &quot;License.Eula.Accepted&quot;: true&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          EOF&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          # now let&#x27;s run RavenDB&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $ ./RavenDB/Server/Raven.Server&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          setup-raven.sh&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;Do note that I&#x2019;m going the quick &amp; dirty mode here without security, this is mostly so I can see what the impact of TLS on the benchmark is at a later point.&#xA;We are now pretty much ready, I think. So let&#x2019;s take a look at the first version I tried. Writing 100,000 random user documents like the following:&#xA;&#xA;As you can see, that isn&#x2019;t too big and shouldn&#x2019;t really be too hard on RavenDB. Unfortunately, I discovered a problem, the write speed was horrible.&#xA;&#xA;Oh wait, the problem exists between keyboard and chair, I was running that from my laptop, so we actually had to go about 10,000 KM from client to server. That&#x2026; is not a good thing.&#xA;Writing the data took almost 12 minutes. But at least this is easy to fix. I setup a couple of client machines on the same AZ and tried again. I&#x2019;m using spot instances, so I got a t3.large instance and a m5d.large instance.&#xA;That gave me a much nicer number, although still far from what I wanted to have.&#xA;&#xA;On the cloud machines, this takes about 23 - 25 seconds. Better than 12 minutes, but nothing to write home about.&#xA;One of the reasons that I wanted to write this blog post is specifically to go through this process, because there are a lot of things that matter, and it sometimes can be hard to figure out what does.&#xA;Let&#x2019;s make a small change in my code, like so:&#xA;&#xA;What this does is to remove the call to RavenDB entirely. The only cost we have here is the cost of generating the from the Bogus library. This time, the code completes in 13 seconds.&#xA;But wait, there are no RavenDB calls here, why does it take so long? Well, as it turns out, the fake data generation library has a non trivial cost to it,&#xA0; which impact the whole test. I changed things&#xA0; so that we&#x2019;ll generate 10,000 users and then use bulk insert to send them over and over again. That means that the time that we measure is just the cost of sending the data over. With these changes, I got much nicer numbers:&#xA;&#xA;While this is going on, by the way, we have an interesting observation about the node while I&#x2019;m doing this.&#xA;&#xA;You can see that while we have two machines trying to push data in as fast as them can, we have a lot of spare capacity. This is key, actually. The issue is what the bottleneck, and we already saw that the problem is probably on the client. We improved our performance by over 300% by simply reducing the cost of generating the data, not writing to RavenDB. As it turns out, we are also leaving a lot of performance on the table because we are doing this single threaded. A lot of the time is actually spent on the client side, doing serialization, etc.&#xA;I changed the client code to use multiple threads and tried it again. By the way, you might notice that the client code is&#x2026; brute forced, in a way. I intentionally did everything in the most obvious way possible, caring non at all about the structure of the code. I just want it to work, so no error handling, nothing sophisticated at all here.&#xA;&#xA;This is with both client machines setup to use 4 threads each to send the data. It&#x2019;s time to dig a bit deeper and see what is actually going on here. The t3.large machine has 2 cores, and looking into what it is doing while it has 4 threads sending data is&#x2026; instructive&#x2026;&#xA;&#xA;The m5d.large instance also have two cores, and is in a similar state:&#xA;&#xA;Leaving aside exactly what is going on here (I&#x2019;ll discuss this in more depth later in this post), it is fairly obvious that the issue here is on the client side, we are completely saturating the machine&#x2019;s capabilities.&#xA;I created another machine to serve as a client, this time a c5.9xlarge, an instance that has 36 cores and is running a much faster CPU that the previous instances. This time, I a single machine and I used just a single thread, and I got the following results:&#xA;&#xA;And at the same time, the server resources utilization was:&#xA;&#xA;Note that this is when we have a single thread doing the work&#x2026; what happens when we increase the load?&#xA;Given the disparity between the client (36 cores) and the server (just 4), I decided to start slow and told the client to use just 12 threads to bulk insert the data. The result:&#xA;&#xA;Now we are talking, but what about the server&#x2019;s resources?&#xA;&#xA;We got ourselves some spare capacity to throw around, it seems.&#xA;At this point, I decided to go all in and see what happens when I&#x2019;m using all 36 cores for this. As it runs out, we can get faster, which is great, but the rise isn&#x2019;t linear, unfortunately.&#xA;&#xA;At this point, I mostly hit the limits. Regardless of how much load I put on the client, it wasn&#x2019;t able to hit any higher than this. I decided to look at what the server is doing. Write speed for RavenDB is almost absolutely determined by the ACID nature of the database, we have to wait for the disk to confirm the write. Because this is such an important factor of our performance, we surface all of that information to you. In the database&#x2019;s stats page, you can go into the IO Stats section, like so:&#xA;&#xA;The first glace might be a bit confusing, I&#x2019;ll admit. We tried to pack a lot of data into a single view.&#xA;&#xA;The colors are important. Blue are writes to the journal, which are the thing that would usually hold up the transaction commit. The green (data write / flush) and red (sync) are types of disk operations, and they are shown here to allow you to see if there are any correlation. For example, if you have a big sync operation, it may suck all the I/O bandwidth, and your journal writes will be slow. With this view, you can clearly correlate that information. The brighter the color, the bigger the write, the wider the write, the more time it took. I hope that this is enough to understand the gist of it.&#xA;Now, let&#x2019;s zoom in. Here you can see a single write, for 124KB, that took 200ms.&#xA;&#xA;Here is another one:&#xA;&#xA;These are problematic for us, because we are stalling. We can&#x2019;t really do a lot while we are waiting for the disk (actually, we can, we start processing the next tx, but there is a limit to that as well). That is likely causing us to wait when we read from the network and in likely the culprit. You might have noticed that both slow writes happened in conjunction with the sync (the red square below), that indicate that we might have latency because both operations go to the same location at the same time.&#xA;On the other hand, here is another section, where we have two writes very near one another and they both very slow, without a concurrent sync. So the interference from the sync is a theory, not a proven fact.&#xA;&#xA;We can go and change the gp2 drive we have to an io1 drive with provisioned IOPS (1536, same as the gp2). That would cost me 3 times as much, so let&#x2019;s see if we can avoid this. Journals aren&#x2019;t meant to be forever. They are used to maintain durability of the data, once we synced the data to disk, we can discard them.&#xA;I created an 8 GB io2 drive with 400 IOPS and attached it to the server instance and then set it up:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          $ sudo mkfs -t ext4 /dev/nvme2n1&#xA;        &#xA;        &#xA;          &#xA;          $ sudo mkdir /journals&#xA;        &#xA;        &#xA;          &#xA;          $ sudo mount /dev/nvme2n1 /journals&#xA;        &#xA;        &#xA;          &#xA;          $ sudo chown -R $USER /journals&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          journals.sh&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;Here is what this ended up as:&#xA;&#xA;Now, I&#x2019;m going to setup the journals&#x2019; directory for this database to point to the new drive, like so:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          $ mkdir /journals/bulk&#xA;        &#xA;        &#xA;          &#xA;          $ ln -s /journals/bulk /data/bulk/Journals&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          separate-journals.sh&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;And now we have a better separation of the journals and the data, let&#x2019;s see what this will give us? Not much, it seems, I&#x2019;m seeing roughly the same performance as before, and the IO stats tells the same story.&#xA;&#xA;Okay, time to see what we can do when we change instance types. As a reminder, so far, my server instance was t3a.xlarge (4 cores, 16 GB). I launched a r5d.large instance (2 cores, 16 GB) and set it up with the same configuration as before.&#xA;&#xA;512 GB gp2 (1536 IOPS) for data&#xA;8GB io2 (400 IOPS) for journals&#xA;&#xA;Here is what I got when I started hammering the machine:&#xA;&#xA;This is interesting, because you can see a few discrepancies:&#xA;&#xA;The machine feels faster, much faster&#xA;We are now bottleneck on CPU, but note the number of writes per second&#xA;This is when we reduced the number of cores by half!&#xA;&#xA;That seems pretty promising, so I decided to switch instances again. This time to i3en.xlarge instance (4 cores, 30GB, 2 TB NVMe drive). To be honest, I&#x2019;m mostly interested in the NVMe drive .&#xA;Here are the results:&#xA;&#xA;As you can see, we are running pretty smoothly with 90K &#x2013; 100K writes per second sustained.&#xA;On the same i3en.xlarge system, I attached the two volumes (512GB gp2 and 8GB io2) with the same setup (journals on the io2 volume), and I&#x2019;m getting some really nice numbers as well:&#xA;&#xA;And now, the hour is nearing 4AM, and while I had a lot of fun, I think this is the time to close this post. The factor in write performance for RavenDB is the disk, but we care a lot more about latency than throughput for these kind of operations.&#xA;A single t3a.xlarge machine was able to hit peak at 77K writes/second and by changing the instance type and getting better IO, we were able to push that to 100K writes/sec. Our current benchmark is sitting at 138,000 writes/second, by the way, but it isn&#x2019;t running on virtual machine but on physical hardware. Probably the most important part of that machine is the fact that is has an NVMe drive (latency, again).&#xA;However, there is one question that still remains. Why did we have to spend so much compute power on generating the bulk insert operations? We had to hit the server from multiple machines or use 36 concurrent threads just to be able to push enough data so the server will sweat it.&#xA;To answer this, I&#x2019;m going to do the Right Thing and look at the profiler results. The problem is in the client side, so let&#x2019;s profile the client and see what is taking so much computation horse power. Here are the results:&#xA;&#xA;The cost here is serialization is the major factor here. That is why we need to parallelize the work, otherwise, as we saw, RavenDB is basically going to sit idle.&#xA;The reason for this &quot;issue&quot; is that JSON.Net is a powerful library with many features, but it does have a cost. For bulk insert scenarios, you typically have a very well defined&#xA0;set of documents, and you don&#x27;t&#xA0;need all this power. For this reason, RavenDB exposes an API that allow you to fully control&#xA0;how serialization works for bulk insert:&#xA;&#xA;DocumentStore.Conventions.BulkInsert.TrySerializeEntityToJsonStream&#xA;&#xA;You can use that to significantly speed up your&#xA0;insert processes.</p>
        </article>
        <article id="article-1893">
            <a href="https://andrewlock.net/filtering-action-methods-with-feature-flags-adding-feature-flags-to-an-asp-net-core-app-part-2/" target="_blank">
                <h2 class="title mb-6" id="article-1893">Filtering action methods with feature flags</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 13, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Adding feature flags to an ASP.NET Core app - Part 2</p>
        </article>
        <article id="article-1894">
            <a href="https://ayende.com/blog/187617-A/computing-spatial-distances-in-ravendb-queries" target="_blank">
                <h2 class="title mb-6" id="article-1894">Computing spatial distances in RavenDB queries</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 12, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB has had support for spatial queries for a long time. In RavenDB 4.0 we did a whole bunch of work to make spatial queries better. In particular, we have separate the concepts of searching and ordering for spatial queries. In most cases, if you are doing a spatial query, you&#x2019;ll want to sort the results by their distance. The classic example is: &#x201C;Give me the Pizza stores within 5 km from me&#x201D;. I&#x2019;ll usually also want to see them listed by their distance. But there are other ways to go about it. For example, if I want to see a concert by Queen, I want to sort them by distance, but I don&#x2019;t want to do any spatial filtering. It gets interesting when you combine different spatial operations at the same time. For example, consider the following query. Here is how you can search for a house in a particular school district, but want to find the one that is nearest to the office. The two spatial queries aren&#x2019;t related at all to one another. One thing that we did not do, however, was report the distance back to the user. In other words, during the query, we compute the distance to the provided location, but we aren&#x2019;t actually returning it, just use it for sorting. This is mostly an oversight, and we&#x2019;ll be fixing that. The thought at the time was that since you already get the document from the server, you already have the location data, and can compute it on the client side. However, that isn&#x2019;t ergonomic to users, who want to just get the data and be done with it. As I said, we&#x2019;ll be fixing this, but in the meantime, you can use another of RavenDB&#x2019;s capabilities to handle this, by define a JS function and projecting that directly from the server. Let&#x2019;s take a look at the following query:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          declare function distance(lat1, lon1, lat2, lon2, unit) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;// from : https://www.geodatasource.com/developers/javascript&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if ((lat1 == lat2) &amp;&amp; (lon1 == lon2)) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;return 0;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;else {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;var radlat1 = Math.PI * lat1/180;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;var radlat2 = Math.PI * lat2/180;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;var theta = lon1-lon2;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;var radtheta = Math.PI * theta/180;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;var dist = Math.sin(radlat1) * Math.sin(radlat2) &#x2B; Math.cos(radlat1) * &#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;   Math.cos(radlat2) * Math.cos(radtheta);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (dist &gt; 1) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;dist = 1;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;dist = Math.acos(dist);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;dist = dist * 180/Math.PI;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;dist = dist * 60 * 1.1515;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (unit==&quot;K&quot;) { dist = dist * 1.609344 }&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (unit==&quot;N&quot;) { dist = dist * 0.8684 }&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;return dist;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          from index &#x27;Houses/ByLocation&#x27; as h&#xA;        &#xA;        &#xA;          &#xA;          where spatial.within(h.Location, spatial.wkt($schoolDistrict))&#xA;        &#xA;        &#xA;          &#xA;          order by spatial.distance(h.Location, spatial.point($office.lat, $office.lng))&#xA;        &#xA;        &#xA;          &#xA;          select {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Distance: distance(h.Location.Lat, h.Location.Lng, $office.lat, $office.lng),&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Address: h.Address.Street &#x2B; &quot; &quot; &#x2B; h.Address.Neighbourhood &#x2B; &quot;, &quot; &#x2B; h.Address.City,&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Price: h.RequestedPrice&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          query.sql&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This query allows us to project the details we need to render the results table to the user directly, without needing to do anything on the client side. It is a good enough solution for right now, and I&#x2019;m really happy that RavenDB is flexible enough to provide this to users without us needing to do anything. That said, I don&#x2019;t like the ergonomics, and we intend to basically make this kind of function into an intrinsic operation inside of RavenDB.</p>
        </article>
        <article id="article-1895">
            <a href="https://andrewlock.net/introducing-the-microsoft-featuremanagement-library-adding-feature-flags-to-an-asp-net-core-app-part-1/" target="_blank">
                <h2 class="title mb-6" id="article-1895">Introducing Microsoft.FeatureManagement</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 11, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Adding feature flags to an ASP.NET Core app - Part 1</p>
        </article>
        <article id="article-1896">
            <a href="https://ayende.com/blog/187585-A/running-a-ravendb-cluster-with-two-nodes" target="_blank">
                <h2 class="title mb-6" id="article-1896">Running a RavenDB cluster with two nodes</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 10, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Recently we got a couple of questions in the mailing list about running a RavenDB 4.x cluster with just two nodes in it. This was a fairly common topology in RavenDB 3.x days, because each of the nodes was mostly independent, but that added a lot of operational complexity to the system. In RavenDB 3.x you had to do a lot of stuff on each of the nodes in the system. RavenDB 4.x has brought us a unified cluster management and greatly simplified a lot of operational tasks. But one of the results of this change is that we now have a cluster rather than just a bunch of nodes.In particular, in order to be able to operate correctly, a RavenDB cluster needs a majority of the voting nodes to operate successfully. In a typical cluster setup, you are going to have three to five nodes and you&#x2019;ll need two or three of them to be accessible for the cluster to be healthy.However, in a cluster of only two nodes, a curious problem arises. The get a majority of the nodes, you need&#x2026; all the nodes. In other words, if you are running a cluster of just two nodes, and one of them is inaccessible, your cluster is not available. RavenDB&#x2019;s distributed nature is built on multiple layers. Even while the cluster itself is not available, you can still load and save documents to the database, perform queries, etc. Most of the normal operations that you would do on a day to day basis will work just fine without the cluster available.However, management functions require that the cluster be up. These include operations such adding or removing nodes to the cluster, creating or deleting a database, creating an index (including creating an auto index) or using advanced features such as ETL or Subscriptions. In both of the cases that were raised in the mailing list, we had a two node cluster and one of the nodes was down (VM was shutdown). That led to the inability to remove the down node from the cluster (we have emergency operations that allow that, but they are not meant for normal use) or errors during queries that required us to introduce a new index to the system.It is important to understand that this isn&#x2019;t actually an error. This is the system operating as designed and is a predictable (and desirable) part of how it is supposed to work in such failure modes.However, that is true only if you are running your cluster with all the nodes as full voting member nodes. There are other alternatives. If you have a two nodes cluster, a single node being down will take the whole cluster down. At this point, you can usually designate one node as the primary and chose a different topology. Look at the cluster image on the right. As you can see, we have the leader A as well as node B. You might notice that node B is marked with a W. Usually a member node in the cluster will be marked with M (for Member). But the W marking stands for Watcher.In this case, a watcher node is a silent participant in the cluster. It can listen, but doesn&#x2019;t interfere in the cluster itself. Node A is the sole node in the cluster that can make decisions. So if node B is down, the cluster is still functional. However, if node A is down, node B is going to operate without the cluster. Given that this would be the same situation anyway if you are running with both A and B as full members, that is a net benefit. And from experience, users who want to run a dual node cluster typically already have pretty firm ideas about which of the nodes is the primary.You can demote a node from a full member to a watcher (and vice versa) dynamically, in the cluster management page in the Studio. However, remember that this is an operation that requires a majority of the cluster to be available.You can also add a node to the cluster as a watcher immediately, which is probably a better idea. Aside from not being counted for cluster votes, watcher nodes in RavenDB behave in the exact same manner as other nodes. You can assign them tasks, the cluster manage them as usual, they host databases and in general behave just like any other RavenDB node. The other use case for watcher nodes are in very large clusters. If your cluster grows being seven nodes, you&#x2019;ll typically start adding watcher nodes to the cluster, instead of full member nodes. This is to avoid having to get majority vote from a large number of nodes.</p>
        </article>
        <article id="article-1897">
            <a href="https://www.meziantou.net/cryptography-in-dotnet.htm" target="_blank">
                <h2 class="title mb-6" id="article-1897">Cryptography in .NET</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 10, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Cryptography is a very important thing for information security. Information security is composed of 4 parts:Integrity: ensure a document is not alteredConfidentiality: ensure only authorized people can read a documentAuthentication: ensure the document was written by an identified personNon-Repudi</p>
        </article>
        <article id="article-1898">
            <a href="https://ayende.com/blog/187554-C/production-postmortem-printer-out-of-paper-and-the-ravendb-hang" target="_blank">
                <h2 class="title mb-6" id="article-1898">Production postmortem</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 07, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I spoke about this in the video, and it seems to have caught a lot of people yes, so I thought that I would talk here a bit how we trace the root cause of a RavenDB critical issue to a printer being out of paper.What is the relationship, I can hear you ask, between RavenDB, a document database, and a printer being out of paper? That is a good question. The answer is pretty much none. There is no DocPrint module inside of RavenDB and the last time yours truly wrote printer code was over fifteen years ago. But the story started, like all good tech stories, with a phone call. An inconveniently timed phone call, I might add.Imagine, the year is 2013, and I&#x2019;m enjoying the best part of the year, December. I love December for a few reasons. I was born in it, and it is a time where pretty much all our customers are busy doing other stuff and we can focus on pure development. So imagine my surprise when, on the other side of the line, I got a pretty upset admin that had to troubleshoot a RavenDB instance that would refuse to start. To make things interesting, this admin had drawn the short straw, I assume, and had to man the IT department while everyone else was on vacation. He had no relation to RavenDB during normal operations and only had the bare minimum information about it.The symptoms were clear, luckily. RavenDB would simply refuse to start, hanging almost immediately, it seemed. No network access, nothing in the logs to indicate a problem. Just&#x2026; hanging&#x2026;Here is the stack trace that we captured:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          mscorlib.dll!Microsoft.Win32.RegistryKey.InternalGetValue(string name, object defaultValue, bool doNotExpand, bool checkSecurity)&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          mscorlib.dll!Microsoft.Win32.RegistryKey.GetValue(string name)&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          System.dll!System.Diagnostics.PerformanceMonitor.GetData(string item)&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          System.dll!System.Diagnostics.PerformanceCounterLib.GetPerformanceData(string item)&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          System.dll!System.Diagnostics.PerformanceCounterLib.CategoryTable.get()&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          System.dll!System.Diagnostics.PerformanceCounterLib.CounterExists(string category, string counter, ref bool categoryExists)&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          System.dll!System.Diagnostics.PerformanceCounterLib.CounterExists(string machine, string category, string counter)&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          System.dll!System.Diagnostics.PerformanceCounter.InitializeImpl()&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          System.dll!System.Diagnostics.PerformanceCounter.PerformanceCounter(string categoryName, string counterName, string instanceName, bool readOnly)&#x9;Unknown&#xA;        &#xA;        &#xA;          &#xA;          Raven.Database.dll!Raven.Database.Indexing.WorkContext.IsValidCategory(string categoryName, System.Collections.Generic.Dictionary&lt;string,System.Diagnostics.PerformanceCounterType&gt; instances, string instanceName)&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          stack.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;And that was&#x2026; it. We started to look into it, and we run into this StackOverflow question, which was awesome. Indeed, restarting the print spooler would fix the problem and RavenDB would immediately start running. But I couldn&#x2019;t leave it like this, and I guess the admin on the other side was kinda bored, because he went along with my investigation.We now have access to the code (we didn&#x2019;t in 2013) and can look at exactly what is going on. This comment had me&#x2026; upset:The service manager in Windows will consider any service that didn&#x2019;t finish initialization in 30 seconds to be failed and kill it.&#xA0; You might be putting the things together at this point?After restarting the print spooler, we were able to start RavenDB, but restarting it cause another failure. Eventually we tracked it down to a network printer that was out of paper (presumably no one in the office to notice / fill it up). My assumption is that the print spooler was holding a register key hostage while making a network call to the printer that would time out because it didn&#x2019;t have any paper. If at that time you would attempt to use a performance counter, you would hang, and if you are running as service, would be killed. I&#x2019;m left with nothing to do but quote Leslie Lamport:A distributed system is one in which the failure of a computer you didn&#x2019;t even know existed can render your own computer unusable.Oh so true.We ended up ditching performance counters entirely after running into so many issues around them. As of 2017, people were still running into this issue, so I think that was a great decision.</p>
        </article>
        <article id="article-1899">
            <a href="https://ardalis.com/syncing-a-fork-of-a-github-repository-with-upstream/" target="_blank">
                <h2 class="title mb-6" id="article-1899">Syncing a Fork of a GitHub Repository with Upstream</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 07, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Update 13 October 2023 GitHub made this easier. You can still use the approach below, but also check out how you can Fetch Upstream directly&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-1900">
            <a href="https://enterprisecraftsmanship.com/posts/merging-domain-events-dispatching/" target="_blank">
                <h2 class="title mb-6" id="article-1900">Merging domain events before dispatching</h2>
            </a>
            <p class="mb-2">by Vladimir Khorikov</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: June 06, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This post describes a common problem: how to deal with multiple domain events if raising of one of them must negate the others.</p>
        </article>
        <div class="button flex justify-between">
            <a href="189.html"><span class="back arrow"></span></a>

            <a href="191.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
