
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 205 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-2041">
            <a href="https://ayende.com/blog/186148-A/next-week-in-new-york" target="_blank">
                <h2 class="title mb-6" id="article-2041">Next week in New York</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: February 01, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;ll be in New York for all of next week, and I got a busy schedule.I&#x2019;m going to be in the O&#x2019;Reilly Architecture Conference on the RavenDB booth, showing off our new features and how RavenDB can figure into your next application&#x2019;s architecture.Feb 4 &#x2013; Feb 6 &#x2013; I&#x2019;ll be at the RavenDB booth in the conference.On Feb 6, I&#x2019;m going to be talking about SQL and NoSQL databases and where to use each.On Feb 7, I&#x2019;m going to be talking about Autonomous Database Self Management. On Feb 10, I&#x2019;m going to be talking about Data flow architecture for Micro Services Systems.If you are around, I would be delighted to meet you in any of these events.</p>
        </article>
        <article id="article-2042">
            <a href="https://enterprisecraftsmanship.com/posts/cqrs-commands-part-domain-model/" target="_blank">
                <h2 class="title mb-6" id="article-2042">Are CQRS commands part of the domain model?</h2>
            </a>
            <p class="mb-2">by Vladimir Khorikov</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 31, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I published an online course about CQRS&#xA0;a couple months ago, and since then I realized that there are some topics I didn&#x2019;t put enough emphasize on in that course, or didn&#x2019;t cover at all. In the next several blog posts, I&#x2019;m going to fill this gap.</p>
        </article>
        <article id="article-2043">
            <a href="https://ayende.com/blog/185858-A/using-tls-in-rust-handling-messages-out-of-band" target="_blank">
                <h2 class="title mb-6" id="article-2043">Using TLS in Rust</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 31, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;m pretty much done with my Rust protocol impl. The last thing that I wanted to try was to see how it would look like when I allow for messages to be handled out of band. Right now, my code consuming the protocol library looks like this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          // handler def&#xA;        &#xA;        &#xA;          &#xA;          type Handler = fn(self::cmd::Cmd) -&gt; Result&lt;String, ConnectionError&gt;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          // handler impl&#xA;        &#xA;        &#xA;          &#xA;          fn echo(cmd: server::cmd::Cmd) -&gt; std::result::Result&lt;String, ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(cmd.args[1].clone())&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          // registeration&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              Arc::get_mut(&amp;mut server).unwrap()&#xA;        &#xA;        &#xA;          &#xA;                  .handle(&quot;echo&quot;.to_string(), echo);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          confumer1.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This is pretty simple, but note that the function definition forces us to return a value immediately, and that we don&#x2019;t have a way to handle a command asynchronously. What I wanted to do is to change things around so I could do that. I decided to implemented the command:remind 15 NapWhich should help me remember to nap. In order to handle this scenario, I need to provide a way to do async work and to keep sending messages to the client. Here was the first change I made:Instead of returning a value from the function, we are going to give it the sender (which will render the value to the client) and can return an error if the command is invalid in some form.That said, it means that the echo implementation is a bit more complex. &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          fn echo(cmd: server::cmd::Cmd, sender : Sender&lt;String&gt;) -&gt; std::result::Result&lt;(), ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              tokio::spawn(sender.send(cmd.args[1].clone()).map_err(|_|()).map(|_|()));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(())&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          echo2.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;There is&#x2026; a lot of ceremony here, even for something so small. Let&#x2019;s see what happens when we do something bigger, shall we? Here is the implementation of the reminder handler:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          fn remind(cmd: server::cmd::Cmd, sender : Sender&lt;String&gt;) -&gt; std::result::Result&lt;(), ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              static COUNTER : std::sync::atomic::AtomicUsize = std::sync::atomic::ATOMIC_USIZE_INIT;&#xA;        &#xA;        &#xA;          &#xA;              // remdind &lt;sec&gt; msg&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              #[async]&#xA;        &#xA;        &#xA;          &#xA;              fn delayed_send(delay: u64, msg: String, sender : Sender&lt;String&gt;) -&gt; std::result::Result&lt;(), ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  await!(Delay::new(Instant::now() &#x2B;Duration::from_secs(delay)))?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  await!(sender.send(msg))?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  Ok(())&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let secs : u64  = match cmd.args.get(1){&#xA;        &#xA;        &#xA;          &#xA;                  None =&gt; return Err(ConnectionError::BadDataArgs{&#xA;        &#xA;        &#xA;          &#xA;                      msg: &quot;&#x27;remind&#x27; requires a &lt;secs&gt; argument&quot;.to_string()&#xA;        &#xA;        &#xA;          &#xA;                  }),&#xA;        &#xA;        &#xA;          &#xA;                  Some(str) =&gt; match str.parse::&lt;u64&gt;(){&#xA;        &#xA;        &#xA;          &#xA;                      Err(e) =&gt; return Err(ConnectionError::BadDataArgs{&#xA;        &#xA;        &#xA;          &#xA;                          msg: &quot;&#x27;remind&#x27; requires a &lt;secs&gt; argument to be a u64: &quot;.to_string() &#x2B; &amp;e.to_string()&#xA;        &#xA;        &#xA;          &#xA;                      }),&#xA;        &#xA;        &#xA;          &#xA;                      Ok(v) =&gt; v&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;              let msg = match cmd.args.get(2){&#xA;        &#xA;        &#xA;          &#xA;                  None =&gt; &quot;Reminder&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  Some(v) =&gt; v&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let id = (COUNTER.fetch_add(1, std::sync::atomic::Ordering::SeqCst) &#x2B; 1).to_string();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              tokio::spawn(delayed_send(secs, msg.to_string() &#x2B; &quot;\r\nSequence: &quot; &#x2B; &amp;id, sender.clone()).map_err(|_|()));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              tokio::spawn(sender.send(&quot;OK\r\nSequence: &quot;.to_string() &#x2B; &amp;id).map_err(|_|()).map(|_|()));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(())&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          remind.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Admittedly, a lot of that is error handling, but there is a lot of code here to do something that simple.&#xA0; Compare that to something like C#, where the same thing could be written as:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public async Task Remind(Cmd cmd, TextWriter writer)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              if(cmd.Arguments.Count &lt; 3)&#xA;        &#xA;        &#xA;          &#xA;                return await writer.WriteAsync(&quot;ERR command requires 3 parameters\r\n\r\n&quot;);&#xA;        &#xA;        &#xA;          &#xA;                &#xA;        &#xA;        &#xA;          &#xA;               if(int.TryParse(cmd.Arguments[1], out var wait) == false))&#xA;        &#xA;        &#xA;          &#xA;                return await writer.WriteAsync(&quot;ERR cannot parse &lt;wait&gt; argument for command: &quot; &#x2B; cmd.Arguments[1] &#x2B; &quot;\r\n\r\n&quot;);&#xA;        &#xA;        &#xA;          &#xA;               &#xA;        &#xA;        &#xA;          &#xA;               await writer.WriteAsync(&quot;OK\r\n\r\n&quot;);&#xA;        &#xA;        &#xA;          &#xA;               async Task.Delay(wait);&#xA;        &#xA;        &#xA;          &#xA;               await writer.WriteAsync(string.Join(cmd.Arguments.Skip(2)) &#x2B; &quot;\r\n\r\n&quot;);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          reminder.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;I&#x2019;m not sure that the amount of complexity that is brought about by the tokio model, even with the async/await macros is worth it at this point. I believe that it needs at least a few more iterations before it is going to be usable for the general public. There is way too much ceremony and work to be done, and a single miss and you are faced with a very pissed off compiler.</p>
        </article>
        <article id="article-2044">
            <a href="https://ayende.com/blog/186081-A/data-modeling-with-indexes-event-sourcing-part-i" target="_blank">
                <h2 class="title mb-6" id="article-2044">Data modeling with indexes</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 30, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post, I want to take the notion of doing computation inside RavenDB&#x2019;s indexes to the next stage. So far, we talked only about indexes that work on a single document at a time, but that is just the tip of the iceberg of what you can do with indexes inside RavenDB. What I want to talk about today is the ability to do computations over multiple documents and aggregate them. The obvious example is in the following RQL query:That is easy to understand, it is simple aggregation of data. But it can get a lot more interesting. To start with, you can add your own aggregation logic in here, which open up some interesting ideas. Event Sourcing, for example, is basically a set of events on a subject that are aggregated into the final model. Probably the classiest example of event sourcing is the shopping cart example. In such a model, we have the following events:AddItemToCartRemoveItemFromCartPayForCartHere what these look like, in document form:We add a couple of items to the cart, remove excess quantity and pay for the whole thing. Pretty simple model, right? But how does this relate to indexing in RavenDB? Well, the problem here is that we don&#x2019;t have a complete view of the shopping cart. We know what the actions were, but not what its current state is. This is where our index come into play, let&#x2019;s see how it works.The final result of the cart should be something like this:Let&#x2019;s see how we get there, shall we? We&#x2019;ll start by processing the add to cart events, like so:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          map(&quot;AddItemToCart&quot;, event =&gt; {&#xA;        &#xA;        &#xA;          &#xA;              var products = {};&#xA;        &#xA;        &#xA;          &#xA;              products[event.Product] = {&#xA;        &#xA;        &#xA;          &#xA;                  Quantity: event.Quantity,&#xA;        &#xA;        &#xA;          &#xA;                  Price: event.Price&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;              return {&#xA;        &#xA;        &#xA;          &#xA;                  Cart: event.Cart,&#xA;        &#xA;        &#xA;          &#xA;                  Products: products&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;          });&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          add-to-car.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, the map phase here build the relevant parts of the end model directly. But we still need to complete the work by doing the aggregation. This is done on the reduce phase, like so:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          groupBy(x=&gt;x.Cart)&#xA;        &#xA;        &#xA;          &#xA;              .aggregate(g =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                  var products = g.values.reduce((agg, item) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                      for (var key in item.Products) {&#xA;        &#xA;        &#xA;          &#xA;                          var p = item.Products[key];&#xA;        &#xA;        &#xA;          &#xA;                          var existing = agg[key];&#xA;        &#xA;        &#xA;          &#xA;                          if (!existing) {&#xA;        &#xA;        &#xA;          &#xA;                              agg[key] = { Quantity: p.Quantity, Price: p.Price };&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          else {&#xA;        &#xA;        &#xA;          &#xA;                              existing.Quantity &#x2B;= p.Quantity;&#xA;        &#xA;        &#xA;          &#xA;                              existing.Price = Math.min(p.Price, existing.Price);&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      return agg;&#xA;        &#xA;        &#xA;          &#xA;                  }, {});&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  return {&#xA;        &#xA;        &#xA;          &#xA;                      Cart: g.key,&#xA;        &#xA;        &#xA;          &#xA;                      Products: products&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;              })&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          reduce1.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Most of the code here is to deal with merging of products from multiple add actions, but even that should be pretty simple. You can see that there is a business rule here. The customer will be paying the minimum price they encountered throughout the process of building their shopping cart.Next, let&#x2019;s handle the removal of items from the cart, which is done in two steps. First, we map the remove events:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          map(&quot;RemoveItemFromCart&quot;, event =&gt; {&#xA;        &#xA;        &#xA;          &#xA;              var products = {};&#xA;        &#xA;        &#xA;          &#xA;              products[event.Product] = {&#xA;        &#xA;        &#xA;          &#xA;                  Quantity: -event.Quantity,&#xA;        &#xA;        &#xA;          &#xA;                  Price: 0&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;              return {&#xA;        &#xA;        &#xA;          &#xA;                  Cart: event.Cart,&#xA;        &#xA;        &#xA;          &#xA;                  Products: products&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;          });&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          removefromcart.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;There are a few things to note here, the quantity is negative, and the price is zeroed, that necessitate changes in the reduce as well. Here they are:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          groupBy(x=&gt;x.Cart)&#xA;        &#xA;        &#xA;          &#xA;              .aggregate(g =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                  var products = g.values.reduce((agg, item) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                      for (var key in item.Products) {&#xA;        &#xA;        &#xA;          &#xA;                          var p = item.Products[key];&#xA;        &#xA;        &#xA;          &#xA;                          var existing = agg[key];&#xA;        &#xA;        &#xA;          &#xA;                          if (!existing) {&#xA;        &#xA;        &#xA;          &#xA;                              agg[key] = { Quantity: p.Quantity, Price: p.Price };&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          else {&#xA;        &#xA;        &#xA;          &#xA;                              existing.Quantity &#x2B;= p.Quantity;&#xA;        &#xA;        &#xA;          &#xA;                              if(p.Price &gt; 0)&#xA;        &#xA;        &#xA;          &#xA;                                  existing.Price = Math.min(p.Price, existing.Price);&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      return agg;&#xA;        &#xA;        &#xA;          &#xA;                  }, {});&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;                  for (var key in products) {&#xA;        &#xA;        &#xA;          &#xA;                      if(products[key].Quantity == 0)&#xA;        &#xA;        &#xA;          &#xA;                          delete products[key];&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  return {&#xA;        &#xA;        &#xA;          &#xA;                      Cart: g.key,&#xA;        &#xA;        &#xA;          &#xA;                      Products: products&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;              })&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          reduce2.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, we now only get the cheapest price, above zero, and we&#x2019;ll remove empty items from the cart. The final step we have to take is handle the payment events. We&#x2019;ll start with the map first, obviously.&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          map(&quot;PayForCart&quot;, event =&gt; {&#xA;        &#xA;        &#xA;          &#xA;              var paid = {};&#xA;        &#xA;        &#xA;          &#xA;              paid[event.Method] = event.Paid;&#xA;        &#xA;        &#xA;          &#xA;              return {&#xA;        &#xA;        &#xA;          &#xA;                  Cart: event.Cart,&#xA;        &#xA;        &#xA;          &#xA;                  Products: [],&#xA;        &#xA;        &#xA;          &#xA;                  Paid: paid&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          });&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          payforcart.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Note that we added a new field to the output. Just like we set the Products fields in the pay for cart map to empty array, we need to update the rest of the maps to include a Paid: {} to match the structure. This is because all the maps (and the reduce) in an index must output the same shape out.And now we can update the reduce accordingly. Here is the third version: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          groupBy(x=&gt;x.Cart)&#xA;        &#xA;        &#xA;          &#xA;              .aggregate(g =&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  var products = g.values.reduce((agg, item) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                      for (var key in item.Products) {&#xA;        &#xA;        &#xA;          &#xA;                          var p = item.Products[key];&#xA;        &#xA;        &#xA;          &#xA;                          var existing = agg[key];&#xA;        &#xA;        &#xA;          &#xA;                          if (!existing) {&#xA;        &#xA;        &#xA;          &#xA;                              agg[key] = { Quantity: p.Quantity, Price: p.Price };&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          else {&#xA;        &#xA;        &#xA;          &#xA;                              existing.Quantity &#x2B;= p.Quantity;&#xA;        &#xA;        &#xA;          &#xA;                              if(p.Price &gt; 0)&#xA;        &#xA;        &#xA;          &#xA;                                  existing.Price = Math.min(p.Price, existing.Price);&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      return agg;&#xA;        &#xA;        &#xA;          &#xA;                  }, {});&#xA;        &#xA;        &#xA;          &#xA;                  for (var key in products) {&#xA;        &#xA;        &#xA;          &#xA;                      if(products[key].Quantity == 0)&#xA;        &#xA;        &#xA;          &#xA;                          delete products[key];&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  var paid = g.values.reduce((agg, item) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                      for (var key in item.Paid){&#xA;        &#xA;        &#xA;          &#xA;                          agg[key] = item.Paid[key] &#x2B; (agg[key] || 0);&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      return agg;&#xA;        &#xA;        &#xA;          &#xA;                  }, {});&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  return {&#xA;        &#xA;        &#xA;          &#xA;                      Cart: g.key,&#xA;        &#xA;        &#xA;          &#xA;                      Products: products,&#xA;        &#xA;        &#xA;          &#xA;                      Paid: paid&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;              })&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          reduce3.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This is almost there, but we still need to do a bit more work to get the final output right. To make things interesting, I changed things up a bit and here is how we are paying for this cart:And here is the final version of the reduce:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          groupBy(x=&gt;x.Cart)&#xA;        &#xA;        &#xA;          &#xA;              .aggregate(g =&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  var products = g.values.reduce((agg, item) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                      for (var key in item.Products) {&#xA;        &#xA;        &#xA;          &#xA;                          var p = item.Products[key];&#xA;        &#xA;        &#xA;          &#xA;                          var existing = agg[key];&#xA;        &#xA;        &#xA;          &#xA;                          if (!existing) {&#xA;        &#xA;        &#xA;          &#xA;                              agg[key] = { Quantity: p.Quantity, Price: p.Price };&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          else {&#xA;        &#xA;        &#xA;          &#xA;                              existing.Quantity &#x2B;= p.Quantity;&#xA;        &#xA;        &#xA;          &#xA;                              if(p.Price &gt; 0)&#xA;        &#xA;        &#xA;          &#xA;                                  existing.Price = Math.min(p.Price, existing.Price);&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      return agg;&#xA;        &#xA;        &#xA;          &#xA;                  }, {});&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  var totalDue = 0;&#xA;        &#xA;        &#xA;          &#xA;                  for (var key in products) {&#xA;        &#xA;        &#xA;          &#xA;                      if(products[key].Quantity == 0)&#xA;        &#xA;        &#xA;          &#xA;                          delete products[key];&#xA;        &#xA;        &#xA;          &#xA;                      else&#xA;        &#xA;        &#xA;          &#xA;                          totalDue &#x2B;= products[key].Quantity * products[key].Price;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  var paid = g.values.reduce((agg, item) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                      for (var key in item.Paid){&#xA;        &#xA;        &#xA;          &#xA;                          agg[key] = item.Paid[key] &#x2B; (agg[key] || 0);&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      return agg;&#xA;        &#xA;        &#xA;          &#xA;                  }, {});&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  var totalPaid = 0;&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  for (var key in paid) {&#xA;        &#xA;        &#xA;          &#xA;                      totalPaid &#x2B;= paid[key];&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;                  return {&#xA;        &#xA;        &#xA;          &#xA;                      Cart: g.key,&#xA;        &#xA;        &#xA;          &#xA;                      Products: products,&#xA;        &#xA;        &#xA;          &#xA;                      Paid: paid,&#xA;        &#xA;        &#xA;          &#xA;                      TotalDue: totalDue,&#xA;        &#xA;        &#xA;          &#xA;                      TotalPaid: totalPaid,&#xA;        &#xA;        &#xA;          &#xA;                      Status: totalDue == totalPaid ? &quot;Paid&quot; : &quot;Pending&quot;&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;              })&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          reduce4.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;And the output of this for is:You can see that this is a bit different from what I originally envisioned it. This is mostly because I&#x2019;m bad at JavaScript and likely took many shortcuts along the way to make things easy for myself. Basically, I was easier to do the internal grouping using an object than using arrays.Some final thoughts:A shopping cart is usually going to be fairly small with a few dozens of events in the common case. This method works great for this, but it will also scale nicely if you need to aggregate over tens of thousands of events. A key concept here is that the reduce portion is called recursively on all the items, incrementally building the data until we can&#x2019;t reduce it any further. That means that the output we have get should also serve as the input to the reduce. This take some getting used to, but it is a very powerful technique.The output of the index is a complete model, which you can use inside your system. I the next post, I&#x2019;ll discuss how we can more fully flesh this out.If you want to play with this, you can get the dump of the database that you can import into your own copy of RavenDB (or our live demo instance).</p>
        </article>
        <article id="article-2045">
            <a href="https://ayende.com/blog/185857-A/using-tls-in-rust-the-complexity-of-async-macros-and-madness" target="_blank">
                <h2 class="title mb-6" id="article-2045">Using TLS in Rust</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 29, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After a lot of trouble, I&#x2019;m really happy that I was able to build an async I/O implementation of my protocol. However, for real code, I think that I would probably recommend using with the sync API instead, since at least that is straightforward and doesn&#x2019;t incur so much overhead at development time. The async stuff is still very much a &#x201C;use at your own risk&#x201D; kind of deal from my perspective. And I can&#x2019;t imagine trying to use it in a large project and no suffering from the complexity.As a good example, take a look at the following bit of code:It doesn&#x2019;t seem to be doing much, right? And it is clear what the intent of the code is. However, if you try to compile this code you&#x2019;ll get:Now, it took me a long while to figure out what is going on.&#xA0; The issue is that the code I&#x2019;m seeing isn&#x2019;t the actual code, because of macro expansions. So let&#x2019;s resolve this and see what the expanded code looks like:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          fn send_results(&#xA;        &#xA;        &#xA;          &#xA;              receiver: Receiver&lt;String&gt;,&#xA;        &#xA;        &#xA;          &#xA;          ) -&gt; impl ::futures::__rt::MyFuture&lt;std::result::Result&lt;(), io::Error&gt;&gt; &#x2B; &#x27;static {&#xA;        &#xA;        &#xA;          &#xA;              ::futures::__rt::gen(move || -&gt; std::result::Result&lt;(), io::Error&gt; {&#xA;        &#xA;        &#xA;          &#xA;                  let __e: std::result::Result&lt;(), io::Error&gt; = {&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          {&#xA;        &#xA;        &#xA;          &#xA;                              let mut __stream = receiver;&#xA;        &#xA;        &#xA;          &#xA;                              loop {&#xA;        &#xA;        &#xA;          &#xA;                                  let msg = {&#xA;        &#xA;        &#xA;          &#xA;                                      extern crate futures_await;&#xA;        &#xA;        &#xA;          &#xA;                                      let r = futures_await::Stream::poll(&amp;mut __stream)?;&#xA;        &#xA;        &#xA;          &#xA;                                      match r {&#xA;        &#xA;        &#xA;          &#xA;                                          futures_await::Async::Ready(e) =&gt; match e {&#xA;        &#xA;        &#xA;          &#xA;                                              futures_await::__rt::std::option::Option::Some(e) =&gt; e,&#xA;        &#xA;        &#xA;          &#xA;                                              futures_await::__rt::std::option::Option::None =&gt; break,&#xA;        &#xA;        &#xA;          &#xA;                                          },&#xA;        &#xA;        &#xA;          &#xA;                                          futures_await::Async::NotReady =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                                              yield futures_await::Async::NotReady;&#xA;        &#xA;        &#xA;          &#xA;                                              continue;&#xA;        &#xA;        &#xA;          &#xA;                                          }&#xA;        &#xA;        &#xA;          &#xA;                                      }&#xA;        &#xA;        &#xA;          &#xA;                                  };&#xA;        &#xA;        &#xA;          &#xA;                                  {&#xA;        &#xA;        &#xA;          &#xA;                                      {&#xA;        &#xA;        &#xA;          &#xA;                                          $crate::io::_print($crate::fmt::Arguments::new_v1_formatted(&#xA;        &#xA;        &#xA;          &#xA;                                              &amp;[&quot;&quot;, &quot;\n&quot;],&#xA;        &#xA;        &#xA;          &#xA;                                              &amp;match (&amp;msg,) {&#xA;        &#xA;        &#xA;          &#xA;                                                  (arg0,) =&gt; [$crate::fmt::ArgumentV1::new(&#xA;        &#xA;        &#xA;          &#xA;                                                      arg0,&#xA;        &#xA;        &#xA;          &#xA;                                                      $crate::fmt::Display::fmt,&#xA;        &#xA;        &#xA;          &#xA;                                                  )],&#xA;        &#xA;        &#xA;          &#xA;                                              },&#xA;        &#xA;        &#xA;          &#xA;                                              &amp;[$crate::fmt::rt::v1::Argument {&#xA;        &#xA;        &#xA;          &#xA;                                                  position: $crate::fmt::rt::v1::Position::At(0usize),&#xA;        &#xA;        &#xA;          &#xA;                                                  format: $crate::fmt::rt::v1::FormatSpec {&#xA;        &#xA;        &#xA;          &#xA;                                                      fill: &#x27; &#x27;,&#xA;        &#xA;        &#xA;          &#xA;                                                      align: $crate::fmt::rt::v1::Alignment::Unknown,&#xA;        &#xA;        &#xA;          &#xA;                                                      flags: 0u32,&#xA;        &#xA;        &#xA;          &#xA;                                                      precision: $crate::fmt::rt::v1::Count::Implied,&#xA;        &#xA;        &#xA;          &#xA;                                                      width: $crate::fmt::rt::v1::Count::Implied,&#xA;        &#xA;        &#xA;          &#xA;                                                  },&#xA;        &#xA;        &#xA;          &#xA;                                              }],&#xA;        &#xA;        &#xA;          &#xA;                                          ));&#xA;        &#xA;        &#xA;          &#xA;                                      };&#xA;        &#xA;        &#xA;          &#xA;                                  }&#xA;        &#xA;        &#xA;          &#xA;                              }&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          Ok(())&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  #[allow(unreachable_code)]&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      return __e;&#xA;        &#xA;        &#xA;          &#xA;                      loop {&#xA;        &#xA;        &#xA;          &#xA;                          yield ::futures::Async::NotReady&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              })&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          expanded.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This is after formatting, of course, but it certainly looks scary. Glancing at this code doesn&#x2019;t tell me what the problem was, so I tried replacing the method with the expanded result, and I got the same error, but this time I got it on a line that helped me figure it out. Here is the issue:We use the ? to return early from the poll method, and the Receiver I&#x2019;m using in this case is defined to have a Result&lt;String, ()&gt;, so this is the cause of the problem.I returned my own error type as a result, giving me the ability to convert from (), but that was a really hard thing to resolve. It might be better to have Rust also offer to show the error on the expanded code by default, because it was somewhat of a chore to actually get to this.What made this oh so confusing is that I had the exact same code, but using a Stream&lt;String, io:Error&gt; that worked, obviously. But it was decidedly non obvious to see what was the difference between two identical pieces of code.</p>
        </article>
        <article id="article-2046">
            <a href="https://andrewlock.net/running-async-tasks-on-app-startup-in-asp-net-core-part-4-using-health-checks/" target="_blank">
                <h2 class="title mb-6" id="article-2046">Using health checks to run async tasks in ASP.NET Core</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 29, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Running async tasks on app startup in ASP.NET Core - Part 4</p>
        </article>
        <article id="article-2047">
            <a href="https://ayende.com/blog/186050-A/large-interconnected-in-memory-model" target="_blank">
                <h2 class="title mb-6" id="article-2047">Large, interconnected, in memory model</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 28, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got into an interesting discussion about Event Sourcing in the comments for a post and that was interesting enough to make a post all of its own.Basically, Harry is suggesting (I&#x2019;m paraphrasing, and maybe not too accurately) a potential solution to the problem of having the computed model from all the events stored directly in memory. The idea is that you can pretty easily get machines with enough RAM to store stupendous amount of data in memory. That will give you all the benefits of being able to hold a rich domain model without any persistence constraints. It is also likely to be faster than any other solution.And to a point, I agree. It is likely to be faster, but that isn&#x2019;t enough to make this into a good solution for most problems. Let me to point out a few cases where this fails to be a good answer.If the only way you have to build your model is to replay your events, then that is going to be a problem when the server restarts. Assuming a reasonably size data model of 128GB or so, and assuming that we have enough events to build something like that, let&#x2019;s say about 0.5 TB of raw events, we are going to be in a world of hurt. Even assuming no I/O bottlenecks, I believe that it would be fair to state that you can process the events at a rate of 50 MB/sec. That gives us just under 3 hours to replay all the events from scratch. You can try to play games here, try to read in parallel, replay events on different streams independently, etc. But it is still going to take time. And enough time that this isn&#x2019;t a good technology to have without a good backup strategy, which means that you need to have at least a few of these machines and ensure that you have some failover between them. But even ignoring that, and assuming that you can indeed replay all your state from the events store, you are going to run into other problems with this kind of model.Put simply, if you have a model that is tens or hundreds of GB in size, there are two options for its internal structure. On the one hand, you may have a model where each item stands on its own, with no relations to other items. Or if there are any relations to other items, they are well scoped to the a particular root. Call it the Root Aggregate model, with no references between aggregates. You can make something like that work, because you have a good isolation between the different items in memory, so you can access one of them without impacting another. If you need to modify it, you can lock it for the duration, etc.However, if your model is interconnected, so you may traverse between one Root Aggregate to another, you are going to be faced with a much harder problem.In particular, because there are no hard breaks between the items in memory, you cannot safely / easily mutate a single item without worrying about access from another item to it. You could make everything single threaded, but that is a waste of a lot of horsepower, obviously.Another problem with in memory models is that they don&#x2019;t do such a good job of allowing you to rollback operations. If you run your code mutating objects and hit an exception, what is the current state of your data? You can resolve that. For example, you can decide that you have only immutable data in memory and replace that atomically. That&#x2026; works, but it requires a lot of discipline and make it complex to program against.Off the top of my head, you are going to be facing problems around atomicity, consistency and isolation of operations. We aren&#x2019;t worried about durability because this is purely in memory solution, but if we were to add that, we would have ACID, and that does ring a bell.The in memory solution sounds good, and it is usually very easy to start with, but it suffer from major issues when used in practice. To start with, how do you look at the data in production? That is something that you do surprisingly often, to figure out what is going on &#x201C;behind the scenes&#x201D;. So you need some way to peek into what is going on. If your data is in memory only, and you haven&#x2019;t thought about how to explore it to the outside, your only option is to attach a debugger, which is&#x2026; unfortunate. Given the reluctance to restart the server (startup time is high) you&#x2019;ll usually find that you have to provide some scripting that you can run in process to make changes, inspect things, etc. Versioning is also a major player here. Sooner or later you&#x2019;ll probably put the data inside a memory mapped to allow for (much) faster restarts, but then you have to worry about the structure of the data and how it is modified over time. None of the issues I have raised is super hard to figure out or fix, but in conjunction? They turn out to be a pretty big set of additional tasks that you have to do just to be in the same place you were before you started to put everything in memory to make things easier. In some cases, this is perfectly acceptable. For high frequency trading, for example, you would have an in memory model to make decisions on as fast as possible as well as a persistent model to query on the side. But for most cases, that is usually out of scope. It is interesting to write such a system, though.</p>
        </article>
        <article id="article-2048">
            <a href="https://www.stevejgordon.co.uk/running-aws-s3-simple-storage-service-using-docker-for-net-core-developers" target="_blank">
                <h2 class="title mb-6" id="article-2048">Running AWS S3 (Simple Storage Service) Locally for .NET Core Developers</h2>
            </a>
            <p class="mb-2">by Steve Gordon</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 25, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In a previous post, I described how to run AWS DynamoDb locally using the AWS supplied docker image. I&#x2019;ve recently been doing some work where I&#x2019;m benchmarking code that works against AWS services. For example, I&#x2019;m working to optimise speed and reduce allocations when downloading and parsing a file from AWS S3. I was curious [&#x2026;]</p>
        </article>
        <article id="article-2049">
            <a href="https://ayende.com/blog/185825-A/using-tls-in-rust-getting-async-i-o-with-tokio-second-try" target="_blank">
                <h2 class="title mb-6" id="article-2049">Using TLS in Rust</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 25, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">On my last post, I got really frustrated with tokio&#x2019;s complexity and wanted to move to use mio directly. The advantages are that the programming model is pretty simple, even if actually working with is is hard. Event loops can cause your logic to spread over many different locations and make it hard to follow. I started to go that path until I figure out just how much work it would take. I decided to give tokio a second change, and at this point, I looked into attempts to provide async/await functionality to Rust.It seems that at least some work is already available for this, using futures &#x2B; some Rust macros. That let me write code that is much more natural looking, and I actually managed to make it work.Before I get to the code, I want to point out some concerns that I have right now. The futures-await crate (and indeed, all of tokio) seems to be in a state of flux. There is an await in tokio, and I think that there is some merging around of all of those libraries into a single whole. What I don&#x2019;t know, and can&#x2019;t find any information about, is what I should actually be using, and how all the pieces come together. I have to note that even with async/await, the programming model is still somewhat awkward, but it is at a level that I can live with. Here is how I built it.First, we need to accept connections, which is done like so:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          #[async]&#xA;        &#xA;        &#xA;          &#xA;          pub fn accept_connections(server : Arc&lt;Server&gt;, listener: TcpListener) -&gt; std::result::Result&lt;(), io::Error&gt; {&#xA;        &#xA;        &#xA;          &#xA;              #[async]&#xA;        &#xA;        &#xA;          &#xA;              for connection in listener.incoming() {&#xA;        &#xA;        &#xA;          &#xA;                  tokio::spawn(Server::handle_connection(server.clone(), connection).map_err(|_| ()));&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              Ok(())&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          accept.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Note that I have two #[async[ annotations. One for the method as a whole and one for the for loop. This just accept the connection and spawn a task to handle that, the most interesting tidbits are in the actual processing of the connection:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          #[async]&#xA;        &#xA;        &#xA;          &#xA;          fn handle_connection(&#xA;        &#xA;        &#xA;          &#xA;              server: Arc&lt;Server&gt;,&#xA;        &#xA;        &#xA;          &#xA;              connection: TcpStream,&#xA;        &#xA;        &#xA;          &#xA;          ) -&gt; std::result::Result&lt;(), ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;              let acceptor = server.tls.clone();&#xA;        &#xA;        &#xA;          &#xA;              let stream = await!(acceptor.accept_async(connection))?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let auth_result = match Server::authenticate_certificate(server.clone(), stream.get_ref().ssl()) {&#xA;        &#xA;        &#xA;          &#xA;                  // failed to auth&#xA;        &#xA;        &#xA;          &#xA;                  Ok(Some((msg, err))) =&gt; Some((msg, err)),&#xA;        &#xA;        &#xA;          &#xA;                  // failed to figure it out&#xA;        &#xA;        &#xA;          &#xA;                  Err(e) =&gt; Some((e.to_string(), ConnectionError::InvalidCertiicateCert)),&#xA;        &#xA;        &#xA;          &#xA;                  // successfully auth&#xA;        &#xA;        &#xA;          &#xA;                  Ok(None) =&gt; None,&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              if let Some((msg, e)) = auth_result {&#xA;        &#xA;        &#xA;          &#xA;                  await!(write_all(stream, msg.into_bytes()))?;&#xA;        &#xA;        &#xA;          &#xA;                  return Err(e);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let (mut sender, receiver) = futures::sync::mpsc::channel(3);&#xA;        &#xA;        &#xA;          &#xA;              let (reader, writer) = stream.split();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              sender = await!(sender.send(&quot;OK&quot;.to_string()))?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              tokio::spawn(Server::process_commands(server, reader, sender).map_err(|_|()));&#xA;        &#xA;        &#xA;          &#xA;              tokio::spawn(Server::send_results(writer, receiver).map_err(|_|()));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(())&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          connection.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;You can see that this is fairly straightforward code. We first do the TLS handshake, then we validate the certificate. If there is an auth error, we send it to the user and back off. If we are successful, however, things get interesting.I create a channel, which allow me to&#xA0; split off the read and write portions of the task. This means that I can send results out of order, if I wanted to, which is great for the actual protocol handling. The first thing to do is to send the OK string to the client, so they know that we successfully connected, then we spawn the read/write tasks. The write task is pretty simple, overall:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          #[async]&#xA;        &#xA;        &#xA;          &#xA;          fn send_results(mut writer: WriteHalf&lt;SslStream&lt;TcpStream&gt;&gt;, receiver: Receiver&lt;String&gt;) -&gt; std::result::Result&lt;(), ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;              #[async]&#xA;        &#xA;        &#xA;          &#xA;              for msg in receiver {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  writer = await!(write_all(writer, msg))?.0;&#xA;        &#xA;        &#xA;          &#xA;                  writer = await!(write_all(writer, b&quot;\r\n\r\n&quot;))?.0;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              Ok(())&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          write.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;You can see the funny .0 references, which is an artifact of the fact that the write_all() function consumes the writer we pass to it and return (a potentially different) writer in the result.&#xA0; This is pretty common for functional languages.I&#x2019;m pretty sure that I can avoid the two calls to write_all for the postfix, but that is easier for now.Processing the commands is simple as well:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          #[async]&#xA;        &#xA;        &#xA;          &#xA;          fn process_commands(server: Arc&lt;Server&gt;, reader: ReadHalf&lt;SslStream&lt;TcpStream&gt;&gt;, mut sender: Sender&lt;String&gt;)&#xA;        &#xA;        &#xA;          &#xA;            -&gt; std::result::Result&lt;(), ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let cmds = FramedRead::new(reader, CommandCodec::new());&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              #[async]&#xA;        &#xA;        &#xA;          &#xA;              for cmd in cmds {&#xA;        &#xA;        &#xA;          &#xA;                  let cmd_to_run = server.cmd_handlers.get(&amp;cmd.args[0])&#xA;        &#xA;        &#xA;          &#xA;                      .map(|h| h.clone());&#xA;        &#xA;        &#xA;          &#xA;                  match cmd_to_run {&#xA;        &#xA;        &#xA;          &#xA;                      None =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                          sender = await!(sender.send(format!(&quot;ERR Uknown command {}&quot;, cmd.args[0])))?;&#xA;        &#xA;        &#xA;          &#xA;                          return Err(ConnectionError::InvalidCommand{cmd: cmd.args[0].clone()});&#xA;        &#xA;        &#xA;          &#xA;                      },&#xA;        &#xA;        &#xA;          &#xA;                      Some(f) =&gt;{&#xA;        &#xA;        &#xA;          &#xA;                          match f(cmd){&#xA;        &#xA;        &#xA;          &#xA;                              Err(e) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                                   sender = await!(sender.send(e.to_string()))?;&#xA;        &#xA;        &#xA;          &#xA;                                   return Err(e);&#xA;        &#xA;        &#xA;          &#xA;                              },&#xA;        &#xA;        &#xA;          &#xA;                              Ok(v) =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                                  sender = await!(sender.send(v))?;&#xA;        &#xA;        &#xA;          &#xA;                              }&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(())&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          cmds.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;For each command we support, we have an entry on the server configuration and we fetch and invoke it. The result of the command will be written to the client by the write task. Right now we have a 1:1 association between them, but this is now easily broken.And finally, having an actually command run and running the server itself:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          fn echo(cmd: server::cmd::Cmd) -&gt; std::result::Result&lt;String, ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(cmd.args[1].clone())&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          fn main() -&gt; std::result::Result&lt;(), server::err::ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;              let mut server = server::Server::new(&#xA;        &#xA;        &#xA;          &#xA;                  &quot;server.pem&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  &quot;server.key&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  // allowed thumprints&#xA;        &#xA;        &#xA;          &#xA;                  &amp;[&quot;1776821db1002b0e2a9b4ee3d5ee14133d367009&quot;],&#xA;        &#xA;        &#xA;          &#xA;              )?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  Arc::get_mut(&amp;mut server).unwrap()&#xA;        &#xA;        &#xA;          &#xA;                      .handle(&quot;echo&quot;.to_string(), echo);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let listener = TcpListener::bind(&amp;&quot;127.0.0.1:4888&quot;.parse::&lt;std::net::SocketAddr&gt;()?)?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              println!(&quot;Started&quot;);&#xA;        &#xA;        &#xA;          &#xA;              tokio::run(server::Server::accept_connections(server, listener).map_err(|_| ()));&#xA;        &#xA;        &#xA;          &#xA;              Ok(())&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          server.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This is pretty simple now, and it give us a nice model to program commands and responses.I pushed the whole code to this branch, if you care to look at it.I have some more comments about this code, but I&#x2019;ll reserve them for another post.</p>
        </article>
        <article id="article-2050">
            <a href="https://ayende.com/blog/186017-A/pesky-code-review-comments" target="_blank">
                <h2 class="title mb-6" id="article-2050">Pesky code review comments</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 24, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A large portion of my day to day tasks is to review code. I&#x2019;m writing this post barely two weeks into the new year, and we already had over 150 PRs going into RavenDB alone. As a result, I&#x2019;ve gotten sensitive to certain issues. For example, the following is a suggestion made for fixing an issue in this method declaration:This is a piece of code (in C) that is meant to handle some low level details for RavenDB. We use the CLR coding conventions for C#, but for C, we have chosen to use a different convention, using snake_case for methods, arguments and variables and SHOUTING_CASE for constants / defines. When reading through the code, I marked this violation of the naming convention for a fix.This may seem minor, but it is probably annoying for the author of the code. They are interested in comments about the code functionality and utility. Why spend any time on something that doesn&#x2019;t really have any impact? Both forms of the parameter name are just as readable to me, after all.Before I get to this part, I want to show another piece of code. Or, to be rather more exact, two pieces of code. One of the reasons that we are using C code is that we can abstract large parts of the underlying platform inside the native code. That means that we have certain parts of the code that are written twice. Once for Windows and once for Linux.Here is some code for Windows:And here is the same code for Linux:You can see that this is pretty much the same thing, just calling the different APIs for each platform. Once thing to notice here is that part of this method&#x2019;s task is to ensure that the file that we open is at least as big as the initially requested size.In Windows, to increase or decrease the file size you call SetFilePointer() followed by SetEndOfFile(). On Linux, you have fallocate() and ftruncate()*.This is reflected in the code. The Windows code has a single method to do this work and the Linux method has two methods. rvn_allocate_file_space() and rvn_truncate_file() which isn&#x2019;t shown here.* Actually, you might have fallocate(). Some file systems do not support it, and you need to use another workaround. One of my code review comments has been that this need to be fixed, that we should have a _resize_file() method for Linux that would simple call the appropriate method based on the file size. But the question is, why?These are two separate implementations for two separate operating systems. We are already creating the higher level abstraction level with operations that hide many system details. Why do I want to have a passthrough method just because the Windows code has this method?The answer here, as in the case above with the parameter name, is the same. Consistency.This it most obvious in the naming convention, but it is the same reasoning I had when I wanted to have the same method structure for both Linux and Windows. Consistency is key for being able to slog through a lot of code. It is how I (and the rest of the team) can go through thousands of lines of code per week and understand what is going on. Because when we look at a piece of code, it follow certain conventions and structure. Reading the code is easy because we can ignore a lot of cruft around it and focus on what is going on.In the case of the Windows / Linux methods, I first read one method and then the next, making sure that we are doing the same thing on all platforms. The different behavior (resize vs. allocate) was very obvious to me, which meant that I had to stop, go and look at each method&#x2019;s implementation to figure out whatever there is any meaningful difference between them. That was a chore, and it would only become worse over time as we add additional functionality, so anything that isn&#x2019;t different because it has to be different should match.In general, I like code reviews where I can scan through the changes and not see the code, but it&#x2019;s purpose. That happens when there isn&#x2019;t anything there that I really have to think about and the intent is clear.When writing in C#, we have decades (literally) of experience and organizational inertia that push us in the right direction. When push C code into the repository, I started to actually pay attention to those details explicitly, because I suddenly need to.This is apparent in code reviews, but it isn&#x2019;t just the case of me trying to make my own tasks easier. Code is read a lot more often than it is written, and focusing on making the code itself boring will pay off, because what the code is doing is what should be interesting in the long run.</p>
        </article>
        <div class="button flex justify-between">
            <a href="204.html"><span class="back arrow"></span></a>

            <a href="206.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	"> Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
