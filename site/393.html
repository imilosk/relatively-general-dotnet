
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 393 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3921">
            <a href="https://ayende.com/blog/163554/voron-lmdb-and-the-external-apis-on-my" target="_blank">
                <h2 class="title mb-6" id="article-3921">Voron, LMDB and the external APIs, on my!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 27, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that I really don&#x2019;t like in LMDB is the API that is exposed to the user. Well, it is C, so I guess there isn&#x2019;t much that can be done about it. But let look at the abstractions that are actually exposed to the user by looking how you usually work with Voron.      1: using (var tx = Env.NewTransaction(TransactionFlags.ReadWrite))   2: {   3:     Env.Root.Add(tx, &quot;key/1&quot;, new MemoryStream(Encoding.UTF8.GetBytes(&quot;123&quot;)));   4:&#xA0;    5:     tx.Commit();   6: }   7:&#xA0;    8:&#xA0;    9: using (var tx = Env.NewTransaction(TransactionFlags.Read))  10: {  11:     using(var stream = Env.Root.Read(tx, &quot;key/1&quot;))  12:     using (var reader = new StreamReader(stream))  13:     {  14:         var result = reader.ReadToEnd();  15:         Assert.Equal(&quot;123&quot;, result);  16:     }  17:     tx.Commit();  18: }&#xA;This is a perfectly nice API, it is quite explicit about what is going on, and it gives you a lot of options with regards to how to actually make things happen. It also gives the underlying library about zero chance to do interesting things. Worse, it means that you have to know, upfront, if you want to do a read only or a read/write operation. And since there can be only one write transaction at any given point in time&#x2026; well, I think you get the point. If you code doesn&#x2019;t respond well to explicit demarcation between read/write, you have to create a lot of writes transaction, essentially serializing pretty much your entire codebase.&#xA;Now, sure, you might have good command / query separation, right? So you have queries for reads and commands for writes, problem solved. Except that the real world doesn&#x2019;t operate in this manner. Let us consider the trivial case of a user logging in. When a user logs in, we need to check the credentials, and if they are wrong, we need to mark it so we can lock the account after 5 failed tries. That means either having to always do the login in a write transaction (meaning only one user can log it at any time) or we start with a read transaction, then we switch to a write transaction when we need to write.&#xA;Either option isn&#x2019;t really nice as far as I am concerned. Therefor, I came with a different API (which is internally based on the one above). This now looks like this:&#xA;&#xA;&#xA;   1: var batch = new WriteBatch();   2: batch.Add(&quot;key/1&quot;, new MemoryStream(Encoding.UTF8.GetBytes(&quot;123&quot;)), null);   3:&#xA0;    4: Env.Writer.Write(batch);   5:&#xA0;    6: using (var snapshot = Env.CreateSnapshot())   7: {   8:     using (var stream = snapshot.Read(null, &quot;key/1&quot;))   9:     using (var reader = new StreamReader(stream))  10:     {  11:         var result = reader.ReadToEnd();  12:         Assert.Equal(&quot;123&quot;, result);  13:     }  14: }&#xA;As you can see, we make use of snapshots &amp; write batches. Those are actually ideas taken from LevelDB. A write batch is a set of changes that we want to apply to the database. We can add any number of changes to the write batch, and it require no synchronization. When we want to actually write those changes, we call Writer.Write(). This will take the entire batch and apply it as a single transactional unit. &#xA;However, while it will do so as a single unit, it will also be able to merge concurrent calls to WriteBatch into a single write transaction, increasing the actual concurrency we gain by quite a bit. The expected usage pattern is that you create a snapshot, do whatever you need to do when reading the data, including maybe adding/removing stuff via a WriteBatch, and finally you write it all out. &#xA;Problems with this approach:&#xA;&#xA;You can&#x2019;t read stuff that you just added, because they haven&#x2019;t been added yet to the actual storage yet. (Generally not that much of an issue in our expected use case)&#xA;You need to worry about concurrently modifying the same value in different write batches. (We&#x2019;re going to add optimistic concurrency option for that purpose)&#xA;Benefits of this approach:&#xA;&#xA;We can optimize concurrent writes.&#xA;We don&#x2019;t have to decide in advance whatever we need to read only or read / write.</p>
        </article>
        <article id="article-3922">
            <a href="https://ayende.com/blog/163265/challenge-spot-the-bug" target="_blank">
                <h2 class="title mb-6" id="article-3922">Challenge</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 26, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Speaking of unfair interview questions, this would be a pretty evil one.   Can you see the bug? And how would you fix it?</p>
        </article>
        <article id="article-3923">
            <a href="https://ardalis.com/3-places-you-should-deploy-your-important-web-site-to/" target="_blank">
                <h2 class="title mb-6" id="article-3923">3 Places You Should Deploy Your Important Web Site To</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 25, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">You&#x2019;ve got a web site, and you think it&#x2019;s important. Or your boss does. Or your customers do. In any case, someone will notice when that&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-3924">
            <a href="https://ayende.com/blog/163521/what-is-your-control-group" target="_blank">
                <h2 class="title mb-6" id="article-3924">What is your control group?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 25, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the areas that where we think Voron can be improved is the free space utilization policy. In particular, smarter free space utilization can lead to better performance, since we won&#x2019;t have to seek so much. I spent some time working on that, and I got something that on paper, at least, looks much better, performance wise. But&#x2026; actual benchmarks showed little to no improvement, and in some cases, actual degradation! That was the point when I realize that I actually needed to have some sort of a control, to see what would be the absolute optimal scenario for us. So I wrote a null free space policy. With no free space, Voron will always go to the end of the file, giving us the best case scenario of sequential writes. This gives us the following behavior: Flush      1 with   2 pages -   8 kb writes and   1 seeks (  2 leaves,   0 branches,   0 overflows)&#xA;Flush      2 with   8 pages -  32 kb writes and   1 seeks (  7 leaves,   1 branches,   0 overflows)&#xA;Flush      3 with  10 pages -  40 kb writes and   1 seeks (  9 leaves,   1 branches,   0 overflows)&#xA;Flush     27 with  74 pages - 296 kb writes and   1 seeks ( 72 leaves,   2 branches,   0 overflows)&#xA;Flush     28 with  74 pages - 296 kb writes and   1 seeks ( 72 leaves,   2 branches,   0 overflows)&#xA;Flush     29 with  72 pages - 288 kb writes and   1 seeks ( 70 leaves,   2 branches,   0 overflows)&#xA;Flush  1,153 with 155 pages - 620 kb writes and   1 seeks (102 leaves,  53 branches,   0 overflows)&#xA;Flush  1,154 with 157 pages - 628 kb writes and   1 seeks (104 leaves,  53 branches,   0 overflows)&#xA;Flush  1,155 with 165 pages - 660 kb writes and   1 seeks (108 leaves,  57 branches,   0 overflows)&#xA;Flush  4,441 with 191 pages - 764 kb writes and   1 seeks (104 leaves,  87 branches,   0 overflows)&#xA;Flush  4,442 with 196 pages - 784 kb writes and   1 seeks (107 leaves,  89 branches,   0 overflows)&#xA;Flush  4,443 with 198 pages - 792 kb writes and   1 seeks (108 leaves,  90 branches,   0 overflows)&#xA;Flush  7,707 with 200 pages - 800 kb writes and   1 seeks (106 leaves,  94 branches,   0 overflows)&#xA;Flush  7,708 with 204 pages - 816 kb writes and   1 seeks (106 leaves,  98 branches,   0 overflows)&#xA;Flush  7,709 with 211 pages - 844 kb writes and   1 seeks (113 leaves,  98 branches,   0 overflows)&#xA;Flush  9,069 with 209 pages - 836 kb writes and   1 seeks (107 leaves, 102 branches,   0 overflows)&#xA;Flush  9,070 with 205 pages - 820 kb writes and   1 seeks (106 leaves,  99 branches,   0 overflows)&#xA;Flush  9,071 with 208 pages - 832 kb writes and   1 seeks (108 leaves, 100 branches,   0 overflows)&#xA;&#xA;&#xA;And with this, 10,000 transactions with 100 random values each &#xA;fill rnd buff separate tx          :    106,383 ms      9,400 ops / sec&#xA;&#xA;&#xA;And that tells me that for the best case scenario, there is something else that is causing this problem, and it ain&#x2019;t the cost of doing seeks. I dropped the number of transactions to 500 and run it through a profiler, and I got the following:&#xA;&#xA;&#xA;In other words, pretty much the entire time was spent just calling FlushViewOfFile. However, I think that we optimized that enough already, didn&#x2019;t we? Looking at the calls, it seems that we have just one FlushViewOfFile per transaction in this scenario.&#xA;In fact, looking at the actual system behavior, we can see:&#xA;&#xA;So seeks wise, we are good. What I can&#x2019;t understand, however, is why we see those ReadFile calls. Looking at the data, it appears that we run into this whenever we access now portion of the file, so this is the mmap subsystem paging the file contents into memory before we start doing that. It is actually pretty great that it is able to page 1 MB at a time.&#xA;Next, let us see what else we can do here. I run the 500 tx test on an HDD drive. And it have given me the following results.&#xA;fill rnd sync separate tx          :     25,540 ms      1,958 ops / sec&#xA;&#xA;&#xA;But note that each write has two writes. One at the end of the file, and one at the file beginning (which is the actual final act of the commit). What happened if we just removed that part?&#xA;This give me a very different number:&#xA;fill rnd sync separate tx          :     21,764 ms      2,297 ops / sec&#xA;&#xA;&#xA;So just seeking and writing a single page cost us 17% of our performance. Here are the details from running this test:&#xA;&#xA;Now, this is a meaningless test, added just to check what the relative costs are. We have to do the header write, otherwise we can&#x2019;t do real transactions.&#xA;For fun, I run the same thing using sequential write, giving me 3,619 ops / sec. Since in both cases we are actually doing sequential writes, the major differences was how much we actually wrote. This is the view of writing sequentially:&#xA;&#xA;As you can see, we only have to write 8 &#x2013; 10 pages per transaction, compare to 110 &#x2013; 130 in the random case. And that obviously has a lot of implications.&#xA;All of this has thought me something very important. In the end, the actual free space policy matters, but not that much. So I need to select something that is good, but that is about it.</p>
        </article>
        <article id="article-3925">
            <a href="https://ayende.com/blog/163810/ravendb-3-0-mystery-feature-1-recorded" target="_blank">
                <h2 class="title mb-6" id="article-3925">RavenDB 3.0 Mystery Feature #1&#x2013;Recorded</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 24, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20"></p>
        </article>
        <article id="article-3926">
            <a href="https://ayende.com/blog/162915/so-what-have-you-been-learning-lately" target="_blank">
                <h2 class="title mb-6" id="article-3926">So, what have YOU been learning lately?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 24, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the worst things that can happen to you professionally is stagnation. You know what you are doing, you know how it works, and you can coast along very easily. Unfortunately, there is the old, it isn&#x2019;t what we know that we don&#x2019;t know that is going to hurt us. It is what we don&#x2019;t know that we don&#x2019;t know that is going to bite us in the end. One of the reasons that I have routinely been going out and searching for difficult codebases to read has been to avoid that. I know that I don&#x2019;t know a lot, I just don&#x2019;t know what I don&#x2019;t know. So I go into an unfamiliar codebase and try to figure out how things work over there. I have been doing that for quite some time now. And I am not talking about looking at some sample project a poo schlump put out to show how you can do CQRS with 17 projects to create a ToDo app. I am talking about production code, and usually in areas or languages that I am not familiar with. A short list of the stuff that I have been gone over:  CouchDB (to learn Erlang, actually, but that got me to do DB stuff). LevelDB LMDB NServiceBus Mass Transit SignalR Hibernate Hibernate Search Those are codebases that do interesting things that I wanted to learn from. Indeed, I have learned from each of those. Some people can learn by reading academic papers, I find that I learn best from having a vague idea about what is going on, then diving into the implementation details and seeing how it all fits together.  But the entire post so far was a preface to the question I wanted to ask. If you are reading this post, I am pretty sure that you are a professional developer. Doctors, lawyers and engineers (to name a few) have to recertify every so often, to make sure that they are current. But I have seen all too many developers stagnate to the point where they are very effective in their chosen field (building web apps with jQuery Mobile on ASP.Net WebForms 3.5) and nearly useless otherwise.  So, how are you keeping your skills sharp and your knowledge current? What have you been learning lately? It can be a course, or a book or a side project or just reading code. But, in my opinion, it cannot be something passive. If you were going to answer: &#x201C;I read your blog&#x201D; as the answer to that question, that is not sufficient, flatterer. Although, you might want to go a bit further and consider that imitation is the sincerest form of flattery, so go ahead and do something.</p>
        </article>
        <article id="article-3927">
            <a href="https://ayende.com/blog/163777/hibernating-rhinos-and-managed-designs-announce-enterprise-partnership-related-to-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-3927">Hibernating Rhinos and Managed Designs announce enterprise partnership related to RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 23, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">September 23, 2013 Deal will allow Hibernating Rhinos customers to get premium level consulting and support services provided by Managed Designs across Europe  Milan, Italy and Sede Izhak, Israel &#x2013; September 23, 2013. Hibernating Rhinos and Managed Designs today announced a partnership that will allow Hibernating Rhinos customers to get premium level consulting, support and training services appointing Managed Designs as its official partner for the following European countries: &#xB7; West Europe Countries: Portugal, Spain (including Andorra), France (including Monaco); &#xB7; Central Europe Countries: Luxemburg, Belgium, Germany, Switzerland, Nederland, United Kingdom and Ireland, Denmark, Sweden, Norway, Finland, Austria and Italy (including San Marino and Vatican City) &#xB7; East Europe Countries: Czech Republic, Poland, Hungary, Slovakia, Slovenia, Bosnia Herzegovina, Croatia, Serbia, Albania and Greece, Romania and Bulgaria As per this partnership &#x201C;Hibernating Rhinos is committed on developing and marketing a first class document database and wants its customers to get the best experience out of it, so we&#x2019;re glad having Managed Designs assisting them&#x201D; said Oren Eini, CEO of Hibernating Rhinos.  &#x201C;Managed Designs has been enjoying RavenDB for years now, and we&#x2019;re excited to have been engaged by Hibernating Rhinos in order to have their customers getting the best experience out of the product&#x201D;, said Andrea Saltarello, CEO of Managed Designs. About Hibernating Rhinos Hibernating Rhinos LTD is an Israeli based company, focused on delivering products and services in the database infrastructure field. For more information about Hibernating Rhinos, visit http://www.hibernatingrhinos.com About Managed Designs Managed Designs provides consulting, education and software development services helping customers to find solutions to their business problems. For more information about Managed Designs, visit http://www.manageddesigns.it RavenDB is a registered trademark of Hibernating Rhinos and/or its affiliates. Other names may be trademarks of their respective owners.</p>
        </article>
        <article id="article-3928">
            <a href="https://ayende.com/blog/163267/raven-storage-vorons-performance" target="_blank">
                <h2 class="title mb-6" id="article-3928">Raven Storage&#x2013;Voron&#x2019;s Performance</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 20, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Voron is the code name for another storage engine that we are currently trying, based on LMDB. After taking that for a spin for a while, it is not pretty complete, and I decided to give it some perf test runs. So far, there has been zero performance work. All the usual caveat applies here, with regards to short test runs, etc.&#xA;&#xA;&#x9;Just like before, we found that this is horribly slow on the first run. The culprit was our debug code that verified the entire structure whenever we added or removed something. One we run it in release mode we started getting more interesting results.&#xA;&#xA;&#x9;Here is the test code:&#xA;&#xA;&#x9;using (var env = new StorageEnvironment(new MemoryMapPager(&quot;bench.data&quot;, flushMode)))&#xA;{&#xA;    using (var tx = env.NewTransaction(TransactionFlags.ReadWrite))&#xA;    {&#xA;        var value = new byte[100];&#xA;        new Random().NextBytes(value);&#xA;        var ms = new MemoryStream(value);&#xA;        for (long i = 0; i &lt; Count; i&#x2B;&#x2B;)&#xA;        {&#xA;            ms.Position = 0;&#xA;            env.Root.Add(tx, i.ToString(&quot;0000000000000000&quot;), ms);&#xA;        }&#xA;&#xA;        tx.Commit();&#xA;    }&#xA;     using (var tx = env.NewTransaction(TransactionFlags.ReadWrite))&#xA;     {&#xA;         DebugStuff.RenderAndShow(tx, tx.GetTreeInformation(env.Root).Root);&#xA;&#xA;         tx.Commit();&#xA;     }&#xA;}&#xA;&#x9;&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;We write 1 million entries with 100 bytes in size and 8 bytes of the key. We run it in three mode:&#xA;&#xA;&#x9;fill seq none &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;9,578 ms &#xA0; &#xA0;104,404 ops / sec&#xA;&#xA;&#x9;fill seq buff &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; 10,802 ms &#xA0; &#xA0; 92,575 ops / sec&#xA;&#xA;&#x9;fill seq sync &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;9,387 ms &#xA0; &#xA0;106,528 ops / sec&#xA;&#xA;&#xA;&#xA;&#x9;None means no flushing to disk, let the OS deals with that completely. Buffers means flush to the OS, but not to disk, and full means do a full fsync.&#xA;&#xA;&#x9;Now, this is pretty stupid way to go about it, I&#x2019;ve to say. This is doing everything in a single transaction, and we are actually counting the time to close &amp; open the db here as well, but that is okay for now. We aren&#x2019;t interested in real numbers, just some rough ideas.&#xA;&#xA;&#x9;Now, let us see how we read it?&#xA;&#xA;&#x9;using (var env = new StorageEnvironment(new MemoryMapPager(&quot;bench.data&quot;)))&#xA;{&#xA;    using (var tx = env.NewTransaction(TransactionFlags.Read))&#xA;    {&#xA;        var ms = new MemoryStream(100);&#xA;        for (int i = 0; i &lt; Count; i&#x2B;&#x2B;)&#xA;        {&#xA;            var key = i.ToString(&quot;0000000000000000&quot;);&#xA;            using (var stream = env.Root.Read(tx, key))&#xA;            {&#xA;                ms.Position = 0;&#xA;                stream.CopyTo(ms);&#xA;            }&#xA;        }&#xA;&#xA;        tx.Commit();&#xA;    }&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And this gives us:&#xA;&#xA;&#x9;read seq &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; : &#xA0; &#xA0; &#xA0;3,289 ms &#xA0; &#xA0;304,032 ops / sec&#xA;&#xA;&#x9;And again, this is with opening &amp; closing the entire db.&#xA;&#xA;&#x9;We could do better with pre-allocation of space on the disk, etc. But I wanted to keep things realistic and to allow us to grow.&#xA;&#xA;&#x9;Next, I wanted to see how much we would gain by parallelizing everything, so I wrote the following code:&#xA;&#xA;&#x9;using (var env = new StorageEnvironment(new MemoryMapPager(&quot;bench.data&quot;)))&#xA;{&#xA;    var countdownEvent = new CountdownEvent(parts);&#xA;    for (int i = 0; i &lt; parts; i&#x2B;&#x2B;)&#xA;    {&#xA;        var currentBase = i;&#xA;        ThreadPool.QueueUserWorkItem(state =&gt;&#xA;        {&#xA;            using (var tx = env.NewTransaction(TransactionFlags.Read))&#xA;            {&#xA;                var ms = new MemoryStream(100);&#xA;                for (int j = 0; j &lt; Count / parts; j&#x2B;&#x2B;)&#xA;                {&#xA;                    var current = j * currentBase;&#xA;                    var key = current.ToString(&quot;0000000000000000&quot;);&#xA;                    using (var stream = env.Root.Read(tx, key))&#xA;                    {&#xA;                        ms.Position = 0;&#xA;                        stream.CopyTo(ms);&#xA;                    }&#xA;                }&#xA;&#xA;                tx.Commit();&#xA;            }&#xA;&#xA;            countdownEvent.Signal();&#xA;        });&#xA;    }&#xA;    countdownEvent.Wait();&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;I then run it with 1 &#x2013; 16 parts, so see how it behaves. Here are the details for this machine:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;And the results pretty much match what I expected:&#xA;&#xA;&#x9;read seq &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; : &#xA0; &#xA0; &#xA0;3,317 ms &#xA0; &#xA0;301,424 ops / sec&#xA;&#xA;&#x9;read parallel 1 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;2,539 ms &#xA0; &#xA0;393,834 ops / sec&#xA;&#xA;&#x9;read parallel 2 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;1,950 ms &#xA0; &#xA0;512,711 ops / sec&#xA;&#xA;&#x9;read parallel 4 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;2,201 ms &#xA0; &#xA0;454,172 ops / sec&#xA;&#xA;&#x9;read parallel 8 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;2,139 ms &#xA0; &#xA0;467,387 ops / sec&#xA;&#xA;&#x9;read parallel 16 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; : &#xA0; &#xA0; &#xA0;2,010 ms &#xA0; &#xA0;497,408 ops / sec&#xA;&#xA;&#x9;We get a 2x perf improvement from running on two cores, running on 4 threads require some dancing around, which caused some perf drop, then we see more time spent in thread switching than anything else, pretty much. As you can see, we see a really pretty jump in performance the more cores we use, until we reach the actual machine limitations.&#xA;&#xA;&#x9;Note that I made sure to clear the OS buffer cache before each test. If we don&#x27;t do that, we get:&#xA;&#xA;&#x9;read seq &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; : &#xA0; &#xA0; &#xA0;2,562 ms &#xA0; &#xA0;390,291 ops / sec&#xA;&#xA;&#x9;read parallel 1 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;2,608 ms &#xA0; &#xA0;383,393 ops / sec&#xA;&#xA;&#x9;read parallel 2 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;1,868 ms &#xA0; &#xA0;535,220 ops / sec&#xA;&#xA;&#x9;read parallel 4 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;1,646 ms &#xA0; &#xA0;607,283 ops / sec&#xA;&#xA;&#x9;read parallel 8 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;: &#xA0; &#xA0; &#xA0;1,673 ms &#xA0; &#xA0;597,557 ops / sec&#xA;&#xA;&#x9;read parallel 16 &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; : &#xA0; &#xA0; &#xA0;1,581 ms &#xA0; &#xA0;632,309 ops / sec&#xA;&#xA;&#x9;So far, I am pretty happy with those numbers. What I am not happy is the current API, but I&#x2019;ll talk about this in a separate post.</p>
        </article>
        <article id="article-3929">
            <a href="https://ayende.com/blog/163457/optimizing-writes-in-voron" target="_blank">
                <h2 class="title mb-6" id="article-3929">Optimizing writes in Voron</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 19, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">As I mentioned, one of the things that I have been working on with Voron is optimizing the sad case of random writes.&#xA0; I discussed some of the issues that we had already, and now I want to explain how we approach resolving them. With LMDB, free space occur on every write, because we don&#x2019;t make modifications in place, instead, we make modifications to a copy, and free the existing page to be reclaimed later. The way the free space reclamation work, a new page can be allocated anywhere on the file. That can lead to a lot of seeks. With Voron, we used a more complex policy. The file is divided in 4 MB sections. And we will aggregate free space in each section. When we need more space, we will find a section with enough free space and use that, and we will continue to use that for as long as we can. The end result is that we tend to be much more local in the way we are reusing space. Here are the original results: Flush     1 with  12 pages   - 48 kb writes and 1  seeks   (11 leaves, 1 branches, 0 overflows)&#xA;Flush     2 with  13 pages   - 52 kb writes and 1  seeks   (12 leaves, 1 branches, 0 overflows)&#xA;Flush     3 with  21 pages   - 84 kb writes and 1  seeks   (20 leaves, 1 branches, 0 overflows)&#xA; &#xA;Flush    27 with  76 pages   - 304 kb writes and 1 seeks  (75 leaves,  1 branches, 0 overflows)&#xA;Flush    28 with  73 pages   - 292 kb writes and 1 seeks  (72 leaves,  1 branches, 0 overflows)&#xA;Flush    29 with  84 pages   - 336 kb writes and 1 seeks  (80 leaves,  4 branches, 0 overflows)&#xA; &#xA;Flush 1,153 with 158 pages - 632 kb writes and 67  seeks (107 leaves, 51 branches, 0 overflows)&#xA;Flush 1,154 with 168 pages - 672 kb writes and 65  seeks (113 leaves, 55 branches, 0 overflows)&#xA;Flush 1,155 with 165 pages - 660 kb writes and 76  seeks (113 leaves, 52 branches, 0 overflows)&#xA; &#xA;Flush 4,441 with 199 pages - 796 kb writes and 146 seeks (111 leaves, 88 branches, 0 overflows)&#xA;Flush 4,442 with 198 pages - 792 kb writes and 133 seeks (113 leaves, 85 branches, 0 overflows)&#xA;Flush 4,443 with 196 pages - 784 kb writes and 146 seeks (109 leaves, 87 branches, 0 overflows)&#xA; &#xA;Flush 7,707 with 209 pages - 836 kb writes and 170 seeks (111 leaves, 98 branches, 0 overflows)&#xA;Flush 7,708 with 217 pages - 868 kb writes and 169 seeks (119 leaves, 98 branches, 0 overflows)&#xA;Flush 7,709 with 197 pages - 788 kb writes and 162 seeks (108 leaves, 89 branches, 0 overflows)&#xA; &#xA;Flush 9,069 with 204 pages - 816 kb writes and 170 seeks (108 leaves, 96 branches, 0 overflows)&#xA;Flush 9,070 with 206 pages - 824 kb writes and 166 seeks (112 leaves, 94 branches, 0 overflows)&#xA;Flush 9,071 with 203 pages - 812 kb writes and 169 seeks (105 leaves, 98 branches, 0 overflows)&#xA;&#xA;&#xA;And here are the improved results:&#xA;Flush      1 with   2 pages -     8 kb writes and   1 seeks (  2 leaves,   0 branches,   0 overflows)&#xA;Flush      2 with   8 pages -    32 kb writes and   1 seeks (  7 leaves,   1 branches,   0 overflows)&#xA;Flush      3 with  10 pages -    40 kb writes and   1 seeks (  9 leaves,   1 branches,   0 overflows)&#xA;  &#xA;Flush     27 with  73 pages -   292 kb writes and   1 seeks ( 72 leaves,   1 branches,   0 overflows)&#xA;Flush     28 with  72 pages -   288 kb writes and   1 seeks ( 71 leaves,   1 branches,   0 overflows)&#xA;Flush     29 with  71 pages -   284 kb writes and   1 seeks ( 70 leaves,   1 branches,   0 overflows)&#xA;  &#xA;Flush  1,153 with 157 pages -   628 kb writes and  11 seeks (105 leaves,  52 branches,   0 overflows)&#xA;Flush  1,154 with 159 pages -   636 kb writes and   2 seeks (107 leaves,  52 branches,   0 overflows)&#xA;Flush  1,155 with 167 pages -   668 kb writes and  17 seeks (111 leaves,  56 branches,   0 overflows)&#xA;  &#xA;Flush  4,441 with 210 pages -   840 kb writes and  11 seeks (121 leaves,  86 branches,   3 overflows)&#xA;Flush  4,442 with 215 pages -   860 kb writes and   1 seeks (124 leaves,  88 branches,   3 overflows)&#xA;Flush  4,443 with 217 pages -   868 kb writes and   9 seeks (126 leaves,  89 branches,   2 overflows)&#xA;  &#xA;Flush  7,707 with 231 pages -   924 kb writes and   7 seeks (136 leaves,  93 branches,   2 overflows)&#xA;Flush  7,708 with 234 pages -   936 kb writes and   9 seeks (136 leaves,  97 branches,   1 overflows)&#xA;Flush  7,709 with 241 pages -   964 kb writes and  13 seeks (140 leaves,  97 branches,   4 overflows)&#xA;&#xA;Flush  9,069 with 250 pages - 1,000 kb writes and   6 seeks (144 leaves, 101 branches,   5 overflows)&#xA;Flush  9,070 with 250 pages - 1,000 kb writes and  13 seeks (145 leaves,  98 branches,   7 overflows)&#xA;Flush  9,071 with 248 pages -   992 kb writes and  12 seeks (143 leaves,  99 branches,   6 overflows)&#xA;&#xA;&#xA;Let us plot this in a chart, so we can get a better look at things:&#xA;&#xA;As you can see, this is a pretty major improvement. But it came at a cost, let us see the cost of size per transaction&#x2026;&#xA;&#xA;So we improved on the seeks / tx, but got worse on the size / tx. That is probably because of the overhead of keeping the state around, but it also relates to some tunable configuration that we added (the amount of free space in a section that will make it eligible for use.&#xA;Annoyingly, after spending quite a bit of time &amp; effort on this, we don&#x2019;t see a major perf boost here. But I am confident that it&#x2019;ll come.</p>
        </article>
        <article id="article-3930">
            <a href="https://ayende.com/blog/163426/field-tokenization-a-problem-analysis" target="_blank">
                <h2 class="title mb-6" id="article-3930">Field Tokenization: A problem analysis</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 18, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was asked about the problem of repeating property names in RavenDB. In particular, let us consider the following document:      1: {    2:     &quot;FirstName&quot;:&quot;John&quot;,   3:     &quot;LastName&quot;:&quot;Doe&quot;,   4:     &quot;BirthDay&quot;: &quot;1980-01-01&quot;,   5:     &quot;LastLoggedInAt&quot;: &quot;2013-08-10&quot;   6: }&#xA;There are 40 chars in this document that are dedicated solely for field names, and just 28 chars dedicate to actual data. Now, 40 vs 28 means that if we have 1 million of those documents, we are losing a lot of space for no good reason. Surely the database can do better on this, right? It can tokenize those things so instead of storing 40 bytes for fields, it would store only 16 (assuming int32 for token ids). And for larger documents, you would see an even more massive saving.&#xA;I think that I talked about this before, oh yes, here it is: http://ayende.com/blog/4669/you-saved-5-cents-and-your-code-is-not-readable-congrats, in which you manually (or via config at the client side) change the document to look like this:&#xA;&#xA;&#xA;   1: {    2:  &quot;FN&quot;:&quot;John&quot;,   3:  &quot;LN&quot;:&quot;Doe&quot;,   4:  &quot;BD&quot;: &quot;1980-01-01&quot;,   5:  &quot;LLD&quot;: &quot;2013-08-10&quot;   6: }&#xA;This is pretty horrible and I cover exactly why this is bad in the blob post above. Now, for 1 million documents, those 40 chars represent about 38MB of disk space. Not really a major issue, I think.&#xA;The actual question I was asked was (by Justin):&#xA;&#xA;Repeating keys is so silly MongoDB has a highly voted issue, marked major with a plan to fix. And many client libraries have code built that tries to shorten names for you:&#xA;https://jira.mongodb.org/browse/SERVER-863&#xA;I personally think reading and writing 2x or more data then necessary is not a silly issue, it impacts all aspects of performance and database management. Disk are cheap sure, then again if your database is smaller you might have been able to put it on a ssd or faster but smaller drive, or just transferred less bytes from that cheap disk to accomplish the same thing. Are you really going to tell me every byte doesn&#x27;t make a difference after examining these c code bases that do their best to save every byte for performance reasons?&#xA;The ugly solution shown above is a manual approach, but surely the db can do better, right? Interning property names is relatively simple conceptually, but a lot more complex in practice.&#xA;For example, if you want to do interning, you probably want to do it end to end. Which means that the client libs need to understand the server tokens. That means that you need some way of informing the client when there is a new interned property added, otherwise they wouldn&#x27;t be able to figure out the real property name. Then there is the issue of how you are going to handle sharding or replication. Is each server going to have its unique copy of the intern table? Is each client going to have to navigate that? Or are you going to try to have a single intern table, and somehow manage to agree on all the positions in that table among a distributed set of nodes? &#xA;Imagine what going to happen during failover, you suddenly need to get the intern table for each of the replicas. And making sure that you aren&#x27;t using the wrong intern table is going to be fun. Not to mention what happens when you have different clients talking to different servers, especially if you had a network split.&#xA;Even assuming that you don&#x27;t care for that, and only want this for saving disk I/O on the server, you are going to run into issue with concurrency management with regards to the itern list. If you have two transaction adding values that both require modifying the intern list, you are in an interesting problem. Not least of which because if you save just the property name id to the data store, instead of the full key, you have to be able to say that this is there if the transaction is committed, because otherwise you have an unknown (or wrong) property name when you read it back. So now you have concurrency issues, and the potential for conflicts because two transactions may be modifying the values of the intern table at the same time. For fun, assume that they both have documents with the same property name that needs to be added, as well as other property names.&#xA;And that doesn&#x27;t even take into account that it is actually pretty common to have dynamic property names. For example, dates &amp; times. You have 1 million documents, each of them have a property with the names like: &quot;2013-08-03T19:57:32.7060000Z&quot;&#xA0; A common scenario where this occurs is tracking things by time. For instance, if you want to track the amount of hours you worked on a bug. The document might look like this:&#xA;&#xA;   1: {   2:   &quot;2013-08-03T19:57:32.7060000Z&quot;:{   3:      &quot;Project&quot;:&quot;RavenDB&quot;,   4:      &quot;RavenDB-1248&quot;:&quot;Fixed&quot;,   5:      &quot;RavenDB-1212&quot;:&quot;Progress made&quot;   6:   }   7: }&#xA;As you can see, we actually have multiple properties with dynamic names here. It would be a waste to try to intern them. In fact, it is likely going to cause us to fall over and die. And wait for that to happen when you have to pass this to the client... fun &amp; joy all around.&#xA;But you know what, I can still probably go and figure out what the most 10,000 common field names are, and have a fixed table of those in place. This would give me the ability to handle things like Name, FirstName, Date, etc. Because it is a fixed list, it would means that a lot of the problems listed above don&#x2019;t matter. It would mean that if you wanted to call your property FirstNames, you might need to call it Names, because the first one would be in the list and won&#x2019;t be interned. &#xA;And that leads to a lot of interesting potential issues with backward and forward compatibility. How do I add more terms to the list? Older clients wouldn&#x2019;t be able to understand the tokens, and that leads to additional complication just managing the versioning story. And I can assure you that you&#x2019;ll have a lot of people clamoring and wanting to add their own unique properties to that list. (What do you mean &#x2018;PensionFundTarget&#x2019; isn&#x2019;t on the intern list, is a a really common term and we could really use the perf boost of that!).&#xA;And then we have the issue of debugging. Right now, you can watch what is going on over the wire using Fiddler very easily, and the values are easily understood. Do you really want to try to figure out data like this?&#xA;&#xA;&#xA;   1: {    2:  &quot;231&quot;:&quot;John&quot;,   3:  &quot;432&quot;:&quot;Doe&quot;,   4:  &quot;127&quot;: &quot;1980-01-01&quot;,   5:  &quot;5841&quot;: &quot;2013-08-10&quot;   6: }&#xA;In pretty much every aspect you can think of, this is a really crazy hard feature, and the benefits that it brings aren&#x2019;t really that important.&#xA;Sure, you can reduce the amount of data that you read from the disk. But that data is already sitting in the same place. And there is absolutely no difference between reading a 30 bytes value and a 200 bytes value (reads/writes are always done at a minimum of 512 bytes). So reading a bit of extra bytes means pretty much nothing to us. We don&#x2019;t have to seek to it, it is already there. And anyway, we have caches to alleviate that problem for us. &#xA;And reading from the disk isn&#x2019;t really our major problem, that is relatively cheap compare to sending the data to the user over the network. But wait, we actually have found a solution for that, we use gzip compression on the wire, a supported and well known method that you can easily see through with tools like Fiddler. That usually gives you the best of all worlds. You get small response size, you still use readable format, you don&#x2019;t have to deal with all of the issues mentioned above. Happy happy joy joy!&#xA;Hm&#x2026; can we not apply the same method internally on the server side? Sure we can. We can compress &amp; decompress data on the fly when we write / read to the disk, further reducing the amount of data that we write. &#xA;In RavenDB, we do both. Data is compressed on the wire, and can be compressed to the disk as well. &#xA;As for the MongoDB issue, it may be highly voted, it may be marked as major, but it has been sitting in the issue tracker for the past 3&#x2B; years. I would say that they aren&#x2019;t in any rush to resolve this. Probably for much the same reasons as I outlined here. It is cheap to vote for an issue, and usually the people setting the issue severity are the people creating it. I wouldn&#x2019;t put too much stock on anything like that.&#xA;Put simply, trying to solve this is a really hard problem, with a lot of cascading implication and dangerous side effects. Conversely there are more effective solutions that are cheaper, simpler and are orthogonal to everything else.&#xA;I think you can guess what I would pick.</p>
        </article>
        <div class="button flex justify-between">
            <a href="392.html"><span class="back arrow"></span></a>

            <a href="394.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>