
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 393 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3921">
            <a href="https://ayende.com/blog/164066/ravendb-acid-base" target="_blank">
                <h2 class="title mb-6" id="article-3921">RavenDB, ACID &amp; BASE</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 22, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Kelly Sommers has been commenting about transactional model on twitter.&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;&quot;Fully ACID writes but BASE reads&quot; - Go back to the books. You can&#x27;t selectively opt out of guarantees as you wish. What can client observe?&#xA;&#xA;&#xA;&#x9;And some other things in the same vien. I am going to assume that this is relevant for RavenDB, based on other tweetss from her. And I think that this requires more space than allowed on twitter. The gist of Kelly&#x27;s argument, as I understand it, is that RavenDB isn&#x27;t ACID because it does BASE reads.&#xA0;&#xA;&#xA;&#x9;I am not sure that I am doing the argument justice, and it is mostly pieced together from a whole bunch of tweets, so I would love to see a complete blog post about it. However, I think that at least with regards to RavenDB, there is a major misconception going on here.&#xA;&#xA;&#x9;RavenDB is an ACID database, period. If you put data in, you can be sure that the data will be there and you can get it out again. Indeed, the data you put in is immediately consistent. There is no scenario in which you can do any sequence of read/write/read/write and not immediately get the last committed state for that server. What I think is confusing people is the fact that we have implemented BASE queries. So let us go back a bit and discuss that.&#xA;&#xA;&#x9;Internally, RavenDB is structure as a set of components. One of those components in the document store, which is responsible for... storing documents (and a lot more besdie, but that isn&#x27;t very important right now). The document store is ACID. And it ensure consistency, MVCC, durability, and all that other good stuff.&#xA;&#xA;&#x9;The document store is also limited in the kind of queries that it support. In effect, it supports only the following:&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;Document by key&#xA;&#x9;&#xA;&#x9;&#x9;Document by key prefix&#xA;&#x9;&#xA;&#x9;&#x9;Documents by update order&#xA;&#xA;&#xA;&#x9;When talking about ACID, I am talking about this part of the system, in which you are writing documents and loading them by their id or by update order.&#xA;&#xA;&#x9;Note that in RavenDB, we use the term &quot;load&quot; to refer to accessing the document store. That is probably the cause for confusion. Loading is never inconsistent and obeys a strict snapshot isolation interpretation of the data. That means that asking something like: &quot;give me users/123&quot; is always going to give you the immediately consistent result.&#xA;&#xA;&#x9;In constrast to that, RavenDB also have the index store. The index store allows us to create complex queries, and that is subject to eventual consistency. That is by design, and a large part of what makes RavenDB able to dynamically adjust its own behavior at runtime based on production usage.&#xA0;&#xA;&#xA;&#x9;We have a separate background processes that apply the indexes to the incoming data, and write them to the actual index store. This is done in direct contrast to other indexing systems (for example, RDBMS) in which indexes are updated as part of the same transaction. That leads to several interesting results.&#xA;&#xA;&#x9;Indexes aren&#x27;t as expensive - In RDBMS, the more indexes you have, the slower your writes become. In RavenDB, indexes have no impact on the write code path,. That means that you can have a lot more indexes without worrying about it too much. Indexes still have cost, of course, but in most system, you just don&#x27;t feel it.&#xA;&#xA;&#x9;Lock free reads &amp; writes&#xA0;- Unlike other databases, where you have to pay the indexing cost either on write (common) or read (rare), with RavenDB both read &amp; writes operate without having to deal with the indexing cost. When you make a query, we will immediately give you an answer from the results that we have right now. When you perform a write, we will process that without waiting for indexing.&#xA;&#xA;&#x9;Dynamic load balancing - because we don&#x27;t promise immediate consistency, we can detect and scale back our indexing costs in time of high usage. That means that we can shift resources from indexing to answering queries or accepting writes. And we will be able to pick up the slack when the peek relaxes.&#xA0;&#xA;&#xA;&#x9;Choice&#xA0;- one of the things that we absolutely ensure is that we will tell you when you make a query and we give you results that might not be up to date. That means that when you get the reply, you can make an informed decision. &quot;This query is the result of all the data in the index as of 5 seconds ago&quot; - decide if this is good enough for you or if you want to wait. Unlike other systems, we don&#x27;t force you to accept whatever consistency model you have. You get to choose if you want to answers I can give you right now, or if you want to wait until we can give you the conistent version, that is up to you.&#xA;&#xA;&#x9;Smarter indexes - under the hood, RavenDB uses lucene for indexes. Even without counting things like full text or spatial searches, we get a lot more than what you get from the type of indexes you are used to in other systems.&#xA;&#xA;&#x9;For example, from the MongoDB docs (http://docs.mongodb.org/manual/core/index-compound/):&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;db.events.find().sort( { username: -1, date: 1 } )&#xA;&#xA;&#x9;&#x9;&#xA;&#x9;&#xA;&#x9;&#xA;&#x9;&#x9;The following index can support both these sort operations:&#xA;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;db.events.ensureIndex( { &quot;username&quot; : 1, &quot;date&quot; : -1 } )&#xA;&#xA;&#x9;&#x9;&#xA;&#x9;&#xA;&#x9;&#xA;&#x9;&#x9;However, the above index cannot support sorting by ascending&#xA0;username&#xA0;values and then by ascending&#xA0;date&#xA0;values, such as the following:&#xA;&#x9;&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;db.events.find().sort( { username: 1, date: 1 } )&#xA;&#x9;&#x9;&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;In constrant, in RavenDB, it is sufficent that you just tell us what you want to index, and you don&#x27;t need to worry about creating two indexes (and paying twice the price) if you want to allow users to sort the grid in multiple directions.&#xA;&#xA;&#x9;On the fly optimiaztions&#xA0;- the decision to separate the document store and the index store to separate components has paid off in ways that we didn&#x27;t realy predict. Because we have the sepration, and because indexes are background processes that don&#x27;t really impact the behavior of the rest of the system (outside of resources consumed), we have the freedom to do some interesting things. One of them is live index rebuild.&#xA;&#xA;&#x9;That means that you can create an index in RavenDB, and the system would go ahead and create it. At the same time, all other operations will go on normally. It can be writes to the document store, it can be updates to the other indexes. Anything at all.&#xA;&#xA;&#x9;Just to give you some idea about this feature, you&#x27;ll note that this feature exists only in the Enterprise edition for SQL Server, for example.&#xA0;&#xA;&#xA;&#x9;And the implications of that are that we&#xA0;can&#xA0;actually create an index in production. In fact, we do so routinely, that is the basis of our ad hoc querying ability. We analyze the query, the query optimizer decides where to dispatch it, and will&#xA0;create the new index if that is needed. There is a whole host of behavior just in this one feature (optimizations, heuroistics, scale back, etc) that we can do, but for the most part, you don&#x27;t care. You make queries to the server. RavenDB analyze them and product the most efficent indexes to match you&#xA0;actual production load&#xA;&#xA;&#x9;.Anyway, I am starting to go on about RavenDB, and that is rarely short. So I&#x27;ll summarize. RavenDB is composed of two distinct parts, the ACID document store, which allow absolute immediate consistency for both reads &amp; writes. And it also have the index store, which is eventually consistent, updated in the background and are always available for queries. They&#x27;ll also do zero waits (unless you explicitly desire this) for you and give you a much better and more consistent performance.&#xA;&#xA;&#x9;Oh, and a final number to conclude. The average time between a document update in the document store and the results showing up in the index store? That is 23ms*.&#xA;&#xA;&#x9;(And I blame 15.6ms of that on the clock resolution).</p>
        </article>
        <article id="article-3922">
            <a href="https://ardalis.com/final-verdict-on-haswell-ultrabook/" target="_blank">
                <h2 class="title mb-6" id="article-3922">Final Verdict on Haswell Ultrabook</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 21, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;ve had a pre-release Intel Ultrabook with the new Haswell processor in it for about two months now, so it&#x2019;s time for one last review of&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-3923">
            <a href="https://ayende.com/blog/164065/ravendb-3-0-feature-server-to-server-smuggling" target="_blank">
                <h2 class="title mb-6" id="article-3923">RavenDB 3.0 Feature: Server to Server Smuggling</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 21, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There are 6 major features for RavenDB 3.0 that we want to keep as surprises. One of them you&#x27;ve already learned about, the HTML5 studio. And we&#x27;ll reveal the others as they become viable to show.&#xA;&#xA;&#x9;But leaving those major features aside, there is a lot of stuff that we are doing that would deserve a bullet point all on its own. And today I want to talk about one of those features, S2S Smuggling.&#xA;&#xA;&#x9;Basically, assume that you have a server at location P (for Production) and you want to get the state of this server to your database at location D (for development). Right now, you have to export the P database, copy the file to your own machine and import it. That isn&#x27;t a major hassle, but it&#xA0;is&#xA0;a hassle.&#xA;&#xA;&#x9;Instead, in RavenDB 3.0, you can go to a server, point it to another server and just see the data streaming by. We even suppose doing this multiple times, and only the changes will be moved between the servers.&#xA;&#xA;&#x9;Yes, you can do that right now with the replication bundle. But not all databases are replicated, and it is simpler and easier to just move the documents as if there is nothing there.&#xA0;&#xA;&#xA;&#x9;The general idea is to be more&#xA0;convenient, but it is also likely to be much faster than the current method of: server &gt; file, copy file, file &gt; server. If only because we can do two way streaming, and plug the outgoing data directly into a bulk insert pipe.</p>
        </article>
        <article id="article-3924">
            <a href="https://ayende.com/blog/164033/hunting-the-performance-bottleneck" target="_blank">
                <h2 class="title mb-6" id="article-3924">Hunting the performance bottleneck</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 18, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We got a support request from a customer, and this time it was quite a doozie. The were using the FreeDB dataset as a test bed for a lot of experiments, and they found very slow indexing speed with it.&#xA0; In fact, what they found was utterly unacceptable indexing speed, to be frank. It took days to complete. However, that run contrary to all of the optimizations that we have done in the past few years. So something there was quite fishy. Luckily, it was fairly simple to reproduce. And the culprit was very easily identified. It was the SQL Replication Bundle. But why? That turned out to be a pretty complex answer.&#xA0;  The FreeDB dataset currently contains over 3.1 million records, and the sample the customer send us had about 8 indexes, varying in complexity from the trivial to full text analyzed and map reduce indexes. We expect such work load plus the replication to SQL to take a while. But it should be pretty fast process.  What turned out to be the problem was the way the SQL Replication bundle work. Since we don&#x2019;t know what changes you are going to replicate to SQL, the first thing we do is to delete all the data that might have previously been replicated. In practice, it means that we execute something like: DELETE FROM Disks WHERE DocumentId in (@p1, @p2, @p3)&#xA;&#xA;INSERT INTO Disks (...) VALUES( ... )&#xA;INSERT INTO Disks (...) VALUES( ... )&#xA;INSERT INTO Disks (...) VALUES( ... )&#xA;&#xA;&#xA;And over time, this became slower &amp; slower. Now, SQL Replication need access to a lot of documents (potentially all of them), so we use the same prefetcher technique that we use for indexing. And we also use the same optimizations to decide how much to load.&#xA;However, in this case, we had the SQL Replication being slow, and because we use the same optimization, to the optimizer it looked like we were having a very slow index. That calls for reducing the load on the server so we can have greater responsiveness and to reduce overall resource utilization. And that impacted the indexes. In effect, SQL Replication being slow forced us to feed the data into the indexes in small tidbits, and that drastically increased the I/O costs that we had to pay.&#xA;So the first thing to do was to actually break it apart, we now have different optimizers instances for indexes and SQL Replication (and RavenDB Replication, for that matter), and they cannot impact one another.&#xA;But the root cause was that SQL Replication was slow. And I think you should be able to figure out why from the information outline above.&#xA;As we replicated more and more data into SQL, we increased the table size. And as we increased the table size, statements like our DELETE would take more and more time. SQL was doing a lot of table scans.&#xA;To be honest, I never really thought about it. RavenDB in the same circumstances would just self optimize and thing would get faster fast. SQL Server (and any other relational database) would just be dog slow until you came and added the appropriate index.&#xA;Once that was done, our performance was back on track and we could run things speedily both for indexes and for SQL Replication.</p>
        </article>
        <article id="article-3925">
            <a href="https://ayende.com/blog/164001/the-curse-of-resource-utilization" target="_blank">
                <h2 class="title mb-6" id="article-3925">The curse of resource utilization</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 17, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got a request from a customer to look at the resource utilization of RavenDB under load. In particular, the customer loaded the entire FreeDB data set into RavenDB, then setup SQL Replication and a set of pretty expensive indexes (map reduce, full text searches, etc). This was a great scenario to look at, and we did find interesting things that we can improve on. But during the testing, we had the following recording taken. in fact, all of them were taken within a minute of each other:    The interesting thing about them is that they don&#x2019;t indicate a problem. They indicate a server that is making as much utilization of resources as is available to it to handle the work load that it has. While I am writing this, there is about 1GB of free RAM that we&#x2019;ve left for the rest of the system, but basically, if you have a big server, and you give it a lot of work to do, it is pretty much given that you&#x2019;ll want to get your money&#x2019;s worth from all of that hardware. The problem in the customer&#x2019;s case was that while it was very busy, it didn&#x2019;t get things done properly, but that is a side note. What I want to talk about is the assumption that the server is using a lot of resources, that is bad. In fact, that isn&#x2019;t true, assuming that it is using them properly. For example, if you have a 32GB RAM, there is little point in trying to conserve memory utilization. And there is all the reason in the world to try to prepare ahead of time answers to upcoming queries. So we might be using CPU even on idle moments. The key here is how you detect when you are over using the system resources. If you are under memory pressure, is is best to let go of that cache. And if you are busy handling requests, it is probably better to reduce the load of background tasks. We&#x2019;ve been doing this sort of auto tuning in RavenDB for a while. A lot of the changes between 1.0 and 2.0 were done around that area.</p>
        </article>
        <article id="article-3926">
            <a href="https://ayende.com/blog/163971/cache-it-aint-just-remembering-stuff" target="_blank">
                <h2 class="title mb-6" id="article-3926">Cache, it ain&#x2019;t just remembering stuff</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 16, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I mentioned that this piece of code have an issue:&#xA;&#xA;&#x9;public class LocalizationService&#xA;{&#xA;    MyEntities _ctx;&#xA;    Cache _cache;&#xA;&#xA;    public LocalizationService(MyEntities ctx, Cache cache)&#xA;    {&#xA;        _ctx = ctx;&#xA;        _cache = cache;&#xA;        Task.Run(() =&gt;&#xA;        {&#xA;            foreach(var item in _ctx.Resources)&#xA;            {&#xA;                _cache.Set(item.Key &#x2B; &quot;/&quot; &#x2B; item.LanguageId, item.Text);&#xA;            }&#xA;        });&#xA;    }    &#xA;&#xA;    public string Get(string key, string languageId)&#xA;    {&#xA;        var cacheKey = key &#x2B;&quot;/&quot; &#x2B; languageId;&#xA;        var item = _cache.Get(cacheKey);&#xA;        if(item != null)&#xA;            return item;&#xA;&#xA;        item = _ctx.Resources.Where(x=&gt;x.Key == key &amp;&amp; x.LanguageId == languageId).SingleOrDefault();&#xA;        _cache.Set(cacheKey, item);&#xA;        return item;&#xA;    }&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And I am pretty sure that the lot of you&#x2019;ll be able to find a lot of additional issues that I&#x2019;ve not thought about.&#xA;&#xA;&#x9;But there are at least three major issues in the code above. It doesn&#x2019;t do anything to solve the missing value problem, it doesn&#x2019;t have good handling for expiring values and have no way to handle changing values.&#xA;&#xA;&#x9;Look at the code above, assume that I am making continuous calls to Get(&#x201C;does not exists&#x201D;, &#x201C;nh-YI&#x201D;), or something like that. The way the code is currently written, it will always hit the database to get that value.&#xA;&#xA;&#x9;The second problem is that if we have had a cache cleanup run, which expired some values, we will actually load them one at a time, in pretty much the worst possible way from the point of view of performance.&#xA;&#xA;&#x9;Then we have the problem of how to actually handle updating values.&#xA;&#xA;&#x9;Let us see how we can at least approach this. We will replace the Cache with a ConcurrentDictionary. That will mean that the data cannot just go away from under us, and since we expect the number of resources to be relatively low, there is no issue in holding all of them in memory.&#xA;&#xA;&#x9;Because we know we hold all of them in memory, we can be sure that if the value isn&#x2019;t there, it isn&#x2019;t in the database either, so we can immediately return null, without checking with the database.&#xA;&#xA;&#x9;Last, we will add a StartRefreshingResources task, which will do the actual refreshing in an async manner. In other words:&#xA;&#xA;&#x9;public class LocalizationService&#xA;{&#xA;    MyEntities _ctx;&#xA;    ConcurrentDictionary&lt;Tuple&lt;string,string&gt;,string&gt; _cache = new ConcurrentDictionary&lt;Tuple&lt;string,string&gt;,string&gt;();&#xA;&#xA;    Task _refreshingResourcesTask;&#xA;&#xA;    public LocalizationService(MyEntities ctx)&#xA;    {&#xA;        _ctx = ctx;&#xA;        StartRefreshingResources();&#xA;    } &#xA;&#xA;    public void StartRefreshingResources()&#xA;    {&#xA;         _refreshingResourcesTask = Task.Run(() =&gt;&#xA;        {&#xA;            foreach(var item in _ctx.Resources)&#xA;            {&#xA;                _cache.Set(item.Key &#x2B; &quot;/&quot; &#x2B; item.LanguageId, item.Text);&#xA;            }&#xA;        });&#xA;    }&#xA;&#xA;    public string Get(string key, string languageId)&#xA;    {&#xA;        var cacheKey = Tuplce.Create(key,languageId);&#xA;        var item = _cache.Get(cacheKey);&#xA;        if(item != null || _refreshingResourcesTask.IsCompleted)&#xA;            return item;&#xA;&#xA;        item = _ctx.Resources.Where(x=&gt;x.Key == key &amp;&amp; x.LanguageId == languageId).SingleOrDefault();&#xA;        _cache.Set(cacheKey, item);&#xA;        return item;&#xA;    }&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;Note that there is a very subtle thing going on in here. as long as the async process is running, if we can&#x2019;t find the value in the cache, we will go to the database to find it. This gives us a good balance between stopping the system entirely for startup/refresh and having the values immediately available.</p>
        </article>
        <article id="article-3927">
            <a href="https://ayende.com/blog/163970/optimizing-the-space-time-matrix" target="_blank">
                <h2 class="title mb-6" id="article-3927">Optimizing the space &amp; time matrix</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 15, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The following method comes from the nopCommerce project. Take a moment to read it.&#xA;&#xA;&#x9;public virtual string GetResource(string resourceKey, int languageId,&#xA;    bool logIfNotFound = true, string defaultValue = &quot;&quot;, bool returnEmptyIfNotFound = false)&#xA;{&#xA;    string result = string.Empty;&#xA;    if (resourceKey == null)&#xA;        resourceKey = string.Empty;&#xA;    resourceKey = resourceKey.Trim().ToLowerInvariant();&#xA;    if (_localizationSettings.LoadAllLocaleRecordsOnStartup)&#xA;    {&#xA;        //load all records (we know they are cached)&#xA;        var resources = GetAllResourceValues(languageId);&#xA;        if (resources.ContainsKey(resourceKey))&#xA;        {&#xA;            result = resources[resourceKey].Value;&#xA;        }&#xA;    }&#xA;    else&#xA;    {&#xA;        //gradual loading&#xA;        string key = string.Format(LOCALSTRINGRESOURCES_BY_RESOURCENAME_KEY, languageId, resourceKey);&#xA;        string lsr = _cacheManager.Get(key, () =&gt;&#xA;        {&#xA;            var query = from l in _lsrRepository.Table&#xA;                        where l.ResourceName == resourceKey&#xA;                        &amp;&amp; l.LanguageId == languageId&#xA;                        select l.ResourceValue;&#xA;            return query.FirstOrDefault();&#xA;        });&#xA;&#xA;        if (lsr != null) &#xA;            result = lsr;&#xA;    }&#xA;    if (String.IsNullOrEmpty(result))&#xA;    {&#xA;        if (logIfNotFound)&#xA;            _logger.Warning(string.Format(&quot;Resource string ({0}) is not found. Language ID = {1}&quot;, resourceKey, languageId));&#xA;        &#xA;        if (!String.IsNullOrEmpty(defaultValue))&#xA;        {&#xA;            result = defaultValue;&#xA;        }&#xA;        else&#xA;        {&#xA;            if (!returnEmptyIfNotFound)&#xA;                result = resourceKey;&#xA;        }&#xA;    }&#xA;    return result;&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;I am guessing, but I am assuming that the intent here is to have a tradeoff between startup time and the system responsiveness. If you have LoadAllLocaleRecordsOnStartup set to true, it will load all the data from the database, and access it from there. Otherwise, it will load the data in a piece at a time.&#xA;&#xA;&#x9;That is nice, but it shows a single tradeoff, and that isn&#x2019;t a really good idea. Not only that, but look how it uses the cache. There are separate entries in the cache for the resources if they are loaded via the GetAllResourceValues() vs. individually. That leaves the cache with a lot less options when it needs to clear the cache. The cache deciding that it can remove a single item would result in a very expensive and long query taking place.&#xA;&#xA;&#x9;Instead, we can do it like this:&#xA;&#xA;&#x9;public class LocalizationService&#xA;{&#xA;    MyEntities _ctx;&#xA;    Cache _cache;&#xA;&#xA;    public LocalizationService(MyEntities ctx, Cache cache)&#xA;    {&#xA;        _ctx = ctx;&#xA;        _cache = cache;&#xA;        Task.Run(() =&gt;&#xA;        {&#xA;            foreach(var item in _ctx.Resources)&#xA;            {&#xA;                _cache.Set(item.Key &#x2B; &quot;/&quot; &#x2B; item.LanguageId, item.Text);&#xA;            }&#xA;        });&#xA;    }    &#xA;&#xA;    public string Get(string key, string languageId)&#xA;    {&#xA;        var cacheKey = key &#x2B;&quot;/&quot; &#x2B; languageId;&#xA;        var item = _cache.Get(cacheKey);&#xA;        if(item != null)&#xA;            return item;&#xA;&#xA;        item = _ctx.Resources.Where(x=&gt;x.Key == key &amp;&amp; x.LanguageId == languageId).SingleOrDefault();&#xA;        _cache.Set(cacheKey, item);&#xA;        return item;&#xA;    }&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;Of course, this has a separate issue, but I&#x2019;ll discuss that in my next post.</p>
        </article>
        <article id="article-3928">
            <a href="https://ayende.com/blog/163938/ravendb-free-db-small-steps-over-time" target="_blank">
                <h2 class="title mb-6" id="article-3928">RavenDB &amp; Free DB&#x2013;small steps over time</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 14, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Over a year ago I took the FreeDB data set and important to RavenDB, to see how it behaves with very large data sets. We got a customer request to handle a problem that was related to this data set, so I had to re-create the database. The numbers are interesting.    Before optimization, 2012 Two hours  After optimization, 2012 42 minutes  Current status 28 minutes Seeing this, I think that I am going to be re-running the entire perf suite again, just to see what the numbers looks like again.</p>
        </article>
        <article id="article-3929">
            <a href="https://ayende.com/blog/163937/the-customer-is-always-right" target="_blank">
                <h2 class="title mb-6" id="article-3929">The customer is always right</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 11, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Seriously?   &#xA0; Yes, dear [redacted] , the cost is 379$. You are absolutely right.</p>
        </article>
        <article id="article-3930">
            <a href="https://ardalis.com/devreach-2013-recap-and-slides/" target="_blank">
                <h2 class="title mb-6" id="article-3930">DevReach 2013 Recap and Slides</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 10, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Last week I had the opportunity to visit Sofia, Bulgaria for the DevReach 2013 conference at which I was once more a presenter. DevReach is&#x2026;Keep Reading &#x2192;</p>
        </article>
        <div class="button flex justify-between">
            <a href="392.html"><span class="back arrow"></span></a>

            <a href="394.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>