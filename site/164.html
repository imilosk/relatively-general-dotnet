
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 164 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-1631">
            <a href="https://ayende.com/blog/189188-A/extendible-hash-table-deletion-i" target="_blank">
                <h2 class="title mb-6" id="article-1631">Extendible hash table&#x2013;Deletion I</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 03, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Building data structures is fun, until you need to actually implement all the non core stuff. In the previous post, we covered iteration, but now we have to deal with the most annoying of features, deletions. In some data structures, implementing deletions can take significantly more time and effort than all other work combined. Let&#x2019;s see what it takes to handle deletions in the hash table as it stands. I started things out by just scanning for the right value and removing it verbatim. Here is what this looked like:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          bool hash_table_delete(hash_ctx_t* ctx, uint64_t key, hash_old_value_t* old_value) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;uint32_t bucket_idx = hash_table_bucket_number(ctx, key);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;hash_bucket_t* b = ctx-&gt;dir-&gt;buckets[bucket_idx];&#xA;        &#xA;        &#xA;          &#xA;          &#x9;uint32_t piece_idx = key % NUMBER_OF_HASH_BUCKET_PIECES;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;ctx-&gt;dir-&gt;version&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if (old_value)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;old_value-&gt;exists = false;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;for (size_t i = 0; i &lt; MAX_CHAIN_LENGTH; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;{&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;hash_bucket_piece_t* p = &amp;b-&gt;pieces[(piece_idx &#x2B; i) % NUMBER_OF_HASH_BUCKET_PIECES];&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;uint8_t* buf = p-&gt;data;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;uint8_t* end = p-&gt;data &#x2B; p-&gt;bytes_used;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;while (buf &lt; end)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;{&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;uint64_t k, v;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;uint8_t* cur_buf_start = buf;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;varint_decode(&amp;buf, &amp;k);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;varint_decode(&amp;buf, &amp;v);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;if (k == key) {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;if (old_value) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&#x9;old_value-&gt;exists = true;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&#x9;old_value-&gt;value = v;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;ptrdiff_t diff = buf - cur_buf_start;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;memmove(cur_buf_start, buf, end - buf);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;p-&gt;bytes_used -= (uint8_t)diff;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;b-&gt;number_of_entries--;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;ctx-&gt;dir-&gt;number_of_entries--;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;return true;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;// if we are looking at an overflow page, move to the next one and try to find it there&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (!p-&gt;overflowed)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;break;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;return false;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          del1.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This works. The value is removed, future modifications or queries can run and everything Just Works. Even overflow operations will just work, including if we deleted all the data from a piece, it will still be marked as overflow and queries / modifications will proceed to get the right value from the right place. In particular, we are missing handling for overflows and compaction. Overflows inside a page happens when we have can&#x2019;t fit a key value pair in its natural piece (a 64 bytes boundary inside the page), so we place it on a nearby piece. Compaction happens when we removed enough data that we can merge sibling pages and free a page from the system.Let&#x2019;s handle the overflow case first, because it is easier. One option we have for handling overflows is to check if there is any overflow for a page, and after freeing some memory, check the next pieces for keys that we can move to our piece. That is actually quite complex, because there are two types of such keys. The first type refers to keys that belong directly to the piece we removed from, but the second type of keys that we have in play here are keys that overflow past this piece.In other words, let&#x2019;s say that we deleted a value from piece #17. We need to check pieces 18 &#x2013; 33 for keys that belong on piece #17. That is the first type. The second type is to check the next pieces for keys whose native location is earlier than piece #17. The idea is that we&#x2019;ll place that data nearer its ideal location. The problem here is that we now have to do a lot of work on deletion, and that isn&#x2019;t something that I&#x2019;m a fan of. One of the common use cases for deletes is massive deletes, so we&#x2019;ll spend time re-arranging the keys, only to have them deleted immediately afterward. Instead, I think that I&#x2019;ll take advantage on the organization of pieces in the hash table. Instead of handling overflows whenever a delete is issued, we&#x2019;ll handle them only when a piece is emptied. That also means that we can be sure that we&#x2019;ll have space for the keys we want to move.Here is what I came up with at 2:30 AM:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          if (p-&gt;bytes_used == 0) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;size_t max_overflow = 0;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;for (size_t j = 0; j &lt; MAX_CHAIN_LENGTH; j&#x2B;&#x2B;) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (b-&gt;pieces[(piece_idx &#x2B; i &#x2B; j) % NUMBER_OF_HASH_BUCKET_PIECES].overflowed)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;max_overflow&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;// we scan keys as far as possible first, to move them closer to their ideal location&#xA;        &#xA;        &#xA;          &#xA;          &#x9;for (size_t j = max_overflow - 1; j &gt;= 0; j--)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;{&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;hash_bucket_piece_t* cur = &amp;b-&gt;pieces[(piece_idx &#x2B; i &#x2B; j) % NUMBER_OF_HASH_BUCKET_PIECES];&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;buf = cur-&gt;data;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;end = buf &#x2B; cur-&gt;bytes_used;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;while (buf &lt; end) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;cur_buf_start = buf;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;varint_decode(&amp;buf, &amp;k);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;varint_decode(&amp;buf, &amp;v);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;if (k % NUMBER_OF_HASH_BUCKET_PIECES == piece_idx) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;diff = buf - cur_buf_start;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;if (diff &#x2B; p-&gt;bytes_used &lt;= PIECE_BUCKET_BUFFER_SIZE) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&#x9;memmove(p-&gt;data &#x2B; p-&gt;bytes_used, cur_buf_start, diff);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&#x9;memmove(cur_buf_start, buf, end - buf);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&#x9;cur-&gt;bytes_used -= (uint8_t)diff;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&#x9;p-&gt;bytes_used &#x2B;= (uint8_t)diff;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;&#x9;end -= diff;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          shift.overflow.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;I&#x2019;m not happy about this, though. It does the job, but you&#x2019;ll note one thing it does not do. It doesn&#x2019;t clear the overflow flag. This is because overflow is a transitive property. That is, I may have moved all the keys that belong to a piece to that piece, and no other piece have keys that belong to it. But keys that belong to previous pieces may be located on pieces after it. If we want to clear the overflow flag, we need to be ready to do a whole lot more.But that is something that I&#x2019;ll do at a more reasonable hour.</p>
        </article>
        <article id="article-1632">
            <a href="https://andrewlock.net/converting-integration-tests-to-net-core-3/" target="_blank">
                <h2 class="title mb-6" id="article-1632">Converting integration tests to .NET Core 3.0</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 03, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Upgrading to ASP.NET Core 3.0 - Part 5</p>
        </article>
        <article id="article-1633">
            <a href="https://ayende.com/blog/189187-A/extendible-hash-table-iteration" target="_blank">
                <h2 class="title mb-6" id="article-1633">Extendible hash table&#x2013;iteration</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 02, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I run perf tests and memory utilization tests on my implementation and finally got it to the right place. But the API I have is pretty poor. I can put a key and value, or get the value by key. But we probably want a few more features.I changed the put implementation to be:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          typedef struct hash_old_value {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;uint64_t value;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;bool exists;&#xA;        &#xA;        &#xA;          &#xA;          } hash_old_value_t;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          bool hash_table_replace(hash_ctx_t* ctx, uint64_t key, uint64_t value, hash_old_value_t* old_value);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          bool hash_table_put(hash_ctx_t* ctx, uint64_t key, uint64_t value) =&gt; hash_table_replace(ctx, key, value, NULL);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          replace.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This allows me to do an atomic replace and get the old value from the table. That is a nice low hanging fruit. But the key feature that I want to talk about today is iteration, as you might have figured out from the post title .I&#x2019;m writing this code in C, because I find it interesting to practice in different environments, and C doesn&#x2019;t really have an iteration API. So here is what I came up with:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          typedef struct hash_iteration_state {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;hash_directory_t* dir;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;uint32_t current_bucket_idx;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;uint8_t current_piece_idx;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;uint8_t current_piece_byte_pos;&#xA;        &#xA;        &#xA;          &#xA;          } hash_iteration_state_t;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          void hash_table_iterate_init(hash_ctx_t* ctx, hash_iteration_state_t* state);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          bool hash_table_iterate_next(hash_iteration_state_t* state, uint64_t* key, uint64_t* value);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          iteration.api.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;If this was a public API I was building, I would probably want to hide the implementation details of the hash_iteration_state. Right now, I get a allocation and failure free API, because the caller is responsible for supplying the space for the state. Here is how we can iterate using this API:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          uint64_t k, v;&#xA;        &#xA;        &#xA;          &#xA;          hash_iteration_state_t state;&#xA;        &#xA;        &#xA;          &#xA;          hash_table_iterate_init(&amp;ctx, &amp;state);&#xA;        &#xA;        &#xA;          &#xA;          while (hash_table_iterate_next(&amp;state, &amp;k, &amp;v)) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;printf(&quot;%llu = %llu\n&quot;, k, v);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          iterating.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Not too bad, right? And this is basically what you&#x2019;ll get when you use yield and such in languages that support native iterations. In C, you need to manage this yourself, but I don&#x2019;t think that I got too lost here.&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          void hash_table_iterate_init(hash_ctx_t* ctx, hash_iteration_state_t* state) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;memset(state, 0, sizeof(hash_iteration_state_t));&#xA;        &#xA;        &#xA;          &#xA;          &#x9;state-&gt;dir = ctx-&gt;dir;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          bool hash_table_iterate_next(hash_iteration_state_t* state, uint64_t* key, uint64_t* value) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;while (true) {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (state-&gt;current_bucket_idx &gt;= state-&gt;dir-&gt;number_of_buckets)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;return false;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (state-&gt;current_piece_idx &gt;= NUMBER_OF_HASH_BUCKET_PIECES) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;state-&gt;current_piece_idx = 0;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;state-&gt;current_bucket_idx&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;continue;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;hash_bucket_t* b = state-&gt;dir-&gt;buckets[state-&gt;current_bucket_idx];&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;hash_bucket_piece_t* p = &amp;b-&gt;pieces[state-&gt;current_piece_idx];&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;if (state-&gt;current_piece_byte_pos &gt;= p-&gt;bytes_used) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;state-&gt;current_piece_byte_pos = 0;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;state-&gt;current_piece_idx&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;&#x9;continue;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;uint8_t* buf = p-&gt;data &#x2B; state-&gt;current_piece_byte_pos;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;varint_decode(&amp;buf, key);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;varint_decode(&amp;buf, value);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;state-&gt;current_piece_byte_pos = (uint8_t)(buf - p-&gt;data);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;return true;&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          hash_table_iterate.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;We store the current state in the state variable, and simply traverse the data in the buckets / pieces as they come.Looking at this code, what is missing? Error handling&#x2026;But wait, I can hear you say, how can there be errors here? There are no moving pieces that can break, surely.Well, the caller of our API may provide some moving pieces for us. For example, consider this code:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          uint64_t k, v;&#xA;        &#xA;        &#xA;          &#xA;          hash_iteration_state_t state;&#xA;        &#xA;        &#xA;          &#xA;          hash_table_iterate_init(&amp;ctx, &amp;state);&#xA;        &#xA;        &#xA;          &#xA;          while (hash_table_iterate_next(&amp;state, &amp;k, &amp;v)) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;hash_table_put(&amp;ctx, k, v &#x2B; 1);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;printf(&quot;%llu = %llu\n&quot;, k, v);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          it.and.modify.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;In other words, if we iterate and modify the data, what is going to happen? Well, we may change the position of values, which will lead us to skipping some values, iterating over some values twice, etc. What is worse, this may violate invariants in the code. In particular, the invariant in question is that current_piece_byte_pos always points to the start of a new key. If the data moved because of the put, this doesn&#x2019;t hold true any longer.I added protection to that by adding a version field to the directory, which is incremented whenever we call a put / replace on the directory. Then we can check if the value has changed. The issue is how do we report this in? Right now, I wrote:I guess I could have done better by changing the return value to an int and returning better error code directly. This is a perfect case for exception, I think, since this is an edge case that should never be hit in real code. The fact that modifying the hash table will invalidate the iterator and cause it to stop working, on the other hand, might not be immediately obvious to the caller. More likely than not, though, anyone trying to write mutating code such as the one above will quickly figure out that this isn&#x2019;t working and check exactly why.Because of that, I decided to keep the bool return value, to simplify the life of our callers.The full code is here.</p>
        </article>
        <article id="article-1634">
            <a href="https://ayende.com/blog/189186-A/chen-ravid-and-oren-eini-value-open-source-videocast" target="_blank">
                <h2 class="title mb-6" id="article-1634">Chen Ravid and Oren Eini - Value Open Source Videocast</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 29, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I did a video cast when Chen a few weeks ago. I think it went quite well.Oren shares his story on how he taught himself how to code in &quot;Prison&quot; and became an open-source developer, coding a prison management system and how he founded Hibernating Rhinos. If you are an open-source developer or entrepreneur, you&#x27;ll find in this videocast some great ideas by Oren - about how to plan ahead and fail properly, promoting an open-source project, and giving advice to people who are beginning their journey in the open-source world. You can watch it here:&#xA;&#xA;Let me know what you think.</p>
        </article>
        <article id="article-1635">
            <a href="https://ayende.com/blog/189185-A/building-extendible-hash-leaf-page-part-iii-optimization-phase" target="_blank">
                <h2 class="title mb-6" id="article-1635">Building extendible hash leaf page&#x2013;Part III, optimization phase</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 28, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post, I wrote about how I changed the structure of the hash leaf page to increase data density. I managed to get it down to 32MB range when I&#x2019;m using random keys. That is a pretty great number, for memory usage, but what is the cost in terms of performance?Well, let&#x2019;s figure it out, shall we? I added some tracing code and got the first result:3.124000 us/op with &#xA;32.007813 MBThat is not to shabby, right? Let&#x2019;s see where we are spending most of our time, shall we? I opened the profiler and got:Okay, that is a good point, isn&#x2019;t it? Changing to release mode gives us:1.471000 us/op with 32.007813 MBthat is much nicer, but still, profiler please&#x2026;As a side note, it actually takes less time to run the profiler than for it to analyze its output. I was looking at this for a while.The result was&#x2026; stunning:What is this thing? And why did it take almost 50% of my runtime?As it turns out, I was compiling for x86, and I&#x2019;m using a lot of shifts on 64 bits numbers. This _allshl seems to be part of the x86 runtime. That means that what I expected to be a cheap instruction on a register was actually a method call. That is interesting, but easy to fix. When running in Release/x64, we get the following results:0.723 us/op with &#xA;32.007813 MBOkay, so we are under a microsecond per op, and very reasonable memory, good to go, right?Well, remember that I did absolutely zero optimizations so far? What does the profiler tell us now? Here is an interesting hotspot:That is reasonable, we are benching this method, after all. But inside that method, we see:This is the part where we scan an existing piece to see if the value is inside it or not. This tell us if we need to add a new value or update an existing one. It make sense this will be hot, we have to do it on each put to the data related to the piece where we want to put the new key.There are a few ways to deal with this, we can try to move from the simple varint mode to a more complex (and performant) system. StreamVByte would probably be a good solution, in term of raw performance. But it is meant for 32 bits numbers and doesn&#x2019;t play nice with being able to remove and add values from the stream easily. I could also try to play games, instead of calling this function twice, call it once and pass both k and v. However, that is almost assuredly a false play. The varint method is small enough that it doesn&#x2019;t really matter, the compiler can inline it and play its own optimizations. Also, I tried it and there was no noticeable performance change, so that&#x2019;s down.Another way to deal with it is to reduce the number of times we call this function. And here is where things get interesting. Why is this called so much? Because during the put process, we find a page to put a value, then in that page, we find a piece (a 64 byte range) that we will put the key and value in. When we get to the piece, we need to check the already existing data if the key is there or not. So far, so good, but there is another factor to consider, overflows. A piece may overflow and spill into consecutive pieces. After all, that is what allowed us to reduce the memory usage from 147MB to just 32MB in the random integers scenario. However, that also means that we may need to scan much larger piece of the page. That explains why we are seeing so much usage of the decoding function. Let&#x2019;s look at the previous behavior, where we have no overflow at all?0.551000 us/op with 147.320313 MBThat is a much cheaper cost, but much higher memory. It looks like the typical compute vs. memory cycle, but let&#x2019;s look at the actual costs?You&#x2019;ll notice that we spend most of our time on increasing the hash table size, allocating and moving memory, etc. So even though we are faster, that isn&#x2019;t a good option for us.One thing to note, we are looking for the same key, and decoding all the data to find it. But we don&#x2019;t actually need to do that, we already have the key, and encoded it to its varint form. We can do a search on the raw encoded data to find it. It won&#x2019;t be good enough for the positive case (we may have a value that was encoded to the same form), but it should help for the common case of inserting a new value. If we find something with memmem(), we still need to decode the data itself and see if the pattern we found is a key or a value, but that should help. I tested it using GCC&#x2019;s implementation, and the performance dropped by almost 50%, it took 1.3 us/op! Maybe if I was using a SIMD optimized implementation, that would help, but given the kind of data we are looking for, it didn&#x2019;t pan out.Another option is to reduce the number of times we&#x2019;ll try to overflow a value. Right now, if we can&#x2019;t put a value in its proper place, we&#x2019;ll try putting it in any of the other locations. That means that we may probe as many as 127 pieces. It also means that during put, we have to scan overflow chains. As we saw in the previous post, that can add up to scanning up to 1.8 KB of data for a single put. What happens if we limit the overflow amount?Let&#x2019;s see if we limit the overflow to 32 probes. Now it only takes 0.403 us/op, which is a huge improvement. But what about the memory size? It&#x2019;s easier to look things up as a table:&#xA;&#xA;&#xA;Max chain&#xA;Overall Time (sec)&#xA;us/op&#xA;Size (MB)&#xA;&#xA;&#xA;10.5450000.545000147.320313&#xA;20.3590000.35900075.156250&#xA;40.3720000.37200055.523438&#xA;80.3220000.32200036.882813&#xA;160.3360000.33600032.226563&#xA;320.4480000.44800032.007813&#xA;640.5960000.59600032.007813&#xA;1280.7700000.77000032.007813&#xA;&#xA;&#xA;&#xA;These numbers are interesting, but let&#x2019;s look at them as a graph, shall we?We can see that the size drops sharply as the performance is best between 8 and 16 probe attempts, and all we are left choosing is the memory cost.If we go with 8 probe attempts, we&#x2019;ll pay with additional 4.875 MB, but with 16 probe attempts, we&#x2019;ll use just 224KB more with a cost of 0.044 us/op more than the optimal value.We could go to 32, of course, which gives us optimal size, with about 60% of the cost of doing the full scan. However, by paying just 224KB more, we get down to 43% of the initial cost. And that certainly seems like it is worth it.You can find the full source code (a little bit cleaned up) here.</p>
        </article>
        <article id="article-1636">
            <a href="https://ayende.com/blog/189153-A/building-extendible-hash-leaf-page-part-ii" target="_blank">
                <h2 class="title mb-6" id="article-1636">Building extendible hash leaf page&#x2013;Part II</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 27, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I wrote before about an idea for designing the leaf page of an extendible hash page. The idea was to arrange things on a cache line size, which would reduce how much we&#x2019;ll need to search inside the page. On the other hand, it means that we might need to split whenever a particular 64 bits range is full. I went ahead an implemented that, just to see how it would work in practice. You can read the code here. Please note, this is testing code, so the point is to see how things work, not so much to do things properly. One really useful piece you&#x2019;ll find there is that I&#x2019;m outputting the structure of the hash to a graph. Being able to visually inspect the state of the system at various points has been invaluable to me.I have tested the implementation with two types on inputs. First, we have sequential keys and values. That is what I expect will be the most common use case that I have for this. It worked, but storing one million items results in just over 8 MB of memory being used. Given that my key &amp; value are 8 bytes each, that isn&#x2019;t too bad. In fact, that is pretty great. If we were storing this as an array, we would need about 15.2MB, so there are spacing savings there as well.Looking at the internal structure of the hash table, we see that all 64 bytes pieces hold some values (all between 42 &#x2013; 48 bytes). That is pretty great all around, open the champagne.I decided to see what kind of behavior we&#x2019;ll see when we have a random distribution. The situation was&#x2026; worse. In fact, storing one million random keys and values takes 147MB. Yes, that is for when you can store the whole data in just 15.2 MB in its raw form.To be fair, one of the advantages that we have for sequential values is that we use varints to store the values, so they compress well. With random values, we don&#x2019;t really benefit from that. I tested this again with different ranges of values. With random values up to 2^32, we get a hash table that over 44MB in size and when we limit the range to ten millions, we use &#x201C;merely&#x201D; 27MB. The issue is fairly simple, the moment we have a 64 bytes range full, we are forced to do a page split. That lead us to high fragmentation, which is not desirable at all. With random distribution, it is likely that we&#x2019;ll hit the 64 bytes capacity easily on each page, leading to very high fragmentation. Amusingly enough, the sequential mode will not have this, because this will spread the values neatly along the different pieces in a page. The answer to that is to move to an open addressing mode inside the page. In other words, when we have a 64 bytes piece that is full, we&#x2019;ll mark it as having overflowed and put the value on the subsequent piece. That would allow us to spill over the values across the entire page much more efficiently. It does complicates deletions, but we&#x2019;ll manage.Implementing that feature took a little bit, but here is the result. For the case of random keys and values, we go to a total memory usage of 32 MB, a very significant improvement. There has been no change for the sequential mode, which was already optimal for our scenario.When values are in the 2^32 range, we use 16 MB and for ten million range, we get 8MB. These numbers are pretty awesome, even if I say so myself.For comparison, I wrote this C# program, which merely store 1 million 16 bytes key pairs. That is basically what I&#x2019;m doing in my code, and it was interesting to compare the memory consumption between the two. The C# version took 37.2 MB, compared to the bad result I had of 32MB in my code.Looking at the actual overflow count, on the random data case, it look like we have the following stats:Max overflow chain (overflow pieces that are next to one another): 29Total number of chains: 107,830Average chain length: 2.35In other words, we have a 10% chance in this case of hitting an overflow chain (meaning that we need to check more than 64 bytes of data to see if the key exists). When this happens, we&#x2019;ll usually scan 128 &#x2013; 192 bytes, but may scan up to 1.8 KB of sequential memory. There are a total of 1,388 cases where we have more than 10 consecutive overflow pieces (1% chance of hitting that) and only 64 cases where the chain is greater than 20.Overall, these numbers looks good to me. As usual, comments are welcome. I would appreciate any feedback you may have.</p>
        </article>
        <article id="article-1637">
            <a href="https://ardalis.com/domain-driven-design-with-asp-net-core-workshop/" target="_blank">
                <h2 class="title mb-6" id="article-1637">Domain-Driven Design with ASP.NET Core Workshop</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 27, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I first learned about Domain-Driven Design, or DDD, over ten years ago. Since then, I&#x27;ve given more workshops on the topic, both public and&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-1638">
            <a href="https://andrewlock.net/converting-a-terminal-middleware-to-endpoint-routing-in-aspnetcore-3/" target="_blank">
                <h2 class="title mb-6" id="article-1638">Converting a terminal middleware to endpoint routing in ASP.NET Core 3.0</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 26, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Upgrading to ASP.NET Core 3.0 - Part 4</p>
        </article>
        <article id="article-1639">
            <a href="https://enterprisecraftsmanship.com/posts/is-entity-same-as-value-object/" target="_blank">
                <h2 class="title mb-6" id="article-1639">Is Entity the same as Value Object?</h2>
            </a>
            <p class="mb-2">by Vladimir Khorikov</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 25, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post, we&#x2019;ll discuss an interesting question about whether the concepts of Entity and Value Object are the same.</p>
        </article>
        <article id="article-1640">
            <a href="https://ardalis.com/moving-from-controllers-and-actions-to-endpoints-with-mediatr/" target="_blank">
                <h2 class="title mb-6" id="article-1640">Moving from Controllers and Actions to Endpoints with MediatR</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 20, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Last updated: 13 October 2023 (or Controllers are dinosaurs - it&#x27;s time to embrace Endpoints) Update Feb 2020: I&#x27;ve started a GitHub repo&#x2026;Keep Reading &#x2192;</p>
        </article>
        <div class="button flex justify-between">
            <a href="163.html"><span class="back arrow"></span></a>

            <a href="165.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>