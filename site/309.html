
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 309 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-3081">
            <a href="https://ayende.com/blog/176098/making-code-faster-that-pesky-dictionary" target="_blank">
                <h2 class="title mb-6" id="article-3081">Making code faster</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 22, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">It is a fact of life, if you are looking at a high performance code, a dictionary is probably going to be one of those things that will be painful. Let us see how this look like in our current program:   Are you kidding me?! Here I am worrying about every little bit and byte to try to get the most performance out of the system, and Dictionary is eating almost 50% of my performance? Let us look more deeply into this:  So that is about 3 &#x3BC;s, which is pretty fast. But it isn&#x2019;t fast enough. Now, know that there are about 200,000 unique values in the dictionary (look at the Insert calls in the profiler output), and we have some knowledge about the problem space. The id that we use has 8 characters, so at most, we can have a hundred million ids. An array of that size would be roughly 762 MB in size, so that is doable. But we also can be fairly certain that the ids are generated in some sequential manner, so there is a strong likelihood that we don&#x2019;t need all of this space.  So I wrote the following function: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;           private static void Increment(ref long[] array, int id, long value)&#xA;        &#xA;        &#xA;          &#xA;           {&#xA;        &#xA;        &#xA;          &#xA;               if (id &lt; array.Length)&#xA;        &#xA;        &#xA;          &#xA;               {&#xA;        &#xA;        &#xA;          &#xA;                   array[id] &#x2B;= value;&#xA;        &#xA;        &#xA;          &#xA;                   return;&#xA;        &#xA;        &#xA;          &#xA;               }&#xA;        &#xA;        &#xA;          &#xA;               UnlikelyGrowArray(ref array, id, value);&#xA;        &#xA;        &#xA;          &#xA;           }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;           private static void UnlikelyGrowArray(ref long[] array, int id, long value)&#xA;        &#xA;        &#xA;          &#xA;           {&#xA;        &#xA;        &#xA;          &#xA;               var size = array.Length*2;&#xA;        &#xA;        &#xA;          &#xA;               while (id &gt;= size)&#xA;        &#xA;        &#xA;          &#xA;                   size *= 2;&#xA;        &#xA;        &#xA;          &#xA;               Array.Resize(ref array, size);&#xA;        &#xA;        &#xA;          &#xA;               Increment(ref array, id, value);&#xA;        &#xA;        &#xA;          &#xA;           }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          increment-array-value.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; Changed the stats to start with an array of 256 longs, and run it, the results are nice.  587 ms and allocated 2,576 kb with peak working set of 296,484 kb And our costs look like:  This is single threaded, of course, and it is faster than all the previous multi threaded versions we had before.</p>
        </article>
        <article id="article-3082">
            <a href="https://andrewlock.net/exploring-middleware-as-mvc-filters-in-asp-net-core-1-1/" target="_blank">
                <h2 class="title mb-6" id="article-3082">Exploring Middleware as MVC Filters in ASP.NET Core 1.1</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 22, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Adding a URL culture provider using middleware as filters - Part 1</p>
        </article>
        <article id="article-3083">
            <a href="https://ayende.com/blog/176097/making-code-faster-streamlining-the-output" target="_blank">
                <h2 class="title mb-6" id="article-3083">Making code faster</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 21, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After looking at the profiler results, I realized that we are actually spending a considerable amount of time just writing the output to a file. That didn&#x2019;t really matter when our code run in 30&#x2B; seconds, spending another 100 &#x2013; 200 ms to write the results was just noise, but when our code is doing that in under a second, that a considerable cost.&#xA;I&#x2019;m running this code on a different machine, so we can&#x2019;t directly compare. The performance of the initial version is:&#xA;&#xA;38,478 ms and allocated 7,612,741 kb with peak working set of 874,660 kb&#xA;&#xA;And the speed of the latest version is:&#xA;&#xA;842 ms and allocated 208,435 kb with peak working set of 375,452 kb&#xA;&#xA;So we are 45 times faster than the initial version.&#xA;The problem is that doing this in parallel takes quite a lot and mask some inefficiencies, so I decided to change it back to using a single threaded approach. Which gives:&#xA;&#xA;1,498 ms and allocated 123,787 kb with peak working set of 319,436 kb&#xA;&#xA;Merely 25 times faster than the original version.&#xA;And now let us focus on the output.&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private static void WriteOutput(Dictionary&lt;int, FastRecord&gt; stats)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              using (var output = File.CreateText(&quot;summary.txt&quot;))&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  foreach (var entry in stats)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      output.WriteLine($&quot;{entry.Value.Id:D10} {TimeSpan.FromTicks(entry.Value.DurationInTicks):c}&quot;);&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          output-summary.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;This is pretty simple code, but it hides a lot of inefficiencies, in particular, it is doing a lot of allocations as it format the string. We can do much better.&#xA;Merely changing the WriteLine to:&#xA;&#xA;output.WriteLine($&quot;{entry.Value.Id} {entry.Value.DurationInTicks}&quot;);&#xA;&#xA;Saved us close to 200 ms (!), so there is a lot of space to improve here. Again, this is mostly an issue of creating highly specific code to solve this exact scenario. Here is what I did:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private static void WriteOutput(Dictionary&lt;int, FastRecord&gt; stats)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              byte[] tempBuffer = new byte[21];&#xA;        &#xA;        &#xA;          &#xA;              tempBuffer[10] = (byte)&#x27; &#x27;;&#xA;        &#xA;        &#xA;          &#xA;              tempBuffer[13] = (byte)&#x27;:&#x27;;&#xA;        &#xA;        &#xA;          &#xA;              tempBuffer[16] = (byte)&#x27;:&#x27;;&#xA;        &#xA;        &#xA;          &#xA;              tempBuffer[19] = (byte)&#x27;\r&#x27;;&#xA;        &#xA;        &#xA;          &#xA;              tempBuffer[20] = (byte)&#x27;\n&#x27;;&#xA;        &#xA;        &#xA;          &#xA;              using (var output = File.Create(&quot;summary.txt&quot;))&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  foreach (var entry in stats)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      WriteFormattedInt(entry.Value.Id, tempBuffer, 0, 10);&#xA;        &#xA;        &#xA;          &#xA;                      var ts = TimeSpan.FromTicks(entry.Value.DurationInTicks);&#xA;        &#xA;        &#xA;          &#xA;                      WriteFormattedInt(ts.Hours, tempBuffer, 11, 2);&#xA;        &#xA;        &#xA;          &#xA;                      WriteFormattedInt(ts.Minutes, tempBuffer, 14, 2);&#xA;        &#xA;        &#xA;          &#xA;                      WriteFormattedInt(ts.Seconds, tempBuffer, 17, 2);&#xA;        &#xA;        &#xA;          &#xA;                      output.Write(tempBuffer, 0, tempBuffer.Length);&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          private static void WriteFormattedInt(long id, byte[] temp, int pos, int numberOfDigits)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              int i = pos &#x2B; numberOfDigits - 1;&#xA;        &#xA;        &#xA;          &#xA;              do&#xA;        &#xA;        &#xA;          &#xA;              {   &#xA;        &#xA;        &#xA;          &#xA;                  temp[i--] = (byte)((id % 10) &#x2B; &#x27;0&#x27;);&#xA;        &#xA;        &#xA;          &#xA;              } while ((id /= 10) &gt; 0);&#xA;        &#xA;        &#xA;          &#xA;              while (i &gt;= pos)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  temp[i--] = (byte)&#x27;0&#x27;;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          private static void WriteFormattedInt(int id, byte[] temp, int pos, int numberOfDigits)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              int i = pos &#x2B; numberOfDigits-1;&#xA;        &#xA;        &#xA;          &#xA;              do&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  temp[i--] = (byte)((id % 10) &#x2B; &#x27;0&#x27;);&#xA;        &#xA;        &#xA;          &#xA;              } while ((id /= 10) &gt; 0);&#xA;        &#xA;        &#xA;          &#xA;              while (i &gt;= pos)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  temp[i--] = (byte)&#x27;0&#x27;;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          optimized-output-summary.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;I wrote a simple function to format the number into a buffer, then change the summary line to write a single line into a prepared buffer (and skip all the static stuff), and write the to the file file in one shot.&#xA;And the results are:&#xA;&#xA;1,191 ms and allocated 16,942 kb with peak working set of 311,432 kb&#xA;&#xA;You might have noticed that I have two copies of the WriteFormattedInt, this is to skip the implicit cast to long, and yes, it matters, by about 50 ms in my tests. But this version also reduces the number of allocations we have by over 100 MB! So this is great.&#xA;And here are the profiler results on analyzing this method:&#xA;&#xA;&#xA;&#xA;This function is now almost 7 times faster! That is pretty awesome, and even talking about single threaded performance, we are looking at 32 times better than the original version.&#xA;Trying the parallel version give me:&#xA;&#xA;731 ms and allocated 101,565 kb with peak working set of 381,224 kb&#xA;&#xA;And a total improvement of 52 times! But we can do even more&#x2026; I&#x2019;ll talk about it in the next post.</p>
        </article>
        <article id="article-3084">
            <a href="https://benfoster.io/blog/net-core-configuration-legacy-projects/" target="_blank">
                <h2 class="title mb-6" id="article-3084">Using .NET Core Configuration with legacy projects</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 20, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I demonstrate how to use the new .NET Core Configuration components in legacy projects such as previous versions of ASP.NET.</p>
        </article>
        <article id="article-3085">
            <a href="https://www.stevejgordon.co.uk/project-json-replaced-by-csproj" target="_blank">
                <h2 class="title mb-6" id="article-3085">R.I.P project.json &#x2013; Out with the new, in with the old</h2>
            </a>
            <p class="mb-2">by Steve Gordon</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 18, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay; the title of the post is a bit tongue in cheek! Since it was first announced that the new project.json format (developed by the ASP.NET Core team) was going to be retired in favour of the more traditional csproj file, the .NET community have had some very strong opinions. These have been shared on [&#x2026;]</p>
        </article>
        <article id="article-3086">
            <a href="https://ayende.com/blog/176039/making-code-faster-pulling-out-the-profiler" target="_blank">
                <h2 class="title mb-6" id="article-3086">Making code faster</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 18, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After doing all I can without reaching out to the profiler, and managing to get x45 performance gain, let us see what the profiler actually tells us. We&#x2019;ll use the single threaded version, since that is easier.&#xA;Here it is:&#xA;&#xA;We can see that dictionary operations take a lot of time, which is to be expected. But what is very surprising is that the date time calls are extremely expensive in this case.&#xA;The relevant code for those is here. You can see that it is pretty nice, but there are a bunch of things there that are likely costing us. The exception inside the method prevents in lining, there is error handling here that we don&#x2019;t need, since we can safely assume in this exercise that the data is valid, etc.&#xA;So I changed the ParseTime to do this directly, like so:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private static readonly int[] DaysToMonth365 = {&#xA;        &#xA;        &#xA;          &#xA;              0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365};&#xA;        &#xA;        &#xA;          &#xA;          private static readonly int[] DaysToMonth366 = {&#xA;        &#xA;        &#xA;          &#xA;              0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366};&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          private const long TicksPerMillisecond = 10000;&#xA;        &#xA;        &#xA;          &#xA;          private const long TicksPerSecond = TicksPerMillisecond * 1000;&#xA;        &#xA;        &#xA;          &#xA;          private const long TicksPerMinute = TicksPerSecond * 60;&#xA;        &#xA;        &#xA;          &#xA;          private const long TicksPerHour = TicksPerMinute * 60;&#xA;        &#xA;        &#xA;          &#xA;          private const long TicksPerDay = TicksPerHour * 24;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          private static long ParseTime(byte* buffer)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              var year = ParseInt(buffer, 4);&#xA;        &#xA;        &#xA;          &#xA;              var month = ParseInt(buffer &#x2B; 5, 2);&#xA;        &#xA;        &#xA;          &#xA;              var day = ParseInt(buffer &#x2B; 8, 2);&#xA;        &#xA;        &#xA;          &#xA;              var hour = ParseInt(buffer &#x2B; 11, 2);&#xA;        &#xA;        &#xA;          &#xA;              var min = ParseInt(buffer &#x2B; 14, 2);&#xA;        &#xA;        &#xA;          &#xA;              var sec = ParseInt(buffer &#x2B; 17, 2);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              var leap = year%4 == 0 &amp;&amp; (year%100 != 0 || year%400 == 0);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              int[] days = leap ? DaysToMonth366 : DaysToMonth365;&#xA;        &#xA;        &#xA;          &#xA;              int y = year - 1;&#xA;        &#xA;        &#xA;          &#xA;              int n = y*365 &#x2B; y/4 - y/100 &#x2B; y/400 &#x2B; days[month - 1] &#x2B; day - 1;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              long totalSeconds = (long)hour * 3600 &#x2B; (long)min * 60 &#x2B; sec;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              return n*TicksPerDay &#x2B; totalSeconds*TicksPerSecond;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          no-error-handling-time-parse.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;And that saved us 11%, just this tiny change.&#xA;Here are our current costs:&#xA;&#xA;Note that we reduced the cost of parse significantly ( at the cost of error handling, though ), but there are still a lot of work being done here. It turns out that we were actually measuring the time to write to the summary file as well (that is what all those FormatHelpers calls are), so that dirty the results somewhat, but nevermind.&#xA;The next place that we need to look at is the Dictionary, it is expensive, even though the usage of FastRecord means that we only need a single call per line, that isn&#x2019;t so much fun. Note that it is using the GenericEqualityComparer, can we do better?&#xA;Trying to create my own equality comparer for longs doesn&#x27;t really help.&#xA;&#xA;So we&#x2019;ll go back to the parallel version with the ParseTime optimization, and we are now running at 628 ms. And at this rate, I don&#x2019;t think that there is a lot&#xA0; more room for improvements, so unless someone suggests something, we are done.</p>
        </article>
        <article id="article-3087">
            <a href="https://ayende.com/blog/176038/making-code-faster-i-like-my-performance-unsafely" target="_blank">
                <h2 class="title mb-6" id="article-3087">Making code faster</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 17, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After introducing the problem and doing some very obvious things, then doing some pretty non obvious things and even writing our own I/O routines we ended up with an implementation that is 17 times faster than the original one. And yet we can still do better. But at this point, we need to go native and use a bit of unsafe code. We&#x2019;ll start by implementing a na&#xEF;ve native record parser, like so: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public static unsafe class NativeRecord&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              public static void Parse(byte* buffer, out long id, out long duration)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  duration = (ParseTime(buffer &#x2B; 20) - ParseTime(buffer)).Ticks;&#xA;        &#xA;        &#xA;          &#xA;                  id = ParseInt(buffer &#x2B; 40, 8);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private static DateTime ParseTime(byte* buffer)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var year = ParseInt(buffer, 4);&#xA;        &#xA;        &#xA;          &#xA;                  var month = ParseInt(buffer &#x2B; 5, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var day = ParseInt(buffer &#x2B; 8, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var hour = ParseInt(buffer &#x2B; 11, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var min = ParseInt(buffer &#x2B; 14, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var sec = ParseInt(buffer &#x2B; 17, 2);&#xA;        &#xA;        &#xA;          &#xA;                  return new DateTime(year, month, day, hour, min, sec);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private static int ParseInt(byte* buffer, int size)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var val = 0;&#xA;        &#xA;        &#xA;          &#xA;                  for (int i = 0; i &lt; size; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      val *= 10;&#xA;        &#xA;        &#xA;          &#xA;                      val &#x2B;= buffer[i] - &#x27;0&#x27;;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  return val;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          native-record-reader.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; This is pretty much the same as before, but now we are dealing with pointers. How do we use this? &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var stats = new Dictionary&lt;long, FastRecord&gt;();&#xA;        &#xA;        &#xA;          &#xA;          using (var mmf = MemoryMappedFile.CreateFromFile(args[0]))&#xA;        &#xA;        &#xA;          &#xA;          using (var accessor = mmf.CreateViewAccessor())&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              byte* buffer = null;&#xA;        &#xA;        &#xA;          &#xA;              accessor.SafeMemoryMappedViewHandle.AcquirePointer(ref buffer);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              var end = buffer &#x2B; new FileInfo(args[0]).Length;&#xA;        &#xA;        &#xA;          &#xA;              while (buffer != end)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  long id;&#xA;        &#xA;        &#xA;          &#xA;                  long duration;&#xA;        &#xA;        &#xA;          &#xA;                  NativeRecord.Parse(buffer, out id, out duration);&#xA;        &#xA;        &#xA;          &#xA;                  buffer &#x2B;= 50;&#xA;        &#xA;        &#xA;          &#xA;                  FastRecord value;&#xA;        &#xA;        &#xA;          &#xA;                  if (stats.TryGetValue(id, out value) == false)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      stats[id] = value = new FastRecord&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          Id = id&#xA;        &#xA;        &#xA;          &#xA;                      };&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  value.DurationInTicks &#x2B;= duration;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          mmap-records.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; We memory map the file, and then we go over it, doing no allocations at all throughout.  This give us 1 second to process the file, 126 MB allocated (probably in the dictionary) and a peak working set of 320 MB. We are now 30 times faster than the initial implementation, and I wonder if I can do more&#x2026; ? We can do that by going parallel, which give us the following code: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          // state&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          public unsafe class ThreadState&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              public Dictionary&lt;long, FastRecord&gt; Records;&#xA;        &#xA;        &#xA;          &#xA;              public byte* Start;&#xA;        &#xA;        &#xA;          &#xA;              public byte* End;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          // parallel work&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          Dictionary&lt;long, FastRecord&gt; allStats;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          using (var mmf = MemoryMappedFile.CreateFromFile(args[0]))&#xA;        &#xA;        &#xA;          &#xA;          using (var accessor = mmf.CreateViewAccessor())&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              byte* buffer = null;&#xA;        &#xA;        &#xA;          &#xA;              accessor.SafeMemoryMappedViewHandle.AcquirePointer(ref buffer);&#xA;        &#xA;        &#xA;          &#xA;              var len = new FileInfo(args[0]).Length;&#xA;        &#xA;        &#xA;          &#xA;              var entries = len / 50;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              int count = 4;&#xA;        &#xA;        &#xA;          &#xA;              var threadStates = new ThreadState[count];&#xA;        &#xA;        &#xA;          &#xA;              for (int i = 0; i &lt; count; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  threadStates[i] = new ThreadState&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      Records = new Dictionary&lt;long, FastRecord&gt;(),&#xA;        &#xA;        &#xA;          &#xA;                      Start = buffer &#x2B; i * (entries / count) * 50,&#xA;        &#xA;        &#xA;          &#xA;                      End = buffer &#x2B; (i&#x2B;1) * (entries / count) * 50&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              threadStates[threadStates.Length - 1].End = buffer &#x2B; len;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Parallel.ForEach(threadStates, state=&gt; &#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  while (state.Start != state.End)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      long id;&#xA;        &#xA;        &#xA;          &#xA;                      long duration;&#xA;        &#xA;        &#xA;          &#xA;                      NativeRecord.Parse(state.Start, out id, out duration);&#xA;        &#xA;        &#xA;          &#xA;                      state.Start &#x2B;= 50;&#xA;        &#xA;        &#xA;          &#xA;                      FastRecord value;&#xA;        &#xA;        &#xA;          &#xA;                      if (state.Records.TryGetValue(id, out value) == false)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          state.Records[id] = value = new FastRecord&#xA;        &#xA;        &#xA;          &#xA;                          {&#xA;        &#xA;        &#xA;          &#xA;                              Id = id&#xA;        &#xA;        &#xA;          &#xA;                          };&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      value.DurationInTicks &#x2B;= duration;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              });&#xA;        &#xA;        &#xA;          &#xA;              allStats = threadStates[0].Records;&#xA;        &#xA;        &#xA;          &#xA;              for (int i = 1; i &lt; count; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  foreach (var record in threadStates[i].Records)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      FastRecord value;&#xA;        &#xA;        &#xA;          &#xA;                      if (allStats.TryGetValue(record.Key, out value))&#xA;        &#xA;        &#xA;          &#xA;                          value.DurationInTicks &#x2B;= record.Value.DurationInTicks;&#xA;        &#xA;        &#xA;          &#xA;                      else&#xA;        &#xA;        &#xA;          &#xA;                          allStats.Add(record.Key, record.Value);&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          parallel-mmap-work.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; This is pretty ugly, but basically we are using 4 threads to run it, and we are giving each one of them a range of the file, as well as their own dedicated records dictionary. After we are done, we need to merge the records to a single dictionary, and that is it. Using this approach, we can get down to 663 ms run time, 184 MB of allocations and 364 MB peak working set. So we are now about 45(!) times faster than the original version. We are almost done, but on my next post, I&#x2019;m going to go ahead and pull the profiler and see if we can squeeze anything else out of it.</p>
        </article>
        <article id="article-3088">
            <a href="https://andrewlock.net/troubleshooting-asp-net-core-1-1-0-install-problems/" target="_blank">
                <h2 class="title mb-6" id="article-3088">Troubleshooting ASP.NET Core 1.1.0 install problems</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 17, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how I fixed some issues I encountered when installing the .NET Core 1.1.0 preview 1 SDK. The 1.1.0 RTM is out now, but it still applies!&#x2026;</p>
        </article>
        <article id="article-3089">
            <a href="https://ayende.com/blog/176037/making-code-faster-going-down-the-i-o-chute" target="_blank">
                <h2 class="title mb-6" id="article-3089">Making code faster</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 16, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After introducing the problem and doing some very obvious things, and then doing some pretty non obvious things we have managed to get to 1/8 of the initial time of the original implementation. But we can do better still. So far, we relied heavily on the File.ReadLines method, which handle quite a lot of the parsing complexity for us. However, that would still allocate a string per line, and our parsing relied on us splitting the strings again, meaning more allocations. We can take advantage of our knowledge of the file to do better. The code size blows up, but it is mostly very simple. We create a dedicated record reader class, which will read each line from the file, with a minimum of allocations. &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public class RecordReader : IDisposable&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              public long Duration;&#xA;        &#xA;        &#xA;          &#xA;              public long Id;&#xA;        &#xA;        &#xA;          &#xA;              private readonly StreamReader _streamReader;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private const int SizeOfDate = 19;// 2015-01-01T16:44:31&#xA;        &#xA;        &#xA;          &#xA;              private const int SizeOfSpace = 1;&#xA;        &#xA;        &#xA;          &#xA;              private const int SizeOfId = 8; // 00043064&#xA;        &#xA;        &#xA;          &#xA;              private const int SizeOfNewLine = 2; // \r\n&#xA;        &#xA;        &#xA;          &#xA;              private const int SizeOfRecord = SizeOfDate &#x2B; SizeOfSpace &#x2B; SizeOfDate &#x2B; SizeOfSpace &#x2B; SizeOfId &#x2B; SizeOfNewLine;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private readonly char[] _buffer = new char[SizeOfRecord];&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public RecordReader(string file)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _streamReader = new StreamReader(file);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public bool MoveNext()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  int sizeRemaining = _buffer.Length;&#xA;        &#xA;        &#xA;          &#xA;                  int index = 0;&#xA;        &#xA;        &#xA;          &#xA;                  while (sizeRemaining &gt; 0)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      var read = _streamReader.ReadBlock(_buffer, index, sizeRemaining);&#xA;        &#xA;        &#xA;          &#xA;                      if (read == 0)&#xA;        &#xA;        &#xA;          &#xA;                          return false;&#xA;        &#xA;        &#xA;          &#xA;                      index &#x2B;= read;&#xA;        &#xA;        &#xA;          &#xA;                      sizeRemaining -= read;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  Duration = (ParseTime(20) - ParseTime(0)).Ticks;&#xA;        &#xA;        &#xA;          &#xA;                  Id = ParseInt(40, 8);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  return true;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private DateTime ParseTime(int pos)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var year = ParseInt(pos, 4);&#xA;        &#xA;        &#xA;          &#xA;                  var month = ParseInt(pos &#x2B; 5, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var day = ParseInt(pos &#x2B; 8, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var hour = ParseInt(pos &#x2B; 11, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var min = ParseInt(pos &#x2B; 14, 2);&#xA;        &#xA;        &#xA;          &#xA;                  var sec = ParseInt(pos &#x2B; 17, 2);&#xA;        &#xA;        &#xA;          &#xA;                  return new DateTime(year, month, day, hour, min, sec);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private int ParseInt(int pos, int size)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var val = 0;&#xA;        &#xA;        &#xA;          &#xA;                  for (int i = pos; i &lt; pos &#x2B; size; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      val *= 10;&#xA;        &#xA;        &#xA;          &#xA;                      val &#x2B;= _buffer[i] - &#x27;0&#x27;;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  return val;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Dispose()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _streamReader.Dispose();&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          record-reader.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; There is a non trivial amount of stuff going on here. We start by noting that the size in character of the data is fixed, so we can compute the size of a record very easily. Each record is exactly 50 bytes long. The key parts here is that we are allocating a single buffer variable, which will hold the line characters. Then we just wrote our own date and integer parsing routines that are very trivial, specific to our case and most importantly, don&#x2019;t require us to allocate additional strings. Using this code is done with: &#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;            var stats = new Dictionary&lt;long, FastRecord&gt;();&#xA;        &#xA;        &#xA;          &#xA;            using (var reader = new RecordReader(args[0]))&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                while (reader.MoveNext())&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                    FastRecord value;&#xA;        &#xA;        &#xA;          &#xA;                    if (stats.TryGetValue(reader.Id, out value) == false)&#xA;        &#xA;        &#xA;          &#xA;                    {&#xA;        &#xA;        &#xA;          &#xA;                        stats[reader.Id] = value = new FastRecord&#xA;        &#xA;        &#xA;          &#xA;                        {&#xA;        &#xA;        &#xA;          &#xA;                            Id = reader.Id&#xA;        &#xA;        &#xA;          &#xA;                        };&#xA;        &#xA;        &#xA;          &#xA;                    }&#xA;        &#xA;        &#xA;          &#xA;                    value.DurationInTicks &#x2B;= reader.Duration;&#xA;        &#xA;        &#xA;          &#xA;                }&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          with-record-reader.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA; So we are back to single threaded mode. Running this code gives us a runtime of 1.7 seconds, 126 MB allocated and a peak working set of 35 MB. We are now about 2.5 times faster than previous parallel version, and over 17 times faster than the original version. Making this code parallel is fairly trivial now, divide the file into sections and have a record reader on each section, but is there really much point at this stage?</p>
        </article>
        <article id="article-3090">
            <a href="https://enterprisecraftsmanship.com/posts/when-to-include-external-systems-into-testing-scope/" target="_blank">
                <h2 class="title mb-6" id="article-3090">When to include external systems in testing scope</h2>
            </a>
            <p class="mb-2">by Vladimir Khorikov</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 15, 2016
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Should you always mock out your database? Or should you include it in the unit/integration testing scope? What about other external systems? This post is based on my Pluralsight course about Pragmatic Unit Testing.&#xA; Two types of external dependencies When it comes to external dependencies (dependencies outside the process that hosts your application, such as a database, a 3rd party system, etc.), there&#x2019;s no single guideline regarding how to work with them in tests.</p>
        </article>
        <div class="button flex justify-between">
            <a href="308.html"><span class="back arrow"></span></a>

            <a href="310.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
