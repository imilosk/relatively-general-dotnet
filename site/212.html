
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 212 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-2111">
            <a href="https://ayende.com/blog/185731-A/reminder-ill-be-in-codemash-is-next-week" target="_blank">
                <h2 class="title mb-6" id="article-2111">Reminder</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 03, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Next week is CodeMash, in Ohio. I&#x2019;m going to be at the conference and I have a talk about extreme performance architecture. I&#x2019;m going to try to condense in 45 minutes the lessons that took us a decade to learn and almost two years to implement. That should be fun, but as much as I enjoy speaking, it is the first time in a while that I&#x2019;m actually going to go to a conference, not just be there at the booth, and that is really exciting for me.I took a look at the schedule and there are some interesting workshops and sessions. Without any particular order, here are the things that popped out as stuff that I would like to be atBTW, to the CodeMash people, not being able to link directly to the sessions is a PITA.Workshops:Up &amp; Running with Graph Databases - Greg Jordan &#x2013; I would love to get a feel to how things are looking from the side consuming the graph API, not the one implementing it. If all goes well, I might do a series of posts on the exercises in the workshop as it pertains to RavenDB.CodeMash CryptoParty - Dusty Burwell &#x2013; I have a love/hate relationship with cryptography. I find it fascinating but the math is usually beyond me,&#xA0; so I can&#x2019;t understand it (that&#x2019;s a joke).Sessions:Making and Baking an Application Security Department - Bill Sempf &#x2013; Following up on the crypto party, this is an are that I care deeply about, so it is worth the 8AM timeslot to learn more about this. I&#x2019;m also interested in how I can, as an infrastructure, meaningfully contribute to the application overall security.7 Reasons why your microservices should use Event Sourcing &amp; CQRS - Hugh McKee &#x2013; I&#x2019;m familiar with both CQRS and microservices, but putting them together seems interesting. I&#x2019;m mostly wondering about the data flow paths in such a system as the data is required on multiple servers.&quot;Did you get my message?&quot; - A comparison of several modern messaging platforms - Jack Bennett &#x2013; This is very close to what I usually do, and I went over ZeroMQ&#x2019;s code a few time, so that would be interesting.Building a better audit log - Craig Hills &#x2013; this is a pain point in many cases, what to log and how, and the tension between logging too much and too little.Database DevOps with Containers - Rob Richardson &#x2013; I think that my interest in this one is pretty obvious .Bluetooth Prototyping with the Raspberry Pi &#x2013; I&#x2019;m using my Raspberry Pis to run clusters of database servers, I wonder if there are other possible uses for a 25$ machine&#x2026;&#xA;Extreme Performance Architecture - Oren Eini &#x2013; I&#x2019;m giving this talk, so I guess I gotta. Pivot: How to proceed when things don&#x27;t work out - Jay Harris &#x2013; This is in the same timeslot as I&#x2019;m speaking at, but I would have like to listen to it. Failure, planning for failure and recovering from it are all very important skills.ZAPping Security Vulnerabilities in Your Development Pipeline - Matthew Smith &#x2013; This seems like it would be a session that cover an eminently useful skill.My users posted what? - Harold Pulcher &#x2013; I don&#x2019;t have a direct use for the topics discussed here, but it seems interesting, and I like learning for leaning sake. At some future time, it always pays off.APIs on the Scale of Decades - Gary Fleming - RavenDB is ten years old, and I&#x2019;m certainly feeling the pressure there.THE STORIES OF THE MOST INFAMOUS BUGS - Ian Zelikman &#x2013; Because who doesn&#x2019;t want to see a clown slip on a banana peel, and this is the high tech equivalent. Data management in a Microservices world - Gerald Venzl &#x2013; This is a topic that I have been thinking a lot about, and more information there would be very useful.Patterns and Architectures Beyond Microservices - Stephen Shary &#x2013; should be interesting, some of the patterns that are mentioned in the description aren&#x2019;t known to me and I have to exert some willpower not to search for them and wait for the session.Post Mortem: Dealing with Failure in Development - BJ Burns &#x2013; Already said that this is an important topic, so this session is also very intereseting.Building A Highly Scalable Service that Survived A Super Bowl - Keith Elder &#x2013; Because if nothing else, the story is likely going to be awesome.Comments are Useless and Other Controversial Opinions About Code - Izzi Bikun &#x2013; This sounds like a fun session.There are a lot of other stuff there that looks good, and I don&#x2019;t even know if I&#x2019;ll be able to get through all these sessions (not actually possible, there are timing conflicts between some of them). But the point of the conference isn&#x2019;t just to sit in the sessions but the hallway interactions and actually talking with people.I&#x2019;m looking forward to that and I&#x2019;m bringing a few books and some swag as well, if anyone is there and is interested. I&#x2019;m really looking forward to it.</p>
        </article>
        <article id="article-2112">
            <a href="https://ayende.com/blog/185698-A/using-tls-with-rust-part-i" target="_blank">
                <h2 class="title mb-6" id="article-2112">Using TLS with Rust</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 02, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The next interesting step in my Rust network protocol exercise is to implement TLS. I haven&#x2019;t looked at that yet, so it is going to be interesting.The first search for &#x201C;Rust TLS&#x201D; gives me the rustls project, which seems to provide a native Rust implementation. There are also native-tls, which uses the system TLS library and binding for OpenSSL. I&#x2019;m not sure how trust worthy rustls is, but I&#x2019;m building a network protocol that is meant as an exercise, so I don&#x2019;t really care. The first thing that I wanted to write was pretty trivial. Just convert the current code to use TLS on the wire, nothing more. I wrote the following code to set things up:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          fn new(cert_path: &amp;str, key_path: &amp;str, listen_uri: &amp;str) -&gt; Result&lt;Server, ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              fn open_cert_file&lt;F,T&gt;(file: &amp;str, method: F) -&gt; Result&lt;Vec&lt;T&gt;, ConnectionError&gt; &#xA;        &#xA;        &#xA;          &#xA;                  where F : Fn(&amp;mut io::BufRead) -&gt; Result&lt;Vec&lt;T&gt;, ()&gt; {&#xA;        &#xA;        &#xA;          &#xA;                  let certfile = fs::File::open(file)?;&#xA;        &#xA;        &#xA;          &#xA;                  let mut reader = io::BufReader::new(certfile);&#xA;        &#xA;        &#xA;          &#xA;                  match method(&amp;mut reader) {&#xA;        &#xA;        &#xA;          &#xA;                      Err(_) =&gt; return Err(ConnectionError::failed_cert(file)),&#xA;        &#xA;        &#xA;          &#xA;                      Ok(certs) =&gt; match certs.len() {&#xA;        &#xA;        &#xA;          &#xA;                          0 =&gt; return Err(ConnectionError::failed_cert(file)),&#xA;        &#xA;        &#xA;          &#xA;                          _ =&gt; Ok(certs)&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let mut config = rustls::ServerConfig::new(rustls::NoClientAuth::new());&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let certs = open_cert_file(cert_path, rustls::internal::pemfile::certs)?;&#xA;        &#xA;        &#xA;          &#xA;              let key = open_cert_file(key_path, rustls::internal::pemfile::rsa_private_keys)&#xA;        &#xA;        &#xA;          &#xA;                          .or_else(|_| open_cert_file(key_path, rustls::internal::pemfile::pkcs8_private_keys))&#xA;        &#xA;        &#xA;          &#xA;                          .and_then(|keys| match keys.get(0){&#xA;        &#xA;        &#xA;          &#xA;                              None =&gt; Err(ConnectionError::failed_cert(key_path)),&#xA;        &#xA;        &#xA;          &#xA;                              Some(key) =&gt; Ok(key.clone())&#xA;        &#xA;        &#xA;          &#xA;                          })?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              config.set_single_cert(certs, key)?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let listener = TcpListener::bind(listen_uri)?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(Server { tls_config: Arc::new(config), tcp_listener: listener })&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          server.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;There is a lot going on and I spend some time figuring out exactly what needs to be done here. I&#x2019;m kinda proud / kinda scared of this code. It is packed. But on the other hand, if you read it, it is fairly clear, it is just that it does a lot of stuff.I then used this in the following way:And that led to this error when using OpenSSL to connect to it:On the rust side, it died with:The good thing, both sides agree that there is a handshake issue, but I had no idea what was going on. The bad thing, I have no clue why this is failing. According to the docs, this is supposed to work. I tried debugging into rustls and it seems to be failing very early in the handshake process, but I&#x2019;m not familiar enough with either Rust or TLS to really understand why. The core issues seems to be here:Note that we get a payload of None, but when I&#x2019;m debugging through the code in the read_version method, it seems like it returns properly.Oh, I figured it out, the issue is here:Note the highlighted section? If this returns a None, it will silently return from the method. It is easy to miss something like that. Digging (much) deeper, I found:And deeper still, we have:Go back a bit and see what kind of URL I gave to OpenSSL, it was 127.0.0.1, and it seems like rustls doesn&#x2019;t support raw IPs, only hostnames. The limit seems to be the result of this code:This seems to be a known error, it is opened since May 2017 and it is a completely deal breaker for me. I&#x2019;m guessing that this isn&#x2019;t a big issue in general because usually if you have a cert, it is for a hostname and certificates for IPs (which exists, but tend to be issued for private CAs) are far rarer.I changed my cmd line to use:And it started working, but at that point, I was debugging this issue for over an hour, so that is quite enough for today.As an aside, I was able to attach to the rust process using Visual Studio and debug it fairly normally. There is some weirdness that I believe relates to the cleanup, where if you abort a method early it looks like it goes back in time until it exit the method. However, overall it works fairly nicely. I do have to point out that many of the nicer features in the language are making debugging much harder.That said, once thing was absolutely amazing and it was the fact that I was so easily debug into my dependencies, in fact, I was changing the code of my dependencies and re-running it, to help me narrow down exactly where the error was. That was easy, obvious and worked. Very nice!</p>
        </article>
        <article id="article-2113">
            <a href="https://ardalis.com/becoming-a-developer-team-force-multiplier/" target="_blank">
                <h2 class="title mb-6" id="article-2113">Becoming a Developer Team Force Multiplier</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 02, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have clients who describe me and my team as a &quot;force multiplier&quot; for their development organization. What does this mean, and how can it&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-2114">
            <a href="https://andrewlock.net/using-dependency-injection-with-twilio-sms-and-asp.net-core-2-1/" target="_blank">
                <h2 class="title mb-6" id="article-2114">Using dependency injection with Twilio SMS and ASP.NET Core 2.1</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 02, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post, I describe how to create a custom ITwilioRestClient, register it with the DI container, and inject it into an MVC controller.&#x2026;</p>
        </article>
        <article id="article-2115">
            <a href="https://ayende.com/blog/185665-A/writing-my-network-protocol-in-rust" target="_blank">
                <h2 class="title mb-6" id="article-2115">Writing my network protocol in Rust</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: January 01, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After spending a lot of time writing my network protocol in C, I decided that it would be a nice exercise to do the same in Rust. I keep getting back to this language because I want to like it. I hope that having a straightforward task and the passage of time will make things easier than before.&#xA;I gotta say, the compiler feels a lot nicer now. Check this out:&#xA;&#xA;I really like it. This feels like the compiler is actively trying to help me get in the right path&#x2026;&#xA;And this error message made me even happier:&#xA;&#xA;Thank you, this is clear, concise and to the point.&#xA;I can indeed report that the borrow checker is indeed very much present, but at least now it will tell you what is the magic incantation you need to make it happen:&#xA;&#xA;This is my third or forth foray into Rust, and I stopped a few times before because the learning curve and the&#x2026; Getting Things Done curve were just weren&#x2019;t there for me. In this case, however, I&#x2019;m getting a very different feel all around. There is a lot less messing around and a lot more actually getting to where I want to go. I&#x2019;m still significantly slower, naturally, since I&#x2019;m learning idioms and the mechanics of the language, but there is a lot less friction. And the documentation has been top notch, and I&#x2019;m leaning on that a lot.&#xA;In particular, one of my pet peeves seems to have been resolved. Composite error handling is now as simple as:&#xA;&#xA0;&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          extern crate custom_error;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          custom_error! {&#xA;        &#xA;        &#xA;          &#xA;              ConnectionError&#xA;        &#xA;        &#xA;          &#xA;              Io{source: io::Error} = &quot;unable to read from the network&quot;,&#xA;        &#xA;        &#xA;          &#xA;              Utf8{source: std::str::Utf8Error} = &quot;Invalid UTF8 character sequence&quot;,&#xA;        &#xA;        &#xA;          &#xA;              Parse{origin: String} = &quot;Unable to parse command: {origin}&quot;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          impl ConnectionError {&#xA;        &#xA;        &#xA;          &#xA;              fn parsing(origin: &amp;str) -&gt; ConnectionError {&#xA;        &#xA;        &#xA;          &#xA;                  ConnectionError::Parse{ origin: origin.to_string() }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          errors.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;Removing the ceremony from error handling is a great relief, I have to say.&#xA;It took me a couple of evenings to get to the point where I can setup a TCP server, accept a connection and parse the command. Let me see if I can break it up to manageable parts, even though the whole thing is about 100 lines of code, this is packed.&#xA;I&#x2019;m certainly feeling the fact that Rust actually have a runtime library. I mean, C has one, but it is pretty anemic to say the least. And actually having an OOTB solution for packaging is not really an option today, it is a baseline requirement.&#xA;Here is the code that handles the connection itself.&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          fn handle_connection(mut stream: TcpStream) -&gt; Result&lt;(), ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;              stream.write(b&quot;OK\r\n&quot;)?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let mut cmd_buffer = Vec::new();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              loop {&#xA;        &#xA;        &#xA;          &#xA;                  let consumed_bytes = { &#xA;        &#xA;        &#xA;          &#xA;                      let msg = read_full_message(&amp;stream, &amp;mut cmd_buffer)?;&#xA;        &#xA;        &#xA;          &#xA;                      let cmd_str = std::str::from_utf8(msg)?;&#xA;        &#xA;        &#xA;          &#xA;                      let cmd = parse_cmd(&amp;cmd_str)?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      dispatch_cmd(&amp;stream, cmd)?;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      msg.len()&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;                  cmd_buffer.drain(0 .. consumed_bytes);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          conn.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;By itself, it is pretty simple. It starts by letting the client know that we are ready (the OK msg) and then read a message from the client, parse it and dispatch it. Rinse, repeat, etc.&#xA;There are a couple of interesting things going on here that might be worth your attention:&#xA;&#xA;The read_full_message() function works on bytes, and it is responsible for finding the message boundaries. The code is meant to handle pipelined messages, partial reads, etc.&#xA;Once we have the range of bytes that represent a single message, we translate them to UTF8 string and use string processing to parse the command. This is simpler than the tokenization we did in C.&#xA;After processing a message, we drain the data we already process and continue with the data already in the buffer. Note that we basically reuse the same buffer, so hopefully there shouldn&#x2019;t be too many allocations along the way.&#xA;&#xA;The buffer handling is the responsibility of the read_full_message() function, which looks like:&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          lazy_static! {&#xA;        &#xA;        &#xA;          &#xA;              static ref msg_break : TwoWaySearcher&lt;&#x27;static&gt; = {&#xA;        &#xA;        &#xA;          &#xA;                  TwoWaySearcher::new(&quot;\r\n\r\n&quot;.as_bytes())&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          fn read_full_message&lt;&#x27;a&gt;(mut stream: &amp;TcpStream, buffer: &amp;&#x27;a mut Vec&lt;u8&gt;) -&gt; Result&lt;&amp;&#x27;a [u8], ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;              let mut to_scan = 0;&#xA;        &#xA;        &#xA;          &#xA;              let mut tmp_buf = [0; 256];&#xA;        &#xA;        &#xA;          &#xA;              loop {&#xA;        &#xA;        &#xA;          &#xA;                  match msg_break.search_in(&amp;buffer[to_scan..]) {&#xA;        &#xA;        &#xA;          &#xA;                      None =&gt; to_scan = min(buffer.len() - 3, 0),&#xA;        &#xA;        &#xA;          &#xA;                      Some(msg_end) =&gt; return Ok(&amp;buffer[0..(to_scan &#x2B; msg_end)])&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  let read = stream.read(&amp;mut tmp_buf)?;&#xA;        &#xA;        &#xA;          &#xA;                  if read &#x2B; buffer.len() &gt; 8192 {&#xA;        &#xA;        &#xA;          &#xA;                      return Err(ConnectionError::MessageTooBig)&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  buffer.extend_from_slice(&amp;tmp_buf[0..read]);&#xA;        &#xA;        &#xA;          &#xA;              }   &#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          read_msg.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;I&#x2019;m using an inefficient method, where I&#x2019;m reading only 256 bytes at a time from the network, mostly to prove that I can process things that come over in multiple calls. But the basic structure is simple:&#xA;&#xA;Use TwoWaySearcher to search for a byte pattern in the buffer. This is basically memmem() call.&#xA;If the byte pattern (\r\n\r\n) is found, we have a message boundary and can return that to the caller.&#xA;If the message boundary isn&#x2019;t found, we need to read more data from the network.&#xA;I&#x2019;m playing some tricks with the to_scan variable, avoiding the case where I need to scan over data that I have already scanned.&#xA;I&#x2019;m also validating that I&#x2019;m never reading too much from the network and abort the connection if we can&#x2019;t find the message boundary in a reasonable size (8KB).&#xA;&#xA;What remains is some string parsing, which ended up being really easy, since Rust has normal string processing routines.&#xA;&#xA;&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          struct Cmd&lt;&#x27;a&gt; {&#xA;        &#xA;        &#xA;          &#xA;              args: Vec&lt;&amp;&#x27;a str&gt;,&#xA;        &#xA;        &#xA;          &#xA;              headers: HashMap&lt;&amp;&#x27;a str, &amp;&#x27;a str&gt;,&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          fn parse_cmd&lt;&#x27;a&gt;(cmd_str: &amp;&#x27;a str) -&gt; Result&lt;Cmd, ConnectionError&gt; {&#xA;        &#xA;        &#xA;          &#xA;              let mut lines = cmd_str.lines();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let cmd_line = match lines.next() {&#xA;        &#xA;        &#xA;          &#xA;                  None =&gt; {&#xA;        &#xA;        &#xA;          &#xA;                      return Err(ConnectionError::parsing(cmd_str));&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  Some(v) =&gt; v,&#xA;        &#xA;        &#xA;          &#xA;               };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let mut cmd = Cmd {&#xA;        &#xA;        &#xA;          &#xA;                  args: cmd_line.split(&#x27; &#x27;).collect(),&#xA;        &#xA;        &#xA;          &#xA;                  headers: HashMap::new(),&#xA;        &#xA;        &#xA;          &#xA;              };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              for line in lines {&#xA;        &#xA;        &#xA;          &#xA;                  let parts: Vec&lt;&amp;str&gt; = line.splitn(2, &#x27;:&#x27;).collect();&#xA;        &#xA;        &#xA;          &#xA;                  if parts.len() != 2 {&#xA;        &#xA;        &#xA;          &#xA;                      return Err(ConnectionError::parsing(line));&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  cmd.headers.insert(parts[0].trim(), parts[1].trim());&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              Ok(cmd)&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          cmd.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;&#xA;And this is pretty much it, I gotta say. For that amount of code, it took a long time to get there, but I&#x2019;m pretty happy with the state of the code. Of course, this is still pretty early in the game and it isn&#x2019;t really doing anything really interesting. The TCP server can accept only a single connection (breaking the connection will kill the server, at this point), error handling is the same as not having a single catch in the entire system, etc.&#xA;What I expect to be&#x2026; interesting is the use of SSL and concurrent (hopefully async) I/O. We&#x2019;ll see where that will take us&#x2026;</p>
        </article>
        <article id="article-2116">
            <a href="https://ayende.com/blog/185634-C/changing-fundamental-behavior-with-two-lines-of-code" target="_blank">
                <h2 class="title mb-6" id="article-2116">Changing fundamental behavior with two lines of code</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 26, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the measure that we don&#x2019;t care much about is the startup time of RavenDB. Whatever it takes 5 seconds or 15 seconds is of little concern to us. Whatever it takes 15 seconds or 3 minutes, however, is something that we most certainly want to pay attention to.One of our customers has an interesting use case. They are running on Azure machines and take full advantage of the multiple storage options that they have available there. In particular, their journals are using a premium storage disk but their data is residing on a a large (and slow) disk. This is because they have quite a lot of data. One of their indexes just exceeded the 256GB mark, for example. In their case, the startup time for RavenDB wasn&#x2019;t acceptable. We investigated the issue and it turned out that the root of the problem was that RavenDB was running recovery on the database, re-applying recent transactions to make sure that we are consistent. This is expected, and in most cases, shouldn&#x2019;t cause you to spend too much time at startup. By default, journals are going to be about 256MB if you are heavily loaded. But due to the customer&#x2019;s access patterns, we saw transactions that included multiple GBs.&#xA0; We compress the transaction data before writing it to disk,&#xA0; so a single transaction (which cannot be split into multiple journal files) that takes multiple GBs compressed has likely wrote to 10&#x2B; GB on the data file. We can tell that we don&#x2019;t need to apply a transaction if it was already applied, but we need to read and analyze it first. Times that by a number of databases and a number of indexes per database and you can see that restarting RavenDB begins to be something that you plan for. That is not where we want to be, obviously. Now, if we just had a crash, there is really no good way to avoid reapplying these transactions,&#xA0; but the problem was that we saw the same behavior without a crash. We saw this when doing normal shutdown. The basic problem was that RavenDB doesn&#x2019;t track the location in the journal file that we know have been safely synced to disk. We only track things at the journal level. That means that on startup, we need to read through the entire journal file and figure out whatever we need to apply each of the transactions inside it. We could track the last synced transaction location, of course. That would mean changing the on disk format at a very low level, something that we have the facilities to do, but is probably going to be awkward and cause compatibility concerns that I would rather not get into.We also looked into changing the runtime behavior so we&#x2019;ll be more likely to move to a new journal file after we synced the data in the previous one if it is too large. I was looking at this today and figure out something silly. Whenever we have a large transaction (where large is bigger that the max journal size) we need to ensure that we have enough space for the transaction. We do that by allocating a big enough file on disk. However, the way we did that was interesting.&#xA0;As you can see, if the minimum required size is smaller than the current journal size, we make sure to increase it. And because we want to avoid making too many file allocation calls, we try to ensure that we&#x2019;ll use a size that is big enough that the journal file can be used or the next transaction as well. Now, consider the common scenario where the current journal size is 256MB (which is the default journal file limit) and the transaction size is 1.56 GB.What will happen then is that we&#x2019;ll get a journal size of 2GB, of which only 1.56GB is used. This is fine, and we&#x2019;ll use the rest of the space, if we can. However, if the next transaction is too large (let&#x2019;s say, 800MB), we&#x2019;ll need to create a new file, whose size will be 1GB, etc. It is when we sync the data to disk, that we really hit the bad behavior. We just synced the data to disk, so we can get rid of the journal file. But there are still 440MB of disk space allocated to the journal file, so we keep the journal around for the next transaction. And if we restart at that point, we&#x2019;ll have to go through the entire 2 GB journal file to make sure that we haven&#x2019;t missed anything. The fix, in this case, was stupidly easy:All we need to do is to ensure that if the power of two size of the write to the journal is bigger than the max journal size, we&#x2019;ll use the size of the write to the journal. That will create a journal that has just a single transaction on it. Most importantly, that means that once the data is synced to disk, there is no more space available on that journal file and Voron will immediately know that it can clear it. No big journal sticking around, no need to re-structure our on disk data or to go into tricky change of behavior. I really love this change because is it succinct, simple and does the job.</p>
        </article>
        <article id="article-2117">
            <a href="https://ayende.com/blog/185633-C/production-postmortem-handled-errors-and-the-curse-of-recursive-error-handling" target="_blank">
                <h2 class="title mb-6" id="article-2117">Production postmortem</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 25, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;m certain that the archangel that is responsible for statistical grouping has a strange fondness for jokes. If that isn&#x2019;t the case, I can&#x2019;t really explain how we routinely get clear clustering of bug reports on specific issues. We have noticed that several years ago, when we suddenly started to get a lot of reports of a particular issue. There was no recent release and no reason for all of these correlated errors to happen all at once. But they did. Luckily, the critical mass of reports gave us more than enough information to figure out what the bug was and fix it. When we checked, the bug was there, dormant, for 20 months.The current issue we are handling is a spate of reports about hard errors in RavenDB. The kind of errors that use the terms invalid data, in particular. These kind of errors bring development to a screeching halt, as we direct all available resources to figure out what is going on. We didn&#x2019;t have a reproduction, but we did have a few cases of people reporting it and the stack trace we got told us that the problem wasn&#x2019;t isolated to a single location but seemed to be fairly wide spread. This is a Good News / Bad News kind of situation. It is good because it means that the problem is in a low level component, it is bad because it is going to be hard to narrow it down exactly.The common theme around this issue popped up when the system was already in a bad state. We were able to see that when we run out of disk space or when the memory on the system was very low. The common thread to these was that in both cases these are expected and handled scenarios. What is more, these are the kind of errors that we want to keep on shouldering through. In general, the error strategy we use in most of RavenDB is fairly simple. Abort the transaction and give the user an error. If the error is considered catastrophic (I/O failure when writing to disk, for example), we also force a restart of the database (which does full recovery). As it turned out, there were three completely separate issues that we found when investigating this issue.First, and the most critical one was cleanup code that wasn&#x2019;t aware of the state of the system. For example, consider:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public void FlushIndex()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            using(var file = _tx_directory.CreateFile(&quot;foo.bar&quot;))&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;              try&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _tx_directory.WriteDdata(file, _data);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              catch&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                _tx_directory.DeleteFile(file);&#xA;        &#xA;        &#xA;          &#xA;                throw;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          errors.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Let&#x2019;s assume that we have an error during the WriteData. For example, we run out of space on disk. We abort the transaction and throw an exception. The FlushIndex() method, however, will go into the catch clause and try to cleanup its resources. When doing so, it will access the transaction (that was just aborted) and try to use it, still.The problem is that at this point the state of the transaction is known bad, the only thing you are allowed to do is to dispose it, you cannot access anything on it. The code in question, however, is meant to be used on non transactional resource and require compensating actions to revert to previous state.For that matter, the code above has another problem, however. Do you see the using statement here? It seemed like we have quite a bit of code that does stuff in the Dispose method. And if that stuff also touch the transaction, you may get what is called in the profession: &#x201C;hilarity ensued&#x201D;.The problem was that our transaction code was too trusting and assumed that the calling code will not call it if it is in invalid state. Indeed, the cases where we did such a thing were rare, but when they happened.The second problem was when we had code like this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public void Process()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            var errs = new List&lt;(Command,Exception)&gt;();&#xA;        &#xA;        &#xA;          &#xA;            using(var tx = CreateWriteTransaction())&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;              foreach (var cmd in commands)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                try&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                  cmd.Execute(); // may fail, we need to report it&#xA;        &#xA;        &#xA;          &#xA;                }&#xA;        &#xA;        &#xA;          &#xA;                catch(Exception e)&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                   errs.Add((cmd, e));&#xA;        &#xA;        &#xA;          &#xA;                }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              tx.Commit();&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;            ReportErrors(errs);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          process.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Except that the real code is a lot more complex and it isn&#x2019;t as each to see what is going on. What you see here is that we run commands, and as we process them, we may get (expected) exceptions, which we should report to the caller. The problem is that we mixed expected exceptions with unexpected ones. And these unexpected exceptions could leave us in&#x2026; a funny state. At which point we would continue executing future commands and even commit the transaction. As you can imagine, that isn&#x2019;t a good place to be at.We have gone over our error handling and injected faults and errors at any later of the stack that we could conceive of. We have been able to fix a lot of issues, most of them have probably never been triggered, but it was a sobering moment to look at some of those changes. The most likely cause for the errors was a change that was made (by me, as it turns out) over two years ago. And in all that time, we never seen neither hide nor hair of it. Until suddenly we got several simultaneous cases.The third and final problem, by the way, was related to not crashing. By default, any severe enough error should cause us to shut down the database and restart it. In the process, we re-apply the journal and ensure that we are in a consistent state. The problem is that we don&#x2019;t want to do that for certain expected errors. And the issue with staying up was that while Voron (at the storage layer) handled the error properly, the higher level code did not. At that point we had a divergence of the in memory state vs. the on disk state. That usually led to either NRE that would remain until the server was restarted or really scary messages that would typically go away when we recovered the database and reloaded the in memory state from the on disk state.In short, handling errors in the error handling code is tough. The primary changes we made were on the transaction side, we made it validate its own state when called, so code that erroneously try to use a transaction that has already failed will error early. We have also added additional validation of operations in several key points. That would allow us to catch errors much more quickly and allow us to pinpoint exactly where things are breaking apart sooner.The current state is that we pushed these changes to our production system and are running the usual battery of tests to prove that the changes are valid. We&#x2019;ll also be adding more faults into the process to ensure that we exercise our error handling a lot more often.</p>
        </article>
        <article id="article-2118">
            <a href="https://enterprisecraftsmanship.com/posts/hierarchy-value-objects/" target="_blank">
                <h2 class="title mb-6" id="article-2118">Hierarchy of value objects</h2>
            </a>
            <p class="mb-2">by Vladimir Khorikov</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 24, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This article is a response to a reader&#x2019;s question. The question posed an interesting problem that I think will be interesting to a wider audience.</p>
        </article>
        <article id="article-2119">
            <a href="https://ayende.com/blog/185601-C/the-case-for-size-limits-vs-number-limits-vs-time-limits" target="_blank">
                <h2 class="title mb-6" id="article-2119">The case for size limits vs. number limits vs. time limits</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 20, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This post was written because of this tweet, asking whatever RavenDB has something similar to MongoDB&#x2019;s capped collections. RavenDB doesn&#x2019;t have this feature, by design. It is something that would be trivial to add and would likely lead to horrible consequences down the line.&#xA;The basic idea with a capped collection is that you set a limit on the size of the collection, and for any write beyond that limit, you delete the oldest document in the collection until to maintain that limit. You can also specify a maximum number of elements, but you must also always specify the size (in bytes). Redis has a similar feature, with capped lists, but that feature only count the number of items, not their size.&#xA0; Both MongoDB and Redis has the notion of expiring data (which is, incidentally, how RavenDB would handle a similar case).&#xA;I can follow the reasoning behind having a limit based on the number of items, even if I think that in most cases that is going to be an issue. But using the overall size of the data for the limit is a recipe for disaster. You need to plan ahead for the capacity you&#x2019;ll get, and in that case, the actual size of the data isn&#x2019;t really meaningful (assuming that you aren&#x2019;t going to run out of disk space). In fact, even a small change in the access patterns to your system can cause you to lose documents because they have reached the limit in the capped collection.&#xA;For example, if you use a capped collection to process events (which seems like a fairly common scenario), you&#x2019;ll set the maximum size of the collection as a factor of how quickly you can process all the events in the collection plus some padding. But if you event processing is running a bit slow (or even just plain crashed), you are racing against the clock to keep up with the incoming events before they will be removed by the size limit.&#xA;A change in the usage pattern can also be that users are sending more data, instead of sending 140 chars, they are now sending 280 chars, to keep the example focused on Twitter. That can really mess up any calculation you made based on expected sizing.&#xA0;&#xA;In practice, you will usually set the maximum number of elements and set the maximum size of the collection as something that is very high, hoping to never hit that limit.&#xA;I mentioned that I can follow the logic behind having a collection that is capped to a certain number of items. I can see follow the logic, but I disagree with it. In most scenarios when you need this feature, you are looking at stuff like &#x201C;I would like to retain the last 100 transactions&#x201D; or stuff like that. The problem is that in the business world, you almost never think in this way, you don&#x2019;t think in counts, you think in time. What you&#x2019;ll likely be asked is: &#x201C;I would like to retain last month transactions&#x201D;. And if you have less than a 100 transactions a month, these two options end up being very close to one another.&#xA;The way we handle it with RavenDB is through document expiration. You can specify a certain point in time when a document will be automatically deleted and RavenDB will take care of that for you. However, we also have a way to globally disable this feature when you need to extend the expiration for some reason. Working on top of time means that the feature is more closely aligned with the actual business requirements and that you don&#x2019;t throw away perfectly good data too soon.</p>
        </article>
        <article id="article-2120">
            <a href="https://andrewlock.net/creating-an-aws-policy-for-calling-the-ses-mailbox-simulator-from-codebuild/" target="_blank">
                <h2 class="title mb-6" id="article-2120">Creating an AWS policy for calling the SES mailbox simulator from CodeBuild</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: December 20, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how to create an AWS IAM policy that allows you to send email with AWS SES to the mailbox simulator only, not to real recipients.&#x2026;</p>
        </article>
        <div class="button flex justify-between">
            <a href="211.html"><span class="back arrow"></span></a>

            <a href="213.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
