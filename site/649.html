
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 649 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-6481">
            <a href="https://ayende.com/blog/3639/rhino-mocks-3-5-gems-explicit-property-setting-expectations" target="_blank">
                <h2 class="title mb-6" id="article-6481">Rhino Mocks 3.5 Gems - Explicit Property Setting Expectations</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 09, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This post is derived from the Rhino Mocks 3.5 documentation. Setting expectations for property set was always very simple, and slightly confusing with Rhino Mocks. Here is how you do it: view.Username = &quot;the user name&quot;;&#x9;&#xA;The problem is that it is hard to see that there is an expectation created here. So, with the generous help of Sebastian Jancke, we have a new syntax:&#xA;Expect.Call(view.Username).SetPropertyWithArguments(&quot;the user name&quot;);&#xA;&#xA;This is much more explicit and easier to understand. We can also set expectation on the property set, without expecting a certain value using this syntax:&#xA;&#xA; Expect.Call(view.Username).SetPropertyAndIgnoreArguments();</p>
        </article>
        <article id="article-6482">
            <a href="https://ayende.com/blog/3638/how-to-build-an-application" target="_blank">
                <h2 class="title mb-6" id="article-6482">How to build an application</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 09, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I am currently working (well, sort of, more playing around) on the NHibernate Profiler. I thought that this would be a good time to describe how I approach most development tasks.   I don&#x27;t actually have the time/strength to start serious development effort, but I have the time to do a lot of spikes, and to think about architecture. If I decide to spend the time making this happen, I&#x27;ll post more about how it works.  I started with a spike about extracting the actual data from NHibernate. My target goal is being able to profile NHibernate 2.0 without having to modify NHibernate to support this. I actually run into some issues with that, more specifically, I run into technical issues with my chosen approach. Instead of spending time on troubling shooting that, I chose another path. That may not be the way it will end, but I am not interested in the technicalities at the moment, I am interested in the feasibility of the project. Suffice to say that I was successful (and learned a bit about named pipes :-) ). Next, SQL formatting is a pain, but it is something that is mandatory for a profiler, a least if you want to let the users a fighting chance in understanding what is going on. I found a solution for that as well, which I am extremely pleased with. Next is not the actual application architecture, but the user interface. That helps nailing down what the application is going to do, and cement what it is going to do. I am also a great believer of building from the top down, and the architecture that I have in mind make it very simple to split back end processing from the front end.  This is an example of what I have in mind. This is concept UI. It is not meant to be the final thing, it is here merely to give me an idea about what I am going to build. This UI was generated with the assistance of power point and paint, the disclaimer is what I usually put whenever I create a UI.  &#xA0; What you can&#x27;t see, and the purpose of the UI building exercise, is the mental model that it helped me create (the main concepts in the application are sessions, statements and warnings/suggestions). There is a streaming rule set that process those, and a whole set of functionality that just sits there in my head. The next step, at this point, is getting from a UI sketch to a working UI draft. What do I mean by that? It means building the UI (which will intentionally look ugly) and hooking it to a dummy back end. The reasoning here is quite simple. I don&#x27;t care for the look and feel at the moment, that is utterly uninteresting to me at this point, because I have seen what real UI developers can do, and I am not in their league so I am not going to even try. What I do care about in this stage is the actual operation of the UI. I can hand it over for the professionals to handle the beautification process after that part work. Of course, I feel bad about not knowing more about this, so I may spend more time there than I should, but I am going to try. After the presentation layer is done, we can start focusing on the actual back end. That is going to composed of event processing pipeline with a set of rules that I can use to provide warnings and suggestions about what to do. Still debating the interaction between the back end and the front end. Most likely this is going to be a simple ThreadSafeQueue&lt;T&gt; and that&#x27;s it. Oh, and here is the total sum of code written so far:   And if you think that this is interesting that I am not showing code, you are right, what is see is what is :-)</p>
        </article>
        <article id="article-6483">
            <a href="https://ayende.com/blog/3637/safe-for-multi-threading" target="_blank">
                <h2 class="title mb-6" id="article-6483">Safe for multi threading...</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 09, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The easiest way of getting there is to have no mutable state. And here is a simple test to ensure that. Seeing how CouchDB code works and how erlag handle things is quite educating in this regard.[TestFixture]&#xA;public class EnssureTypesSafeForMultiThreadingTestFixture&#xA;{&#xA;    [Test]&#xA;    public void TypeIsSafeForMultiThreading()&#xA;    {&#xA;        var visitedTypes = new List&lt;Type&gt;&#xA;        {   // immutable types, partial list&#xA;            typeof(int),&#xA;            typeof(long),&#xA;            typeof(string),&#xA;            typeof(DateTime)&#xA;        };&#xA;        foreach (var type in GetRootTypesToCheck())&#xA;        {&#xA;            CheckType(type, visitedTypes);&#xA;        }&#xA;    }&#xA;&#xA;    private static void CheckType(Type type, ICollection&lt;Type&gt; types)&#xA;    {&#xA;        if(types.Contains(type))&#xA;            return;&#xA;        types.Add(type);&#xA;        var fields = type.GetFields(BindingFlags.Instance|BindingFlags.NonPublic|BindingFlags.Public);&#xA;        foreach (var info in fields)&#xA;        {&#xA;            var isReadOnlyField = (info.Attributes &amp; FieldAttributes.InitOnly)==FieldAttributes.InitOnly;&#xA;            if(isReadOnlyField==false)&#xA;                throw new InvalidAsynchronousStateException(&quot;Dude, &quot; &#x2B; type &#x2B; &quot;.&quot; &#x2B; info.Name &#x2B;&#xA;                                                            &quot; is not marked as read only. You are NOT safe for multi threading, enjoy the deadlock, bye!&quot;);&#xA;            CheckType(info.FieldType, types);&#xA;        }&#xA;    }&#xA;&#xA;    private static IEnumerable&lt;Type&gt; GetRootTypesToCheck()&#xA;    {&#xA;        // return types that I am interested in verifying&#xA;    }&#xA;}</p>
        </article>
        <article id="article-6484">
            <a href="https://ayende.com/blog/3636/rhino-mocks-challenge-implement-this-feature" target="_blank">
                <h2 class="title mb-6" id="article-6484">Rhino Mocks Challenge: Implement This Feature</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 08, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, let us see if this approach works...&#xA;Here is a description of a feature that I would like to have in Rhino Mocks (modeled after a new feature in Type Mock). I don&#x27;t consider this a complicated feature, and I would like to get more involvement from the community in building Rhino Mocks (see the list of all the people that helped get Rhino Mocks 3.5 out the door).&#xA;The feature is fluent mocks. The idea is that this code should work:&#xA;&#xA;  var mockService = MockRespository.GenerateMock&lt;IMyService&gt;();&#xA;  Expect.Call( mockService.Identity.Name ).Return(&quot;foo&quot;);&#xA;&#xA;  Assert.AreEqual(&quot;foo&quot;, mockService.Identity.Name);&#xA;&#xA;Where identity is an interface.&#xA;The best place to capture such semantics is in the RecordMockState.&#xA;Have fun, and send me the patch :-)</p>
        </article>
        <article id="article-6485">
            <a href="https://ardalis.com/search-trends-october-2008/" target="_blank">
                <h2 class="title mb-6" id="article-6485">Search Trends October 2008</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 06, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">PDC is fast approaching and Cloud Computing is the theme &#x2013; and all the rage for everyone else in the Industry media. Amazon recently&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-6486">
            <a href="https://ayende.com/blog/3635/reading-eralng-couchdb-streams" target="_blank">
                <h2 class="title mb-6" id="article-6486">Reading Eralng: CouchDB Streams</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 06, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A question to my dear readers, do you find this series valuable? Do you consider it interesting? It is a significant departure from my usual set of topics.&#xA;In my recent post I wondered about the concept of summary streams, and how they related to the way CouchDB works. I couldn&#x27;t figure out what they were doing. As it turn out, there is a good documentation for them in this post. There were two things that mislead me. The first was the notion of summary. I think that this is a misnomer, because this is the only place in CouchDB where that term is used. It is not a summary, it is the actual document. As a matter of fact, I think that it is a term that was carried over from Notes.&#xA;The second misleading clue was stream. I am used to think about streams in the classic sense, as a way to access a stream of bytes. The CouchDB notion of stream is quite different. It is a way to optimize disk access, it seems. I wondered about that, because the nature of CouchDB append only file seems certain to cause a lot of issues with regards to internal fragmentation in the file (which would require a lot of seeks, which are slow).&#xA;Let me see if I can deconstruct what is going on in couch_stream, first, we have the structure declaration:&#xA;&#xA;This seems to be pretty reasonable. The write_stream is defining a reserved space in the file, note the next_alloc field. It looks like we are allocating memory (or disk space). Should be interesting. The stream structure just hold the process and the file description, and isn&#x27;t really interesting.&#xA;The initialization of a stream is interesting in itself:&#xA;&#xA;Here we just create a new write stream and copy the initialization values to the state. There seems to be a 1 to 1 mapping between a stream and an erlang process. Let us examine how we write the data. First, we have the stop condition of running out of data to write:&#xA;&#xA;You can learn a lot about the a function in erlang just from its declaration. In this case, &lt;&lt;&gt;&gt; means a binary with no items in it, hence, we run out of things to write.&#xA;And now we come to the function clause that deals with the issue of running out of room to write it.&#xA;&#xA;The first part of the function is using variable binding to extract the values out of the stream. It goes against the grain, I know, to see CurrentPos being &quot;set&quot; when it is on the right side of the assignment, but that how it works. (Well, actually it isn&#x27;t being set, it is being matched, or bound, but that is another issue).&#xA;Next we find what is the next size that we have to allocate, and ask the file to expand. I don&#x27;t think that I have seen this before, let us take a look:&#xA;&#xA;We first get a the end of the file, and then we write a single byte at the end of the file plus the expansion value. In other words, we increase the length of the file by however big Num is. For .NET, this is the equivalent of the SetLength call, and it is important to create continuos files, with as little fragmentation as possible.&#xA;Going back to write_data, we have this line:&#xA;&#xA;The syntax isn&#x27;t really nice, in my opinion, but what we have here is basically: Write to the file Fd at position CurrentPos the value of NewPos (with pack to FILE_POINTER_BITS and then the value of NewSize (packed to STREAM_OFFSET_BITS).&#xA;It is important to note where this is written. Go and take a look at the case statement in which this expression is. First, we setup enough size for the data we want to write and for the next allocation. When we come to the end of the current chunk, we create a new one (by expanding the file) and then write the address of the new chunk into the end of the chunk, following that by a move to the new chunk.&#xA;The last part of write_data is very simple:&#xA;&#xA;We start by figuring out how many bytes we have to write, and then split the binary data by that. We write what we can to the file, and then recursively call ourself (which will either exit (nothing to write) or create a new chunk of the file and continue writing it.&#xA;Elegant, short and to the point. It take more time to describe how it works than it is to write the code. The code for reading is just as sweet:&#xA;&#xA;The stop condition is when we have no more data to read. The second clause is when we have run out of data to read in the current stream, and we need to read about the next one. Again, erlang&#x27;s pattern matching is useful here, because it allow to easily unpack the values from the file to in memory representation.&#xA;The last clause is where things are actually happening. We select the number of bytes to read, offset is a really misleading term here, it is not the offset from the beginning of the chunk (like most of us would think), it is the amount of bytes remaining in the current chunk.&#xA;We read the data to memory, update the Sp (stream position?) and then call the function that we were passed, to find out if we should read more or stop.&#xA;Now, how are those streams used?&#xA;From reading the code, it looks like there are two streams used in CouchDB. The first is the document stream (called the summary_stream). And the second (actually, the seconds) is a stream for all the binary attachments for a document (a stream per a set of document attachments).&#xA;And with this, we conclude the reading of CouchDB persistence architecture. Next topic, views, and how they are used.</p>
        </article>
        <article id="article-6487">
            <a href="https://ardalis.com/reducing-sql-lookup-tables-and-function-properties-in-nhibernate/" target="_blank">
                <h2 class="title mb-6" id="article-6487">Reducing SQL Lookup Tables and Function Properties in NHibernate</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 05, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the points made in Jeffrey&#x2019;sagile development boot camp last week that struck a chord with me was that many database-centric designs&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-6488">
            <a href="https://ayende.com/blog/3634/windsor-imodelinterceptersselector" target="_blank">
                <h2 class="title mb-6" id="article-6488">Windsor - IModelInterceptersSelector</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 05, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my previous post I introduced the basis of context as an architectural pattern. Now I want to talk about how we can implement that using Windsor and a new extensibility point: IModelInterceptersSelector. The interface is defined as: /// &lt;summary&gt;&#xA;/// Select the appropriate interecptors based on the application specific&#xA;/// business logic&#xA;/// &lt;/summary&gt;&#xA;public interface IModelInterceptorsSelector&#xA;{&#xA;    /// &lt;summary&gt;&#xA;    /// Select the appropriate intereceptor references.&#xA;    /// The intereceptor references aren&#x27;t neccessarily registered in the model.Intereceptors&#xA;    /// &lt;/summary&gt;&#xA;    /// &lt;param name=&quot;model&quot;&gt;The model to select the interceptors for&lt;/param&gt;&#xA;    /// &lt;returns&gt;The intereceptors for this model (in the current context) or a null reference&lt;/returns&gt;&#xA;    /// &lt;remarks&gt;&#xA;    /// If the selector is not interested in modifying the interceptors for this model, it &#xA;    /// should return a null reference and the next selector in line would be executed (or the default&#xA;    /// model.Interceptors).&#xA;    /// If the selector return a non null value, this is the value that is used, and the model.Interectors are ignored, if this&#xA;    /// is not the desirable behavior, you need to merge your interceptors with the ones in model.Interecptors yourself.&#xA;    /// &lt;/remarks&gt;&#xA;    InterceptorReference[] SelectInterceptors(ComponentModel model);&#xA;&#xA;    /// &lt;summary&gt;&#xA;    /// Determain whatever the specified has interecptors.&#xA;    /// The selector should only return true from this method if it has determained that is&#xA;    /// a model that it would likely add interceptors to.&#xA;    /// &lt;/summary&gt;&#xA;    /// &lt;param name=&quot;model&quot;&gt;The model&lt;/param&gt;&#xA;    /// &lt;returns&gt;Whatever this selector is likely to add intereceptors to the specified model&lt;/returns&gt;&#xA;    bool HasInterceptors(ComponentModel model);&#xA;}&#xA;And registering it in the container is simply:&#xA;&#xA;container.Kernel.ProxyFactory.AddInterceptorSelector(selector);&#xA;Interceptors are the basis of AOP, but traditionally, you didn&#x27;t get a lot of choices in how you compose your interceptors at runtime. Using IModelInterceptersSelector make it extremely easy to modify the selection of interceptors based on relevant business logic. &#xA;Let us take the following example. We have a warehouse service that we want to add caching to. However, we can&#x27;t use the cache in the request comes from the fulfillment service. First, we define the caching interceptor, then, we define the logic that controls adding or removing it.&#xA;public class WarehouseCachingInterceptorSelector : IModelInterceptorsSelector&#xA;{&#xA;    public InterceptorReference[] SelectInterceptors(ComponentModel model)&#xA;    {&#xA;        if(model.Service!=typeof(IWarehouse))&#xA;            return null;&#xA;        if(Origin.IsFromFulfillment)&#xA;            return null;&#xA;        return new InterceptorReference[]{new InterceptorReference(typeof(WarehouseCachingInterceptor)), };&#xA;    }&#xA;&#xA;    public bool HasInterceptors(ComponentModel model)&#xA;    {&#xA;        return model.Service == typeof (IWarehouse);&#xA;    }&#xA;}&#xA;And now we get caching for everything except for fulfillment. And we get this in a clean and very easy to understand way. :-D</p>
        </article>
        <article id="article-6489">
            <a href="https://ayende.com/blog/3633/windsor-ihandlerselector" target="_blank">
                <h2 class="title mb-6" id="article-6489">Windsor - IHandlerSelector</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 05, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my previous post I introduced the basis of context as an architectural pattern. Now I want to talk about how we can implement that using Windsor and a new extensibility point: IHandlerSelector. The interface is defined as: /// &lt;summary&gt;&#xA;/// Implementors of this interface allow to extend the way the container perform&#xA;/// component resolution based on some application specific business logic.&#xA;/// &lt;/summary&gt;&#xA;/// &lt;remarks&gt;&#xA;/// This is the sibling interface to &lt;seealso cref=&quot;ISubDependencyResolver&quot;/&gt;.&#xA;/// This is dealing strictly with root components, while the &lt;seealso cref=&quot;ISubDependencyResolver&quot;/&gt; is dealing with&#xA;/// dependent components.&#xA;/// &lt;/remarks&gt;&#xA;public interface IHandlerSelector&#xA;{&#xA;    /// &lt;summary&gt;&#xA;    /// Whatever the selector has an opinion about resolving a component with the &#xA;    /// specified service and key.&#xA;    /// &lt;/summary&gt;&#xA;    /// &lt;param name=&quot;key&quot;&gt;The service key - can be null&lt;/param&gt;&#xA;    /// &lt;param name=&quot;service&quot;&gt;The service interface that we want to resolve&lt;/param&gt;&#xA;    bool HasOpinionAbout(string key, Type service);&#xA;&#xA;    /// &lt;summary&gt;&#xA;    /// Select the appropriate handler from the list of defined handlers.&#xA;    /// The returned handler should be a member from the &lt;paramref name=&quot;handlers&quot;/&gt; array.&#xA;    /// &lt;/summary&gt;&#xA;    /// &lt;param name=&quot;key&quot;&gt;The service key - can be null&lt;/param&gt;&#xA;    /// &lt;param name=&quot;service&quot;&gt;The service interface that we want to resolve&lt;/param&gt;&#xA;    /// &lt;param name=&quot;handlers&quot;&gt;The defined handlers&lt;/param&gt;&#xA;    /// &lt;returns&gt;The selected handler, or null&lt;/returns&gt;&#xA;    IHandler SelectHandler(string key, Type service, IHandler[] handlers);&#xA;}&#xA;And registering it in the container is simply:&#xA;&#xA;container.Kernel.AddHandlerSelector(selector);&#xA;A handler selector is asked if it wants to express an opinion on a particular component resolution, based on key (optional) and type. Assuming we say yes, we are called to select the appropriate handler from all the registered handlers that can satisfy that request.&#xA;Let us say that we want to recover from the database being down by serving an implementation that reads from only the cache, we can implement it thusly:&#xA;public class DataAccessHandlerSelector : IHandlerSelector&#xA;{&#xA;&#x9;bool databaseIsDown = false;&#xA;&#xA;&#x9;public DataAccessHandlerSelector()&#xA;&#x9;{&#xA;&#x9;&#x9;DatabaseMonitor.OnChangedState &#x2B;= &#xA;&#x9;&#x9;&#x9;state =&gt; databaseIsDown = state == DatabaseState.Down;&#xA;&#x9;}&#xA;&#xA;&#x9;public bool HasOpinionAbout(string key, Type service)&#xA;&#x9;{&#xA;&#x9;&#x9;return databaseIsDown &amp;&amp; service == typeof(IRepository);&#xA;&#x9;}&#xA;&#xA;&#x9;public IHandler SelectHandler(string key, Type service, IHandler[] handlers)&#xA;&#x9;{&#xA;&#x9;&#x9;return handlers.Where(x=&gt;x.ComponentModel.Implementation == typeof(CacheOnlyRepository)).First();&#xA;   &#x9;}&#xA;&#xA;}&#xA;Now we automatically replace, based on our own logic and the current context what type of component the container should resolve.&#xA;I am giving the example of detecting infrastructure change, but as important, and as interesting, is the ability to easily use this in order to select services in a multi tenant environment. We can use this approach to perform service overrides all over the place in a way that is natural, easy and extremely powerful.&#xA;Have fun...</p>
        </article>
        <article id="article-6490">
            <a href="https://ayende.com/blog/3632/components-implementations-and-contextual-decisions" target="_blank">
                <h2 class="title mb-6" id="article-6490">Components, Implementations and Contextual Decisions</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: October 05, 2008
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I am a big believer in using context in order to drive a system. What do I mean by that?   Note, I am going to talk about the problem in general, and its solution implementation using Windsor. The example is fictitious and is here to represent the problem in a way that allow me to talk about it in isolation, it doesn&#x27;t necessarily represent good design. It seems like just about all the applications that I had to deal with recently had to have the notion of system variability. Now, let us make it clear. System variability is a fancy name for the if statement. The problem with the if statement is that when you have a lot of them, it gets pretty tricky to understand what is going on with the system. That is why a common refactoring is replace conditional with polymorphism.  What I am usually talking about is &quot;when we are in this condition, we should do X, otherwise, we should do Y&quot;. Let us take the simple idea of a warehouse service. If we are making a call from the web site, it is okay to return data that may not be accurate to the second. If we are calling from the fulfillment service, we need accurate, up to date results. A simple way of handling this is: public bool ItemIsPhysicallyOnTheShelve(Guid id)&#xA;{&#xA;&#x9;if(Origin == Originators.Website)//can use caching&#xA;&#x9;{&#xA;&#x9;&#x9;var result = Cache.Get&lt;bool?&gt;(&quot;item-on-shelve-&quot; &#x2B; id)&#xA;&#x9;&#x9;if(result.HasValue)&#xA;&#x9;&#x9;&#x9;return result.Value;&#xA;&#x9;}&#xA;&#x9;// actual work and putting in cache&#xA;}&#xA;A more interesting example might be different business rules for making order authorization, based on whatever we have a strategic customer or not. In both cases, we have some context for the operation that modify the way that we deal with this operation.&#xA;public bool IsValid(Order order, ValidationSummary summary)&#xA;{&#xA;&#x9;IRule[] rules = CurrentCustomer.IsStrategic ?&#xA;&#x9;&#x9;strategicCutomerRules : normalCustomerRules;&#xA;&#x9;foreach(IRule rule in rules)&#xA;&#x9;{&#xA;&#x9;&#x9;rule.Validate(order, summary);&#xA;&#x9;}&#xA;&#x9;return summary.HasErrors;&#xA;}&#xA;One way of dealing with that is as you see in the code samples, get the state from somewhere and make decisions based on that. Another, more advance option is to create:&#xA;&#xA;IWarehouseService&#xA;DefaultWarehouseService&#xA;CachingWarehouseServiceDecorator&#xA;And because decorators are really annoying, we will use AOP to deal with it by creating a caching interceptor.&#xA;Now the issue is mere configuration, I can deal with that by flipping bits in the container configuration. The second example can be solved by creating two components with different rule sets and using that. The problem is that this remove the coding issues, but it creates a more subtle and much harder to deal with problems.&#xA;If I rely on the container configuration alone, I suddenly have logic there. Important business logic. That is not a good idea, I think. Especially since this means that at some point my code has to make an explicit decision about what component to use, and that breaks the infrastructure independence rule.&#xA;What this boil down to is that now I have to manage a lot of the complexity in the application using the container configuration and tie the working of the system into it. That works if the number of variables that I have to juggle is small, but if I have a lot of axes (plural: axis)&#xA0; that are orthogonal to one another, it is getting complex very fast.&#xA;My solution for that problem is to define a service and its context as a cohesive unit. That is, the concept of a service contains its interface, all of its implementations and the business logic required to select which implementation (and configuration) to choose for a given context.&#xA;In the warehouse example above, what we will have is:&#xA;&#xA;IWarehouseService&#xA;DefainltWarehouseService&#xA;WarehouseCachingInterceptor&#xA;WarehouseInterceptorsSelector&#xA;Now all of those are part of the same service. The last one is where we isolate the actual decision about what type of implementation we should get. In this case, we use Windsor&#x27;s IModelInterecptorsSelector to add additional, context bound, interceptors to the service.&#xA;But that is just from the interceptors side, what about the selection of the appropriate rules? We can handle that using ISubDependencyResolver, where we can decide how we want to filter the rules that goes into IWarehouseService based on the context. For that matter, we might have a completely different warehouse implementations, VirtualWarehouseService and PhysicalWarehouseService. And we need to select between them based on some business criteria. We handle that using IHanlderSelector, that make the decision which component to create.&#xA;Again, IHandlerSelector, IModelInterceptorsSelector and ISubDependencyResolvers are all implementations of Windsor extensibility mechanisms (my next two posts will cover them in details) that allows us to make it aware of the context that we have in the application.&#xA;The purpose of the explicit notion of context is to allow us to deal with the variability in the application in an explicit manner. And that, in turn means that we get much better separation of concerns.</p>
        </article>
        <div class="button flex justify-between">
            <a href="648.html"><span class="back arrow"></span></a>

            <a href="650.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>