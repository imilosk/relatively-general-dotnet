
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 158 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-1571">
            <a href="https://ayende.com/blog/189025-A/researching-a-disk-based-hash-table" target="_blank">
                <h2 class="title mb-6" id="article-1571">Researching a disk based hash table</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 14, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There is a specific scenario that I run into that could be really helped by an O(1) lookup cost on a disk persistent data structure. Voron, our storage engine library, is built on top of a whole big pile of B&#x2B;Trees, which has an O(logN) lookup cost. I could use that, but I wanted to see if we could do better. The natural thing to do when you hear about O(1) costs is to go fetch the nearest hash table, so I spent some time thinking about how to build a hash table that would be persisted to disk. My needs are relatively simple, I believe:O(1) lookup (at least in the common case).&#xA;Able to support greater than memory size.&#xA;Mutable (writes &amp; deletes)&#xA;Keys and values are limited to int64.It doesn&#x2019;t sound hard, right?But when I started thinking about it, I run into a pretty hard limit. If the size of the data is greater than memory, then we have to take into account data access costs. A simple approach here would be to allocate a section in the file for the hash table and use a hash to get to the right location in the file. That works, if you don&#x2019;t need to support mutations. But when you do, you run into a big problem. At some point, the load factor of the hash table is going to increase to the point where you need to regrow it. At that point, you may need to re-hash the entire thing.Assume that the hash table size at this point is 4 GB, you need to re-hash it to 8GB and you have just 1 GB available. That is going to take some time and be a pretty horrible process all around. That is as far as I got when I considered directly translating in memory hash table to disk based one. I&#x2019;m pretty lucky that I don&#x2019;t have to do that, because there is a wealth of research on the matter. These go back to before I was born, although B&#x2B;Trees predate them by a decade or so. They key here is to use extensible hashing. The Wikipedia article is pretty good, I especially liked the Python code showing how things work there. The original paper on the topic is also quite interesting and is of interest to people who care about the details of how storage engines work.I believe that my next step is going to be playing with some codebases that implement these ideas. I decided to look at how this is done with the DBM family of systems. They are old, some of them are probably direct implementations of the extensible hashing paper, but I&#x2019;m mostly interested in seeing how things fit together at this point. All of that said, I run into a lot of red flags along the way.Modern B-Tree Techniques discuss the issue of B-Trees vs. Hashes Indexes and come to the conclusion that you shouldn&#x2019;t bother. They cover quite a few aspects of this issue, from complexity of implementation to usage scenarios.The Berkley DB documentation states that for anything requiring locality of reference, B-Trees are the way to go. However, for large amount of data, their Hash implementation uses less metadata, so might be better. That said, this doesn&#x2019;t match my expectation for the way the system will behave. Looking at this StackOverflow answer, it seems very likely that if you have a working set that is greater than memory, the hash implementation will hit page faults all the time and the B-Tree implementation will be able to keep at least most of its metadata in memory, benefiting greatly from that.Indeed, we have this interesting quote from Berkley DB as well:Hash access method is appropriate for data sets so large that not even the Btree indexing structures fit into memory. At that point, it&#x27;s better to use the memory for data than for indexing structures. This trade-off made a lot more sense in 1990 when main memory was typically much smaller than today.All in all, this seems like a nice area for me to look into. I&#x2019;ll go and read some code now, and maybe I&#x2019;ll write about it.</p>
        </article>
        <article id="article-1572">
            <a href="https://www.meziantou.net/visual-studio-tips-and-tricks-paste-as-json.htm" target="_blank">
                <h2 class="title mb-6" id="article-1572">Visual Studio Tips and tricks: Paste as JSON</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 13, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you often work with JSON documents, you may have created classes to map the content of the JSON document to a .NET class. Then, Json.NET or the new System.Text.Json allows to serialize a class to a JSON string or to deserialize a JSON string to a .NET class.Writing mapping classes is annoying an</p>
        </article>
        <article id="article-1573">
            <a href="https://www.stevejgordon.co.uk/timezonenotfoundexception-in-alpine-based-docker-images" target="_blank">
                <h2 class="title mb-6" id="article-1573">TimeZoneNotFoundException in Alpine Based Docker Images</h2>
            </a>
            <p class="mb-2">by Steve Gordon</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 12, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post, we&#x2019;re going to explore the cause of a TimeZoneNotFoundException in a .NET Core application, running on .NET Core 3.0 in an Alpine Linux Docker container. TL;DR; The default Alpine Docker image does not include time zone data by default. This causes code which depends on this data to throw exceptions. If you [&#x2026;]</p>
        </article>
        <article id="article-1574">
            <a href="https://ayende.com/blog/188994-C/re-document-level-optimistic-concurrency-in-mongodb" target="_blank">
                <h2 class="title mb-6" id="article-1574">re</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 12, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I run into this blog post talking about how to handle optimistic concurrency in MongoDB and it brought to mind a very fundamental difference in the design philosophy between RavenDB and MongoDB. If you&#x2019;ll read the associated blog post, you&#x2019;ll see guidance on how to build a simple optimistic concurrency using the MongoDB API. It looks like a relatively straightforward thing, but there is a lot of complexity going on here.With RavenDB, we have decided that the responsibility of such tasks is on us, and not our users. Here is how you&#x2019;ll write the same thing in RavenDB:session.Advanced.OptimisticConcurrency = true;And you are done. There are also options to set it globally (for all actions), for a particular session, as shown above or for a particular document or documents in a bigger transaction. About the only thing that we don&#x2019;t handle is retries if the update failed, to allow you to re-run your business logic.The reason I&#x2019;m writing this is actually at the very end of the post:This works just fine if I &quot;remember&quot; to include that Where clause correctly, but there&#x27;s a better way if we want a general solution. For that, I&#x27;d do pretty much what I would have in the Life Beyond Distributed Transactions series - introduce a Repository, Unit of Work, and Identity Map.This is exactly right. It looks trivial to do something like that when you are looking into a trivial scenario, but put it in a real application and the complexity sprouts. For example, try doing the same thing with multiple documents that need to change together. You have to implement quite a lot of code to do so (identity map, unit of work, hopefully not a repository ).With RavenDB, all of that is just there and available for you. No need to do anything, It Just Works.</p>
        </article>
        <article id="article-1575">
            <a href="https://andrewlock.net/ihostingenvironment-vs-ihost-environment-obsolete-types-in-net-core-3/" target="_blank">
                <h2 class="title mb-6" id="article-1575">IHostingEnvironment vs IHostEnvironment - obsolete types in .NET Core 3.0</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 12, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Upgrading to ASP.NET Core 3.0 - Part 2</p>
        </article>
        <article id="article-1576">
            <a href="https://ayende.com/blog/188993-C/vorons-roaring-set-part-ii-implementation" target="_blank">
                <h2 class="title mb-6" id="article-1576">Voron&#x2019;s Roaring Set: Part II&#x2013;Implementation</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 11, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A couple of weeks ago I started to talk about the implementation details of building a persistent data structure in RavenDB. As it turns out, I had some evenings available and I was able to sit down and actually write out the code for it. The current state of things is that a few tests work and the overall structure is in place. I run into some hurdles along the way, which is why I preferred to wait till I have something at hand before writing about it.Please note, I&#x2019;m going to be doing a lot of low level talk here. Mostly about how we allocate space and manage bits and bytes in Voron. If you aren&#x2019;t interested in such details, you can skip all the gory stuff and get to the design details.If you want to go straight for the code, you can find it here. Just note that this version has been created as a proof of concept and hasn&#x2019;t yet been through the same process we usually take our code through.The first thing to understand is what I&#x2019;m trying to write. The reason I need this data structure is for my series about writing search engines. That means that I want to use this to store posting lists. But given my experience with building such systems, I know that there are quite a few different use cases that I need to cover. A posting list is the list of documents matching a term in a search index. Let&#x2019;s consider a few examples, shall we?Email: oren@example.comHobbies: Dogs, Reading, ProgrammingThe above represent fields and values for fields in a full text search index. There are a few things to note. We can usually assume that the Email field will be unique or nearly so. In other words, the number of documents where the Email field will match oren@example.com is going to be one (or very nearly so). This is a very frequent scenario when indexing data and it deserves optimal behavior.The Hobbies field, however, is very different. Quite a few people likes Dogs, for example, so we can assume that we&#x2019;ll have a lot of documents that are matched to this term. That mean that we need to optimize for very large number of matches, the exact opposite of how we need to behave for the Email field.Sometimes, it is easier to understand when looking at the type signature. If I was writing this in memory, I would use:Map&lt;FieldName, Map&lt;Term, Set&lt;DocumentId&gt;&gt; InvertedIndex;That is the conceptual model that we&#x2019;ll be working with here. After implementing the actual data structure, we have the following API:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var emailField = tx.OpenRoaringSet(&quot;Email&quot;);&#xA;        &#xA;        &#xA;          &#xA;          emailField.Set(&quot;oren@example.com&quot;, 1);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var hobbiesField = tx.OpenRoaringSet(&quot;Hobbies&quot;);&#xA;        &#xA;        &#xA;          &#xA;          hobbiesField.Set(&quot;Dogs&quot;, 1);&#xA;        &#xA;        &#xA;          &#xA;          hobbiesField.Set(&quot;Reading&quot;, 1);&#xA;        &#xA;        &#xA;          &#xA;          hobbiesField.Set(&quot;Programming&quot;, 1);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          usage.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Once we have the data stored, we can now query on it. For example, to find all users that like dogs, you&#x2019;ll write:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var hobbiesField = tx.OpenRoaringSet(&quot;Hobbies&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var it = hobbiesField.Iterate(&quot;Dogs&quot;);&#xA;        &#xA;        &#xA;          &#xA;          while (it.MoveNext(out var docId))&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              // match...&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          query.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Actually building realistic queries on top of this is a tedious, but fairly straightforward matter. It will also likely be the topic of another post. For now, I want to focus on how I actually built the implementation of this feature. At this point, Voron features are mostly built on top of&#x2026; Voron features . That is, we don&#x2019;t need to build complex data structure from scratch, but can usually use a fair bit of the underlying infrastructure that we already have. In this case, we need to understand one of the most basic building blocks in Voron: The Tree. This versatile data structure is the core of pretty much everything in Voron. It is a B&#x2B;Tree that can hold arbitrary keys and values, keeping them in sorted order. In particular, the Tree uses a byte string as its key, and its value can be either a raw value or a complex type. Going back to the type signature, the Tree would be:SortedMap&lt;ByteString, (byte[] RawValue, Tree NestedTree, FixedSizeTree NestedFixedSizeTree)&gt; Tree;Note that the value can be a raw value, a nested tree or a fixed size tree (there are other options, but we&#x2019;ll focus on those). A raw value is simple, it is just a buffer that is stored and retrieved.&#xA0; The two nested tree options is just using recursion to its fullest potential. The difference between Tree and FixedSizeTree is one of optimizations. A Tree can use any byte string as its key, but a fixed size tree can only use an int64 for its key. And as you can expect from the name, its values are also fixed in size. That means that it needs less metadata than its Tree sibling and can be somewhat simpler to implement. Voron also has the notion of raw data sections. These allow you to allocate / write to the disk directly and are usually paired with another data structure to manage them. You can think about the raw data section as the malloc() of persistent data structures.I&#x2019;m going over these details because they are important to how I built the underlying data structure. Here are the rules that I had in mind while building this:Optimize for both storage space and computational powerZero managed allocations for readingReduce / eliminate managed allocations for writingDocument ids are int64Handle single use terms (Email)Handle multiple use terms (Hobbies)We&#x2019;ll start from the simple scenario, storing a document id for a particular email address:emailField.Set(&quot;oren@example.com&quot;, 1L);The backing store of the Roaring Set is a Voron Tree, and we&#x2019;ll use the term as the key, and store the document id (1L, in this case) as the value. That is probably the absolutely simplest way to go about building this feature. Except that we are actually wasting space. 1L (long set to one, basically) takes 8 bytes to store data that can be stored in a single byte. That means that we&#x2019;ll waste space, quite a lot of it, in fact.So we aren&#x2019;t going to store the data as raw int64. Instead, we are going to use varints, instead. In this way, a value such as 1L can be stored in a single byte. What happen if we have another value for the same field and term?emailField.Set(&quot;oren@example.com&quot;, 3L);At this point, we&#x2019;ll encode the next value using varint as well, but instead of recording the actual value, we&#x2019;ll record the difference from the previous value. We&#x2019;ll continue to do so until the size of the buffer we need to record the data reach 32 bytes.The idea is that in most cases, we&#x2019;ll have a single value or very few of them. We have a compact way of representing this information, which works quite nicely for small set of values.Here is how you can read such an encoding:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public bool Test(byte* ptr, int size, long valToCheck)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            long last = 0;&#xA;        &#xA;        &#xA;          &#xA;            int pos = 0;&#xA;        &#xA;        &#xA;          &#xA;            while (pos &lt; size)&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                last &#x2B;= ReadVariableSize(ptr, ref pos);&#xA;        &#xA;        &#xA;          &#xA;                if (last == valToCheck)&#xA;        &#xA;        &#xA;          &#xA;                    return true;&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;            return false;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          varint-test.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, there is nothing really interesting going on here. There are implementation details that I&#x2019;m not getting into, such as the fact that we are storing the values sorted (which maximize the delta encoding from keeping just the difference from the previous number), but that doesn&#x2019;t actually matter to the core concept.I mentioned before that this is limited to 32 bytes, right? So what happens when we get beyond that level? This is where things become interesting / complicated.Instead of using a raw value for the values, we will move to a more complex structure. This is suitable when we have enough values to justify the extra effort. The idea here is to make use of Roaring Bitmaps, which is an efficient way to store bit maps. A bit map is simply an array of bits that are either set or cleared. I&#x2019;m using them to hold a set of values. In other words, consider a Set&lt;int64&gt;, where the implementation is using a bitmap to figure out if a value exists or not. Of course, storing such a set using standard bitmaps would be incredibly wasteful in space, but that is what roaring bitmaps are for. I&#x2019;ll let you go to the actual site for a description of them, but you can think about them as a sparse map. You only need to hold the bits that you care about. That said, the way roaring bitmaps are usually used, they are using 8KB ranges. That is, each such range is capable of holding 65,536 bits. However, when looking into how I&#x2019;ll be using this in Voron, I run into an issue.A Voron page is 8KB in size, and we have to allocate some space for the page header, we can&#x2019;t easily store an 8KB value there. I thought about using 4KB, instead, but that just made things awkward. I&#x2019;ll be losing half a page, after all. After some experimentation, I ended up with each roaring set segment using 256 bytes. This is small, but has several advantages for my needs.A Voron page has a 64 bytes header, which means that I can use 8,128 bytes for real data. Using 256 bytes for the roaring segment size, I also need to account for some metadata per segment, so that turns out to be 260 bytes total. That gives me a total of 30 segments that I can squeeze into a single page. I actually have a total of additional 10 bytes that I can use per segment, without impacting the total number of values that can be stored into in a page. A single segment represent the state of the bits with a range of 2048 bits. And there are other advantages to the small size, though. This is planned as a persistent and mutable data structure. Having a smaller segment size means that I have easier time modifying just a single segment. Following the roaring bitmap rules, we have three types of segments:Small (128 or less bits set) &#x2013; stored as an array of int16 (up to 256 bytes) holding the offsets of set bits in the range.Medium (up to 1920 bits set) &#x2013; stored as a bitmap value (taking 256 bytes).Large (more than 1920 bits set) &#x2013; stored as an array of int16 (up to 256 bytes) holding the offsets of cleared bits in the range. Roaring Bitmaps tend to perform much better than the alternative (even though this is the 8KB version).Just having the segments isn&#x2019;t good enough, though. I need to also have a way to search for a segment. After all, the whole idea is that we&#x2019;ll have a sparse data structure. This is done using a Fixed Size Tree. Each segment gets a key, made up of the segment range (54 bits) and the number of set bits in the range (10 bits). Together, they make up the key that we can use to look up a particular segment. The value for the Fixed Size Tree is the position of the actual segment in the data file.You can think about this as:SortedMap&lt;SegmentKey(Range: 54 bits, NumOfSetBits: 10 bits), FileOffset&gt; Segments;In other words, the total metadata cost for a segment is actually 270 bytes (counting also currently unused space) for the segment as well as 16 bytes for the key/value in the fixed size tree. In other words, to hold about 10 million values, we&#x2019;ll need roughly 2.8 MB or so. On the other if we stored the offsets directly as int64, 10 million values would be around 76MB. The numbers aren&#x2019;t quite that bad, because for roaring bitmap we pay per segment, while for a simple array of int64, we&#x2019;ll pay for each set value.I think that this post has gone on long enough. You can look at the code, which has all the details (and I would love to get feedback / questions on this), but I now need to face another challenge in this road. Tying all of this together so we can create a useful search API. Just having the code I&#x2019;ve shown at the top of this post is not sufficient, we need to be able to provide more metadata around tying values together. I&#x2019;ll get to that in another post.</p>
        </article>
        <article id="article-1577">
            <a href="https://ayende.com/blog/188961-B/upsert-patching-in-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-1577">Upsert patching in RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 07, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Trevor asked a really interesting question in the mailing list. Assume that we have the following model:And what we want to do is to be able to add a note to a book. The API looks like so:public void SubmitNote(string isbn, string note);The requirements are simple: There is one book per ISBNNotes on the book shouldn&#x2019;t be duplicatedThe Book document may be large, and we don&#x2019;t actually care about it, just want to add itIf there is a note on an non existent book, we need to create itThe key observation here is that Trevor doesn&#x2019;t want to load the document, modify it and save it back. What he is looking for is a way to send the change to the database server and have it happen there. Luckily, RavenDB has the right set of features for this, the Patching API. Here is how you&#x2019;ll write the code to update the document without having to load it:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          string note = &quot;Great book&quot;;&#xA;        &#xA;        &#xA;          &#xA;          using (var s = store.OpenSession())&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              s.Advanced.Patch&lt;Book, Note&gt;(&quot;978-1719946216&quot;, &#xA;        &#xA;        &#xA;          &#xA;                  x=&gt;x.Notes, notes=&gt;notes.Add(new Note&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      Text = note&#xA;        &#xA;        &#xA;          &#xA;                  }));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;             s.SaveChanges();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          patch1.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;We can send the update to the server, have the change happen there, with no need to load and save the document. And we get strongly typed API and compiler validation, joy all around.This is great, but it misses something. If we&#x2019;ll run this code twice, we&#x2019;ll have a duplicated comment, which is something that we don&#x2019;t want to do. Luckily, we have more options. The strongly typed API we just wrote is sitting on top of the actual patch API, which is much more powerful. Let&#x2019;s see how we can tackle this requirement, shall we?&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          using (var s = store.OpenSession())&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              string note = &quot;Great book&quot;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              s.Advanced.Defer(new PatchCommandData(&quot;978-1719946216&quot;, null, &#xA;        &#xA;        &#xA;          &#xA;                 new PatchRequest&#xA;        &#xA;        &#xA;          &#xA;                 {&#xA;        &#xA;        &#xA;          &#xA;                     Script = @&quot;&#xA;        &#xA;        &#xA;          &#xA;          if(this.Notes.some( n =&gt; n.Text === $note))&#xA;        &#xA;        &#xA;          &#xA;            return;&#xA;        &#xA;        &#xA;          &#xA;          this.Notes.push({Text: $note});&#xA;        &#xA;        &#xA;          &#xA;          &quot;,&#xA;        &#xA;        &#xA;          &#xA;                     Values = { [&quot;note&quot;] = note }&#xA;        &#xA;        &#xA;          &#xA;                 }, null));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;             s.SaveChanges();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          patch2.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Now, we send a script to the server, which will execute it. If the note already exists, that means that we will not modify the document. So we got that out of the way. But we are still missing a piece of the puzzle, as you can probably see from the title of the post. What happens if the Book document does not exists?Luckily, we thought about this issue and RavenDB is ready to help here as well. When you send a patch request to RavenDB, you can send a single script, or two. The second one will be executed if the document does not exists, like so:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          using (var s = store.OpenSession())&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              string note = &quot;Great book&quot;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              s.Advanced.Defer(new PatchCommandData(&quot;978-1719946216&quot;, null,&#xA;        &#xA;        &#xA;          &#xA;                 patch: new PatchRequest&#xA;        &#xA;        &#xA;          &#xA;                 {&#xA;        &#xA;        &#xA;          &#xA;                     Script = @&quot;&#xA;        &#xA;        &#xA;          &#xA;          if(this.Notes.some( n =&gt; n.Text === $note))&#xA;        &#xA;        &#xA;          &#xA;              return;&#xA;        &#xA;        &#xA;          &#xA;          this.Notes.push({Text: $note});&#xA;        &#xA;        &#xA;          &#xA;          &quot;,&#xA;        &#xA;        &#xA;          &#xA;                    Values = { [&quot;note&quot;] = note&#xA;        &#xA;        &#xA;          &#xA;                 },&#xA;        &#xA;        &#xA;          &#xA;                 patchIfMissing: new PatchRequest&#xA;        &#xA;        &#xA;          &#xA;                 {&#xA;        &#xA;        &#xA;          &#xA;                     Script = @&quot;&#xA;        &#xA;        &#xA;          &#xA;          this.Notes = [{Text: $note}];&#xA;        &#xA;        &#xA;          &#xA;          this[&#x27;@metadata&#x27;] = {&#x27;@collection&#x27;: &#x27;Books&#x27;};&#xA;        &#xA;        &#xA;          &#xA;          &quot;,&#xA;        &#xA;        &#xA;          &#xA;                     Values = { [&quot;note&quot;] = note&#xA;        &#xA;        &#xA;          &#xA;                 }));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              s.SaveChanges();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          patch3.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;If the document exists, we will run the patch script and modify the document. If the document does not exists, we will create an empty document and then run the patchIfMissing script to populate it. The code above handles all of the stated requirements, and we can call it a day.But as long as we are here, let&#x2019;s add another requirement. The only information we have from the SubmitNote(isbn, note) call is the ISBN of the book. Presumably we want to do things to this book, for example, figure out what the title is. Using this mechanism, how do we do this? When we return from the SaveChanges call, there is no way to tell if the document was newly created or already there?The answer here is to ask RavenDB to do so. And we can modify our patchIfMissing a bit to do so. Note the changes in that are in the code:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          using (var s = store.OpenSession())&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              string note = &quot;Great book&quot;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              s.Advanced.Patch&lt;Book, Note&gt;(&quot;978-1719946216&quot;,&#xA;        &#xA;        &#xA;          &#xA;                  x =&gt; x.Notes, notes =&gt; notes.Add(new Note&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      Text = note&#xA;        &#xA;        &#xA;          &#xA;                  }));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              s.Advanced.Defer(new PatchCommandData(&quot;978-1719946216&quot;, null,&#xA;        &#xA;        &#xA;          &#xA;                 patch: new PatchRequest&#xA;        &#xA;        &#xA;          &#xA;                 {&#xA;        &#xA;        &#xA;          &#xA;                     Script = @&quot;&#xA;        &#xA;        &#xA;          &#xA;          if(this.Notes.some( n =&gt; n.Text === $note))&#xA;        &#xA;        &#xA;          &#xA;              return;&#xA;        &#xA;        &#xA;          &#xA;          this.Notes.push({Text: $note});&#xA;        &#xA;        &#xA;          &#xA;          &quot;,&#xA;        &#xA;        &#xA;          &#xA;                     Values =&#xA;        &#xA;        &#xA;          &#xA;                     {&#xA;        &#xA;        &#xA;          &#xA;                         [&quot;note&quot;] = &quot;Great book!!&quot;&#xA;        &#xA;        &#xA;          &#xA;                     }&#xA;        &#xA;        &#xA;          &#xA;                 },&#xA;        &#xA;        &#xA;          &#xA;                 patchIfMissing: new PatchRequest&#xA;        &#xA;        &#xA;          &#xA;                 {&#xA;        &#xA;        &#xA;          &#xA;                     Script = @&quot;&#xA;        &#xA;        &#xA;          &#xA;          this.Notes = [{Text: $note}];&#xA;        &#xA;        &#xA;          &#xA;          this[&#x27;@metadata&#x27;] = {&#x27;@collection&#x27;: &#x27;Books&#x27;};&#xA;        &#xA;        &#xA;          &#xA;          put(&#x27;tasks/update-book-data/&#x27;&#x2B;$isbn, {&#xA;        &#xA;        &#xA;          &#xA;              &#x27;Task&#x27;: &#x27;Found out more about this book&#x27;,&#xA;        &#xA;        &#xA;          &#xA;              &#x27;ISBN&#x27;: $isbn,&#xA;        &#xA;        &#xA;          &#xA;              &#x27;@metadata&#x27;: { &#x27;@collection&#x27;: &#x27;Tasks&#x27; }&#xA;        &#xA;        &#xA;          &#xA;          });&#xA;        &#xA;        &#xA;          &#xA;          &quot;,&#xA;        &#xA;        &#xA;          &#xA;                     Values =&#xA;        &#xA;        &#xA;          &#xA;                     {&#xA;        &#xA;        &#xA;          &#xA;                         [&quot;note&quot;] = &quot;Great book!&quot;,&#xA;        &#xA;        &#xA;          &#xA;                         [&quot;isbn&quot;] = &quot;978-1719946216&quot;&#xA;        &#xA;        &#xA;          &#xA;                     }&#xA;        &#xA;        &#xA;          &#xA;                 }));&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              s.SaveChanges();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          patch4.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;If we need to execute the missing patch code, we&#x2019;ll create the new document and in the same transaction, we&#x2019;ll also create a task document to fetch additional information about this book. Your code will usually subscribe to the Tasks collection and execute additional work as a result of that.And this is it, everything we need to, in a single operation. Note that in many cases, you don&#x2019;t actually have a single such call, though. Let&#x2019;s say that you are getting a batch of work all at once. Your API will actually look like:public void SumbitNotes(Dictionary&lt;string, string&gt; isbnToNotes);In this case, we are going to execute the code above for all the items that we got in the call, but call SaveChanges once. All of them would operate as a single transaction and a single round trip to the server.</p>
        </article>
        <article id="article-1578">
            <a href="https://ayende.com/blog/188931-C/using-ravendb-in-php" target="_blank">
                <h2 class="title mb-6" id="article-1578">Using RavenDB in PHP</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 06, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After build an R client for RavenDB, I decided to see what it would take to build a basic RavenDB client for PHP in the same manner. It turned out to be fairly simple, and you can find the relevant code here.Here are some basic CRUD operations:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          &lt;?php&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $rvn = new RavenDB(&quot;http://live-test.ravendb.net&quot;, &quot;Demo&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $new_user = array(&#xA;        &#xA;        &#xA;          &#xA;              &#x27;User&#x27; =&gt; &#x27;Oren&#x27;, &#xA;        &#xA;        &#xA;          &#xA;              &#x27;Emails&#x27; =&gt; array(&quot;ayende@ayende.com&quot;, &quot;oren@ravendb.net&quot;), &#xA;        &#xA;        &#xA;          &#xA;              &quot;@metadata&quot; =&gt; array(&quot;@collection&quot; =&gt; &quot;Users&quot;)&#xA;        &#xA;        &#xA;          &#xA;          );&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $rvn-&gt;put(&quot;users/ayende&quot;, $new_user);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $name = $rvn-&gt;get(&quot;users/ayende&quot;)-&gt;{&#x27;User&#x27;};&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          echo $name . &quot;\n&quot;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $users = $rvn-&gt;query(&#xA;        &#xA;        &#xA;          &#xA;            &quot;from Users where Emails in (\$emails)&quot;, &#xA;        &#xA;        &#xA;          &#xA;            array(&quot;emails&quot; =&gt; array(&quot;oren@ravendb.net&quot;, &quot;ayende@ravendb.cloud&quot;))&#xA;        &#xA;        &#xA;          &#xA;          );&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          $rvn-&gt;del(&quot;users/ayende&quot;);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var_dump($users);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          ?&gt;&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          crud.php&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, the API is quite straightforward to use. It isn&#x2019;t the full blown API that we usually provide, but it is more than enough to get you going.Incidentally, we also published our REST API documentation recently, so you can see how you expand this code to do even more for you.</p>
        </article>
        <article id="article-1579">
            <a href="https://www.meziantou.net/visual-studio-tips-and-tricks-open-the-documentation-of-a-symbol.htm" target="_blank">
                <h2 class="title mb-6" id="article-1579">Visual Studio Tips and tricks: Open the documentation of a symbol</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 06, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">When you write code, you sometimes need to read the documentation of a method or a class to understand how it works. The IntelliSense already provides useful information, but the documentation can contain useful remarks or links that you may need. You can open your favorite search engine and search</p>
        </article>
        <article id="article-1580">
            <a href="https://ayende.com/blog/188930-C/the-futility-of-using-ravendb-as-an-in-memory-database" target="_blank">
                <h2 class="title mb-6" id="article-1580">The futility of using RavenDB as an in memory database</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 05, 2019
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was reminded recently that the RavenDB documentation aren&#x2019;t putting enough emphasis on the fact that RavenDB can run as an in memory database.&#xA0; In fact, topologies that other databases seem to think are fancy are trivial in RavenDB. You can run your cluster in a mixed mode, with a couple of nodes that are persistent and write to disk, but having other nodes that are using pure in memory storage. Combined with RavenDB&#x2019;s routing capabilities, you&#x2019;ll end up with a cluster where the nodes you&#x2019;ll usually interact with are going to be purely in memory, but with the backend pushing data to other nodes that are persisting to disk. On the face of it, you have both the speed of in memory database with the persistence that your data craves.&#xA;So why aren&#x2019;t we making a whole lot of a big deal out of this? This is a nice feature, and surely it can be used as a competitive advantage, no?&#xA;The problem is that it isn&#x2019;t going to play out as you would expect it to be.&#xA;Consider the case where you dataset* is larger than memory. In that case, you are going to have to go to disk anyway. At this point, it doesn&#x2019;t really matter whatever you are swapping to the page file or reading from a data file. On the other hand, if the dataset you work with can fit entirely in memory, you are going to see significant speedups. Except that with RavenDB, you won&#x2019;t.&#xA;That sound bad, so let me try to express this better. If you dataset can fit into memory, RavenDB is already going to be serving it completely from memory. You don&#x2019;t need to do anything to avoid disk I/O, by default, RavenDB is already going to do that for you. And if you dataset is larger than memory, RavenDB is going to ensure that we make only the minimum amount of I/O in order to serve your requests.&#xA;In other words, because of the way RavenDB is architected, you aren&#x2019;t going to see any major advantages by going the pure in memory route. We are already providing most of them out of the box, while still maintain ACID guarantees as well as on disk persistence.&#xA;There are some advantages of running in memory only mode. Transactions are somewhat faster, but we have spent a lot of time optimizing our transactional hot path, you can get to hundreds of thousands of individual writes on a single node while maintaining full persistence and ACID compliance. In the vast majority of the cases, you simply don&#x2019;t need the additional boost. It costs too much on to give up persistence.&#xA;So the answer is that you can run RavenDB purely in memory, and you can also do that in mixed mode cluster, but for the most part, it just doesn&#x2019;t give you enough bang for the buck. You are going to be as fast for reads and almost as fast for writes (almost certainly faster than what you actually need) anyway.&#xA;* Well, working set, at least, but I&#x2019;m being fast and loose with the terms here.</p>
        </article>
        <div class="button flex justify-between">
            <a href="157.html"><span class="back arrow"></span></a>

            <a href="159.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>