
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 112 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-1111">
            <a href="https://ayende.com/blog/194369-B/open-for-extension-closed-for-modification-as-an-architectural-pattern" target="_blank">
                <h2 class="title mb-6" id="article-1111">Open for extension, closed for modification as an architectural pattern</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 30, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The Open Closed Principle is part of the SOLID principles. It isn&#x2019;t new or anything exciting, but I wanted to discuss this today in the context of using that not as a code artifact but as part of your overall architecture.The Open Closed Principle states that the code should be opened for extension, but closed for modification. That is a fancy way to say that you should spend most of your time writing new code, not modifying old code. Old code is something that is known to be working, it is stable (hopefully), but messing around with old code can break that. Adding new code, on the other hand, carry far less risk. You may break the new things, but the old stuff will continue to work. There is also another aspect to this, to successfully add new code to a project, you should have a structure that support that. In other words, you typically have very small core of functionality and then the entire system is built on top of this.&#xA0; Probably the best example of systems that follow the Open Closed Principle is the vast majority of PHP applications. Hold up,I can hear you say. Did you just called out PHP as an architectural best practice? Indeed I did, and more than that, the more basic the PHP application in question, the closer it is to the ideal of Open Closed Principle.Consider how you&#x2019;ll typically add a feature to a PHP application. You&#x2019;ll create a new script file and write the functionality there. You might need to add links to that (or you already have this happen automatically), but that is about it. You aren&#x2019;t modifying existing code, you are adding new one. The rest of the system just know how to respond to that and handle that appropriately. Your shared component might be the site&#x2019;s menu, a site map and the like. Adding a new functionality may occasionally involve adding a link to a new page, but for the most parts, all of those operations are safe, they are isolated and independent from one another.In C#, on the other hand, you can do the same by adding a new class to a project. It isn&#x2019;t at the same level of not even touching anything else, since it all compiles to a single binary, but the situation is roughly the same. That is the Open Closed Principle when it applies to the code inside your application. What happens when you try to apply the same principle to your overall architecture?I think that Terraform is a great example of doing just that. They have a plugin system that they built, which spawns a new process (so completely independent) and then connect to it via gRPC. Adding a new plugin to Terraform doesn&#x2019;t involve modifying any code (you do have to update some configuration, but even that can be automated away). You can write everything using separate systems, runtime and versions quite easily.If we push the idea a bit further, we&#x2019;ll discover that Open Closed Principle at the architecture level is the Service Oriented Architecture.&#xA0; Note that I explicitly don&#x2019;t count Microservices in this role, because they are usually intermixed (yes, I know they aren&#x2019;t supposed to, I&#x2019;m talking about what is). In those situations, adding a new feature to the system would involve adding a new service. For example, in a banking system, if you want to add a new feature to classify fraudulent transactions, how would you do it?One way is to go to the transaction processing code and write something like:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public void processTransactions(HttpServletRequest request, HttpServletResponse response) {&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;            String src = request.getParameter(&quot;from&quot;);&#xA;        &#xA;        &#xA;          &#xA;            String dst = request.getParameter(&quot;to&quot;);&#xA;        &#xA;        &#xA;          &#xA;            int amountInCents = Integer.parseInt(request.getParameter(&quot;amount&quot;));&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;            /// new code here&#xA;        &#xA;        &#xA;          &#xA;            TransactionProcessingFactory fact = new TransactionProcessingFactory();&#xA;        &#xA;        &#xA;          &#xA;            // will throw if fraud&#xA;        &#xA;        &#xA;          &#xA;            fact.createProcessor().process(new Transaction(src, dst, amountInCents/1.0));&#xA;        &#xA;        &#xA;          &#xA;            // new code here&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            /*&#xA;        &#xA;        &#xA;          &#xA;            ** Rest of the actual functionality&#xA;        &#xA;        &#xA;          &#xA;            **/&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          txn_proc.java&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;That, of course, would mean that you are going to have to modify existing code, that is not a good idea. Welcome to six months of meeting about when you can deploy your changes to the code. On the other hand, applying the Open Closed Principle to the architecture, we won&#x2019;t ever touch the actual system that process transactions. Instead, we&#x2019;ll use a side channel. Transactions will be written to a queue and we&#x2019;ll be able to add listeners to the queue. In such a way, we&#x2019;ll have the ability to add additional processing seamlessly. Another fraud system will just have to listen to the stream of messages and react accordingly.Note that there is a big difference here, however, unlike with modifying the code directly, we can no longer just throw an exception to stop the process. By the time that we process the message, the transaction has already been applied. That requires that we&#x2019;ll build the system in such a way that there are ways to stop transactions after the fact (maybe by actually submitting them to the central bank after a certain amount of time, or releasing them to the system only after all the configured endpoints authorized it).At the architecture level, we are intentionally building something that is initially more complex, because we have to take into account asynchronous operations and work that happens out of band, including work that we couldn&#x2019;t expect. In the context of a bank, that means that we need to provide the mechanisms for future code to intervene. For example, we may not know what we&#x2019;ll want the additional code to do, but we&#x2019;ll have a way to do things like pause a transaction for manual review, add additional fees, raise alerts, etc.&#xA0; Those are the capabilities of the system, and the additional behavior would be policy around building that. There are other things that make this very attractive, you don&#x2019;t have to run everything at the same time, you can independently upgrade different pieces and you have clear lines of demarcation between the different pieces of your system.</p>
        </article>
        <article id="article-1112">
            <a href="https://ayende.com/blog/194337-B/system-threading-tasks-task-isnt-an-execution-unit" target="_blank">
                <h2 class="title mb-6" id="article-1112">System.Threading.Tasks.Task isn&#x2019;t an execution unit</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 29, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">From a conceptual model, a thread and a task are very similar. That is very much by design, since the Task is meant to allow you to work with asynchronous code while maintaining the illusion that you are running in a sequential manner. It is tempting to think about this in terms of the Task actually executing the work, but that isn&#x2019;t actually the case.The Task doesn&#x2019;t represent the execution of whatever asynchronous process is running, the Task represent a ticket that will be punched when the asynchronous process is done. Consider the case of going to a restaurant and asking for a table, if there isn&#x2019;t an available table, you cannot be seated. What the restaurant will do is hand you a pager that will buzz when the table is ready. In the same sense, a Task is just such a token. The restaurant pager doesn&#x2019;t means that someone is actively clearing a table for you. It is just something that will buzz when a table is ready.A code sample may make things clearer:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public class Restaurant &#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              private int _occupancy;&#xA;        &#xA;        &#xA;          &#xA;              private List&lt;(TaskCompletionSource&lt;object&gt;, int)&gt; _waiters = new List&lt;(TaskCompletionSource&lt;object&gt;, int)&gt;();&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;              public Task GetTable(int numberOfDiners)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  lock (this)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      if(_occupancy&#x2B; numberOfDiners &lt; 60)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          _occupancy &#x2B;= numberOfDiners;&#xA;        &#xA;        &#xA;          &#xA;                          return Task.CompletedTask;&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      var tcs = new TaskCompletionSource&lt;object&gt;();&#xA;        &#xA;        &#xA;          &#xA;                      _waiters.Add((tcs, numberOfDiners));&#xA;        &#xA;        &#xA;          &#xA;                      _waiters.Sort((x, y) =&gt; x.Item2.CompareTo(y.Item2));&#xA;        &#xA;        &#xA;          &#xA;                      return tcs.Task;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#x200B;&#xA;        &#xA;        &#xA;          &#xA;              public void ReleaseTable(int numberOfDiners)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  lock (this)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      _occupancy -= numberOfDiners;&#xA;        &#xA;        &#xA;          &#xA;                      while (_waiters.Count &gt; 0)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          if(_waiters[0].Item2 &#x2B; _occupancy &gt; 60)&#xA;        &#xA;        &#xA;          &#xA;                              break;&#xA;        &#xA;        &#xA;          &#xA;                          var tcs = _waiters[0].Item1;&#xA;        &#xA;        &#xA;          &#xA;                          _occupancy &#x2B;= _waiters[0].Item2;&#xA;        &#xA;        &#xA;          &#xA;                          _waiters.RemoveAt(0);&#xA;        &#xA;        &#xA;          &#xA;                          tcs.SetResult(null);&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#x200B;&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          Restaurant.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;In this case, we are manually coordinating the Task using its completion source and you can see that the Task instance that was handed when trying to get a table doesn&#x2019;t actually start anything. It is simply waiting to be raised when called.That is an important aspect of how System.Threading.Tasks.Task works, because it is usually in contrast to the mental model in our head.</p>
        </article>
        <article id="article-1113">
            <a href="https://www.stevejgordon.co.uk/how-does-the-stringbuilder-work-in-net-part-3-how-appending-works-and-the-stringbuilder-expands" target="_blank">
                <h2 class="title mb-6" id="article-1113">How Does the StringBuilder Work in .NET? (Part 3)</h2>
            </a>
            <p class="mb-2">by Steve Gordon</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 28, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Part Three:&#xA0; How Appending Works and the StringBuilder Expands So far in this series, we&#x2019;ve learned when we should consider using StringBuilder in our code and learned about the memory overhead of using a StringBuilder. It&#x2019;s now time to learn how the StringBuilder can &#x201C;expand&#x201D; its capacity and support appending string data efficiently. As with [&#x2026;]</p>
        </article>
        <article id="article-1114">
            <a href="https://ayende.com/blog/194305-B/architecture-foresight-put-a-queue-on-that" target="_blank">
                <h2 class="title mb-6" id="article-1114">Architecture foresight: Put a queue on that</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 28, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you build any kind of non trivial system, one of the absolutely best things that you can do for the long term health of your system is to move all significant processing to sit behind a queue.&#xA0; That is one of those things that is going to pay massive dividends down the line as your system grows. Basically, any time that you want to do something that isn&#x2019;t &#x201C;pull data and show it to the user&#x201D; or &#x201C;store the data immediately&#x201D;, throwing a queue at the problem is going to make things easier in the long run.Yes, this is a bold statement, and I&#x2019;m sure that you can see that this may be abused. Nevertheless, if you&#x2019;ll follow this one rule, even if you misuse it, you are likely going to be better off than if you don&#x2019;t. I should probably explain.When I&#x2019;m talking about using a queue, I&#x2019;m talking about moving actual processing of an operation from the request handler (controller / action / web sever ) to popping a message from a queue and processing that. The actual queue implementation (SQS, Kafka, MSMQ, ring buffer) doesn&#x2019;t actually matter. It also doesn&#x2019;t matter if you are writing to the queue in the same process and machine or a distributed system. What matter is that you can created a break in the system between three very important aspects of command processing:Accepting a request.Processing the request.Sending the result of the request back.A system without a queue will do all of that inline, in this manner:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          @app.route(&#x27;/purchase-policy&#x27;)&#xA;        &#xA;        &#xA;          &#xA;          def purchase_policy():&#xA;        &#xA;        &#xA;          &#xA;              user_id = request.args.get(&quot;user_id&quot;)&#xA;        &#xA;        &#xA;          &#xA;              # load the user&#x27;s details&#xA;        &#xA;        &#xA;          &#xA;              # process the policy, evaluate terms&#xA;        &#xA;        &#xA;          &#xA;              return &quot;Thank you for your purchase&quot;, 201&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          inline.py&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;What is the problem here? If the processing of the request is complex or takes some time, you have an inherent clock here. At some point, the client is going to timeout on the request, which lead to things like this:On the other hand, if you put a queue in the middle, this looks like this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          @app.route(&#x27;/purchase-policy&#x27;)&#xA;        &#xA;        &#xA;          &#xA;          def purchase_policy():&#xA;        &#xA;        &#xA;          &#xA;              req_id = uuid.uuidv4()&#xA;        &#xA;        &#xA;          &#xA;              user_id = request.args.get(&quot;user_id&quot;)&#xA;        &#xA;        &#xA;          &#xA;              other_details = ... # get them somehow&#xA;        &#xA;        &#xA;          &#xA;              put_on_queue(req_id, user_id, other_details);&#xA;        &#xA;        &#xA;          &#xA;              return req_id, 202 # accepted, not processed&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;          @app.route(&#x27;/purchase-policy-status&#x27;)&#xA;        &#xA;        &#xA;          &#xA;          def purchase_policy_status():&#xA;        &#xA;        &#xA;          &#xA;            req_id = request.args.get(&quot;req_id&quot;)&#xA;        &#xA;        &#xA;          &#xA;            if load_req(req_id) is None:&#xA;        &#xA;        &#xA;          &#xA;                return &quot;Please wait, processing&quot;, 203 &#xA;        &#xA;        &#xA;          &#xA;             &#xA;        &#xA;        &#xA;          &#xA;             return &quot;Thank you for your purchase&quot;, 201 # created&#xA;        &#xA;        &#xA;          &#xA;            &#xA;        &#xA;        &#xA;          &#xA;          # called somewhere else, not part of the request processing&#xA;        &#xA;        &#xA;          &#xA;          def queue_callback(msg):&#xA;        &#xA;        &#xA;          &#xA;            # load the user&#x27;s details&#xA;        &#xA;        &#xA;          &#xA;            # process the policy, evaluate terms&#xA;        &#xA;        &#xA;          &#xA;            save_data(msg.req_id)&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          queued.py&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Note that there is a separation in the processing of the request and sending the accepted answer to the customer.What is the impact of this change? Well, it is a bit more complex to manage in the user interface. Instead of getting the response for the request immediately, we have to fetch it in a separate operation. I&#x2019;m typically really strict on policing the number of remote calls, why am I advocating for an architectural pattern that requires more remote calls?The answer is that we build, from the first step, the ability of the system to delay processing. The user interface no longer attempts to pretend that the system reacts instantly, and have far more freedom to change what we do behind the scenes.Just putting the operation on a queue gives us the ability to shift the processing, which means that we can:Maintain speedy responses and responsive system to the users.Can easily bridge spikes in the system by having the queue flatten them.Scale up the processing of the operations without needing to do anything in the front end.Go from a local to a distribute mechanism without changing the overall architecture (that holds even if you previously held the queue in memory and processed that with a separate thread). Monitor the size of the queue to get a really good indication about where we are at in terms of load.Gain the ability to push updates to the backend seamlessly.At more advanced levels:Can copy message to an audit log, which gives great debugging abilities.Can retry messages that failed.There are whole patterns of message based operations that are available to you, but the things that I list above are what you get almost for free. The reason that I think you should do that upfront is that your entire system would already be used to that. Your UI (and users&#x2019; expectations) would already be set to handle potential delays. That gives you a far better system down the line. And you can play games on the front end to present the illusion that operations are accepted on the server (in pending status) without compromising the health of the system.In short, for the health of your system, put a queue on that, your future self will thank you later.One final word of warning, this apply to operations, not queries. Don&#x2019;t bother putting queries through the queue unless they are intended to be very long lived / complex ones.</p>
        </article>
        <article id="article-1115">
            <a href="https://enterprisecraftsmanship.com/posts/specification-pattern-always-valid-domain-model/" target="_blank">
                <h2 class="title mb-6" id="article-1115">Specification Pattern vs Always-Valid Domain Model</h2>
            </a>
            <p class="mb-2">by Vladimir Khorikov</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 27, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There&#x2019;s an interesting controversy between two DDD topics: the Specification pattern and the Always-Valid domain model.</p>
        </article>
        <article id="article-1116">
            <a href="https://ayende.com/blog/194274-B/responsibility-abdication-the-path-to-create-flexible-business-system" target="_blank">
                <h2 class="title mb-6" id="article-1116">Responsibility Abdication: The path to create flexible business system</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 27, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I had a long conversation with a dev team that are building a non trivial business system. One of the chief problems that they have to deal with is that the &#x201C;business logic&#x201D; that they are asked to work with is extremely mutable, situation dependent and changes frequently. That isn&#x2019;t a new compliant, of course, but given that I have run into this in the past, I can deeply emphasize. The key issue is that the business rules (I refuse to call it logic) are in a constant state of flux. Trying to encode them into the software itself leads to a great deal of mess in both the code and architecture.For example, consider the field of insurance. There are certain aspects of the insurance field that are pretty much fixed in stone (and codified into law). But there are (many) others that are much more flexible, because they relate to the business of selling insurance rather than the actual insurance itself. Because certain parts of the system cannot change (by law), all the modifications happen in other places, and those places see a lot of churn. A marketing executive came up with a brilliant idea, let&#x2019;s market a health insurance policy for young athletic people. This is the same as the usual young policy, but you get a 5% discount on the monthly premium if you have over 20 days in the month with over 10,000 steps recorded. Conversely, you get penalized with 5% surcharge if you don&#x2019;t have at least 15 days of over 10,000 steps recorded. Please note that this is a real service and not something that I just made up. Consider what such a feature means? We have to build the integration with FitBit, the ability to pull the data in, etc. But what happens next? You can be sure that there are going to be a lot more plans and offers that will use those options. You can envision another offer for a policy that gives discounts for 40&#x2B; who jogs regularly, etc. What does this kind of thing looks like in your code? The typical answer is that this can be one of a few options:Just Say No &#x2013; in some IT organizations, this is just rejected. They don&#x2019;t have the capacity or ability to implement such options, therefor the business won&#x2019;t be able to implement it.Yes man &#x2013; whatever the business wants, the business gets. And if the code gets a little ugly, well, that is life, isn&#x2019;t it? Structured &#x2013; those organizations were able to figure out how to divide the static pieces and the frequently changing parts in such a way that they can ensure long term maintainability of the system.In many cases, organizations start as the 2nd option and turn into the 1st. In the early 2000, cellular phones plans in Israel were expensive. A family plan could cost as much as a mortgage payment. I&#x2019;m not kidding, it was really that bad. One of the cellular companies had an inherent advantage, however. They were able to make new offers and plans so much faster than the companies. Summer Vacation plan for your teenagers &#x2013; speak free after midnight with 50 texts a week.Off hours dedicated phones discounts &#x2013; you can talk to 5 phone numbers between 20:00 &#x2013; 08:00 and on weekends for fixed price.All sort of stuff like that, and that worked. Some people would switch plans on a regular basis, trying to find the optimal option. The reason that this company was able to do that had to do with the manner in which they did billing.What they did was quite amazing, even decades later. Their billing systems aggregated all the usage of a particular plan based and pushed that into a report. Then there was a directory filled with VBScript files that they would run over the report. The VBScripts were responsible for apply the logics for the plans. The fact that they wrote them in VBScript meant that they had a very well defined structure. There was all the backend work that gathered the data, then they applied the policies in the scripts. Making those kind of changes and introducing new policies was easy.If the technique is familiar to you, that is because I talked about this in the past. In fact, I wrote a book about it. But this isn&#x2019;t the time to talk about a book a dozen years old or a story from twenty years ago. Let&#x2019;s talk about how we can apply this today, shall we?For scripting, I&#x2019;m going to use MoonSharp, which is a managed Lua implementation. Lua is a great scripting language, it is quite capable and at the same time usable for people without too much technical knowledge. Among other things, it also offers builtin debugging support, which can be a crucial feature for large scale systems.At any rate, let&#x2019;s consider the following logic:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          if &#xA;        &#xA;        &#xA;          &#xA;              policy.Type == PolicyType.House     and &#xA;        &#xA;        &#xA;          &#xA;              policy.address.country == &#x27;Germany&#x27; and &#xA;        &#xA;        &#xA;          &#xA;              policy.address.zip == &#x27;50374&#x27;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          then&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;              policy.adjust_policy(&#x27;flood risk&#x27;, 50)&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;          end&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          flood_prone_places.lua&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, this script raise the monthly rate for a house insurance policy in a particular location. To execute this code, you&#x2019;ll need something like:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          UserData.RegisterType&lt;Policy&gt;();&#xA;        &#xA;        &#xA;          &#xA;          UserData.RegisterType&lt;Address&gt;();&#xA;        &#xA;        &#xA;          &#xA;          UserData.RegisterType&lt;PolicyType&gt;();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          Script script = new Script();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          script.Globals[&quot;PolicyType&quot;] = UserData.CreateStatic&lt;PolicyType&gt;();&#xA;        &#xA;        &#xA;          &#xA;          script.Globals[&quot;policy&quot;] = policy;&#xA;        &#xA;        &#xA;          &#xA;          script.DoString(scriptCode);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          run_script.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Let&#x2019;s look at a slightly more complex example, implementing the FitBit discount:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          days_with_10K_plus_steps = 0&#xA;        &#xA;        &#xA;          &#xA;          for i, day in ipairs(fitbit.period) do&#xA;        &#xA;        &#xA;          &#xA;            if day.number_of_steps &gt; (10 * 1000) then&#xA;        &#xA;        &#xA;          &#xA;              days_with_10K_plus_steps = days_with_10K_plus_steps &#x2B; 1&#xA;        &#xA;        &#xA;          &#xA;            end&#xA;        &#xA;        &#xA;          &#xA;          end&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          if days_with_10K_plus_steps &gt;= 20 then&#xA;        &#xA;        &#xA;          &#xA;            policy.apply_discount(&#x27;Walked 10K or more for 20&#x2B; days this month&quot;, 0.05) # 5% discount, yeah&#xA;        &#xA;        &#xA;          &#xA;          elseif days_with_10K_plus_steps &lt; 15 then&#xA;        &#xA;        &#xA;          &#xA;            policy.apply_discount(&#x27;Walked 10K or more for less than 15 days this month&quot;, -0.05) # 5% penalty, boo!&#xA;        &#xA;        &#xA;          &#xA;          end&#xA;        &#xA;        &#xA;          &#xA;           &#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          fitbit_discount.lua&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Those are the mechanics of how this works. How you can use MoonSharp to apply arbitrary logic to a policy. As I mentioned, I literally wrote a book about this, discussing many of the details you need to create such a system. Right now, I want to focus on the architecture impact.The kind of code we&#x2019;ll write in those scripts is usually pretty boring. Those are business rules in all their glory, quite specific and narrow, carefully applied. They are simple to understand in isolation, and as long as we keep them this way, we can reduce the overall complexity on the system.Let&#x2019;s consider how we&#x2019;ll actually use them, shall we? Here is what the user will work with to customize the system. I&#x2019;m saying user, but this is likely going to be used by integrators, rather than the end user. That data is then going to be stored directly in our Policy object, and we can apply it as needed. A more complex solution may have the ability to attach multiple scripts to various events in the system. This change the entire manner of your system, because you are focused on enabling the behavior of the system, rather than having to figure out how to apply the rules. The end result is that there is a very well defined structure (there has to be, for things to work) and in general an overall more maintainable system.</p>
        </article>
        <article id="article-1117">
            <a href="https://andrewlock.net/a-deep-dive-on-stringbuilder-part-3-converting-chunks-to-a-string-with-tostring/" target="_blank">
                <h2 class="title mb-6" id="article-1117">Converting chunks to a string with ToString()</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 27, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A deep dive on StringBuilder - Part 3</p>
        </article>
        <article id="article-1118">
            <a href="https://ayende.com/blog/194273-B/working-with-business-events-and-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-1118">Working with business events and RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 26, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">About twenty years ago, I remember looking at a typical business application and most of the code was basically about massaging data to and from the database. The situation has changed, but even the most sophisticated of applications today spent an inordinate amount of time just shuffling data around. It may require lot less code, but CRUD still makes the most of the application codebase. On the one hand, that is pretty boring code to write, but on the other hand, that is boring code to write. That is an excellent property. Boring code is predictable, it will work without issues, it is easy to understand and modify and in general it lacks surprises. I love surprises when it comes to birthday parties and refunds from the IRS, I like them a lot less in my production code. Here is a typical example of such code:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public record PolicyPaid(string PolicyId, string PolicyType, decimal Amount, bool PaidInFull, DateTime At);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          public class PayPolicyHandler : BaseRequestHandler&lt;PayPolicy&gt;&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              public Task Handle(PayPolicy request, CancellationToken token)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var policy = await Session.LoadAsync&lt;Policy&gt;(request.PolicyId, token);&#xA;        &#xA;        &#xA;          &#xA;                  var full = policy.ApplyPayment(request.Payment, request.PaymentDate);&#xA;        &#xA;        &#xA;          &#xA;                  await Session.StoreaAync(new PolicyPaid(request.PolicyId, policy.Type, request.Amount, full, request.PaymentDate));&#xA;        &#xA;        &#xA;          &#xA;                  await Session.SaveChangesAsync(token);        &#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          InsurancePolicyPayment.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, we are using a command handling pattern and here we can choose one of a few architectural options:Write the code and behavior directly inside the command handlers.The command handlers are mostly about orchestration and we&#x2019;ll write the business logic inside the business entities (such as the example above).There is another aspect to the code here that is interesting, however. Take a look at the first line of code. We define there a record, a data class, that we use to note that an event happened. You might be familiar with the notion of event sourcing, where we are recording the incoming events to the system so we&#x2019;ll be able to replay them if our logic changes. In this case, that is the exact inverse of that, our code emits business events that can be processed by other pieces of the system.The nice thing in the code above is that the business event in this case is simply writing the data record to the database. In this manner, we can participate in the overall transaction and seamlessly integrate into the overarching architecture. There isn&#x2019;t much to do here, after all. You can utilize this pattern to emit whenever something that is interesting or potentially interesting happens in your application.Aside from holding up some disk space, why exactly would you want to do this?Well, now that you have the business events in the database, you can start operating on them. For example, we can create a report based on the paid policies by policy types and month. Of far greater interest, however, is the ability to handle such events in code. You can do that using RavenDB subscriptions.That gives us a very important channel for extending the behavior for the system. Given the code above, let&#x2019;s say that we want to add a function that would send a note to the user if their policy isn&#x2019;t paid in full. I can handle that by writing the following subscription:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          from PolicyPaid where PaidInFul == false&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          subscription.sql&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;And then we can write a script to process that:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          #!/usr/bin/python3&#xA;        &#xA;        &#xA;          &#xA;          import os&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          def process_partially_paid_policies(batch):&#xA;        &#xA;        &#xA;          &#xA;               for policy in batch.items:&#xA;        &#xA;        &#xA;          &#xA;                    # send an email, etc...&#xA;        &#xA;        &#xA;          &#xA;                    print(&quot;Pay up: &quot; &#x2B; policy.PolicyId)&#xA;        &#xA;        &#xA;          &#xA;                  &#xA;        &#xA;        &#xA;          &#xA;               &#xA;        &#xA;        &#xA;          &#xA;          with document_store.DocumentStore(urls=[os.getenv(&quot;RAVENDB_URL&quot;)], database=os.getenv(&quot;RAVENDB_DATABASE_NAME&quot;)) as store:&#xA;        &#xA;        &#xA;          &#xA;              store.initialize()&#xA;        &#xA;        &#xA;          &#xA;              &#xA;        &#xA;        &#xA;          &#xA;              connection_options = SubscriptionWorkerOptions(&quot;PartiallyPaidPolicies&quot;)&#xA;        &#xA;        &#xA;          &#xA;              with self.store.subscriptions.get_subscription_worker() as subscription:&#xA;        &#xA;        &#xA;          &#xA;                      subscription.run(process_partially_paid_policies)&#xA;        &#xA;        &#xA;          &#xA;                      &#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          subscription.py&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;I intentionally show the example here as a Python script, because that doesn&#x2019;t have to be a core part of the system. That can be just something that you add, either directly or as part of the system customization by an integrator.The point is that this isn&#x2019;t something that was thought of and envision by the core development team. Instead, we are emitting business events and using RavenDB subscriptions to respond to them and enhance the system with additional behavior.One end result of this kind of system is that we are going to have two tiers of the system. One, where most of the action happens, is focused almost solely on the data management and the core pieces of the system. All the other behavior in the system is done elsewhere, in a far more dynamic manner. That gives you a lot of flexibility. It also means that there is a lot less hidden behavior, you can track and monitor all the parts much more easily, since everything is done in the open.</p>
        </article>
        <article id="article-1119">
            <a href="https://www.meziantou.net/removing-elements-after-an-animation-in-blazor.htm" target="_blank">
                <h2 class="title mb-6" id="article-1119">Removing elements after an animation in Blazor</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 26, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There are many cases where you want to smoothly remove an element from the UI. A solution is to use an animation to fade out the element before removing it. You can start the animation by adding a class to the element you want to remove. Then, you can use the transitionend or animationend event to</p>
        </article>
        <article id="article-1120">
            <a href="https://ayende.com/blog/194241-B/postmortem-accidentally-quadratic-indexing-output" target="_blank">
                <h2 class="title mb-6" id="article-1120">Postmortem</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: July 23, 2021
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Tracking down a customer&#x2019;s performance issue, we eventually tracked things down to a single document modification that would grind the entire server to a halt. The actual save was working fine, it was when indexing time came around that we saw the issues. The entire system would spike in terms of memory usage and disk I/O, but CPU utilization wasn&#x2019;t too bad.We finally tracked it down to a fairly big document. Let&#x2019;s assume that we have the following document:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            &quot;name&quot;: &quot;Eat, Slay, Love: The Good Guys, Book 10&quot;,&#xA;        &#xA;        &#xA;          &#xA;            &quot;author&quot;: &quot;Eric Ugland&quot;,&#xA;        &#xA;        &#xA;          &#xA;            &quot;rating&quot;: &quot;Excellent&quot;,&#xA;        &#xA;        &#xA;          &#xA;            &quot;reviews&quot;: [&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                &quot;title&quot;: &quot;Fantastic&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;body&quot;: &quot;I really like how the story moves forward&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;author&quot;: &quot;users/clark&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;verified&quot;: true,&#xA;        &#xA;        &#xA;          &#xA;                &quot;rating&quot;: 5&#xA;        &#xA;        &#xA;          &#xA;              },&#xA;        &#xA;        &#xA;          &#xA;              /// *******************&#xA;        &#xA;        &#xA;          &#xA;              /// *Many* such reviews&#xA;        &#xA;        &#xA;          &#xA;              /// *******************&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                &quot;title&quot;: &quot;Horrible&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;body&quot;: &quot;Author writes based on a template and is boring, I&#x27;ll keep reading because I want to send him money, but will complain.&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;author&quot;: &quot;users/snark&quot;,&#xA;        &#xA;        &#xA;          &#xA;                &quot;verified&quot;: true,&#xA;        &#xA;        &#xA;          &#xA;                &quot;rating&quot;: 1&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;            ]&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          big.json&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Note that this can be big. As in, multiple megabyte range in some cases, with thousands of reviews. The case we looked at, the document was over 5MB in size and had over 1,500 reviews.That isn&#x2019;t ideal, and RavenDB will issue an performance hint when dealing with such documents, but certainly workable. The problem was with the index, which looked like this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          from book in docs.Books&#xA;        &#xA;        &#xA;          &#xA;          from review in book.reviews&#xA;        &#xA;        &#xA;          &#xA;          select new &#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            review_title review.title,&#xA;        &#xA;        &#xA;          &#xA;            review_rating = review.rating,&#xA;        &#xA;        &#xA;          &#xA;            review_verfied = review.verified,&#xA;        &#xA;        &#xA;          &#xA;            review_author = review.author&#xA;        &#xA;        &#xA;          &#xA;            book = book,&#xA;        &#xA;        &#xA;          &#xA;            book_rating = book.rating,&#xA;        &#xA;        &#xA;          &#xA;            book_name = book.name,&#xA;        &#xA;        &#xA;          &#xA;            book_author = book.author&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          opps.index.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This index is also setup to store all the fields being indexed. Take a look at the index, and read it a few times. Can you see what the problem is? This is a fanout index, which I&#x2019;m not a fan of, but that is certainly something that we can live with. 1,500 results from a single index isn&#x2019;t even in the top order of magnitude that we have seen. And yet this index will cause RavenDB to consume a lot of resources, even if we have just a single document to index.What is going on here?Here is the faulty issue:Give it a moment to sink in, please.We are indexing the entire document here, once for each of the reviews that you have in the index. When RavenDB encounters a complex value as part of the indexing process, it will index that as a JSON value. There are some scenarios that call for that, but in this case, what this meant is that we would, for each of the reviews in the document:Serialize the entire document to JSONStore that in the index5MB times 1,500 reviews gives us a single document costing us nearly 8GB in storage space alone. And will allocate close to 100GB (!) of memory during its operation (won&#x2019;t hold 100GB, just allocate it). Committing such an index to disk requires us to temporarily use about 22GB of RAM and force us to do a single durable write that exceed the 7GB mark. Then there is the background work to clean all of that.The customer probably meant to index book_id, but got this by mistake, and then we ended up with extreme resource utilization every time that document was modified. Removing this line meant that indexing the document went from ~8GB to 2MB. That is three orders of magnitude difference.We are going to be adding some additional performance hints to make it clear that something is wrong in such a scenario. We had a few notices, but it was hard to figure out exactly what was going on there.</p>
        </article>
        <div class="button flex justify-between">
            <a href="111.html"><span class="back arrow"></span></a>

            <a href="113.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>