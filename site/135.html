
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/183329-C/the-case-of-the-missing-writes-in-docker-a-data-corruption-story" target="_blank"><h1 class="title mb-6">The case of the missing writes in Docker (a Data Corruption story)</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 14, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We started to get reports from users that are running RavenDB on Docker that there are situations where RavenDB reports that there has been a data corruption event.&#xA0; You can see how this looks like on the right. As you can see, this ain&#x2019;t a happy camper. In fact, this is a pretty scary one. The kind you see in movies that air of Friday the 13th. The really strange part there was that this is one of those errors that really should never be possible. RavenDB have a lot of internal checks, including for things that really aren&#x2019;t supposed to happen. The idea is that it is better to be safe than sorry when dealing with your data. So we got this scary error, and we looked into it hard. This is the kind of error that gets top priority internally, because it touch at the core of what we do, keeping data safe.The really crazy part there was that we could find any data loss event. It took a while until we were able to narrow it down to Docker, so we were checking a lot of stuff in the meantime. And when we finally began to suspect Docker, it got even crazier. At some point, we were able to reproduce this more or less at will. Spin a Docker instance, write a lot of data, wait a bit, write more data, see the data corruption message. What was crazy about that was that we were able to confirm that there wasn&#x2019;t any actual data corruption.We started diving deeper into this, and it looked like we fell down a very deep crack. Eventually we figured out that you need the following scenario to reproduce this issue:A Linux Docker instance.Hosted on a Windows machine.Using an external volume to store the data.That led us to explore exactly how Docker does volume sharing. I a Linux / Linux or Windows / Windows setup, that is pretty easy, it basically re-route namespaces between the host and the container. In a Linux container running on a Windows machine, the external volume is using CIFS. In other words, it is effectively running on a network drive, even if the network is machine local only.It turned out that the reproduction is not only very specific for a particular deployment, but also for a particular I/O pattern. The full C code reproducing this can be found here. It is a bit verbose because I handled all errors. The redacted version that is much more readable is here:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          char* alignedBuffer;&#xA;        &#xA;        &#xA;          &#xA;          char readBuffer[4096];&#xA;        &#xA;        &#xA;          &#xA;          int wfd, rfd, rc;&#xA;        &#xA;        &#xA;          &#xA;          size_t i;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          alignedBuffer = aligned_alloc(4096, 4096);&#xA;        &#xA;        &#xA;          &#xA;          memset(alignedBuffer, &#x27;$&#x27;, 4096);&#xA;        &#xA;        &#xA;          &#xA;          wfd = open(argv[1], O_DIRECT | O_DSYNC | O_WRONLY | O_TRUNC  | O_CREAT, S_IWUSR | S_IRUSR);&#xA;        &#xA;        &#xA;          &#xA;          rc = pwrite(wfd, alignedBuffer, 4096, (256 * 1024 * 1024) - 4096 );&#xA;        &#xA;        &#xA;          &#xA;          rc = fsync(wfd);&#xA;        &#xA;        &#xA;          &#xA;          for (i = 0; i &lt; 256; i&#x2B;&#x2B;)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;rc = pwrite(wfd, alignedBuffer, 4096, i * 4096);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          rfd = open(argv[1], O_RDONLY, S_IRUSR);&#xA;        &#xA;        &#xA;          &#xA;          rc = pwrite(wfd, alignedBuffer, 4096, 256 * 4096);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          memset(readBuffer, 1, 4096);&#xA;        &#xA;        &#xA;          &#xA;          rc = pread(rfd, readBuffer, 4096, 257 * 4096);&#xA;        &#xA;        &#xA;          &#xA;          rc = pwrite(wfd, alignedBuffer, 4096, 257 * 4096);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          memset(readBuffer, 1, 4096);&#xA;        &#xA;        &#xA;          &#xA;          rc = pread(rfd, readBuffer, 4096, 257 * 4096);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          if (readBuffer[0] != &#x27;$&#x27;) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;printf(&quot;Line %d Read corrupted data from disk: %d but exepcted &#x27;$&#x27; \n&quot;, __LINE__, readBuffer[0]);&#xA;        &#xA;        &#xA;          &#xA;          &#x9;return __LINE__;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          bad_io.short.c&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This can be executed using:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          #!/bin/sh&#xA;        &#xA;        &#xA;          &#xA;          gcc /wrk/bad_io.c -o /wrk/bad_io.exec&#xA;        &#xA;        &#xA;          &#xA;          /wrk/bad_io.exec /wrk/test.file&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          setup.sh&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;And running the following command:docker run --rm -v PWD:/wrk gcc /wrk/setup.shAs you can see, what we do is the following:Create a file and ensure that it is pre-allocatedWrite to the file using O_DIRECT | O_DSYNCWe then read (using another file descriptor) the dataThe write operations are sequential, and the read operations as well, however, the read operation will read past the written area. This is key. At this point, we write again to the file, to an area where we already previously read.At this point, we attempt to re-read the data that was just written, but instead of getting the data, we get just zeroes.&#xA0; What I believe is going on is that we are hitting the cached data. Note that this is doing system calls, not any userland cache. I reported this to Docker as a bug. I actually believe that this will be the same whenever we use CIFS system (a shared drive) to run this scenario. The underlying issue is that we have a process that reads through the journal file and apply it, at the same time that transactions are writing to it. We effectively read the file until we are done, forcing the file data into the cache. The writes, which are using direct I/O are going to bypass that cache and we are going to have to wait for the change notification from CIFS to know that this needs to be invalidated. That turn this issue into a race condition of data corruption,of sort.The reason that we weren&#x2019;t able to detect data corruption after the fact was that there was no data corruption. The data was properly written to disk, we were just mislead by the operating system about that when we tried to read it and got stale results. The good news is that even after catching the operating system cheating on us with the I/O system, RavenDB is handling things with decorum. In other words, we immediately commit suicide on the relevant database. The server process shuts down the database, register an alert and try again. At this point, we rely on the fact that we are crash resistant and effectively replay everything from scratch. The good thing about this is that we are doing much better the second time around (likely because there is enough time to get the change event and clear the cache). And even if we aren&#x2019;t, we are still able to recover the next time around. Running Linux containers on Windows is a pretty important segment for us, developers using Docker to host RavenDB, and it make a lot of sense they will be using external volumes. We haven&#x2019;t gotten to testing it out, but I suspect that CIFS writes over &#x201C;normal&#x201D; network might exhibit the same behavior. That isn&#x2019;t actually a good configuration for a database for a lot of other reasons, but that is still something that I want to at least be able to limp on. Even with no real data loss, a error like the one above is pretty scary and can cause a lot of hesitation and fear for users. Therefor, we have changed the way we are handling I/O in this case, we&#x2019;ll avoid using the two file descriptors and hold a bit more data in memory for the duration. This give us more control, actually likely to give us a small perf boost and avoid the problematic I/O pattern entirely.</p>
        <a href="https://enterprisecraftsmanship.com/posts/ef-core-vs-nhibernate-ddd-perspective/" target="_blank"><h1 class="title mb-6">EF Core 2.1 vs NHibernate 5.1: DDD perspective</h1></a>
        <p class="mb-2">by Vladimir Khorikov</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 13, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">UPDATE 3/5/2020: I&#x2019;ve expanded on this article and updated its content for EF Core 3.1 in my new Pluralsight course DDD and EF Core: Preserving Encapsulation.&#xA;&#xA;That was probably a long wait for those of you who follow my blog. But, better late than never, so here it is: another comparison of Entity Framework and NHibernate, in which I bash EF Core and present it as an unbiased review. Just kidding, I do try to be unbiased here to the best of my skills.</p>
        <a href="https://ayende.com/blog/183297-A/net-core-2-1-broke-my-software-thank-you-very-much" target="_blank"><h1 class="title mb-6">.NET Core 2.1 broke my software, thank you very much!</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 13, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We just upgraded our stable branch to .NET Core 2.1. The process was pretty smooth overall, but we did get the following exchange in our internal Slack channel. It went something like this:is it known that import doesn&#x27;t work ? As you can imagine, Import is pretty important for us.nodoes it work on your machine ?checking,,,what&#x27;s an error?no error.so UI is blocked?do you have any errors in dev tools console?`TypeError: e is undefined`doesn&#x27;t says to me muchsame thing in incognitoexport doesn&#x27;t work eitherlol the reason is: dotnet core 2.1&#xA;the websockets are faster and I had race in code&#xA;will push fix shortlyThere you have it, .NET Core 2.1 broke our code. Now I have to go and add Thread.Sleep somewhere&#x2026;</p>
        <a href="https://www.stevejgordon.co.uk/ihttpclientfactory-patterns-using-typed-clients-from-singleton-services" target="_blank"><h1 class="title mb-6">IHttpClientFactory Patterns: Using Typed Clients from Singleton Services</h1></a>
        <p class="mb-2">by Steve Gordon</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 11, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;ve been following IHttpClientFactory for some time and have created a number of blog posts on the various features based on sample applications. Since then; with the release of ASP.NET Core 2.1 now available, I&#x2019;ve begun using IHttpClientFactory in real production applications. In this post, I want to start covering some patterns I&#x2019;ve begun to [&#x2026;]</p>
        <a href="https://ayende.com/blog/183265-A/ravendb-4-0-node-js-client-rtm" target="_blank"><h1 class="title mb-6">RavenDB 4.0 Node.JS client RTM</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 11, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The Node.JS client for RavenDB 4.0 is out. You can get it directly from NPM. Here is how this looks like:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          const { DocumentStore } = require(&#x27;ravendb&#x27;);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          const store = new DocumentStore(&#x27;http://live-test.ravendb.net&#x27;, &#x27;Norhtwind&#x27;);&#xA;        &#xA;        &#xA;          &#xA;          store.initialize();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          const session = store.openSession();&#xA;        &#xA;        &#xA;          &#xA;          let product = await session.load(&#x27;products/1-A&#x27;);&#xA;        &#xA;        &#xA;          &#xA;          product.in_stock = false;&#xA;        &#xA;        &#xA;          &#xA;          product.last_update = new Date();&#xA;        &#xA;        &#xA;          &#xA;          await session.saveChanges();&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          ravendb.node.js&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;Enjoy .</p>
        <a href="https://ayende.com/blog/183233-A/inside-ravendb-4-0-book-is-done-done" target="_blank"><h1 class="title mb-6">Inside RavenDB 4.0 book is Done, Done</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 08, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">And now the book is another tiny big step close to actually being completed. All editing has been completed, and we did a full pass through the book. All content is written and there isn&#x2019;t much to do at all.We are now sending this for production work, and once that is done, I can announce this project complete. Of course, by that time, I&#x2019;ll have to start writing about the new features in RavenDB 4.1, but that is a story for another day.You can get the updated bits here, as usual, I would really appreciate any feedback.</p>
        <a href="https://ayende.com/blog/183201-C/automatic-subscription-retries-with-ravendb" target="_blank"><h1 class="title mb-6">Automatic subscription retries with RavenDB</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 07, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB&#x2019;s subscription give you the ability to run batch processing easily and robustly. In other words, you specify a query and subscribe to its results. RavenDB will send you all the documents matching the query. So far, that is pretty obvious, but what is important with subscriptions is the fact that it will keep sending you results. As long as your subscription is opened, you&#x2019;ll get any changed document that matches your query. That gives you a great way to implement event pipelines, batch processes and in general opens up some interesting options. In this case, I want to talk about how failures with subscriptions. Not failure in the sense of a server going down, or a client crashing. These are already handled by the subscription mechanism itself. A server going down will cause the cluster to change the ownership of subscription, and your client code will not even notice. A client going down can either failover to another client. Alternatively, upon restart of the client, it will pick up right from where it dropped things. No, this is handled.What require attention is what happen if there is an error during the processing of a batch of documents. Imagine that we want to do some background processing. We could do that in many ways, such as introducing a queuing system and tasks queue, but in many cases, the overhead of that is quite high. A simpler approach is to just write the tasks out as documents and use a subscription to process them. In this case, let&#x2019;s imagine that we want to send emails. A subscription will run over all the EmailToSend collection, doing whatever processing is required to actually send it. Once we are done processing a batch, we&#x2019;ll delete all the items that we processed. Whenever there are new emails to send, the subscriptions will get them for us immediately.But what happens if there is a failure to send one particular email in a batch? Well, we can ignore this (and not delete the document), but that will require some admin involvement to resolve. Subscriptions will not revisits documents that they have already seen. Except if these documents were changed.&#xA0; Here is one way to handle this scenario:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var retry = new PatchRequest {&#xA;        &#xA;        &#xA;          &#xA;            Script = @&quot;&#xA;        &#xA;        &#xA;          &#xA;              var metadata =this[&#x27;@metadata&#x27;];&#xA;        &#xA;        &#xA;          &#xA;              metadata.Retries = (metadata.Retries || 0) &#x2B; 1;&#xA;        &#xA;        &#xA;          &#xA;            &quot;&#xA;        &#xA;        &#xA;          &#xA;          };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          using (var subscription = store.Subscriptions.GetSubscriptionWorker&lt;EmailToSend&gt;(options))&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              await subscription.Run(async batch =&gt;&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  using (var session = batch.OpenAsyncSession())&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      foreach (var item in batch.Items)&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          try&#xA;        &#xA;        &#xA;          &#xA;                          {&#xA;        &#xA;        &#xA;          &#xA;                              SendEmail(item.Document);&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          catch&#xA;        &#xA;        &#xA;          &#xA;                          {&#xA;        &#xA;        &#xA;          &#xA;                              if (item.Metadata.TryGetValue(&quot;Retries&quot;, out object o) &amp;&amp;&#xA;        &#xA;        &#xA;          &#xA;                                  o is long numberOfRetries &amp;&amp;&#xA;        &#xA;        &#xA;          &#xA;                                  numberOfRetries &gt; 5)&#xA;        &#xA;        &#xA;          &#xA;                              {&#xA;        &#xA;        &#xA;          &#xA;                                  // too many retries, giving up, admin will handle.&#xA;        &#xA;        &#xA;          &#xA;                                  continue; // logging / warning / etc&#xA;        &#xA;        &#xA;          &#xA;                              }&#xA;        &#xA;        &#xA;          &#xA;                              // this will increment the retries counter&#xA;        &#xA;        &#xA;          &#xA;                              // will also cause it to be resent to the &#xA;        &#xA;        &#xA;          &#xA;                              // subscription because it was changed.&#xA;        &#xA;        &#xA;          &#xA;                              var patch = new PatchCommandData(item.Id,&#xA;        &#xA;        &#xA;          &#xA;                                  item.ChangeVector,&#xA;        &#xA;        &#xA;          &#xA;                                  retry,&#xA;        &#xA;        &#xA;          &#xA;                                  patchIfMissing: null&#xA;        &#xA;        &#xA;          &#xA;                                  );&#xA;        &#xA;        &#xA;          &#xA;                              session.Advanced.Defer(patch);&#xA;        &#xA;        &#xA;          &#xA;                              continue;&#xA;        &#xA;        &#xA;          &#xA;                          }&#xA;        &#xA;        &#xA;          &#xA;                          session.Delete(item.Id);&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;                      await session.SaveChangesAsync();&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              });&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          AutomaticRetries.Subscriptions.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;In short, we&#x2019;ll try to process each document, sending the email, etc. If we failed to do so, we&#x2019;ll not delete the document, instead, we&#x2019;ll patch it to increment a Retries property in the metadata. This operation has two interesting effects. First, it means that we can keep track of how often we retried a particular document. But as a side effect of modifying the document, we&#x2019;ll get it back in the subscription again. In other words, this piece of code will give a document 5 retries before it give up. As an admin, you can then peek into your database and see all the documents that have exceeded the allow retries and make a decision on what to do with them. But anything that failed because of some transient failure will just work.</p>
        <a href="https://ayende.com/blog/183169-C/codex-kv-properly-generating-the-file" target="_blank"><h1 class="title mb-6">Codex KV</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 06, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The previous post has a code sample in it that was figuratively* physically painful for me to write. Avoiding the number of syscalls that are invoked, the code isn&#x2019;t all too efficient as I now measure things, it uses way too much managed memory and it is subject to failures as we increase the amount of data we push through. For this post, I&#x2019;m going to be rewriting the CodexWriter class as I would for code that is going into RavenDB.* I literally know what literally used to mean, amazing.I&#x2019;m sorry, there is going to be a big jump in the complexity of the code, because I&#x2019;m going to try to handle performance, parallelism and resource utilization all at once. The first thing to do is to go into the project&#x2019;s settings and enable both unsafe code (without which is it nearly impossible to write high performance code) and C# 7.3 features, we&#x2019;ll need these. We can divide the task of gather the inputs into several stages. First, we need to write the data to the file. This is similar to the way we did it before, here is the Add() method:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public void Add(string str)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              if (_alreadSeen.Add(str) == false)&#xA;        &#xA;        &#xA;          &#xA;                  return; // already exists&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              _currentOffsets.Add(_data.Position);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              _dataWriter.Write(str);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              if (_currentOffsets.Count &gt;= 16 * 1024)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  CreateSegment();&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          Update.Add.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, there isn&#x2019;t really much that changed here, but we have this notion of a segment, which is created every million keys. But what is this segment?It is a way to refer to a specific section of records in the file. In particular, it has just one primary role, it exists to sort the records. Let&#x2019;s take a look at the code:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          private unsafe class Segment : IComparable&lt;Segment&gt;, IComparer&lt;long&gt;, IDisposable&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              private readonly CodexWriter _parent;&#xA;        &#xA;        &#xA;          &#xA;              private int _current;&#xA;        &#xA;        &#xA;          &#xA;              public Task Running;&#xA;        &#xA;        &#xA;          &#xA;              private byte* _rawData;&#xA;        &#xA;        &#xA;          &#xA;              private readonly List&lt;IDisposable&gt; _toDispose = new List&lt;IDisposable&gt;();&#xA;        &#xA;        &#xA;          &#xA;              private readonly List&lt;long&gt; _offsets;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public Segment(CodexWriter parent, List&lt;long&gt; offsets)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _parent = parent;&#xA;        &#xA;        &#xA;          &#xA;                  _offsets = offsets;&#xA;        &#xA;        &#xA;          &#xA;                  var dataMap = MemoryMappedFile.CreateFromFile(_parent._data, null, 0, MemoryMappedFileAccess.Read, HandleInheritability.None, true);&#xA;        &#xA;        &#xA;          &#xA;                  _toDispose.Add(dataMap);&#xA;        &#xA;        &#xA;          &#xA;                  var dataAccessor = dataMap.CreateViewAccessor(0, _parent._data.Length, MemoryMappedFileAccess.Read);&#xA;        &#xA;        &#xA;          &#xA;                  _toDispose.Add(dataAccessor);&#xA;        &#xA;        &#xA;          &#xA;                  dataAccessor.SafeMemoryMappedViewHandle.AcquirePointer(ref _rawData);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              [MethodImpl(MethodImplOptions.AggressiveInlining)]&#xA;        &#xA;        &#xA;          &#xA;              public static int ReadVariableSizeInt(ref byte* buffer)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                &#x9;// redacted&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public Span&lt;byte&gt; GetKeyAtOffset(long index)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var aLoc = _rawData &#x2B; index;&#xA;        &#xA;        &#xA;          &#xA;                  var aSize = ReadVariableSizeInt(ref aLoc);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  return new Span&lt;byte&gt;(aLoc, aSize);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public Task EnsureSorted()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  if (Running != null)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      return Running;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  var task = new Task(() =&gt;&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      _offsets.Sort(this);&#xA;        &#xA;        &#xA;          &#xA;                  });&#xA;        &#xA;        &#xA;          &#xA;                  var result = Interlocked.CompareExchange(ref Running, task, null);&#xA;        &#xA;        &#xA;          &#xA;                  if (result == null)&#xA;        &#xA;        &#xA;          &#xA;                      task.Start();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  return result ?? task;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public int Compare(long x, long y)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var a = GetKeyAtOffset(x);&#xA;        &#xA;        &#xA;          &#xA;                  var b = GetKeyAtOffset(y);&#xA;        &#xA;        &#xA;          &#xA;                  return Compare(a, b);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              [DllImport(&quot;msvcrt.dll&quot;, EntryPoint = &quot;memcmp&quot;, CallingConvention = CallingConvention.Cdecl, SetLastError = false)]&#xA;        &#xA;        &#xA;          &#xA;              public static extern int Compare(byte* b1, byte* b2, long count);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private int Compare(Span&lt;byte&gt; a, Span&lt;byte&gt; b)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  fixed (byte* pb = b)&#xA;        &#xA;        &#xA;          &#xA;                  fixed (byte* pa = a)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      var size = Math.Min(a.Length, b.Length);&#xA;        &#xA;        &#xA;          &#xA;                      var result = Compare(pa, pb, size);&#xA;        &#xA;        &#xA;          &#xA;                      if (result != 0)&#xA;        &#xA;        &#xA;          &#xA;                          return result;&#xA;        &#xA;        &#xA;          &#xA;                      return a.Length - b.Length;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          Segment.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;There are a few key points. Instead of using file I/O directly, we are using memory mapped files. Why is that? Because, as we have seen, the cost of syscalls is non trivial in the extreme, and using memory mapped files means that we can access the data natively without having to pay any price aside from page fault if the data isn&#x2019;t already in memory.The EnsureSorted() method is also interesting, it spawns a new task to sort the entries inside the segment in parallel with inserting the data to the main file. The actual sort is handled in the Compare() methods.As we write the data into the codex, we sort the data as we run through it, but what happens in the end? In this case, we have about 13 million items that we inserted, so we have 13 segments that are each individually sorted. To get the final sort, we basically merge from all of them. Here is the relevant code:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public void Complete()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              if (_currentOffsets.Count &gt; 0)&#xA;        &#xA;        &#xA;          &#xA;                  CreateSegment();&#xA;        &#xA;        &#xA;          &#xA;              var heap = new SortedSet&lt;Segment&gt;();&#xA;        &#xA;        &#xA;          &#xA;              foreach (var segment in _segments)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  segment.Running.Wait();&#xA;        &#xA;        &#xA;          &#xA;                  heap.Add(segment);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              int count = 0;&#xA;        &#xA;        &#xA;          &#xA;              while (heap.Count &gt; 0)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  count&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;                  var min = heap.Min;&#xA;        &#xA;        &#xA;          &#xA;                  heap.Remove(min);&#xA;        &#xA;        &#xA;          &#xA;                  _dataWriter.Write(min.GetCurrentOffset());&#xA;        &#xA;        &#xA;          &#xA;                  if (min.MoveNext())&#xA;        &#xA;        &#xA;          &#xA;                      heap.Add(min);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              _dataWriter.Write(count);&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          private class Segment &#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            [DllImport(&quot;msvcrt.dll&quot;, EntryPoint = &quot;memcmp&quot;, CallingConvention = CallingConvention.Cdecl, SetLastError = false)]&#xA;        &#xA;        &#xA;          &#xA;            public static extern int Compare(byte* b1, byte* b2, long count);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            private int Compare(Span&lt;byte&gt; a, Span&lt;byte&gt; b)&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                fixed (byte* pb = b)&#xA;        &#xA;        &#xA;          &#xA;                fixed (byte* pa = a)&#xA;        &#xA;        &#xA;          &#xA;                {&#xA;        &#xA;        &#xA;          &#xA;                    var size = Math.Min(a.Length, b.Length);&#xA;        &#xA;        &#xA;          &#xA;                    var result = Compare(pa, pb, size);&#xA;        &#xA;        &#xA;          &#xA;                    if (result != 0)&#xA;        &#xA;        &#xA;          &#xA;                        return result;&#xA;        &#xA;        &#xA;          &#xA;                    return a.Length - b.Length;&#xA;        &#xA;        &#xA;          &#xA;                }&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;            public int CompareTo(Segment other)&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;                if (_current &gt;= _offsets.Count)&#xA;        &#xA;        &#xA;          &#xA;                    return -1;&#xA;        &#xA;        &#xA;          &#xA;                if (other._current &gt;= other._offsets.Count)&#xA;        &#xA;        &#xA;          &#xA;                    return 1;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                return Compare(GetCurrentKey(), other.GetCurrentKey());&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          MergeSort.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This used the SortedSet as a heap, to always get the minimum value from the sorted inner values in the set. Note that we need to wait for the parallel searches to complete, then merge from all of them to the final result. We can write the result of the sort directly to the end of the file.Overall, this process takes: 59.01 seconds to complete. Remember that this is when we are pushing unsorted data through. If we pass the data sorted, we get a significant improvement and only take: 35.91 seconds.To compare, I run the same sort of test on Voron, and I got: 59.15 seconds for the unsorted case and for the sorted case: 13.85 seconds. This is when Voron is also doing ACID writes, which we obviously don&#x2019;t in Codex.I guess that spending four to five years with a whole team doing performance optimization is a better way to get storage performance than a couple of evenings hacking before I go to bed, who knew?</p>
        <a href="https://ayende.com/blog/183105-C/codex-kv-how-to-build-a-kv-storage-from-scratch" target="_blank"><h1 class="title mb-6">Codex KV</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 05, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We are exploring a few data structure for a particular feature in RavenDB, and I run into something that is elegant, simple, easy and deep enough that we can discuss serious implementation details upon without getting too bogged down in the details.The idea is that I&#x2019;m going to be using this series of blog post to post a detailed walk through about building a key value store from scratch. Including all the intermediate steps and wrong turns along the way. In other words, this is a &#x201C;Show YourWork&#x201D; kind of series. The end result is going to be a key/value store that can:Store arbitrary keys / values.Get key&#x2019;s value by the key.Support range queries and iteration.Support some form of ACID.In this case, I&#x2019;m going to start from the very basics and build up. The challenge we are going to deal with is ingesting all the titles of articles in Wikipedia, about 277MB of them. I took them from here: (https://dumps.wikimedia.org/enwiki/latest/enwiki-latest-all-titles-in-ns0.gz). There are 13,755,095 of them in my case. I&#x2019;m calling the KV store that we&#x2019;ll be creating Codex. And I&#x2019;m going to start from the most basic of example, just being able to store and check if a value exists in the store. Here is the code that reads from the titles list and add them to the store. Note that the articles are sorted, but we don&#x2019;t want this advantage of adding sorted data, so we randomize things.&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;           var writer = new CodexWriter(file);&#xA;        &#xA;        &#xA;          &#xA;           var lines = File.ReadAllLines(@&quot;C:\Users\ayende\Downloads\enwiki-20180220-all-titles-in-ns0&quot;);&#xA;        &#xA;        &#xA;          &#xA;           Shuffle(lines);&#xA;        &#xA;        &#xA;          &#xA;           foreach (var term in lines)&#xA;        &#xA;        &#xA;          &#xA;           {&#xA;        &#xA;        &#xA;          &#xA;               writer.Add(term);&#xA;        &#xA;        &#xA;          &#xA;           }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          codex.add.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;The question here, how are we going to store these titles in a way that allow us fast retrieval?&#xA0; Here is the idea, we are going to write the strings to the output file as they come, and also record their positions. When we are done inserting strings to the codex, we&#x2019;ll run a sort based on the positions, and that will give us an array of offsets to the strings in the files, sorted by their value. The first version of this code looks like this:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public class CodexWriter&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              private readonly Stream _dest;&#xA;        &#xA;        &#xA;          &#xA;              private readonly BinaryWriter _writer;&#xA;        &#xA;        &#xA;          &#xA;              private List&lt;long&gt; _positions = new List&lt;long&gt;();&#xA;        &#xA;        &#xA;          &#xA;              private BinaryReader _reader;&#xA;        &#xA;        &#xA;          &#xA;              private HashSet&lt;string&gt; _repeated = new HashSet&lt;string&gt;();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public CodexWriter(Stream dest)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _dest = dest;&#xA;        &#xA;        &#xA;          &#xA;                  _writer = new BinaryWriter(_dest);&#xA;        &#xA;        &#xA;          &#xA;                  _reader = new BinaryReader(_dest);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Add(string str)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  if (_repeated.Add(str) == false)&#xA;        &#xA;        &#xA;          &#xA;                      return;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  var pos = _dest.Position;&#xA;        &#xA;        &#xA;          &#xA;                  _writer.Write(str);&#xA;        &#xA;        &#xA;          &#xA;                  _positions.Add(pos);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              private string ReadFrom(long pos)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  _dest.Position = pos;&#xA;        &#xA;        &#xA;          &#xA;                  return _reader.ReadString();&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              public void Complete()&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  var pos = _dest.Position;&#xA;        &#xA;        &#xA;          &#xA;                  _positions.Sort((x, y) =&gt; ReadFrom(x).CompareTo(ReadFrom(y)));&#xA;        &#xA;        &#xA;          &#xA;                  _dest.Position = pos;&#xA;        &#xA;        &#xA;          &#xA;                  foreach (var item in _positions)&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      _writer.Write(item);&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  _writer.Write(_positions.Count);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          CodexWriter.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;If you&#x2019;ll run this code on the Wikipedia titles, you&#x2019;ll find that it takes a while to run. On my machine, that took just under 50 minutes.Well, we are dealing with the full set of Wikipedia titles, but even so, that doesn&#x2019;t sound like it should take this long. What gives?Let&#x2019;s analyze what is going on here, okay? If you run this code, you&#x2019;ll note that it isn&#x2019;t using CPU or I/O or really seems to be doing much. What is going on?The key here is in the ReadFrom method. There, we do two seemingly innocent actions. We set the file&#x2019;s position (translate to SetFilePointer call) and read a short string (translate to a ReadFile call). Now, why is that expensive? Well, the ReadFrom method is called twice each time we need to sort an entry. In this case, it means that ReadFrom will be called a total of 575,616,878 times. That is not a typo. And each invocation means two separate system call. In other words, this innocent seeming piece of code executed over 1.15 billion system calls.For reference, simple by reading the entire file to a MemoryStream and keeping everything else the same, I was able to bring the cost of this operation down to under 3 minutes.Lesson learned, system calls are expensive, let&#x2019;s try to reduce them as much as we can.</p>
        <a href="https://www.stevejgordon.co.uk/record-metrics-datadog-asp-net-core-aws-ecs" target="_blank"><h1 class="title mb-6">How to record metrics to DataDog from ASP.NET Core</h1></a>
        <p class="mb-2">by Steve Gordon</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: June 04, 2018
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;m currently architecting and building a new microservices based system at work. A priority of mine has been to learn from the experience of building our first microservices project by putting a greater focus on logging and monitoring. We freely acknowledge that we didn&#x2019;t get this as good as we would have liked in our [&#x2026;]</p>
        <div class="button flex justify-between">
            <a href="134.html"><span class="back arrow"></span></a>

            <a href="136.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>