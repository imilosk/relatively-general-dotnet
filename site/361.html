
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/160292/optimizations-gone-wild-o-n-memory-leaks" target="_blank"><h1 class="title mb-6">Optimizations gone wild, O(N!) memory leaks</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 17, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">So, after doing so much work on the indexing optimization, it turned out that we had a bug. I assume that you remember this optimization, right?  In which we were able to pre fetch data from the disk and not have to wait for data at all. This all worked beautifully when running on data sets that included simple indexes. But the moment we had map/reduce indexes, something bad happened. That something bad was that we kept missing the batch that we loaded (this relates to how we load &amp; find the appropriate batches).  We do all the lookups by etag, and map/reduce add gaps in the etags. Which meant that we kept missing the etag, and had to start loading things up again. And because whenever we load something we also start loading the next batch&#x2026; Here is what the memory looked like:   Yup, for every batch we loaded the next 5 batches, for a total of O(N!) items in memory for everything. Now, we had some cleanup routines, but we did NOT expect to have that much, so we would recover, eventually, but usually not before we consumed all the memory. Opps!</p>
        <a href="https://benfoster.io/blog/web-api-multipart-file-upload-additional-form-data/" target="_blank"><h1 class="title mb-6">Sending additional form data in multipart uploads with ASP.NET Web API</h1></a>
        <p class="mb-2">by Ben Foster</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 15, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I demonstrate how you can use ASP.NET Web API&#x2019;s HTTP client to send additional form data in a multipart form upload.</p>
        <a href="https://ayende.com/blog/160291/ravendb-indexing-optimizations-step-iii-skipping-the-disk-altogether" target="_blank"><h1 class="title mb-6">RavenDB indexing optimizations, Step III&#x2013;Skipping the disk altogether</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 14, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Coming back a bit, before prefetching, we actually had something like this:  &#xA0;  With the new prefetching, we can parallelize the indexing &amp; the I/O fetching. That is good, but the obvious optimization is actually not going to the disk at all. We already have the documents we want in memory, why no send them directly to the pre fetched queue?  As you can see, we didn&#x2019;t need to even touch the disk to get this working properly. This gives us a really big boost in terms of how fast we can index things. Also note that because we already have those docs in memory, we can still merge separate writes into a single indexing batch, reducing the cost of indexing even further.</p>
        <a href="https://ayende.com/blog/160290/ravendb-indexing-optimizations-step-ii-pre-fetching" target="_blank"><h1 class="title mb-6">RavenDB indexing optimizations, Step II&#x2013;Pre Fetching</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 13, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Getting deeper into our indexing optimization routines, when we last left it, we had the following system:  This was good because it was able to predictively decide when to increase the batch size and smooth over spikes easily. But note where we have the costs?  The next step was this:  Pre fetching, basically. What we noticed is that we were spending a lot of time just loading the data from the disk, and we changed our behavior to allow us to load things while we are indexing. So on the next indexing batch, we will usually find all of the data we needed already in memory and ready to rock. This gave us a pretty big boost in how fast we can index things , but we aren&#x2019;t done yet. In order to make this feature viable, we had to do a lot of work there. For starter, we had to make sure we would take too much memory, and we wouldn&#x2019;t impact other aspects of the database, etc. Interesting work, all around, even if I am just focusing on the high level optimizations. There is still a fairly obvious optimization waiting for us, but I&#x2019;ll discuss that in the next post.</p>
        <a href="https://ayende.com/blog/160289/ravendb-indexing-optimizations-step-i-dynamic-batches" target="_blank"><h1 class="title mb-6">RavenDB indexing optimizations, Step I&#x2013;dynamic batches</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 12, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the major features in RavenDB was significant improvements to indexing speed. I thought that this would be a good idea to discuss this in detail. Here is a very simple example of how RavenDB used to handle indexing.  The blue boxes are inserts, and the green and red ones are showing the indexing work done.  &#xA0;  This is simplified, of course, but that is a good way to show exactly what is going on there. In particular, you can see that it takes quite a long time for us to index everything. The good thing here is that the actual cost we have is per index, so we want to batch things properly. Note that this behavior is already somewhat optimized. Most of the time, you don&#x2019;t have a few calls with thousands of documents. Usually we are talking about many calls each saving a small number of documents. This approach would balance those things out, because we can merge many save calls into a single indexing run. However, that still took too much time, so we introduced the idea of dynamically change the batch size (the reason we have batches is to limit the amount of RAM we use, and allow us to respond more quickly in general). So we changed things to do this:  Note that we increased the batch size as we note that we have more things to index. The batch size will automatically grow all the way to 128K docs, depending on a whole host of factors (load, speed, memory, number of indexes, etc). Since the cost is most in per batch, we actually got a not insignificant improvement from this approach.&#xA0; But we can do better, as we will see in our next post.</p>
        <a href="https://ayende.com/blog/160257/microsoft-patterns-practices-symposium-2013" target="_blank"><h1 class="title mb-6">Microsoft patterns &amp; practices Symposium 2013</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 10, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">A while ago I had to promise myself that I wouldn&#x2019;t be traveling so much (translated: all the time). Which is probably why I would not be in this event.  There are some quite interesting talks scheduled there. In particular, I would note:   CQRS presented by Greg Young&#xA0;&#x2013; I don&#x2019;t always agree with Greg, but it is always a pleasure to learn from him.  Embracing Async Programming presented by Chris Tavares&#xA0;&#x2013; Because you really need to learn all about how to use async properly and effectively.  Windows 8 JavaScript presented by Christopher Bennage&#xA0;&#x2013; Honestly, I&#x2019;ll go to this because I don&#x2019;t know anything about the topic in question.  Modern Architecture presented by Ted Neward &#x2013; Ted is a great guy, and he usually has a good way to looking at problems, generally at a wildly different angle that I would.</p>
        <a href="https://ayende.com/blog/160225/ravendb-1-0-hot-fix-release" target="_blank"><h1 class="title mb-6">RavenDB 1.0 Hot Fix release</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 07, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In has been a while since we released the last 1.0 build (960). In the meantime, we had done a lot of work on RavenDB to get it ready to 2.0. But we also maintained, fixed bugs and in general learned a lot from things that happened for people in production. Just before we release 2.0, we decided to create a hot fix release, which contains a lot of the bug fixes that went into the product as a result of actual production experience for our existing 1.0 customers. The bloody JSON.NET problem. The new hot fix build (992) uses Newtonsoft.Json 4.0.8. If you need to use the 4.5 version, you will need to either keep using build 975 or move to 2.0 (which resolved the problem completely). I am sorry about this, but there is really very little that we can do about it at this point.   Update: We had a problem in the studio in 990, so we fixed that in 992, please upgrade to that. Changes:  Transactions:   Will only try to delete transactions from my resource manager  Allowing multiple concurrent startups  Fixing transaction rollback error  Avoiding recovering transactions when EnlistInDistributedTransactions= false  Making sure we use the appropriate database, whatever it is the default one or not  Making sure that we can use the proper database when we recover from a failure using DTC  RavenDB-620 Ensure dealing with recovered transactions properly  Notify DTC about recovery completed AFTER we finish processing all the failed transactions  Moving the way we are handling storage of the recovery information Instead of storing and recovering on the server, we store / recover locally  Making sure that creating a transaction in parallel isn&#x27;t going to cause issues  RavenDB-529 NonAuthoritativeInformation does not consider the transaction timeout  Fixing an issue with local transaction identifier always being thought of as the same Replication:   Avoiding NRE during conflict resolution  Proper cleanup of the transactions  Making it possible to disable compression for replication (using Raven/Replication/DisableCompression config option). Useful if you need to replicate to an older version of RavenDB  Database:   Making sure that deletes are properly atomic in multi threading scenarios  Making sure that we can get an error on optimistic concurrency delete inside transaction using munin  Moving Munin to Snapshot isolation mode  Making sure that all of Munin operations run withing a Read context  Better safety using Munin  Proper handling of disposing of the database tasks Will handle failed dbs nicely  Make sure that we have safe shutdown sequence for transactional storage  Making sure that we will cleanup the write marker after we did the complete index cleanup  IIS:   Database initialization is not happening on a separate thread, so a request timeout should not cause it to die mid way  More robust disposal sequence  More robust init sequence, will force disposal of the resources created during the db ctor  Making sure that we play more nicely with the way ASP.Net calls us during app domain shut down  Making sure that we register to the TenantDatabaseModified.Occured from ASP.Net as well  Make sure that the idle timeout and the shutdown timeout were reasonable values for what we need during shutdowns Baring hot fixes for additional critical bugs, this is the last RavenDB 1.0 build</p>
        <a href="https://ayende.com/blog/160193/debugging-memory-issues-with-ravendb-using-windbg" target="_blank"><h1 class="title mb-6">Debugging memory issues with RavenDB using WinDBG</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 06, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We had gotten a database export that showed a pretty rough case for RavenDB. A small set of documents (around 7K) that fan out in multiple map/reduce indexes to be around 70K to 180K (depending of which index is used). As you can imagine, this puts quite a load on the system, I tried to use the usual methods (dotTrace, hand picking, etc) and we did get some good results on that, we found some pretty problematic issues along the way, and it was good. But we still had the RavenDB process take way too much memory. That means that we had to pull the big guns, WinDBG. I took a dump of the process when it was using about 1 GB of memory, then I loaded that dump into WinDBG (6.2.9200.20512 AMD64). I loaded SOS:  .loadby sos clr Then, the first thing to do was to try to see what is going on with the threads:  As you can see, we have a small number of threads, but nothing to write home about. The next step is to see if we have anything very big in the heap:  !dumpheap &#x2013;stat  The first number is the method table address, the second is the count, and the third is the total size. The problem is that all of that combine doesn&#x2019;t reach near as much memory as we take. I guess it is possible that we hold a lot of data in the stack, especially since the problem is likely caused by indexing. I decided to map all of the threads and see what they are doing.   Switches me to thread #1, and we can see that we are currently in a waiting. Dumping the stack reveals:  This seems to be the debugger thread. Let us look at the rest:  2 &#x2013; Finalizer 3 &#x2013; Seems to be an inactive thread pool thread. 6 &#x2013; appears to be an esent thread:I am not sure what this is doing, and I am going to ignore this for now. 7 &#x2013; also esent thread: And&#x2026; I got tired of this, and decided that I wanted to do something more productive, which is to selectively disable things in RavenDB until I find something that drops the memory usage enough to be worth while. Whack a mole might not be a great debugging tool, but it the essence of binary search. Or so I tell myself to make my conscience sleep more easily.&#xA0;  For reference, you can look at the dump file here.</p>
        <a href="https://ardalis.com/working-with-ivy-bridge-ultrabook-sensors/" target="_blank"><h1 class="title mb-6">Working with Ivy Bridge Ultrabook Sensors</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 05, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;ve had Intel&#x2019;s preview Ivy Bridge Ultrabook for a little over two months now. It&#x2019;s a preview device with a few pre-production quirks, but&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/160161/managing-ravendb-document-store-startup" target="_blank"><h1 class="title mb-6">Managing RavenDB Document Store startup</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: December 03, 2012
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The RavenDB&#x2019;s document store is your main access point to the database. It is strongly recommended that you&#x2019;ll have just a single instance of the document store per each server you are accessing. That usually means that you have to implement a singleton, with all the double checked locking nonsense that is involved in that. I was giving a course in RavenDB last week and I stumbled upon a very nice coding pattern: public static class Global&#xA;{&#xA;    private static readonly Lazy&lt;IDocumentStore&gt; theDocStore = new Lazy&lt;IDocumentStore&gt;(()=&gt;&#xA;        {&#xA;            var docStore = new DocumentStore&#xA;                {&#xA;                    ConnectionStringName = &quot;RavenDB&quot;&#xA;                };&#xA;            docStore.Initialize();&#xA;&#xA;            //OPTIONAL:&#xA;            //IndexCreation.CreateIndexes(typeof(Global).Assembly, docStore);&#xA;&#xA;            return docStore;&#xA;        });&#xA;&#xA;    public static IDocumentStore DocumentStore&#xA;    {&#xA;        get { return theDocStore.Value; }&#xA;    }&#xA;}&#xA;&#xA;&#xA;&#xA;This is a very readable code, and it handles pretty much all of the treading stuff for you, without obscuring what you really want to do.&#xA;And what about when you have multiple servers? How do you handle it then? Same idea, taken one step further:&#xA;public static class Global&#xA;{&#xA;    private readonly static ConcurrentDictionary&lt;string, Lazy&lt;IDocumentStore&gt;&gt; stores = &#xA;        new ConcurrentDictionary&lt;string, Lazy&lt;IDocumentStore&gt;&gt;();&#xA;    &#xA;    public static IDocumentStore GetDocumentStoreFor(string url)&#xA;    {&#xA;        return stores.GetOrAdd(url, CreateDocumentStore).Value;&#xA;    }&#xA;&#xA;    private static Lazy&lt;IDocumentStore&gt; CreateDocumentStore(string url)&#xA;    {&#xA;        return new Lazy&lt;IDocumentStore&gt;(() =&gt;&#xA;            {&#xA;                var docStore = new DocumentStore&#xA;                    {&#xA;                        ConnectionStringName = url&#xA;                    };&#xA;                docStore.Initialize();&#xA;&#xA;                //OPTIONAL:&#xA;                //IndexCreation.CreateIndexes(typeof(Global).Assembly, docStore);&#xA;&#xA;                return docStore;&#xA;            });&#xA;    }&#xA;}&#xA;&#xA;&#xA;This is nice, easy and the correct way to handle things.</p>
        <div class="button flex justify-between">
            <a href="360.html"><span class="back arrow"></span></a>

            <a href="362.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>