
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 455 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4541">
            <a href="https://ayende.com/blog/158530/nuget-perf-the-final-part-load-testing-the-tests" target="_blank">
                <h2 class="title mb-6" id="article-4541">NuGet Perf, The Final Part &#x2013; Load Testing &#x2013; The Tests</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 17, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">For the tests, we used VS 2012 load testing tool.&#xA;&#xA;&#x9;We defined the following tests:&#xA;&#xA;&#x9;Just browsing through the packages listing:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;Browsing a bit then searching, and then narrowing the search:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;And finally, searching a few packages by their id, tags, etc:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;I then defined the following load test:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;With the following distribution:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;Finally, we have the way we actually run the test:&#xA;&#xA;&#x9;&#xA;&#xA;&#x9;We get 20 seconds of warm up, then 5 minutes of tough load.&#xA;&#xA;&#x9;On my next post, we will see how we did.</p>
        </article>
        <article id="article-4542">
            <a href="https://ayende.com/blog/158529/nuget-perf-the-final-part-load-testing-setup" target="_blank">
                <h2 class="title mb-6" id="article-4542">NuGet Perf, The Final Part &#x2013; Load Testing &#x2013; Setup</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 17, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">So, after talking so long about the perf issues, here is the final part of this series. In which we actually take this for a spin using Load Testing.&#xA;&#xA;&#x9;I built a Web API application to serve as the test bed. It has a RavenController, which looks like this:&#xA;&#xA;&#x9;public class RavenController : ApiController&#xA;{&#xA;    private static IDocumentStore documentStore;&#xA;&#xA;    public static IDocumentStore DocumentStore&#xA;    {&#xA;        get&#xA;        {&#xA;            if (documentStore == null)&#xA;            {&#xA;                lock (typeof (RavenController))&#xA;                {&#xA;                    if (documentStore != null)&#xA;                        return documentStore;&#xA;                    documentStore = new DocumentStore&#xA;                        {&#xA;                            Url = &quot;http://localhost:8080&quot;,&#xA;                            DefaultDatabase = &quot;Nuget&quot;&#xA;                        }.Initialize();&#xA;                    IndexCreation.CreateIndexes(typeof (Packages_Search).Assembly, documentStore);&#xA;                }&#xA;            }&#xA;            return documentStore;&#xA;        }&#xA;    }&#xA;&#xA;    public IDocumentSession DocumentSession { get; set; }&#xA;&#xA;    public override async Task&lt;HttpResponseMessage&gt; ExecuteAsync(HttpControllerContext controllerContext, CancellationToken cancellationToken)&#xA;    {&#xA;        using (DocumentSession = DocumentStore.OpenSession())&#xA;        {&#xA;            HttpResponseMessage result = await base.ExecuteAsync(controllerContext, cancellationToken);&#xA;            DocumentSession.SaveChanges();&#xA;            return result;&#xA;        }&#xA;    }&#xA;}&#xA;&#x9;&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And now we have the following controllers:&#xA;&#xA;&#x9;public class PackagesController : RavenController&#xA;{&#xA;    public IEnumerable&lt;Packages_Search.ReduceResult&gt; Get(int page = 0)&#xA;    {&#xA;        return DocumentSession.Query&lt;Packages_Search.ReduceResult, Packages_Search&gt;()&#xA;            .Where(x=&gt;x.IsPrerelease == false)&#xA;            .OrderByDescending(x=&gt;x.DownloadCount)&#xA;                .ThenBy(x=&gt;x.Created)&#xA;            .Skip(page*30)&#xA;            .Take(30)&#xA;            .ToList();&#xA;    }&#xA;}&#xA;&#xA;public class SearchController : RavenController&#xA;{&#xA;    public IEnumerable&lt;Packages_Search.ReduceResult&gt; Get(string q, int page = 0)&#xA;    {&#xA;        return DocumentSession.Query&lt;Packages_Search.ReduceResult, Packages_Search&gt;()&#xA;            .Search(x =&gt; x.Query, q)&#xA;            .Where(x =&gt; x.IsPrerelease == false)&#xA;            .OrderByDescending(x =&gt; x.DownloadCount)&#xA;                .ThenBy(x =&gt; x.Created)&#xA;            .Skip(page * 30)&#xA;            .Take(30)&#xA;            .ToList();&#xA;    }&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;And, just for completeness sake, the Packages_Search index looks like this:&#xA;&#xA;&#x9;public class Packages_Search : AbstractIndexCreationTask&lt;Package, Packages_Search.ReduceResult&gt;&#xA;{&#xA;    public class ReduceResult&#xA;    {&#xA;        public DateTime Created { get; set; }&#xA;        public int DownloadCount { get; set; }&#xA;        public string PackageId { get; set; }&#xA;        public bool IsPrerelease { get; set; }&#xA;        public object[] Query { get; set; }&#xA;    }&#xA;&#xA;    public Packages_Search()&#xA;    {&#xA;        Map = packages =&gt; from p in packages&#xA;                          select new&#xA;                              {&#xA;                                  p.Created, &#xA;                                  DownloadCount = p.VersionDownloadCount, &#xA;                                  p.PackageId, &#xA;                                  p.IsPrerelease,&#xA;                                  Query = new object[] { p.Tags, p.Title, p.PackageId}&#xA;                              };&#xA;        Reduce = results =&gt;&#xA;                 from result in results&#xA;                 group result by new {result.PackageId, result.IsPrerelease}&#xA;                 into g&#xA;                 select new&#xA;                         {&#xA;                             g.Key.PackageId,&#xA;                             g.Key.IsPrerelease,&#xA;                             DownloadCount = g.Sum(x =&gt; x.DownloadCount),&#xA;                             Created = g.Select(x =&gt; x.Created).OrderBy(x =&gt; x).First(),&#xA;                             Query = g.SelectMany(x=&gt;x.Query).Distinct()&#xA;                         };&#xA;&#xA;        Store(x=&gt;x.Query, FieldStorage.No);&#xA;    }&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;That is enough setup, in the next post, I&#x2019;ll discuss the actual structure of the load tests.</p>
        </article>
        <article id="article-4543">
            <a href="https://ayende.com/blog/158273/questions-that-stumps-me" target="_blank">
                <h2 class="title mb-6" id="article-4543">Questions that stumps me</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 14, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">My response? &#x7121;</p>
        </article>
        <article id="article-4544">
            <a href="https://ayende.com/blog/158433/implementing-lru-cache" target="_blank">
                <h2 class="title mb-6" id="article-4544">Implementing LRU cache</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 13, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In my last post I mentioned that checking whatever a user is an administrator or not using Active Directory query can be slow. That means that we can just make use of that, we have to cache that. When caching is involved, we have to consider a few things. When do we expire the data? How much memory are we going to use? How do we handle concurrency? The first thing that pops to mind is the usage of MemoryCache, now part of the .NET framework and easily accessible. Sadly, this is a heavy weight object, it creates its own threads to manage its state, which probably means we don&#x2019;t want to use it for a fairly simple feature like this. Instead, I implemented the following: public class CachingAdminFinder&#xA;{&#xA;    private class CachedResult&#xA;    {&#xA;        public int Usage;&#xA;        public DateTime Timestamp;&#xA;        public bool Value;&#xA;    }&#xA;&#xA;    private const int CacheMaxSize = 25;&#xA;    private static readonly TimeSpan MaxDuration = TimeSpan.FromMinutes(15);&#xA;    private readonly ConcurrentDictionary&lt;SecurityIdentifier, CachedResult&gt; cache =&#xA;        new ConcurrentDictionary&lt;SecurityIdentifier, CachedResult&gt;();&#xA;&#xA;&#xA;    public bool IsAdministrator(WindowsIdentity windowsIdentity)&#xA;    {&#xA;        if (windowsIdentity == null) throw new ArgumentNullException(&quot;windowsIdentity&quot;);&#xA;        if (windowsIdentity.User == null)&#xA;            throw new ArgumentException(&quot;Could not find user on the windowsIdentity&quot;, &quot;windowsIdentity&quot;);&#xA;&#xA;        CachedResult value;&#xA;        if (cache.TryGetValue(windowsIdentity.User, out value) &amp;&amp; (DateTime.UtcNow - value.Timestamp) &lt;= MaxDuration)&#xA;        {&#xA;            Interlocked.Increment(ref value.Usage);&#xA;            return value.Value;&#xA;        }&#xA;        bool isAdministratorNoCache;&#xA;        try&#xA;        {&#xA;            isAdministratorNoCache = IsAdministratorNoCache(windowsIdentity.Name);&#xA;        }&#xA;        catch (Exception e)&#xA;        {&#xA;            log.WarnException(&quot;Could not determine whatever user is admin or not, assuming not&quot;, e);&#xA;            return false;&#xA;        }&#xA;        var cachedResult = new CachedResult&#xA;            {&#xA;                Usage = value == null ? 1 : value.Usage &#x2B; 1,&#xA;                Value = isAdministratorNoCache,&#xA;                Timestamp = DateTime.UtcNow&#xA;            };&#xA;&#xA;        cache.AddOrUpdate(windowsIdentity.User, cachedResult, (_, __) =&gt; cachedResult);&#xA;        if (cache.Count &gt; CacheMaxSize)&#xA;        {&#xA;            foreach (var source in cache&#xA;                .OrderByDescending(x =&gt; x.Value.Usage)&#xA;                .ThenBy(x =&gt; x.Value.Timestamp)&#xA;                .Skip(CacheMaxSize))&#xA;            {&#xA;                if (source.Key == windowsIdentity.User)&#xA;                    continue; // we don&#x27;t want to remove the one we just added&#xA;                CachedResult ignored;&#xA;                cache.TryRemove(source.Key, out ignored);&#xA;            }&#xA;        }&#xA;&#xA;        return isAdministratorNoCache;&#xA;    }&#xA;&#xA;    private static bool IsAdministratorNoCache(string username)&#xA;    {&#xA;       // see previous post&#xA;    }&#xA;}&#xA;&#xA;&#xA;Amusingly enough, properly handling the cache takes (much) more code than it takes to actually get the value.&#xA;We use ConcurrentDictionary as the backing store for our cache, and we enhance the value with usage &amp; timestamp information. Those come in handy when the cache grows too big and need to be trimmed. &#xA;Note that we also make sure to check the source every 15 minutes or so, because there is nothing as annoying as &#x201C;you have to restart the server for it to pick the change&#x201D;. We also handle the case were we can&#x2019;t get this information for some reason.&#xA;In practice, I doubt that we will ever hit the cache max size limit, but I wouldn&#x2019;t have been able to live with myself without adding the check .</p>
        </article>
        <article id="article-4545">
            <a href="https://ardalis.com/growing-object-oriented-software-guided-by-tests-book-review/" target="_blank">
                <h2 class="title mb-6" id="article-4545">Growing Object-Oriented Software Guided By Tests Book Review</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 12, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I finished this book a while back and just haven&#x2019;t had a chance to write about it until now. Growing Object-Oriented Software, Guided by&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4546">
            <a href="https://ayende.com/blog/158401/are-you-an-administrator" target="_blank">
                <h2 class="title mb-6" id="article-4546">Are you an administrator?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 12, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In RavenDB vNext, we tightened the security story a bit. Some operations that used to be possible for standard users are now administrator operations. For example, creating a new database require you to be admin. Figuring out whatever you are admin is a bit tough, though. In particular, we use the following logic to determine that:  If you logged in using OAuth, the credentials will tell us whatever you are admin or not. If you are logged in using Windows Auth, we make the following assumption:  If you are a Windows Admin, you are an administrator (ouch!). If you are running on the same user as the one RavenDB is using, you are an administrator (debug / dev scenarios). If you are running embedded, you are admin. You might have noticed that there is an &#x201C;ouch&#x201D; on the Windows Admin line. The reason for that is that it is actually quite hard to figure that one out. RavenDB is running as a web server, and when we use Windows Auth, we get a WindowsIdentity that we can use. The problem is with UAC. When that is turned on, what we get is the non elevated user. But that user is not an Admin in the Windows sense of the word. We don&#x2019;t actually care about that (it isn&#x2019;t like we need to impersonate the user), we just use that as a &#x201C;yes/no&#x201D; for certain ops. This is documented here: https://connect.microsoft.com/VisualStudio/feedback/details/679546/problem-with-windowsprincipal-isinrole-when-uac-is-enabled The resolution is by design.  So&#x2026; we need another way to check for this. Luckily, since we don&#x2019;t need impersonation, we can just check Active Directory for that. Here is how we do so: private static bool IsAdministratorNoCache(string username)&#xA;{&#xA;    PrincipalContext ctx;&#xA;    try&#xA;    {&#xA;        Domain.GetComputerDomain();&#xA;        try&#xA;        {&#xA;            ctx = new PrincipalContext(ContextType.Domain);&#xA;        }&#xA;        catch (PrincipalServerDownException)&#xA;        {&#xA;            // can&#x27;t access domain, check local machine instead &#xA;            ctx = new PrincipalContext(ContextType.Machine);&#xA;        }&#xA;    }&#xA;    catch (ActiveDirectoryObjectNotFoundException)&#xA;    {&#xA;        // not in a domain&#xA;        ctx = new PrincipalContext(ContextType.Machine);&#xA;    }&#xA;    var up = UserPrincipal.FindByIdentity(ctx, username);&#xA;    if (up != null)&#xA;    {&#xA;        PrincipalSearchResult&lt;Principal&gt; authGroups = up.GetAuthorizationGroups();&#xA;        return authGroups.Any(principal =&gt;&#xA;                              principal.Sid.IsWellKnown(WellKnownSidType.BuiltinAdministratorsSid) ||&#xA;                              principal.Sid.IsWellKnown(WellKnownSidType.AccountDomainAdminsSid) ||&#xA;                              principal.Sid.IsWellKnown(WellKnownSidType.AccountAdministratorSid) ||&#xA;                              principal.Sid.IsWellKnown(WellKnownSidType.AccountEnterpriseAdminsSid));&#xA;    }&#xA;    return false;&#xA;}&#xA;&#xA;&#xA;Here we check whatever the user is directly or indirectly and admin. Note that we have to take care of cases in which we are running inside &amp; outside a domain, as well as cases where the domain controller is down.&#xA;This works, but there is just one problem with that, it is sloooow. As in, multiple seconds slow. Even on the local machine without any domain involved.&#xA;I&#x2019;ll discuss how we solved that on my next post.</p>
        </article>
        <article id="article-4547">
            <a href="https://benfoster.io/blog/aspnet-web-api-compression/" target="_blank">
                <h2 class="title mb-6" id="article-4547">ASP.NET Web API Compression</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 12, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">How to compress and decompress your ASP.NET Web API responses, including support for GZip and Deflate encoding.</p>
        </article>
        <article id="article-4548">
            <a href="https://ardalis.com/a-gentle-introduction-to-structuremap/" target="_blank">
                <h2 class="title mb-6" id="article-4548">A Gentle Introduction to StructureMap</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 11, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I found myself explaining inversion of control containers and their benefits to someone today, and so I created a very simple console&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4549">
            <a href="https://ayende.com/blog/158369/on-professional-code" target="_blank">
                <h2 class="title mb-6" id="article-4549">On Professional Code</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 11, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Trystan made a very interesting comment on my post about unprofessional code:  I think it&#x27;s interesting that your definition of professional is not about SOLID code, infrastructure, or any other technical issues. Professional means that you, or the support staff, can easily see what the system is doing in production and why. It is a pretty accurate statement, yes. More to the point, a professional system is one that can be supported in production easily. About the most unprofessional thing that you can say is: &#x201C;I have no idea what is going on.&#x201D; Expanding on this, we have been paying a LOT of attention recently to production readiness. We can&#x2019;t afford not to. Just building the software is often just not enough for us. In many cases, if there is a problem, we can&#x2019;t just debug through the process. Either because reproducing the problem is too hard or because it happens at a client side with their own private data. Even more important than that, if we can give the ops team the tools to actually see what is going on within the system, we drastically reduce the number of support calls we have to take. Not to mention that software that actively support and help the ops team gets into the actual data center a lot faster and easier than software that doesn&#x2019;t. Sure, clean code is important, but production ready code is often not clean code. I read this a long time ago, and it stuck:  Back to that two page function. Yes, I know, it&#x27;s just a simple function to display a window, but it has grown little hairs and stuff on it and nobody knows why. Well, I&#x27;ll tell you why: those are bug fixes. One of them fixes that bug that Nancy had when she tried to install the thing on a computer that didn&#x27;t have Internet Explorer. Another one fixes that bug that occurs in low memory conditions. Another one fixes that bug that occurred when the file is on a floppy disk and the user yanks out the disk in the middle. That LoadLibrary call is ugly but it makes the code work on old versions of Windows 95. Each of these bugs took weeks of real-world usage before they were found. The programmer might have spent a couple of days reproducing the bug in the lab and fixing it. If it&#x27;s like a lot of bugs, the fix might be one line of code, or it might even be a couple of characters, but a lot of work and time went into those two characters. Some parts of the RavenDB code are ugly. HttpServer class, for example, goes on for over thousands lines of mostly error detection and recovery modes. But it works, and it allows us to inspect it on a running production server. That is important, and that make the separation from good code and production worthy code.</p>
        </article>
        <article id="article-4550">
            <a href="https://ayende.com/blog/158721/rule-out-the-stupid-stuff-first-select-still-aint-broken" target="_blank">
                <h2 class="title mb-6" id="article-4550">Rule out the stupid stuff first: Select still ain&#x2019;t broken</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: September 10, 2012
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">So, I sent a simple repro to the client and he reproduced the problem, and I was happy, because it ain&#x2019;t my problem. The good thing about sending a simple repro app to the client is that he can play with that easily, and that is how he discovered that it is my fault. In particular, it is all about the actual buffer size that we use. If we try to send a large dataset using 4KB buffer, it would take much longer than it would take using 128KB buffer. But only when using a real network, not when running locally. After looking at the matter for a while I figure it out. When using the default RavenDB builtin server, (based on the .NET HttpListener), it is actually flushing everything to the network card every time that you make a write. And there appears to be a non insubstantial cost of just doing that .I suspect that most of the cost is actually moving from user land to http.sys to do the work, but the problem was fairly clear. When you have an expensive resource like that, there is a solution for it, buffering. And luckily for us, the .NET framework comes with a BufferedStream.&#xA0; Sadly, it uses a single buffer, and we don&#x2019;t know ahead of time how much data we are going to write. Even more important, it creates its own buffers, about the only thing you can customize there is the buffer size. So sure, we can just wrap it in a Buffered Stream and set the buffer size to 128Kb and be done with it, right? Not quite so. The reason this is problematic is that this would allocate a buffer of 128Kb for every request, and buffers of that size goes to the Large Object Heap. Never mind that just allocating that much memory have its own performance issues. So, here is the problem. And the question is how we deal with in. There is a good solution for allocating a lot of memory and filling up the Large Object Heap, and that is to use the BufferManager that comes with the framework. I discussed this in this post. Next, we wrote a Buffer Pool Stream, which uses a buffer taken from a buffer manager. This resolve the problem of filling up the Large Object Heap, but it created another problem if for every request, we would use up a 128Kb buffer, that would means that we would use up a lot of memory that we probably don&#x2019;t need. Admittedly, even if we had a thousand concurrent requests, it would still amount to less than 130 MB, but that still bothers me. Instead, we took a different path. We use multiple buffers of fixed sizes (4Kb, 8Kb, 16Kb, 32Kb, 64Kb, 128Kb) to buffer the response, and we switch between them on demand. Here is how it works now:     Size  Buffers   &lt;= 8 Kb  4 Kb   &lt;= 28 Kb  8 Kb   &lt;=60 Kb  16 Kb   &lt;=124 Kb  32 Kb   &lt;= 252 Kb  64 Kb   &gt; 252 Kb  128 Kb For the first 8 Kb, we will use a 4 Kb buffer, then switch to an 8 Kb buffer until we get to 28 Kb, then 16 Kb buffer all the way to 60 Kb, etc. In our tests ,this strategy showed the best usage of time vs memory on both large and small requests. And we make sure to use big buffers only when we absolutely have to. The moral of the story, once you get your repro and see what is actually happening, dig a bit deeper. You might find some gold there. In our case, we optimize network traffic significantly when you are running in service / debug mode. This is very relevant for a very common scenario, downloading the silverlight xap for the management studio, which should improve quite a bit now .</p>
        </article>
        <div class="button flex justify-between">
            <a href="454.html"><span class="back arrow"></span></a>

            <a href="456.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
