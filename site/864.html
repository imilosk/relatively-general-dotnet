
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 864 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-8631">
            <a href="https://ayende.com/blog/1851/can-you-spot-the-joke" target="_blank">
                <h2 class="title mb-6" id="article-8631">Can you spot the joke?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 07, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Okay, so I highjacked the company&#x27;s job spot to put my job advertisement. I think that is is doing a much better job than a generic &quot;dotNet programmer with 2 year exp.&quot; You can see this here. (Suggestions are welcomed, by the way).    Anyway, there is a joke there, can you spot it?</p>
        </article>
        <article id="article-8632">
            <a href="https://ardalis.com/sqldependency-issue-resolved/" target="_blank">
                <h2 class="title mb-6" id="article-8632">SqlDependency Issue Resolved</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 06, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;m doublechecking my demos for my sessions at DevConnections this week and I think I finally fixed an issue that has plagued me off and on&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-8633">
            <a href="https://ayende.com/blog/1850/ajax-what-the-hell-is-the-buzz-all-about" target="_blank">
                <h2 class="title mb-6" id="article-8633">Ajax: What the hell is the buzz all about?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 05, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">So today I had used ajax functionality for the first time. By that I mean that I used Ajax as it should be use, to show a progress bar for a lengthy process (about 1 minute).    What I wanted is to load a page with a progress indicator, and at the same time, start the action in the server, when the results are ready (a grid), they would be sent to the client, which would replace the progress indicator with the gird. The current result set is about 5,000 items (expected to be aroudn 50 - 100 in production, though), so it should be pageable once it is calculated.    The upstream team is using atlas, so I decided to take a look at this. It took me about five - ten minutes to determain that to implement the functionality in atlas would take quite a bit of time, since I know nothing about atlas except that update panel doesn&#x27;t play nice with validation on my pages.    I briefly considered using prototype to handle the functionality, but that would mean bringing an additional server side functionality that I would have to deal with, which I am not thrilled about, or handle the call myself, which is not something that I have a particular wish to do. Therefor, I looked into ASP.Net 2.0 callbacks.    After reading a couple of articles, I began searching for the right progress indicator&#xA0;(I really like this one, but this one was the final choise), which took about 25 minutes. I then implemented ICallbackEventHandler and wrote the javascript functions that would replace the waiting indicator with the grid when it was done in another 30 minutes.    The most major issue that I had to deal with was that calculating the result is expensive, so it should be cached, but it is only valid for a single page visit. I decided to put the cache key in the view state, which would enable me to keep the calculation as long as the user remained on the page. (Basically, browsing through the data, not much more). But because the calculation is happening as the page is loading, it was neccecary to maintain the cache key when called from the callback (which doesn&#x27;t trasnfer view state, as far as I can tell).  There were some issues with the Page Lifecycle, of course, and you can&#x27;t just render a grid to string, you need to disable event validation at the page level (only using markup, not in code) or you will get null reference error. But I consider this life in the ASP.Net WebForms world.    Overall, including learning how to do this, it took about two hours, going from a white screen for a minute or so to fully featured ajaxified page. No external code except what is in ASP.Net 2.0 (I really wish that I could have used MonoRail, it has prototype and supporting framework already builtin, and no page lifecycle).    Ajax? Can you tell me why I, as a developer, should find it interesting?&#xA0;Sure, Gmail and the like are really nice. But interesting technology wise?&#xA0; I see a lot of cases where people are shoving Ajax into every little bit of the application (you are replacing the bottom half or the page, and the lower half of the page... and you do it with ajax... to avoid page refresh, I see...).    Building applications should be about usability, and you don&#x27;t get that by throwing indicators all over the place or making each and every text box auto complete.And to the buzzword-wize fellow out there, putting web 2.0 on your resume... put you on the direct path to marketing...</p>
        </article>
        <article id="article-8634">
            <a href="https://ayende.com/blog/1849/a-new-record" target="_blank">
                <h2 class="title mb-6" id="article-8634">A new record</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 05, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">For anyone who wonders why I consider 2Gb machines to be the bare minimum for development.</p>
        </article>
        <article id="article-8635">
            <a href="https://ayende.com/blog/1848/rhino-mocks-2-9-5-extending-rhino-mocks" target="_blank">
                <h2 class="title mb-6" id="article-8635">Rhino Mocks 2.9.5: Extending Rhino Mocks...</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 04, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After getting a request for implementing a feature that I don&#x27;t want to have in Rhino Mocks (very narrow scenario, very confusing semantics), I decided to follow my own advice and open up the API.&#xA;    In this case, it involved making MockRepository.CreateMockObject() and the MockRepository.CreateMockState delegate protected. Now, users of the library can extend it with their own recorders and replayers.&#xA;    Of course, using this require a bit of understanding of how Rhino Mocks Internals work. Basically, when Rhino Mocks is returning a type, its state is set to RecordMockState. This means that any call to the mock object will be recorded for later time. When Replay or ReplayAll are called, the mock state is queried for its next state.&#xA;    This architecture allows plugging in additional mock state, and cutomize behaviors as much as you wish. This was what enabled me to add dynamic mocks, and later on delegate mocks and partial mocks. Now this is opened for you, to do as you please. In 95% of the cases, I don&#x27;t think that you will need this, but it is good to have for the 5% chance.&#xA;    You can see an example of this extensability here.&#xA;    I also fixed BackToRecordAll(), making sure that it would erase all state from the mocked object, including when it is on the recording phase.&#xA;    A more radical change is that now Rhino Mocks will now throw when you try to verify whose expectations failed at some point. This is done to aid valid mocking when the code under test need to handle all exception cases, and so catch the ExpectationViolationException. I lost the mail that request this feature, so I am using this as a way to inform whom ever it was :-)&#xA;    As usual, code and source are here.&#xA;    Happy Mocking...</p>
        </article>
        <article id="article-8636">
            <a href="https://ayende.com/blog/1847/expertise-questions" target="_blank">
                <h2 class="title mb-6" id="article-8636">Expertise Questions</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 04, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Daniel is asking several good questions&#xA0;about experstise. Here are my answers:            Is it possible to be passionate without being a zealot?                Hm, I certainly hope so. I am passionate about many subjects, but I think that I am still able to listen to the other side and have a reasonable discussion.            If someone came up with something better than the .net framework, would you switch?        This is a really tough question. It would have to be something with an order of magnitude improvement over .Net, something like the switch from C&#x2B;&#x2B; to C#, in order to make me consider it for most of my activities. Right now, I don&#x27;t see it coming.        Beyond that, there is a big issue with abandoning knowledge. I know a lot about .Net, from how to do dynamic code generation to why you are allowed to do double locking to what is happening when you specify RegexOption.Compiled. I can read a stack trace and usually pinpoint the problem with ease. I wouldn&#x27;t be able to do that in another technology for a long time, and that is an important part of what makes me effective developer, that I know my environment. I&#x27;m not talking about just the API, I am talking that I am comportable editing msbuild / nant files, and that I have extensive knowledge of keyboard shortcuts, that I know how fusion loads an assembly, and how I can interfer with that. I can fuzz around with the internals of ASP.Net and AppDomain load issues with confidence.        Getting anywhere near this level of confidence is not something that is just going to happened.        There is a reason why I don&#x27;t label myself as Java / C&#x2B;&#x2B; guy. I know both language reasonably well. And I have a lot of experiance                 How much of your identity is bound to being a .net programmer?        Moo. The question cannot be answered within the given parameters. (I actually has an exception message that throws this.)        My identity has nothing to do to being a .net programmer. I am a developer that happens to be working on .Net. If I were to make a different decision several years ago you would have probably seen quite a lot of posts here about log4j and Hibernate, praising IntelliJ and writing Groovy DSL for Spring configurations :-)</p>
        </article>
        <article id="article-8637">
            <a href="https://ayende.com/blog/1846/demo-code-for-castle-forums-demo-app" target="_blank">
                <h2 class="title mb-6" id="article-8637">Demo Code for Castle Forums Demo App</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 04, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I figured that no one would find the link to the code if I just put it in the end (11 pages for a single post, wow!), so here it is.    You can get the sources here. Have fun!</p>
        </article>
        <article id="article-8638">
            <a href="https://ayende.com/blog/1845/building-applications-using-castle-rc2-part-ii" target="_blank">
                <h2 class="title mb-6" id="article-8638">Building Applications Using Castle RC2</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 04, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Last time I left we had a working data access layer, based on Active Record, as well as a scaffolding for editing users. We used TDD to drive the functionality of the application, and I intend to keep doing it this way while developing the functionality of the site itself.     Before we start by building the initial list of tests, let us consider what we want to achieve...     We want to have&#xA0;a forum system, so diplaying the forums, adding and browsing messages is very important, but managing users / forums is not a high priority, we can leave the users management on the scaffolding, and build the scaffolding for forums as well. Here is what we need to do to build the scaffolding for Forum:             [Layout(&quot;default&quot;), Rescue(&quot;generalerror&quot;), Scaffolding(typeof(Forum))]                        public class ForumController : SmartDispatcherController                        {                        }         And now we can access it at /forum/list.rails     One thing that I forgot to do before is to add the ActiveRecord HttpModule, which goes into the &lt;httpModules&gt; section in &lt;system.web&gt; element, like this:             &lt;add name=&quot;active-record&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;type=&quot;Castle.ActiveRecord.Framework.SessionScopeWebModule, Castle.ActiveRecord&quot; /&gt;         Now, let us see what kind of scenarios we want to support:             The homepage should display a list of all the forums, by name and id, with links to the forum page.                 There should be a text box where I can enter a forum id and go directly to it.                 A forum should display ten root messages, and be pagable.                 Can add a message to forum.                 Can reply to message.                 Messages appear in hierarchy.         When building tests for a MonoRail application, we have two options, we can do normal tests, which involve testing the data sent from the controller to the view, or integration tests, where we assert on the HTML output from the view. Let us start with the first test, asserting that the homepage controller pass the view a list of all forums. We start by building the test data in the test setup. But in order to do this, we need to setup Active Record.     In the previous installment, we already setup Active Record for the MonoRail application, but now we are calling Active Record from the tests, and that is in a different AppDomain. A word about the way MonoRail tests work. A MonoRail test basically host the ASP.Net runtime in a different AppDomain, which means that anything that goes between your test and the application is cross AppDomain boundaries. This is why we need to setup Active Record in both the tests and the MonoRail application, they are on different app domains. One word of caution, right now we have setup the MonoRail application so that it would recreate the database on startup, but we setup the database on test setup. This means that we need to remove the ActiveRecordStart.CreateSchema() from Application_OnStart.     I decided to do the setup in a test base class, like this:             public class AbstractMRWithARTestCase : AbstractMRTestCase                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; [SetUp]                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; public override void Initialize()                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ActiveRecordStarter.ResetInitializationFlag();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; IConfigurationSource source = ActiveRecordSectionHandler.Instance;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ActiveRecordStarter.Initialize(System.Reflection.Assembly.Load(&quot;Castle.Forums.Model&quot;), source);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ActiveRecordStarter.CreateSchema();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; base.Initialize();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        }         This initialize the framework, and then rebuild the database, so the tests are isolated.     Now, let us see the real setup code:             [SetUp]        public override void Initialize()        {        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; base.Initialize();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; User user = new User(&quot;Ayende&quot;, &quot;Ayende@example.org&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; user.SetPassword(&quot;Scott/Tiger&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; user.Create();                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Forum forum1 = new Forum(&quot;My Forum 1&quot;, user);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; forum1.Create();                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Forum forum2 = new Forum(&quot;My Forum 2&quot;, user);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; forum2.Create();                        }         Now, after all this, we can start creating the first real test, it goes like this:             [Test]                        public void IndexAction_PassAllForumsToView()                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DoGet(&quot;home/index.rails&quot;);                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertPropertyBagContains(&quot;forums&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Forum[] forums = (Forum[])Response.PropertyBag[&quot;forums&quot;];                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Assert.AreEqual(2, forums.Length);                                &#xA0;                        }         What does this do? Well, it asserts that the controller has passed two forums to the view. Running this test now will fail with this erro: Entry forums was not on PropertyBag     We have a red light! Let us make it green.&#xA0;We can make this test pass using this code:             public void Index()                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;forums&quot;] = Forum.FindAll();                        }         We run the code, and this time it is failing with another error, complaining that Forum is not a serializable type. This is an annoying side affect of the need to run ASP.Net in another AppDomain, everything that goes between the domains has to be serializable. This is an annoying limitation, and we are thinking about ways to fix this, but currently there isn&#x27;t a good way to do this, since the ASP.Net runtime creates its own AppDomain, and that is hard to change. So, we need to put [Serializable] on Forum, User and Message classes. I usually don&#x27;t like artificial test requirements, but this isn&#x27;t an onerous one, and there are valid reasons to want to do this anyway.     After making the model entities serializable, the test pass! Of course, if we go to the page, it doesn&#x27;t show anything, we need another test, one that would assert that the view is displaying the fourms:             [Test]                        public void IndexView_DisplayAllForums()                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DoGet(&quot;home/index.rails&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyContains(&quot;My Forum 1&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyContains(&quot;My Forum 2&quot;);                        }         Run and see it fails... Let us make this work. Go to the view, which is on the Castle.Forums.Web project, &quot;Views\Home\index.boo&quot;. We need to output the forums out, so let us do it simple as:             &lt;h2&gt;Forums List&lt;/h2&gt;                        &lt;ul&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;?brail for forum in forums: ?&gt;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;li&gt;${forum.Id} - ${forum.Name}&lt;/li&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;?brail end ?&gt;                                 &lt;/ul&gt;         Run the test again to make sure that it passes, and let us move on. We don&#x27;t have a list to each forum&#x27;s page, but this is because it doesn&#x27;t exists yet. So let us create it. I think that /forum/1/index.rails is a good place to put it, so let us create a ForumControllerTestCase class, for testing the new functionality. In the setup (which I will not show) we merely create a user, a forum and 50 messages (each with 2 reply messages). The root messages has names like Root 1 and&#xA0;Root 30, and their children names like Child 1.3 or Child 30.2, this is just so we can assert on them with ease.     Let us start by writing the test:             [Test]                        public void ForumController_PassAllRootMessagesToView()                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DoGet(string.Format(&quot;forum/{0}/index.rails&quot;, forumId));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertSuccess();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertPropertyBagContains(&quot;messages&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Message[] msgs = (Message[])Response.PropertyBag[&quot;messages&quot;];                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Assert.AreEqual(50,&#xA0; msgs.Length);                        }         Very similar to what we did before. Notice that forumId is the id of the forum we create previously. Now, to get the to pass we need to do quite a bit.     First, let us add an index method to ForumController:             public void Index(int forumId)                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Forum forum = Forum.Find(forumId);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;messages&quot;] = Message.FindAll(Expression.Eq(&quot;Forum&quot;, forum),                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Expression.IsNull(&quot;RootParent&quot;));                        }         Get the forum, and then get all the message for the forum, very simple. Note that this method is called by the MonoRail framework, and it has a parameter. This parameter is parsed by MonoRail from the request parameters (both query string and forms parameters are considered).     Considerring that the URL that we want to use has the format of &quot;/forum/1/index.rails&quot;, how can MonoRail understand that it should use the 1 as the parameter to the index? We can tell it so with the use of routing rules. A routing rule is merely a small piece of regex that transfrom one representation of the request URL to another.     You can configure routing using the &lt;monorail&gt;/&lt;routing&gt; element, by adding a rule:             &lt;rule&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;pattern&gt;/forum/(\d&#x2B;)/(.*)$&lt;/pattern&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;replace&gt;&lt;![CDATA[ /forum/$2?forumId=$1 ]]&gt;&lt;/replace&gt;                        &lt;/rule&gt;         We are simple replacing every reference to /forum/number/page with /forum/page?id=number. Now, MonoRail can translate the &quot;folder&quot; into the correct parameter. We are not done yet, we still need to create a view to show a forum&#x27;s listing. We need to create a a subdirectory under views &quot;Forum&quot;, which will contain all the forum&#x27;s views. Then, add an empty file called index.boo to it.     Now the test passes, but we have nothing in the view. Also, notice that we aren&#x27;t doing any paging yet.     Here is a test that assert that the page shows something, and that it is using paging:             [Test]                        public void ForumsView_ShowsOnlyFirstRootMessages()                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DoGet(string.Format(&quot;forum/{0}/index.rails&quot;, forumId));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyContains(&quot;Root 1&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyContains(&quot;Root 9&quot;);                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyDoesNotContain(&quot;Root 11&quot;);//that should be paged                        }         MonoRail has a feature called CachedPagination, which we are about to make use of. It means that we are going to need to change the controller code, and since the pagination is not serializable, so we need to restructure our tests first. Let us start with the code this time:             public void Index(int forumId)                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; string paginationCacheKey = string.Format(&quot;forum.{0}.messages&quot;, forumId);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DataObtentionDelegate getMessageForForum = delegate                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Forum forum = Forum.Find(forumId);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return Message.FindAll(Expression.Eq(&quot;Forum&quot;, forum), Expression.IsNull(&quot;RootParent&quot;));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; };                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; IPaginatedPage cachedPagination = PaginationHelper.CreateCachedPagination(paginationCacheKey,10,&#xA0;        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; getMessageForForum);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;messages&quot;] =&#xA0; cachedPagination;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;messages.TotalItems&quot;] = cachedPagination.TotalItems;                        }         What is going on? We create a cache key for the results, this should help reduce the amount of queries that we have in a big site, not really neccecary in our case, but it is so elegant that I can&#x27;t help it ;-) We pass a delegate to the method, which will be called when there is a cache miss to get the data. Then we put the resulting pagination and the total item count into it. Notice that I don&#x27;t need to specify which page I was working with, that is the responsability of the PaginationHelper.     I put the total count into the Flash so I could still test that I am getting the results from the controller. Since pagination is not serializble, I can no longer access PropertyBag, it can&#x27;t pass the AppDomain boundary. The first test now looks like this:             [Test]                        public void ForumController_PassAllRootMessagesToView()                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DoGet(string.Format(&quot;forum/{0}/index.rails&quot;, forumId));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertSuccess();                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertFlashContains(&quot;messages.TotalItems&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; int msgs = (int)Response.Flash[&quot;messages.TotalItems&quot;];                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Assert.AreEqual(50,&#xA0; msgs);                        }         Moving on to writing the view itself, it looks like this:             &lt;h2&gt;Messages:&lt;/h2&gt;                        &lt;table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Title:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Author:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;?brail for msg in messages: ?&gt;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ${msg.Title}                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ${msg.Author.Name}                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;?brail end ?&gt;                                 &lt;/table&gt;         Now, when we run the tests, everything pass. But we need to hanle paging as well. Currently we are just showing the first 10 rows. Here is a test that says we can page:             [Test]                        public void ForumsView_HasPaging_AndChangeDataOnPaging()                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DoGet(string.Format(&quot;forum/{0}/index.rails&quot;, forumId));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; //has next link                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyContains(&quot;&lt;a href=\&quot;/forum/index.rails?page=2&amp;amp;forumId=1&amp;amp;\&quot; &gt;next&lt;/a&gt;&quot;);                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DoGet(string.Format(&quot;forum/{0}/index.rails&quot;, forumId), &quot;page=3&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyContains(&quot;Root 20&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyContains(&quot;Root 29&quot;);                                &#xA0;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyDoesNotContain(&quot;Root 19&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; AssertReplyDoesNotContain(&quot;Root 31&quot;);                        }         This is fairly brute force way of doing this, but I can&#x27;t really this of a better way. Also, notice the way of passing query strings using DoGet(), if you try to concat strings to make&#xA0;a URL, it won&#x27;t work. Anyway, we need paging, we are likely going to want to do this in more than one view since paging is a cross cutting concerns. We are going to utilize the CommonScripts functionality of Brail to get this. Add a subfolder called CommonScripts to the Views folder, and create a file called Paging.boo:             import Castle.MonoRail.Framework.Helpers                        import System.Text                        import System.Collections                                &#xA0;                        def Pagination(paginationHelper as PaginationHelper,                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; items as IPaginatedPage,                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; htmlAttributes as IDictionary,                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; querySting as IDictionary):                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output = StringBuilder()                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append(&quot;&quot;&quot;&lt;div class=&quot;pagination&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;table width=&quot;100%&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0; border=&quot;0&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Showing ${items.FirstItem} - ${items.LastItem} of ${items.TotalItems}&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td align=&quot;right&quot;&gt;&quot;&quot;&quot;)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if items.HasFirst:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( paginationHelper.CreatePageLink( 1, &quot;first&quot;,htmlAttributes, querySting )&#xA0; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( &quot;first&quot; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; end                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( &quot; | &quot; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if items.HasPrevious:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( paginationHelper.CreatePageLink( items.PreviousIndex, &quot;prev&quot;,htmlAttributes, querySting )&#xA0; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( &quot;prev&quot; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; end                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( &quot; | &quot; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if items.HasNext:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( paginationHelper.CreatePageLink( items.NextIndex, &quot;next&quot;,htmlAttributes, querySting ) )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( &quot;next&quot; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; end                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append(&#xA0; &quot; | &quot; )                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if items.HasLast:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append(&#xA0; paginationHelper.CreatePageLink( items.LastIndex, &quot;last&quot;,htmlAttributes, querySting ) )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append(&#xA0; &quot;last&quot; )                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; end                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output.Append( &quot;&quot;&quot;&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/table&gt;                        &lt;/div&gt;&quot;&quot;&quot;)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return output.ToString()                        end         This looks like a lot of code, but it isn&#x27;t doing much, actually. Just outputing the pagination html. Notice that we can specify the query string and the html attributes. Now, we can just append this at the bottom of the views:             &lt;?brail                                 output Pagination( PaginationHelper, messages, null, { &quot;forumId&quot; : forumId} )                                 ?&gt;         Now run the tests, assure that they are passing, and then browse to the site and see what your easy work has gained you :-) I&#x27;m not going to write more tests, by this time, you should be able to do this yourself, and they clutter the tutorial. By this point, I think that I have shown how easy it is to write tests for MonoRail.     Now that we have a way of showing the forum&#x27;s messages, we can add a link from the home page to the forum&#x27;s page, and then we are done with the first scenario, this can be done as simply as:             &lt;li&gt;${forum.Id} - &lt;a href=&quot;/forum/${forum.Id}/index.rails&quot;&gt;${forum.Name}&lt;/a&gt;         Now we finished with the first scenario, the second one calls for a text box that allows a quick access to the forum&#x27;s page by its id. It turns out that we have to change only the view to make this happen, just adding this to /home/index.boo:             &lt;div style=&quot;text-align: right;&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;form action=&quot;/forum/index.rails&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Go to forum #                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;input type=&quot;text&quot;&#xA0;name=&quot;forumId&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;input type=&quot;submit&quot; value=&quot;Go!&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/form&gt;                        &lt;/div&gt;         How this works? Remember that the ForumController.Index() method accept an integer? This simply sends it to it. MonoRail doesn&#x27;t care if how we pass the value, it does the Right Thing :-D     But, this raise the question of input validation. We now have input from the user, and they are very good in putting the wrong data just to spite me.     Looking at this, I can see three edge-cases:             Entering an id that doesn&#x27;t belong to a forum.                 Not entering anything.                 Entering a non-numeric value.         Let us protect ourself from the first case:             public void Index(int forumId)                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Forum forum = Forum.TryFind(forumId);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if(forum==null)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;ForumId&quot;] = forumId;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderView(&quot;NoSuchForum&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; string paginationCacheKey = string.Format(&quot;forum.{0}.messages&quot;, forumId);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; DataObtentionDelegate getMessageForForum = delegate                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return Message.FindAll(Expression.Eq(&quot;Forum&quot;, forum), Expression.IsNull(&quot;RootParent&quot;));                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; };                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; IPaginatedPage cachedPagination = PaginationHelper.CreateCachedPagination(paginationCacheKey,10,                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; getMessageForForum);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;messages&quot;] =&#xA0; cachedPagination;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Flash[&quot;messages.TotalItems&quot;] = cachedPagination.TotalItems;                        }         We simply add a check to ensure that the forum exists. In both cases, we show a view that simply says: (Views\Forum\NoSuchForum.boo)             &lt;h2&gt;No Such Forum&lt;/h2&gt;                        &lt;p&gt;                        Could not find a forum with id ${ForumId}                        &lt;/p&gt;         This still doesn&#x27;t handle the last case, where the user pass a non-numeric data. How would we handle this? We can try to catch an error from the framework when it is trying to convert the value to integer, and handle that, but that is not an elegant solution in my opinion. A much more elegant solution is to think about it this way, an invalid integer value is a string, and MonoRail actually supports overloading, so... here is how we handle the other two cases:             public void Index(string forumId)                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if (string.IsNullOrEmpty(forumId))                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;ForumId&quot;] = &quot;null / empty&quot;;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; else                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;ForumId&quot;] = forumId;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderView(&quot;NoSuchForum&quot;);                        }         Now MonoRail will do the right thing, and call our Index(int) if the value can be converted to integer, and call Index(string) if it can&#x27;t. We moved our error handling outside the method, not it is much easier to read and work with. Also, we are reusing the UI, the NoSuchForum view is being used by two actions on the controller. That is something that is usually harder to do (in terms of the setup require to make the code reusable), isn&#x27;t it? A word of caution, this behavior is currently dependant on source code orderring, which I consider a bug. This mean that the Index(int) method should come before Index(string) method for it to be considered.     Forth scenario, we need to be able to add messages to a forum. Let us extend the forum/index view to handle this. I think that I want to use a drop of ajax for this, so we need to add this to Views\Layouts\default.boo, somewhere on the &lt;head&gt;:              ${AjaxHelper.GetJavascriptFunctions()}             This makes sure that prototype&#xA0;is setup appropriately. Now, we can just append this at the end:             &lt;p&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ${ AjaxHelper.LinkToFunction(&#x27;Post new message...&#x27;, &#x27;$(newMsg).toggle()&#x27;) }                        &lt;/p&gt;                        &lt;div id=&quot;newMsg&quot;&#xA0; class=&quot;postNewMsg&quot; style=&quot;display: none;&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;form method=&quot;POST&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Title:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;&lt;input name=&quot;msg.Title&quot; type=&quot;text&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Author Id:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;&lt;input name=&quot;msg.Author.Id&quot; type=&quot;text&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Content:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td colspan=&quot;2&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;textarea name=&quot;msg.Content&quot; rows=&quot;10&quot; cols=&quot;50&quot;&gt;&lt;/textarea&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;input type=&quot;submit&quot; value=&quot;Post new message&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/form&gt;                        &lt;/div&gt;                         This just add a link that when press, will show the add new post form. I am asking the user for its ID, and that isn&#x27;t really nice, but I don&#x27;t want to get into authentication, that is not the purpose of this post. Here is the code that handles the actual saving of the message:             public void PostMsg([DataBind(&quot;msg&quot;)] Message msg)                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; msg.Create();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; string paginationCacheKey = string.Format(&quot;forum.{0}.messages&quot;, msg.Forum.Id);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Context.Cache.Remove(paginationCacheKey);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; CancelView();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Response.Redirect(string.Format(&quot;/Forum/Index.rails?forumId={0}&quot;, msg.Forum.Id));                        }                         How did it do that? I hear you asking. Well, it is utilizing a very smart behavior on the side of MonoRail. If you look closely, you&#x27;ll notice that I naming the input fields in the form (and the query string) with an object notation. &quot;msg.Forum.Id&quot;, for instnace. Then, all I need to do is to tell MonoRail how it show build this type for me. Note that you do need to ensure that the values are correct. Trying to input &quot;abc&quot; in the Author Id will fail, but those checks are fairly easy to do. And it puts you on the &quot;we can see the results&quot; path a lot quicker.     After creating the new message, I clear the cache for this forum, and redirect to the main page. So, we have only two more scenarios to go (That is assuming that you are still reading this, of course).     Let us start by showing how we can display hierarchical data. We need to get all the root messages, and all their children, and so on. But right now we don&#x27;t have a way to get from a Message to its children, or from a root message to all its hierarchy. Seems like we have a problem in the model (let us call a meeting).     After thinking about it, I decided that the following properties need to be added:             [HasMany(typeof(Message), &quot;Parent&quot;, &quot;Message&quot;)]                        public ISet Children                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get { return children; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; set { children = value; }                        }                                &#xA0;                        [HasMany(typeof(Message), &quot;RootParent&quot;, &quot;Message&quot;)]                        public ISet Hierarchy                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get { return hierarchy; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; set { hierarchy = value; }                        }                         And, the Parent needs to be modified slightly:            [BelongsTo]                        public Message Parent                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; get { return parent; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; set                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; parent = value;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if(parent==null)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RootParent = parent.RootParent ?? parent;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        }                        This is done to ensure that the RootParent is set properly in databinding scenarios. Now we can build the controller&#x27;s action:            public void MessageDetails(int messageId)                        {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;                                 &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; SimpleQuery&lt;Message&gt; simpleQuery = new SimpleQuery&lt;Message&gt;(                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; @&quot;from Message msg left join fetch msg.Hierarchy where msg.Id = ?&quot;,                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; messageId);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Message[] messages = simpleQuery.Execute();                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if(messages.Length==0)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; {                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;MessageId&quot;] = messageId;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; RenderView(&quot;NoSuchMsg&quot;);                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; return;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; }                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; PropertyBag[&quot;message&quot;] = messages[0];                        }                        Now you may begin to see what is the value in the RootParent, it allows us to pull all the message hierarchy efficently. We get it from the database, check that the value exists in the database, and then populate the PropertyBag with the value. Now, to the view, which is a little complicated:            &lt;?brail                                 import System.Text                        import System.Collections                                &#xA0;                        def Messages(messages as ICollection):                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output &quot;&lt;ul&gt;&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; for msg in messages:                        ?&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;li&gt;Title: ${msg.Title}&lt;br/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Author:&#xA0; ${msg.Author.Name}&lt;br/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ${msg.Content}&lt;/li&gt;&lt;br/&gt;&quot;&quot;&quot;                                &#xA0;                        &lt;?brail output AjaxHelper.LinkToFunction(&#x27;Post reply...&#x27;, &quot;$(&#x27;newMsg.${msg.Id}&#x27;).toggle()&quot;) ?&gt;                        &lt;div id=&quot;newMsg.${msg.Id}&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; class=&quot;postNewMsg&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; style=&quot;display: none;&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;form method=&quot;POST&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0;action=&quot;/forum/postMsg.rails?msg.Forum.Id=${message.Forum.Id}&amp;msg.Parent.Id=${msg.Id}&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Title:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;&lt;input name=&quot;msg.Title&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0; type=&quot;text&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Author Id:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;&lt;input name=&quot;msg.Author.Id&quot;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &#xA0; type=&quot;text&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;Content:&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td&gt;&lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;td colspan=&quot;2&quot;&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;textarea name=&quot;msg.Content&quot; rows=&quot;10&quot; cols=&quot;50&quot;&gt;&lt;/textarea&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/td&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/tr&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/table&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;input type=&quot;submit&quot; value=&quot;Post new message&quot;/&gt;                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; &lt;/form&gt;                        &lt;/div&gt;                        &lt;?brail                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; if msg.Children.Count &gt;0:                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; Messages(msg.Children)                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; end                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; end                        &#xA0;&#xA0;&#xA0;&#xA0;&#xA0; output &quot;&lt;/ul&gt;&quot;                        end                        ?&gt;                        &lt;h2&gt;Message ${message.Id}&lt;/h2&gt;                        Title: ${message.Title}&lt;br/&gt;                        Author:&#xA0; ${message.Author.Name}&lt;br/&gt;                        ${message.Content}                                &#xA0;                        &lt;?brail&#xA0; Messages( message.Children ) ?&gt;                        Most of this is HTML, though. What is happening is that we output the first message, and then recursively all its children, with a reply link that will open in place. This seems to the end of it, we have finished implementing all the scenarios.Wow, that took a lot of time to write. I usually manage to finish those in a few hours, but this took several days. I hope that I managed to show you a bit of how you can use Castle to make your life easier.This is not a real application, it is not even a pretty demo. I focused mainly on try to shed some light into what Castle can do for you. Of the top of my head, this application need&#xA0;a lot more UI, a bit more error handling, but seems to be it.It is already well structured and it is well tested. Very good points to start with. :-)</p>
        </article>
        <article id="article-8639">
            <a href="https://ayende.com/blog/1844/what-i-find-exciting-part-ii" target="_blank">
                <h2 class="title mb-6" id="article-8639">What I find exciting, part II</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 04, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I am not sure if I should feel this way, but I just finished writing a paged table in MonoRail, and that brought a complete sense of satisfaction. No, it isn&#x27;t a major techincal challange. :-) It is just that I know,all the up and all the way down, what is going on, and I wholly approve. More and more I find how important it is to control as much as possible of the stack as possible.    If I try to constract the code required to handle the full &quot;get from the database, show paged view on form&quot; functionaly in ASP.Net WebForms &#x2B; DataSet (the &quot;default&quot; ASP.Net architecture) vs. MonoRail &#x2B; Active Record, I find that I get about the same line count, but the functionality offered is greater (custom paging doesn&#x27;t require a chicken, for instnace), and there isn&#x27;t magic stuff going on that I can&#x27;t get into (view state, data binding).    The amount of flexibility that I have when working with the MR &#x2B; AR stack is far greater. Moreover, I find that I don&#x27;t feel that I am hacking when I am using MonoRail. All too often I need to do something a bit out of line in WebForms, and then I find that I need to write hackish code (e.Cells[12].FindControl(&quot;lnkDelete&quot;).Enabled = UserHasPermission; is hackish, and not maintainable).    The mere fact that I can look at code that does paging and say: &quot;You know, this is really cool.&quot; speaks for itself, I think.</p>
        </article>
        <article id="article-8640">
            <a href="https://ayende.com/blog/1843/brail-code-formatting" target="_blank">
                <h2 class="title mb-6" id="article-8640">Brail Code Formatting</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: November 03, 2006
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I mentioned before that I tend to edit Brail&#x27;s source in #Develop, since it has native support for Boo. I finally decided that just using Boo&#x27;s color scheme is not enough, and created one specific for Brail.This scheme is merely HTML &#x2B; Boo, where code sections are marked with &lt;?brail ?&gt;The coloring schema is attached to this message.Brail.zip (3.53 KB)Now if only it were as simple to do this for Visual Studio....</p>
        </article>
        <div class="button flex justify-between">
            <a href="863.html"><span class="back arrow"></span></a>

            <a href="865.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
