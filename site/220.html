
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 220 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-2191">
            <a href="https://ayende.com/blog/183073-C/i-wont-have-order-looking-at-search-libraries-without-ordering" target="_blank">
                <h2 class="title mb-6" id="article-2191">I won&#x2019;t have order: Looking at search libraries without ordering</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 31, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">For my needs, I&#x2019;m mostly interesting in being able to under this type of query:from Userswhere City = &#x2018;London&#x2019;order by LastLoginI already looked at a few of these, as you can see in past posts. However, as I was trawling through the internet (or, more precisely, though various GitHub projects) I found quite a few search libraries that don&#x2019;t have ordering support.For example:TrinityTanvityRiotWhy would anyone build such a system? Isn&#x2019;t order by important? Well, yes and no. In practice, all the libraries I found that skip explicit order by do that for a few good reasons. First, they are focused on IR (information retrieval) rather than queries. In other words, they all absolutely do ordering, but they do that based on how closely they were able to match the results to your query. For such a system, sorting by a different field is not meaningful. You want to have the most relevant results. The other reason is that ordering by a arbitrary field, unrelated to the query, is tough. You have to explicitly keep track of additional information to be able to do that. IR is already complex enough, and in many cases, what you are searching on is a huge corpus of unstructured (at best, semi structured) data. You can&#x2019;t afford the cost of tracking more data or the time to try to sort potentially many millions of results.</p>
        </article>
        <article id="article-2192">
            <a href="https://ayende.com/blog/183042-C/i-will-have-order-how-bleve-sorts-query-results" target="_blank">
                <h2 class="title mb-6" id="article-2192">I WILL have order</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 30, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In the previous post, I looked into the Bleve search engine library. Now, I want to go into the codebase and answer a simple question. How does Bleve handles sorting of queries. Here is my code:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          query := NewMatchQuery(&quot;&quot;)&#xA;        &#xA;        &#xA;          &#xA;          searchRequest := NewSearchRequest(query)&#xA;        &#xA;        &#xA;          &#xA;          searchRequest.SortBy([]string{&quot;State&quot;, &quot;City&quot;})&#xA;        &#xA;        &#xA;          &#xA;          searchResults, err := exampleIndex.Search(searchRequest)&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          bleve.search.go&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;During the search process, we have visitor defined:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          hc.updateFieldVisitor = func(field string, term []byte) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if hc.facetsBuilder != nil {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;hc.facetsBuilder.UpdateVisitor(field, term)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          &#x9;hc.sort.UpdateVisitor(field, term)&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          bleve.collect.go&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;This is called on every field (and term value) that is found in the query (it looks like only the relevant ones are touched, but that is still a lot). Eventually, this gets here:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          type SortField struct {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Field   string&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Desc    bool&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Type    SortFieldType&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Mode    SortFieldMode&#xA;        &#xA;        &#xA;          &#xA;          &#x9;Missing SortFieldMissing&#xA;        &#xA;        &#xA;          &#xA;          &#x9;values  [][]byte&#xA;        &#xA;        &#xA;          &#xA;          &#x9;tmp     [][]byte&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          func (s *SortField) UpdateVisitor(field string, term []byte) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;if field == s.Field {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;s.values = append(s.values, term)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          func (s *SortField) Value(i *DocumentMatch) string {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;iTerms := s.filterTermsByType(s.values)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;iTerm := s.filterTermsByMode(iTerms)&#xA;        &#xA;        &#xA;          &#xA;          &#x9;s.values = s.values[:0]&#xA;        &#xA;        &#xA;          &#xA;          &#x9;return iTerm&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          bleve.sortfield.go&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;At this point, we can see that we basically gather a list of of all the terms in the values field inside the UpdateVisitor. This is important, because we are later going to rely on the same order of iteration, as you can see in the Value call. Even though there is a DocumentMatch being passed there, it isn&#x2019;t actually being used. Instead, it always take the first element in the values.This is called on a per document level, so there is an expectation that the values will be smaller. On the other hand, during the sorting process, we&#x2019;ll merge it all into a single location per document, as you can see:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          func (so SortOrder) Value(doc *DocumentMatch) {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;for _, soi := range so {&#xA;        &#xA;        &#xA;          &#xA;          &#x9;&#x9;doc.Sort = append(doc.Sort, soi.Value(doc))&#xA;        &#xA;        &#xA;          &#xA;          &#x9;}&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          bleve.get.sort.fields.vals.go&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;In other words, the doc.Sort is going to end up with an array of the values that we want to sort by. At this point, sorting is done by maintaining a heap and pushing values to it until we get the top N elements. Pretty simple overall.It also allocates quite heavily, with arrays, slices and strings. I don&#x2019;t have a good feeling for where it actually will be a problem in Go, but it is something to consider. In C#, I would be very worried about the eventual costs of all of these allocations.</p>
        </article>
        <article id="article-2193">
            <a href="https://ayende.com/blog/183041-C/reviewing-the-bleve-search-library" target="_blank">
                <h2 class="title mb-6" id="article-2193">Reviewing the Bleve search library</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 29, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Bleve is a Go search engine library, and that means that it hit a few good points with me. It is interesting, it is familiar ground and it is in a language that I&#x2019;m not too familiar with, so that is a great chance to learn some more.I reviewed revision: 298302a511a184dbab2c401e2005c1ce9589a001I like to start with reading from the bottom up, and in this case, the very first thing that I looked at was the storage level. Bleve uses a pluggable storage engine and currently has support for:BoltDBLevelDBMossIn memory treeThis is interesting, if only because I put BoltDB and Moss on my queue of projects to read.The actual persistent format for Bleve is very well document here. Which make it much easier to understand what is going on. The way Bleve uses the storage, it has a flat key/value store view of the world, as well as needing prefix range queries. Nothing else is required. Navigating the code is a bit hard for me as someone who isn&#x2019;t too familiar with Go, but the interesting things start here, in scorch.go (no idea why this is called scorch, though).We get a batch of changes, and run over them, adding an _id field to the document. So far, pretty simple to figure out. The next part is interesting:You can see that we are running in parallel here, starting the analysis work and queuing it all up. Bleve then wait for the analysis to run. I&#x2019;ll dig a bit deeper into how that work in a bit, first I want to understand how the whole batch concept work.So that tells us some interesting things. First, even though there is the concept of a store, there is also this idea of a segment. I&#x2019;m familiar with this from Lucene, but there it is tied very closely to the on disk format. Before looking at the analysis, let&#x2019;s look at this concept of segments.The &#x201C;zap&#x201D; package, in this term, seems to refer to the encoding that is used to store the analysis results. It looks like it is running over all the results of the batch and write them into a single binary value. This is very similar to the way Lucene works so far, although I&#x2019;m still confused about the key/value store. What is happening is that after the segment is created, it is sent to prepareSegment. This eventually send it to a Go channel that is used in the Scortch.mainLoop function (which is being run as a separate thread).Here is the relevant code:The last bit is the one that is handling the segment introduction, whatever that is. Note that this seems to be strongly related to the store, so hopefully we&#x2019;ll see why this is showing up here. What seems to be going on here is that there is a lot of concurrency in the process, the code spawns multiple go funcs to do work. The mainLoop is just one of them. The persisterLoop is another as well as the mergerLoop. All of which sounds very much like how Lucene works.I&#x2019;m still not sure how this is all tied together. So I&#x2019;m going to follow just this path for now and see what is going on with these segments. A lot of the work seems to be around managing this structure:The Segment itself is an interface with the following definition:There are go in memory and mmap versions of this interface, it seems. So far, I&#x2019;m not following relation between the storage interface and this segments idea. I think that I&#x2019;m lost here so I&#x2019;m going to go a slightly different route. Instead of seeing how Bleve write stuff, let&#x2019;s focus on how it reads. I&#x2019;ll try to follow the path of a query. This path of inquiry leads me to this guy:Again, very similar to Lucene. And the TermFieldReader is where we are probably going to get the matches for this particular term (field, value). Let&#x2019;s dig into that. And indeed, following the code for this method leads to the inverted index, called upside_down in this code. I managed to find how the terms are being read, and it makes perfect sense, exactly as expected, it does a range query and parses both key and values for the relevant values. Still not seeing why there is the need for segments.And here is where things start to come together. Bleve uses the key/value interface to store some data that it searches on, but document values are stored in segments, and are loaded directly from there on demand. At a glace, it looks like the zap encoding is used to store values in chunks. It looks like I didn&#x2019;t paid attention before, but the zap format is actually documented and it is very helpful. Basically, all the per document (vs. per term / field) data is located there, as well as a few other things. I think that this is were I&#x2019;ll stop. The codebase is interesting, but I now know enough to have a feeling how things work. Some closing thoughts:Really good docs.I didn&#x2019;t use my usual &#x201C;read the project in lexical file order&#x201D; to figure out things, and I had a hard time navigating the codebase because of that. Probably my lack of Go chops. There seems to be a lot more concurrency for stuff that I would usually assume be single threaded than I&#x2019;m used to. I&#x2019;m aware that Go has builtin concurrency primitives and it is more common to use there, but it seems strange to see. As consume of search libraries, I&#x2019;m not sure that I&#x2019;m happy about this. I like to control my threading behaviors. It seems that a lot of the data is held in memory (mmap) but in a format that requires work to handle or in the key/value store, but again, in a format that require work. The problem with work is that you have to do it each and every time. I&#x2019;m used to Lucene (read it once from disk and keep a cached version in memory that is very fast) or Voron, in which the data is held in memory and can be access with zero work.I didn&#x2019;t get to any of the core parts of the library (analysis, full text search). This is because they aren&#x2019;t likely to be that different and they are full of the storage interaction details that I just went over.</p>
        </article>
        <article id="article-2194">
            <a href="https://andrewlock.net/pushing-nuget-packages-built-in-docker-by-running-the-container/" target="_blank">
                <h2 class="title mb-6" id="article-2194">Pushing NuGet packages built in Docker by running the container</h2>
            </a>
            <p class="mb-2">by Andrew Lock</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 29, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I show how to create a Dockerfile for building your NuGet packages which you can then run as a container to push them to a NuGet feed.&#x2026;</p>
        </article>
        <article id="article-2195">
            <a href="https://ayende.com/blog/183010-C/i-will-have-order-how-noise-sorts-query-results" target="_blank">
                <h2 class="title mb-6" id="article-2195">I WILL have order</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 28, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">After looking at Lucene, the next library that I looked at is the Noise search project. This is a Rust library that is sitting on top of RocksDB. It has a very different model internally than Lucene. You can read a full review I made for this project a while ago.At any rate, what we are looking at here is this code:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;           #[test]&#xA;        &#xA;        &#xA;          &#xA;          fn test_basic() {&#xA;        &#xA;        &#xA;          &#xA;              let dbname = &quot;target/tests/basic&quot;;&#xA;        &#xA;        &#xA;          &#xA;              let _ = Index::drop(dbname);&#xA;        &#xA;        &#xA;          &#xA;              let mut batch = Batch::new();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let mut index = Index::open(dbname, Some(OpenOptions::Create)).unwrap();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let id1 = index.add(r#&quot;{&quot;State&quot;:&quot;TX&quot;,&quot;City&quot;:&quot;Dallas&quot;}&quot;#, &amp;mut batch).unwrap();&#xA;        &#xA;        &#xA;          &#xA;              let id2 = index.add(r#&quot;{&quot;State&quot;:&quot;TX&quot;,&quot;City&quot;:&quot;Austin&quot;}&quot;#, &amp;mut batch).unwrap();&#xA;        &#xA;        &#xA;          &#xA;              let id3 = index.add(r#&quot;{&quot;State&quot;:&quot;NY&quot;,&quot;City&quot;:&quot;New York&quot;}&quot;#, &amp;mut batch).unwrap();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              index.flush(batch).unwrap();&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              let mut results = index.query(r#&quot;find order State, City&quot;#, None).unwrap();&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          noise.ordering.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;The question here is how are we going to be sorting these results. Digging into the code, ordering is a bit complex to figure out, but I think I got it. The way Noise work, it writes the following values to RocksDB:W.City!Austin#2W.City!Dallas#1W.City!New York#3W.State!NY#3W.State!TX#1W.State!TX#2These are the values of the relevant documents. I&#x2019;m ignoring the filtering part of the query, because that isn&#x2019;t relevant to what I&#x2019;m trying to find. This piece of code is what actually handles the ordering during query retrieval. Notice that this is done in a buffered manner, which is interesting. Let&#x2019;s go and look at the actual do_ordering_and_ags method. This is a pretty large method, and the relevant piece has about 75 lines of pretty complex logic around how to keep the top N results based on the ordering of the query.The key part there is that comparing any two results in done using the following code:This ends up being here:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          fn cmp_results(orders: &amp;Vec&lt;(Order, usize)&gt;,&#xA;        &#xA;        &#xA;          &#xA;                         a: &amp;VecDeque&lt;JsonValue&gt;,&#xA;        &#xA;        &#xA;          &#xA;                         b: &amp;VecDeque&lt;JsonValue&gt;)&#xA;        &#xA;        &#xA;          &#xA;                         -&gt; Ordering {&#xA;        &#xA;        &#xA;          &#xA;              for &amp;(ref order_dir, n) in orders.iter() {&#xA;        &#xA;        &#xA;          &#xA;                  let cmp = if *order_dir != Order::Desc {&#xA;        &#xA;        &#xA;          &#xA;                      b[n].cmp(&amp;a[n])&#xA;        &#xA;        &#xA;          &#xA;                  } else {&#xA;        &#xA;        &#xA;          &#xA;                      a[n].cmp(&amp;b[n])&#xA;        &#xA;        &#xA;          &#xA;                  };&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                  if cmp != Ordering::Equal {&#xA;        &#xA;        &#xA;          &#xA;                      return cmp;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              Ordering::Equal&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          noise.cmp.rs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;And this is the really interesting piece. The a and b variables are basically each the returned results for each matched document, with the n here being the position of a particular field in the vector. This has interesting implications. To start with, it means that whenever we have sorting, we have to fetch, in addition to the values we want to return, the values that we want to search by. If there are a lot of results to go through, that can cause a lot of individual queries to RocksDB. It also means that you need to materialize all of that memory directly. The cost of doing comparisons is also non trivial. Noise will actually compare the values directly, so it is expected that the comparison costs will dominate here, especially if you have large values. Lucene, in the same situation, is able to use the ordinal position and spare a lot of that cost. Noise doesn&#x2019;t seem to benefit from repeated queries, in each case, the value for each of the sorted field would have to be fetch, compared and sorted individually. On the other hand, the cost if directly proportional to the number of results in the query, vs. the number of documents in the index (for the first query), as it is on Lucene.</p>
        </article>
        <article id="article-2196">
            <a href="https://www.meziantou.net/write-your-own-dom-element-factory-for-typescript.htm" target="_blank">
                <h2 class="title mb-6" id="article-2196">Write your own DOM element factory for TypeScript</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 28, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">The DOM API allows manipulating the HTML document in a browser. It&#x27;s simple to use, but the code is not very readable. Here&#x27;s the code needed to create 2 elements and set an attribute:JavaScriptcopyfunction foo() {&#xA;    let div = document.createElement(&quot;div&quot;);&#xA;    let anchor = document.createElement</p>
        </article>
        <article id="article-2197">
            <a href="https://ayende.com/blog/183009-C/i-will-have-order-how-lucene-sorts-query-results" target="_blank">
                <h2 class="title mb-6" id="article-2197">I WILL have order</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 25, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this series of posts, I am going to take a look at a single feature across several search engine libraries. Given three documents, sort them by State and then by City. This is a pretty trivial query, but there is a lot that is going on behind the scenes that needs to happen for this to actually work. Let&#x2019;s look at how this is implemented, shall we? The first library to look at it Lucene, because it is so prevalent. Here is the relevant code that I&#x2019;m executing:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          var dir = FSDirectory.Open(&quot;index&quot;);&#xA;        &#xA;        &#xA;          &#xA;          var writer = new IndexWriter(dir, new StandardAnalyzer(Lucene.Net.Util.Version.LUCENE_30), MaxFieldLength.UNLIMITED);&#xA;        &#xA;        &#xA;          &#xA;          writer.AddDocument(CreateDoc(&quot;users/1&quot;, &quot;TX&quot;, &quot;Dallas&quot;));&#xA;        &#xA;        &#xA;          &#xA;          writer.AddDocument(CreateDoc(&quot;users/1&quot;, &quot;TX&quot;, &quot;Austin&quot;));&#xA;        &#xA;        &#xA;          &#xA;          writer.AddDocument(CreateDoc(&quot;users/1&quot;, &quot;NY&quot;, &quot;New York&quot;));&#xA;        &#xA;        &#xA;          &#xA;          writer.Commit(state);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          var searcher = new IndexSearcher(IndexReader.Open(dir, true));&#xA;        &#xA;        &#xA;          &#xA;          var sort = new Sort(new SortField(&quot;State&quot;, SortField.STRING, false), new SortField(&quot;City&quot;, SortField.STRING, false));&#xA;        &#xA;        &#xA;          &#xA;          var result = searcher.Search(new MatchAllDocsQuery(), null, 5, sort);&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          Lucene.Search.Sort.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;A key part of the way Lucene executes sorting is this piece of code:As you can see, we ask the reader (a single file in a Lucene directory) to get a the list of field values and matches for a particular field.In this case, what his means it that doc #0 has the value in lookup[2], doc #1 as well, and doc #2 has the value in lookup[1]. This means that when we compare, we can do it using the following code:And this is called for each field independently, like so:All of which is pretty simple and straightforward. There is a nice optimization here in the sense that in most cases, if the readerGen is the same, we can compare the ordinals directly, without comparing the actual string values.The problem here is that we need to hold arrays. In particular, I&#x2019;m talking about the FieldCache.GetStringIndex() (and it&#x2019;s related friends). The way Lucene stores the values on disk means that on first read, it needs to reconstruct the terms from the index. Here is the core of the work that is done in GetStringIndex.&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          protected internal override System.Object CreateValue(IndexReader reader, Entry entryKey)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;              System.String field = StringHelper.Intern(entryKey.field);&#xA;        &#xA;        &#xA;          &#xA;              int[] retArray = new int[reader.MaxDoc];&#xA;        &#xA;        &#xA;          &#xA;              System.String[] mterms = new System.String[reader.MaxDoc &#x2B; 1];&#xA;        &#xA;        &#xA;          &#xA;              int t = 0; // current term number&#xA;        &#xA;        &#xA;          &#xA;              using (TermDocs termDocs = reader.TermDocs())&#xA;        &#xA;        &#xA;          &#xA;              using (TermEnum termEnum = reader.Terms(new Term(field), ))&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  // an entry for documents that have no terms in this field&#xA;        &#xA;        &#xA;          &#xA;                  // should a document with no terms be at top or bottom?&#xA;        &#xA;        &#xA;          &#xA;                  // this puts them at the top - if it is changed, FieldDocSortedHitQueue&#xA;        &#xA;        &#xA;          &#xA;                  // needs to change as well.&#xA;        &#xA;        &#xA;          &#xA;                  mterms[t&#x2B;&#x2B;] = null;&#xA;        &#xA;        &#xA;          &#xA;                  do&#xA;        &#xA;        &#xA;          &#xA;                  {&#xA;        &#xA;        &#xA;          &#xA;                      Term term = termEnum.Term;&#xA;        &#xA;        &#xA;          &#xA;                      if (term == null || term.Field != field || t &gt;= mterms.Length)&#xA;        &#xA;        &#xA;          &#xA;                          break;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      // store term text&#xA;        &#xA;        &#xA;          &#xA;                      mterms[t] = term.Text;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      termDocs.Seek(termEnum);&#xA;        &#xA;        &#xA;          &#xA;                      while (termDocs.Next())&#xA;        &#xA;        &#xA;          &#xA;                      {&#xA;        &#xA;        &#xA;          &#xA;                          retArray[termDocs.Doc] = t;&#xA;        &#xA;        &#xA;          &#xA;                      }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;                      t&#x2B;&#x2B;;&#xA;        &#xA;        &#xA;          &#xA;                  }&#xA;        &#xA;        &#xA;          &#xA;                  while (termEnum.Next());&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              if (t == 0)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  // if there are no terms, make the term array&#xA;        &#xA;        &#xA;          &#xA;                  // have a single null entry&#xA;        &#xA;        &#xA;          &#xA;                  mterms = new System.String[1];&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              else if (t &lt; mterms.Length)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  // if there are less terms than documents,&#xA;        &#xA;        &#xA;          &#xA;                  // trim off the dead array space&#xA;        &#xA;        &#xA;          &#xA;                  System.String[] terms = new System.String[t];&#xA;        &#xA;        &#xA;          &#xA;                  Array.Copy(mterms, 0, terms, 0, t);&#xA;        &#xA;        &#xA;          &#xA;                  mterms = terms;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              StringIndex value_Renamed = new StringIndex(retArray, mterms);&#xA;        &#xA;        &#xA;          &#xA;              return value_Renamed;&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          GetStringIndex.impl.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;As you can see, this rips through the entire file, reading each term and then getting all the documents for a particular term. The code is quite clever, because we don&#x2019;t need to compare anything, we know that we are sorted, so we can take advantage of that when detecting the ordinals.What this code isn&#x2019;t very helpful about, though, is the fact that this is allocating a lot of memory. In particular, it will allocate arrays with a value per each document in the index. On large indexes, these can be very large. The good thing here is that there is a good caching going on here, so you&#x2019;ll typically not need to run this code all too often. The bad thing is that this runs per segment. If you have a lot of small index batches, you&#x2019;ll have a lot of values like that floating around, and then it will get merged, and you&#x2019;ll have to run through this again. This is also one of the primary reasons Lucene is limited to about 2.1 billion documents per index.The good thing about it is that this is really flexible and give us a great performance when sorting. So now that we know how Lucene does it, let&#x2019;s look at other libraries.</p>
        </article>
        <article id="article-2198">
            <a href="https://ayende.com/blog/182948-C/distributed-compare-exchange-operations-with-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-2198">Distributed compare-exchange operations with RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 24, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">RavenDB uses a consensus protocol to manage much of its distributed state. The consensus is used to ensure consistency in a distributed system and it is open for users as well. You can use this feature to enable some interesting scenarios. The idea is that you can piggy back on RavenDB&#x2019;s existing consensus engine to gain the ability allow you to create robust and consistent distributed operations. RavenDB exposes these operations using&#xA0; a pretty simple interface: compare-exchange.At the most basic level, you have a key/value interface that you can make distributed atomic operations on, knowing that they are completely consistent. This is great, in abstract, but it s a bit hard to grasp without a concrete example.&#xA;Consider the following scenario. We have a bunch of support engineers, ready and willing to take on any support call that come. &#xA;At the same time, an engineer can only a certain number of support calls. In order to handle this, we allow engineers to register &#xA;when they are available to take a new support call. How would we handle this in RavenDB? Assuming that we wanted absolute &#xA;consistency? An engineer may never be assigned too much work and work may never be lost. Assume that we need this to be robust in the face of network and node failure. &#xA;Here is how an engineer can register to the pool of available engineers.&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          const string key = &quot;engineers/available&quot;;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;          public void RegisterEngineerAvailability(string engineer)&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            while (true)&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;              var get = new GetCompareExchangeValueOperation&lt;List&lt;string&gt;&gt;(&#xA;        &#xA;        &#xA;          &#xA;              &#x9;key);&#xA;        &#xA;        &#xA;          &#xA;              var getResult = _store.Operations.Send(get);&#xA;        &#xA;        &#xA;          &#xA;              if (getResult == null)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  // empty, so create a new one&#xA;        &#xA;        &#xA;          &#xA;                  getResult = new CompareExchangeValue&lt;List&lt;string&gt;&gt;(&#xA;        &#xA;        &#xA;          &#xA;                      key,&#xA;        &#xA;        &#xA;          &#xA;                      index: 0, // new&#xA;        &#xA;        &#xA;          &#xA;                      value: new List&lt;string&gt;()&#xA;        &#xA;        &#xA;          &#xA;                      );&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              getResult.Value.Add(engineer);&#xA;        &#xA;        &#xA;          &#xA;              var put = new PutCompareExchangeValueOperation&lt;List&lt;string&gt;&gt;(&#xA;        &#xA;        &#xA;          &#xA;                  key,&#xA;        &#xA;        &#xA;          &#xA;                  getResult.Value,&#xA;        &#xA;        &#xA;          &#xA;                  getResult.Index);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              var putResult = _store.Operations.Send(put);&#xA;        &#xA;        &#xA;          &#xA;              if (putResult.Successful)&#xA;        &#xA;        &#xA;          &#xA;                  return;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              // someone pushed a new engineer, retry...&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          engineer.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;The code above is very similar to how you would write multi-threaded code. You first get the value, then attempt &#xA;to do an atomic operation to swap the old value with the new one. If we are successful, the operation is done. If not, then&#xA;we retry. Concurrent calls to RegisterEngineerAvailability will race each other. One of them will succeed and the others&#xA;will have to retry.The actual data that we store in the compare exchange value in this case is an array. You can see an example of how that would look here:&#xA;Compare exchange values can be simple values (numbers, strings), arrays or even objects. Any value that can be represented &#xA;as JSON is valid there. However, the only operation that is allowed on a compare exchange value is a wholesale replacement.&#xA;The code above is only doing half of the job. We still need to be able to get an engineer to help us handle &#xA;a support call. The code to complete this task is shown below:&#xA;    &#xA;      &#xA;        &#xA;  &#xA;    &#xA;    &#xA;&#xA;        &#xA;&#xA;&#xA;  &#xA;  &#xA;  &#xA;    &#xA;&#xA;    &#xA;      This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.&#xA;      Learn more about bidirectional Unicode characters&#xA;    &#xA;&#xA;&#xA;              Show hidden characters&#xA;&#xA;&#xA;&#xA;&#xA;  &#xA;    &#xA;    &#xA;&#xA;&#xA;&#xA;  &#xA;        &#xA;          &#xA;          public string PullAvailableEngineer()&#xA;        &#xA;        &#xA;          &#xA;          {&#xA;        &#xA;        &#xA;          &#xA;            while (true)&#xA;        &#xA;        &#xA;          &#xA;            {&#xA;        &#xA;        &#xA;          &#xA;              var get = new GetCompareExchangeValueOperation&lt;List&lt;string&gt;&gt;(&#xA;        &#xA;        &#xA;          &#xA;              &#x9;key);&#xA;        &#xA;        &#xA;          &#xA;              var getResult = _store.Operations.Send(get);&#xA;        &#xA;        &#xA;          &#xA;              if(getResult == null)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                  // no support engineers, wait and retry&#xA;        &#xA;        &#xA;          &#xA;                  Thread.Sleep(500);&#xA;        &#xA;        &#xA;          &#xA;                  continue;&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              string engineer = getResult.Value[0];&#xA;        &#xA;        &#xA;          &#xA;              getResult.Value.RemoveAt(0);&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              CompareExchangeResult&lt;List&lt;string&gt;&gt; result;&#xA;        &#xA;        &#xA;          &#xA;              if (getResult.Value.Count == 0)&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                var del = &#xA;        &#xA;        &#xA;          &#xA;               &#x9;new DeleteCompareExchangeValueOperation&lt;List&lt;string&gt;&gt;(&#xA;        &#xA;        &#xA;          &#xA;          &#x9;         key,&#xA;        &#xA;        &#xA;          &#xA;          &#x9;         getResult.Index);&#xA;        &#xA;        &#xA;          &#xA;                result = _store.Operations.Send(del);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;              else&#xA;        &#xA;        &#xA;          &#xA;              {&#xA;        &#xA;        &#xA;          &#xA;                var put = &#xA;        &#xA;        &#xA;          &#xA;               &#x9;new PutCompareExchangeValueOperation&lt;List&lt;string&gt;&gt;(&#xA;        &#xA;        &#xA;          &#xA;          &#x9;         key,&#xA;        &#xA;        &#xA;          &#xA;          &#x9;         getResult.Value,&#xA;        &#xA;        &#xA;          &#xA;          &#x9;         getResult.Index);&#xA;        &#xA;        &#xA;          &#xA;                result = _store.Operations.Send(put);&#xA;        &#xA;        &#xA;          &#xA;              }&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              if (result.Successful)&#xA;        &#xA;        &#xA;          &#xA;                  return engineer;&#xA;        &#xA;        &#xA;          &#xA;          &#xA;&#xA;        &#xA;        &#xA;          &#xA;              // someone took an available engineer&#xA;        &#xA;        &#xA;          &#xA;              // while we were running, let&#x27;s try again...&#xA;        &#xA;        &#xA;          &#xA;            }&#xA;        &#xA;        &#xA;          &#xA;          }&#xA;        &#xA;  &#xA;&#xA;&#xA;&#xA;    &#xA;&#xA;  &#xA;&#xA;&#xA;      &#xA;      &#xA;        view raw&#xA;        &#xA;          pull.cs&#xA;        &#xA;        hosted with &#x2764; by GitHub&#xA;      &#xA;    &#xA;&#xA;&#xA;The code for pulling an engineer from the pool is a bit more complex. Here we read the available engineers from the server. If there are none, we&#x27;ll &#xA;wait a bit and try again. If there are available engineers we&#x27;ll remove the first one and then try to update the value. This &#xA;can happen for multiple clients at the same time, so we check whatever our update was successful and only return the engineer &#xA;if our change was accepted.&#xA;Note that in this case we use two different modes to update the value. If there are still more engineers in the available&#xA0; pool, we&#x27;ll just remove our engineer and update the value. But if our engineer is the last one, we&#x27;ll delete the value &#xA;entirely. In either case, this is an atomic operation that will first check the index of the pre-existing value before &#xA;performing the write.&#xA;It is important to note that when using compare exchange values, you&#x27;ll typically not act on read. In other words, in PullAvailableEngineer, even if we have an available engineer, we&#x27;ll not use that knowledge until we successfully wrote the new value.&#xA;The whole idea with compare exchange values is that they give you atomic operation primitive in the cluster. So a typical &#xA;usage of them is always to try to do something on write until it is accepted, and only then use whatever value you read.&#xA;The acceptance of the write indicates the success of your operation and the ability to rely on whatever values you read. &#xA;However, it is important to note that compare exchange operations are atomic and independent. That means an operation&#xA;that modify a compare exchange value and then do something else needs to take into account that these would run in separate &#xA;transactions.&#xA;For example, if a client pull an engineer from the available pool but doesn&#x27;t provide any work (maybe because the client &#xA;crashed) the engineer will not magically return to the pool. In such cases, the idle engineer should periodically check &#xA;that the pool still the username and add it back if it is missing.</p>
        </article>
        <article id="article-2199">
            <a href="https://ayende.com/blog/182947-C/daisy-chaining-data-flow-in-ravendb" target="_blank">
                <h2 class="title mb-6" id="article-2199">Daisy chaining data flow in RavenDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 23, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have talked before about RavenDB&#x2019;s MapReduce indexes and their ability to output results to a collection as well as RavenDb&#x2019;s ETL processes and how we can use them to push some data to another database (a RavenDB database or a relational one). Bringing these two features together can be surprisingly useful when you start talking about global distributed processing. A concrete example might make this easier to understand. Imagine a shoe store (we&#x2019;ll go with Gary&#x2019;s Shoes) that needs to track sales across a large number of locations. Because sales must be processed regardless of the connection status, each store hosts a RavenDB server to record its sales. Here is the geographic distribution of the stores:To properly manage this chain of stores, we need to be able to look at data across all stores. One way of doing this is to set up external replication from each store location to a central server. This way, all the data is aggregated into a single location. In most cases, this would be the natural thing to do. In fact, you would probably want two-way replication of most of the data so you could figure out if a given store has a specific shoe in stock by just looking at the local copy of its inventory. But for the purpose of this discussion, we&#x2019;ll assume that there are enough shoe sales that we don&#x2019;t actually want to have all the sales replicated. We just want some aggregated data. But we want this data aggregated across all stores, not just at one individual store. Here&#x2019;s how we can handle this: we&#x2019;ll define an index that would aggregate the sales across the dimensions that we care about (model, date, demographic, etc.). This index can answer the kind of queries we want, but it is defined on the database for each store so it can only provide information about local sales, not what happens across all the stores. Let&#x2019;s fix that. We&#x2019;ll change the index to have an output collection. This will cause it to write all its output as documents to a dedicated collection. Why does this matter? These documents will be written to solely by the index, but given that they are documents, they obey all the usual rules and can be acted upon like any other document. In particular, this means that we can apply an ETL process to them. Here is what this ETL script would look like. The script sends the aggregated sales (the collection generated by the MapReduce index) to a central server. Note that we also added some static fields that will be helpful on the remote server so as to be able to tell which store each aggregated sale came from. At the central server, you can work with these aggregated sales documents to each store&#x2019;s details, or you can aggregate them again to see the state across the entire chain.The nice things about this approach are the combination of features and their end result. At the local level, you have independent servers that can work seamlessly with an unreliable network. They also give store managers a good overview of their local states and what is going on inside their own stores. At the same time, across the entire chain, we have ETL processes that will update the central server with details about sales statuses on an ongoing basis. If there is a network failure, there will be no interruption in service (except that the sales details for a particular store will obviously not be up to date). When the network issue is resolved, the central server will accept all the missing data and update its reports.The entire process relies entirely on features that already exist in RavenDB and are easily accessible. The end result is a distributed, highly reliable and fault tolerant MapReduce process that gives you aggregated view of sales across the entire chain with very little cost.</p>
        </article>
        <article id="article-2200">
            <a href="https://ayende.com/blog/182946-C/ravendb-4-1-features-highlighting" target="_blank">
                <h2 class="title mb-6" id="article-2200">RavenDB 4.1 Features</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 22, 2018
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">This s actually an old feature, that didn&#x2019;t make the cut to enter 4.0. This is now back, and it is roaring. This is the kind of feature that is useful if you are utilizing RavenDB&#x2019;s search capabilities. Let us assume that you want to search for something, but instead of querying for &#x201C;give me all the active users&#x201D; you want to actually&#x2026; search. For example, you want to search for all employees with a BA in their bio. However, you don&#x2019;t want to just get the matches, you want to show the user why this was matches.That is the problem that highlighting is meant to solve. Consider the following query:Which returns the following results:Why did we get this particular employees?&#xA0; Let&#x2019;s find out:Now we are asking the server to highlight for us the reason for the match. You can see this in the studio directly, in the Highlight tab:Using this approach, you can enrich the search result and provide nicer experience for your users.</p>
        </article>
        <div class="button flex justify-between">
            <a href="219.html"><span class="back arrow"></span></a>

            <a href="221.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>