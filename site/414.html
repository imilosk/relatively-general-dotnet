
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 414 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4131">
            <a href="https://ayende.com/blog/161441/reviewing-leveldb-part-v-into-the-memtables-we-go" target="_blank">
                <h2 class="title mb-6" id="article-4131">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 27, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">You can read about the theory of Sorted Strings Tables and Memtables here. In this case, what I am interested in is going a bit deeper into the leveldb codebase, and understanding how the data is actually kept in memory and what is it doing there. In order to do that, we are going to investigate MemTable. As it turned out, this is actually a very simple data structure. A MemTable just hold a SkipList, whish is a sorted data structure that allows O(log N) access and modifications. The interesting thing about Skip List in contrast to Binary Trees, is that it is much easier to create a performant solution of concurrent skip list (either with or without locks) over a concurrently binary tree. The data in the table is just a list of key &amp; value (or delete marker). And that means that searches through this can give you three results:  Here is the value for the key (exists) The value for the key was remove (deleted) The value is not in the memory table (missing) It is the last part where we get involved with the more interesting aspect of LevelDB (and the reason it is called leveldb in the first place). The notion that you have multiple levels. The mem table is the first one, and then you spill the output out to disk (the Sorted Strings Table). Now that I figure out how simple MemTable is really is, I am going to take a look at the leveldb log, and then dive into Sorted Strings Table.</p>
        </article>
        <article id="article-4132">
            <a href="https://ayende.com/blog/161413/reviewing-leveldb-part-iv-on-std-string-buffers-and-memory-management-in-c" target="_blank">
                <h2 class="title mb-6" id="article-4132">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 26, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">his is a bit of a side track. One of the things that is quite clear to me when I am reading the leveldb code is that I was never really any good at C&#x2B;&#x2B;. I was a C/C&#x2B;&#x2B; developer. And that is a pretty derogatory term. C &amp; C&#x2B;&#x2B; share a lot of the same syntax and underlying assumption, but the moment you want to start writing non trivial stuff, they are quite different. And no, I am not talking about OO or templates. I am talking about things that came out of that. In particular, throughout the leveldb codebase, they are very rarely, if at all, allocate memory directly. Pretty much the whole codebase rely on std::string to handle buffer allocations and management. This make sense, since RAII is still the watch ward for good C&#x2B;&#x2B; code. Being able to utilize std::string for memory management also means that the memory will be properly released without having to deal with it explicitly. More interestingly, the leveldb codebase is also using std::string as a general buffer. I wonder why it is std::string vs. std::vector&lt;char&gt;,&#xA0; which would bet more reasonable, but I guess that this is because most of the time, users will want to pass strings as keys, and likely this is easier to manage, given the type of operations available on std::string (such as append). It is actually quite fun to go over the codebase and discover those sort of things. Especially if I can figure them out on my own . This is quite interesting because from my point of view, buffers are a whole different set of problems. We don&#x2019;t have to worry about the memory just going away in .NET (although we do have to worry about someone changing the buffer behind our backs), but we have to worry a lot about buffer size. This is because at some point (80Kb), buffers graduate to the large object heap, and stay there. Which means, in turn, that every time that you want to deal with buffers you have to take that into account, usually with a buffer pool. Another aspect that is interesting with regards to memory usage is the explicit handling of copying. There are various places in the code where the copy constructor was made private, to avoid this. Or a comment is left about making a type copy-able intentionally. I get the reason why, because it is a common failing point in C&#x2B;&#x2B;, but I forgot (although I am pretty sure that I used to know) the actual semantics of when/ how you want to do that in all cases.</p>
        </article>
        <article id="article-4133">
            <a href="https://ayende.com/blog/161667/ravendb-2-0-3-stable-release" target="_blank">
                <h2 class="title mb-6" id="article-4133">RavenDB 2.0.3 Stable Release!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 25, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We have just released the next stable build 2330 of RavenDB 2.0. You can find it here. This release contains a lot of bug fixes, improvements, streamlining and some interesting new stuff. The full change log is actually here, because we found a bug in 2325 (ironically, it was a bug in how it reported its build number).  Breaking Changes:  SQL Replication script / configuration change (more below). Features:  More debug / visibility endpoints (user info, changes traffic, map/reduce data, etc). Better highlighting support. Spatial Search will sort by distance by default. Better indexing for TimeSpan values. Can do more Parallel Work in Map/Reduce indexes now. Improvements:  Map/Reudce indexes tune themselves automatically. Better Periodic Backup behavior when there is no new writes. Better handling of transactions during documents put with high number of referencing documents. Better use of alerts. Better float support. Studio:  Better import/export UI. Bug fixes:  Can backup &amp; restore even in the presence of corrupt / missing indexes. LoadDocument with map/reduce indexes cause issues. Allow to change the number of cached requests on the client side without NRE. Fixing Unique Constraints bundle with null unique properties. Forbidden error when running as a non admin user in the studio. Better support for indexing nullable properties with HasValue. Fixed a problem with replication of deleted documents when adding a new node in the topology. Support export / import with versioning bundle. &#xA0; SQL Replication Breaking Changes With SQL Replication, it became apparent that we missed a pretty big use case.&#xA0; Deletions.  Deletions is something that we didn&#x2019;t handle, and couldn&#x2019;t handle using the existing format. It was a touch call, but we decided to make a breaking change here. Now, you need to define all the tables that you&#x2019;ll be working with (as well as the order we will be writing to them). Assuming that we have a User document, and we want to replicate to Users and UsersGroups tables, we would have:      1: replicateToUsers({   2:    Name: this.Name   3: })   4:&#xA0;    5: for(var i = 0; i &lt; this.Groups.length; i&#x2B;&#x2B;) {   6:   replicateToUsersGroups({   7:       Group: this.Groups[i]   8:   });   9: }&#xA;This replaced the sqlReplicate calls. Note that this is a hard breaking reset. When you upgrade, you&#x2019;ll need to update all of your SQL Replication definitions (but you keep the replication state, you won&#x2019;t have to start replicating from scratch).</p>
        </article>
        <article id="article-4134">
            <a href="https://ardalis.com/speed-up-youtube-videos/" target="_blank">
                <h2 class="title mb-6" id="article-4134">Speed Up YouTube Videos</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 22, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">If you&#x2019;ve ever wanted to speed up a YouTube video, like you can do with Pluralsight training videos, here&#x2019;s a quick tip to show you how to&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4135">
            <a href="https://ayende.com/blog/161412/reviewing-leveldb-part-iii-writebatch-isnt-what-you-think-it-is" target="_blank">
                <h2 class="title mb-6" id="article-4135">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 22, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the key external components of leveldb is the idea of WriteBatch. It allows you to batch multiple operations into a single atomic write. It looks like this, from an API point of view:      1: leveldb::WriteBatch batch;   2: batch.Delete(key1);   3: batch.Put(key2, value);   4: s = db-&gt;Write(leveldb::WriteOptions(), &amp;batch);&#xA;As we have learned in the previous post, WriteBatch is how leveldb handles all writes. Internally, any call to Put or Delete is translated into a single WriteBatch, then there is some batching involved across multiple batches, but that is beside the point right now.&#xA;I dove into the code for WriteBatch, and immediately I realized that this isn&#x2019;t really what I bargained for. In my mind, WriteBatch was supposed to be something like this:&#xA;&#xA;&#xA;   1: public class WriteBatch   2: {   3:    List&lt;Operation&gt; Operations;   4: }&#xA;Which would hold the in memory operations until they get written down to disk, or something.&#xA;Instead, it appears that leveldb took quite a different route. The entire data is stored in the following format:&#xA;&#xA;&#xA;   1: // WriteBatch::rep_ :=   2: //    sequence: fixed64   3: //    count: fixed32   4: //    data: record[count]   5: // record :=   6: //    kTypeValue varstring varstring         |   7: //    kTypeDeletion varstring   8: // varstring :=   9: //    len: varint32  10: //    data: uint8[len]&#xA;This is the in memory value, mind. So we are already storing this in a single buffer. I am not really sure why this is the case, to be honest.&#xA;WriteBatch is pretty much a write only data structure, with one major exception:&#xA;&#xA;&#xA;   1: // Support for iterating over the contents of a batch.   2: class Handler {   3:  public:   4:   virtual ~Handler();   5:   virtual void Put(const Slice&amp; key, const Slice&amp; value) = 0;   6:   virtual void Delete(const Slice&amp; key) = 0;   7: };   8: Status Iterate(Handler* handler) const;&#xA;You can iterate over the batch. The problem is that we now have this implementation for Iterate:&#xA;&#xA;&#xA;   1: Status WriteBatch::Iterate(Handler* handler) const {   2:   Slice input(rep_);   3:   if (input.size() &lt; kHeader) {   4:     return Status::Corruption(&quot;malformed WriteBatch (too small)&quot;);   5:   }   6:&#xA0;    7:   input.remove_prefix(kHeader);   8:   Slice key, value;   9:   int found = 0;  10:   while (!input.empty()) {  11:     found&#x2B;&#x2B;;  12:     char tag = input[0];  13:     input.remove_prefix(1);  14:     switch (tag) {  15:       case kTypeValue:  16:         if (GetLengthPrefixedSlice(&amp;input, &amp;key) &amp;&amp;  17:             GetLengthPrefixedSlice(&amp;input, &amp;value)) {  18:           handler-&gt;Put(key, value);  19:         } else {  20:           return Status::Corruption(&quot;bad WriteBatch Put&quot;);  21:         }  22:         break;  23:       case kTypeDeletion:  24:         if (GetLengthPrefixedSlice(&amp;input, &amp;key)) {  25:           handler-&gt;Delete(key);  26:         } else {  27:           return Status::Corruption(&quot;bad WriteBatch Delete&quot;);  28:         }  29:         break;  30:       default:  31:         return Status::Corruption(&quot;unknown WriteBatch tag&quot;);  32:     }  33:   }  34:   if (found != WriteBatchInternal::Count(this)) {  35:     return Status::Corruption(&quot;WriteBatch has wrong count&quot;);  36:   } else {  37:     return Status::OK();  38:   }  39: }&#xA;So we write it directly to a buffer, then read from that buffer. The interesting bit is that the actual writing to leveldb itself is done in a similar way, see:&#xA;&#xA;&#xA;   1: class MemTableInserter : public WriteBatch::Handler {   2:  public:   3:   SequenceNumber sequence_;   4:   MemTable* mem_;   5:&#xA0;    6:   virtual void Put(const Slice&amp; key, const Slice&amp; value) {   7:     mem_-&gt;Add(sequence_, kTypeValue, key, value);   8:     sequence_&#x2B;&#x2B;;   9:   }  10:   virtual void Delete(const Slice&amp; key) {  11:     mem_-&gt;Add(sequence_, kTypeDeletion, key, Slice());  12:     sequence_&#x2B;&#x2B;;  13:   }  14: };  15:&#xA0;   16: Status WriteBatchInternal::InsertInto(const WriteBatch* b,  17:                                       MemTable* memtable) {  18:   MemTableInserter inserter;  19:   inserter.sequence_ = WriteBatchInternal::Sequence(b);  20:   inserter.mem_ = memtable;  21:   return b-&gt;Iterate(&amp;inserter);  22: }&#xA;As I can figure it so far, we have the following steps:&#xA;&#xA;WriteBatch.Put / WriteBatch.Delete gets called, and the values we were sent are copied into our buffer.&#xA;We actually save the WriteBatch, at which point we unpack the values out of the buffer and into the memtable.&#xA;It took me a while to figure it out, but I think that I finally got it. The reason this is the case is that leveldb is a C&#x2B;&#x2B; application. As such, memory management is something that it needs to worry about explicitly.&#xA;In particular, you can&#x2019;t just rely on the memory you were passed to be held, the user may release that memory after they called to Put. This means, in turn, that you must copy the memory to memory that leveldb allocated, so leveldn can manage its own lifetime. This is a foreign concept to me because it is such a strange thing to do in the .NET land, where memory cannot just disappear underneath you.&#xA;On my next post, I&#x2019;ll deal a bit more with this aspect, buffers management and memory handling in general.</p>
        </article>
        <article id="article-4136">
            <a href="https://ayende.com/blog/161411/reviewing-leveldb-part-ii-put-some-data-on-the-disk-dude" target="_blank">
                <h2 class="title mb-6" id="article-4136">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 21, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I think that the very first thing that we want to do is to actually discover how exactly is leveldb saving the information to disk. In order to do that, we are going to trace the calls (with commentary) for the Put method. We start from the client code:      1: leveldb::DB* db;   2: leveldb::DB::Open(options, &quot;play/testdb&quot;, &amp;db);   3: status = db-&gt;Put(leveldb::WriteOptions(), &quot;Key&quot;, &quot;Hello World&quot;);&#xA;This calls the following method:&#xA;&#xA;&#xA;   1: // Default implementations of convenience methods that subclasses of DB   2: // can call if they wish   3: Status DB::Put(const WriteOptions&amp; opt, const Slice&amp; key, const Slice&amp; value) {   4:   WriteBatch batch;   5:   batch.Put(key, value);   6:   return Write(opt, &amp;batch);   7: }   8:&#xA0;    9: Status DB::Delete(const WriteOptions&amp; opt, const Slice&amp; key) {  10:   WriteBatch batch;  11:   batch.Delete(key);  12:   return Write(opt, &amp;batch);  13: }&#xA;I included the Delete method as well, because this code teaches us something important, all the modifications calls are always going through the same WriteBatch call. Let us look at that now.&#xA;&#xA;&#xA;   1: Status DBImpl::Write(const WriteOptions&amp; options, WriteBatch* my_batch) {   2:   Writer w(&amp;mutex_);   3:   w.batch = my_batch;   4:   w.sync = options.sync;   5:   w.done = false;   6:&#xA0;    7:   MutexLock l(&amp;mutex_);   8:   writers_.push_back(&amp;w);   9:   while (!w.done &amp;&amp; &amp;w != writers_.front()) {  10:     w.cv.Wait();  11:   }  12:   if (w.done) {  13:     return w.status;  14:   }  15:&#xA0;   16:   // May temporarily unlock and wait.  17:   Status status = MakeRoomForWrite(my_batch == NULL);  18:   uint64_t last_sequence = versions_-&gt;LastSequence();  19:   Writer* last_writer = &amp;w;  20:   if (status.ok() &amp;&amp; my_batch != NULL) {  // NULL batch is for compactions  21:     WriteBatch* updates = BuildBatchGroup(&amp;last_writer);  22:     WriteBatchInternal::SetSequence(updates, last_sequence &#x2B; 1);  23:     last_sequence &#x2B;= WriteBatchInternal::Count(updates);  24:&#xA0;   25:     // Add to log and apply to memtable.  We can release the lock  26:     // during this phase since &amp;w is currently responsible for logging  27:     // and protects against concurrent loggers and concurrent writes  28:     // into mem_.  29:     {  30:       mutex_.Unlock();  31:       status = log_-&gt;AddRecord(WriteBatchInternal::Contents(updates));  32:       if (status.ok() &amp;&amp; options.sync) {  33:         status = logfile_-&gt;Sync();  34:       }  35:       if (status.ok()) {  36:         status = WriteBatchInternal::InsertInto(updates, mem_);  37:       }  38:       mutex_.Lock();  39:     }  40:     if (updates == tmp_batch_) tmp_batch_-&gt;Clear();  41:&#xA0;   42:     versions_-&gt;SetLastSequence(last_sequence);  43:   }  44:&#xA0;   45:   while (true) {  46:     Writer* ready = writers_.front();  47:     writers_.pop_front();  48:     if (ready != &amp;w) {  49:       ready-&gt;status = status;  50:       ready-&gt;done = true;  51:       ready-&gt;cv.Signal();  52:     }  53:     if (ready == last_writer) break;  54:   }  55:&#xA0;   56:   // Notify new head of write queue  57:   if (!writers_.empty()) {  58:     writers_.front()-&gt;cv.Signal();  59:   }  60:&#xA0;   61:   return status;  62: }&#xA;Now we have a lot of code to go through. Let us see what conclusions we can draw from this.&#xA;The first 15 lines or so seems to create a new Writer, not sure what that is yet, and register that in a class variable. Maybe it is actually being written on a separate thread?&#xA;I am going to switch over and look at that line of thinking .First thing to do is to look at the Writer implementation. This writer looks like this:&#xA;&#xA;&#xA;   1: struct DBImpl::Writer {   2:   Status status;   3:   WriteBatch* batch;   4:   bool sync;   5:   bool done;   6:   port::CondVar cv;   7:&#xA0;    8:   explicit Writer(port::Mutex* mu) : cv(mu) { }   9: };&#xA;So this is just a data structure with no behavior. Note that we have CondVar, whatever that is. Which accepts a mutex. Following the code, we see this is a pthread condition variable. I haven&#x2019;t dug too deep into this, but it appears like it is similar to the .NET lock variable. Except that there seems to be the ability to associate multiple variables with a single mutex. Which could be a useful way to signal on specific conditions. The basic idea is that you can wait for a specific operation, not just a single variable.&#xA;Now that I get that, let us see what we can figure out about the writers_ usage. This is just a standard (non thread safe) std::deque, (a data structure merging properties of list &amp; queue). Thread safety is achieved via the call to MutexLock on line 7. I am going to continue ignoring the rest of the function and look where else this value is being used now. Back now, and it appears that the only place where writers_ are used in in this method or methods that it calls.&#xA;What this means in turn is that unlike what I thought, there isn&#x2019;t a dedicated background thread for this operation. Rather, this is a way for leveldb to serialize access. As I understand it. Calls to the Write() method would block on the mutex access, then it waits until its write is the current one (that is what the &amp;w != writers_.front() means. Although the code also seems to suggest that another thread may pick up on this behavior and batch multiple writes to disk at the same time. We will discuss this later on.&#xA;Right now, let us move to line 17, and MakeRoomForWrite. This appears to try to make sure that we have enough room to the next write. I don&#x2019;t really follow the code there yet, I&#x2019;ll ignore that for now and move on to the rest of the Write() method.&#xA;In line 18, we get the current sequence number, although I am not sure why that is, I think it is possible this is for the log. The next interesting bit is in BuildBatchGroup, this method will merge existing pending writes into one big write (but not too big a write). This is a really nice way to merge a lot of IO into a single disk access, without introducing latency in the common case.&#xA;The rest of the code is dealing with the actual write to the log&#xA0; / mem table 20 &#x2013; 45, then updating the status of the other writers we might have modified, as well as starting the writes for existing writers that may have not got into the current batch.&#xA;And I think that this is enough for now. We haven&#x2019;t got to disk yet, I admit, but we did get a lot of stuff done. On my next post, I&#x2019;ll dig even deeper, and try to see how the data is actually structured, I think that this would be interesting&#x2026;</p>
        </article>
        <article id="article-4137">
            <a href="https://ayende.com/blog/161633/ravendb-vnext-it-is-so-pink" target="_blank">
                <h2 class="title mb-6" id="article-4137">RavenDB vNext: It is so pink!</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 21, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Just thought that you might appreciate a peek into what we have been working on:  You can consider the bright pink background a bug, by the way. But the installer is real, and it will guide you through an install of RavenDB using the &#x201C;Yes, Dear&#x201D; model. This is mostly for clients that don&#x2019;t like xcopy installs (honestly, this is to make sure that setting up in IIS is no longer a set of manual steps).</p>
        </article>
        <article id="article-4138">
            <a href="https://ardalis.com/when-should-you-arrive-for-an-interview/" target="_blank">
                <h2 class="title mb-6" id="article-4138">When Should You Arrive for an Interview</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 20, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We&#x2019;ve been doing a lot of interviewing as we grow our team in Hudson, Ohio for Telerik Services. We have a fairly small office in a suburban&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4139">
            <a href="https://ayende.com/blog/161410/reviewing-leveldb-part-i-what-is-this-all-about" target="_blank">
                <h2 class="title mb-6" id="article-4139">Reviewing LevelDB</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 20, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">LevelDB is&#x2026;  a fast key-value storage library written at Google that provides an ordered mapping from string keys to string values. That is the project&#x2019;s own definition. Basically, it is a way for users to store data in an efficient manner. It isn&#x2019;t a SQL database. It isn&#x2019;t even a real database in any sense of the word. What it is is a building block for building databases. It handles writing and reading to disk, and it supports atomicity. But anything else is on you (from transaction management to more complex items). As such, it appears perfect for the kind of things that we need to do. I decided that I wanted to get to know the codebase, especially since at this time, I can&#x2019;t even get it to compile . The fact that this is a C&#x2B;&#x2B; codebase, written by people who eat &amp; breath C&#x2B;&#x2B; for a living is another reason why. I expect that this would be a good codebase, so I might as well sharpen my C&#x2B;&#x2B;-foo at the same time that I grok what this is doing. The first thing to do is to look at the interface that the database provides us with:   That is a very small surface area, and as you can imagine, this is something that I highly approve of. It make it much easier to understand and reason about. And there is some pretty complex behavior behind this, which I&#x2019;ll be exploring soon.</p>
        </article>
        <article id="article-4140">
            <a href="https://ayende.com/blog/161378/ravendb-vnext-just-the-same-a-little-bit-better-all-over-the-place" target="_blank">
                <h2 class="title mb-6" id="article-4140">RavenDB vNext? Just the same, a little bit better, all over the place</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: March 19, 2013
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We pretty much completed all of the major work that was going to get into the next major RavenDB release. There is the indexing stuff that I already talked about in this blog, but most of the rest are a lot of seemingly minor things. Nothing that would blow you head in isolation. Things like better aggressive caching invalidation, faster error in network timeout scenarios, better bucket selection algorithm for map/reduce, providing you with auto resolving conflicts, or even more improvements to the studio. Hell, it is even things like this:  We output a lot of information that can help you figure out what is going on in your system. But now we are actually starting to take it up a notch and also provide good UX for handling that.</p>
        </article>
        <div class="button flex justify-between">
            <a href="413.html"><span class="back arrow"></span></a>

            <a href="415.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>