
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 496 &#x2022; Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
    <!-- Google Analytics -->
    <script>
        // Only load GA if consent is given
        function loadGA() {
            const script = document.createElement('script');
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-MDFXJY3FCY';
            script.async = true;
            document.head.appendChild(script);

            window.dataLayer = window.dataLayer || [];

            function gtag() {
                dataLayer.push(arguments);
            }

            gtag('js', new Date());
            gtag('config', 'G-MDFXJY3FCY');
        }

        // Check if consent was previously given
        if (localStorage.getItem('cookieConsent') === 'accepted') {
            loadGA();
        }
    </script>
    <!-- End Google Analytics -->
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline underline"
               href="index.html"> Home </a><a
                aria-current="" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline " href="about.html">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>


<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4951">
            <a href="https://benfoster.io/blog/model-binder-dependency-injection-structuremap/" target="_blank">
                <h2 class="title mb-6" id="article-4951">Model Binder Dependency Injection with Structuremap</h2>
            </a>
            <p class="mb-2">by Ben Foster</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 10, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In this post I demonstrate how we can use a custom IModelBinderProvider to allow for dependency injection in an ASP.NET MVC ModelBinder.</p>
        </article>
        <article id="article-4952">
            <a href="https://ayende.com/blog/59394/ravendb-implementation-frustrations" target="_blank">
                <h2 class="title mb-6" id="article-4952">RavenDB implementation frustrations</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 09, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">While working on the RavenDB server is usually a lot of fun, there is a part of RavenDB client that I absolutely abhor. Every time that I need to touch the part of the client API that talks to the server, it is a pain. Why is that? Let us take a the simple example, loading a document by id. On the wire, it looks like this:  GET /docs/users/ayende It can&#x2019;t be simpler than that, except that internally in RavenDB, we have three implementation for that:  Standard sync impl  Standard async impl  Silverlight async impl The problem is that each of those uses different API, and while we created a shared abstraction for async / sync, at least, it is a hard task making sure that they are all in sync with one another if we need to make a modification. For example, let us look at the three implementation of Get:public JsonDocument DirectGet(string serverUrl, string key)&#xA;{&#xA;    var metadata = new RavenJObject();&#xA;    AddTransactionInformation(metadata);&#xA;    var request = jsonRequestFactory.CreateHttpJsonRequest(this, serverUrl &#x2B; &quot;/docs/&quot; &#x2B; key, &quot;GET&quot;, metadata, credentials, convention);&#xA;    request.AddOperationHeaders(OperationsHeaders);&#xA;    try&#xA;    {&#xA;        var requestString = request.ReadResponseString();&#xA;        RavenJObject meta = null;&#xA;        RavenJObject jsonData = null;&#xA;        try&#xA;        {&#xA;            jsonData = RavenJObject.Parse(requestString);&#xA;            meta = request.ResponseHeaders.FilterHeaders(isServerDocument: false);&#xA;        }&#xA;        catch (JsonReaderException jre)&#xA;        {&#xA;            var headers = &quot;&quot;;&#xA;            foreach (string header in request.ResponseHeaders)&#xA;            {&#xA;                headers = headers &#x2B; string.Format(&quot;\n\r{0}:{1}&quot;, header, request.ResponseHeaders[header]);&#xA;            }&#xA;            throw new JsonReaderException(&quot;Invalid Json Response: \n\rHeaders:\n\r&quot; &#x2B; headers &#x2B; &quot;\n\rBody:&quot; &#x2B; requestString, jre);&#xA;        }&#xA;        return new JsonDocument&#xA;        {&#xA;            DataAsJson = jsonData,&#xA;            NonAuthoritiveInformation = request.ResponseStatusCode == HttpStatusCode.NonAuthoritativeInformation,&#xA;            Key = key,&#xA;            Etag = new Guid(request.ResponseHeaders[&quot;ETag&quot;]),&#xA;            LastModified = DateTime.ParseExact(request.ResponseHeaders[&quot;Last-Modified&quot;], &quot;r&quot;, CultureInfo.InvariantCulture).ToLocalTime(),&#xA;            Metadata = meta&#xA;        };&#xA;    }&#xA;    catch (WebException e)&#xA;    {&#xA;        var httpWebResponse = e.Response as HttpWebResponse;&#xA;        if (httpWebResponse == null)&#xA;            throw;&#xA;        if (httpWebResponse.StatusCode == HttpStatusCode.NotFound)&#xA;            return null;&#xA;        if (httpWebResponse.StatusCode == HttpStatusCode.Conflict)&#xA;        {&#xA;            var conflicts = new StreamReader(httpWebResponse.GetResponseStreamWithHttpDecompression());&#xA;            var conflictsDoc = RavenJObject.Load(new JsonTextReader(conflicts));&#xA;            var conflictIds = conflictsDoc.Value&lt;RavenJArray&gt;(&quot;Conflicts&quot;).Select(x =&gt; x.Value&lt;string&gt;()).ToArray();&#xA;&#xA;            throw new ConflictException(&quot;Conflict detected on &quot; &#x2B; key &#x2B;&#xA;                                        &quot;, conflict must be resolved before the document will be accessible&quot;)&#xA;            {&#xA;                ConflictedVersionIds = conflictIds&#xA;            };&#xA;        }&#xA;        throw;&#xA;    }&#xA;}&#xA; &#xA;&#xA;&#xA;This is the sync API, of course, next we will look at the same method, for the full .NET framework TPL:&#xA;public Task&lt;JsonDocument&gt; GetAsync(string key)&#xA;{&#xA;    EnsureIsNotNullOrEmpty(key, &quot;key&quot;);&#xA;&#xA;    var metadata = new RavenJObject();&#xA;    AddTransactionInformation(metadata);&#xA;    var request = jsonRequestFactory.CreateHttpJsonRequest(this, url &#x2B; &quot;/docs/&quot; &#x2B; key, &quot;GET&quot;, metadata, credentials, convention);&#xA;&#xA;    return Task.Factory.FromAsync&lt;string&gt;(request.BeginReadResponseString, request.EndReadResponseString, null)&#xA;        .ContinueWith(task =&gt;&#xA;        {&#xA;            try&#xA;            {&#xA;                var responseString = task.Result;&#xA;                return new JsonDocument&#xA;                {&#xA;                    DataAsJson = RavenJObject.Parse(responseString),&#xA;                    NonAuthoritiveInformation = request.ResponseStatusCode == HttpStatusCode.NonAuthoritativeInformation,&#xA;                    Key = key,&#xA;                    LastModified = DateTime.ParseExact(request.ResponseHeaders[&quot;Last-Modified&quot;], &quot;r&quot;, CultureInfo.InvariantCulture).ToLocalTime(),&#xA;                    Etag = new Guid(request.ResponseHeaders[&quot;ETag&quot;]),&#xA;                    Metadata = request.ResponseHeaders.FilterHeaders(isServerDocument: false)&#xA;                };&#xA;            }&#xA;            catch (WebException e)&#xA;            {&#xA;                var httpWebResponse = e.Response as HttpWebResponse;&#xA;                if (httpWebResponse == null)&#xA;                    throw;&#xA;                if (httpWebResponse.StatusCode == HttpStatusCode.NotFound)&#xA;                    return null;&#xA;                if (httpWebResponse.StatusCode == HttpStatusCode.Conflict)&#xA;                {&#xA;                    var conflicts = new StreamReader(httpWebResponse.GetResponseStreamWithHttpDecompression());&#xA;                    var conflictsDoc = RavenJObject.Load(new JsonTextReader(conflicts));&#xA;                    var conflictIds = conflictsDoc.Value&lt;RavenJArray&gt;(&quot;Conflicts&quot;).Select(x =&gt; x.Value&lt;string&gt;()).ToArray();&#xA;&#xA;                    throw new ConflictException(&quot;Conflict detected on &quot; &#x2B; key &#x2B;&#xA;                                                &quot;, conflict must be resolved before the document will be accessible&quot;)&#xA;                    {&#xA;                        ConflictedVersionIds = conflictIds&#xA;                    };&#xA;                }&#xA;                throw;&#xA;            }&#xA;        });&#xA;}&#xA;&#xA;&#xA;&#xA;And here is the Siliverlight version:&#xA;public Task&lt;JsonDocument&gt; GetAsync(string key)&#xA;{&#xA;    EnsureIsNotNullOrEmpty(key, &quot;key&quot;);&#xA;&#xA;    key = key.Replace(&quot;\\&quot;,@&quot;/&quot;); //NOTE: the present of \ causes the SL networking stack to barf, even though the Uri seemingly makes this translation itself&#xA;&#xA;    var request = url.Docs(key)&#xA;        .ToJsonRequest(this, credentials, convention);&#xA;&#xA;    return request&#xA;        .ReadResponseStringAsync()&#xA;        .ContinueWith(task =&gt;&#xA;        {&#xA;            try&#xA;            {&#xA;                var responseString = task.Result;&#xA;                return new JsonDocument&#xA;                {&#xA;                    DataAsJson = RavenJObject.Parse(responseString),&#xA;                    NonAuthoritiveInformation = request.ResponseStatusCode == HttpStatusCode.NonAuthoritativeInformation,&#xA;                    Key = key,&#xA;                    LastModified = DateTime.ParseExact(request.ResponseHeaders[&quot;Last-Modified&quot;].First(), &quot;r&quot;, CultureInfo.InvariantCulture).ToLocalTime(),&#xA;                    Etag = new Guid(request.ResponseHeaders[&quot;ETag&quot;].First()),&#xA;                    Metadata = request.ResponseHeaders.FilterHeaders(isServerDocument: false)&#xA;                };&#xA;            }&#xA;            catch (AggregateException e)&#xA;            {&#xA;                var webException = e.ExtractSingleInnerException() as WebException;&#xA;                if (webException != null)&#xA;                {&#xA;                    if (HandleWebExceptionForGetAsync(key, webException))&#xA;                        return null;&#xA;                }&#xA;                throw;&#xA;            }&#xA;            catch (WebException e)&#xA;            {&#xA;                if (HandleWebExceptionForGetAsync(key, e))&#xA;                    return null;&#xA;                throw;&#xA;            }&#xA;        });&#xA;}&#xA;&#xA;&#xA;&#xA;Did I mention it is annoying?&#xA;All of those methods are doing the exact same thing, but I have to maintain 3 versions of them. I thought about dropping the sync version (it is easy to do sync on top of async), which would mean that I would have only 2 implementations, but I don&#x2019;t like it. The error handling and debugging support for async is still way below what you can get for sync code.&#xA;I don&#x2019;t know if there is a solution for this, I just know that this is a big pain point for me.</p>
        </article>
        <article id="article-4953">
            <a href="https://ayende.com/blog/54273/macto-the-main-screen" target="_blank">
                <h2 class="title mb-6" id="article-4953">Macto</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 08, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I usually like to think about the responsibilities of the system by showing up the UI. It is a great way to communicate with both customers and developers. Here is the main screen for the application:  This is actually a bad place to start with, in terms of coding start points, because it requires so many other things as well. This particular screen is likely to be viewed pretty much everywhere, this is what the prison commanders and the cell blocks commanders have at their desktop, what the officers are using to do their daily work (usually for Counting, admittedly). Even before we can start , it reveals quite a lot about the actual way things work. In this screen, we can see that we have Flagged Dossiers, those are Inmates that have some problem with their Dossier. We can accept Inmates with problematic Dossiers, but we want to fix that as soon as possible, so we make this something that is very much front and center. The &#x201C;Action required&#x201D; section detail Inmates that we have to take some action about. Whatever it is a court date that this inmate have to be at or his sentence is ending or a warrant that need extending.  Finally, and most importantly, we have the counts, which are the most important thing in the prison. You can see that the numbers at the bottom line up. If they don&#x2019;t, we have A Problem.</p>
        </article>
        <article id="article-4954">
            <a href="https://ayende.com/blog/75777/entity-framework-4-1-update-1-backward-compatibility-and-microsoft" target="_blank">
                <h2 class="title mb-6" id="article-4954">Entity Framework 4.1 Update 1, Backward Compatibility and Microsoft</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 05, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that you keep hearing about Microsoft products is how much time and effort is dedicated to ensuring Backward Compatibility. I have had a lot of arguments with Microsoft people about certain design decisions that they have made, and usually the argument ended up with &#x201C;We have to do it this was to ensure Backward Compatibility&#x201D;.  That sucked, but at least I could sleep soundly, knowing that if I had software running on version X of Microsoft, I could at least be pretty sure that it would work in X&#x2B;1. Until Entity Framework 4.1 Update 1 shipped, that is. Frans Bouma has done a great job in describing what the problem actually is, including going all the way and actually submitting a patch with the code required to fix this issue. But basically, starting with Entity Framework 4.1 Update 1 (the issue also appears in Entity Framework 4.2 CTP, but I don&#x2019;t care about this much now), you can&#x2019;t use generic providers with Entity Framework. Just to explain, generic providers is pretty much the one way that you can integrate with Entity Framework if you want to write a profiler or a cacher or a&#x2026; you get the point. Looking at the code, it is pretty obvious that this is not intentional, but just someone deciding to implement a method without considering the full ramifications. When I found out about the bug, I tried figuring out a way to resolve it, but the only work around would require me to provide a different assembly for each provider that I wanted to support (and there are dozens that we support on EF 4.0 and EF 3.5 right now). We have currently implemented a work around for SQL Server only, but if you want to use Entity Framework Profiler with Entity Framework 4.1 Update 1 and a database other than SQL Server, we would have to create a special build for your scenario, rather than have you use the generic provider method, which have worked so far.  Remember the beginning of this post? How I said that Backward Compatibility is something that Microsoft is taking so seriously?  Naturally I felt that this (a bug that impacts anyone who extends Entity Framework in such a drastic way) is an important issue to raise with Microsoft. So I contacted the team with my finding, and the response that I got was basically: Use the old version if you want this supported. What I didn&#x2019;t get was:  Addressing the issue of a breaking change of this magnitude that isn&#x2019;t even on a major release, it is an update to a minor release. Whatever they are even going to fix it, and when this is going to be out. Whatever the next version (4.2 CTP also have this bug) is going to carry on this issue or not. I find this unacceptable. The fact that there is a problem with a CTP is annoying, but not that important. The fact that a fully release package has this backward compatibility issue is horrible.  What makes it even worse is the fact that this is an update to a minor version, people excepts this to be a safe upgrade, not something that requires full testing. And anyone who is going to be running Update-Package in VS is going to hit this problem, and Update-Package is something that people do very often. And suddenly, Entity Framework Profiler can no longer work.  Considering the costs that the entire .NET community has to bear in order for Microsoft to preserve backward compatibility, I am deeply disappointed that when I actually need this backward compatibility.  This is from the same guys that refused (for five years!) to fix this bug: new System.ComponentModel.Int32Converter().IsValid(&quot;yellow&quot;) == true&#xA;&#xA;&#xA;&#xA;Because, and I quote:&#xA;&#xA;We do not have the luxury of making that risky assumption that people will not be affected by the potential change. I know this can be frustrating for you as it is for us. Thanks for your understanding in this matter.&#xA;Let me put this to you in perspective, anyone who is using EF Prof is likely to (almost by chance) to get hit by that. When this happens, our only option is to tell them to switch back a version? &#xA;That makes us look very bad, regardless of what is the actual reason for that. That means that I am having to undermine my users&#x27; trust in my product. &quot;He isn&#x27;t supporting 4.1, and he might not support 4.2, so we probably can&#x27;t buy his product, because we want to have the newest version&quot;. &#xA;This is very upsetting. Not so much about the actual bug, those happen, and I can easily imagine the guy writing the code making assumptions that turn out to be false. Heavens know that I have done the same many times before. I don&#x2019;t even worry too much about this having escaped the famous Microsoft Testing Cycle. &#xA;What (to be frank) pisses me off is that the response that we got from Microsoft for this was that they aren&#x2019;t going to fix this. That the only choice that I have it to tell people to downgrade if they want to use my product (with all the implications that has for my product).</p>
        </article>
        <article id="article-4955">
            <a href="https://www.meziantou.net/rex-regular-expression-exploration-for-dotnet.htm" target="_blank">
                <h2 class="title mb-6" id="article-4955">Rex: Regular Expression Exploration for .NET</h2>
            </a>
            <p class="mb-2">by G&#xE9;rald Barr&#xE9;</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 05, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I think you can imagine I&#x27;m not going to talk about the police dog&#x2026;Rex is a utility designed by a team of Microsoft Research. It allows to generate strings that match a regular expression. Results can be saved to a file for easy use. An example of use:Shellcopy&gt; rex.exe &quot;^[a-z]&#x2B;$&quot; /k:10 /file:to</p>
        </article>
        <article id="article-4956">
            <a href="https://ayende.com/blog/71681/ravendb-session-management-with-nservicebus" target="_blank">
                <h2 class="title mb-6" id="article-4956">RavenDB Session Management with NServiceBus</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 04, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I got a few questions about this in the past, and I thought that I might as well just post how I recommend deal with RavenDB session management for NServiceBus: public class RavenSessionMessageModule : IMessageModule&#xA;{&#xA;  ThreadLocal&lt;IDocumentSession&gt; currentSession = new ThreadLocal&lt;IDocumentSession&gt;();&#xA;&#xA;  IDocumentStore store;&#xA;  &#xA;  public RavenSessionMessageModule(IDocumentStore store)&#xA;  {&#xA;    this.store = store;&#xA;  }&#xA;&#xA;  public IDocumentSession CurrentSession&#xA;  {&#xA;    get{ return currentSession.Value; }&#xA;  }&#xA;&#xA;  public void HandleBeginMessage()&#xA;  {&#xA;    currentSession.Value = store.OpenSession();&#xA;  }&#xA;  &#xA;  public void HandleEndMessage()&#xA;  {&#xA;    using(var old = currentSession.Value)&#xA;    {&#xA;      currentSession.Value = null;&#xA;      old.SaveChanges();&#xA;    }&#xA;  }&#xA;  &#xA;  public void HandleError()&#xA;  {&#xA;    using(var old = currentSession.Value)&#xA;      currentSession.Value = null;&#xA;  }&#xA;}&#xA;&#xA;&#xA;When any of your message handlers needs to get the session, you need to wire the container in such a way that it would provide the RavenSessionMessageModule.CurrentSession to it.</p>
        </article>
        <article id="article-4957">
            <a href="https://ayende.com/blog/74753/advanced-nhibernate-course-warsaw-october-2011" target="_blank">
                <h2 class="title mb-6" id="article-4957">Advanced NHibernate Course&#x2013;Warsaw, October 2011</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 04, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I was very pleasantly surprised by the overwhelmingly positive response to my the idea of running the NHibernate course in Poland. Which is why it gives me great pleasure to announce that I&#x2019;ll be giving my Advanced NHibernate Course in Warsaw, between the 17 October to the 19 October, 2011. You can register using the this link. And in the meantime,   Happy nHibernating</p>
        </article>
        <article id="article-4958">
            <a href="https://ayende.com/blog/53249/macto-warrants-are-for-fools" target="_blank">
                <h2 class="title mb-6" id="article-4958">Macto</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 03, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Warrants are kinda important in a prison. They are the legal authority to limit someone&#x2019;s freedom. In wouldn&#x2019;t be overstating the fact in saying that Warrants are one of the major factors being managed in Macto. There are all kind of Warrants in existence. To list just a few of them:  Arrest Warrant &#x2013; Issued by an officer, generally hold for 24 hours only. Detention Warrant &#x2013; Issued by the court, generally for a short amount of time, up to a few weeks, in most cases. Remand Warrant &#x2013; Issued by the court, generally instructing the prison to hold the Inmate in custody until sentencing (not limited in time). Sentencing Warrant &#x2013; Issued by the court, specifying the total time that an Inmate is to be incarcerated. There are other warrants, such as an Court Arrest Warrant, for example, but for the purpose of Macto, we won&#x2019;t get into those. The type of activity currently required by the prison doesn&#x2019;t really need them, but that might change in the future. There is also another type of Warrant available, it is Whatever The Judge Said Warrant, or as the lawyers call is Mandamus Warrant. It is basically an instruction to do something, and it can be just about anything. From letting the Inmate to call his wife to putting him in a different cell or transferring him to a different prison to command special food / treatment to&#x2026; Well, there is a reason I call it Whatever The Judge Said. The rules for Warrants for incarceration are pretty simple. Each warrant type has an issuer (Arrest Warrants can only be given by Officers of rank Captain and above) for a certain duration (which in some cases, may be limited, such as the 24 hour limit for Arrest Warrants). Depending on the type of Warrant, it can be in Hours, Days, Months or Years. The units in which a warrant is specified are very important. In particular, there is a difference between 30 days incarceration and 1 month incarceration, for example. And hourly Warrants requires that by the time the Warrant expire, you are either got a new one at court or let the Inmate go. The last issued Warrant is always the one that is valid, and all Warrants must be continuous. Gaps in the middle are considered to be a Very Bad thing.</p>
        </article>
        <article id="article-4959">
            <a href="https://ayende.com/blog/59393/challenge-modifying-execution-approaches" target="_blank">
                <h2 class="title mb-6" id="article-4959">Challenge</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 02, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">In RavenDB, we had this piece of code: internal T[] LoadInternal&lt;T&gt;(string[] ids, string[] includes)&#xA;        {&#xA;            if(ids.Length == 0)&#xA;                return new T[0];&#xA;&#xA;            IncrementRequestCount();&#xA;            Debug.WriteLine(string.Format(&quot;Bulk loading ids [{0}] from {1}&quot;, string.Join(&quot;, &quot;, ids), StoreIdentifier));&#xA;            MultiLoadResult multiLoadResult;&#xA;            JsonDocument[] includeResults;&#xA;            JsonDocument[] results;&#xA;#if !SILVERLIGHT&#xA;            var sp = Stopwatch.StartNew();&#xA;#else&#xA;            var startTime = DateTime.Now;&#xA;#endif&#xA;            bool firstRequest = true;&#xA;            do&#xA;            {&#xA;                IDisposable disposable = null;&#xA;                if (firstRequest == false) // if this is a repeated request, we mustn&#x27;t use the cached result, but have to re-query the server&#xA;                    disposable = DatabaseCommands.DisableAllCaching();&#xA;                using (disposable)&#xA;                    multiLoadResult = DatabaseCommands.Get(ids, includes);&#xA;&#xA;                firstRequest = false;&#xA;                includeResults = SerializationHelper.RavenJObjectsToJsonDocuments(multiLoadResult.Includes).ToArray();&#xA;                results = SerializationHelper.RavenJObjectsToJsonDocuments(multiLoadResult.Results).ToArray();&#xA;            } while (&#xA;                AllowNonAuthoritiveInformation == false &amp;&amp;&#xA;                results.Any(x =&gt; x.NonAuthoritiveInformation ?? false) &amp;&amp;&#xA;#if !SILVERLIGHT&#xA;                sp.Elapsed &lt; NonAuthoritiveInformationTimeout&#xA;#else &#xA;                (DateTime.Now - startTime) &lt; NonAuthoritiveInformationTimeout&#xA;#endif&#xA;                );&#xA;&#xA;            foreach (var include in includeResults)&#xA;            {&#xA;                TrackEntity&lt;object&gt;(include);&#xA;            }&#xA;&#xA;            return results&#xA;                .Select(TrackEntity&lt;T&gt;)&#xA;                .ToArray();&#xA;        }&#xA;&#xA;&#xA;And we needed to take this same piece of code and execute it in:&#xA;&#xA;Async fashion&#xA;As part of a batch of queries (sending multiple requests to RavenDB in a single HTTP call).&#xA;Everything else is the same, but in each case the marked line is completely different.&#xA;When we had only one additional option, I choose the direct approach, and implement it using;&#xA;public Task&lt;T[]&gt; LoadAsync&lt;T&gt;(string[] ids)&#xA;{&#xA;    IncrementRequestCount();&#xA;    return AsyncDatabaseCommands.MultiGetAsync(ids)&#xA;        .ContinueWith(task =&gt; task.Result.Select(TrackEntity&lt;T&gt;).ToArray());&#xA;}&#xA;&#xA;&#xA;You might notice a few differences between those approaches. The implementation behave, most of the time, the same, but all the behavior for edge cases is wrong. The reason for that, by the way, is that initially the Load and LoadAsync impl was functionality the same, but the Load behavior kept getting more sophisticated, and I kept forgetting to also update the LoadAsync behavior. &#xA;When I started building support for batches, this really stumped me. The last thing that I wanted to do is to either try to maintain complex logic in three different location or have different behaviors depending if you were using a direct call, a batch or async call. Just trying to document that gave me a headache.&#xA;How would you approach solving this problem?</p>
        </article>
        <article id="article-4960">
            <a href="https://ayende.com/blog/50177/macto-non-functional-concerns-you-are-a-legal-system" target="_blank">
                <h2 class="title mb-6" id="article-4960">Macto</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: August 01, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Macto is a system that operates in a highly legislative environment. As such, we have to be prepared for the court to ask us to show our records about a particular Inmate. Part of that is ensuring that we preserve the history of the Inmate&#x2019;s Dossier. An example where this would be relevant is when a lawyer contend the legality of incarcerating the Inmate. You have to show not only that you have legal authority to incarcerate the guy, you also have to show that you had that authority continuously throughout the incarceration period. A typical case where there is a problem is shown below:  27 June 2011 20:52 &#x2013; Arrest by Sargent Azulay for car vandalizing.  29 June 2011 09:15 &#x2013; Detention, 8 days by Judge Judy  5&#xA0;&#xA0; July 2011 &#x2013; Remanded in Custody by Judge Thachil Oti  14 Aug 2011 &#x2013; Sentenced, 3 months by Judge Koev Li  27 Sep 2011 &#x2013; Released at end of sentence Do you see the problem? You probably don&#x2019;t, but for me, it shouts. The issue is that an Arrest is only valid for 24 hours. Because of the gap in the incarceration warrants, a lawyer can usually get an Inmate out. That means that part of what the system has to do is to be able to say not only what the current state, but what was the state at any given point in time. Those are usually called Temporal Systems, or Append Only systems, since you are not allowed to make modifications existing data, only create new data. They also tend to be quite hard to work with, but this is still isn&#x2019;t a post about the technical stuff, so we will let it go until we get to the good parts.</p>
        </article>
        <div class="button flex justify-between">
            <a href="495.html"><span class="back arrow"></span></a>

            <a href="497.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>

<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">© Relatively General
                        .NET 2025<span
                            class="inline-block">&nbsp;🚀&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="about.html"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="/pagefind/pagefind-ui.js"></script>

<!-- Cookie Consent Banner -->
<div class="cookie-consent" id="cookieConsent">
    <div>
        <p class="text-sm">We use cookies to analyze our website traffic and provide a better browsing experience. By
            continuing to use our site, you agree to our use of cookies.</p>
    </div>
    <div class="cookie-consent-buttons">
        <button class="cookie-consent-decline" onclick="declineCookies()">Decline</button>
        <button class="cookie-consent-accept" onclick="acceptCookies()">Accept</button>
    </div>
</div>

<script>
    // Cookie consent management
    function showCookieConsent() {
        const consent = localStorage.getItem('cookieConsent');
        if (!consent) {
            document.getElementById('cookieConsent').classList.add('show');
        }
    }

    function acceptCookies() {
        localStorage.setItem('cookieConsent', 'accepted');
        document.getElementById('cookieConsent').classList.remove('show');
        loadGA(); // Load Google Analytics after consent
    }

    function declineCookies() {
        localStorage.setItem('cookieConsent', 'declined');
        document.getElementById('cookieConsent').classList.remove('show');
    }

    // Show the consent banner only for EU visitors (you can add more country codes as needed)
    fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const euCountries = ['AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'];
                if (euCountries.includes(data.country_code)) {
                    showCookieConsent();
                } else {
                    // For non-EU visitors, automatically load GA
                    if (!localStorage.getItem('cookieConsent')) {
                        localStorage.setItem('cookieConsent', 'accepted');
                        loadGA();
                    }
                }
            })
            .catch(() => {
                // If we can't determine location, show the consent banner to be safe
                showCookieConsent();
            });
</script>
</body>
</html>
