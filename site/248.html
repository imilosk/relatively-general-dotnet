
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Home â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">
<script>
    const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

    function getUserPref() {
        const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
        return storedTheme || (lightModePref.matches ? "light" : "dark");
    }

    function setTheme(newTheme) {
        if (newTheme !== "light" && newTheme !== "dark") {
            return console.warn(
                `Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
            );
        }

        const root = document.documentElement;

        // root already set to newTheme, exit early
        if (newTheme === root.getAttribute("data-theme")) {
            return;
        }

        root.setAttribute("data-theme", newTheme);

        const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
        const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
        colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
        if (typeof localStorage !== "undefined") {
            localStorage.setItem("theme", newTheme);
        }
    }

    // initial setup
    setTheme(getUserPref());

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("theme-toggle").addEventListener("click", () => {
            const theme = localStorage.getItem("theme");

            if (theme === "dark") {
                setTheme("light");
            } else {
                setTheme("dark");
            }
        });

        document.getElementById("toggle-navigation-menu").addEventListener("click", (e) => {
            const button = e.target;
            const ariaExpanded = button.getAttribute("aria-expanded");
            const header = document.getElementById("main-header");

            if (ariaExpanded === "true") {
                button.setAttribute("aria-expanded", "false");
                header.classList.remove("menu-open");
            } else {
                button.setAttribute("aria-expanded", "true");
                header.classList.add("menu-open");
            }
        });
    });
</script>

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <theme-toggle class="ms-auto">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main">
    <section aria-label="Blog post list">
        <a href="https://ayende.com/blog/169985/excerpts-from-the-ravendb-performance-team-report-facets-of-information-part-i" target="_blank"><h1 class="title mb-6">Excerpts from the RavenDB Performance team report</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 12, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Facets are annoying. Mostly because they tend to be used relatively rarely, but when they are used, they are used a lot, and in many interesting ways. Because they are fairly rarely used, let me explain what they are first.  We want to show the users all the recent phones. We can do this using the following query:  from phone in session.Query&lt;Phone&gt;() orderby phone.ReleaseDate descending select phone;&#xA;&#xA;So far, so good. But we want to do better than just show a potentially big list to the user. So we start faceting the results. We pull some interesting pieces of data from the results, and allow the user to quickly narrow down the details. Typical facets for a phone query would be:&#xA;&#xA;Brand &#xA;Screen Size &#xA;Camera &#xA;Cost&#xA;Now, we can certainly give the&#xA0; option to search for them individually, but then you end up with something like this:&#xA;&#xA;That is neither friendly nor very useful. so UX designers came up with this idea, instead:&#xA;&#xA;This gives the user a much easier way to look at the large data sets, and quickly narrow down the search to just the things they want. It also gives the user some indication about the actual data. I can see how changing the facet selection would likely change the number of results I have. This is a great way to offer data exploration capabilities. And in any kind of data repository, this is crucial. Shopping sites are a natural choice, but content/document management systems, job sites, information centers are all commonly making use of this feature.&#xA;&#xA;I&#x2019;m sorry for the long intro, but I feel that this feature needs to be placed in context, to explain its history and the various iterations it has gone through.&#xA;We first got this feature in Sep 2011. It was a pull request from Matt Warren, apparently based on some code that I spiked. I intentionally goes there, because that is the first time we see this code, and it was implemented in the simplest possible manner that could possibly work, to showcase this feature and to make sure that it works end to end. The underlying implementation looked something like this:&#xA;&#xA;private void HandleTermsFacet(string index, Facet facet, IndexQuery indexQuery, IndexSearcher currentIndexSearcher, &#xA;&#x9;Dictionary&lt;string, IEnumerable&lt;FacetValue&gt;&gt; results)&#xA;{&#xA;&#x9;var terms = database.ExecuteGetTermsQuery(index,&#xA;&#x9;&#x9;facet.Name,null,&#xA;&#x9;&#x9;database.Configuration.MaxPageSize);&#xA;&#x9;var termResults = new List&lt;FacetValue&gt;();&#xA;&#x9;foreach (var term in terms)&#xA;&#x9;{&#xA;&#x9;&#x9;var baseQuery = database.IndexStorage.GetLuceneQuery(index, indexQuery);&#xA;&#x9;&#x9;var termQuery = new TermQuery(new Term(facet.Name, term));&#xA;&#xA;&#x9;&#x9;var joinedQuery = new BooleanQuery();&#xA;&#x9;&#x9;joinedQuery.Add(baseQuery, BooleanClause.Occur.MUST);&#xA;&#x9;&#x9;joinedQuery.Add(termQuery, BooleanClause.Occur.MUST);&#xA;&#xA;&#x9;&#x9;var topDocs = currentIndexSearcher.Search(joinedQuery, 1);&#xA;&#xA;&#x9;&#x9;if(topDocs.totalHits &gt; 0)&#xA;&#x9;&#x9;&#x9;termResults.Add(new FacetValue&#xA;&#x9;&#x9;&#x9;{&#xA;&#x9;&#x9;&#x9;&#x9;Count = topDocs.totalHits,&#xA;&#x9;&#x9;&#x9;&#x9;Range = term&#xA;&#x9;&#x9;&#x9;});&#xA;&#x9;}&#xA;&#xA;&#x9;results[facet.Name] = termResults;&#xA;}&#xA;In other words, the overall logic was something like this:&#xA;&#xA;Get a faceted query, with a list of facets.&#xA;For each facet:&#xA;&#xA;Get all the terms for the field (if this is Operating System, then that would be: Android, iOS, BlackBerry, Windows Phone)&#xA;For each of those terms, executed the original query and add a clause that limit the results to the current term and value.&#xA;As you can imagine, this has some.. performance issues. The more facets we had, and the more terms per facets, the costlier this got. Surprisingly enough, this code lasted almost unmodified for about 10 months, and the next major change was simply to process all of this in parallel. &#xA;Shortly thereafter, we have more changes. Moving from this trivial model to a much more efficient one, where we are executing the query once (PR from Michael Weber, by the way) per facet, instead of once per facet/term. Dynamic aggregation in RavenDB is also done through facets, and that added a much more common code path, so more changes started happening to the facets code. In particular, we started handling caching, we ended up reducing the time to run by a lot by restructuring how we were handling things so we would only executed a single query, then use low level index access to get all the other information we needed in an optimized fashion.&#xA;We got more customer usage sample, from the guys who had 70,000 facet queries to the people who wanted facets over multiple millions of results. All of that meant that we put a lot of thought into how we can reduce the performance of faceted queries, and over time, things because more and more complex, but much faster. In particular, by ordering the sequence of operations for computing the query, adding prefetching support and in general greatly reduced the amount of work we needed to do to just get the query working.&#xA;The end result was that the facet code looked something like this:&#xA;&#xA;IndexedTerms.ReadEntriesForFields(currentState, fieldsToRead, allCollector.Documents,&#xA;    (term, docId) =&gt;&#xA;    {&#xA;        List&lt;Facet&gt; facets;&#xA;        if (!sortedFacets.TryGetValue(term.Field, out facets))&#xA;            return;&#xA;        &#xA;        foreach (var facet in facets)&#xA;        {&#xA;            switch (facet.Mode)&#xA;            {&#xA;                case FacetMode.Default:&#xA;                    var facetValues = facetsByName.GetOrAdd(facet.DisplayName);&#xA;                    FacetValue existing;&#xA;                    if (facetValues.TryGetValue(term.Text, out existing) == false)&#xA;                    {&#xA;                        existing = new FacetValue&#xA;                        {&#xA;                            Range = GetRangeName(term)&#xA;                        };&#xA;                        facetValues[term.Text] = existing;&#xA;                    }&#xA;                    ApplyFacetValueHit(existing, facet, docId, null, currentState, fieldsCrc);&#xA;                    break;&#xA;                case FacetMode.Ranges:&#xA;                    // removed for brevity&#xA;                    break;&#xA;                default:&#xA;                    throw new ArgumentOutOfRangeException();&#xA;            }&#xA;        }&#xA;&#xA;    });});&#xA;There is a lot of stuff going on around this code, but this is where we actually computed the facets. Note that this basically calls the lambda once per every matching term for the specified fields for every document in the query.&#xA;And the performance was pretty good for our test cases, we run this through several customers who were heavy facet users, and they saw a marked improvement in performance of queries. But we recently got a customer that mentioned in passing that facet queries were expensive. As in, 5 &#x2013; 10 seconds range per query. That raised some red flags, we consider requests that takes more than 100ms to be suspicious, so we asked for more information, and we realized that he was using facets slightly differently from most of our customers.&#xA;Usually, facets are used to&#x2026; well, facet the data on a search. Typical performance issues with facets in the past were with large number of facets on a search result (I wasn&#x2019;t kidding with the 70,000 facets). Because most of the customer feedback we got was around that, we focused on this issue primarily, to the point were even stuff like that was well behaving. This customer, however, was using facets not for searching, but as a way to manage the data itself. That meant that they were using a lot of facets on the entire data set. &#xA;So instead of having many facets on a medium size number of documents, we were using a small number of facets, but on the entire data set. Profiling this resulted in a few calls being highlighted:&#xA;&#xA;GetOrAdd&#xA;TryGetValue&#xA;They are very cheap calls, on their own, but this piece of code was called literally tens of millions of times for this particular scenario. We spent some time with a profiler and started playing with the code, trying to see if we can remove the costly calls and optimize this code path.&#xA;The answers was&#x2026; no. In fact, everything we did was in the range of 5% &#x2013; 7% change (in both directions, mind). &#xA;This sucked, because going back to the user and saying: &#x201C;that is the way it is&#x201D; didn&#x2019;t sit well with us. We got together, closed the shutters, turned off the light, and solely by the light of the monitors, we did a major hacking session. We completely changed the way we were handling facets, to avoid not just the problem with the calls to TryGetValue or GetOrAdd but to change direction to a much more efficient mode.&#xA;This post is getting pretty long, so I&#x2019;ll discuss this in my next post. For now, can you suggest options for improvements?</p>
        <a href="https://ayende.com/blog/169953/figure-this-code" target="_blank"><h1 class="title mb-6">Figure this code?</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 11, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have just finished writing this code, and it occurred to me that on its own, it makes very little sense.&#xA;&#xA;&#x9;&#xA;&#x9;&#x9;private static int RedactedFunctionName(List&lt;int&gt; a, List&lt;int&gt; b)&#xA;{&#xA;    List&lt;int&gt; n,m;&#xA;    if (a.Count &gt; b.Count)&#xA;    {&#xA;        n = a;&#xA;        m = b;&#xA;    }&#xA;    else&#xA;    {&#xA;        n = b;&#xA;        m = a;&#xA;    }&#xA;&#xA;    int nSize = n.Count;&#xA;    int mSize = m.Count;&#xA;&#xA;    double o1 = nSize &#x2B; mSize;&#xA;    double o2 = nSize * Math.Log(mSize, 2);&#xA;&#xA;    int result = 0;&#xA;    if (o1 &lt; o2)&#xA;    {&#xA;        int mi = 0, ni = 0;&#xA;        while (mi &lt; mSize &amp;&amp; ni &lt; nSize)&#xA;        {&#xA;            if (n[ni] &gt; m[mi])&#xA;            {&#xA;                mi&#x2B;&#x2B;;&#xA;            }&#xA;            else if (n[ni] &lt; m[mi])&#xA;            {&#xA;                ni&#x2B;&#x2B;;&#xA;            }&#xA;            else&#xA;            {&#xA;                ni&#x2B;&#x2B;;&#xA;                mi&#x2B;&#x2B;;&#xA;                result&#x2B;&#x2B;;&#xA;            }&#xA;        }&#xA;    }&#xA;    else&#xA;    {&#xA;        for (int i = 0; i &lt; mSize; i&#x2B;&#x2B;)&#xA;        {&#xA;            if (n.BinarySearch(m[i]) &gt;= 0)&#xA;                result&#x2B;&#x2B;;&#xA;        }&#xA;    }&#xA;    return result;&#xA;}&#xA;&#x9;&#xA;&#xA;&#xA;&#x9;Can you figure out what this function does, why is it behaving in this manner, and what preconditions it expects?</p>
        <a href="https://ayende.com/blog/170145/inside-ravendb-3-0-chapter-9-is-out" target="_blank"><h1 class="title mb-6">Inside RavenDB 3.0&#x2013;Chapter 9 is out</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 10, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Chapter 9 of the Inside RavenDB 3.0 book is now available. This chapter goes over Full Text Search, and how to make the best use of that in RavenDB. It covers how Full Text Search works, Suggestions, Facets, and more.  You can download it using the following link. We now have PDF, Kindle and ePub versions available.</p>
        <a href="https://ayende.com/blog/170146/new-ravendb-3-0-stable-release" target="_blank"><h1 class="title mb-6">New RavenDB 3.0 Stable Release</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 09, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">We have been hard at work in the past three months, and according to the statistics, we got quite a few things done, 1,144 commits a host of new features and serious performance improvements are out. I&#x2019;ll do another post shortly on our future work, but for now, here is what is new in this release:  Side by Side indexing Indexing performance timeline Index tryouts&#xA0; Data Subscriptions We also made a lot of performance improvements, most of them were discussed in this blog, but I think that you&#x2019;ll like the new numbers. There are also things that we did mostly as preparation of future work, such as:  Voron running on Linux&#xA0; Minimal incremental backup in Voron Rachis: Raft implementation for RavenDB You&#x2019;ll be hearing a lot more on those when we are ready for the next round of feature releases. In the meantime, you can head here for the new build, hot off the press.</p>
        <a href="https://enterprisecraftsmanship.com/posts/shared-library-vs-enterprise-development/" target="_blank"><h1 class="title mb-6">Shared library vs Enterprise development</h1></a>
        <p class="mb-2">by Vladimir Khorikov</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 08, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Most of the development principles are applicable to any software you might develop. Nevertheless, there are some differences between building a reusable library and an enterprise application. Those differences often become sticking points as we try to apply experience gained in one type of project to projects of the other type.&#xA;&#xA;&#xA;The differences between shared library and enterprise development&#xA0;grow from differences in requirements and lifetime support cycle.</p>
        <a href="https://ayende.com/blog/169861/excerpts-from-the-ravendb-performance-team-report-do-you-copy-that" target="_blank"><h1 class="title mb-6">Excerpts from the RavenDB Performance team report</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 06, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Note, this post was written by Federico. This series relies heavily on the optimization work we did on the optimizing memory comparisons, if you haven&#x2019;t read it, I suggest you start there instead. If memory compare is the bread, memory copy is the butter in an storage engine. Sooner or later we will need to send the data to disk, in the case of Voron we use memory mapped files so we are doing the copy ourselves. Voron also uses a copy-on-write methodology to deal with tree changes, so there are plenty of copy commands around.   Differently from the memory compare case where an optimized version already existed. In the case of memory copy we relied on a p/invoke call to memcpy because we usually move lots of memory around and it is hard to compete in the general case with an assembler coded version.&#xA0; Scrap that, it is not hard, it is extremely hard!!! Don&#x2019;t underestimate the impact that SSE extensions and access to the prefetching operation can have on memcpy. [1]  However, usually not all memory copies are created equally and there is plenty opportunity to do some smart copy; our code wasn&#x2019;t exactly an exception to the rule. The first work involved isolating the places where the actual &#x201C;big copies&#x201D; happen, especially where the cost of actually doing a p/invoke call gets diluted by the sheer amount of data copied [2] in the statistically representative case. You guessed right, for that we used our FreeDB example and the results were very encouraging, there&#xA0; were a couple of instances of &#x201C;big copies&#x201D;. In those cases using the P/Invoke memcpy was not an option, but for the rest we had plenty of different alternatives to try.  The usual suspects to take over our P/Invoke implementation for small copies would be Buffer.BlockCopy, the MSIL cpblk operation and Buffer.Memcpy which is internal, but who cares, we can still clone it .  The general performance landscape for all our alternatives is:  What we can get from this is: Buffer.Memcpy should be the base for any optimization effort until we hit the 2048 bytes where all behave more or less in the same way. If&#xA0; we have to choose between Buffer.BlockCopy and memcpy though, we will select the latter because when running in 32 bits the former is pretty bad. [3]  Having said that, the real eye opener here is the for-loop which is always a bad bet against Buffer.Memcpy. Specially because that&#x2019;s usual strategy followed when copying less than 32 bytes.  There is also another interesting tidbit here, Buffer.Memcpy has some pretty nasty discontinuities around 16 bytes and 48 bytes.  Size: 14 Memcpy: 128 Stdlib: 362 BlockCopy: 223 ForLoop: 213&#xA;Size: 16 Memcpy: 126 Stdlib: 336 BlockCopy: 220 ForLoop: 235&#xA;Size: 18 Memcpy: 170 Stdlib: 369 BlockCopy: 262 ForLoop: 303&#xA;Size: 20 Memcpy: 160 Stdlib: 368 BlockCopy: 247 ForLoop: 304&#xA;Size: 22 Memcpy: 165 Stdlib: 399 BlockCopy: 245 ForLoop: 312&#xA; &#xA;Size: 44 Memcpy: 183 Stdlib: 499 BlockCopy: 257 ForLoop: 626&#xA;Size: 46 Memcpy: 181 Stdlib: 563 BlockCopy: 264 ForLoop: 565&#xA;Size: 48 Memcpy: 272 Stdlib: 391 BlockCopy: 257 ForLoop: 587&#xA;Size: 50 Memcpy: 342 Stdlib: 447 BlockCopy: 290 ForLoop: 674&#xA;Size: 52 Memcpy: 294 Stdlib: 561 BlockCopy: 269 ForLoop: 619&#xA;&#xA;&#xA;What would you do here?&#xA;&#xA;&#xA;[1] With RyuJIT there are new vectorised operations (SIMD). We will certainly look for opportunities to implement a fully managed&#xA0; version of memcpy if possible.&#xA;[2] For a detailed analysis of the cost of P/Invoke and the Managed C&#x2B;&#x2B;/CLI Interface you can go the this article: http://www.codeproject.com/Articles/253444/PInvoke-Performance&#xA;[3] For detailed metrics check: http://code4k.blogspot.com.ar/2010/10/high-performance-memcpy-gotchas-in-c.html</p>
        <a href="https://ayende.com/blog/170113/this-exception-never-happened" target="_blank"><h1 class="title mb-6">This exception never happened</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 05, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I&#x2019;m not sure what is going on, but it is strange.  This seems to be related to having multiple catch statements with the same exception name, but I can&#x2019;t reproduce this in isolation. And it seems that other people have run into it as well: http://stackoverflow.com/questions/5650868/net-exception-caught-is-unexpectedly-null Worked around it by changing the parameter name&#x2026; but still, really strange.</p>
        <a href="https://ayende.com/blog/169860/excerpts-from-the-ravendb-performance-team-report-optimizing-compare-conclusions" target="_blank"><h1 class="title mb-6">Excerpts from the RavenDB Performance team report</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 05, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Note, this post was written by Federico. We are done with the optimizations, but the question remains. Was all this trouble worthwhile?  If you remember from the first post in this series, based on our bulk insert scenario I said that each comparison in average takes us 97.5 nanoseconds. Now let&#x2019;s first define what that means.  The most important thing is to understand what are the typical characteristics of this scenarios.   All the inserts are in the same collection. Inserts are in batches and with sequential ids. Document keys share the first 10 bytes. (which is very bad for us but also explains why we have a cluster around 13 bytes). No map-reduce keys (which are scattered all over the place) No indexing happens.  In short, we gave ourselves a pretty bad deal.  We are dealing with a live database here, we can control the scenario, but it is insanely difficult to control the inner tasks as we do with micro-benchmarks. Therefore all percentage gains use call normalization which allows us to make an educated guess of what would have been the gain under the same scenario. The smaller the difference in calls, the less noise or jitter in the measurement.  So without further ado this is the comparison before-after with call normalization.  With our nightmare scenario we get a 10% improvement. We went from 97.5 nanoseconds per compare to 81.5 nanoseconds. Which is AWESOME if we realize we were optimizing an already very tight method.  What this means in context? Let&#x2019;s take a look at the top user on this workload, searching a page.  Before:  After:  It seems that we got better, but also there is something different. Why those gets are missing? In the first batch of optimizations we requested the compiler to aggressively inline those properties, now those properties are part of the call-site with optimized code. A bit off-topic but when optimizing first look for these before going in an optimization frenzy.  This is the search method after optimization.   Our 10% improvement on the Memory Compare gave us almost an extra 4% in the search when bulk inserting. Which for a method that is called in the billions range calls on real life workloads, is pretty damn good.  And this concludes the series about memory compare, hope you have enjoyed it.  PS: With all the information provided, where do you guess I will look afterwards for extra gains?</p>
        <a href="https://ardalis.com/software-application-assessments/" target="_blank"><h1 class="title mb-6">Software Application Assessments</h1></a>
        <p class="mb-2">by Ardalis</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 04, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I just completed a Software Application Assessment for one of our clients, and will be presenting the report to them this week. We&#x2026;Keep Reading &#x2192;</p>
        <a href="https://ayende.com/blog/169859/excerpts-from-the-ravendb-performance-team-report-comparing-branch-tables" target="_blank"><h1 class="title mb-6">Excerpts from the RavenDB Performance team report</h1></a>
        <p class="mb-2">by Oren Eini</p>
        <p class="mb-6 flex gap-1.5">
                    <span>
                                    <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                                         xmlns="http://www.w3.org/2000/svg"><path
                                            xmlns="http://www.w3.org/2000/svg"
                                            d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
            posted on: February 04, 2015
        </p>
        <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Note, this post was written by Federico. In the previous post  after inspecting the decompiled source using ILSpy&#xA0; we were able to uncover potential things we could do. In the last post we found out that the housekeeping of our last loop is non negligible, but we also know it&#x2019;s execution is bounded by n. From our static analysis we know that n cannot be bigger than a word or 8 bytes.  To build an efficient loop what we can do is exploit our knowledge on how to &#x201C;hint&#x201D; the compiler to build a branch table and build customized code for each one of the cases.  We ended up paying some housekeeping because the code gets unwieldy pretty fast. We know we can still go that road if we need to.  The performance of this loop trades comparisons with branch tables and gets rid of the comparison of n (notice that we have an endless loop here). But to squeeze the latest few nanoseconds there is a very important tidbit that could easily pass inadvertent.  Mileage will vary in real workloads but let&#x2019;s do a couple of assumptions just for the purpose of illustrate the optimization.  Let&#x2019;s say that in half of the requests the memory blocks are equal and on the other half they are not. That means that half of our request will be our worst case scenario, good news is that we have optimized the hell out of it. But what about the other half? For simplicity we will assume that if 2 memory blocks are different there is an uniform probability of it to be different at position n.  That means:   If we are comparing 3 bytes memory blocks there is a chance of 1/3 that byte-1 is different and 2/3 that it&#x2019;s not. If byte-1 of the memory blocks are equal, then there is 1/3 of a chance that byte-2 will be different. &#xA0;And so on.  For the mathematically inclined, this looks like a geometric distribution (http://en.wikipedia.org/wiki/Geometric_distribution).  Or the probability distribution of the number X of Bernoulli trials needed to get a desired outcome, supported on the set { 1, 2, 3, ...}  So let&#x2019;s say that we have X compares to do in order to rule out equality of the memory blocks (our worst case scenario).  From Wikipedia:  In our example, the probability p = 0.66.&#xA0; Why? Because that is the probability of &#x201C;successes&#x201D; until we &#x201C;fail&#x201D; &#x2026; You will notice that success and fail are inverted in our case, because what matter to us is the failure. But mathematically speaking using the other probability would be wrong, it is just a matter of interpretation.   Now the important tidbit here is, no matter how long is the memory block (or lower the p-value), the cumulative distribution function will always grow pretty fast. To us, that means that the chances to find a difference in the first X bytes if the memory blocks are different is pretty high. In the context of Voron, let&#x2019;s say we are looking for a particular key out there in a tree. If the keys are spread apart we are going to be able to rule them out pretty fast until we are in the neighborhood of the key, where we will need to check more bytes to know for sure.  The code to achieve this optimization is quite simple, we already used it to optimize the last-loop.   So we just copy the switch block into the entrance of method. If the size of the memory block is 0 to 3, we will have a fast-return. In the case of bigger memory blocks, we will consume the first 4 bytes (32 bits) before starting to test with words.  If I were to modify the original implementation and just add this optimization. What&#x2019;s would the speed up be under this theoretical workload? (I will publish that in the comments section in a couple of days J so make your educated guess).     Ayende&#x2019;s note: That said, there is actually another thing to consider here. It is very common for us to have keys with shared prefixes. For example, &#x201C;users/1&#x201D;, &#x201C;users/2&#x201D;, etc. In fact, we are trying hard to optimize for that route because that gives us a better structure for the internal B&#x2B;Tree that we use in Voron.</p>
        <div class="button flex justify-between">
            <a href="247.html"><span class="back arrow"></span></a>

            <a href="249.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
</body>
</html>