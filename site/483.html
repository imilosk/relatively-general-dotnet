
<!DOCTYPE html>
<html class="scroll-smooth" lang="en-US" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <title>Page 483 â€¢ Relatively General .NET</title>
    <link href="favicon.ico" rel="icon" sizes="any">
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon">
    <meta content="hsl()" name="theme-color">
    <meta content="website" property="og:type">
    <meta content="Home" property="og:title">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="pagefind/pagefind-ui.css">
</head>
<body class="mx-auto flex min-h-screen max-w-3xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8">

<a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">
    skip to content
</a>
<header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
    <div class="flex sm:flex-col">
        <a aria-current="page" class="inline-flex items-center hover:filter-none sm:relative sm:inline-block"
           href="index.html">
            <img class="me-3 sm:absolute sm:start-[-4.5rem] sm:me-0 sm:h-16 sm:w-16 w-16" src="images/giphy.gif"
                 alt=""/>
            <span class="text-xl font-bold sm:text-2xl">Relatively General .NET</span>
        </a>
        <nav aria-label="Main menu"
             class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none"
             id="navigation-menu">
            <a aria-current="page" class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline"
               href="index.html"> Home </a><a
                class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" href="/about/">
                About </a>
        </nav>
    </div>
    <site-search class="ms-auto" id="search">
        <button id="open-search"
                class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2"
                data-open-modal="">
            <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" stroke="none"></path>
                <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
            </svg>
        </button>
        <dialog aria-label="search"
                class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md">
            <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6">
                <button id="close-search"
                        class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700"
                        data-close-modal="">Close
                </button>
                <div class="search-container">
                    <div id="cactus__search"/>
                </div>
            </div>
        </dialog>
    </site-search>
    <theme-toggle class="ms-2 sm:ms-4">
        <button id="theme-toggle" class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2"
                type="button">
            <span class="sr-only">Dark Theme</span>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0"
                 fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100"
                 fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
                <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
                <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path>
                <path d="M19 11h2m-1 -1v2"></path>
            </svg>
        </button>
    </theme-toggle>
    <mobile-button>
        <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu"
                class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button">
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
                 fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <svg aria-hidden="true"
                 class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
                 fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5"
                 viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </button>
    </mobile-button>
</header>
<main id="main" data-pagefind-body>
    <section aria-label="Blog post list">
        <article id="article-4821">
            <a href="https://ayende.com/blog/4829/ravenfs-rsync" target="_blank">
                <h2 class="title mb-6" id="article-4821">RavenFS &amp; Rsync</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 01, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the things that I considered when starting to design RavenFS is &#x201C;Do we really need this? Can&#x2019;t we just use rsync?&#x201D;  There were several reasons why I decided to go ahead with RavenFS. The first was that rsync isn&#x2019;t really used on the Windows platform, for various reasons that I won&#x2019;t get into.  The second is that rsync is meant to be a general purpose file synchronization tool. RavenFS is meant to be more than that.   More specifically, RavenFS is aimed specifically at distribution and synchronization of large files (tens of MB are considered small, hundreds of MB are common and multiple GBs are frequently used). It turns out that very large files mean a whole different kettle of fish. I am going to reference the thesis project of Andrew Tridgell quite frequently for the rest of this post (and you can find the link at the bottom of this post). Andrew is the author of rsync, so he probably knows a thing or two about synchronization problems.  In particular, he had thought about and discarded my approach for synchronizing files in his thesis:     This algorithm is very simple and meets some of the aims of our remote update algorithm, but it is useless in practice     The problem with it is that A can only find matches that are on block boundaries. If the file on A is the same as B except that one byte has been inserted at the start of the file then no block matches will be found and the algorithm will transfer the whole file.   This is absolutely correct. My approach, by design, suffer from the &#x201C;inserting a single byte at beginning of file&#x201D;. Why do I take such a stupid approach?  Put simply, because anything else is too expensive. The rsync approach is to compute a hash at byte boundaries, it gets away with that with having multiple hash functions, one of which is very cheap to compute (with higher number of collisions possible) and another that is more expensive to compute but has far lower probability of collisions.  Now, go up and look at the description of RavenFS. It is meant for very large files. Are you really going to perform an operation on every single byte on the file when the file is 2 GB in size?  This is where a very interesting property of file systems come into place. Let us assume that you have the following file, shown as a sequence of bytes:     [1,2,3,4]   And let us say that we want to add the byte 0 at the beginning of the file. For now, we will assume buffer size of 1, we will have to issue the following commands to the file system to do so:     Write 0 to position 1    Write 1 to position 2    Write 2 to position 3    Write 3 to position 4    Write 4 to position 5 &lt;&#x2014;increase the file size   In other words, inserting a value (vs modifying a value) is an O( File.Length &#x2013; File.Position). In other words, the closer to the beginning of the file you are, the more expensive it is to insert a new value.  Ponder that while considering the cost of doing something like that on files that are big. Let us assume a more reasonable file size of 4,096 (the .NET default), and we realize that inserting a value into the beginning of a 500 MB file would require 128 thousand file system operations.  In practice, this isn&#x2019;t a real issue because most of the time, when we are talking about such large files, we are talking about either files that are using fixed sized records ( no inserting whatsoever ) or appending data to the end of the file. That is mostly because there really isn&#x2019;t any other choice for them, in order to preserve reasonable performance.  RavenFS is meant to take advantage on this aspect to make the &#x201C;useless in practice&#x201D; option a viable option.  On a separate issue, this quote made me laugh:     The lack of such a routine was quite a surprise and prompted me to look into the whole issue of parallel sorting, totally ignoring the fact that I only wanted a parallel sorting routine in order to solve a problem that didn&#x2019;t really require sorting at all.    ~ Andrew Tridgell http://samba.org/~tridge/phd_thesis.pdf</p>
        </article>
        <article id="article-4822">
            <a href="https://ayende.com/blog/4828/designing-ravenfs" target="_blank">
                <h2 class="title mb-6" id="article-4822">Designing RavenFS</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: May 01, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">What is Raven FS? Raven FS is a distributed file system designed to handle large file replication across WAN networks reliably.   What does it actually means? The scenario that we have is actually quite simple. Given that we have a file in location A and we need to have that file in location B (geo distributed) how do we move the file across the WAN? Let me make the problem slightly more interesting:     The file is large, we are talking about hundreds of megabytes at the low range and tens of gigabytes at the high end.     The two locations might be connected over WAN.     The connection is assumed to be flakey.    Let us consider the a few scenarios where this can be useful:     I have a set of videos that I would like to be edited in some fashion (say, putting Bang! and Wham! callouts in some places). Since I have zero ability in editing videos, I hire a firm in India to do that for me. The problem is that each video file is large, and just sending the files to India and back is a challenge. (Large file distributed collaboration problem)     I have a set of webservers where users can upload images. We need to send those images to background servers for processing, and then they need to be made available to the web servers again. The image sizes are too large to be sent over traditional queuing technologies. (Udi Dahan calls the problem the Data Bus).     I have a set of geo-distributed locations where I have a common set of files (think about something like scene information for rendering a game) that needs to be kept in sync. (Distributed file replication).    I have run into each of those problems (and others that fall into similar categories) several times in recent months. Enough to convince me that:     There is a need here that people would be willing to pay for.     It is something that we can provide a solution for.     There is a host of other considerations related to those set of problems that we can also provide a solution for. A simple example might be simple backup procedures.    The actual implementation will probably vary, but this is the initial design for the problem.  A RavenFS node is going to be running as an HTTP Web Server. That removes a lot of complexity from our life, since we can utilize a lot of pre-existing protocols and behaviors. HTTP already supports the notion of partial downloads / parallel uploads, (Range, If-Range, Content-Range), so we can re-use a lot of that.  From an external implementation perspective, RavenFS node exposes the following endpoints:     GET /static/path/to/file &lt;- get the file contents, optionally just a range     PUT /static/path/to/file &lt;- put file contents, optionally just a range     DELETE /static/path/to/file&#xA0; &lt;- delete the file     GET /metadata/path/to/file &lt;- get the metadata about a file     GET /browse/path/to/directory &lt;- browse the content of a directory     GET /stats &lt;- number of files, current replication efforts, statistics on replication, etc    A file in RavenFS consists of:     The file name     The file length     A sequence of bytes that makes up the file contents     A set of key/value properties that contains file metadata    Internally, files are stored in a transactional store. Each file is composed of pages, each page is a maximum of 4 MB in size and is identified by its signature. (Actually, a pair of hash signatures, probably SHA256 &amp; RIPEMD160, to avoid any potential for collision). The file contents are actually the list of pages that it is composed of.   The notion of pages is pretty important for several reasons:     It provides us with a standard way to identify pieces of the files.     Each page may be part of multiple files.     Pages are immutable, once they are written to storage, they cannot be modified (but they can be removed if no file is referencing this page).     It makes it easier to chunk data to send while replicating.     It drastically reduces the size taken by files that share much of the same information.    Let us try to analyze this further. Let us say that we have a 750MB video, we put this video file inside RavenFS. Internally, that file is chunked into 188 pages, each of them about 4 MB in size. Since we have setup replication to the RavenFS node in India, we start replicating each of those pages as soon as we are done saving it to the local RavenFS node. In other words, even while we are uploading the file to the local RavenFS node, it is being replicated to the remote RavenFS nodes, saving us the need to wait until the full file is loaded for replication to begin. Once the entire file has been replicated to the remote node, the team in India can start editing that file.  They make changes in three different places, then save the file again to RavenFS. In total, they have modified 24 MB, and in total modified 30 pages. That means that for the purpose of replicating back to the local RavenFS node, we need to send only 120 MB, instead of 750 MB.   This reduces both time and bandwidth required to handle replication. The same will happen, by the way, if we have a set of common files that have some common parts, we will not store the information twice. For that matter, the RavenFS client will be able to ask the RavenFS node about pages that are already stored, and so won&#x2019;t need to even bother uploading pages that are already on the server.  Another important factor in the decision to use pages is that when replicating across unreliable medium, sending large files around in a single chunk is a bad idea, because it is pretty common for the connection to drop, and if you need a prefect connection for the duration of the transfer of a 1.5 GB file, you are going to be in a pretty bad place very soon.  Thoughts?</p>
        </article>
        <article id="article-4823">
            <a href="https://ayende.com/blog/4827/answer-stopping-the-leaks" target="_blank">
                <h2 class="title mb-6" id="article-4823">Answer</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 30, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Originally posted at 4/19/2011Yesterday I posted the following challenge:  Given the following API, can you think of a way that would prevent memory leaks?     public interface IBufferPool&#xA;{&#xA;    byte[] TakeBuffer(int size);&#xA;    void ReturnBuffer(byte[] buffer);&#xA;}&#xA;  &#xA;&#xA;The problem with having something like this is that forgetting to return the buffer is going to cause a memory leak. Instead of having that I would like to have the application stop if a buffer is leaked. Leaked means that no one is referencing this buffer but it wasn&#x2019;t returned to the pool.&#xA;&#xA;What I would really like is that when running in debug mode, leaking a buffer would stop the entire application and tell me:&#xA;&#xA;&#xA;  That a buffer was leaked. &#xA;&#xA;  What was the stack trace that allocated that buffer. &#xA;&#xA;&#xA;Let us take a look at how we are going about implementing this, shall we? I am going to defer the actual implementation of the buffer pool to System.ServiceModel.Channels.BufferManager and focus on providing the anti leak features. The result is that this code:&#xA;&#xA;&#xA;  IBufferPool pool = new BufferPool(1024*512, 1024);&#xA;&#xA;var buffer = pool.TakeBuffer(512);&#xA;GC.WaitForPendingFinalizers(); // nothing here&#xA;&#xA;pool.ReturnBuffer(buffer);&#xA;buffer = null;&#xA;GC.WaitForPendingFinalizers(); // nothing here, we released the memory properly&#xA;&#xA;pool.TakeBuffer(512); // take and discard a buffer without returning to the pool&#xA;GC.WaitForPendingFinalizers(); // failure!&#xA;  &#xA;&#xA;Will result in the following error:&#xA;&#xA;&#xA;  Unhandled Exception: System.InvalidOperationException: A buffer was leaked. Initial allocation:&#xA;   at ConsoleApplication1.BufferPool.BufferTracker.TrackAllocation() in IBufferPool.cs:line 22&#xA;   at ConsoleApplication1.BufferPool.TakeBuffer(Int32 size) in IBufferPool.cs:line 60&#xA;   at ConsoleApplication1.Program.Main(String[] args) in Program.cs:line 21&#xA;  &#xA;&#xA;And now for the implementation:&#xA;&#xA;&#xA;  public class BufferPool : IBufferPool&#xA;{&#xA;    public class BufferTracker&#xA;    {&#xA;        private StackTrace stackTrace;&#xA;&#xA;        public void TrackAllocation()&#xA;        {&#xA;            stackTrace = new StackTrace(true);&#xA;            GC.ReRegisterForFinalize(this);&#xA;        }&#xA;&#xA;        public void Discard()&#xA;        {&#xA;            stackTrace = null;&#xA;            GC.SuppressFinalize(this);&#xA;        }&#xA;&#xA;        ~BufferTracker()&#xA;        {&#xA;            if (stackTrace == null)&#xA;                return;&#xA;&#xA;            throw new InvalidOperationException(&#xA;                &quot;A buffer was leaked. Initial allocation:&quot; &#x2B; Environment.NewLine &#x2B; stackTrace&#xA;                );&#xA;        }&#xA;    }&#xA;&#xA;    private readonly BufferManager bufferManager;&#xA;    private ConditionalWeakTable&lt;byte[], BufferTracker&gt; trackLeakedBuffers = new ConditionalWeakTable&lt;byte[], BufferTracker&gt;();&#xA;&#xA;    public BufferPool(long maxBufferPoolSize, int maxBufferSize)&#xA;    {&#xA;        bufferManager = BufferManager.CreateBufferManager(maxBufferPoolSize, maxBufferSize);&#xA;    }&#xA;&#xA;    public void Dispose()&#xA;    {&#xA;        bufferManager.Clear();&#xA;        // note that disposing the pool before returning all of the buffers will cause a crash&#xA;    }&#xA;&#xA;    public byte[] TakeBuffer(int size)&#xA;    {&#xA;        var buffer = bufferManager.TakeBuffer(size);&#xA;        trackLeakedBuffers.GetOrCreateValue(buffer).TrackAllocation();&#xA;        return buffer;&#xA;    }&#xA;&#xA;    public void ReturnBuffer(byte[] buffer)&#xA;    {&#xA;        BufferTracker value;&#xA;        if(trackLeakedBuffers.TryGetValue(buffer, out value))&#xA;        {&#xA;            value.Discard();&#xA;        }&#xA;        bufferManager.ReturnBuffer(buffer);&#xA;    }&#xA;}&#xA;  &#xA;&#xA;As you can see, utilizing ConditionalWeakTable is quite powerful, since it allows us to support a lot of really advanced scenarios in a fairly simple ways.</p>
        </article>
        <article id="article-4824">
            <a href="https://ayende.com/blog/4826/challenge-stop-the-leaks" target="_blank">
                <h2 class="title mb-6" id="article-4824">Challenge</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 29, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Given the following API, can you think of a way that would prevent memory leaks?     public interface IBufferPool&#xA;{&#xA;    byte[] TakeBuffer(int size);&#xA;    void ReturnBuffer(byte[] buffer);&#xA;}&#xA;  &#xA;&#xA;The problem with having something like this is that forgetting to return the buffer is going to cause a memory leak. Instead of having that I would like to have the application stop if a buffer is leaked. Leaked means that no one is referencing this buffer but it wasn&#x2019;t returned to the pool.&#xA;&#xA;What I would really like is that when running in debug mode, leaking a buffer would stop the entire application and tell me:&#xA;&#xA;&#xA;  That a buffer was leaked. &#xA;&#xA;  What was the stack trace that allocated that buffer. &#xA;&#xA;&#xA;A solution will be posted tomorrow.</p>
        </article>
        <article id="article-4825">
            <a href="https://ardalis.com/fixing-maxitemsinobjectgraph-quota-error-in-wcf-service/" target="_blank">
                <h2 class="title mb-6" id="article-4825">Fixing MaxItemsInObjectGraph quota Error in WCF Service</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 28, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have a WCF Service that occasionally yields a message like this one: Maximum number of items that can be serialized or deserialized in an&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4826">
            <a href="https://ayende.com/blog/4825/an-elegant-threadlocal-for-silverlight" target="_blank">
                <h2 class="title mb-6" id="article-4826">An elegant ThreadLocal for Silverlight</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 28, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">One of the annoying bits about Silverlight is how much of what I consider core API isn&#x2019;t there. For example, concurrent collections or thread local.  I didn&#x2019;t have the time to implement concurrent collections properly, but thread local isn&#x2019;t really that hard. Here is a simple implementation:     public class ThreadLocal&lt;T&gt;&#xA;{&#xA;    private readonly Func&lt;T&gt; valueCreator;&#xA;&#xA;    public class Holder&#xA;     {&#xA;         public T Val;&#xA;     }&#xA;&#xA;    [ThreadStatic]&#xA;    private static ConditionalWeakTable&lt;object, Holder&gt; _state;&#xA;&#xA;    public ThreadLocal():this(() =&gt; default(T))&#xA;    {&#xA;    }&#xA;&#xA;    public ThreadLocal(Func&lt;T&gt; valueCreator)&#xA;    {&#xA;        this.valueCreator = valueCreator;&#xA;    }&#xA;&#xA;    public T Value&#xA;    {&#xA;        get&#xA;        {&#xA;            Holder value;&#xA;            if (_state == null || _state.TryGetValue(this, out value) == false)&#xA;            {&#xA;                var val = valueCreator();&#xA;                Value = val;&#xA;                return val;&#xA;            }&#xA;            return value.Val;&#xA;        }&#xA;        set&#xA;        {&#xA;            if (_state == null)&#xA;                _state = new ConditionalWeakTable&lt;object, Holder&gt;();&#xA;            var holder = _state.GetOrCreateValue(this);&#xA;            holder.Val = value;&#xA;        }&#xA;    }&#xA;}&#xA;  &#xA;&#xA;The fun part, it satisfies the entire contract, but I am willing to bet it is going to cause some head scratching.</p>
        </article>
        <article id="article-4827">
            <a href="https://ardalis.com/exporting-blog-content-from-community-server/" target="_blank">
                <h2 class="title mb-6" id="article-4827">Exporting Blog Content from Community Server</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 27, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">I have some old blog content scattered around a few different sites, and it&#x2019;s on my list for the near future to consolidate it as much as&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4828">
            <a href="https://ayende.com/blog/4824/raven-situational-awareness" target="_blank">
                <h2 class="title mb-6" id="article-4828">Raven Situational Awareness</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 27, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">There is a whole set of features that require collaboration from a set of severs. For example, when talking about auto scale scenarios, you really want the servers to figure things out on their own, without needing administrators to hold their hands and murmur sweet nothings at 3 AM.  We needed this feature in Raven DB, Raven MQ and probably in Raven FS, so I sat down and thought about what is actually needed and whatever I could package that in a re-usable form. I am on a roll for the last few days, and something that I estimated would take a week or two took me about six hours, all told.  At any rate, I realized that the important parts of this feature set is the ability to detect siblings on the same network, being able to detect failure of those siblings and the ability to dynamically select the master node.&#xA0; The code is available here: https://github.com/hibernating-rhinos/Raven.SituationalAwareness under the AGPL license. If you want to use this code commercially, please contact me for commercial licensing arrangements.   Let us see what is actually involved here:     var presence = new Presence(&quot;clusters/commerce&quot;, new Dictionary&lt;string, string&gt;&#xA;{&#xA;    {&quot;RavenDB-Endpoint&quot;, new UriBuilder(&quot;http&quot;, Environment.MachineName, 8080).Uri.ToString()}&#xA;}, TimeSpan.FromSeconds(3));&#xA;presence.TopologyChanged &#x2B;= (sender, nodeMetadata) =&gt;&#xA;{&#xA;    switch (nodeMetadata.ChangeType)&#xA;    {&#xA;        case TopologyChangeType.MasterSelected:&#xA;            Console.WriteLine(&quot;Master selected {0}&quot;, nodeMetadata.Uri);&#xA;            break;&#xA;        case TopologyChangeType.Discovered:&#xA;            Console.WriteLine(&quot;Found {0}&quot;, nodeMetadata.Uri);&#xA;            break;&#xA;        case TopologyChangeType.Gone:&#xA;            Console.WriteLine(&quot;Oh no, {0} is gone!&quot;, nodeMetadata.Uri);&#xA;            break;&#xA;        default:&#xA;            throw new ArgumentOutOfRangeException();&#xA;    }&#xA;};&#xA;presence.Start();&#xA;  &#xA;&#xA;As you can see, we are talking about a single class that is exposed to your code. You need to provide the cluster name, this allows us to run multiple clusters on the same network without conflicts. (For example, in the code above, we have a set of servers for the commerce service, and another for the billing service, etc). Each node also exposes metadata to the entire cluster. In the code above, we share the endpoint for our RavenDB endpoint.&#xA0; The TimeSpan variable determines the heartbeat frequency for the cluster (how often it would check for failing nodes).&#xA;&#xA;We have a single event that we can subscribe to, which let us know about changes in the system topology. Discovered and Gone are pretty self explanatory, I think. But MasterSelected is more interesting.&#xA;&#xA;After automatically discovering all the siblings on the network, Raven Situation Awareness will use the Paxos algorithm to decide who should be the master. The MasterSelected event happens when a quorum of the nodes select a master. You can then proceed with your own logic based on that. If the master will fail, the nodes will convene again and the quorum will select a new master. &#xA;&#xA;With the network topology detection and the master selection out of the way, (and all of that with due consideration for failure conditions) the task of actually implementing a distributed server system just became significantly easier.</p>
        </article>
        <article id="article-4829">
            <a href="https://ardalis.com/aspnet-mvc3-scaffolding/" target="_blank">
                <h2 class="title mb-6" id="article-4829">ASP.NET MVC 3 Scaffolding Quick Start</h2>
            </a>
            <p class="mb-2">by Ardalis</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 26, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Introduction One of the new features in ASP.NET MVC 3 is its scaffolding feature, which basically lets you very quickly produce data entry&#x2026;Keep Reading &#x2192;</p>
        </article>
        <article id="article-4830">
            <a href="https://ayende.com/blog/4823/why-is-this-not-thread-safe" target="_blank">
                <h2 class="title mb-6" id="article-4830">Why is this not thread safe?</h2>
            </a>
            <p class="mb-2">by Oren Eini</p>
            <p class="mb-6 flex gap-1.5">
                    <span>
                        <svg width="1.25rem" fill="currentColor" viewBox="0 0 24 24"
                             xmlns="http://www.w3.org/2000/svg"><path
                                xmlns="http://www.w3.org/2000/svg"
                                d="M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 6C12.5523 6 13 6.44772 13 7V11.5858L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L11.2929 12.7071C11.1054 12.5196 11 12.2652 11 12V7C11 6.44772 11.4477 6 12 6Z"></path></svg>
                    </span>
                posted on: April 26, 2011
            </p>
            <p class="max-w-full w-full line-clamp-5 text-justify mb-20">Originally posted at 4/15/2011Take a look at the following piece of code:     if(items.ContainsKey(key) == false)&#xA;{&#xA;    lock(items)&#xA;    {&#xA;        if(items.ContainsKey(key) == false)&#xA;        {&#xA;            items.Add(key, val);&#xA;        }&#xA;    }&#xA;}&#xA;  &#xA;&#xA;The answer is quite simple, and it is located directly in the docs:&#xA;&#xA; &#xA;&#xA;Yes, on the face of it, this is safe code, in the sense that we will never get DuplicateKeyException. But the implementation of ContainsKey() isn&#x2019;t safe to run when Add() is also executing.&#xA;&#xA;The actual behavior depends on the implementation, but it is easy enough to imagine a scenario where invariants that ContainsKey() relies on are broken for the duration of the Add() call.</p>
        </article>
        <div class="button flex justify-between">
            <a href="482.html"><span class="back arrow"></span></a>

            <a href="484.html"><span class="next arrow"></span></a>
        </div>
    </section>
</main>
<footer
    class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs">
    <div class="me-0 sm:me-4">
        <div class="flex flex-wrap items-end gap-x-2">
            <ul class="flex flex-1 items-center gap-x-2 sm:flex-initial">
                <li class="flex">
                    <p class="flex items-end gap-2 justify-center flex-wrap	">Â© Relatively General
                        .NET 2024<span
                            class="inline-block">&nbsp;ðŸš€&nbsp;Theme: Astro Cactus</span>

                        <a class="inline-block sm:hover:text-link" href="https://github.com/chrismwilliams/astro-cactus"
                           rel="noopener noreferrer " target="_blank">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" aria-hidden="true" class="h-6 w-6"
                                 focusable="false" data-icon="mdi:github">
                                <symbol id="ai:mdi:github">
                                    <path fill="currentColor"
                                          d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"></path>
                                </symbol>
                                <use xlink:href="#ai:mdi:github"></use>
                            </svg>
                            <span class="sr-only">Github</span>
                        </a>
                    </p>
                </li>
            </ul>
        </div>
    </div>
    <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500">
        <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="index.html"> Home </a><a
            class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/about/"> About </a>
    </nav>
</footer>
<script src="js/script.js?id=af8f4559935e7bf5bf6015373793411d"></script>
<script src="pagefind/pagefind-ui.js"></script>
</body>
</html>